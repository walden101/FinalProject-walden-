var hzApp=angular.module("BC",["ui.router","pascalprecht.translate","BC.services","BC.directives","BC.controllers.project","BC.controllers.dashboard","BC.controllers.dashUpload","BC.controllers.chartEdit","BC.controllers.dataSource","BC.controllers.database","BC.controllers.dataSource.polymer","BC.controllers.security","BC.controllers.warn","BC.controllers.notice","BC.controllers.setWarn","BC.controllers.template.home","BC.controllers.template.config","BC.controllers.template.rule","BC.controllers.template.modify","BC.controllers.workspace","BC.controllers.authorManageCtrl","BC.controllers.train","BC.controllers.chart.template","BC.controllers.chart.template.config","BC.controllers.chart.template.rule","BC.controllers.pay","mainNav","bdp.charts","ngDialog","ui.bootstrap","ui.select","ui.tree","lr.upload","datePicker","ui.sortable","ui.mask","filter","monospaced.elastic","ui-rangeSlider","spectrumColorPicker","promiseButton","inputNumber","ngInputText","ngLoadingGif","angular-click-outside","angular-mouserover-hide","textAngular","ngFileUpload","bw.paging"]);hzApp.run(["$rootScope","$location","$window","$timeout","$translate","$http","ngDialog","$state","$stateParams","pendingRequests","webSocket",function(e,t,a,l,r,o,s,i,n,c,d){var m=[];e.historyTime=[],e.back=function(){var a=m.length>1?m.splice(-2)[0]:"/";return e.historyTime.length>1?e.historyTime.splice(-2)[0]:"/","/dash_edit"==a||"/"==a?void(location.href="/index.html"):void t.path(a)},e.$on("$stateChangeStart",function(){e.pageLoading=!0,e.member_personal=!1,0===+!!$.cookie("token")&&(a.location.href=isThirdIframe?"http://b.rongyi.com/cms/main/login/home":bdp.bdpLogin.checkPartnerLogin()),c.cancelAll()}),e.$on("$stateChangeSuccess",function(){m.push(t.path()),e.historyTime.push(t.path()),e.pageLoading=!1,e.wsId=n.wsId,e.actualLocation=t.path()}),e.$watch(function(){return t.path()},function(t){e.actualLocation===t&&s.closeAll()}),e.$on("changeCapacity",function(){e.$broadcast("getCapacity","change")}),e.$on("userInfoChange",function(){e.$broadcast("getUserInfo","change")});var p=null;$(window).resize(function(t){t.target===window&&(clearTimeout(p),p=setTimeout(function(){e.$broadcast("afterWindowResize")},300))});var _=function(a,l){e.view=a,l&&t.path(l)};e.click_show_view=function(a,l){function r(e,t){var a=!1;return t.map(function(t){t.ws_id==e&&(a=!0)}),a}l=l||{};var o,s,i=n.wsId,c=e.workspaceList;switch(a){case"dashboard":if(o="dashboard",i){c=c.dash;var d=e.last_dash_path,m=r(i,c);if(m){s=d&&d.indexOf(i)>-1?d:"dash_edit_ws/"+i;break}}t.path().indexOf("dash_edit")<0&&(s=d&&d.indexOf("dash_edit_ws")>-1?"/dash_edit":d?d:"/dash_edit");break;case"dash_tpl":o="dash_tpl",t.path().indexOf("dash_tpl")<0&&(s="/dash_tpl");break;case"data_source":if(s="/data_source",o="worktable",i){c=c.worktable;var m=r(i,c);if(m){s="data_source/"+i;break}}s="data_source";break;case"user":s="/user",o="user";break;case"database":s="/database",o="database";break;case"database_list":s="/database_list",o="database_list";break;case"developerCenter":s="/developer_center";break;case"warn":s=l.wsId?"/warn/"+l.wsId:"/warn/",o="warn";break;case"template_home":if(o="template",i){c=c.template;var m=r(i,c);if(m){s="template_home/"+i;break}}"user"==e.role?(i=e.workspaceList.template[0].ws_id,s="template_home/"+i):s="/template_home";break;case"template_config":s=l.wsId?"/template_config/"+l.wsId:"/template_config",o="template";break;case"template_rule":s=l.wsId?"/template_rule/"+l.wsId:"/template_rule/",o="template";break;case"template_rule_create":s=l.wsId?"/template_rule_modify/create/"+l.wsId:"/template_rule_modify/create",o="template";break;case"template_rule_modify":s=l.wsId?"/template_rule_modify/"+l.ruleId+"/"+l.wsId:"/template_rule_modify/"+l.ruleId,o="template";break;case"workspace":s="/workspace";break;case"security":s="/security",o="security";break;case"train":s="/train",o="train",n.mdlId&&(s="/train/"+n.mdlId);break;case"train_model":s="/train_model",o="train";break;case"chart_template":s="/chart_template",o="chart_template";break;case"chart_template_config":s="/chart_template_config",o="chart_template_config";break;case"chart_template_rule":s="/chart_template_rule",o="chart_template_rule";break;case"chart_template_rule_modify":s="/chart_template_rule_modify/"+l.chartTplRuleId,o="chart_template_rule_modify";break;case"chart_template_rule_create":s="/chart_template_rule_create",o="chart_template_rule_create"}_(o,s)},e.$editable=!1,_("dashboard"),e.proj_share=!1,e.dash_share_name="",e.global={},e.permision={},e.show_bdp_header=!0,window.usedThemeId=e.usedThemeId=parseInt($.cookie(window.BDPThemes.bdpThemeIdCookieName)||2),e.is_sub_admin=!!$.cookie("is_sub_admin"),"personal"===window._mc_role_&&(e.role=""),e.$on("onSearch",function(t,a){setTimeout(function(){e.$broadcast("jumpToSearch",a)},0)});var u=["zh","en"],h=0;e.changeTranslation=function(){h=(h+1)%u.length,console.log(u[h]),r.use(u[h])},window.changeTranslation=e.changeTranslation,window.bdpChart=window.bdpChart||{},e.$on("$translateChangeSuccess",function(t,a){console.log("Language has been switched to "+a.language),window.bdpChart.language=e.language=a.language,angular.element("body").removeClass("zh en").addClass(a.language)}),e.guideStepModify=function(t){2==t?e.$broadcast("nextGuide","testForZidingyi"):e.$broadcast("nextGuide","testForMuban");var a={guide:userGuideFlags.set("origin",t),user_id:e.user_id};o.post("/api/user/guide_set",a).success(function(e){return 0==e.status?!0:(errorHandle(e),!1)})},e.dotGuideStepModify=function(t){"table_guide"==t&&(e.personalInfo.table_guide=1),"chart_guide"==t&&(e.personalInfo.chart_guide=1),"dashboard_guide"==t&&(e.personalInfo.dashboard_guide=1)},e.$on("okToGuide",function(t,a){e.$broadcast("nextGuide",a)}),e.$on("noticeListClose",function(t,a){e.$broadcast("getNavNoticeList",a)}),e.current_language="en"==$.cookie("locale")?"English":"简体中文",e.changeLanguage=function(t){e.language=t,window.locale=t,"zh"==t?(e.current_language="简体中文",r.use(t)):"en"==t&&(e.current_language="English",r.use(t))};var b=navigator.userAgent;b&&(isIE||window.ActiveXObject||"ActiveXObject"in window)&&($("body").removeClass("IE-BDP"),$("body").addClass("IE-BDP")),e.$watch("themeChangeFlag",function(t,a){t==a||"dashboard"!=e.view&&"dash_tpl"!=e.view||e.$broadcast("fire-refresh-dashboard"),t!=a&&"worktable"==e.view&&e.$broadcast("refresh-relation-path")});var w="_websocketChartMessage_",g=location.protocol,f=g+"//bws.bdp.cn",C=f+"/api/chat";e[w]={},e[w].lock=!1,e[w].lock||setTimeout(function(){e.socketConn=d.connect(C,{onMessage:function(t){t=t||{},t._t=new Date,e.$broadcast(w,t)},onOpen:function(){},onClose:function(){}})},100)}]),hzApp.config(["$stateProvider","$urlRouterProvider","$translateProvider","ngDialogProvider","uiMask.ConfigProvider",function(e,t,a,l,r){t.otherwise("/dash_edit"),e.state("dash_edit",{url:"/dash_edit",templateUrl:"/static/js/dashboard/tpl/project_view.html",controller:"ProjectController"}).state("dash_edit.dash",{url:"/:projId/:dashId?df_id&range",templateUrl:"/static/js/dashboard/tpl/dash_edit.html",controller:"DashController"}).state("dash_edit.rule",{url:"/:projId/:dashId/:ruleId??df_id&range",templateUrl:"/static/js/dashboard/tpl/dash_edit.html",controller:"DashController"}).state("dash_fullscreen",{url:"/dash_fullscreen/:projId/:dashId",templateUrl:"/static/js/dashboard/tpl/dash_fullscreen.html",controller:"DashController"}).state("dash_fullscreen.rule",{url:"/:ruleId",templateUrl:"/static/js/dashboard/tpl/dash_fullscreen.html",controller:"DashController"}).state("ws_dash",{url:"/dash_edit_ws/:wsId",templateUrl:"/static/js/dashboard/tpl/project_view.html",controller:"ProjectController"}).state("ws_dash.dash",{url:"/:projId/:dashId?df_id&range",templateUrl:"/static/js/dashboard/tpl/dash_edit.html",controller:"DashController"}).state("third_iframe",{url:"/third_iframe",templateUrl:"/static/js/dashboard/tpl/project_view.html",controller:"ProjectController"}).state("third_iframe.dash",{url:"/:projId/:dashId",templateUrl:"/static/js/dashboard/tpl/dash_edit.html",controller:"DashController"}).state("ws_dash_fullscreen",{url:"/dash_fullscreen_ws/:wsId/:projId/:dashId",templateUrl:"/static/js/dashboard/tpl/dash_fullscreen.html",controller:"DashController"}).state("chart_edit",{url:"/chart_edit/:projId/:dashId/:chartId",templateUrl:"/static/view/chart_edit.html",controller:"ChartController"}).state("chart_edit_ws",{url:"/chart_edit_ws/:wsId/:projId/:dashId/:chartId",templateUrl:"/static/view/chart_edit.html",controller:"ChartController"}).state("upgrade",{url:"/upgrade",templateUrl:"/static/view/partner_upgrade.html",controller:"partnerUpgradeController"}).state("data_source",{url:"/data_source",templateUrl:"/static/js/worktable/preview/worktable.html",controller:"WorktableCtrl"}).state("data_source_ws",{url:"/data_source/:wsId",templateUrl:"/static/js/worktable/preview/worktable.html",controller:"WorktableCtrl"}).state("user",{url:"/user",templateUrl:"/static/view/user.html",controller:"UserController"}).state("database",{url:"/database",templateUrl:"/static/database/view/database.html",controller:"databaseCtrl"}).state("database_list",{url:"/database_list",templateUrl:"/static/database/view/database_list.html",controller:"databaseListCtrl"}).state("database_create",{url:"/database_create/:dbType",templateUrl:"/static/database/view/database_create.html",controller:"databaseCreateCtrl"}).state("database_sync_client",{url:"/database_sync_client/",templateUrl:"/static/database/view/database_sync_client.html",controller:"databaseSyncClientCtrl"}).state("database_sync_client_big",{url:"/database_sync_client_big/",templateUrl:"/static/database/view/database_sync_client_big.html",controller:"databaseSyncClientCtrl"}).state("database_log",{url:"/database_log/:dsId",templateUrl:"/static/database/view/database_log.html",controller:"databaseLogCtrl"}).state("database_ba",{url:"/database_ba/:ds_id",templateUrl:"/static/database/view/database_ba.html",controller:"databaseBaController"}).state("ba_config",{url:"/ba/:dsId",templateUrl:"/static/view/ba_config.html",controller:"BAConfigController"}).state("database_baidu_search",{url:"/database_baidu_search/:dsId/:realtimeId",templateUrl:"/static/view/database_baidu_search.html",controller:"databaseBaiduSearchCtrl"}).state("database_baidu_search_list",{url:"/database_baidu_search_list/:dsId",templateUrl:"/static/view/database_baidu_search_list.html",controller:"databaseBaiduSearchListCtrl"}).state("database_baidu_index",{url:"/database_baidu_index/:dsId/:indexId",templateUrl:"/static/view/database_baidu_index.html",controller:"databaseBaiduIndexCtrl"}).state("database_baidu_index_list",{url:"/database_baidu_index_list/:dsId",templateUrl:"/static/view/database_baidu_index_list.html",controller:"databaseBaiduIndexListCtrl"}).state("developerCenter",{url:"/developer_center",templateUrl:"/static/database/view/developerCenter.html",controller:"developerCenterCtrl"}).state("warn",{url:"/warn",templateUrl:"/static/view/warn_list.html",controller:"WarnController"}).state("notice_list",{url:"/notice",templateUrl:"/static/view/notice_list.html",controller:"noticeCtrl"}).state("notice",{url:"/notice/:noticeTpye",templateUrl:"/static/view/notice_list.html",controller:"noticeCtrl"}).state("warn_ws",{url:"/warn/:wsId",templateUrl:"/static/view/warn_list.html",controller:"WarnController"}).state("template_home",{url:"/template_home",templateUrl:"/static/view/template_home.html",controller:"TemplateHomeController"}).state("template_home_ws",{url:"/template_home/:wsId",templateUrl:"/static/view/template_home.html",controller:"TemplateHomeController"}).state("template_config_ws",{url:"/template_config/:wsId",templateUrl:"/static/view/template_config.html",controller:"TemplateConfigController"}).state("template_config",{url:"/template_config",templateUrl:"/static/view/template_config.html",controller:"TemplateConfigController"}).state("template_rule",{url:"/template_rule",templateUrl:"/static/view/template_rule.html",controller:"templateRuleCtrl"}).state("template_rule_ws",{url:"/template_rule/:wsId",templateUrl:"/static/view/template_rule.html",controller:"templateRuleCtrl"}).state("template_rule_modify",{url:"/template_rule_modify/:module",templateUrl:"/static/view/template_rule_modify.html",controller:"templateRuleModifyCtrl"}).state("template_rule_modify.ws",{url:"/:wsId",templateUrl:"/static/view/template_rule_modify.html",controller:"templateRuleModifyCtrl"}).state("template_rule_create",{url:"/template_rule_create",templateUrl:"/static/view/template_rule_modify.html",controller:"templateRuleModifyCtrl"}).state("template_rule_create_ws",{url:"/template_rule_create/:wsId",templateUrl:"/static/view/template_rule_modify.html",controller:"templateRuleModifyCtrl"}).state("join_table",{url:"/jointable",templateUrl:"/static/js/worktable/join/join_table.html",controller:"joinTableController"}).state("join_table_edit",{url:"/jointable/:tbId",templateUrl:"/static/js/worktable/join/join_table.html",controller:"joinTableController"}).state("join_table_ws",{url:"/jointable_ws/:wsId",templateUrl:"/static/js/worktable/join/join_table.html",controller:"joinTableController"}).state("join_table_ws_edit",{url:"/jointable_ws/:wsId/:tbId",templateUrl:"/static/js/worktable/join/join_table.html",controller:"joinTableController"}).state("polymer_table",{url:"/polymer_table",templateUrl:"/static/js/worktable/polymer/polymer_table.html",controller:"polymerTableCtrl"}).state("polymer_table_edit",{url:"/polymer_table/:tbId",templateUrl:"/static/js/worktable/polymer/polymer_table.html",controller:"polymerTableCtrl"}).state("polymer_table_ws",{url:"/polymer_table_ws/:wsId",templateUrl:"/static/js/worktable/polymer/polymer_table.html",controller:"polymerTableCtrl"}).state("polymer_table_ws_edit",{url:"/polymer_table_ws/:wsId/:tbId",templateUrl:"/static/js/worktable/polymer/polymer_table.html",controller:"polymerTableCtrl"}).state("union_table",{url:"/union_table/",templateUrl:"/static/js/worktable/union/union_table.html",controller:"UnionTableCtrl"}).state("union_table_edit",{url:"/union_table/:tbId",templateUrl:"/static/js/worktable/union/union_table.html",controller:"UnionTableCtrl"}).state("union_table_ws",{url:"/union_table_ws/:wsId",templateUrl:"/static/js/worktable/union/union_table.html",controller:"UnionTableCtrl"}).state("union_table_ws_edit",{url:"/union_table_ws/:wsId/:tbId",templateUrl:"/static/js/worktable/union/union_table.html",controller:"UnionTableCtrl"}).state("extract_table",{url:"/extract_table",templateUrl:"/static/js/worktable/extract/extract_table.html",controller:"ExtractTableCtrl"}).state("sql_table",{url:"/sql_table",templateUrl:"/static/js/worktable/sql/sqlMergeTable.html",controller:"SQLTableCtrl"}).state("sql_table_edit",{url:"/sql_table/:tbId",templateUrl:"/static/js/worktable/sql/sqlMergeTable.html",controller:"SQLTableCtrl"}).state("sql_table_ws",{url:"/sql_table/:wsId",templateUrl:"/static/js/worktable/sql/sqlMergeTable.html",controller:"SQLTableCtrl"}).state("sql_table_ws_edit",{url:"/sql_table/:wsId/:tbId",templateUrl:"/static/js/worktable/sql/sqlMergeTable.html",controller:"SQLTableCtrl"}).state("workspace",{url:"/workspace",templateUrl:"/static/view/workspace.html",controller:"workspaceCtrl"}).state("security",{url:"/security",templateUrl:"/static/view/security.html",controller:"securityCtrl"}).state("gis_edit",{url:"/gis_edit/:projId/:dashId/:chartId",templateUrl:"/static/view/gis_edit.html",controller:"gisCtrl"}).state("gis_edit_ws",{url:"/gis_edit_ws/:wsId/:projId/:dashId/:chartId",templateUrl:"/static/view/gis_edit.html",controller:"gisCtrl"}).state("parse_url",{url:"/parse_url/:tbId",templateUrl:"/static/js/worktable/parse/parse_url.html",controller:"parseUrlCtrl"}).state("parse_url_ws",{url:"/parse_url_ws/:wsId/:tbId",templateUrl:"/static/js/worktable/parse/parse_url.html",controller:"parseUrlCtrl"}).state("merge_field",{url:"/merge_field/:tbId",templateUrl:"/static/js/worktable/parse/merge_field.html",controller:"mergeFieldCtrl"}).state("merge_field_ws",{url:"/merge_field_ws/:wsId/:tbId",templateUrl:"/static/js/worktable/parse/merge_field.html",controller:"mergeFieldCtrl"}).state("author_manage",{url:"/author_manage",templateUrl:"/static/view/author_manage.html",controller:"authorManageCtrl"}).state("train",{url:"/train",templateUrl:"/static/view/train_view.html",controller:"TrainModelListCtrl"}).state("train.edit",{url:"/:mdlId",templateUrl:"/static/view/train.html",controller:"TrainModelCtrl"}).state("train_model",{url:"/train_model",templateUrl:"/static/view/train_model.html",controller:"TrainModelEditCtrl"}).state("train_model_edit",{url:"/train_model/:mdlId",templateUrl:"/static/view/train_model.html",controller:"TrainModelEditCtrl"}).state("chart_template",{url:"/chart_template",templateUrl:"/static/chartTemplate/view/chart_template.html",controller:"chartTemplate"}).state("chart_template_config",{url:"/chart_template_config",templateUrl:"/static/chartTemplate/view/chart_template_config.html",controller:"chartTemplateConfig"}).state("chart_template_rule",{url:"/chart_template_rule",templateUrl:"/static/chartTemplate/view/chart_template_rule.html",controller:"chartTemplateRuleList"}).state("chart_template_rule_modify",{url:"/chart_template_rule_modify/:chartTplRuleId",templateUrl:"/static/chartTemplate/view/chart_template_rule_modify.html",controller:"chartTemplateRule"}).state("chart_template_rule_create",{url:"/chart_template_rule_create",templateUrl:"/static/chartTemplate/view/chart_template_rule_modify.html",controller:"chartTemplateRule"}).state("member",{url:"/member",templateUrl:"/static/pay/member/view/member.html",controller:"memberCtrl"}).state("member_upgrade",{url:"/member_upgrade",templateUrl:"/static/pay/member/view/member_upgrade.html",controller:"memberUpgradeCtrl"}).state("member_upgrade_level",{url:"/member_upgrade/:upgradeId",templateUrl:"/static/pay/member/view/member_upgrade.html",controller:"memberUpgradeCtrl"}).state("dash_tpl",{url:"/dash_tpl",templateUrl:"/static/js/dashboard/tpl/project_view.html",controller:"ProjectController"}).state("dash_tpl.dash",{url:"/:projId/:dashId",templateUrl:"/static/view/dash_template.html",controller:"newDashController"}).state("dash_tpl_fullscreen",{url:"/dash_tpl_fullscreen/:projId/:dashId",templateUrl:"/static/js/dashboard/tpl/dash_fullscreen.html",controller:"newDashController"}).state("tpl_replace",{url:"/tpl_replace/:projId/:dashId",templateUrl:"/static/view/tpl_replace.html",controller:"tplReplaceCtrl"}).state("page_upload_add",{url:"/page_upload/:operate",templateUrl:"/static/view/page_upload.html",controller:"pageUploadCtrl"}).state("page_upload_replace",{url:"/page_upload/:operate/:tbId",templateUrl:"/static/view/page_upload.html",controller:"pageUploadCtrl"}).state("page_upload_singlereplace",{url:"/page_upload/:operate/:tbId/:mapId",templateUrl:"/static/view/page_upload.html",controller:"pageUploadCtrl"}).state("table_capacity",{url:"/table_capacity",templateUrl:"/static/js/worktable/preview/table_capacity.html",controller:"tableCapacityCtrl"}).state("table_capacity_ws",{url:"/table_capacity/:wsId",templateUrl:"/static/js/worktable/preview/table_capacity.html",controller:"tableCapacityCtrl"}),a.useSanitizeValueStrategy("escape").useLoaderCache(!0).useStaticFilesLoader({prefix:"/static/i18n/locale.",suffix:".json"}).registerAvailableLanguageKeys(["zh","en"],{"zh-CN":"zh","en-US":"en","en-UK":"en","en-GB":"en"}).useStorage("myTranslateStorage").determinePreferredLanguage(function(){return navigator.language||navigator.languages&&navigator.languages[0]||navigator.browserLanguage||navigator.systemLanguage||navigator.userLanguage}),l.setDefaults({closeByDocument:!1,closeByEscape:!1,trapFocus:!1}),r.eventsToHandle(["input"])}]).factory("myTranslateStorage",function(){return{put:function(e,t){["zh","en"].indexOf(t)<0&&(t="en"),$.cookie(e,t,{path:"/",expires:365}),$.cookie("locale",t,{path:"/",expires:365})},get:function(e){return $.cookie(e)}}}).controller("LogoutController",["$scope","$http","$window","$rootScope",function(e,t,a,l){e.logout=function(){t.post("/api/user/logout",{access_token:$.cookie("token")}).then(function(){if($.cookie("token","",{expires:-1,path:"/"}),$.cookie("master_role","",{expires:-1,path:"/"}),$.cookie("is_weak","",{expires:-1}),2==l.enterprise_type&&window.close(),5==l.enterprise_type||6==l.enterprise_type)return a.location.href="http://yunqi.shopex.cn/",!1;if(l.userInfoObj.is_personalized){var e=l.userInfoObj.domain;a.location.href="https://"+e+".bdp.cn"}else a.location.href="/login.html"})},window.onbeforeunload=function(){l.securityStrategy&&l.securityStrategy.closeBrowserTokenFailure?window.localStorage.setItem("latestLeaveTime",(new Date).getTime()):window.localStorage.setItem("latestLeaveTime",0)}}]);
;angular.module("BC").run(["$templateCache",function(i){"use strict";i.put("/static/js/common/tpl/directive/labelCommentTooltip.html",'<div class="tooltip {{placement}} tooltip-bg-white bdp-tips label-comment-tooltip" ng-class="{ in: isOpen(), fade: animation() }" ng-show="!!content.name || (!!content.origin_name && content.origin_name != content.name) || !!content.owner_name || !!content.label || !!content.comment || !!content.share_name || !!content.rule_user"><div class="tooltip-inner"><div class="box"><div class="tooltip-block" ng-show="!!content.name"><span>{{\'name\' | translate}}</span> <span>{{content.name}}</span></div><div class="tooltip-block mt4" ng-show="!!content.origin_name && content.origin_name != content.name"><span>{{\'wb.worktableOriginalName\' | translate}}</span> <span>{{content.origin_name}}</span></div><div class="tooltip-block mt4" ng-show="!!content.label"><span>{{\'label\' | translate}}</span> <span>{{content.label}}</span></div><div class="tooltip-block mt4" ng-show="!!content.comment"><span>{{\'comment\' | translate}}</span> <span>{{content.comment}}</span></div><div class="tooltip-block mt4" ng-show="!!content.share_name"><span>{{\'dash.sharedFrom\' | translate}}</span> <span>{{content.share_name}}</span></div><div class="tooltip-block mt4" ng-show="!!content.rule_user"><span>{{\'dash.allocatedFrom\' | translate}}</span> <span>{{content.rule_user}}</span></div><div class="tooltip-block mt4" ng-show="!!content.owner_name"><span>{{\'wb.sharedFrom\' | translate}}</span> <span>{{content.owner_name}}</span></div></div></div></div>'),i.put("/static/js/common/tpl/directive/navWorkspace.html",'<div ng-if="workspaceList && curWsList.length > 0"><div class="nav-workspace-list"><ul><li class="display-inline-block cursor-pointer" ng-class="{\'active\':!wsId}" ng-click="tabWorkspace($event,undefined)" ng-if="(view !== \'template\' && view !==\'template_config\' && view != \'template_rule\') || role !== \'user\'"><div class="workspace-nav"><div class="left-border"></div><div class="workspace-nav-content nowrap">我的工作区</div><div class="right-border"></div></div></li><li ng-repeat="item in curWsList" class="display-inline-block cursor-pointer" ng-class="{\'active\':item.ws_id == wsId}" ng-click="tabWorkspace($event,item.ws_id,item.admin)"><div class="workspace-nav"><div class="left-border"></div><div class="workspace-nav-content nowrap">{{item.name}}</div><div class="right-border"></div></div></li></ul></div></div>'),i.put("/static/js/common/tpl/global_filter.html",'<div class="global-filter-l global-filter-handler"><a class="bdp-icon-wrap ml24"><i class="bdp-icon ico-filter"></i></a><a class="bdp-icon-wrap cursor-pointer" ng-if="scrollHandler.firstIndex > 0" ng-click="scrollHandler.scroll(-1)"><i class="bdp-icon ico-triangle-left"></i></a></div><div class="global-filter global-filter-share filter-i-w"><dl class="filter-i" ng-repeat="it in globalDashFilter" click-outside="it.show = false" outside-active="it.show"><dd ng-if="it.data_type !== \'date\'"><div class="filter-i-list-w"><p class="filter-i-name" ng-click="innerFilterModule.getItemList($event,it)"><span class="nowrap" title="{{it.range | sub_date:it}}" ng-show="it.range_type != 0">{{it.range | sub_date:it}} </span><span ng-show="it.range_type == 0" class="nowrap" title="{{\'dash.custom\' | translate}}">{{\'dash.custom\' | translate}} </span><i class="bdp-icon ico-triangle-down arrow-down"></i></p><div class="filter-i-list" ng-show="it.show" ng-style="adjustWidth[it.df_id]"><div ng-loading-gif size="size-1x" placeholder="true" ng-show="showLoading"></div><div class="pd3 query-box auto" ng-if="queryString[it.df_id].total > 20 && queryString[it.df_id].total <= 100"><input type="text" class="query-text" ng-model="queryKwd[it.df_id]" ng-input-text ng-keyup="filterQueryModule.enterToQuery({\'e\':$event,\'filter\':it,\'is_advance\':false,\'real_search\':false})"></div><div ng-if="showQueryfilter[it.df_id]" ng-show="!showLoading" class="query-box"><input type="text" ng-model="queryKwd[it.df_id]" ng-keyup="filterQueryModule.enterToQuery({\'e\':$event,\'filter\':it,\'is_advance\':false,\'real_search\':true})" class="query-text"> <a class="bdp-icon-wrap query-btn" ng-click="filterQueryModule.query(it)"><i class="bdp-icon ico-search"></i></a></div><ul ng-show="!showLoading"><li ng-if="it.config.show_all"><a ng-click="resetRangeType(it);refreshCharts(it,\'\',[])" translate="all"></a></li><li ng-repeat="query in queryString[it.df_id].list | filter:queryString[it.df_id].keyword track by $index"><a class="filter-list-a" title="{{query}}" ng-click="resetRangeType(it);refreshCharts(it,query,[query])">{{query}}</a></li><li ng-if="queryString[it.df_id].list.length == 0" class="empty" style="padding:3px"><p>{{\'dash.noSearchResult\' | translate}}</p></li></ul></div></div><span class="filter-i-adv" ng-click="innerFilterModule.getItemList($event,it,innerFilterModule.openAdvanceModal)" translate="multiSelect" ng-hide="onSharePage"></span></dd><dd ng-if="it.data_type === \'date\'"><div class="filter-i-list-w"><p class="filter-i-name" ng-click="innerFilterModule.getItemList($event,it)"><span class="nowrap" ng-if="it.config.granularity !== \'\'" title="{{it.range[0] | sub_date:it}}">{{it.range[0] | sub_date:it}} <em ng-if="it.range[0] && it.config.granularity == \'week\'">({{it.range[0] | weekFormat}})</em> </span><span class="nowrap" ng-if="!it.config.granularity" title="{{it.range | format_date:it.adv_date_list:it.name}}">{{it.range | format_date:it.adv_date_list:it.name}} </span><i class="bdp-icon ico-triangle-down arrow-down"></i></p><div class="filter-i-list" ng-show="it.show" ng-style="adjustWidth[it.df_id]"><div ng-loading-gif size="size-1x" placeholder="true" ng-show="showLoading"></div><div class="pd3 query-box auto" ng-if="queryString[it.df_id].total > 20 && queryString[it.df_id].total <= 100"><input type="text" class="query-text" ng-model="queryKwd[it.df_id]" ng-input-text ng-keyup="filterQueryModule.enterToQuery({\'e\':$event,\'filter\':it,\'is_advance\':false,\'real_search\':false})"></div><div ng-if="showQueryfilter[it.df_id]" ng-show="!showLoading" class="query-box"><input type="text" ng-model="queryKwd[it.df_id]" ng-keyup="filterQueryModule.enterToQuery({\'e\':$event,\'filter\':it,\'is_advance\':false,\'real_search\':true})" class="query-text"> <a class="bdp-icon-wrap query-btn" ng-click="filterQueryModule.query(it)"><i class="bdp-icon ico-search"></i></a></div><ul ng-if="!it.config.granularity" ng-show="!showLoading"><li ng-if="it.config.show_all"><a ng-click="refreshCharts(it,\'\',[])" translate="dash.allTime"></a></li><li ng-repeat="adv in queryString[it.df_id].list | filter:queryString[it.df_id].keyword track by $index" class="adv-item pr"><a class="filter-list-a" title="{{adv.name}}" ng-click="refreshCharts(it,adv.name,[adv.opt_id])">{{adv.name}}</a></li><li><a ng-click="innerFilterModule.showDatePicker($index, it.range)" translate="chart.definedTimeRange"></a></li></ul><ul ng-if="it.config.granularity !== \'\'" ng-show="!showLoading"><li ng-if="it.config.show_all"><a class="cursor-pointer" ng-click="refreshCharts(it,\'\',[])" translate="dash.allTime"></a></li><li ng-if="it.config.granularity !== \'week\'" ng-repeat="adv in queryString[it.df_id].list | query_inner:queryString[it.df_id].keyword:it.config.granularity track by $index"><a class="filter-list-a" title="{{adv | timestamp2LocaleDate: it.config.granularity}}" ng-click="refreshCharts(it,\'\',[adv])">{{adv | timestamp2LocaleDate: it.config.granularity}}</a></li><li ng-if="it.config.granularity === \'week\'" ng-repeat="adv in queryString[it.df_id].list | query_inner:queryString[it.df_id].keyword:it.config.granularity track by $index"><a class="filter-list-a" title="{{adv | timestamp2LocaleDate: it.config.granularity}}({{adv | weekFormat}})" ng-click="refreshCharts(it,\'\',[adv])">{{adv | timestamp2LocaleDate: it.config.granularity}} <span>({{adv | weekFormat}})</span></a></li></ul></div></div></dd></dl></div><div class="global-filter-r global-filter-handler"><a class="bdp-icon-wrap cursor-pointer" ng-if="scrollHandler.nextIndex !== 0 && scrollHandler.nextIndex !== globalDashFilter.length" ng-click="scrollHandler.scroll(1)"><i class="bdp-icon ico-triangle-right"></i></a></div>'),i.put("/static/js/common/tpl/guide/database_guide.html",'<div class="database-view guide-page" ng-if="showGuide"><div class="nav" ng-if="[3].indexOf(guide) != -1"><span>数据源</span></div><div class="dashed pa" ng-if="[3].indexOf(guide) != -1"></div><div class="init-guide pr" ng-if="[3].indexOf(guide) != -1"><div class="db-guide-init"></div><i class="close-init pa opacity6" ng-click="closeInit()"></i> <a class="btn-blue pa font-size-14 font-w-b cursor-pointer" ng-click="gotoDataSource()"><span class="font-w-b">立即体验</span></a></div><div class="statistics-layer pr" ng-if="viewGuide == \'guide-step1\'"><ul><li class="pr"><div class="box"><span class="mb4">全部</span> <b>21</b></div></li><li><div class="box box-other"><span class="mb4">已完成</span> <b>12</b></div></li><li><div class="box box-other"><span class="mb4">正在运行</span> <b>3</b></div></li><li><div class="box box-other"><span class="cr-hint mb4">失败</span> <b>3</b></div></li><li><div class="box box-other"><span class="mb4">停用</span> <b>3</b></div></li></ul><div class="db-guide-tooltip center pr"><div class="triangle-up"></div>全局状态筛选，已有数据源概况一览无余。 <span class="pa guide-step1">1/4</span> <a class="pa know1 font-size-14 cursor-pointer font-w-b" ng-click="goOn(\'guide-step2\')">继续</a></div></div><div class="guide-main mt16 no-padding"><div class="view-side-list pt16 pr" ng-if="viewGuide == \'guide-step2\'"><div class="db-guide-tooltip pa guide-tip2"><div class="triangle-up head-left"></div>局部类型筛选与搜索，配合状态筛选，快速找到目标数据源，可搜索源标签搜索。 <span class="pa guide-step1">2/4</span> <a class="pa know1 font-size-14 cursor-pointer font-w-b" ng-click="goOn(\'guide-step3\')">继续</a></div><div class="list-masking pa" style="width: 200px;height: 200px;z-index: 9999"></div><div class="view-list-header pl16 pr"><span class="title">我的数据源</span><div class="search-bar pa"><i class="bdp-icon ico-search cursor-pointer"></i></div></div><div class="view-list-body"><ul><li class="active pl24">全部</li><li class="pl24">MySQL</li><li class="pl24">百度实况</li><li class="pl24">百度搜索推广</li></ul></div></div><div class="view-main-body pt16 pr24 pr" style="top: 210px;overflow: initial" id="table_list" ng-if="viewGuide == \'guide-step3\'"><div class="db-guide-tooltip pa guide-tip3"><div class="triangle-up head-bottom"></div>简洁的数据源列表，鼠标移动至数据源上方，显示相关操作、提示信息，删除支持直接删除数据源及其下工作表；点击数据源名称可查看同步记录和其下工作表的使用情况。 <span class="pa guide-step1">3/4</span> <a class="pa know1 font-size-14 cursor-pointer font-w-b" ng-click="goOn(\'guide-step4\')">继续</a></div><div class="masking2"></div><table class="bdp-table-normal w100 database-table"><thead><tr><th class="db-name cursor-pointer">名称</th><th class="cursor-pointer db-status">状态</th><th class="cursor-pointer db-sync-time">最近同步时间</th></tr></thead><tbody><tr><td class="pr"><img ng-src="/static/images/s-logo.png" width="40" class="fl"><div class="database-table-name pr"><div><a class="ds-name">我的数据源1</a> <span class="display-block tag-label">#标签1#</span></div><div class="operate-layer pa" style="display: block"><a class="bdp-btn-blue cursor-pointer">详情配置</a> <a class="bdp-btn-blue cursor-pointer">同步</a> <a class="bdp-btn-blue cursor-pointer">合并</a> <a class="bdp-btn-blue cursor-pointer">删除</a></div></div></td><td><span>正在运行</span></td><td><span>一天前</span></td></tr><tr><td class="pr"><img ng-src="/static/images/s-logo.png" width="40" class="fl"><div class="database-table-name pr"><div class="line-height-40"><a class="ds-name">我的数据源2</a></div></div></td><td><span class="cr-hint">失败:余额不足，请充值</span></td><td><span>一天前</span></td></tr><tr><td class="pr"><img ng-src="/static/images/s-logo.png" width="40" class="fl"><div class="database-table-name pr"><div><a class="ds-name">我的数据源3</a> <span class="display-block tag-label">#标签1#</span></div></div></td><td><span>正在运行</span></td><td><span>一天前</span></td></tr><tr><td class="pr"><img ng-src="/static/images/s-logo.png" width="40" class="fl"><div class="database-table-name pr"><div class="line-height-40"><a class="ds-name">我的数据源4</a></div></div></td><td><span>正在运行</span></td><td><span>一天前</span></td></tr></tbody></table></div></div><div ng-if="viewGuide == \'guide-step4\'"><div class="btn-layer"><a class="nowrap add"><i class="bdp-icon ico-add-database ico-opacity"></i> <span class="pr ml4">{{ \'ds.adddatasource\' | translate }}</span></a><div class="db-guide-tooltip pa guide-tip4"><div class="triangle-up head-top"></div>全新的数据源列表页，全面直观浏览全部可用数据源，优化了添加流程，操作更加便捷。 <span class="pa guide-step1">4/4</span> <a class="pa know1 font-size-14 cursor-pointer font-w-b" ng-click="quit()">我知道了</a></div></div></div><div ng-if="viewGuide == \'guide-step5\'"><div class="block-beta pa"><i class="ico-beta"></i></div><div class="db-guide-tooltip pa guide-tip5"><div class="triangle-up head-bottom1"></div><p class="font-size-14 mb8 font-w-b">公开试用</p>带有BETA标识数据源为最近上线，由于第三方限制，可能会偶尔同步失败或延迟，BDP会结成推动第三方优化，稳定后将自动升级为正式服务。 <a class="pa know1 font-size-14 cursor-pointer font-w-b" ng-click="quit()">我知道了</a></div></div><div ng-if="viewGuide == \'guide-step6\'"><div class="guide-usage pa" ng-style="style"><div class="db-guide-tooltip pa guide-tip6"><div class="triangle-up head-right"></div><p class="font-size-14 mb8 font-w-b">使用说明</p>可以在右侧查看数据源配置的所需信息，帮助你快速完成添加配置。 <a class="pa know1 font-size-14 cursor-pointer" ng-click="quit()">我知道了</a></div><div class="mg24" style="overflow: auto"><p class="form-desc-title mb16 font-w-b">使用说明</p><dl ng-repeat="it in descInfo" class="mb8"><dt>{{it.name[language]}}</dt><dd ng-bind-html="it.desc[language] | htmlFilter"></dd></dl></div></div></div><a class="quit pa font-underline cursor-pointer" ng-click="quit(\'quit\')" ng-if="showGuide && [3].indexOf(guide) == -1">退出引导</a></div>'),i.put("/static/js/common/tpl/guide/dot_guide.html",'<div ng-if="watchStatus == dotGuideData[guideItem].guideNum"><div class="dot-guide" ng-hide="dotMask == true || !dotGuideData[guideItem].tooltipText" ng-click="clickShowInfo()"></div><div class="circle-group" ng-click="guideItem == \'drillChart\' ? clickShowInfo() : null" ng-class="{\'cursor-pointer\': guideItem == \'drillChart\'}"><div class="circle4"></div><div class="circle3"></div><div class="circle2"></div><div class="circle1"></div></div><div class="dot-guide-tip" ng-show="showDotGuideTip == true && dotGuideData[guideItem].tooltipText"><p class="dot-guide-tip-text" ng-bind-html="dotGuideData[guideItem].tooltipText | toSce"></p><div class="tip-operate clearfix"><div class="see-help" ng-show="dotGuideData[guideItem].videoSrc"><span class="" ng-click="seeHelpVideo();showDotVideo = true"><i class="bdp-icon ico-help"></i> <span class="ico-help-text">{{\'operatorHelp\'|translate}}</span></span></div><div class="know-and-close" ng-click="iKnowClick()">知道了</div></div></div></div>'),i.put("/static/js/common/tpl/guide/user_guide.html",'<div ng-include="guideMask"></div><div class="quit-user-guide" ng-click="exitGuide()" ng-show="guideMask && guideStep != 0 && guideStep != 3 && guideStep != 105 && guideStep != 107 &&  guideStep != 2">退出引导</div>'),i.put("/static/js/common/tpl/nav_notice.html",'<div class="pr"><span class="bdp-icon-wrap" ng-class="{\'unread\':unread > 0}" title="消息中心"><i class="bdp-icon ico-message" ng-click="goToListPage()"></i> <i ng-show="hasNewNotice.unReadTotal > 0" class="unwatched active"></i></span><div class="nav-notice-list-wrap" ng-class="{\'single-notice\': hasNewNotice.unReadTypeLen == 1}" ng-if="hasNewNotice.show"><ul class="nav-notice-list"><li class="nav-notice-item" ng-if="noticTipsMol[navNoticeItem.typeId].show" ng-repeat="navNoticeItem in navNoticeList" ng-click="goToListPage(navNoticeItem.typeId)">你有 {{navNoticeItem.unReadNewsLen}}条<span class="notice-type">【{{navNoticeItem.typeId | noticeTypeMap}}】</span>消息</li></ul><div class="close-notice-btn"><i class="bdp-icon ico-gis-close cursor-pointer" ng-click="closeNavNotice()"></i></div></div></div>'),i.put("/static/js/common/tpl/nav_project_list.html",'<div class="side-nouse-wrap"></div><a class="drag-btn" resize-project-list data-draw-chart-url="draw_chart_url" title="{{ \'dragResize\' | translate}}" ng-if="view != \'dash_tpl\'"></a><div class="create-block"><p class="fl" ng-if="view != \'dash_tpl\'" translate="dash"></p><p class="fl" ng-if="view == \'dash_tpl\'">模板列表</p><div class="pa"><div class="display-inline-block search-chart-wrap" search-chart ng-class="{open : show_search_box}"><a class="bdp-icon-wrap" ng-click="showSearchBar()"><i class="bdp-icon ico-search"></i></a><div class="dropdown-wrap search-chart-box" ng-show="show_search_box"><div><input class="dash-search-input" type="text" ng-model="search_name" ng-keyup="onSearchKeyUp($event)" placeholder="{{\'dash.searchChart\'|translate}}"><div class="empty-tip height-32" ng-if="search_name && search_result_empty">{{\'dash.searchChartEmpty\'| translate }}</div><div ng-loading-gif size="size-1x" ng-show="showSearchBoxLoading"></div><ul class="search-chart-list" ng-show="!!search_name && !showSearchBoxLoading"><li class="search-result-type" ng-if="old_search_chart_list.length > 0">{{ \'chart\' | translate }} <span class="search-result-list-num">{{old_search_chart_list.length}}</span> <span class="search-result-list-more fr cursor-pointer" ng-click="getMoreSearchList($event,\'chart\')" ng-show="old_search_chart_list.length > 3 && old_search_chart_list.length != search_chart_list.length">{{ \'more\' | translate }}</span> <span class="search-result-list-more fr cursor-pointer" ng-click="getFoldUpSearchList($event,\'chart\')" ng-show="old_search_chart_list.length > 3 && old_search_chart_list.length == search_chart_list.length">{{ \'foldUp\' | translate }}</span></li><li ng-repeat="item in search_chart_list" class="cursor-pointer search-result-item" ng-click="jumpToSearchChart(item)"><p class="nowrap chart-name" title="{{item.ct_name}}">{{item.ct_name}}</p><p class="nowrap dash-name" title="{{item.proj_name}}/{{item.dsh_name}}">{{item.proj_name}}&nbsp;/&nbsp;{{item.dsh_name}}</p></li><li class="search-result-type" ng-if="old_search_dashboard_list.length > 0">{{ \'dash\' | translate }} <span class="search-result-list-num">{{old_search_dashboard_list.length}}</span> <span class="search-result-list-more fr cursor-pointer" ng-click="getMoreSearchList($event,\'dashboard\')" ng-show="old_search_dashboard_list.length > 3 && old_search_dashboard_list.length != search_dashboard_list.length">{{ \'more\' | translate }}</span> <span class="search-result-list-more fr cursor-pointer" ng-click="getFoldUpSearchList($event,\'dashboard\')" ng-show="old_search_dashboard_list.length > 3 && old_search_dashboard_list.length == search_dashboard_list.length">{{ \'foldUp\' | translate }}</span></li><li ng-repeat="item in search_dashboard_list" class="cursor-pointer search-result-item" ng-click="jumpToSearchDashboard(item)"><p class="nowrap chart-name" title="{{item.dsh_name}}" ng-class="{\'has-label\': !!item.label}"><span class="chart-name-span nowrap">{{item.dsh_name}}</span><span class="item-label dash nowrap" ng-show="!!item.label">{{item.label}}</span></p><p class="nowrap dash-name" title="{{item.proj_name}}">{{item.proj_name}}</p></li><li class="search-result-type" ng-if="old_search_project_list.length > 0">{{ \'folder\' | translate }} <span class="search-result-list-num">{{old_search_project_list.length}}</span> <span class="search-result-list-more fr cursor-pointer" ng-click="getMoreSearchList($event,\'project\')" ng-show="old_search_project_list.length > 3 && old_search_project_list.length != search_project_list.length">{{ \'more\' | translate }}</span> <span class="search-result-list-more fr cursor-pointer" ng-click="getFoldUpSearchList($event,\'project\')" ng-show="old_search_project_list.length > 3 && old_search_project_list.length == search_project_list.length">{{ \'foldUp\' | translate }}</span></li><li ng-repeat="item in search_project_list" class="cursor-pointer search-result-item" ng-click="jumpToSearchProject(item)"><p class="nowrap chart-name" title="{{item.name}}">{{item.name}}</p></li></ul></div></div></div><div class="display-inline-block show-add op-add-icon" ng-if="permision.projEdit" ng-click="show_add = !show_add" click-outside="show_add = false" outside-active="show_add"><a class="bdp-icon-wrap"><i class="bdp-icon ico-plus1"></i></a><ul class="dropdown-wrap create-op-list" ng-show="show_add"><li><a ng-click="show_create_proj_dialog()" class="dropdown-item" translate="dash.createProj"></a></li><li><a ng-click="show_create_dash_dialog()" class="dropdown-item" translate="dash.createDash"></a></li></ul></div><div class="display-inline-block show-add" ng-if="permision.projEdit" ng-click="show_add = !show_add" click-outside="show_add = false" outside-active="show_add"><a class="bdp-icon-wrap"><i class="bdp-icon ico-more"></i></a><ul class="dropdown-wrap create-op-list switch-all" ng-show="show_add"><li><a ng-click="tapAllProject(all_project_list,0)" class="dropdown-item" translate="dash.closeAll"></a></li><li><a ng-click="tapAllProject(all_project_list,1)" class="dropdown-item" translate="dash.openAll"></a></li></ul></div></div></div><div class="J-scroll-project project-nav project-list" ng-class="{\'under-workspace\': workspaceList && workspaceList[\'dash\'].length > 0}"><div class="list-hd"><div ng-if="isThirdIframeMobile.type" class="thirdIframe-dash-list-title">我的仪表盘</div><ul class="own-project-list" ui-sortable="sortProject" ng-model="all_project_list"><li ng-repeat="project in all_project_list" class="project-item" ng-class="{\'active\':project.proj_id==selected.proj_id,\'first\':$first,\'J-sort-disabled\':view == \'dash_tpl\' || isThirdIframeMobile.type}"><p class="cat cat-op-parent" ng-hide="editState[project.proj_id]" data-ng-click="tapProject(project, \'tab\')"><i class="bdp-icon fl" ng-class="{\'ico-folder1\': project.type == 0 && !project.property,\n                    \'ico-folder-rule\':project.property || project.type == 2, \'ico-folder-shared\': project.type == 1}"></i> <span class="cat-op fr"><a class="bdp-icon-wrap" title="{{\'share\'|translate}}" ng-if="project.dsh_list.length > 0 && share && project.type == 0 && permision.innerShare && !wsId" data-type="folder" data-id="{{project.proj_id}}" share-dash><i class="bdp-icon ico-share1"></i> </a><a class="bdp-icon-wrap" ng-if="permision.projEdit && project.property == 0" title="{{ \'edit\' | translate}}" ng-click="getPorName($index,project.name,project.proj_id, $event)"><i class="bdp-icon ico-text-edit"></i> </a><a class="bdp-icon-wrap" ng-if="permision.projEdit && project.property == 0" title="{{ \'remove\' | translate}}" ng-click="delProject($index,project,$event)"><i class="bdp-icon ico-trash"></i> </a></span><b class="nowrap project-name" title="{{project.name}}">{{project.name}}</b></p><p class="edit" ng-show="editState[project.proj_id]"><input type="text" class="t-input rename-input" ng-model="current.proName" ng-keydown="isEnterKey($event,\'project_rename\')"> <i class="bdp-icon ico-ok pa" ng-click="editProject($index,project.proj_id)"></i></p><div class="list-bd" ng-show="projFolding[project.proj_id] || projFolding[project.proj_id + \'$\' + project.rule_id]"><div class="box mb8"><ul class="dash-list" ng-class="{\'own-dash-list\': project.type == 0}" ui-sortable="project.type == 0 ? sortOwnDashboard : sortDashboard" ng-model="project.dsh_list" data-proj-id="{{project.proj_id}}"><li ng-repeat="it in project.dsh_list" class="dashboard-item sortable-element J-tag-dash-li" ng-class="{\'active\':(it.dsh_id+project.rule_id) == selected.dsh_id_rule_id, \'has-label\': !!it.label || !!it.comment, \'J-sort-disabled\':view == \'dash_tpl\' || isThirdIframeMobile.type}" ng-mouseenter="isThirdIframeMobile.type ? \'\' : (over_handler_more = true)" ng-mouseleave="over_handler_more = false" label-comment-tooltip="it" tooltip-placement="right" tooltip-adaptiv="true"><div class="cat-op-parent" ng-hide="editState[it.dsh_id]"><div class="cat-op cat-op-show fr cat-op-margin"><div class="bdp-icon-wrap ng-hide" title="{{\'more\'| translate }}" click-outside="field.handler_more_show = false" outside-active="field.handler_more_show" ng-click="field.handler_more_show = !field.handler_more_show; copyDashboard.handlerMorePos($event)" ng-if="project.type == 0 && permision.projEdit && it.property == 0" ng-show="field.handler_more_show || over_handler_more" nav-project-drop-down drop-down-flag="field.handler_more_show"><i class="bdp-icon ico-more"></i><ul class="dropdown-wrap field-editable-handler-more" ng-show="field.handler_more_show"><li ng-click="dashboard.edit($event, it, project)" class="dropdown-item ng-binding">{{ \'edit\' | translate}}</li><li class="dropdown-item" ng-if="share && permision.innerShare && project.type == 0 && !wsId" data-type="dashboard" data-id="{{it.dsh_id}}" share-dash>{{ \'share\' | translate}}</li><li ng-click="copyDashboard.open(it)" class="dropdown-item">{{ \'copy\' | translate}}</li><li ng-click="delDashboard($index,it, project)" class="ng-binding dropdown-item">{{ \'remove\' | translate}}</li></ul></div></div><a ng-if="project.type == 0" ng-click="tapDashboard(it.dsh_id, project, true)" class="nowrap dash-name"><span>{{it.name}}</span> </a><a ng-if="project.type == 1" ng-click="tapDashboard(it.dsh_id, project, true)" class="nowrap dash-name"><span>{{it.name}}</span> </a><a ng-if="project.type == 2" ng-click="tapDashboard(it.dsh_id, project, true)" class="nowrap dash-name"><span>{{it.name}}</span></a></div><p class="edit" ng-if="!project.share" ng-show="editState[it.dsh_id]"><input type="text" class="t-input rename-input" ng-model="current.name" ng-keydown="isEnterKey($event,\'dashboard_rename\', project)"> <i class="bdp-icon ico-ok pa" ng-click="dashboard.save(current)"></i></p></li></ul></div></div></li></ul></div></div><div warning-amount></div>'),i.put("/static/js/common/tpl/notice_broadcast.html",'<div class="new-broadcast-wrap" ng-show="enterprise_type == 3 && personalInfo.new_version"><div class="new-broadcast-bg"></div><div class="new-broadcast"><div class="btn-close" ng-click="closeBroadcast()">×</div><p class="broadcast-title">BDP个人版重装上线啦~</p><div class="broadcast-info"><dl class="info-list"><dt class="info-title">会员体系</dt><dd class="info-content">为满足不同用户的数据分析需求，我们新增了银钻和金钻会员等级。会员用户将享有直连数据库、使用数据同步客户端、使用专属APP、超大数据容量等各种超值特权。</dd><dt class="info-title">数据容量扩充</dt><dd class="info-content">所有免费用户数据容量已经从20M提升至了100M，让数据更好地服务于工作。</dd><dt class="info-title">行业模板库</dt><dd class="info-content">针对不同行业的用户，贴心打造了行业数据模板。你只需要通过BDP的“替换数据”功能，将你的数据套用到模板数据中，即可让模板为你所用。</dd></dl><div class="btn-learn-more" ng-click="toLearn()">了解更多</div></div></div></div>'),i.put("/static/js/dashboard/tpl/chart_operate.html",'<div class="chart-operate"><a class="cursor-pointer bdp-icon-wrap chart-op-refresh" ng-click="refreshChart({type:\'refresh\'})" title="{{\'dash.chartRefresh\' | translate}}"><i class="bdp-icon ico-refresh"></i> </a><a class="bdp-icon-wrap chart-op-edit" ng-if="!proj_share && permision.dashOperate && child.meta.property == 0 && !isFullscreenMode" ng-click="edit()" title="{{\'edit\' | translate}}"><i class="bdp-icon ico-edit"></i> </a><a chart-full-screen chart-url="draw_chart_url" domid="child.dom_id" standard-items="dashStandardItems" class="chart-op-fs"></a><div chart-info-summary class="pr bdp-icon-wrap chart-info-summary-icon chart-op-sum"><i class="bdp-icon ico-info-sign" ng-class="{\'active\': child.meta.refresh}"></i><div class="dropdown-wrap chart-info-summary"><em class="arrow-up"></em><div class="summary-content-wrap"><table class="chart-info-summary-content"><tr><td class="label" style="width:{{width}}px">{{\'dash.dataUpdate\'| translate}}</td><td class="text">{{tb_update_time | date:\'yyyy-MM-dd HH:mm:ss\'}}</td></tr><tr ng-if="child.meta.refresh"><td class="label" style="width:{{width}}px">{{\'dash.upadateStatus\'| translate}}</td><td class="text">{{\'dash.chartDataRefresh\' | translate}}</td></tr><tr ng-repeat="y in yAxis" ng-if="y.description"><td class="label" title="{{y.nick_name || y.name}}">{{y.nick_name || y.name}}</td><td class="text">{{y.description}}</td></tr><tr ng-repeat="x in xAxis" ng-if="x.description"><td class="label" title="{{x.nick_name || x.name}}">{{x.nick_name || x.name}}</td><td class="text">{{x.description}}</td></tr><tr ng-if="description"><td class="label">{{\'dash.chartRemark\'| translate}}</td><td class="text">{{description}}</td></tr></table></div></div></div><a class="bdp-icon-wrap chart-warn-alert-icon chart-op-warn" ng-if="canSetWarnLine()" ng-click="showSetWarningDialog()" title="{{ \'chart.warningSetting\'| translate }}"><i class="bdp-icon ico-alarm-on" ng-class="{\'ico-alarm-active\': warnSwitchOn, \'ico-always-highlight\': warnSwitchOn}"></i></a><div dash-filter adv-date-list="child.meta.adv_date_list" chart-options="draw_chart_url[child.dom_id].options" opts="item.children[0]"></div><a class="bdp-icon-wrap table-adv-sort-dashboard" ng-if="selected_type === \'C200\'" ng-click="showTableAdvSort(child.meta)" title="{{\'chart.tableAdvSortTitle\' | translate}}" ng-mouseover="showAdvTip = !showAdvTip" ng-mouseout="showAdvTip = !showAdvTip"><i class="bdp-icon" ng-class="{true: \'ico-table-adv-sort-cur\', false: \'ico-table-adv-sort\'}[child.meta.is_advanced_sort == 1 && child.meta.advanced_sort.length > 0]"></i><div class="guide-wrap" ng-if="showAdvTip"><div class="dot-guide-tip guide-hover-tip-none" ng-if="!child.meta.advanced_sort || child.meta.advanced_sort.length == 0 || child.meta.is_advanced_sort == 0"><div>{{\'chart.noAdvSortRule\' | translate}}</div></div><div class="dot-guide-tip guide-hover-tip" ng-if="child.meta.is_advanced_sort == 1 && child.meta.advanced_sort.length > 0"><div class="adv-sort-rule-title">{{\'chart.advSortRule\' | translate}}</div><ul class="adv-sort-rule-content"><li ng-repeat="item in child.meta.advanced_sort"><span class="adv-sort-field nowrap">{{item.name}}</span> <span class="adv-sort-order-type" ng-if="item.type == \'asc\' "><i class="trigger-col-sort bdp-icon ico-asc-sort-arrow"></i>{{\'ascending\' | translate}}</span> <span class="adv-sort-order-type" ng-if="item.type == \'desc\' "><i class="trigger-col-sort bdp-icon ico-desc-sort-arrow"></i>{{\'descending\' | translate}}</span></li></ul></div></div></a><div operate-more data-chart-url="draw_chart_url[child.dom_id]" opts="item.children[0]" ng-hide="global.hideChartMore"></div></div>'),i.put("/static/js/dashboard/tpl/chart_operate_more.html",'<div class="chart-operate-more bdp-icon-wrap J-dot-dash-edit" ng-class="{\'active is-show-wrap-bg\':more_show == true}" click-outside="more_show = false" outside-active="more_show" title="{{\'more\' | translate}}" ng-click="setOperatorPos($event);" p-index="{{$parent.$parent.$parent.$index}}"><i class="bdp-icon ico-more"></i><ul ng-show="more_show" class="dropdown-wrap"><li ng-if="permision.allowExporting && child.meta.drillChartType != \'C200\' && child.meta.drillChartType != \'C310\' && !child.meta.split_compare" export-img data-mode="dashboard" data-setting="{{child.meta.dash_setting}}" translate="dash.exportImg" data-filename="{{child.meta.name}}" class="dropdown-item"></li><li ng-if="permision.allowExporting && global.exportDataSetting.is_export == 1" data-charttype="{{child.meta.type}}" export-excel data-mode="dashboard" translate="dash.exportExcel" class="dropdown-item"></li><li ng-if="!proj_share && permision.dashOperate && child.meta.property == 0" ng-click="move_chart()" translate="dash.moveChart" class="dropdown-item"></li><li ng-if="!proj_share && permision.dashOperate  && child.meta.property == 0" ng-click="copy_chart()" translate="dash.copyChart" class="dropdown-item"></li><li ng-if="!proj_share && permision.dashOperate  && child.meta.property == 0" ng-click="chartChain.open(child.meta)" class="pr chart-china-text dropdown-item" ng-class="{\'dropdown-item-disabled\': !chartChain.checkSupport(child.meta)}"><span translate="dash.chartLink"></span> <span class="del-chart-chain" ng-if="child.meta.chart_link.linked_chart_type == \'2\'" ng-click="chartChain.del($event,child.meta.ct_id)"><i class="bdp-icon ico-trash"></i></span></li><li ng-if="!proj_share && permision.dashOperate  && child.meta.property == 0" ng-click="chartDashJump.showDia(child.meta)" class="pr chart-china-text dropdown-item" ng-class="{\'dropdown-item-disabled\': !chartDashJump.checkSupport(child.meta)}"><span translate="dash.dashChartJump"></span> <span class="del-chart-chain" ng-if="child.meta.chart_jump.can_jump == \'1\'" ng-click="chartDashJump.del($event, child.meta.ct_id)"><i class="bdp-icon ico-trash"></i></span></li><li ng-if="!proj_share && permision.dashOperate && child.meta.property == 0" ng-click="del()" translate="remove" class="dropdown-item"></li></ul></div>'),i.put("/static/js/dashboard/tpl/dash_edit.html",'<div ng-if="!global.showMobLayout" class="dash-edit-content-view"><div class="dash-title-wrap view-header-wrap" ng-hide="dashEditMode"><div class="clearfix dash-title view-header"><h2>{{dashTitle}}</h2><div class="btn-layer" ng-if="!dashFullscreen && permision.dashEdit && property == 0 && !isThirdIframeMobile.type"><a ng-if="enterprise_type == 3 && isTpl" class="dash-add-item-btn J-see-template-data pr"><i class="bdp-icon ico-sheet-data" ng-click="gotoTplSheet()"></i> <span class="btn-layer-opt" ng-click="gotoTplSheet()">替换模板数据 <span class="btn-layer-hover-line"></span> </span><i class="bdp-icon ico-triangle-down mr0" ng-click="showDownloadSheet = !showDownloadSheet" click-outside="showDownloadSheet = false" outside-active="showDownloadSheet"></i><ul class="dropdown-wrap dash-display-mode-list" ng-show="showDownloadSheet" style="right: 20px"><li class="dropdown-item"><span ng-click="personalDashExcelExport()">下载模板数据</span></li></ul></a><a ng-if="!proj_share && !dashEditMode && !(enterprise_type == 5 || enterprise_type == 6)" ng-click="addItem()" class="dash-add-item-btn"><i class="bdp-icon ico-add-chart"></i> <span class="btn-layer-opt">{{ \'dash.addChart\' | translate }} <span class="btn-layer-hover-line"></span></span></a><div class="display-inline-block pr"><div ng-if="enterprise_type == 3" ng-show="guide != 1 && guide != 2" dot-guide dot-mask="dotMask.design" guide-item="design" guide-type="dash_edit" watch-status="personalInfo.dashboard_guide" btn-class="J-dot-design" add-class="\'dot-guide-design\'"></div><a ng-if="!proj_share && !dashEditMode && !(enterprise_type == 5 || enterprise_type == 6)" ng-click="makeDashEdit(true)" ng-if="permision.dashEdit && property == 0" class="J-design-button J-dot-design"><i class="bdp-icon ico-edit-layout"></i> <span class="btn-layer-opt"><span ng-if="enterprise_type != 3">{{ \'design\' | translate }}</span> <span ng-if="enterprise_type == 3">图文模式</span> <span class="btn-layer-hover-line"></span></span></a></div><a ng-if="!dashEditMode && !permision.outerShare"><i class="bdp-icon ico-fullscreen-2" ng-click="enterFullScreen(false)"></i> <span class="btn-layer-opt" ng-click="enterFullScreen(false)">{{ \'dash.fullscreen\' | translate }} <span class="btn-layer-hover-line"></span> </span><i class="bdp-icon ico-triangle-down" ng-click="show_presentation_mode = !show_presentation_mode" click-outside="show_presentation_mode = false" outside-active="show_presentation_mode"></i><ul class="dropdown-wrap dash-display-mode-list" ng-show="show_presentation_mode"><li class="dropdown-item" ng-click="enterFullScreen(true)"><i class="bdp-icon ico-presentation-mode"></i> {{ \'dash.presentationMode\' | translate }}</li></ul></a><div class="outer-share pr display-inline-block cursor-pointer J-share-button" social-share ng-if="permision.dashEdit && property == 0 && permision.outerShare" ng-click="outerShareFuncs = !outerShareFuncs" click-outside="outerShareFuncs = false" outside-active="outerShareFuncs"><div class="pr"><div ng-if="enterprise_type == 3" ng-show="guide != 1 && guide != 2" dot-guide dot-mask="dotMask.share" guide-item="share" guide-type="dash_edit" watch-status="personalInfo.dashboard_guide" btn-class="J-dot-share" add-class="\'dot-guide-share\'"></div><div class="J-dot-share" ng-click="(outer_share_info.sdo_id) ? \'\' : showShareDialog()"><i class="bdp-icon ico-share2 pr"><i class="unwatched ng-hide" ng-show="outer_share_info.unread_total > 0" ng-class="{\'active\': outer_share_info.unread_total > 0}"></i> </i><span>分享</span> <i class="bdp-icon ico-triangle-down" ng-if="outer_share_info.sdo_id"></i></div></div><div class="outer-share-funcs ng-hide" ng-show="outerShareFuncs && outer_share_info.sdo_id"><div class="dropdown-wrap"><div class="dropdown-item" ng-click="showShareDialog()">我要分享</div><div class="dropdown-item"><a class="outer-share-link" ng-click="outer_share_info.unread_total = 0" href="/share/index.html?shareId={{outer_share_info.sdo_id}}" target="_blank">查看分享<span class="ml4 outer-share-unread" ng-if="outer_share_info.unread_total > 0">{{outer_share_info.unread_total}}</span></a></div><div class="dropdown-item cursor-pointer" ng-click="cancelSharePop();">取消分享</div></div></div></div><a class="more-btn" ng-if="!dashEditMode" ng-click="show_more_btn = !show_more_btn" click-outside="show_more_btn = false" outside-active="show_more_btn"><i class="bdp-icon ico-more"></i><ul class="dropdown-wrap dash-more-list" ng-show="show_more_btn"><li class="dropdown-item global-filter-set" ng-if="!proj_share && dashSelected" global-filter-set original-global-filter="global.originalGlobalFilter" global-dash-filter="global.globalDashFilter" dash-standard-items="dashStandardItems" global-dash-filter-items="global.globalDashFilterItems" rule-id="global.rule_id" draw_chart_url="draw_chart_url">{{ "dash.globalFilter" | translate }}</li><li ng-if="permision.allowExporting" export-dashboard ng-click="showExportDialog()" class="dropdown-item dash-add-item-btn">{{ \'dash.exportDashboard\' | translate }}</li></ul></a></div><div class="mobile-dash-list" ng-if="isThirdIframeMobile.type" ng-click="showThirdIframeDshList()"><i class="icon-third-back"></i></div></div></div><div class="view-header dash-edit-wrapper clearfix" ng-if="dashEditMode"><h3 class="design-title" ng-if="enterprise_type != 3">{{ \'dash.designDashboard\' | translate }}</h3><div class="btn-layer"><div class="item design-mob" ng-if="dashLayoutInfo.layout_style == 2"><a ng-click="setMobLayout(true)"><i class="bdp-icon ico-mobile"></i> <span class="btn-layer-opt">{{\'dash.dashModeMob\'|translate}} <span class="btn-layer-hover-line"></span></span></a></div><div class="item"><div class="view-header-seperate-line" ng-if="dashLayoutInfo.layout_style == 2"></div><a class="make-dash-edit-done" ng-click="makeDashEdit(false)"><i class="bdp-icon ico-ok-blue"></i> <span class="btn-layer-opt">{{ \'done\' | translate }} <span class="btn-layer-hover-line"></span></span></a></div></div><div class="design-title switch-layout" ng-if="enterprise_type == 3"><ul><li><label class="mr16"><input type="radio" ng-model="dashLayoutInfo.layout_style" value="1" ng-change="updateGridLayout()"> {{\'dash.layoutStandard\'|translate}}</label><label><input type="radio" ng-model="dashLayoutInfo.layout_style" value="2" ng-change="updateGridLayout()"> {{\'dash.layoutFree\'|translate}}</label></li></ul></div><div class="block chart-component" ng-if="enterprise_type == 3"><div class="hd">{{ \'dash.addComponent\' | translate }}</div><div class="bd"><ul><li><a ng-if="!proj_share && !(enterprise_type == 5 || enterprise_type == 6)" ng-click="addItem()" class="bdp-icon-wrap add-chart"><i class="bdp-icon ico-component-chart"></i>{{ \'chart\' | translate }}</a></li><li><a class="bdp-icon-wrap add-text" ng-click="dash.addTextComponent()"><i class="bdp-icon ico-component-text"></i>{{ \'text\' | translate }}</a></li></ul></div></div><div class="block" ng-if="dashLayoutInfo.layout_style != 2 && !dashLayoutInfo.id"><div class="hd">{{\'dash.layoutSetting\'|translate}}</div><div class="bd"><ul><li><label><input type="checkbox" ng-model="dashLayoutInfo.show_block" ng-change="dash.modify(\'show_block\')"> {{\'dash.showElementBorder\'|translate}}</label></li><li><label><input type="checkbox" ng-model="dashLayoutInfo.fixed_width" ng-change="dash.modify(\'fixed_width\')"> {{\'dash.fixedWidth\'|translate}}</label></li></ul></div></div><div class="block ml16" ng-if="!dashLayoutInfo.id"><div class="view-header-seperate-line"></div><span class="setting-tip mr16">{{\'dash.designTip1\'|translate}}</span></div><div class="block ml16" ng-if="dashLayoutInfo.dash_setting" ng-show="dash.canSetTitle()"><div class="view-header-seperate-line"></div><div class="hd">{{ \'dash.displayProperty\' | translate }}</div><div class="bd"><ul><li ng-show="dash.canSetTitle()"><label><input type="checkbox" ng-model="dashLayoutInfo.dash_setting.show_title" ng-change="dash.modify(\'title\')"> {{\'dash.showTitle\' | translate }}</label></li><li ng-show="dash.canSetLegend()"><label><input type="checkbox" ng-model="dashLayoutInfo.dash_setting.show_legend" ng-change="dash.modify(\'legend\')"> {{\'dash.showLegend\' | translate }}</label></li><li ng-show="dash.canSetAxis()"><label><input type="checkbox" ng-model="dashLayoutInfo.dash_setting.show_axis" ng-change="dash.modify(\'axis\')"> {{\'dash.showAxis\' | translate }}</label></li><li ng-show="dash.canSetDataLabels()"><label><input type="checkbox" ng-model="dashLayoutInfo.dash_setting.show_datalabels" ng-change="dash.modify(\'datalabels\')"> {{\'dash.showDataLabels\' | translate }}</label></li><li ng-show="dash.canSetTotal()"><label><input type="checkbox" ng-model="dashLayoutInfo.dash_setting.show_total" ng-change="dash.modify(\'total\')"> {{\'dash.showTotal\' | translate }}</label></li><li ng-show="dash.canSetNavigator()"><label><input type="checkbox" ng-model="dashLayoutInfo.dash_setting.show_navigator" ng-change="dash.modify(\'navigator\')"> {{\'dash.showNavigator\' | translate }}</label></li></ul></div></div><div class="block dash-border ml16" ng-show="dashLayoutInfo.ct_id && !dashLayoutInfo.show_block"><div class="view-header-seperate-line"></div><div class="hd">{{\'border\'|translate}}</div><div class="bd"><a class="bdp-icon-wrap" ng-class="{\'active\':dashLayoutInfo.dash_setting.border_null}" ng-click="dash.toggleBorder(\'null\')"><i class="bdp-icon ico-border-null"></i> </a><a class="bdp-icon-wrap" ng-class="{\'active\':dashLayoutInfo.dash_setting.border_top}" ng-click="dash.toggleBorder(\'top\')"><i class="bdp-icon ico-border-top"></i> </a><a class="bdp-icon-wrap" ng-class="{\'active\':dashLayoutInfo.dash_setting.border_right}" ng-click="dash.toggleBorder(\'right\')"><i class="bdp-icon ico-border-right"></i> </a><a class="bdp-icon-wrap" ng-class="{\'active\':dashLayoutInfo.dash_setting.border_bottom}" ng-click="dash.toggleBorder(\'bottom\')"><i class="bdp-icon ico-border-bottom"></i> </a><a class="bdp-icon-wrap" ng-class="{\'active\':dashLayoutInfo.dash_setting.border_left}" ng-click="dash.toggleBorder(\'left\')"><i class="bdp-icon ico-border-left"></i></a></div></div></div><div ng-if="!dashLoading && global.globalDashFilter.length" class="dash-global-wrap" global-filter original-global-filter="global.originalGlobalFilter" global-dash-filter="global.globalDashFilter" global-dash-filter-items="global.globalDashFilterItems" rule-id="global.rule_id" show-loading="showLoading" on-share-page="isThirdIframe" draw-chart-url="draw_chart_url"></div><div class="dash-wrapper" ng-class="{\n            \'dash-one-block\':!dashLayoutInfo.show_block,\n            \'edit-mode\':dashEditMode,\n            \'dash-fixed-width\':dashLayoutInfo.fixed_width,\n            \'hide-block-watermark\':!dashLayoutInfo.show_block && global.watterMark, \n            \'under-workspace\':(workspaceList && workspaceList[\'dash\'].length > 0),\n            \'dash-mode-free\':dashLayoutInfo.layout_style == 2,\n            \'has-global-filter\': global.globalDashFilter.length > 0\n            }"><div class="folder-empty" ng-if="showEmptyDash"><img src="/static/images/empty-folder.png"><p translate="dash.emptyDash" class="mt8"></p></div><div gridster="gridsterOpts"><div ng-if="!selected.proj_share" ng-hide="dashInit.load"><div ng-if="!proj_share && selected.dsh_id  && dashStandardItems.length == 0" ng-click="addItem()" class="empty-dash-add"><span><i class="a"></i> <i class="b"></i></span><div class="textalign-center empty-dash-add-tip">{{\'dash.addChart\' | translate}}</div></div><ul id="J_gridster" ng-if="dashLayoutInfo.layout_style == 1"><li gridster-item="item" ng-repeat="item in dashStandardItems" row="item.row" col="item.col" size-x="item.sizeX" size-y="item.sizeY" ng-hide="chartdel[\'chart\'+current_item.meta.ct_id]" id="{{item.children[0].meta.ct_id}}" data-chart-type="{{item.children[0].meta.type}}" data-chart-id="{{item.children[0].meta.ct_id}}" ng-mouseleave="mouseleaveItem()" ng-class="{\n                            \'selected\':dashLayoutInfo.ct_id === item.children[0].meta.ct_id,\n                            \'border-left\':item.children[0].meta.dash_setting.border_left,\n                            \'border-right\':item.children[0].meta.dash_setting.border_right,\n                            \'border-top\':item.children[0].meta.dash_setting.border_top,\n                            \'border-bottom\':item.children[0].meta.dash_setting.border_bottom,\n                            \'no-border\':item.children[0].meta.dash_setting.border_null,\n                            \'no-title\': item.children[0].meta.type === \'C310\' || !item.children[0].meta.dash_setting.show_title,\n                            \'no-axis\': !item.children[0].meta.dash_setting.show_axis,\n                            \'component-text\': item.children[0].meta.ct_id.indexOf(\'text_\') > -1,\n                            \'J-dot-dash-edit-wrap\': $first\n                            }"><div class="pr" ng-if="$index === 0 && enterprise_type == 3" ng-show="!dashEditMode" ng-class="{\'dot-guide-C310\': item.children[0].meta.type == \'C310\', \'dot-guide-C101\': item.children[0].meta.type == \'C101\'}"><div ng-if="enterprise_type == 3" ng-show="guide != 1 && guide != 2" dot-guide dot-mask="dotMask.dashEdit" guide-item="dashEdit" guide-type="dash_edit" watch-status="personalInfo.dashboard_guide" btn-class="J-dot-dash-edit-wrap .J-dot-dash-edit" add-class="\'dot-guide-dash-edit\'"></div></div><div ng-repeat="child in item.children" class="chart-box"><div ng-if="child.meta.ct_id.indexOf(\'text_\') > -1" ng-class="{\'ta-edit-mode-on\':dashEditMode && textComponentEditMode[child.meta.ct_id]}"><div class="chart-operate" ng-if="!proj_share && dashProperty == 0"><div class="chart-operate-more bdp-icon-wrap" ng-click="more_show = !more_show" ng-mouseleave="more_show = false"><i class="bdp-icon ico-more"></i><ul ng-show="more_show" class="dropdown-wrap"><li class="dropdown-item" translate="edit" ng-click="dash.editTextFromMore(child)"></li><li class="dropdown-item" translate="remove" ng-click="dash.delComponent(child.meta.ct_id)"></li></ul></div></div><span class="ta-edit-wrap" ng-show="dashEditMode && !textComponentEditMode[child.meta.ct_id]"><a class="bdp-icon-wrap ta-edit" ng-click="dash.editTextComponent(child)"><i class="bdp-icon ico-edit"></i></a><div class="chart-operate-more bdp-icon-wrap" ng-click="more_show = !more_show" ng-mouseleave="more_show = false"><i class="bdp-icon ico-more"></i><ul ng-show="more_show" class="dropdown-wrap"><li class="dropdown-item" translate="remove" ng-click="dash.delComponent(child.meta.ct_id)"></li></ul></div></span><div ng-if="dashEditMode" text-angular ng-model="child.meta.html" name="{{child.meta.ct_id}}" ta-toolbar="[[\'BDP\'],[\'fontColor\'],[\'fontSize\'],[\'justifyLeft\',\'justifyCenter\',\'justifyRight\',\'justifyFull\'],[\'bold\',\'italics\',\'underline\',\'strikeThrough\']]"></div><div ng-if="!dashEditMode" class="item-text-chart" ng-bind-html="child.meta.html"></div><div ng-show="dashEditMode && !textComponentEditMode[child.meta.ct_id]" class="base-loading-layer" ng-click="dash.editChartMeta(child)"></div></div><div ng-if="child.meta.ct_id.indexOf(\'text_\') < 0"><div class="item-chart-title"><div class="item-chart-title-bd nowrap"><div class="display-inline-block drill-tip" ng-if="child.meta.level_fields.length > 1"><i class="bdp-icon ico-drill"></i><div class="dropdown-wrap drill-tip-bd"><span ng-repeat="drill_field in child.meta.level_fields"><i class="bdp-icon ico-slicesnav-arrow" ng-show="!$first"></i> {{drill_field.name}}</span></div></div><i class="bdp-icon ico-linked" ng-if="child.meta.chart_link.linked_chart_type == \'2\'"></i> <i class="bdp-icon ico-chart-jump" ng-if="child.meta.chart_jump.can_jump == \'1\'"></i> <span class="no-margin" ng-click="">{{child.meta.name}}</span><div class="loading-wrap"><div class="loader-inner ball-spin-fade-loader"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><span class="filter-item" ng-repeat="it in child.meta.filter_list_inner" ng-if="it.range.length && !it.adv_type"><em ng-if="it.data_type === \'date\' && !it.granularity" ng-hide="AllMap.indexOf( (it.range | format_date:child.meta.adv_date_list ) ) >= 0">{{it.range | format_date:child.meta.adv_date_list}} <span ng-if="it.granularity == \'week\'">({{it.range[0] | weekFormat:it.range[0]}})</span> </em><em ng-if="it.data_type === \'date\' && it.granularity">{{it.range | inner_range_date_format:it}} <span ng-if="it.granularity == \'week\'">({{it.range[0] | weekFormat:it.range[0]}})</span> </em><em ng-if="it.data_type !== \'date\' && !it.inner_adv_type && it.range_type != 0">{{it.range | dash_sub_date:it}}</em> <em ng-if="it.data_type !== \'date\' && ( (it.inner_adv_type && it.rangeNumber != 1) || it.range_type == 0 )"><span ng-if="!it.nick_name">{{it.name}}</span> <span ng-if="!!it.nick_name">{{it.nick_name}}</span> {{\'dash.custom\' | translate}} </em><em ng-if="it.data_type !== \'date\' && it.inner_adv_type && it.rangeNumber == 1 && it.range_type != 0 ">{{it.rangeFirstField | dash_sub_date:it}} </em></span><span class="filter-item" ng-repeat="it in child.meta.diff_filter"><em>{{it}}</em></span></div></div><div class="item-chart drag-disable" ng-class="{\'noscroll\':selected_type === \'C200\' || selected_type === \'C400\'}" id="{{child.dom_id}}" size-x="{{item.sizeX}}" size-y="{{item.sizeY}}"><div class="drill-crumbs-wrap"></div><div bdp-chart="draw_chart_url[child.dom_id].options" display-mode="{{item.sizeX + \'*\' + item.sizeY}}" data-updatetime="{{child.meta.update_time}}" data-index="$parent.$parent.$index" data-domid="child.dom_id" data-lazy-loaded="draw_chart_url[child.dom_id].lazyload" class="chart" ng-class="{\'chart-table\':selected_type === \'C200\',\n                                            \'chart-map\':selected_type === \'C271\' || selected_type === \'C272\',\n                                            \'chart-funnel overflow-hidden\':selected_type === \'C330\',\n                                            \'show-datalabels\': child.meta.dash_setting.show_datalabels,\n                                            \'hide-total\':!child.meta.dash_setting.show_total}" data-ctid="{{draw_chart_url[child.dom_id].options.ct_id}}"></div><div class="loading-wrap" ng-if="item.children[0].meta.type === \'C310\'"><div class="loader-inner ball-spin-fade-loader"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div><div chart-operate p-index="{{$parent.$parent.$index}}" class="drag-disable"></div><div ng-show="dashEditMode" class="base-loading-layer" ng-click="dash.editChartMeta(child)"></div></div></div></li></ul><ul id="J_gridster" ng-if="dashLayoutInfo.layout_style == 2"><li gridster-item="item" ng-repeat="item in dashStandardItems" style="left:{{item.left}}px;top:{{item.top}}px;width:{{item.width}}px;height:{{item.height}}px" ng-hide="chartdel[\'chart\'+current_item.meta.ct_id]" id="{{item.children[0].meta.ct_id}}" data-chart-type="{{item.children[0].meta.type}}" data-chart-id="{{item.children[0].meta.ct_id}}" ng-mouseleave="mouseleaveItem()" ng-class="{\n                            \'selected\':dashLayoutInfo.ct_id === item.children[0].meta.ct_id,\n                            \'border-left\':item.children[0].meta.dash_setting.border_left,\n                            \'border-right\':item.children[0].meta.dash_setting.border_right,\n                            \'border-top\':item.children[0].meta.dash_setting.border_top,\n                            \'border-bottom\':item.children[0].meta.dash_setting.border_bottom,\n                            \'no-border\':item.children[0].meta.dash_setting.border_null,\n                            \'no-title\': item.children[0].meta.type === \'C310\' || !item.children[0].meta.dash_setting.show_title,\n                            \'no-axis\': !item.children[0].meta.dash_setting.show_axis,\n                            \'component-text\': item.children[0].meta.ct_id.indexOf(\'text_\') > -1\n                            }"><div ng-repeat="child in item.children" class="chart-box"><div ng-if="child.meta.ct_id.indexOf(\'text_\') > -1" ng-class="{\'ta-edit-mode-on\':dashEditMode && textComponentEditMode[child.meta.ct_id]}"><div class="chart-operate" ng-if="!proj_share && dashProperty == 0"><div class="chart-operate-more bdp-icon-wrap" ng-click="more_show = !more_show" ng-mouseleave="more_show = false"><i class="bdp-icon ico-more"></i><ul ng-show="more_show" class="dropdown-wrap"><li class="dropdown-item" translate="edit" ng-click="dash.editTextFromMore(child)"></li><li class="dropdown-item" translate="remove" ng-click="dash.delComponent(child.meta.ct_id)"></li></ul></div></div><span class="ta-edit-wrap" ng-show="dashEditMode && !textComponentEditMode[child.meta.ct_id]"><a class="bdp-icon-wrap ta-edit" ng-click="dash.editTextComponent(child)"><i class="bdp-icon ico-edit"></i></a><div class="chart-operate-more bdp-icon-wrap" ng-click="more_show = !more_show" ng-mouseleave="more_show = false"><i class="bdp-icon ico-more"></i><ul ng-show="more_show" class="dropdown-wrap"><li class="dropdown-item" translate="remove" ng-click="dash.delComponent(child.meta.ct_id)"></li></ul></div></span><div ng-if="dashEditMode" text-angular ng-model="child.meta.html" name="{{child.meta.ct_id}}" ta-toolbar="[[\'BDP\'],[\'fontColor\'],[\'fontSize\'],[\'justifyLeft\',\'justifyCenter\',\'justifyRight\',\'justifyFull\'],[\'bold\',\'italics\',\'underline\',\'strikeThrough\']]"></div><div ng-if="!dashEditMode" class="item-text-chart" ng-bind-html="child.meta.html"></div><div ng-show="dashEditMode && !textComponentEditMode[child.meta.ct_id]" class="base-loading-layer" ng-click="dash.editChartMeta(child)"></div></div><div ng-if="child.meta.ct_id.indexOf(\'text_\') < 0"><div class="item-chart-title"><div class="item-chart-title-bd nowrap"><div class="display-inline-block drill-tip" ng-if="child.meta.level_fields.length > 1"><i class="bdp-icon ico-drill"></i><div class="dropdown-wrap drill-tip-bd"><span ng-repeat="drill_field in child.meta.level_fields"><i class="bdp-icon ico-slicesnav-arrow" ng-show="!$first"></i> {{drill_field.name}}</span></div></div><i class="bdp-icon ico-linked" ng-if="child.meta.chart_link.linked_chart_type == \'2\'"></i> <i class="bdp-icon ico-chart-jump" ng-if="child.meta.chart_jump.can_jump == \'1\'"></i> <span class="no-margin" ng-click="">{{child.meta.name}}</span><div class="loading-wrap"><div class="loader-inner ball-spin-fade-loader"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><span class="filter-item" ng-repeat="it in child.meta.filter_list_inner" ng-if="it.range.length && !it.adv_type"><em ng-if="it.data_type === \'date\' && !it.granularity" ng-hide="AllMap.indexOf( (it.range | format_date:child.meta.adv_date_list ) ) >= 0">{{it.range | format_date:child.meta.adv_date_list}} <span ng-if="it.granularity == \'week\'">({{it.range[0] | weekFormat:it.range[0]}})</span> </em><em ng-if="it.data_type === \'date\' && it.granularity">{{it.range | inner_range_date_format:it}} <span ng-if="it.granularity == \'week\'">({{it.range[0] | weekFormat:it.range[0]}})</span> </em><em ng-if="it.data_type !== \'date\' && !it.inner_adv_type && it.range_type != 0">{{it.range | dash_sub_date:it}}</em> <em ng-if="it.data_type !== \'date\' && ( (it.inner_adv_type && it.rangeNumber != 1) || it.range_type == 0 )"><span ng-if="!it.nick_name">{{it.name}}</span> <span ng-if="!!it.nick_name">{{it.nick_name}}</span> {{\'dash.custom\' | translate}} </em><em ng-if="it.data_type !== \'date\' && it.inner_adv_type && it.rangeNumber == 1 && it.range_type != 0 ">{{it.rangeFirstField | dash_sub_date:it}} </em></span><span class="filter-item" ng-repeat="it in child.meta.diff_filter"><em>{{it}}</em></span></div></div><div class="item-chart drag-disable" ng-class="{\'noscroll\':selected_type === \'C200\' || selected_type === \'C400\'}" id="{{child.dom_id}}" size-x="{{item.sizeX}}" size-y="{{item.sizeY}}"><div class="drill-crumbs-wrap"></div><div bdp-chart="draw_chart_url[child.dom_id].options" display-mode="{{item.sizeX + \'*\' + item.sizeY}}" data-updatetime="{{child.meta.update_time}}" data-index="$parent.$parent.$index" data-domid="child.dom_id" data-lazy-loaded="draw_chart_url[child.dom_id].lazyload" class="chart" ng-class="{\'chart-table\':selected_type === \'C200\',\n                                            \'chart-map\':selected_type === \'C271\' || selected_type === \'C272\',\n                                            \'chart-funnel overflow-hidden\':selected_type === \'C330\',\n                                            \'show-datalabels\': child.meta.dash_setting.show_datalabels,\n                                            \'hide-total\':!child.meta.dash_setting.show_total}" data-ctid="{{draw_chart_url[child.dom_id].options.ct_id}}"></div><div class="loading-wrap" ng-if="item.children[0].meta.type === \'C310\'"><div class="loader-inner ball-spin-fade-loader"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div><div chart-operate p-index="{{$parent.$parent.$index}}" class="drag-disable"></div><div ng-show="dashEditMode" class="base-loading-layer" ng-click="dash.editChartMeta(child)"></div></div></div></li></ul></div></div></div></div><div ng-if="global.showMobLayout" class="dash-mode-mob dash-edit-content-view"><div class="view-header dash-edit-wrapper clearfix"><div class="block mr16"><a class="back-web" ng-click="setMobLayout(false)"><i class="bdp-icon ico-back1"></i>{{\'dash.backToWeb\'|translate}}</a></div><div class="block ml16"><div class="view-header-seperate-line"></div><span class="setting-tip mr16">{{\'dash.designTip2\'|translate}}</span></div></div><div class="dash-wrapper"><ul ui-sortable="sortMobCharts" ng-model="dashStandardItems"><li ng-repeat="item in dashStandardItems" class="gridster-item" ng-class="{\n                    \'selected\':dashLayoutInfo.ct_id === item.children[0].meta.ct_id,\n                    \'no-title\': item.children[0].meta.type === \'C310\' || !item.children[0].meta.dash_setting.show_title,\n                    \'no-axis\': !item.children[0].meta.dash_setting.show_axis,\n                    \'component-text\': item.children[0].meta.ct_id.indexOf(\'text_\') > -1\n                    }"><div ng-repeat="child in item.children" class="chart-box"><div ng-if="child.meta.ct_id.indexOf(\'text_\') > -1"><div class="item-text-chart" ng-bind-html="child.meta.html"></div><div ng-show="dashEditMode" class="base-loading-layer" ng-click="dash.editChartMeta(child)"></div></div><div ng-if="child.meta.ct_id.indexOf(\'text_\') < 0"><div class="item-chart-title"><div class="item-chart-title-bd nowrap"><span class="no-margin" ng-click="">{{child.meta.name}}</span><div class="loading-wrap"><div class="loader-inner ball-spin-fade-loader"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div></div><div class="item-chart drag-disable" ng-class="{\n                                \'noscroll\':selected_type === \'C200\' \n                                || selected_type === \'C400\'\n                            }" id="{{child.dom_id}}"><div class="drill-crumbs-wrap"></div><div bdp-chart="draw_chart_url[child.dom_id].options" display-mode="{{item.sizeX + \'*\' + item.sizeY}}" data-updatetime="{{child.meta.update_time}}" data-index="$parent.$parent.$index" data-domid="child.dom_id" data-lazy-loaded="draw_chart_url[child.dom_id].lazyload" class="chart" ng-class="{\'chart-table\':selected_type === \'C200\',\n                                    \'chart-map\':selected_type === \'C271\' || selected_type === \'C272\',\n                                    \'chart-funnel overflow-hidden\':selected_type === \'C330\',\n                                    \'show-datalabels\': child.meta.dash_setting.show_datalabels,\n                                    \'hide-total\':!child.meta.dash_setting.show_total}" data-ctid="{{draw_chart_url[child.dom_id].options.ct_id}}"></div><div class="loading-wrap" ng-if="item.children[0].meta.type === \'C310\'"><div class="loader-inner ball-spin-fade-loader"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div><div ng-show="dashEditMode" class="base-loading-layer" ng-click="dash.editChartMeta(child)"></div></div></div></li></ul></div></div><div ng-loading-gif ng-show="dashLoading"></div><div tpl-library-guide veil-ele="J-see-template-data" step-num="tplLibraryGuide" ng-if="enterprise_type == 3 && isTpl && tplLibraryGuide == 1"></div>'),i.put("/static/js/dashboard/tpl/dash_filter.html",'<div click-outside="show_dash_filter = false;" outside-active="show_dash_filter" ng-class="{\'is-show-wrap-bg\': show_dash_filter}" class="dash-filter bdp-icon-wrap" ng-show="show_filter"><i class="bdp-icon ico-filter-white fs-filter-icon"></i> <i class="bdp-icon ico-filter" ng-class="{\'ico-filter-active\':isActive, \'ico-always-highlight\':isActive}" ng-click="handleFilterPos($event)"></i><div class="bd filter-i-w J_filterLayer" ng-show="show_dash_filter"><dl class="filter-i nowrap" ng-class="{\'disable\':it.disabled}" ng-repeat="it in filter_list_inner"><dt class="nowrap" title="{{it.name}}{{setAdvanceAggregatorName(it)}}" ng-if="!(it.hasOwnProperty(\'nick_name\') && it.nick_name !==\'\') ">{{it.name}}{{setAdvanceAggregatorName(it)}}</dt><dt class="nowrap" title="{{it.nick_name}}" ng-if="(it.hasOwnProperty(\'nick_name\') && it.nick_name !==\'\') ">{{it.nick_name}}</dt><dd click-outside="show_options[it.fid+it.uniq_id] = false" outside-active="show_options[it.fid+it.uniq_id]" ng-if="it.data_type !== \'date\' && it.data_type !== \'number\' && !it.hasOwnProperty(\'aggregator\') "><div class="filter-i-list-w"><p class="filter-i-name" ng-class="{\'selected\': show_options[it.fid+it.uniq_id]}" ng-if="!innerFilterModule.isShowFilter(it.fid,it.uniq_id) " ng-click="innerFilterModule.getItemList(opts.meta,it);"><span ng-if="!fullscreen && it.range_type != 0" class="nowrap" title="{{it.range | dash_sub_date:it}}">{{it.range | dash_sub_date:it}} </span><span ng-if="!fullscreen && it.range_type == 0 " class="nowrap" title="{{\'dash.custom\' | translate}}">{{\'dash.custom\' | translate}} </span><span ng-if="fullscreen && ( (it.is_defined && it.rangeNumber != 1) || it.range_type == 0 )" class="nowrap" title="{{\'dash.custom\' | translate}}">{{\'dash.custom\' | translate}} </span><span ng-if="fullscreen && it.is_defined && it.rangeNumber == 1 && it.range_type != 0" class="nowrap" title="{{it.range | sub_date:it}}">{{it.rangeFirstField | dash_sub_date:it}} <em ng-if="it.rangeFirstField && it.data_type == \'date\' && it.granularity == \'week\'">({{it.rangeFirstField | weekFormat:it.rangeFirstField}}) </em></span><span ng-if="fullscreen && !it.is_defined && it.range_type != 0 " class="nowrap" title="{{it.range | sub_date:it}}">{{it.range | sub_date:it}} </span><i class="bdp-icon ico-triangle-down arrow-down"></i></p><p class="filter-i-name" ng-class="{\'selected\': show_options[it.fid+it.uniq_id]}" ng-if="innerFilterModule.isShowFilter(it.fid,it.uniq_id) && (it.rangeNumber != 1 || it.range_type == 0 )" ng-click="innerFilterModule.getItemList(opts.meta,it);"><span class="nowrap">{{\'dash.custom\' | translate}} </span><i class="bdp-icon ico-triangle-down arrow-down"></i></p><p class="filter-i-name" ng-class="{\'selected\': show_options[it.fid+it.uniq_id]}" ng-if="innerFilterModule.isShowFilter(it.fid,it.uniq_id) && it.rangeNumber == 1 && it.range_type != 0" ng-click="innerFilterModule.getItemList(opts.meta,it);"><span class="nowrap">{{it.rangeFirstField | dash_sub_date:it}} </span><em ng-if="it.rangeFirstField && it.data_type == \'date\' && it.granularity == \'week\'">({{it.rangeFirstField | weekFormat:it.rangeFirstField}}) </em><i class="bdp-icon ico-triangle-down arrow-down"></i></p><div class="filter-i-list" ng-show="show_options[it.fid+it.uniq_id] && !it.disabled" ng-style="adjustWidth[it.fid]"><div ng-loading-gif size="size-1x" placeholder="true" ng-show="showLoading"></div><div class="query-box auto" ng-if="(innerFilterItems[it.fid].total <= 100 && innerFilterItems[it.fid].list.length > 20)"><input type="text" class="query-text" ng-input-text ng-keyup="filterQueryModule.enterToQuery({\'e\':$event,\'filter\':it,\'is_advance\':false,\'real_search\':false})" ng-model="queryKwd[it.fid]"></div><div ng-if="innerFilterItems[it.fid].total > 100" ng-show="!showLoading" class="query-box"><input type="text" ng-model="queryKwd[it.fid]" ng-keyup="filterQueryModule.enterToQuery({\'e\':$event,\'filter\':it,\'is_advance\':false,\'real_search\':true})" class="query-text"> <a class="bdp-icon-wrap query-btn" ng-click="filterQueryModule.query(it,false)"><i class="bdp-icon ico-search"></i></a></div><ul><li ng-show="!showLoading && it.show_all"><a class="cursor-pointer" ng-click="innerFilterModule.setInnerFilter({range:[],index:$index,fid:it.fid,type:it.data_type,uniq_id:it.uniq_id});">{{\'all\'| translate}}</a></li><li ng-show="!showLoading" ng-repeat="range in innerFilterItems[it.fid].list | filter:innerFilterItems[it.fid].keyword track by $index"><a class="nowrap cursor-pointer" title="{{range | sub_date:it}}" ng-click="innerFilterModule.setInnerFilter({range:[range],index:$parent.$parent.$index,fid:it.fid,type:it.data_type,uniq_id:it.uniq_id})">{{range | sub_date:it}}</a></li><li ng-if="innerFilterItems[it.fid].list.length == 0" ng-show="!showLoading" class="empty" style="padding:3px"><p>{{\'dash.noSearchResult\'| translate}}</p></li></ul></div></div><span class="filter-i-adv" ng-click="innerFilterModule.getItemList(opts.meta,it,innerFilterModule.openAdvanceModal);">{{\'multiSelect\'| translate}}</span></dd><dd click-outside="show_options[it.fid+it.uniq_id] = false" outside-active="show_options[it.fid+it.uniq_id]" ng-if="it.data_type === \'date\'"><div class="filter-i-list-w"><p class="filter-i-name" ng-class="{\'selected\': show_options[it.fid+it.uniq_id]}" ng-if="it.granularity !== \'\'" ng-click="innerFilterModule.getItemList(opts.meta,it);"><span ng-if="!fullscreen" class="nowrap" title="{{it.range | dash_sub_date:it}}">{{it.range | dash_sub_date:it}} <em ng-if="it.range[0] && it.granularity == \'week\'">({{it.range[0] | weekFormat}}) </em></span><span ng-if="fullscreen && it.is_defined" class="nowrap" title="{{it.range | sub_date:it}}">{{\'dash.custom\' | translate}} </span><span ng-if="fullscreen && !it.is_defined" class="nowrap" title="{{it.range | sub_date:it}}">{{it.range | sub_date:it}} <em ng-if="it.range[0] && it.granularity == \'week\'">({{it.range[0] | weekFormat}}) </em></span><i class="bdp-icon ico-triangle-down arrow-down"></i></p><p class="filter-i-name" ng-class="{\'selected\': show_options[it.fid+it.uniq_id]}" ng-if="!it.granularity" ng-click="innerFilterModule.getItemList(opts.meta,it);"><span class="nowrap" ng-if="fullscreen" title="{{it.range | format_date:adv_date_list:it.name}}">{{it.range | format_date:adv_date_list:it.name}} </span><span class="nowrap" ng-if="!fullscreen" title="{{it.range | format_date:adv_date_list}}">{{it.range | format_date:adv_date_list}} </span><i class="bdp-icon ico-triangle-down arrow-down"></i></p><div class="filter-i-list" ng-show="show_options[it.fid+it.uniq_id] && !it.disabled" ng-style="adjustWidth[it.fid]"><div ng-loading-gif size="size-1x" placeholder="true" ng-show="showLoading"></div><div class="query-box auto" ng-if="(innerFilterItems[it.fid].total <= 100 && innerFilterItems[it.fid].list.length > 20)"><input type="text" class="query-text" ng-model="queryKwd[it.fid]" ng-input-text ng-keyup="filterQueryModule.enterToQuery({\'e\':$event,\'filter\':it,\'is_advance\':false,\'real_search\':false})"></div><div ng-if="innerFilterItems[it.fid].total > 100" ng-show="!showLoading" class="query-box"><input type="text" ng-model="queryKwd[it.fid]" ng-keyup="filterQueryModule.enterToQuery({\'e\':$event,\'filter\':it,\'is_advance\':false,\'real_search\':true})" class="query-text"> <a class="bdp-icon-wrap query-btn" ng-click="filterQueryModule.query(it,false)"><i class="bdp-icon ico-search"></i></a></div><ul ng-if="!it.granularity" ng-show="!showLoading"><li><a ng-class="{\'active\':it.range[0] == \'\'}" ng-show="it.show_all" ng-click="innerFilterModule.setInnerFilter({range:[],index:$parent.$index,fid:it.fid,type:\'date\',uniq_id:it.uniq_id})">{{\'dash.allTime\'| translate}}</a></li><li ng-repeat="adv in adv_date_list"><a class="nowrap pointer" title="{{adv.name}}" ng-class="{\'active\':it.range[0] == adv.opt_id}" ng-click="innerFilterModule.setInnerFilter({range:[adv.opt_id],index:$parent.$index,fid:it.fid,type:\'date\',uniq_id:it.uniq_id})">{{adv.name}}</a></li><li><a class="cursor-pointer" title="{{\'dash.definedTimeRange\'| translate}}" ng-class="{\'active\':it.range.length == 2}" ng-click="innerFilterModule.showDatePicker($parent.$index,it.range,it.fid)">{{\'dash.definedTimeRange\'| translate}}</a></li></ul><ul ng-if="it.granularity !== \'\'"><li ng-show="it.show_all"><a ng-class="{\'active\':it.range[0] == \'\'}" ng-show="it.show_all" ng-click="innerFilterModule.setInnerFilter({range:[],index:$parent.$index,fid:it.fid,type:\'date\',uniq_id:it.uniq_id})">{{\'dash.allTime\'| translate}}</a></li><li ng-if="it.granularity !== \'week\'" ng-repeat="range in innerFilterItems[it.fid].list | query_inner:innerFilterItems[it.fid].keyword:it.granularity track by $index"><a class="nowrap cursor-pointer" title="{{range | timestamp2LocaleDate:it.granularity}}" ng-click="innerFilterModule.setInnerFilter({range:[range],index:$parent.$parent.$index,fid:it.fid,type:it.data_type,uniq_id:it.uniq_id})">{{range | timestamp2LocaleDate:it.granularity}}</a></li><li ng-if="it.granularity == \'week\'" ng-repeat="range in innerFilterItems[it.fid].list | query_inner:innerFilterItems[it.fid].keyword:it.granularity track by $index"><a class="nowrap cursor-pointer" title="{{range | sub_date:it}}({{range | weekFormat}})" ng-click="innerFilterModule.setInnerFilter({range:[range],index:$parent.$parent.$index,fid:it.fid,type:it.data_type,uniq_id:it.uniq_id})">{{range | sub_date:it}} <span ng-if="it.data_type == \'date\' && it.granularity == \'week\'">({{range | weekFormat}})</span></a></li></ul></div></div></dd><dd ng-if="it.data_type === \'number\' || ( it.data_type !=\'number\' && it.hasOwnProperty(\'aggregator\') ) " click-outside="show_options[it.fid+it.uniq_id] = false" outside-active="show_options[it.fid+it.uniq_id]"><div class="filter-i-list-w number-filter-i-list"><p class="filter-i-name name" ng-class="{\'selected\': show_options[it.fid+it.uniq_id]}" ng-if="!innerFilterModule.isShowFilter(it.fid,it.uniq_id)" ng-click="innerFilterModule.getItemListForNumber(opts.meta,it);"><span ng-if="!fullscreen" class="nowrap" title="{{numberConditionFormatString[it.fid+it.uniq_id]}}">{{numberConditionFormatString[it.fid+it.uniq_id]}} </span><span ng-if="fullscreen && (it.hasOwnProperty(\'nick_name\') && it.nick_name !==\'\') " class="nowrap" title="{{it.nick_name}}{{numberConditionFormatString[it.fid+it.uniq_id]}}">{{it.nick_name}}{{numberConditionFormatString[it.fid+it.uniq_id]}} </span><span ng-if="fullscreen && !(it.hasOwnProperty(\'nick_name\') && it.nick_name !==\'\') " class="nowrap" title="{{it.name}}{{setAdvanceAggregatorName(it)}}{{numberConditionFormatString[it.fid+it.uniq_id]}}">{{it.name}}{{setAdvanceAggregatorName(it)}}{{numberConditionFormatString[it.fid+it.uniq_id]}} </span><i class="bdp-icon ico-triangle-down arrow-down"></i></p><div class="filter-i-list" ng-style="adjustWidth[it.fid]" ng-show="show_options[it.fid+it.uniq_id]"><div ng-loading-gif size="size-1x" placeholder="true" ng-show="showLoading"></div><div ng-show="!showLoading" class="select-box"><select ng-model="innerFilterItems[it.fid+it.uniq_id].numOpt" ng-options="opt.value as opt.text for opt in numberInnerFilterMap" ng-change="changeNumberOpt(opts.meta, it, innerFilterItems[it.fid+it.uniq_id].numOpt)"></select></div><ul ng-show="!showLoading"><li class="none-filter-range" ng-if="nullRange[it.fid+it.uniq_id]">无范围</li><li ng-loading-gif size="size-1x" placeholder="true" ng-show="rangeLoading"></li><li class="range" ng-if="!nullRange[it.fid+it.uniq_id] && defaultRange[it.fid+it.uniq_id].length > 0 && innerFilterItems[it.fid+it.uniq_id].numOpt == -1">{{defaultRange[it.fid+it.uniq_id][0]}} ~ {{defaultRange[it.fid+it.uniq_id][1]}}</li><li class="range" ng-if="!nullRange[it.fid+it.uniq_id] && defaultRange[it.fid+it.uniq_id].length == 0 && innerFilterItems[it.fid+it.uniq_id].numOpt != -1"><input type="number" ng-model="innerFilterItems[it.fid+it.uniq_id].numRange[0]"></li><li class="range" ng-if="!nullRange[it.fid+it.uniq_id] && defaultRange[it.fid+it.uniq_id].length == 0 && innerFilterItems[it.fid+it.uniq_id].numOpt == 12">{{\'field.to\' | translate }}</li><li class="range" ng-if="!nullRange[it.fid+it.uniq_id] && defaultRange[it.fid+it.uniq_id].length == 0 && innerFilterItems[it.fid+it.uniq_id].numOpt == 12"><input type="number" ng-model="innerFilterItems[it.fid+it.uniq_id].numRange[1]"></li></ul><div class="operator" ng-show="!showLoading"><button class="bdp-btn bdp-btn-ok" translate="ok" ng-click="innerFilterModule.setInnerFilterForNumber({fid:it.fid,index:$index,uniq_id:it.uniq_id})"></button></div></div></div></dd></dl></div></div>'),i.put("/static/js/dashboard/tpl/dash_fullscreen.html",'<div class="dash-fullscreen-wrap display-device-{{fullDisplayDevice}} display-theme-{{fullDisplayTheme === 1 ? \'dark\' : \'light\'}}"><div class="dash-title-wrap view-header-wrap"><div class="clearfix dash-title view-header"><h2>{{dashTitle}}</h2><div class="btn-layer"><a class="full-display-setting" ng-click="show_display_theme = !show_display_theme" click-outside="show_display_theme = false" outside-active="show_display_theme"><span class="setting-label">{{ \'dash.displayTheme\' | translate }}</span> <span class="btn-layer-opt">{{fullDisplayTheme === 1 ? \'dash.darkTheme\' : \'dash.lightTheme\' | translate}} <span class="btn-layer-hover-line"></span> </span><i class="bdp-icon ico-triangle-down"></i><ul class="dropdown-wrap" ng-show="show_display_theme"><li class="dropdown-item" ng-click="setFullDisplayTheme(1)">{{ \'dash.darkTheme\' | translate }}</li><li class="dropdown-item" ng-click="setFullDisplayTheme(2)">{{ \'dash.lightTheme\' | translate }}</li></ul></a><a class="full-display-setting" ng-click="show_display_devices = !show_display_devices" click-outside="show_display_devices = false" outside-active="show_display_devices"><span class="setting-label">{{ \'dash.displayDevice\' | translate }}</span> <span class="btn-layer-opt"><i class="bdp-icon ico-device ico-device-{{fullDisplayDevice}}"></i> <span class="btn-layer-hover-line"></span> </span><i class="bdp-icon ico-triangle-down"></i><ul class="dropdown-wrap" ng-show="show_display_devices"><li class="dropdown-item" ng-click="setFullDisplayDevice(\'pc\')"><i title="{{ \'dash.pcDevice\' | translate }}" class="bdp-icon ico-device-pc"></i></li><li class="dropdown-item" ng-click="setFullDisplayDevice(\'projector\')"><i title="{{ \'dash.projectorDevice\' | translate }}" class="bdp-icon ico-device-projector"></i></li><li class="dropdown-item" ng-click="setFullDisplayDevice(\'tv\')"><i title="{{ \'dash.tvDevice\' | translate }}" class="bdp-icon ico-device-tv"></i></li></ul></a><a ng-click="exitFullScreen();removeFullDisplayStyle()"><i class="bdp-icon ico-exit-fullscreen"></i> <span class="btn-layer-opt">{{ \'exitFullscreen\' | translate }} <span class="btn-layer-hover-line"></span></span></a></div></div></div><div ng-if="!dashLoading && global.globalDashFilter.length" class="dash-global-wrap" global-filter original-global-filter="global.originalGlobalFilter" global-dash-filter="global.globalDashFilter" global-dash-filter-items="global.globalDashFilterItems" rule-id="global.rule_id" show-loading="showLoading" draw_chart_url="draw_chart_url"></div><div class="dash-wrapper" ng-class="{\n        \'dash-one-block\':!dashLayoutInfo.show_block,\n        \'edit-mode\':dashEditMode,\n        \'dash-fixed-width\':dashLayoutInfo.fixed_width,\n        \'hide-block-watermark\':!dashLayoutInfo.show_block && global.watterMark, \n        \'under-workspace\':(workspaceList && workspaceList[\'dash\'].length > 0),\n        \'has-global-filter\': global.globalDashFilter.length > 0\n        }"><div class="folder-empty" ng-if="showEmptyDash"><img src="/static/images/empty-folder.png"><p translate="dash.emptyDash" class="mt8"></p></div><slick class="slider single-item" id="dash-slider" draggable="false" lazy-load="ondemand" autoplay autoplay-speed="10000" init-onload="true" data="dashPages" infinite="true" dots="false" append-arrows=".page-nav"><div class="gridster-page" ng-repeat="dashPageItems in dashPages" gridster="gridsterOpts"><div ng-if="!selected.proj_share" ng-hide="dashInit.load"><div ng-if="selected.dsh_id  && dashPageItems.length == 0" ng-click="addItem()" class="empty-dash-add"><span><i class="a"></i> <i class="b"></i></span><div class="textalign-center empty-dash-add-tip">{{\'dash.addChart\' | translate}}</div></div></div><ul><li gridster-item="item" ng-repeat="item in dashPageItems" row="item.row" col="item.col" size-x="item.sizeX" size-y="item.sizeY" ng-hide="chartdel[\'chart\'+current_item.meta.ct_id]" id="{{item.children[0].meta.ct_id}}" class="no-border" data-chart-id="{{item.children[0].meta.ct_id}}" ng-mouseleave="mouseleaveItem()" ng-class="{\n                            \'selected\':dashLayoutInfo.ct_id === item.children[0].meta.ct_id,\n                            \'no-title\': item.children[0].meta.type === \'C310\' || !item.children[0].meta.dash_setting.show_title,\n                            \'no-axis\': !item.children[0].meta.dash_setting.show_axis,\n                            }"><div ng-repeat="child in item.children" class="chart-box"><div ng-if="child.meta.ct_id.indexOf(\'text_\') < 0"><div class="item-chart-title"><div class="item-chart-title-bd nowrap"><div class="display-inline-block drill-tip" ng-if="child.meta.level_fields.length > 1"><i class="bdp-icon ico-drill"></i><div class="drill-tip-bd mt5"><span ng-repeat="drill_field in child.meta.level_fields"><i class="bdp-icon ico-slicesnav-arrow" ng-show="!$first"></i> {{drill_field.name}}</span><div class="arrow"><em></em><span></span></div></div></div><i class="bdp-icon ico-linked" ng-if="child.meta.chart_link.linked_chart_type == \'2\'"></i> <i class="bdp-icon ico-chart-jump" ng-if="child.meta.chart_jump.can_jump == \'1\'"></i> <span class="no-margin" ng-click="">{{child.meta.name}}</span> <span class="filter-item" ng-repeat="it in child.meta.filter_list_inner" ng-if="it.range.length && !it.adv_type"><em ng-if="it.data_type === \'date\' && !it.granularity" ng-hide="AllMap.indexOf( (it.range | format_date:child.meta.adv_date_list ) ) >= 0">{{it.range | format_date:child.meta.adv_date_list}} <span ng-if="it.granularity == \'week\'">({{it.range[0] | weekFormat:it.range[0]}})</span> </em><em ng-if="it.data_type === \'date\' && it.granularity">{{it.range | inner_range_date_format:it}} <span ng-if="it.granularity == \'week\'">({{it.range[0] | weekFormat:it.range[0]}})</span> </em><em ng-if="it.data_type !== \'date\' && !it.inner_adv_type">{{it.range | dash_sub_date:it}}</em> <em ng-if="it.data_type !== \'date\' && it.inner_adv_type && (it.rangeNumber != 1 || it.range_type == 0 )"><span ng-if="!it.nick_name">{{it.name}}</span> <span ng-if="!!it.nick_name">{{it.nick_name}}</span> {{\'dash.custom\' | translate}} </em><em ng-if="it.data_type !== \'date\' && it.inner_adv_type && it.rangeNumber == 1 && it.range_type != 0 ">{{it.rangeFirstField | dash_sub_date:it}} </em></span><span class="filter-item" ng-repeat="it in child.meta.diff_filter"><em>{{it}}</em></span><div class="loading-wrap"><div class="loader-inner ball-spin-fade-loader"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div></div><div class="item-chart drag-disable" ng-class="{\'noscroll\':selected_type === \'C200\'}" id="{{child.dom_id}}" size-x="{{item.sizeX}}" size-y="{{item.sizeY}}"><div class="drill-crumbs-wrap"></div><div bdp-chart="draw_chart_url[child.dom_id].options" display-mode="{{item.sizeX + \'*\' + item.sizeY}}" data-updatetime="{{child.meta.update_time}}" data-index="item.index" data-domid="child.dom_id" data-lazy-loaded="draw_chart_url[child.dom_id].lazyload" class="chart" ng-class="{\'chart-table\':selected_type === \'C200\',\n'+"                                        'chart-map':selected_type === 'C271' || selected_type === 'C272',\n                                        'chart-funnel overflow-hidden':selected_type === 'C330',\n                                        'chart-sankey': selected_type === 'C300',\n                                        'show-datalabels': child.meta.dash_setting.show_datalabels,\n                                        'hide-total':!child.meta.dash_setting.show_total}\"></div></div><div chart-operate p-index=\"{{$parent.$parent.$index}}\" class=\"drag-disable hidden\"></div></div></div></li></ul></div></slick></div><div class=\"page-nav\"><span class=\"page-ctrl-play\" ng-click=\"toggleDashboardAutoplay()\"><i class=\"bdp-icon\" ng-class=\"{'ico-pause': dashboardAutoplay, 'ico-play': !dashboardAutoplay}\"></i></span></div></div>"),i.put("/static/js/dashboard/tpl/markPointTooltip.html",'<div class="mark-point-wrap"><div ng-repeat="item in markPoints" class="hchart-mark-point" style="left:{{item.pos.left}}px;top:{{item.pos.top}}px"><i class="bdp-icon ico-comment" ng-click="setTooltipPos($event, item)" ng-show="!item.show"></i><div class="popover mark-point-tooltip" ng-class="{\'top\': item.popover.pos === \'top\',\'bottom\': item.popover.pos === \'bottom\',}" ng-show="item.show" style="margin-left: {{-item.contentPixel/2 - 15}}px"><i class="bdp-icon ico-cancel close" title="{{\'close\'|translate}}" ng-click="item.show=false"></i><div class="popover-inner"><div class="popover-content" style="width: {{item.contentPixel}}px"><div class="tooltip-hd text-left" ng-if="mode==\'edit\'">{{\'chart.markPoint\' | translate}}</div><div class="tooltip-bd text-left" ng-bind="item.pointModel.comment"></div></div></div></div></div></div>'),i.put("/static/js/dashboard/tpl/project_view.html","<div nav-workspace class=\"nav-workspace\"></div><div project-list ng-class=\"{'role-user':role=='user',\n        'has-workspace-list': workspaceList && workspaceList['dash'].length > 0,\n"+'        \'empty-project-wrap\': showEmptyFolder}" class="dash-sidebar J_dash_sidebar"></div><div class="dash-edit-content" ng-class="{\'shopex-dash-edit-content\': (enterprise_type == 5 || enterprise_type == 6) && showEmptyFolder}"><div ui-view class="dash-edit-content-view pr"><div class="project-empty" ng-if="showEmptyFolder && !(enterprise_type == 5 || enterprise_type == 6) && !isThirdIframe"><img src="/static/images/empty-proj.png"><p translate="dash.emptyProject" class="mt16"></p></div><div class="shopex-empty-dash-wrap" ng-if="(enterprise_type == 5 || enterprise_type == 6) && showEmptyFolder"><div class="shopex-empty-dash-title">欢迎使用生意罗盘</div><div class="shopex-empty-dash-desc">生意罗盘是专业的数据分析产品，为您定制专业的数据可视化服务，帮助您实现数据运营，用数据指导决策等。它能够整合淘宝、京东等多平台数据，为您提供最便捷的今日资讯，根据当前资讯，您可以有针对性的查看商品分析、客户分析和运营管理分析，从而为决策提供最有效的数据支撑。</div><div class="shopex-empty-dash-btn-wrap text-center"><button class="bdp-btn bdp-btn-ok" ng-click="click_show_view(\'database\')">立即使用</button></div><div class="shopex-empty-dash-img-wrap text-center"><img class="shopex-empty-dash-img" ng-src="/static/images/shopex.png"></div></div><div class="project-empty" ng-if="isThirdIframe"><img src="/static/images/rongyi_empty_folder.png"><p class="mt16 text-left">当前账户尚未分配浏览数据权限，<br>请联系容易网客服： 400-040-8989</p></div></div></div>')
}]);
;angular.module("BC.services",[]).service("pendingRequests",[function(){var e=[];this.get=function(){return e},this.add=function(a){e.push(a)},this.remove=function(a){e=e.filter(function(e){return e.url!==a})},this.cancelAll=function(){angular.forEach(e,function(e){e.canceller.resolve()}),e.length=0},this.cancelOne=function(a){if(a&&e)for(var t=0,n=e.length;n>t;t++)if(e[t].url==a){e[t].canceller.resolve();break}}}]).config(["$httpProvider",function(e){e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8",e.defaults.headers.common.Accept="application/json";var a=function(e){var t,n,r,o,i,s,c,l="";for(t in e)if(n=e[t],n instanceof Array)for(c=0;c<n.length;++c)i=n[c],r=t+"["+c+"]",s={},s[r]=i,l+=a(s)+"&";else if(n instanceof Object)for(o in n)i=n[o],r=t+"["+o+"]",s={},s[r]=i,l+=a(s)+"&";else void 0!==n&&null!==n&&(l+=encodeURIComponent(t)+"="+encodeURIComponent(n)+"&");return l.length?l.substr(0,l.length-1):l};e.defaults.transformRequest=function(e){if(angular.isObject(e)&&String(e)){var t={};return angular.copy(e,t),a(t)}return e}}]).factory("chartType",["$rootScope","$translate",function(e,a){function t(){a(n).then(function(e){r.forEach(function(a){a.name=e[a.type]})})}var n=["C210","C211","C212","C220","C230","C240","C241","C242","C200","C250","C261","C271","C272","C280","C290","C300","C310","C320","C330","C340","C350","C351","C352","C360","C370"];t(),e.$on("$translateChangeSuccess",t);var r=[{cate:"C20",type:"C200",name:"表格",status:!1},{cate:"C31",type:"C310",name:"指标卡",status:!1},{cate:"C26",type:"C261",name:"计量图",status:!1},{cate:"C22",type:"C220",name:"折线图",status:!1},{cate:"C21",type:"C210",name:"簇状柱形图",status:!1},{cate:"C21",type:"C211",name:"堆积柱形图",status:!1},{cate:"C21",type:"C212",name:"百分比堆积柱形图",status:!1},{cate:"C32",type:"C320",name:"瀑布图",status:!1},{cate:"C24",type:"C240",name:"条形图",status:!1},{cate:"C24",type:"C241",name:"堆积条形图",status:!1},{cate:"C24",type:"C242",name:"百分比堆积条形图",status:!1},{cate:"C30",type:"C300",name:"桑基图",status:!1},{cate:"C35",type:"C350",name:"面积图",status:!1},{cate:"C35",type:"C351",name:"堆积面积图",status:!1},{cate:"C35",type:"C352",name:"百分比堆积面积图",status:!1},{cate:"C28",type:"C280",name:"散点图",status:!1},{cate:"C23",type:"C230",name:"普通饼图",status:!1},{cate:"C36",type:"C360",name:"旭日图",status:!1},{cate:"C37",type:"C370",name:"树图",status:!1},{cate:"C33",type:"C330",name:"漏斗图",status:!1},{cate:"C27",type:"C271",name:"地图（面积）",status:!1},{cate:"C27",type:"C272",name:"地图（气泡）",status:!1},{cate:"C25",type:"C250",name:"双轴",status:!1},{cate:"C340",type:"C340",name:"词云",status:!1},{cate:"C29",type:"C290",name:"雷达图",status:!1}];return r}]).factory("chartTypeTip",["$rootScope","$translate",function(e,a){function t(){a(n).then(function(e){o.forEach(function(a){a.name=e[a.type]})}),a(r).then(function(e){o.forEach(function(a){0==a.combination.length?(a.showDimension=e[a.dimension],a.showMetric=e[a.metric]):(a.showCombination[0]=e[a.combination[0]],a.showCombination[1]=e[a.combination[1]])})})}var n=["C210","C211","C212","C220","C230","C240","C241","C242","C200","C250","C261","C271","C272","C280","C290","C300","C310","C320","C330","C340","C350","C351","C352","C360","C370"],r=["only0","onlyOne","onlyTwo","onlyMore","OneOrTwo","0orOne","0orMore","OneorMore","TwoorMore","NoMoreThanTwo","0DMoreV","OneDOneV","OneOrTwoDOneV","OneDMoreV","moreCMoreV","0andMoreC3andMoreV"];t(),e.$on("$translateChangeSuccess",t);var o=[{type:"C200",name:"表格",dimension:"0orMore",metric:"0orMore",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C310",name:"指标卡",dimension:"only0",metric:"OneOrTwo",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C261",name:"计量图",dimension:"only0",metric:"onlyOne",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C220",name:"折线图",dimension:"OneOrTwo",metric:"OneorMore",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C210",name:"簇状柱形图",dimension:"NoMoreThanTwo",metric:"OneorMore",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C211",name:"堆积柱形图",dimension:"OneOrTwo",metric:"TwoorMore",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C212",name:"百分比堆积柱形图",dimension:"OneOrTwo",metric:"TwoorMore",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C320",name:"瀑布图",dimension:"",metric:"",combination:["OneOrTwoDOneV","0DMoreV"],showDimension:"",showMetric:"",showCombination:[],needComparison:!1},{type:"C240",name:"条形图",dimension:"NoMoreThanTwo",metric:"OneorMore",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C241",name:"堆积条形图",dimension:"OneOrTwo",metric:"TwoorMore",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C242",name:"百分比堆积条形图",dimension:"OneOrTwo",metric:"TwoorMore",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C300",name:"桑基图",dimension:"onlyTwo",metric:"onlyOne",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!1},{type:"C230",name:"普通饼图",dimension:"",metric:"",combination:["OneDOneV","0DMoreV"],showDimension:"",showMetric:"",showCombination:[],needComparison:!1},{type:"C271",name:"地图（面积）",dimension:"onlyOne",metric:"onlyOne",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!1},{type:"C272",name:"地图（气泡）",dimension:"onlyOne",metric:"onlyOne",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!1},{type:"C290",name:"雷达图",dimension:"",metric:"",combination:["OneDMoreV","0andMoreC3andMoreV"],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C250",name:"双轴",dimension:"0orOne",metric:"onlyMore",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C280",name:"散点图",dimension:"0orMore",metric:"onlyTwo",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!1},{type:"C330",name:"漏斗图",dimension:"",metric:"",combination:["OneDOneV","0DMoreV"],showDimension:"",showMetric:"",showCombination:[],needComparison:!1},{type:"C340",name:"词云",dimension:"onlyOne",metric:"only0",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!1},{type:"C350",name:"面积图",dimension:"0orOne",metric:"OneorMore",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C351",name:"堆积面积图",dimension:"onlyOne",metric:"TwoorMore",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C352",name:"百分比堆积面积图",dimension:"onlyOne",metric:"TwoorMore",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!0},{type:"C360",name:"旭日图",dimension:"TwoorMore",metric:"onlyOne",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!1},{type:"C370",name:"树图",dimension:"OneorMore",metric:"0orOne",combination:[],showDimension:"",showMetric:"",showCombination:[],needComparison:!1}];return o}]).factory("operatorHelpLink",["$rootScope","$translate",function(){var e="";return function(a){switch(a){case"globalFilter":e="https://help.bdp.cn/index.php?title=%E5%85%A8%E5%B1%80%E7%AD%9B%E9%80%89%E5%99%A8";break;case"tableFormatting":e="https://help.bdp.cn/index.php?title=%E9%A2%9C%E8%89%B2%E4%B8%8E%E6%9D%A1%E4%BB%B6%E6%A0%BC%E5%BC%8F#.E8.A1.A8.E6.A0.BC";break;case"plotLine":e="https://help.bdp.cn/index.php?title=%E9%A2%84%E8%AD%A6%E4%B8%8E%E8%BE%85%E5%8A%A9%E7%BA%BF#.E8.BE.85.E5.8A.A9.E7.BA.BF";break;case"chartWarn":e="https://help.bdp.cn/index.php?title=%E9%A2%84%E8%AD%A6%E4%B8%8E%E8%BE%85%E5%8A%A9%E7%BA%BF#.E9.A2.84.E8.AD.A6";break;case"dateYoy":e="https://help.bdp.cn/index.php?title=%E9%AB%98%E7%BA%A7%E8%AE%A1%E7%AE%97#.E7.BB.B4.E5.BA.A6.E4.B8.BA.E9.9D.9E.E6.97.A5.E6.9C.9F.E5.AD.97.E6.AE.B5";break;case"customYoy":e="https://help.bdp.cn/index.php?title=%E9%AB%98%E7%BA%A7%E8%AE%A1%E7%AE%97#.E7.BB.B4.E5.BA.A6.E4.B8.BA.E6.97.A5.E6.9C.9F.E5.AD.97.E6.AE.B5";break;case"advanceDateFilter":e="https://help.bdp.cn/index.php?title=%E7%AD%9B%E9%80%89%E5%99%A8#.E6.97.A5.E6.9C.9F.E5.AD.97.E6.AE.B5";break;case"innerFilter":e="https://help.bdp.cn/index.php?title=%E7%AD%9B%E9%80%89%E5%99%A8#.E5.9B.BE.E5.86.85.E7.AD.9B.E9.80.89.E5.99.A8";break;case"colorSettingByNum":e="https://help.bdp.cn/index.php?title=%E9%A2%9C%E8%89%B2%E4%B8%8E%E6%9D%A1%E4%BB%B6%E6%A0%BC%E5%BC%8F#.E6.B8.90.E5.8F.98.E9.A2.9C.E8.89.B2";break;case"colorSettingByField":e="https://help.bdp.cn/index.php?title=%E9%A2%9C%E8%89%B2%E4%B8%8E%E6%9D%A1%E4%BB%B6%E6%A0%BC%E5%BC%8F#.E6.9E.9A.E4.B8.BE.E9.A2.9C.E8.89.B2";break;case"resultFilter":e="https://help.bdp.cn/index.php?title=%E7%AD%9B%E9%80%89%E5%99%A8#.E7.BB.93.E6.9E.9C.E7.AD.9B.E9.80.89.E5.99.A8";break;case"chartChain":e="https://help.bdp.cn/index.php?title=%E5%9B%BE%E8%A1%A8%E8%81%94%E5%8A%A8";break;case"chartMoveCalc":e="https://help.bdp.cn/index.php?title=%E9%AB%98%E7%BA%A7%E8%AE%A1%E7%AE%97#.E7.A7.BB.E5.8A.A8.E8.AE.A1.E7.AE.97";break;case"chartRepetition":e="https://help.bdp.cn/index.php?title=%E9%AB%98%E7%BA%A7%E8%AE%A1%E7%AE%97#.E9.87.8D.E5.A4.8D.E7.8E.87";break;case"chartRetention":e="https://help.bdp.cn/index.php?title=%E9%AB%98%E7%BA%A7%E8%AE%A1%E7%AE%97#.E7.95.99.E5.AD.98.E7.8E.87";break;case"chartRunning":e="https://help.bdp.cn/index.php?title=%E9%AB%98%E7%BA%A7%E8%AE%A1%E7%AE%97#.E7.B4.AF.E8.AE.A1.E8.AE.A1.E7.AE.97";break;case"chartActivity":e="https://help.bdp.cn/index.php?title=%E9%AB%98%E7%BA%A7%E8%AE%A1%E7%AE%97#.E6.B4.BB.E8.B7.83.E7.8E.87";break;case"csv":e="https://help.bdp.cn/index.php?title=%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0#.E4.B8.8A.E4.BC.A0CSV.E6.96.87.E4.BB.B6";break;case"fileUpload":e="https://help.bdp.cn/index.php?title=%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0#.E4.B8.8A.E4.BC.A0Excel.E6.96.87.E4.BB.B6";break;case"fileAppend":e="https://help.bdp.cn/index.php?title=%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0#.E8.BF.BD.E5.8A.A0.E6.95.B0.E6.8D.AE";break;case"fileReplace":e="https://help.bdp.cn/index.php?title=%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0#.E6.9B.BF.E6.8D.A2.E6.95.B0.E6.8D.AE";break;default:e=""}e&&window.open(e)}}]).factory("formula",["$rootScope","$translate",function(e,a){function t(){a(n).then(function(e){r.forEach(function(a){a.list?(a.name=e.more,a.list.forEach(function(a){a.list?(a.name=e.PERCENTILE,a.list.forEach(function(a){a.name=e[a.type]})):a.name=e[a.type]})):a.name=e[a.type]})})}var n=["SUM","AVERAGE","AVG","MIN","MAX","COUNT","COUNT_DISTINCT","more","MED","PERCENTILE","PERCENT_5","PERCENT_10","PERCENT_25","PERCENT_50","PERCENT_75","PERCENT_90","PERCENT_95"],r=[{name:"求和",type:"SUM",show:"number"},{name:"平均值",type:"AVERAGE",show:"number"},{name:"计数",type:"COUNT",show:"all"},{name:"去重计数",type:"COUNT_DISTINCT",show:"all"},{name:"更多计数方式",type:"more",show:"number",list:[{name:"最大值",type:"MAX",show:"number"},{name:"最小值",type:"MIN",show:"number"},{name:"中位数",type:"MED",show:"number"},{name:"百分位",type:"PERCENTILE",show:"number",list:[{name:"5",type:"PERCENT_5",show:"number",percent:.05},{name:"10",type:"PERCENT_10",show:"number",percent:.1},{name:"25",type:"PERCENT_25",show:"number",percent:.25},{name:"50",type:"PERCENT_50",show:"number",percent:.5},{name:"75",type:"PERCENT_75",show:"number",percent:.75},{name:"90",type:"PERCENT_90",show:"number",percent:.9},{name:"95",type:"PERCENT_95",show:"number",percent:.95}]}]}];return t(),e.$on("$translateChangeSuccess",t),r}]).factory("formulaFunc",function(){return[{name:"求和",type:"SUM",show:"number"},{name:"平均值",type:"AVG",show:"number"},{name:"最大值",type:"MAX",show:"number"},{name:"最小值",type:"MIN",show:"number"},{name:"计数",type:"COUNT",show:"all"},{name:"去重计数",type:"COUNT(DISTINCT())",show:"all"}]}).factory("verifyTbName",["$rootScope","errHint","$translate",function(e,a,t){function n(){t(o).then(function(e){r=e["join.worksheetname"]+e.tbNameInvalid})}var r="",o=["join.worksheetname","tbNameInvalid"];return n(),function(){return!0}}]).factory("dateTimeByHalfHour",["$rootScope",function(){return[{value:"00:00:00",label:"00:00"},{value:"01:00:00",label:"01:00"},{value:"02:00:00",label:"02:00"},{value:"03:00:00",label:"03:00"},{value:"04:00:00",label:"04:00"},{value:"05:00:00",label:"05:00"},{value:"06:00:00",label:"06:00"},{value:"07:00:00",label:"07:00"},{value:"08:00:00",label:"08:00"},{value:"09:00:00",label:"09:00"},{value:"10:00:00",label:"10:00"},{value:"11:00:00",label:"11:00"},{value:"12:00:00",label:"12:00"},{value:"13:00:00",label:"13:00"},{value:"14:00:00",label:"14:00"},{value:"15:00:00",label:"15:00"},{value:"16:00:00",label:"16:00"},{value:"17:00:00",label:"17:00"},{value:"18:00:00",label:"18:00"},{value:"19:00:00",label:"19:00"},{value:"20:00:00",label:"20:00"},{value:"21:00:00",label:"21:00"},{value:"22:00:00",label:"22:00"},{value:"23:00:00",label:"23:00"}]}]).service("personalSettingService",["$http","$window","errHint",function(e,a,t){this.getUserInfo=function(){return e.get("/api/user/info?access_token="+$.cookie("token")).then(function(e){return e=e.data,"0"!==e.status?(t(Number(e.status)),{}):e.result})},this.modifyUserInfo=function(a){return a.access_token=$.cookie("token"),e.post("/api/user/modify_info",a).then(function(e){return e=e.data,"0"!==e.status?(t(Number(e.status)),!1):!0})},this.modifyPassword=function(a){return a.access_token=$.cookie("token"),e.post("/api/user/modify_pwd",a).then(function(e){return e=e.data,"0"!==e.status?(t(Number(e.status)),!1):!0})},this.logout=function(){e.post("/api/user/logout",{access_token:$.cookie("token")}).success(function(){a.location.href="login.html"})}}]).factory("capacityHint",["ngDialog","$rootScope",function(e,a){return function(){e.closeAll(),a.maxSize=a.personalInfo.capacity_info.capacity,e.open({template:"/static/partials/dialogTemplates/capacityHint.html",className:"ngdialog-theme-default ngDialog-width-330",scope:a})}}]).factory("errHint",["$rootScope","$timeout","$location","$translate",function(e,a,t,n){var r=0,o=null,i=!1;return function(t,s){var c,l="/login.html",d=e.language;s=s||{},window.isThirdIframe||(window.isThirdIframe=e.isThirdIframe=!1);var u=!1;if("number"!=typeof t)c=t;else{var h=1*t;switch(h){case 1:$.cookie("token",""),$.cookie("token_invalid",1,{path:"/"}),i||(i=!0,l=bdp.bdpLogin.checkPartnerLogin(),location.href=l);break;case 2:c=n.instant("error.API");break;case 3:return 0==r&&(c=n.instant("error.noExistOrAccess"),alert(c),r+=1),void(window.location.href="/");case 4:c=n.instant("error.unManager");break;case 10:c=n.instant("error.serverFail");break;case 11:c=n.instant("error.paramError");break;case 12:c=n.instant("error.internetOutRange"),setTimeout(function(){l=bdp.bdpLogin.checkPartnerLogin(),location.href=l},1e3);break;case 13:0==r&&(c=n.instant("error.haveLogin"),alert(c),r+=1),$.cookie("token",""),$.cookie("token_invalid",1,{path:"/"}),l=bdp.bdpLogin.checkPartnerLogin(),location.href=l;break;case 14:0==r&&(alert(s.warn_msg),r+=1),l=bdp.bdpLogin.checkPartnerLogin(),location.href=l;break;case 15:0==r&&(c=n.instant("error.noPermission"),alert(c),r+=1),l=bdp.bdpLogin.checkPartnerLogin(),location.href=l;break;case 18:c=n.instant("error.noBind"),c="";break;case 19:c=n.instant("error.confirmed"),l=bdp.bdpLogin.checkPartnerLogin(),location.href=l,c="";break;case 20:c="",$.cookie("password_changed",1,{path:"/"}),l=bdp.bdpLogin.checkPartnerLogin(),window.location.href=l;break;case 21:c=n.instant("error.noChartOrnoAccess");break;case 22:c=n.instant("error.saveFail");break;case 102:c=n.instant("error.datasourceNotExist");break;case 103:c=n.instant("error.noDelete");break;case 104:c=n.instant("ds.connectFail");break;case 126:c=n.instant("error.apiTimesLimit");break;case 106:c=n.instant("error.saveSuccessAndSync");break;case 108:c=n.instant("error.fieldRepeat");break;case 109:c=n.instant("error.apiUsernameExist");break;case 110:c=n.instant("error.dsRepeat");break;case 111:c=n.instant("error.captchaSendError");break;case 112:c=n.instant("error.captchaError");break;case 113:c=n.instant("error.captchaOutOfLimit");break;case 114:c=n.instant("error.kstRepeat");break;case 115:c=n.instant("error.kstError");break;case 116:c=n.instant("error.jinyiweiConnFail");break;case 117:c=n.instant("error.loginInfoErrorOrUserLock");break;case 118:c=n.instant("error.dsConfigError");break;case 119:c=n.instant("error.loginFrequently");break;case 120:c=n.instant("error.phoneVerifyFail");break;case 121:c=n.instant("error.serviceException");break;case 122:c=n.instant("error.accountFail");break;case 124:c=n.instant("error.passworkWrong");break;case 125:c=n.instant("error.usernameWrong");break;case 128:c=n.instant("ds.baiduTaskExist");break;case 129:c=n.instant("error.tokenWrong");break;case 201:c=n.instant("wb.isUpdatingThen");break;case 1001:c=n.instant("error.userForbidden");break;case 1002:c=n.instant("error.password");break;case 1004:c=n.instant("error.noAuthorizationInfo");break;case 1009:c=n.instant("error.noUser");break;case 1012:c=n.instant("error.limitNumber");break;case 1014:c="",$.cookie("password_reset",1,{path:"/"}),l=bdp.bdpLogin.checkPartnerLogin(),window.location.href=l;break;case 1015:c=n.instant("error.accountActived");break;case 1016:c=n.instant("error.accoutLimit");break;case 1018:c=n.instant("error.codeError");break;case 1023:c=n.instant("error.mobileExisted");break;case 3003:c=n.instant("error.noId");break;case 3005:c=n.instant("error.needCtId");break;case 3008:c=n.instant("error.needId");break;case 3009:c=n.instant("error.missId");break;case 3011:c=n.instant("error.fidId");break;case 3204:c=n.instant("error.dashboardOccupied");break;case 3209:c=n.instant("sql.sqlScriptNotBeNull");break;case 3210:c=n.instant("error.dashboardNotbelong");break;case 3211:c=n.instant("error.noChart");break;case 3212:c=n.instant("error.noFolder");break;case 3216:c=n.instant("error.infoErrorInTable");break;case 3219:c=n.instant("error.tplNotExist");break;case 3220:c=n.instant("error.noDashboard");break;case 3221:c=n.instant("error.noBelong");break;case 3222:c=n.instant("error.chartsNumMismatch");break;case 3223:c=n.instant("error.noSelect");break;case 3224:c=n.instant("error.noLinkage");break;case 3231:c=n.instant("error.needConfigList");break;case 3232:c=n.instant("error.infoErrorInTable");break;case 7001:c=n.instant("error.needFormula");break;case 7024:c=n.instant("error.stringAbove");break;case 7200:c=n.instant("error.errorFormula");break;case 7300:c=n.instant("error.unknow");break;case 7400:c=n.instant("error.fieldNull");break;case 7500:c=n.instant("error.fieldRepeat");break;case 7590:c=n.instant("error.fieldUsing");break;case 7601:c=n.instant("error.dataNameRepeat");break;case 7700:c=n.instant("error.errorFormula");break;case 8003:c=n.instant("error.accoutRepeat");break;case 9003:c=n.instant("error.info");break;case 10004:c=n.instant("error.datasourceSyncing");break;case 10005:c=n.instant("error.dsAmountOutOfLimit");break;case 10006:c=s.warn_msg;break;case 10007:c=n.instant("error.noDelete");break;case 10100:c=n.instant("error.noDianJingAccess");break;case 10115:c=n.instant("error.startDateError");break;case 10116:c=n.instant("error.endDateError");break;case 10117:c=n.instant("ds.baiduTaskDomainExit");break;case 10118:c=n.instant("ds.baiduTaskDomainNotExit");break;case 10119:c=n.instant("ds.baiduTaskCompanyError");break;case 10120:c=n.instant("ds.baiduTaskDomainError");break;case 10121:case 10122:case 10123:c=s.warn_msg;break;case 10124:c=n.instant("ds.baiduTaskWeekError");break;case 10625:c=n.instant("error.changeFileEncode");break;case 10626:c=n.instant("error.changeFileEncode");break;case 12002:c=n.instant("error.groupRepeat");break;case 12008:c=n.instant("error.contactManager");break;case 12010:c=n.instant("error.noActivateCode");break;case 12011:c=n.instant("error.errorActivateCode");break;case 13001:c=n.instant("error.noSelectId");break;case 13004:c=n.instant("error.selectRepeat");break;case 16004:c=n.instant("error.noPermissionToPreview");break;case 16005:c=n.instant("error.replacingExcelFailed");break;case 16006:c=n.instant("error.exceptionInExcel");break;case 16007:c=n.instant("error.excelNotExist");break;case 16008:c=n.instant("error.excelIsUpdating");break;case 16009:c=n.instant("error.deletingExcelFailed");break;case 16010:c=n.instant("error.excelCanNotBeEmpty");break;case 16011:c=n.instant("error.appendingExcelFailed");break;case 16012:c=n.instant("error.fieldsInExcelMismatch");break;case 16013:c=n.instant("error.sameFieldsWhileAppending");break;case 16014:c=n.instant("error.fieldsNotInTable");break;case 16015:c=n.instant("error.sheetNotExist");break;case 16016:c=n.instant("error.sheetCanNotBeIgnored");break;case 16017:c=n.instant("error.uploadingExcelFailed");break;case 16018:c=n.instant("error.fieldsInExcelMismatch");break;case 16019:c=n.instant("error.fieldsInExcelMismatch");break;case 16025:c=n.instant("error.csvEncodeNotSupport");break;case 16026:c=n.instant("error.changeFileEncode");break;case 19001:c=n.instant("error.selectRely");break;case 19002:c=n.instant("wb.noWorksheets");break;case 19005:c="聚类字段名称不能为空";break;case 21007:c=n.instant("error.dbCannotBeDeleted");break;case 22001:c=n.instant("error.aggregationsRepeat");break;case 22002:c=n.instant("error.aggregationsNull");break;case 23023:c=n.instant("error.accoutExisted");break;case 23002:c=n.instant("error.captchaError");break;case 23003:c=n.instant("error.personalAccountNotExist");break;case 23008:c=n.instant("error.nicknameExisted");break;case 23009:c=n.instant("error.emailError");break;case 23010:c=n.instant("error.captchaCounts");break;case 23013:c=n.instant("error.formatError");break;case 23014:c=n.instant("error.oneHourLater");break;case 23016:c=n.instant("error.twentyFourHourLater");break;case 23019:c=n.instant("error.emailExisted");break;case 23020:c=n.instant("error.phoneExisted");break;case 23023:c=n.instant("error.personalUserExisted");break;case 23030:c=n.instant("error.sensitiveWord");break;case 24006:c=n.instant("error.accoutAccessLimit");break;case 24007:c=n.instant("error.chartUnremove");break;case 24008:c=n.instant("error.userLimit");break;case 24009:c=n.instant("error.haveDeleted");break;case 24010:c=n.instant("error.haveRule");break;case 24011:c=n.instant("error.haveChart");break;case 24012:c=n.instant("error.removeAccess");break;case 25001:c=n.instant("error.folderExisted");break;case 25004:c=n.instant("wb.cannotMoveToSubFolder");break;case 25005:c=n.instant("wb.cannotMoveTwoLevelsToSubFolder");break;case 26003:c=n.instant("error.nameExisted");break;case 26007:c=n.instant("error.exceedTasks");break;case 26008:c="分享表暂不支持聚类模型";break;case 29e3:c=s.warn_msg;break;case 3e4:c=n.instant("error.tableDoesNotExist");break;case 30001:c=n.instant("error.tableIsBeingUsed");break;case 30003:c=s.warn_msg;break;case 30004:c=n.instant("error.tableMustBeBasetable");break;case 30005:c="["+s.warn_msg+"] "+n.instant("wb.transform.realtimeTableCantJoin");break;case 30007:c=n.instant("error.fieldsInExcelMismatch");break;case 30009:c=n.instant("error.sameTitleExistInExcel");break;case 31e3:c=n.instant("error.existRely");break;case 31005:case 31006:c=s.warn_msg;break;case 31007:c=n.instant("error.viewGeneratorRuleNotExist");break;case 31008:c=n.instant("error.canNotModifyThisViewType");break;case 31009:c=n.instant("error.viewGeneratorTypeNotExist");break;case 32001:c=n.instant("error.openDsTokenError");break;case 32002:c=n.instant("error.ipNotInWhiteList");break;case 40001:c=n.instant("error.noPermissionToDelete");break;case 40002:var p="";c=n.instant("error.fieldRepeat")+p;break;case 40005:c=s.warn_msg;break;case 40007:c=n.instant("error.dataTooLong");break;case 40008:c=n.instant("error.changeToAggregatorFunc");break;case 40009:c=n.instant("error.titleHasInvalidCharacter");break;case 40010:c=n.instant("error.contentHasInvalidCharacter");break;case 40011:c=n.instant("error.functionNeedBrackets");break;case 40012:c=n.instant("error.mapCanNotBeEmpty");break;case 41001:c=n.instant("error.LdapTokenIsError");break;case 41002:c=n.instant("error.LdapTokenIsDestroyed");break;case 41003:c=n.instant("error.LdapUserNotExist");break;case 70001:c=n.instant("ds.auxiliaryFieldHasExist");break;case 70002:c=n.instant("error.fieldNameUsing");break;case 81001:var p="";s.warn_msg&&(p="："+s.warn_msg),c=n.instant("error.illegalFilter")+p;break;case 81002:var p="";s.warn_msg&&(p="："+s.warn_msg),c=n.instant("error.illegalSortField")+p;break;case 9e4:c=n.instant("error.partitionExceed");break;case 90001:c=n.instant("error.partitionNotEnough");break;case 90002:c=n.instant("error.intermediateTableNoPartition");break;case 90003:c=n.instant("error.unionTableNoPartition");break;case 90006:c=n.instant("error.childTbBeingCreated");break;case 90100:s.result&&s.result.map&&(c=s.result.map(function(e){return e.name}).join()),c=n.instant("chartTemplate.tplUnusable")+"["+c+"]";break;case 90007:c=n.instant("error.tableTypeNotSupportOpt");break;case 90008:c=n.instant("error.updateModeNotChanged");break;case 90009:c=n.instant("error.canNotChangeToRealTimeUpdateMode");break;case 90010:c=n.instant("error.canNotSetPartitionField");break;case 90011:c=n.instant("error.canNotMergeThisTable");break;case 90012:c=n.instant("error.updatedSoFrequentlyPleaseWait");break;case 100001:c=n.instant("error.failedGetOperatorInfo");break;case 100002:c=n.instant("error.authorizationExpired");break;case 100003:c=n.instant("error.authorizationRecordNotExist");break;case 100004:c=n.instant("error.failedAddOperator");break;case 100005:c=n.instant("error.failedCreateAuthorization");break;case 100006:c=n.instant("error.failedUpdateLdapToken");break;case 100007:c=n.instant("error.failedCreateLdapToken");break;case 100008:c=n.instant("error.failedDeleteLdapToken");break;case 110001:c=n.instant("error.mobileOSorVersionRequired");break;case 110002:c=n.instant("error.unknownMobileOS");break;case 110003:c=n.instant("error.mobileVersionFormatError");break;case 120001:c=n.instant("error.srcDashIdRequiredWhenMovingChart");break;case 120002:c=n.instant("error.targetDashIdRequiredWhenMovingChart");break;case 120003:c=n.instant("error.dashFolderIdRequiredWhenMovingChart");break;case 120004:c=n.instant("error.forbiddenMovingChart");break;case 120005:c=n.instant("error.movedChartExist");break;default:c=s&&s.warn_msg?s.warn_msg:"en"==d?"Something Wrong~":"出错啦",u=!0}}return s.dialog?e.global.dialog_hint=c:(1!=Number(c)||20!=Number(c)||1014!=Number(c))&&(e.global.hint=c),s.always_show||(o&&(a.cancel(o.$$timeoutId),o=null),o=a(function(){e.global.dialog_hint="",e.global.hint=""},s.delay_time||5e3)),u}}]).factory("tbList",["$rootScope","$http","errHint",function(e,a,t){return function(){a.get("/api/tb/list",{params:{access_token:$.cookie("token")}}).success(function(a){if(0==a.status)e.tbList=a.result?a.result.self:[];else{var n=parseInt(a.status);t(n)}})}}]).factory("formatFieldPercentile",["formulaKeyMap",function(){return function(e){if(!e)return e;if("PERCENT"!=e.aggregator)return e.percent="",e;var a=new RegExp("^(\\d|[1-9]\\d|100)$");if("中位数"==e.aggregator_name||"Median"==e.aggregator_name)e.aggregator="MED",e.percent="0.5";else if(a.test(parseInt(e.aggregator_name))){var t=parseInt(e.aggregator_name);e.aggregator="PERCENT_"+t,e.percent=String(t/100)}return e}}]).factory("setAdvanceAggregatorName",["formulaKeyMap",function(e){return function(a){function t(e){var a="",t=$.cookie("locale"),n=function(e){switch(e){case"year":a="zh"==t?"上年同比率":"Compare to last year(rate)";break;case"quarter":a="zh"==t?"上季同比率":"Compare to last quarter(rate)";break;case"month":a="zh"==t?"上月同比率":"Compare to last month(rate)";break;case"week":a="zh"==t?"上周同比率":"Compare to last week(rate)";break;case"day":a="zh"==t?"上日同比率":"Compare to last day(rate)"}},r=function(e){switch(e){case"year":a="zh"==t?"上年同比值":"Compare to last year(value)";break;case"quarter":a="zh"==t?"上季同比值":"Compare to last quarter(value)";break;case"month":a="zh"==t?"上月同比值":"Compare to last month(value)";break;case"week":a="zh"==t?"上周同比值":"Compare to last week(value)";break;case"day":a="zh"==t?"上日同比值":"Compare to last day(value)"}},o=function(e){switch(e){case"rate":a="zh"==t?"环比增长率":"Day on Day(rate)";break;case"value":a="zh"==t?"环比增长值":"Day on Day(value)"}};if(e.hasOwnProperty("yoyQoqType")){var i=e.yoyQoqType;e.hasOwnProperty("YoY")&&"rate"==i&&n(e.YoY),e.hasOwnProperty("YoY")&&"value"==i&&r(e.YoY),e.hasOwnProperty("QoQ")&&o(i)}var s=function(e){switch(e){case"year":a="zh"==t?"按年环比增长":"Year on Year";break;case"quarter":a="zh"==t?"按季环比增长":"Quarter on Quarter";break;case"month":a="zh"==t?"按月环比增长":"Month on Month";break;case"week":a="zh"==t?"按周环比增长":"Week on Week";break;case"day":a="zh"==t?"按日环比增长":"Day on Day"}},c=function(e){switch(e){case"yoy_week":a="zh"==t?"上周同比":"Compare to last week";break;case"yoy_month":a="zh"==t?"上月同比":"Compare to last month";break;case"yoy_quarter":a="zh"==t?"上季同比":"Compare to last quarter";break;case"yoy_year":a="zh"==t?"去年同比":"Compare to last year";break;case"custom":a="zh"==t?"自定义对比":"Custom Comparison";break;case"nodate_custom":a="zh"==t?"自定义对比":"Custom Comparison"}};if(e.hasOwnProperty("yoyQoqSetting")){var l=e.yoyQoqSetting;"qoq"==l.type?s(l.date_field_type):c(l.type)}return a}function n(e){var a="1",t="",n=$.cookie("locale");if(e.hasOwnProperty("advance_aggregator")){var r=e.advance_aggregator.type;"percentage"==r?(t="zh"==n?"百分比":"Percentage",a="1"):"retention"==r?(t="zh"==n?"留存率":"Retention",a="0"):"activity"==r?(t="zh"==n?"活跃率":"Active Rate",a="0"):"repetition"==r?(t="zh"==n?"重复率":"Repetition",a="0"):"running"==r?(t="zh"==n?"累计计算":"Cumulative Calculation",a="1"):"moving"==r&&(t="zh"==n?"移动计算":"Moving Calculation",a="1")}var o=[];return o.push(a),o.push(t),o}var r="",o="",i="",s=[];if(a.hasOwnProperty("aggregator")){if(r=e[a.aggregator],Number(a.aggregator_name)<=100&&Number(a.aggregator_name)>0)if("zh"==$.cookie("locale"))r="百分位"+parseInt(a.aggregator_name);else{var c="";c=parseInt(a.aggregator_name)%10==1&&11!=parseInt(a.aggregator_name)?"st percentile":parseInt(a.aggregator_name)%10==2&&12!=parseInt(a.aggregator_name)?"nd percentile":parseInt(a.aggregator_name)%10==3&&13!=parseInt(a.aggregator_name)?"rd percentile":"th percentile",r=parseInt(a.aggregator_name)+c}1==a.is_build_aggregated&&(r="")}a.hasOwnProperty("advance_aggregator")&&(s=n(a),o=s[1],"0"==s[0]&&(r=""));var l=t(a);return l&&(o=l),r?(i+="("+r,o&&(i+=" - "+o),i+=")"):o&&(i+="(",i+=o,i+=")"),i}}]).factory("getFunctionList",["$rootScope","commonService",function(e,a){var t={base:[],all:[]};a.getFunctionList().then(function(a){if(0==a.status){var n=a.result.classification,r={};angular.forEach(n,function(e,a){r[a]=[],angular.forEach(n[a],function(e){r[a].push({usage:e.usage,description:e.desc,example:e.demo,type:e.name})})}),t.base=r[2].concat(r[3]).concat(r[4]).concat(r[5]).concat(r[6]),e.global.funcList=t}})}]).service("commonHttp",["$http","$rootScope","errHint","pendingRequests","$q",function(e,a,t,n,r){function o(e,t){return i={},i._t=(new Date).getTime(),a.wsId&&(i.ws_id=a.wsId),angular.extend(i,e),s.errHint=!0,t?angular.extend(s,t):t={},i}var i={},s={errHint:!0},c=function(e){if(e=e.data,"0"==e.status)return e;if(s.errHint){var a=parseInt(e.status),n=null;e.errstr&&(n={warn_msg:e.errstr,result:e.result}),t(a||e.errstr,n)}return e},l=["/api/warn/amount"];return{get:function(a,t,s){var d=r.defer();i=o(t,s),$.inArray(a,l)<0&&n.add({url:a,canceller:d});var u=e.get(a,{params:i,timeout:d.promise}).then(c);return u.finally(function(){n.remove(a)}),u.success=function(e){u.then(e)},u.error=function(e){u.then(null,e)},u},post:function(a,t,n){i=o(t,n);var s=r.when(e.post(a,i),c);return s.success=function(e){s.then(e)},s.error=function(e){s.then(null,e)},s}}}]).factory("webSocket",[function(){function e(){return!r&&s>0}var a={},t=null,n=null,r=!1,o=location.protocol,i="https:"==o?30:0,s=i;if(!SockJS)throw"Please add socketjs to your app.";return a.connect=function(n,c){c=c||{};var l=["opened","received","closed"],d=$.cookie("token");return/^http(s)?:\/\//.test(n)||(n=o+"//"+location.host+n),t=new SockJS(n+"?token="+d),t.onopen=function(){c.onOpen&&c.onOpen({status:l[0]})
},t.onmessage=function(e){var a="string"==typeof e.data?$.parseJSON(e.data):e.data;if(0==a.state&&(r=!0,30>s&&window._BDP_TIME_LOGGER&&BDPLogger.log("websocket","reconnect","onsuccess",1),s=i),0==a.state){if(!c.onMessage)throw"Please give the func of onMessage.";c.onMessage({status:l[1],data:a})}},t.onclose=function(){r=!1,window._BDP_TIME_LOGGER&&(BDPLogger.log("websocket","connect","onerror",1),0==s&&BDPLogger.log("websocket","reconnect","onfail",1));var o=e();o&&a.reConnect(n,c),c.onClose&&(c.onClose({status:l[2]}),t=null)},a},a.reConnect=function(e,t){a.disconnect(),n=setTimeout(function(){a.connect(e,t),s--},2e3)},a.disconnect=function(){null!=t&&(t.close(),t=null),clearTimeout(n),r=!1},a.send=function(e){t&&t.send(e)},a.socket=t,a}]).factory("autoRefreshChart",[function(){var e={};return e.refresh=function(e){var a=["data-ctid","data-scrolling","data-drill-status"],t="dashboard",n="true",r=e.drawChartUrl,o=e.type||t,i=e.scope,s=e.ret,c="string"==typeof s.data?$.parseJSON(s.data):s.data,l=(s.status,s._t),d=null;if(!i)throw"Please give param scope.";if(!i.dashEditMode&&!i.autoPlaying&&r&&(d=c.ct_id||[],d.length)){for(var u in i.draw_chart_url){var h=i.draw_chart_url[u].options.ct_id;if(i.draw_chart_url[u].options.read_cache=!1,$.inArray(h,d)>-1){var p=$("["+a[0]+"="+h+"]"),m=p.attr(a[1]),b=p.attr(a[2]),f=m&&m==n,k=b&&b==n;if(f||k)continue;o==t?r[u].options._t=l:r.options._t=l}}i.$$phase||i.$digest()}},e}]).factory("modelAlgoList",["$rootScope","$translate",function(e,a){function t(){a(n).then(function(e){r.forEach(function(a){a.name=e["model."+a.transName]})})}var n=["model.modelAlgo1","model.modelAlgo2"],r=[{name:"多元线性回归",type:1,transName:"modelAlgo1"},{name:"聚类",type:2,transName:"modelAlgo2"}];return t(),e.$on("$translateChangeSuccess",t),r}]).factory("dashChartLink",["$rootScope","commonHttp","errHint","ngDialog",function(e,a,t,n){function r(r){var o={checkSupport:function(e){return!("C261 C290 C300 C310 C320 C330 C340 C400 C360 C370".indexOf(e.type)>-1||r.dashStandardItems.length<=1||e.chart_jump&&"1"==e.chart_jump.can_jump||e.level_fields.length>1)},chart_table_map:{},table_chart_map:{},allChecked:!1,get_table_list:function(t,n){a.post("/api/chart_link/info",{ct_id:t}).then(function(a){"0"==a.status?n(a.result):e.pageLoading=!1})},init_chart_table_map:function(){var e;angular.forEach(r.dashStandardItems,function(a){e=a.children[0].meta,r.chartChain.chart_table_map[e.ct_id]=e.tb_id})},open:function(a){if(!r.chartChain.checkSupport(a))return!1;e.pageLoading=!0,r.chartChain.init_chart_table_map();var t=function(t){function o(e){var a={linkCtIdList:[],linkTbIdList:[]};if(!$.isArray(e))return a;for(var t=0,n=e.length;n>t;t++)a.linkCtIdList.push(e[t].link_ct_id),a.linkTbIdList.push(e[t].link_tb_id);return a}e.pageLoading=!1;var i=t,s=[],c={},l=[],d=null,u=o(i.link_info),h=u.linkCtIdList||{},p=u.linkTbIdList||{};angular.forEach(r.dashStandardItems,function(e){c=e.children[0].meta,c.type&&c.ct_id!==a.ct_id&&s.push({name:c.name,ct_id:c.ct_id,tb_id:c.tb_id,is_gis:"C400"===c.type,selected:$.inArray(c.ct_id,h)>-1,isMainChart:c.chart_link&&2==c.chart_link.linked_chart_type})}),angular.forEach(i.tb_list,function(e){l.push({show:$.inArray(e.tb_id,p)>-1,name:e.name,fields:e.fields,tb_id:e.tb_id,selected:[]}),a.tb_id==e.tb_id&&(d={name:e.name,fields:e.fields,tb_id:e.tb_id,selected:$.inArray(e.tb_id,p)>-1})});for(var m=null,b=!1,f=0;f<a.x.length;f++){var k=a.x[f],C=k.fid,g=!1,E=[];angular.forEach(l,function(e){var a,t=e.tb_id;angular.forEach(i.link_info,function(n){n.link_tb_id==t&&(e.ct_id=n.link_ct_id,angular.forEach(n.field_map,function(e){e.field==C&&f==e.index&&(a=e.link_field,g=!0)}))}),E.push({tbId:t,linkFieldId:a,curTable:e,index:f,fid:C})}),a.x[f].selectedTable=E,g?(k.selected=!0,null===m&&(m=f),b=!0):k.selected=!1}b?a.x[m]&&(a.x[m].isCur=!0):(a.x[0].isCur=!0,a.x[0].selected=!0),angular.forEach(a.x,function(e,a){1==e.isCur&&a>m&&(e.isCur=!1)}),a.chartLinkType=$.inArray(a.type,["C210","C211","C212","C220","C240","C241","C242"])>-1&&2==a.x.length?"doubleDms":"C200"==a.type?"manyDms":"oneDms",r.chartChain.changeCheckedAll(s),n.open({template:"/static/partials/dialogTemplates/chart_chain.html",className:"ngdialog-theme-default str-filter-model chart-chain-modal",data:{main_chart:a,charts:s,main_table:d,tables:l},scope:r})};r.chartChain.get_table_list(a.ct_id,t)},update_status:function(e,a){var t=a.charts,n=a.tables,o=r.chartChain.chart_table_map[e.ct_id],i=function(e){for(var a=0;a<n.length;a++)if(o===n[a].tb_id)return n[a].show=e,!1};if(r.chartChain.changeCheckedAll(a.charts),e.selected)i(!0);else for(var s=0;s<t.length;s++)if(i(!1),o===t[s].tb_id&&t[s].selected)return i(!0),!1},changeCheckedAll:function(e){var a=0,t=0;angular.forEach(e,function(e){e.is_gis||a++,e.selected&&t++}),r.chartChain.allChecked=a==t},checkAllCharts:function(e,a){r.chartChain.allChecked=e,angular.forEach(a.charts,function(t){t.is_gis||(t.selected=e,r.chartChain.update_status(t,a))})},selectDms:function(e,a,t){angular.forEach(a.x,function(e,a){e.isCur=a==t?!0:!1})},save:function(o){var i=!0,s=[],c=[],l="manyDms"==o.main_chart.chartLinkType,d="doubleDms"==o.main_chart.chartLinkType;angular.forEach(o.charts,function(e){e.selected&&s.push(e.ct_id)}),0===s.length&&(t(r.tips["chart.chainChart"]),i=!1),$.each(o.main_chart.x,function(e,a){var n=a.fid;return a.selected&&(main_chart=!0),$.each(o.charts,function(s,u){if(u.selected){var h,p,m,b=u.tb_id,f=u.ct_id,k=!1;return angular.forEach(a.selectedTable,function(e){e.tbId&&e.curTable.tb_id==b?h=e.linkFieldId:b==o.main_table.tb_id&&(h=n)}),!h&&b==o.main_chart.tb_id&&(d||!d&&a.selected)&&(h=n),h&&(h=h.split("_")[0],p={field:n,index:e,link_field:h}),$.each(c,function(e,a){return a.link_ct_id==f?(k=!0,m=e,!1):void 0}),h&&(l?a.selected:!0)&&(k?c[m].field_map.push(p):c.push({link_ct_id:f,link_tb_id:b,field_map:[p]})),!h&&a.selected||"doubleDms"==o.main_chart.chartLinkType&&!h?(i=!1,void t(r.tips["chart.chainField"])):void 0}}),"oneDms"==o.main_chart.chartLinkType?!1:void 0}),i&&a.post("/api/chart_link/commit",{ct_id:o.main_chart.ct_id,link_info:angular.toJson(c)}).then(function(){t(r.tips.saveSuccess),r.getDashboardInfo(r.dashSelected),n.closeAll(),e.mainChartIdContainer=[],e.mainChartContainer=[]})},del:function(o,i){o.stopPropagation(),a.post("/api/chart_link/delete",{ct_id:i}).then(function(){t(r.tips.delChartLinkSuccess);var a=$.inArray(i,e.mainChartIdContainer);angular.forEach(e.mainChartContainer,function(a,t){a.ctId==i&&e.mainChartContainer.splice(t,1)}),e.mainChartIdContainer.splice(a,1),r.getDashboardInfo(r.dashSelected),n.closeAll()})}};return o}return r}]).factory("dashChartJump",["$rootScope","ngDialog","commonService","errHint","$state",function(e,a,t,n,r){function o(o){var i={checkSupport:function(e){return!("C261 C290 C300 C310 C320 C330 C340 C400 C360 C370".indexOf(e.type)>-1||e.level_fields.length>1||1*e.chart_link.linked_chart_type===2)},getData:function(a,n){var o=r.params.dashId;t.ds.getJumpInfo({ct_id:a,dsh_id:o}).then(function(a){"0"==a.status?n(a.result):e.pageLoading=!1})},getChartFields:function(e){var a=["C210","C211","C212","C220","C240","C241","C242"],t=null;if("C200"===e.type){t=e.x.slice(0);for(var n=0,r=t.length;r>n;n++){var o=t[n];o.name=o.nick_name||o.name,o.fIndex=n}return{fields:t,type:"arr"}}return t=$.inArray(e.type,a)>-1&&2==e.x.length?e.x[1]:e.x[0],t.name=t.nick_name||t.name,{fields:t,type:"str"}},getInitFieldId:function(e,a){var t="arr"==a.type?a.fields[0]:a.fields;return e.fid||t.fid},getInitFieldObj:function(e,a){var t=a.fields;if("arr"==a.type){for(var n=null,r=0,o=t.length;o>r;r++){var i=t[r];if(i.fid==e.fid&&"f_index"in e&&e.f_index==i.fIndex){n=i;break}}return n||t[0]||{}}return t},getInitMode:function(e){return e.is_blank?1:0},getInitProj:function(e,a){var t,n;if(e.proj_id)for(var r=0,o=a.length;o>r;r++){var i=a[r];if(i.proj_id==e.proj_id){t=i;break}}return t=t||a[0]||{},n=t.proj_id,{proj:t,selectId:n}},getInitDash:function(e,a){for(var t,n,r=0,o=a.length;o>r;r++){var i=a[r];if(i.dsh_id==e.dsh_id){n=i;break}}return n=n||a[0]||{},t=n.dsh_id,n.df_list=n.df_list||[],{dash:n,selectId:t}},getInitFilter:function(e,a){for(var t,n,r=0,o=a.length;o>r;r++){var i=a[r];if(i.df_id==e.df_id){n=i;break}}return n=n||a[0]||{},t=n.df_id,{filter:n,selectId:t}},change:["$scope","$timeout",function(e){var a=e.ngDialogData;e.changeProj=function(){a.selectDashObj=a.selectprojObj.dash_list[0]||{},e.$$phase||e.$digest(),a.selectFilterObj=a.selectDashObj.df_list?a.selectDashObj.df_list[0]:{}},e.changeDash=function(){a.selectDashObj.df_list=a.selectDashObj.df_list||[],a.selectFilterObj=a.selectDashObj.df_list[0]}}],showDia:function(e){if(i.checkSupport(e)){var t=e.ct_id,n=i.getChartFields(e),r=function(e){var r=e.select_info,s=e.info_list,c=i.getInitProj(r,s),l=i.getInitDash(r,c.proj.dash_list),d=i.getInitFilter(r,l.dash.df_list),u=i.getInitMode(r),h=i.getInitFieldObj(r,n);a.open({template:"/static/partials/dialogTemplates/dash_chart_jump.html",className:"ngdialog-theme-default str-filter-model chart-jump-model",data:{openMode:u,infoList:s,initField:h,jumpFields:n,initProj:c.proj,initDash:l.dash,initFilter:d.filter,ctId:t},scope:o,controller:i.change})};i.getData(t,r)}},save:function(e){function r(e,a){var t;return t="date"==e?2:1,a==t&&1==a}if(e.selectFilterObj&&e.selectFilterObj.df_id){e.selectFieldObj=e.selectFieldObj||e.initField;var i={ct_id:e.ctId,fid:e.selectFieldObj.fid,f_index:e.selectFieldObj.fIndex,proj_id:e.selectprojObj.proj_id,dsh_id:e.selectDashObj.dsh_id,df_id:e.selectFilterObj.df_id,is_blank:1*e.openMode};return r(e.selectFieldObj.data_type,e.selectFilterObj.type)?void t.ds.saveJumpInfo(i).then(function(e){"0"==e.status?(o.getDashboardInfo(o.dashSelected),a.closeAll()):n(e.errstr)}):void n(o.tips["dash.dashCartJump.errSameTip"])}},del:function(e,r){e.stopPropagation(),t.ds.delJumpInfo({ct_id:r}).then(function(e){"0"==e.status&&n(o.tips["dash.dashCartJump.successDelTip"]),o.getDashboardInfo(o.dashSelected),a.closeAll()})}};return i}return o}]).factory("chartJumpFuns",["commonService","$location","$state","ngDialog",function(e,a,t,n){var r={init:function(e,a){a.info.chart_type;r.check(e,a)},"goto":function(e,t,o,i){var s=e.is_blank,c=(e.jumpInfo,e.dsh_id),l=(e.df_id,r.getDashUrl(e,t,o,i));if(0==s){var d=a.path();return d.indexOf("/dash_fullscreen/")>-1?void a.url(l):(n.closeAll(),void $("body").trigger("changeDashboard",{dshId:c,projInfo:t,url:l}))}window.open(l,"_blank")},getPointData:function(e,a){var t=["C271","C272"],n=a.info.chart_type,r=a.data.x,o=[];return"C200"===n?e:($.inArray(n,t)>-1?o.push(e.name):angular.forEach(r,function(a){o.push(a.data[e.index])}),o[o.length-1])},getDashUrl:function(e,n,o,i){var s,c=e.proj_id,l=e.dsh_id,d=e.df_id,u=e.is_blank,h=u?"/#":"",p=a.path(),m=p.indexOf("/dash_edit")>-1||p.indexOf("/dash_fullscreen")>-1,b=(p.indexOf("dash_tpl")>-1,h+(m?"/dash_edit":"/dash_tpl")),f=n.rule_id,k=r.getPointData(o,i),C="?df_id="+d+"&range="+k;return s=f?b+"/"+c+"/"+l+"/"+f:t.params.wsId?b+"_ws/"+t.params.wsId+"/"+c+"/"+l:b+"/"+c+"/"+l,s+=C},check:function(a,n){var o=n.optional.chart_jump_info,i=n.ct_id,s=o.dsh_id,c=t.params.dashId;e.ds.checkJumpInfo({ct_id:i,tgt_dsh_id:s,dsh_id:c}).then(function(e){if("0"==e.status){var t=e.result.proj_info;1==e.result.can_jump?r.goto(o,t,a,n):errHint("没有筛选器")}})}};return r}]).factory("setTableAdvSort",["ngDialog","$timeout",function(e,a){var t={show:function(a,n,r){{var o="/static/partials/dialogTemplates/table-adv-sort.html",i="ngdialog-theme-default chart-chain-modal table-adv-wrap",s=!r,r=r||a.chart_ops.meta.level[a.drill_level],c=[],l=r.x,d=r.y,u=r.row_setting,h=r.y_optional;bdpChart.language||"zh"}c=c.concat(t.preHandleData(l,"x",a)),!s&&u&&(u.name="zh"==bdpChart.language?"总计":"Summary",d.splice(u.pos,0,u)),c=c.concat(t.preHandleData(d,"y",a)),c=c.concat(t.preHandleData(h,"y_optional",a)),t.initScopeFuns(a,c,n,r,s),this.dia=e.open({template:o,className:i,scope:a})},initScopeFuns:function(e,n,r,o,i){var s=this,c=".J-sortable-adv-sort",l=e.$bdpChart,d=o.advanced_sort=o.advanced_sort||[];t.initData(e,d,n),e.addAdvSortField=function(a){var t=e.fieldListInfo.splice(a,1);e.sortRuleInfo.push(t[0])},e.addAllAdvSortFields=function(){e.fieldListInfo=[],e.sortRuleInfo=n.slice(0)},e.clearAllRuleFields=function(){e.fieldListInfo=n.slice(0),e.sortRuleInfo=[]},e.deleteRuleField=function(a){var t=e.sortRuleInfo.splice(a,1);e.fieldListInfo.push(t[0])},e.tableAdvSortOk=function(){e.draw_chart_url;o.is_advanced_sort=1,o.advanced_sort=e.sortRuleInfo.slice(0),i?r({closeDialog:!0}):(l.emit("setAdvSort",{advanced_sort:JSON.stringify(o.advanced_sort),is_advanced_sort:o.is_advanced_sort}),s.dia.close())},e.cancelsetAdvSort=function(){e.clearAllRuleFields(),s.dia.close()},e.sortRuleFields={items:c,start:function(){},update:function(){},stop:function(a,t){var n=t.item.sortable.index,r=t.item.sortable.dropindex,o=e.sortRuleInfo[r],i=e.sortRuleInfo[n];e.sortRuleInfo[n]=i,e.sortRuleInfo[r]=o}},l&&l.off("dashboard_click_sort").on("dashboard_click_sort",function(){a(function(){o.is_advanced_sort=0})})},initGuide:function(e){var a="___bdp_guide_table_adv_sort___",t=a+$.cookie("user");e.hideTableAdvSortGuide=function(a){a.stopPropagation(),localStorage.setItem(t,Date.now()),e.hasShowedTableAdvSortGuide=!0},e.hasShowedTableAdvSortGuide=!!localStorage.getItem(t)},initData:function(e,a,t){if(a.length<1)e.sortRuleInfo=[],e.fieldListInfo=t.slice(0)||[];else{for(var n=[],r=0,o=t.length;o>r;r++){for(var i=t[r],s=i.fid,c=i.uniq_id,l=!1,d=i.axis,u=0,h=a.length;h>u;u++){var p=a[u],m=p.fid,b=p.uniq_id,f=p.axis,k=p.type;if(d==f)if(c){if(b===c){l=!0,i.type=k,p.name=i.name;break}}else if(m===s){l=!0,i.type=k,p.name=i.name;break}}l||n.push(i)}e.fieldListInfo=n.slice(0),e.sortRuleInfo=a.slice(0)}},preHandleData:function(e,a,t){var n=[],r=[];if($.isArray(e))for(var o=0,i=e.length;i>o;o++){var s=e[o],c="x"===a?s.name:s.name+t.setAdvanceAggregatorName(s),l=s.nick_name||c,d={fid:s.fid,axis:"y_optional"==a?"y":a,name:l,originName:c,type:"asc"};s.uniq_id?(d.uniq_id=s.uniq_id,-1==$.inArray(s.uniq_id,n)&&(n.push(s.uniq_id),r.push(d))):r.push(d)}return r}};return t}]);
;"use strict";angular.module("filter",[]).filter("null_date",["$rootScope","$translate",function(e,r){function n(){return r(["all","chart.notLimit"]).then(function(e){t=e["chart.notLimit"]})}var t="不限";return n(),e.$on("$translateChangeSuccess",n),function(e){return e?e:t}}]).filter("format_date",["$rootScope","$translate",function(e,r){function n(){return r(["all","chart.notLimit"]).then(function(e){t=e.all,a=e["chart.notLimit"]})}var t="全部时间",a="不限";n(),e.$on("$translateChangeSuccess",n);var u=/^opt_[0-9a-zA-Z]{32}$/;return function(e,r,n){if(1==e.length&&!u.test(e[0]))return e[0];var o=function(){var a="";return angular.forEach(r,function(r){r.opt_id===e[0]&&(a=r.name)}),a=a?a:n||t};if(!e)return n||t;var i=e.length,f="test";switch(i){case 0:f=n||t;break;case 1:f=u.test(e[0])?o():e[0];break;case 2:var c=e[0]?e[0]:a,s=e[1]?e[1]:a;f=c+"~"+s;break;default:f=n||t}return f}}]).filter("inner_range_date_format",function(){return function(e,r){var n=r.granularity,t=r.granularity_name||"",a=r.month_start_day||0;return e.length?e.map(function(e){return bdpChart.helper.checkGranularity(n,e,t,a)}).join(","):e}}).filter("granularity",["granularityMap",function(e){return function(r){var n=r;return r&&(n="chart.by"+r.charAt(0).toUpperCase()+r.substring(1)),e[n]||e["chart.byDay"]}}]).filter("dataShowType",["dataShowTypeMap",function(e){return function(r){var n=r;return r&&(n="chart.by"+r.charAt(0).toUpperCase()+r.substring(1)),e[n]||e["chart.byText"]}}]).filter("empty",function(){return function(e){return"NULL"==e&&(e=""),e}}).filter("query_inner",function(){var e=function(e,r,n){if(!e||!r)return e;var t=[];if("string"==typeof e[0])angular.forEach(e,function(e){e.toLowerCase().indexOf(r.toLowerCase())>-1&&t.push(e)});else{var a;angular.forEach(e,function(e){a=bdpChart.helper.checkGranularity(n,e),a.toLowerCase().indexOf(r.toLowerCase())>-1&&t.push(e)})}return t};return e}).filter("query_fields",function(){return function(e,r,n){if(!r)return e;n=n||"fuzzy";var t=[];return angular.forEach(e,function(e){("number"==typeof e.name||"number"==typeof e.original_name)&&(e.name=e.name.toString(),e.original_name=e.original_name.toString()),e.original_name?(e.original_name.toLowerCase().indexOf(r.toLowerCase())>-1||e.name.toLowerCase().indexOf(r.toLowerCase())>-1)&&t.push(e):"fuzzy"==n&&e.name.toLowerCase().indexOf(r.toLowerCase())>-1?t.push(e):"exactly"==n&&e.name.toLowerCase()==r.toLowerCase()&&t.push(e)}),t}}).filter("queryFieldsAsTitle",function(){return function(e,r){if(!r)return e;var n=[];return angular.forEach(e,function(e){"number"==typeof e.name&&(e.title=e.title.toString()),e.title.toLowerCase().indexOf(r.toLowerCase())>-1&&n.push(e)}),n}}).filter("query_tables",function(){return function(e,r){if(!r)return e;var n=[];return angular.forEach(e,function(e){"number"==typeof e.name&&(e.name=e.name.toString()),(e.name.toLowerCase().indexOf(r.toLowerCase())>-1||e.label&&e.label.toLowerCase().indexOf(r.toLowerCase())>-1)&&n.push(e)}),n}}).filter("categoryFilter",function(){return function(e,r){if(!r)return e;for(var n=[],t=0,a=e.length;a>t;t++)(-1!=e[t].db_name[language].toLowerCase().indexOf(r.toLowerCase())||-1!=e[t].category_name[language].toLowerCase().indexOf(r.toLowerCase()))&&n.push(e[t]);return n}}).filter("nameFilter",function(){return function(e,r){if(!r)return e;for(var n=[],t=0;t<e.length;t++)e[t].original_name?(-1!=e[t].name.toLowerCase().indexOf(r)||-1!=e[t].original_name.toLowerCase().indexOf(r))&&n.push(e[t]):-1!=e[t].name.toLowerCase().indexOf(r)&&n.push(e[t]);return n}}).filter("titleFilter",function(){return function(e,r){if(!r)return e;for(var n=[],t=0;t<e.length;t++)-1!=e[t].title.toLowerCase().indexOf(r)&&n.push(e[t]);return n}}).filter("query_models",function(){return function(e,r){if(!r)return e;var n=[];return angular.forEach(e,function(e){"number"==typeof e.name&&(e.name=e.name.toString()),e.name.toLowerCase().indexOf(r.toLowerCase())>-1&&n.push(e)}),n}}).filter("query_fields_nick_name",function(){return function(e,r){if(!r)return e;var n=[];return angular.forEach(e,function(e){("number"==typeof e.nick_name||"number"==typeof e.name)&&(e.nick_name=e.nick_name.toString(),e.name=e.name.toString()),(e.nick_name.toLowerCase().indexOf(r.toLowerCase())>-1||e.name.toLowerCase().indexOf(r.toLowerCase())>-1)&&n.push(e)}),n}}).filter("query_baiduSearch",function(){return function(e,r){var n=[];return r?"暂未设置"===r?(angular.forEach(e,function(e){""===e.companyName&&n.push(e)}),n):(angular.forEach(e,function(e,t){"number"==typeof e.companyName&&(e.companyName=e.companyName.toString()),(e.companyName.toLowerCase().indexOf(r.toLowerCase())>-1||0==t)&&n.push(e)}),n):e}}).filter("cutLength",function(){return function(e,r){if(!r)return e;var n=e;return e.length>r&&(n=e.slice(0,r)+"……"),n}}).filter("query_updateRecord_fileLlist",function(){return function(e,r){if(!r)return e;var n=[];return angular.forEach(e,function(e){var t=e.excel_name+"-"+e.sheet_name;t.toLowerCase().indexOf(r.toLowerCase())>-1&&n.push(e)}),n}}).filter("queryByTagorDstype",["$rootScope",function(e){return function(r,n){function t(e){return e.tag&&e.tag.toLowerCase().indexOf(n.toLowerCase())>-1}function a(r){var t=r.ds_type_name[e.language];return t&&t.toLowerCase().indexOf(n.toLowerCase())>-1}if(!n)return r;var u=[];return angular.forEach(r,function(e){(t(e)||a(e))&&u.push(e)}),u}}]).filter("query_ds_names_or_tags",function(){return function(e,r){if(!r)return e;var n=[],t=[];angular.forEach(e,function(e){e.hasOwnProperty("tag")&&null!=e.tag&&e.tag.toLowerCase().indexOf(r.toLowerCase())>-1?n.push(e):e.hasOwnProperty("ds_name")&&null!=e.ds_name&&e.ds_name.toLowerCase().indexOf(r.toLowerCase())>-1&&t.push(e)});var a=[];return a=n.concat(t)}}).filter("query_user",function(){return function(e,r){if(!r)return e;var n=[];return angular.forEach(e,function(e){(e.name.toLowerCase().indexOf(r.toLowerCase())>-1||e.username&&e.username.toLowerCase().indexOf(r.toLowerCase())>-1)&&n.push(e)}),n}}).filter("query_group",function(){var e=function(e,r){if(!r)return e;var n=[];return angular.forEach(e,function(e){e.group_name.toLowerCase().indexOf(r.toLowerCase())>-1&&n.push(e)}),n};return e}).filter("query_parse_param",function(){return function(e,r){if(!r)return e;var n=[],t=[];return angular.forEach(e,function(e){t=[],angular.forEach(e.keys,function(e){e.name.toLowerCase().indexOf(r.toLowerCase())>-1&&t.push(e)}),t.length>0&&n.push({original_field_id:e.original_field_id,original_field_name:e.original_field_name,keys:t})}),n}}).filter("filter_compare",["$rootScope","$translate",function(e,r){function n(){r(["warn.higher","warn.lower"]).then(function(e){t=e["warn.higher"],a=e["warn.lower"]})}var t="高于",a="低于";return n(),e.$on("$translateChangeSuccess",n),function(e){return 1==e?t:a}}]).filter("warnSwitch",["$translate",function(e){var r="开启预警",n="关闭预警";return e(["warn.open","warn.close"]).then(function(e){r=e["warn.open"],n=e["warn.close"]}),function(e){return 1==e?n:r}}]).filter("sub_date",function(){return function(e,r){var n=r.data_type,t=r.config?r.config.granularity:r.granularity,a=r.name;return void 0===e||""===e||0==e.length?a:"string"==n?"object"!=typeof e?e:e.join("，"):"date"==n?"object"!=typeof e?bdpChart.helper.checkGranularity(t,e):e.map(function(e){return bdpChart.helper.checkGranularity(t,e)}).join("，"):(t=r.fid.split("_")[1],bdpChart.helper.subDateFormat(t,e))}}).filter("dash_sub_date",["$rootScope","$translate",function(e,r){var n="全部";return r("all").then(function(e){n=e}),e.$on("$translateChangeSuccess",function(){r("all").then(function(e){n=e})}),function(e,r){var t=r.data_type,a=r.granularity;return void 0===e||""===e||0==e.length?n:"string"==t?"object"!=typeof e?e:e.join("，"):"date"==t?"object"!=typeof e?bdpChart.helper.checkGranularity(a,e):e.map(function(e){return bdpChart.helper.checkGranularity(a,e)}).join("，"):(a=r.fid.split("_")[1],"object"!=typeof e?bdpChart.helper.subDateFormat(a,e):e.map(function(e){return bdpChart.helper.subDateFormat(a,e)}).join(","))}}]).filter("plot_line_calc",["formulaKeyMap",function(e){return function(r){return e[r]}}]).filter("date_gran_to_name",["dateNameMap",function(e){return function(r){return e[r]||e.day}}]).filter("tb_type_hint",function(){return function(e,r){if("access_tb"==r)return"分配";var n;switch(e){case"excel":n="Excel";break;case"join":n="多表合并";break;case"aggr":n="数据聚合";break;case"ds":n="数据库表";break;case"public":n="公共数据表";break;default:n="工作表"}return n}}).filter("userStatus",["$translate","$rootScope",function(e,r){function n(){e(["user.base_info.unactive","user.base_info.pwd"]).then(function(e){t=e["user.base_info.unactive"],a=e["user.base_info.pwd"]})}var t="未激活",a="已重置密码";return n(),r.$on("$translateChangeSuccess",n),function(e){return 1==e?t:a}}]).filter("fieldType",function(){return function(e){switch(e=Number(e)){case 0:case 1:return"数值";case 2:return"字符串";case 3:return"日期"}}}).filter("granularityName",["granularityMap",function(e){return function(r){var n=r;return r&&(n="chart.by"+r.charAt(0).toUpperCase()+r.substring(1)),e[n]||e.normal}}]).filter("buildAggregator",function(){return function(e){return e?e.filter(function(e){return 1!==e.is_build_aggregated}):[]}}).filter("db_type",["$rootScope","databaseType",function(e,r){return function(e){for(var n="",t=0;t<r.length;t++)if(r[t].dbType==e){n=r[t].typeName;break}return n}}]).filter("weekFormat",function(){return function(e){"number"!=typeof e&&(e=new Date(e).getTime());var r=864e5,n=Highcharts.dateFormat("%b/%e",e),t=Highcharts.dateFormat("%b/%e",e+6*r);return n+"~"+t}}).filter("dateFormat",function(){return function(e){return Highcharts.dateFormat("%Y-%m-%d",new Date(e))}}).filter("workTbName",function(){return function(e){return e||"请选择工作表"}}).filter("workFieldName",function(){return function(e){return e||"请选择字段"}}).filter("filterOperator",["filterOperatorMap",function(e){return function(r){return""===r?"":e[r]||e[0]}}]).filter("conditionType",function(){return function(e){return 0==e?"全部":"任一"}}).filter("timestamp2LocaleDate",[function(){return function(e,r){return bdpChart.helper.checkGranularity(r,e)}}]).filter("t2Date",[function(){return function(e,r){var n=r.granularity,t=r.granularity_name||"",a=r.month_start_day||0;return"week"===n&&(a=r.week_start_day_of_week),bdpChart.helper.checkGranularity(n,e,t,a)}}]).filter("yoyTypeTranslate",["$rootScope","dateNameMap",function(e,r){return function(n,t){var a,u;return"zh"==e.language?(a="环比增长",u="value"==t?"值":"率"):(a=r[n]+" on "+r[n],u=t?"("+t+")":""),t?a+u:a}}]).filter("thisCaptain",function(){return function(e){return e.substring(0,4)+e.charAt(4).toUpperCase()+e.substring(5)}}).filter("i18nMonth",["$rootScope",function(e){var r=e.language,n=["January","February","March","April","May","June","July","August","September","October","November","December"];return function(e){return"zh"===r?e+"月":"en"===r?n[e-1]:void 0}}]).filter("i18nWeek",["$rootScope",function(e){var r=e.language,n=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],t=["星期一","星期二","星期三","星期四","星期五","星期六","星期日"];return function(e){return"zh"===r?t[e-1]:"en"===r?n[e-1]:void 0}}]).filter("i18nDay",["$rootScope",function(e){var r=e.language;return function(e){if("zh"===r)return e+"日";if("en"===r)switch(e){case 1:return e+"st";case 2:return e+"nd";case 3:return e+"rd";default:return e+"th"}}}]).filter("timestamp2DayInWeek",["$rootScope",function(e){var r=e.language,n=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],t=["星期一","星期二","星期三","星期四","星期五","星期六","星期日"];return function(e){var a=new Date(e),u=a.getDay();return u=0===u?7:u,"zh"===r?t[u-1]:"en"===r?n[u-1]:void 0}}]).filter("query_union_table",function(){return function(e,r){var n=[];return r?(angular.forEach(e,function(e){e.hasOwnProperty("tag")&&e.tag.toLowerCase().indexOf(r.toLowerCase())>-1?n.push(e):e.hasOwnProperty("name")&&e.name.toLowerCase().indexOf(r.toLowerCase())>-1&&n.push(e)}),n):e}}).filter("timestampToHoursFormat",["$translate",function(e){return function(r){r/=1e3;var n=Math.floor(r/3600),t=Math.floor((r-3600*n)/60),a=Math.floor(r-3600*n-60*t);return n+e.instant("author.hour")+t+e.instant("author.minute")+a+e.instant("author.second")}}]).filter("fieldFilter",function(){return function(e,r){if(!r)return e;var n=[];return angular.forEach(e,function(e){"number"==typeof e.name&&(e.name=e.name.toString()),e.name.toLowerCase().indexOf(r.toLowerCase())>-1&&n.push(e)}),n}}).filter("dbLogSheetStatus",function(){return function(e,r){if(!r)return e;var n=[];return angular.forEach(e,function(e){(e.status==r||"all"==r)&&n.push(e)}),n}}).filter("dbLogSheetQuery",function(){return function(e,r){if(!r)return e;var n=[];return angular.forEach(e,function(e){e.title.toLowerCase().indexOf(r.toLowerCase())>-1&&n.push(e)}),n}}).filter("dbLogTaskStatus",function(){return function(e,r){if(!r)return e;var n=[];return angular.forEach(e,function(e){(e.status==r||"all"==r)&&n.push(e)}),n}}).filter("htmlFilter",["$sce",function(e){return function(r){return e.trustAsHtml(r)}}]).filter("dateFormat",["$translate",function(e){return function(r,n){function t(){var e=Highcharts.dateFormat("%Y/%m/%d",new Date);return new Date(e).getTime()}r=r.replace(/-/g,"/"),n=n.replace(/-/g,"/");var a=new Date(r).getTime(),u=t(),o=new Date(n).getTime(),i=parseInt((u-a)/1e3/60/60);if(!(u>a)){var f=parseInt((o-a)/1e3/60/60);if(f>=1)return f+e.instant("hourAgo");var c=parseInt((o-a)/1e3/60);return c>5?c+e.instant("minuteAgo"):e.instant("just")}return i>48?r.replace(/(.{4})\/(.{2})\/(.{2})(.*)$/,function(r,n,t,a){return n+e.instant("upyear")+t+e.instant("upmonth")+a+e.instant("upday")}):48>i&&i>=24?e.instant("beforeYesterday"):24>i?e.instant("yesterday"):void 0}}]).filter("getFieldsByDataType",function(){return function(e,r){var n=[];return angular.forEach(e,function(e){e.data_type==r&&n.push(e)}),n}});
;!function(){angular.module("BC.services").service("commonService",["$http","errHint","commonHttp",function(t,e,i){var n,r,o,a=function(t){if(t=t.data||t,"0"==t.status)return t.result;var i=null;return t.errstr&&(i={warn_msg:t.errstr}),e(Number(t.status),i),null};n={modify:function(t){return i.post("/api/global_config/modify",{data:t}).then(a)},themeModify:function(t){return i.post("/api/user/modify_theme",{theme_id:t})}},r={create:function(t){return i.post("/api/project/create",{name:t})},getTree:function(t){return i.get("/api/project/tree",t).then(a)},modify:function(t,e){return i.get("/api/project/modify",{proj_id:t,data:{name:e}})},del:function(t){return i.post("/api/project/delete",{proj_id:t})},order:function(t){var e=t.map(function(t){return{type:t.type,proj_id:t.proj_id}});return i.post("/api/project/order",{sort:angular.toJson(e)})}},o={getList:function(t){return i.get("/api/dashboard/list",t).then(a)},getInfo:function(t){var e={};return t=angular.extend(e,t),i.get("/api/dashboard/info",t)},create:function(t){return i.post("/api/dashboard/create",{name:t.name,proj_id:t.proj_id,label:t.label||"",comment:t.comment||"",meta:angular.toJson({show_block:!0})})},modify:function(t){return t.access_token=$.cookie("token"),i.post("/api/dashboard/modify",t)},del:function(t){return i.post("/api/dashboard/delete",{dsh_id:t})},order:function(t,e,n){return i.post("/api/dashboard/order",{proj_id:t,type:e||0,sort:angular.toJson(n)})},move:function(t,e,n,r){return i.post("/api/dashboard/move",{dsh_id:r,proj_id:t,type:e,sort:angular.toJson(n)})}},chart={getInfo:function(t){var e={};return"string"==typeof t?e.ct_id=t:e=angular.extend(t,e),i.post("/api/chart/info",e)},getData:function(e){return t.post("/api/chart/data",{ct_id:e})},create:function(t){var e={dsh_id:t.dsh_id};return angular.isArray(t.tb_id)?(e.ct_type=1,e.tb_ids=angular.toJson(t.tb_id)):(e.tb_id=t.tb_id,2==t.ct_type&&(e.ct_type=2)),t.dsh_meta&&(e.dsh_meta=angular.toJson(t.dsh_meta)),i.post("/api/chart/create",e)},del:function(t){return t.dsh_meta&&(t.dsh_meta=angular.toJson(t.dsh_meta)),i.post("/api/chart/delete",t)},modify:function(t){return i.post("/api/chart/modify",t)},getDbInfo:function(t){return i.get("/api/chart/database_info",{ct_id:t})},modifyTb:function(t,e){return i.get("/api/chart/modify_tb",{ct_id:t,tb_id:e})},getRelationList:function(t){return i.get("/api/chart/rela_list",{tb_id:t}).then(a)},search:function(t){return i.get("/api/chart/search",{ct_name:t.name,is_tpl:t.is_tpl}).then(a)},getSizeGroups:function(t,e,n,r,o){return o=o?angular.toJson(o):void 0,i.post("/api/chart/size_groups",{ct_id:t,bubble_setting:angular.toJson(e),drill_level:n,drill_field:r,drill_value:o}).then(a)},getGisSizeGroups:function(t,e,n){return i.post("/api/chart/size_groups",{ct_id:t,bubble_setting:angular.toJson(e),layer_level:n}).then(a)},addRelaTb:function(t,e){return i.post("/api/chart/add_rela_tb",{ct_id:t,tb_id:e})},delRelaTb:function(t,e){return i.post("/api/chart/del_rela_tb",{ct_id:t,tb_id:e})},exportExcelType:function(t){return i.post("/api/export/get_file_type",t)},exportLargeExcel:function(t){return i.post("/api/export/large_file",t)},wholeRelaChain:function(t){return i.post("/api/chart/whole_rela_chain",{tb_id:t.tb_id})},tableUnion:function(t){return i.post("/api/chart/table_union",t)}};var u={getField:function(t){var e={dstb_id:t};return i.get("/api/dstb/info",e).then(a)},del:function(t){var e={dstb_id:t};return i.get("/api/dstb/delete",e)},getList:function(){return i.get("/api/dstb/list").then(a)},modify:function(t,e){var n={dstb_id:t,data:e};return i.get("/api/dstb/modify",n).then(a)},getUpdateRecord:function(t){return i.get("/api/excel/list?time="+(new Date).getTime(),t).then(a)},deleteFile:function(t,e){var n={dstb_id:t,filetbname:e};return i.get("/api/dstb/delete_file",n).then(a)},excelCreate:function(t){return i.post("/api/excel/create",t,{errHint:!1})},excelAppend:function(t){return i.post("/api/excel/append",t,{errHint:!1})},excelReplace:function(t){return i.post("/api/excel/replace",t,{errHint:!1})},excelHistoryReplace:function(t){return i.post("/api/excel/replace_one",t,{errHint:!1})},excelDelete:function(t){return i.get("/api/excel/delete",t,{errHint:!1})},startTask:function(e,i){return t.post("/api/dstb/start",{job_id:e,sheet_name:angular.toJson(i)})},excelCheck:function(t){return i.post("/api/excel/check",t,{errHint:!1})},excelModify:function(t){return i.post("/api/excel/modify",t,{errHint:!1})},subOwnWbList:function(t){return i.post("/api/folder/sub_own_list",t)},extractTb:function(t){return i.post("/api/tb/extract",t)},shareTbInfo:function(t){return i.post("/api/tb/share_info",t)},uploadPreview:function(t,e){return i.post("/api/excel/preview",t,{errHint:e})},uploadParser:function(t){return i.post("/api/excel/parser",t)},getSchema:function(t){return i.post("/api/tb/schema",{tb_id:t})},checkFieldDependency:function(t){return i.post("/api/tb/check_field_dependency",t)},adjustTable:function(t){return i.post("/api/",t)},previewAdjustTable:function(t){return i.post("/api/excel/replace_preview",t)},excelRepeatCheck:function(t){return i.post("/api/excel/title_check",t)}},p={modify:function(t){return i.post("/api/tb/modify",{data:t})},modifyFieldStatus:function(t,e){return i.post("/api/tb/field_selected/modify",{tb_id:t,field_ids:e})},getStatusData:function(t){return i.post("/api/tb/field_selected/query",{tb_id:t})},getList:function(){return i.get("/api/tb/list").then(a)},copy:function(t){return i.post("/api/data_union/union_copy",t)},getInfo:function(t){return i.get("/api/tb/info",{tb_id:t})},getMultiInfo:function(t){return i.get("/api/tb/multi_info",t)},preview:function(t,e,n,r){return-1===e&&null!=n?i.post("/api/tb/preview",{tb_id:t,where:angular.toJson(n.where),where_linker:n.where_linker,sort:angular.toJson(n.sort),fields:angular.toJson(r)}).then(a):e?i.post("/api/tb/preview",{tb_id:t,ws_id:e}).then(a):i.post("/api/tb/preview",{tb_id:t}).then(a)},filedPreview:function(t,e){return i.get("/api/tb/preview",{tb_id:t,fields:e})},del:function(t){return i.post("/api/tb/delete",{tb_id:t})},delTableWithChart:function(t,e,n){return i.post("/api/tb/delete",{tb_id:t,session_id:e,verify_code:n})},getJoinInfo:function(t){return i.get("/api/tb/join_info",{tb_id:t}).then(a)},getJoinErrorReport:function(t){return i.post("/api/wb/profile",t)},getJoinProfileReport:function(t){return i.post("/api/wb/profile_report",{tb_id:t})},getModelStruct:function(t){return i.get("/api/tb/model_struct",{tb_id:t})},getStatus:function(t,e){return i.get("/api/tb/status",{tb_id:t,view_status_read:e})},getStorageAccount:function(){return i.get("/api/tb/stat").then(a)},modifyTag:function(t){return i.post("/api/tb/modify_tag",{data:JSON.stringify(t)})},getTbsField:function(t){return i.post("/api/dstb/infos",t)},partitionSet:function(t){return i.post("/api/tb/partition/set",{tb_id:t.tb_id,base_field:t.base_field,param:t.param})},partitionDel:function(t){return i.post("/api/tb/partition/remove",{tb_id:t.tb_id})},wholeJoinChain:function(t){return i.post("/api/tb/whole_join_chain",{tb_id:t.tb_id})},sqlTrans:function(t){return i.post("/api/tb/sql_trans",t)},sqlScript:function(t){return i.post("/api/sql_script/check",t)},sqlFormat:function(t){return i.post("/api/sql_script/format",t)},tableFieldFilter:function(t){return i.post("/api/field/filter",t)},batchMove:function(t){return i.post("/api/folder/change_batch",t)},batchDeleteTables:function(t){return i.post("/api/tb/delete_batch",t)},checkTablesRely:function(t){return i.post("/api/tb/list_check_rely",t)},gisTransfer:function(t){return i.post("/api/gis/transfer",t)},gisModify:function(t){return i.post("/api/gis/modify",t)},updateModeCheck:function(t){return i.post("/api/tb/update_mode/check",t)},updateModeModify:function(t){return i.post("/api/tb/update_mode/modify",t)},triggerFullUpdate:function(t){return i.post("/api/tb/update",t)},replaceCheck:function(t){return i.post("/api/wb/replace_check",t)},getTplExcel:function(t){return i.get("/api/personal/tpl_excel",t)},tplExport:function(t){return i.get("/api/personal/export",t)}},s={getList:function(t){return i.get("/api/tb/info",{tb_id:t})},getEditableSchema:function(t){return i.get("/api/tb/editable_schema",{tb_id:t})},create:function(t){return i.post("/api/field/create",t)},modify:function(t){return i.post("/api/field/modify",t)},del:function(t,e){return i.post("/api/field/delete",{tb_id:e,fid:t})},getRange:function(t,e,n){return i.post("/api/field/range",{fid:e,ct_id:n,tb_id:t})},getFilteredRange:function(t,e,n,r){return void 0===r?i.post("/api/enum_color/field_range",{ct_id:t,tb_id:e,field:angular.toJson(n)}):i.post("/api/enum_color/gis_field_range",{ct_id:t,tb_id:e,field:angular.toJson(n),layer_level:r})},url_preview:function(t,e){return i.post("/api/field/url_preview",{tb_id:t,field_ids:angular.toJson(e)}).then(a)},extract_preview:function(t,e){return i.post("/api/field/extract_preview",{tb_id:t,fields:angular.toJson(e)}).then(a)},extract_url:function(t,e){return i.post("/api/field/extract_url",{tb_id:t,fields:angular.toJson(e)}).then(a)},merge:function(t,e){return i.post("/api/field/merge",{tb_id:t,info:angular.toJson(e)}).then(a)}},d={allList:function(t){var e={};return e=angular.extend(t,e),i.get("/api/share/all_list",e)},getList:function(t){var e={};return e=angular.extend(t,e),i.get("/api/share/list",e)},share:function(t){var e={};return e=angular.extend(t,e),i.get("/api/share/commit",e)},modify:function(t){return i.post("/api/share/modify",t)}},c={getConnStatus:function(t){return i.post("/api/ds/conn",t)},connNopwd:function(t){return i.post("/api/ds/nopawd",t)},createApi:function(t){return i.post("/api/ds/create",t)},getNameAndTag:function(){return i.get("/api/ds/list").then(a)},getList:function(){return i.get("/api/ds/list").then(a)},getListForDataSource:function(t){return i.get("/api/ds/nslist",t)},getTree:function(){return i.get("/api/ds/tree").then(a)},info:function(t){return i.get("/api/ds/info",t)},modify:function(t){return t=t||{},i.post("/api/ds/modify",t)},startSyncTask:function(t,e,n){return i.get("/api/ds/sync",{ds_id:t,new_table:e,db_type:n})},startBaiduSyncCost:function(t){return i.get("/api/rtapi/single_cost",{ds_id:t})},del:function(t){return i.post("/api/ds/delete",{ds_id:t})},getInitInfo:function(){return i.get("/api/ds/all")},getResultForSearch:function(t,e){return i.get("api/ds/search",{stype:e,content:t})},getTables:function(e){return t.get("/api/ds/mdstb",{params:{ds_id:e}})},getJsjTables:function(e){return t.post("/api/ds/cdstb",e)},modifytb:function(e,i,n){return t.get("/api/ds/modifytb",{params:{ds_id:e,name:i,check_tables:angular.toJson(n)}})},openDataList:function(){return i.get("/api/ds/publiclist")},create:function(t){return i.post("/api/ds/create",t)},conn:function(t){return i.post("/api/ds/conn",t)},tbList:function(){return i.get("/api/ds/tblist")},username_verify:function(t){return i.post("/api/ds/verify",t)},jyw_klist:function(){return i.post("/api/jyw/klist")},set_sync:function(t){return i.post("/api/ds/sync",t)},mobile_default_bind:function(t){return i.post("/api/sms/defaultbind",t)},mobile_unbind_all:function(t){return i.post("/api/sms/unbindall",t)},warn_mobile_list:function(){return i.post("/api/sms/list")},warn_mobile_del:function(t){return i.post("/api/sms/delete",{phone:t.phone})},warn_mobile_vcode:function(t){return i.post("/api/sms/vcode",{phone:t.phone,new_phone:t.new_phone})},warn_mobile_verify:function(t){return i.post("/api/sms/verify",{phone:t.phone,new_phone:t.new_phone,vcode:t.vcode})},ds_amount:function(){return i.get("/api/ds/stat")},kstList:function(t){return i.post("/api/kst/list",t)},kstConn:function(t){return i.post("/api/kst/conn",t)},kstCreate:function(t){return i.post("/api/kst/create",t)},kstInfo:function(t){return i.post("/api/kst/info",t)},kstModify:function(t){return i.post("/api/kst/modify",t)},baiduRegion:function(){return i.get("/api/rtapi/city")},baiduIndex:function(){return i.get("/api/inapi/city")},baiduIndexCheckKeyWords:function(t){return i.post("/api/inapi/check",t)},modifyDbBaiduSearchTask:function(t){return i.post("/api/rtapi/control",t)},modifyDbBaiduIndexTask:function(t){return i.post("/api/inapi/control",t)},baiduSearchConfig:function(t){return i.post("/api/rtapi/config",t)},baiduIndexConfig:function(t){return i.post("/api/inapi/config",t)},modifyDbBaiduSearch:function(t){return i.post("/api/rtapi/modify",t)},modifyDbBaiduIndex:function(t){return i.post("/api/inapi/modify",t)},createDbBaiduSearch:function(t){return i.post("/api/ds/create",t)},createDbBaiduSearchTask:function(t){return i.post("/api/rtapi/create",t)},createDbBaiduIndexTask:function(t){return i.post("/api/inapi/create",t)},deleteDbBaiduSearchTask:function(t){return i.post("/api/rtapi/delete",t)},deleteDbBaiduIndexTask:function(t){return i.post("/api/inapi/delete",t)},getDbBaiduSearchTaskList:function(t){return i.post("/api/rtapi/rtlist",t)},getDbBaiduIndexTaskList:function(t){return i.post("/api/inapi/inlist",t)},startBaiduTaskSyncCost:function(t){return i.get("/api/rtapi/single_cost",t)},startBaiduIndexTaskSyncCost:function(t){return i.get("/api/inapi/single_cost",t)},startBaiduSyncTask:function(t){return i.post("/api/rtapi/sync",t)},startBaiduIndexSyncTask:function(t){return i.post("/api/inapi/sync",t)},baiduCompanySetting:function(t){return i.post("/api/rtapi/field_info",t)},modifyCompanySetting:function(t){return i.post("/api/rtapi/field_modify",t)},dbTypeInfo:function(t){return i.get("/api/ds/category",t)},getCTableList:function(t){return i.post("/api/ds/cdstb",t)},getTbInfo:function(t){return i.post("/api/ds/tbinfo",t)},getDsSheet:function(t){return i.post("/api/ds/sheet",t)},getDsTask:function(t){return i.post("/api/ds/task",t)},"delete":function(t){return i.post("/api/ds/delete",t)},getGaReports:function(t){return i.get("/api/ga/dreports",t)},getGaInfo:function(t){return i.get("/api/ga/info",t)},previewGa:function(t){return i.post("/api/ga/preview",t)},pwdBatchPreview:function(t){return i.post("/api/ds_batch/preview",t)},pwdBatchModify:function(t){return i.post("/api/ds_batch/modify",t)},getJumpInfo:function(t){return i.get("/api/chart/jump_info",t)},saveJumpInfo:function(t){return i.post("/api/chart/jump_save",t)},delJumpInfo:function(t){return i.post("/api/chart/jump_delete",t)},checkJumpInfo:function(t){return i.get("/api/chart/jump_check",t)}},f={field_list:function(t){return i.post("/api/ds_field/field_list",t)},field_del:function(t){return i.post("/api/ds_field/field_del",t)},field_modify:function(t){return i.post("/api/ds_field/field_modify",t)}},l={del:function(t){return i.post("/api/adv_date/del",{opt_id:t})},global_del:function(t,e){return i.post("/api/adv_date/del",{opt_id:t,df_id:e})},modify:function(t,e,n){return i.post("/api/adv_date/modify",{ct_id:t,opt_id:e,data:n})},global_modify:function(t,e,n,r){return i.post("/api/adv_date/modify",{dsh_id:t,opt_id:e,df_id:n,data:r})},list:function(t){return i.post("/api/adv_date/list",{ct_id:t})},info:function(t){return i.post("/api/adv_date/info",{opt_id:t})},order:function(t,e){return i.post("/api/adv_date/order",{ct_id:t,options:e})}},_={add:function(t){return i.get("/api/warn/add",{ct_id:t.ct_id,rule_id:t.rule_id,data:t.data})},modify:function(t){return i.get("/api/warn/modify",{ct_id:t.ct_id,rule_id:t.rule_id,data:t.data,warn_id:t.warn_id})},del:function(t){return i.get("/api/warn/delete",{ct_id:t.ct_id,rule_id:t.rule_id,warn_id:t.warn_id})},warnSwitch:function(t){return i.get("/api/warn/switch",{ct_id:t.ct_id,rule_id:t.rule_id,open_warn_ids:t.open_warn_ids,off_warn_ids:t.off_warn_ids})}},g={modify:function(t){return i.post("/api/model/modify",t)},preview:function(t){return i.post("/api/model/train_set_preview",t)},result:function(t){return i.post("/api/model/result",t)},list:function(t){return i.post("/api/model/list",t)},info:function(t){return i.post("/api/model/info",t)},del:function(t){return i.post("/api/model/delete",t)},saveClusterRs:function(t){return i.post("/api/model/result_commit",t)}},m={getList:function(){return i.get("/api/folder/list").then(a)},del:function(t,e){return i.get("/api/folder/delete",{folder_id:t,mode:e})},modify:function(t){return i.post("/api/folder/modify",t)},create:function(t){return i.post("/api/folder/create",t)},change:function(t){return i.get("/api/folder/change",{tb_id:t.tb_id,to_folder:t.to_folder,to_seq:t.to_seq,tb_index:t.tb_index})},change_batch:function(t){return i.post("/api/folder/change_batch",{change_folders:t})},modify_folder_rel:function(t){return i.post("/api/folder/modify_folder_rel",{tb_id:t.tb_id,folder_rels:t.tb_status})},modify_seq:function(t){return i.post("/api/folder/modify_seq",{seq_no:t.seq_no,folder_id:t.folder_id})},modify_parent:function(t){return i.post("/api/folder/modify_parent",{seq_no:t.seq_no,folder_id:t.folder_id,parent_id:t.parent_id})},getStructure:function(){return i.post("/api/folder/get_tree")},getStructureWithTableList:function(t){return i.post("/api/folder/get_tree_with_tblist",t)},getWorktable:function(t){return i.get("/api/folder/list_only_tb",t)},getTableSiblings:function(t){return i.get("/api/folder/get_current_tb",t)},searchFolderAndTable:function(t){return i.get("/api/folder/filter",t)}},b={create:function(t){return i.get("/api/field_comment/create",t)},modify:function(t){return i.get("/api/field_comment/modify",{ct_id:t.ct_id,fc_id:t.fc_id,comment:t.comment})},del:function(t,e){return i.get("/api/field_comment/delete",{ct_id:t,fc_id:e})}},h={list:function(t){return i.post("/api/dsh_filter/list",{dsh_id:t.dash_id,rule_id:t.rule_id})},modify:function(t){return i.post("/api/dsh_filter/commit",{dsh_id:t.dash_id,data:t.dash_filter_list})},item:function(t){return i.post("/api/dsh_filter/item",{dsh_id:t.dash_id,sdo_id:t.sdo_id,rule_id:t.rule_id,is_tpl:t.is_tpl})},range:function(t){return i.post("/api/dsh_filter/range",{dsh_id:t.dash_id,df_id:t.df_id,rule_id:t.rule_id,selected_tables:t.selected_tables,granularity:t.granularity,parent_range:t.range})}},y={userList:function(t){return i.post("/api/sub/list",t)},modifyPersonal:function(t){return i.get("/api/user/modify_personal",t)},modifyInfo:function(t){return i.get("/api/user/modify_info",t)},groupList:function(t){return i.post("/api/group/list",t)},modify:function(t){return i.post("/api/sub/modify",t)},setFrozen:function(t){return i.post("/api/user/set_frozen",t)},exportFileList:function(t){return i.post("/api/export/file_list",t)},hideNotification:function(){return i.post("/api/export/hide_notification")},logout:function(t){return i.post("/api/user/logout",t)},modifyPassword:function(t){return i.post("/api/user/modify_pwd",t)},getUserInfo:function(){return i.post("/api/user/info")},unreadNewFeatures:function(){return i.post("/api/log/unread")},readNewFeatures:function(){return i.get("/api/log/read")},getMobileCode:function(t){return i.post("/api/user/gen_captcha",t)}},w={getOrderInfo:function(t,e){return i.get("/api/enum_order/info",{_t:(new Date).getTime(),tb_id:t,fid:e}).then(a)},updateOrder:function(t){return i.post("/api/enum_order/update",t)}},v={preview:function(t){return i.post("/api/sql_script/preview",{info:angular.toJson(t)},{errHint:!1})},create:function(t,e,n){return i.post("/api/sql_script/create",{folder_id:n,info:angular.toJson({table_name:t,info:e})})},modifyPreview:function(t,e,n,r){return i.post("/api/sql_script/modify_preview",{tb_id:n,tb_name:t,info:e,folder_id:r})},modify:function(t,e,n){return i.post("/api/sql_script/modify",{tb_id:n,info:angular.toJson({table_name:t,info:e})})}},k={ruleTbInfo:function(t){return i.post("/api/tb/rule_tb_info",t)},getFieldRule:function(t){return i.post("/api/rule/search_filter",t)},saveBatchRule:function(t){return i.post("/api/rule/create_filter_batch",t)},chartList:function(t){return i.post("/api/chart/list",t)},tplCommit:function(t){return i.post("/api/template/commit",t)}},x={tbListPreview:function(t){return i.post("/api/workspace/tb_list_preview",t)},create:function(t){return i.post("/api/workspace/create",t)},"delete":function(t){return i.post("/api/workspace/delete",t)},modify:function(t){return i.post("/api/workspace/modify",t)},info:function(t){return i.post("/api/workspace/info",t)},list:function(){return i.post("/api/workspace/list")},modifyDashList:function(t){return i.post("/api/workspace/modify_dash_list",t)},modifyTableList:function(t){return i.post("/api/workspace/modify_tb_list",t)},modifyGroupList:function(t){return i.post("/api/workspace/modify_group_list",t)},modifyAuthority:function(t){return i.post("/api/workspace/modify_authority_info",t)},userList:function(t){return i.post("/api/workspace/user_list",t)},workspaceLog:function(t){return i.post("/api/workspace/ws_log",t)}},T={list:function(t){return i.post("/api/sem/list",{ds_id:t.ds_id,ds_type:t.ds_type})},merge:function(t){return i.post("/api/sem/merge",{link_list:t.link_list})},tbrefer:function(t){return i.post("/api/sem/tbrefer",{ds_id:t.ds_id,tmp_ds_id:t.tmp_ds_id})}},j={guideSet:function(t){return i.post("/api/user/guide_set",t)}},J={getListByType:function(t){return i.post("/api/message/list",t)},setNoticeReaded:function(t){return i.post("/api/message/read",t)},getNoticeType:function(){return i.post("/api/message/purpose")}},S={info:function(t){return i.post("/api/auth/info",t)},create:function(t){return i.post("/api/auth/create",t)},modify:function(t){return i.post("/api/auth/modify",t)},stop:function(t){return i.post("/api/auth/stop",t)},oplog:function(t){return i.post("/api/auth/oplog",t)}},L={info:function(t){return i.post("/api/chart_tpl/info",{tpl_id:t})},createChart:function(t){var e={dsh_id:t.dsh_id,tb_id:t.tb_id,tpl_id:t.tpl_id,used_origin_fids_map:angular.toJson(t.used_origin_fids_map),dsh_meta:angular.toJson(t.dsh_meta)};return i.post("/api/chart_tpl_apply/create",e)},create:function(t){var e={proj_id:t.proj_id,ct_id:t.ct_id,name:t.name,type:t.type,explain:t.explain};return e.fid_explain=angular.isArray(t.fid_explain)?angular.toJson(t.fid_explain):t.fid_explain,i.post("/api/chart_tpl/create",e)},"delete":function(t){return i.post("/api/chart_tpl/delete",{tpl_id:t})},modify:function(t){var e={tpl_id:t.tpl_id,proj_id:t.proj_id,ct_id:t.ct_id,name:t.name,type:t.type,explain:t.explain};return e.fid_explain=angular.isArray(t.fid_explain)?angular.toJson(t.fid_explain):t.fid_explain,i.post("/api/chart_tpl/modify",e)},applyList:function(t){var e={type:t.type};return i.post("/api/chart_tpl_apply/list",e)},typeList:function(t){return i.post("/api/chart_tpl/type_list",t)}},I={getTree:function(t){return i.post("/api/chart_tpl_proj/tree",t)},create:function(t){return i.post("/api/chart_tpl_proj/create",{name:t})},modify:function(t,e){return i.post("/api/chart_tpl_proj/modify",{proj_id:t,name:e})},del:function(t){return i.post("/api/chart_tpl_proj/delete",{proj_id:t})},order:function(t,e,n){return i.post("/api/chart_template/order",{proj_id:t,type:e||0,sort:angular.toJson(n)})},move:function(t,e,n,r){return i.post("/api/chart_template/move",{dsh_id:r,proj_id:t,type:e,sort:angular.toJson(n)})}},D={info:function(t){return i.get("/api/chart_tpl_rule/info",{rule_id:t})},industryList:function(t){return i.get("/api/industry/list",t)},domainList:function(t){return i.get("/api/domain/list",t)},domainSearch:function(t){return i.get("/api/domain/search",t)},create:function(t){return i.post("/api/chart_tpl_rule/create",t)},list:function(t){return i.post("/api/chart_tpl_rule/list",t)},"delete":function(t){return i.post("/api/chart_tpl_rule/delete",{rule_id:t})},modify:function(t){return i.post("/api/chart_tpl_rule/modify",t)},issued:function(t){var e={rule_id:t.rule_id,issued_status:t.issued_status};return i.post("/api/chart_tpl_rule/issued",e)}},C={personalVipInfo:function(){return i.post("/api/pay/personal_vip_info")},personalOrderHistory:function(){return i.get("/api/pay/order_history")}};return{global_config:n,project:r,dashboard:o,chart:chart,db:u,tb:p,field:s,fieldComment:b,ds:c,ds_field:f,share:d,adv_date:l,warn:_,model:g,folder:m,enumField:w,tpl:k,sql_script:v,dash_global_filter:h,workspace:x,user:y,sem:T,guide:j,authority:S,chart_tpl:L,chart_tpl_project:I,chartTplRule:D,pay:C,notice:J,getJobStatus:function(t){return i.post("/api/job/status",{job_id:t})},getTaskStatus:function(t){return i.get("/api/task/status",{task_id:t},{errHint:!1})},getFunctionList:function(){return i.get("/api/function/list")}}}]).service("baService",["$http","errHint","commonHttp",function(t,e,i){return{list:function(t){return i.post("/api/sta/list",t)},addDomain:function(t){return i.post("/api/sta/add",t)},delDomain:function(t){return i.post("/api/sta/del",t)},updateConfig:function(t){return i.post("/api/sta/update",t)},checkDeploy:function(t){return i.post("/api/sta/ref",t)},getToken:function(t){return i.post("/api/sta/token",t)}}}])}();
;angular.module("BC.services").factory("$jsTipTranslate",["$rootScope","$translate",function(n,t){return function(o,a){function r(){t(o).then(function(n){angular.forEach(n,function(n,t){a.tips[t]=n})})}a.tips=a.tips||{};var c=n.$on("$translateChangeSuccess",r);a.$on("$destroy",function(){c()}),r()}}]);
;angular.module("BC.services").value("operatorTranslateIds",["equal","notEqual","greatThen","lessThen","GTE","LTE","contain","notContain","isEmpty","isNotEmpty","selectDateRange"]).factory("filterOperatorMap",["$rootScope","$translate","operatorTranslateIds",function(e,a,t){function n(){s.length=0,a(t).then(function(e){t.forEach(function(a){s.push(e[a])})})}var s=[];return n(),e.$on("$translateChangeSuccess",n),s}]).factory("filterOperatorMapWithType",["$rootScope","$translate","operatorTranslateIds",function(e,a,t){function n(){a(t).then(function(e){r.string=[],r.number=[],r.date=[],s.forEach(function(a){var n=t[a];r.string.push({value:a,name:e[n]})}),p.forEach(function(a){var n=t[a];r.number.push({value:a,name:e[n]})}),o.forEach(function(a){var n=t[a];r.date.push({value:a,name:e[n]})})})}var s=[0,1,6,7,8,9],p=[0,1,2,3,4,5,8,9],o=[0,1,2,3,4,5,8,9,10],r={};return n(),e.$on("$translateChangeSuccess",n),r}]).factory("dsStatusMap",["$rootScope","$translate",function(e,a){function t(){a(n).then(function(e){o.statusMap.length=0,o.updateStatusMap.length=0,s.forEach(function(a){o.statusMap.push(e[a])}),p.forEach(function(a){o.updateStatusMap.push(e[a])})})}var n=["ds.status.normal","ds.status.disconnect","ds.status.updating","ds.updateStatus.fail","ds.updateStatus.updating"],s=[n[0],n[0],n[1],n[2]],p=[n[0],n[0],n[3],n[4]],o={statusMap:[],updateStatusMap:[]};return t(),e.$on("$translateChangeSuccess",t),o}]).factory("conditionType",["$rootScope","$translate",function(e,a){function t(){a(s).then(function(e){n.length=0,n.push({value:0,text:e[s[0]]}),n.push({value:1,text:e[s[1]]})})}var n=[],s=["tableFilter.andType","tableFilter.orType"];return t(),e.$on("$translateChangeSuccess",t),n}]).factory("dataTypeList",["$rootScope","$translate",function(e,a){function t(){a(s).then(function(e){n.length=0,s.forEach(function(a){n.push({value:a,text:e[a]})})})}var n=[],s=["string","number","date"];return t(),e.$on("$translateChangeSuccess",t),n}]).factory("dataTypeMap",["$rootScope","$translate",function(e,a){function t(){a(s).then(function(e){s.forEach(function(a){n[a]=e[a]})})}var n={},s=["string","number","date"];return t(),e.$on("$translateChangeSuccess",t),n}]).factory("alphaOrderType",["$rootScope","$translate",function(e,a){function t(){a(s).then(function(e){n.length=0,s.forEach(function(a){n.push({value:a,text:e[a]})})})}var n=[],s=["ascending","descending"];return t(),e.$on("$translateChangeSuccess",t),n}]).factory("chartLineType",["$rootScope","$translate",function(e,a){function t(){a(s).then(function(e){n.length=0,n.push({type:"constant",name:e[s[0]]}),n.push({type:"calculate",name:e[s[1]]})})}var n=[],s=["chart.constantValue","chart.calculateValue"];return t(),e.$on("$translateChangeSuccess",t),n}]).factory("$getCustomFormula",["$rootScope","$translate",function(e,a){function t(t){function n(){a(t).then(function(e){s.length=0,t.forEach(function(a){s.push({type:a,name:e[a]})})})}var s=[];return n(),e.$on("$translateChangeSuccess",n),s}return t}]).factory("formulaKeyMap",["$rootScope","$translate",function(e,a){function t(){a(s).then(function(e){s.forEach(function(a){n[a]=e[a]})})}var n={},s=["TOTAL","SUM","AVERAGE","AVG","MIN","MAX","COUNT","COUNT_DISTINCT","YoY","QoQ","MED","PERCENT_5","PERCENT_10","PERCENT_25","PERCENT_50","PERCENT_75","PERCENT_90","PERCENT_95","LAST"];return t(),e.$on("$translateChangeSuccess",t),n}]).factory("dateNameMap",["$rootScope","$translate",function(e,a){function t(){a(s).then(function(e){s.forEach(function(a){n[a]=e[a]})})}var n={},s=["day","week","month","quarter","year","hour","minute","second"];return t(),e.$on("$translateChangeSuccess",t),n}]).factory("dataShowTypeMap",["$rootScope","$translate",function(e,a){function t(){a(s).then(function(e){s.forEach(function(a){n[a]=e[a]})})}var n={},s=["chart.byText","chart.byImg"];return t(),e.$on("$translateChangeSuccess",t),n}]).factory("granularityMap",["$rootScope","$translate",function(e,a){function t(){a(s).then(function(e){s.forEach(function(a){n[a]=e[a]})})}var n={},s=["chart.byDay","chart.byWeek","chart.byMonth","chart.byQuarter","chart.byYear","chart.byHour","chart.byMinute","chart.bySecond","normal"];return t(),e.$on("$translateChangeSuccess",t),n}]).factory("AdvfilterOperatorMap",["$rootScope","$translate",function(e,a){function t(){a(n).then(function(e){s.length=0,n.forEach(function(a,t){s.push({value:p[t],name:e[a]})})})}var n=["equal","notEqual","contain","notContain","beginWith","endWith"],s=[],p={0:0,1:1,2:6,3:7,4:10,5:11};return t(),e.$on("$translateChangeSuccess",t),s}]).factory("AdvfilterOperatorNumberMap",["$rootScope","$translate",function(e,a){function t(){a(n).then(function(e){s.length=0,n.forEach(function(a,t){s.push({value:p[t],name:e[a]})})})}var n=["equal","notEqual","greatThen","lessThen","GTE","LTE","between"],s=[],p={0:0,1:1,2:2,3:3,4:4,5:5,6:12};return t(),e.$on("$translateChangeSuccess",t),s}]).factory("AdvfilterOperatorList",["$rootScope","$translate",function(e,a){function t(){a(n).then(function(e){n.forEach(function(a,t){s[p[t]]=e[a]})})}var n=["equal","notEqual","greatThen","lessThen","GTE","LTE","contain","notContain","beginWith","endWith","between"],s={},p={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:10,9:11,10:12};return t(),e.$on("$translateChangeSuccess",t),s}]).factory("warnOperatorMap",["$rootScope","$translate",function(e,a){function t(){a(n).then(function(e){n.forEach(function(a,t){s[p[t]]=e[a]})})}var n=["equal","notEqual","greatThen","GTE","lessThen","LTE","between"],s={},p={0:3,1:4,2:1,3:6,4:2,5:5,6:7};return t(),e.$on("$translateChangeSuccess",t),s}]).factory("numberInnerFilterMap",["$rootScope","$translate",function(e,a){function t(){a(n).then(function(e){s.length=0,n.forEach(function(a,t){s.push({value:p[t],text:e[a]})})})}var n=["all","equal","notEqual","greatThen","GTE","lessThen","LTE","between"],s=[],p={0:-1,1:0,2:1,3:2,4:4,5:3,6:5,7:12};return t(),e.$on("$translateChangeSuccess",t),s}]).factory("conditionTypeVal",["$rootScope","$translate","$jsTipTranslate",function(e,a,t){return t(["template.all","template.any"],e),function(a){return 0==a?e.tips["template.all"]:e.tips["template.any"]}}]).factory("dbTypeMap",["$rootScope",function(e){var a={1:"MySQL",2:"Oracle",3:"MSSQL",4:"OpenDS",5:"Baidu Sem",7:"Sogou Sem",8:"en"==e.language?"4D Pocket":"四次元空间袋",10:"Umeng",11:"360 Sem",12:"Shenma Sem",13:"Shopex",15:"53KF",16:"快商通",18:"en"==e.language?"Baidu ads ranking":"百度推广实况",19:"JinYiWei",21:"百度网盟",22:"SEM数据管理系统",23:"Live800"};return a}]).factory("databaseType",["$rootScope","$translate",function(e,a){function t(){a(n).then(function(e){s.forEach(function(a){a.typeName=a.translateName?e[a.translateName]:a.typeName})})}var n=["dsType.4dPocket","dsType.baiduAdsRank","dsType.baiduSem","dsType.360Sem","dsType.sougouSem","dsType.shenmaSem","dsType.baiduUnion","dsType.youdaoSpread","dsType.toutiaoAds","dsType.baiduAnalytics","dsType.cnzz","dsType.umeng","dsType.baiduBridge","dsType.tq","dsType.53kf","dsType.live800","dsType.chengxintong","dsType.jinyiwei","dsType.kuaishangtong","dsType.shangwutong","dsType.weiboSpread","dsType.tencentSpread","dsType.sougouUnion","ba.bdpAnalysis","dsType.jinshuju","dsType.tencentgdt","dsType.EC","dsType.sougouSmall","dsType.youkuDSP","dsType.md","dsType.CM","dsType.sinaFuyi"];e.$on("$translateChangeSuccess",t);var s=[{dbType:1,typeName:"MySQL",dbLabel:"ds",category:"ds"},{dbType:2,typeName:"Oracle",dbLabel:"ds",category:"ds"},{dbType:3,typeName:"MSSQL",dbLabel:"ds",category:"ds"},{dbType:4,typeName:"OpenDS",dbLabel:"opends",category:"opends"},{dbType:8,typeName:a.instant("dsType.4dPocket"),dbLabel:"public",category:"public",translateName:"dsType.4dPocket"},{dbType:13,typeName:"Shopex",dbLabel:"shopex"},{dbType:18,typeName:a.instant("dsType.baiduAdsRank"),dbLabel:"baiduAds",translateName:"dsType.baiduAdsRank"},{dbType:22,typeName:"SEM数据管理系统",dbLabel:"sem",category:"sem"},{dbType:5,typeName:a.instant("dsType.baiduSem"),dbLabel:"api",category:"api_0",translateName:"dsType.baiduSem"},{dbType:11,typeName:a.instant("dsType.360Sem"),dbLabel:"api",category:"api_1",translateName:"dsType.360Sem"},{dbType:7,typeName:a.instant("dsType.sougouSem"),dbLabel:"api",category:"api_0",translateName:"dsType.sougouSem"},{dbType:39,typeName:a.instant("dsType.sougouSmall"),dbLabel:"api",category:"api_1",tip:"ds.sougouSmallTip",translateName:"dsType.sougouSmall"},{dbType:12,typeName:a.instant("dsType.shenmaSem"),dbLabel:"api",category:"api_1",tip:"ds.ShenmaTip",translateName:"dsType.shenmaSem"},{dbType:21,typeName:a.instant("dsType.baiduUnion"),dbLabel:"api",category:"api_0",tip:"ds.WMTip",translateName:"dsType.baiduUnion"},{dbType:30,typeName:a.instant("dsType.sougouUnion"),dbLabel:"api",category:"api_0",tip:"",translateName:"dsType.sougouUnion"},{dbType:27,typeName:a.instant("dsType.youdaoSpread"),dbLabel:"api",category:"api_1",translateName:"dsType.youdaoSpread"},{dbType:31,typeName:a.instant("dsType.weiboSpread"),dbLabel:"api",category:"api_1",tip:"",translateName:"dsType.weiboSpread"},{dbType:29,typeName:a.instant("dsType.tencentSpread"),dbLabel:"api",category:"api_1",tip:"ds.tencentSpreadTip",syncTip:!0,translateName:"dsType.tencentSpread"},{dbType:36,typeName:a.instant("dsType.tencentgdt"),dbLabel:"api",category:"api_1",tip:"ds.tencentgdtTip",translateName:"dsType.tencentgdt"},{dbType:33,typeName:a.instant("dsType.sinaFuyi"),dbLabel:"api",category:"api_1",tip:"",translateName:"dsType.sinaFuyi"},{dbType:25,typeName:a.instant("dsType.toutiaoAds"),dbLabel:"api",category:"api_1",translateName:"dsType.toutiaoAds"},{dbType:37,typeName:a.instant("dsType.youkuDSP"),dbLabel:"api",category:"api_1",translateName:"dsType.youkuDSP"},{dbType:9,typeName:a.instant("dsType.baiduAnalytics"),dbLabel:"api",category:"api_5",tip:"ds.baiduStatisticsTip",syncTip:!0,translateName:"dsType.baiduAnalytics"},{dbType:24,typeName:a.instant("dsType.cnzz"),dbLabel:"api",category:"api_1",tip:"ds.cnzzTip",syncTip:!0,translateName:"dsType.cnzz"},{dbType:10,typeName:a.instant("dsType.umeng"),dbLabel:"api",category:"api_1",tip:"ds.umengTip",translateName:"dsType.umeng"},{dbType:17,typeName:a.instant("dsType.baiduBridge"),dbLabel:"api",category:"api_1",tip:"ds.baiduBridgeTip",translateName:"dsType.baiduBridge"},{dbType:20,typeName:a.instant("dsType.tq"),dbLabel:"api",category:"api_1",tip:"ds.TQTip",translateName:"dsType.tq"},{dbType:15,typeName:a.instant("dsType.53kf"),dbLabel:"api",category:"api_1",translateName:"dsType.53kf"},{dbType:23,typeName:a.instant("dsType.live800"),dbLabel:"api",category:"api_0",tip:"ds.live800Tip",syncTip:!0,translateName:"dsType.live800"},{dbType:32,typeName:a.instant("dsType.shangwutong"),dbLabel:"api",category:"api_1",tip:"ds.shangwutongTip",translateName:"dsType.shangwutong"},{dbType:28,typeName:a.instant("dsType.chengxintong"),dbLabel:"api",category:"api_1",translateName:"dsType.chengxintong"},{dbType:19,typeName:a.instant("dsType.jinyiwei"),dbLabel:"api",category:"api_3",translateName:"dsType.jinyiwei"},{dbType:16,typeName:a.instant("dsType.kuaishangtong"),dbLabel:"api",category:"api_2",translateName:"dsType.kuaishangtong"},{dbType:34,typeName:a.instant("dsType.jinshuju"),dbLabel:"api",category:"api_1",translateName:"dsType.jinshuju"},{dbType:35,typeName:a.instant("dsType.EC"),dbLabel:"api",category:"api_0",tip:"ds.ECTip",translateName:"dsType.EC"},{dbType:38,typeName:a.instant("dsType.md"),dbLabel:"api",category:"api_1",tip:"ds.mdTip",syncTip:!0,translateName:"dsType.md"},{dbType:41,typeName:a.instant("dsType.CM"),dbLabel:"api",category:"api_1",tip:"ds.CMTip",translateName:"dsType.CM"},{dbType:26,typeName:a.instant("ba.bdpAnalysis"),dbLabel:"ba",category:"",translateName:"ba.bdpAnalysis"}];return s}]).factory("databaseSyncTime",[function(){var e={hourOptions:["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"],minuteOptions:["00","05","10","15","20","25","30","35","40","45","50","55"]};return e}]).factory("dateTimesMap",[function(){var e=[{name:"00",value:"00"},{name:"01",value:"01"},{name:"02",value:"02"},{name:"03",value:"03"},{name:"04",value:"04"},{name:"05",value:"05"},{name:"06",value:"06"},{name:"07",value:"07"},{name:"08",value:"08"},{name:"09",value:"09"},{name:"10",value:"10"},{name:"11",value:"11"},{name:"12",value:"12"},{name:"13",value:"13"},{name:"14",value:"14"},{name:"15",value:"15"},{name:"16",value:"16"},{name:"17",value:"17"},{name:"18",value:"18"},{name:"19",value:"19"},{name:"20",value:"20"},{name:"21",value:"21"},{name:"22",value:"22"},{name:"23",value:"23"},{name:"24",value:"24"}];return e}]).factory("databaseParamTip",[function(){var e={1:{connect:[{key:"host",name:"服务器",desc:"数据库的公网访问地址，如IP、域名等。"},{key:"port",name:"端口",desc:"数据库的公网访问端口号。"},{key:"username",name:"用户名",desc:"数据库的公网访问用户名"},{key:"password",name:"密码",desc:"数据库的公网访问密码"},{key:"database",name:"数据库",desc:"目标数据库名称"}]}};return e}]);
;!function(){angular.module("BC.services").service("styleService",[function(){function e(e){var t=document.createElement("link");return t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href",e),t}function t(t,r){for(var l="href",i=document.getElementsByTagName("link"),u=!0,s=i.length-1;s>=0;s--)if(i[s]&&null!=i[s].getAttribute(l)&&i[s].getAttribute(l)===t){var a=e(r);i[s].parentNode.replaceChild(a,i[s]),u=!1}u&&n(r)}function n(t){var n=e(t);console.log(t,n),"undefined"!=typeof n&&document.getElementsByTagName("head")[0].appendChild(n)}function r(e){for(var t="href",n=document.getElementsByTagName("link"),r=n.length-1;r>=0;r--)n[r]&&null!=n[r].getAttribute(t)&&n[r].getAttribute(t)===e&&n[r].parentNode.removeChild(n[r])}return{createCssFile:e,replaceCssFile:t,addCssFile:n,deleteCssFile:r}}])}();
;!function(){angular.module("BC.controllers.project",[]).controller("ProjectController",["$scope","$rootScope","commonService","$location","ngDialog","errHint","$state","$timeout","$jsTipTranslate",function(e,t,i,r,a,d,s,o,l){function n(t,i,r){function a(e,t){for(var a=0,d=e.length;d>a;a++)if(!(e[a].proj_id!=t||i&&e[a].rule_id!=i||r&&e[a].share_user_id!=r))return e[a]}var d=a(e.all_project_list,t);return d}function h(i){if(e.showEmptyDash=0==i.dsh_list.length,t.proj_share=i.is_share,i&&i.dsh_list.length)e.selected.dsh_id=e.selected.dsh_id||i.dash_id||i.dsh_list[0].dsh_id,e.tapDashboard(e.selected.dsh_id,i);else{e.selected.proj_id=i.proj_id,e.selected.rule_id=t.global.rule_id=i.rule_id||"",e.selected.dsh_id=void 0,e.selected.dsh_id_rule_id=void 0;var a="/dash_edit/";t.wsId&&(a="/dash_edit_ws/"+t.wsId+"/"),r.path(a+i.proj_id+"/")}}function c(){function t(t){angular.forEach(t,function(t){var a=t.proj_id+(t.rule_id?"$"+t.rule_id:"");i[a]=t==e.active_proj?1:void 0===r[a]?1:1&r[a]})}var i={},r=localStorage.getItem("project_folding");try{r=angular.fromJson(r)||{}}catch(a){r={}}t(e.all_project_list),e.projFolding=i;var d=$.extend({},r,i);_(d)}function _(e){e=e||{};var t=localStorage.getItem("project_folding");try{t=angular.fromJson(t)||{}}catch(i){t={}}var r=$.extend({},t,e);localStorage.setItem("project_folding",angular.toJson(r))}function p(e){var t={};t.proj_id=e.proj_id,i.dashboard.getList(t).then(function(t){e.dsh_list=t,h(e)})}function u(){if(t.needMobileBind)return!1;var r={};return v&&(r.is_tpl=1),i.project.getTree(r).then(function(i){e.project_list=[],e.project_dsh_label_list=[],e.all_project_list=i.proj,e.showEmptyFolder=0==i.proj.length;var r=JSON.parse(j.getItem(g))||{},a=!1,d=!1;angular.forEach(i.proj,function(t){t.proj_id==r.proj_id&&(a=!0),0!=t.type||1==t.property?(t.is_share=!0,angular.forEach(t.dsh_list,function(e){1==t.type&&(e.share_name=t.share_name),2==t.type&&(e.rule_user=t.rule_user)})):e.project_list.push(t),angular.forEach(t.dsh_list,function(i){i.label&&e.project_dsh_label_list.indexOf(i.label)<0&&e.project_dsh_label_list.push(i.label),1==a&&i.dsh_id==r.dash_id&&(t.dash_id=i.dsh_id,d=t)})});var s;s=e.selected.proj_id?n(e.selected.proj_id,e.selected.rule_id):d||i.proj[0],s&&h(s),setTimeout(function(){bdp.utils.scrollToElement(".project-nav",".project-item.active","top")},10),c(),t.projectLoaded=!0})}function f(t,i,r){var a=0,d=0,s=0,o=0,l=e.all_project_list,n=l.length,h=0;if(i){for(a=0;n>a;a++)if(l[a].proj_id==t){s=a;break}}else for(a=0;n>a;a++)if(l[a].proj_id==t)for(s=a,d=0;d<l[a].dsh_list.len;d++)if(l[a].dsh_list[d]==i){o=d;break}$(".own-project-list > .project-item").each(function(e,t){s>e&&(h+=$(t).height())}),h+=32*o,0==r&&(h=0),scrollToTargetPos($(".project-list"),h)}var j=window.localStorage,m=$.cookie("user_id"),g="__localstorage_key_project"+m+(s.params.wsId||"");e.showEmptyDash=!1,e.showEmptyFolder=!1,e.selected={proj_id:s.params.projId,dsh_id:s.params.dashId,rule_id:s.params.ruleId,ws_id:s.params.wsId},t.needMobileBind=1==$.cookie("need_mobile_bind");var b=r.path(),v=(b.indexOf("dash_edit")>-1,b.indexOf("dash_tpl")>-1);window.isThirdIframe=t.isThirdIframe=b.indexOf("third_iframe")>-1,t.isThirdIframeMobile={type:void 0},t.isThirdIframe&&($("head").append('<meta name="viewport" content="width=device-width, initial-scale=1.0">'),o(function(){bdpChart.helper.isMobile()&&($("head").append('<link rel="stylesheet" type="text/css" href="https://m1.bdp.cn/static/css/mobile-mode_0d39ff8.css"/>'),$("body").addClass("mobile-mode"),e.isThirdIframeMobile.type=!0)},0,!1)),e.show_create_dash_dialog=function(){function t(t,i){return 8!=t.keyCode&&i&&i.length>=20?(d(e.tips["dash.dashboardLabelLimit"]),!1):void 0}function i(t,i){return 8!=t.keyCode&&i&&i.length>=100?(d(e.tips["dash.dashboardCommentLimit"]),!1):void 0}if(e.project_list&&0!=e.project_list.length){var r={save:e.createDashboard,hitExistDashLabel:e.hitExistDashLabel,labelLimit:t,commentLimit:i,proj_id:"",name:"",type:"create"};r.proj_id=e.selected.proj_id?e.selected.proj_id:e.project_list[0].proj_id,a.open({templateUrl:"/static/partials/dialogTemplates/create_dashboard.html",scope:e,className:"ngdialog-theme-default ngdialog-small",data:r})}else d(e.tips["dash.emptyProject"])},e.hitLabelList={show:!1,list:[]},e.hitExistDashTags=function(t){e.hitLabelList.list=[],e.hitLabelList.show=!0,t?angular.forEach(e.project_dsh_label_list,function(t){t.toLowerCase().indexOf(tag.toLowerCase())>=0&&e.hitLabelList.list.push(t)}):e.hitLabelList.list=angular.copy(e.project_dsh_label_list)},e.show_create_proj_dialog=function(){a.open({templateUrl:"/static/partials/dialogTemplates/create_project.html",scope:e,className:"ngdialog-theme-default ngdialog-small"})},e.createProject=function(t,r){if(void 0==t)return void d(e.tips["dash.projectNameRequired"]);var a=e.project_list||[];if(""===t)return void d(e.tips["dash.projectNameRequired"]);for(var s=0,o=a.length;o>s;s++)if(a[s].name==t)return void d(e.tips["dash.duplicateProjectName"]);i.project.create(t).success(function(t){"0"==t.status?(e.selected.proj_id=t.result.proj_id,e.selected.dsh_id="",e.selected.rule_id="",r(),u()):errorHandle(t)})},e.createDashboard=function(t,r){if(t.name.length>100)return void d(e.tips["dash.dashNameLessThan100"]);var a=t.name,s=t.proj_id;if(""===a)return void d(e.tips["dash.dashNameRequired"]);for(var o=null,l=0;l<e.project_list.length;l++)if(e.project_list[l].proj_id==s){o=e.project_list[l];break}if(!o)return void d(e.tips["dash.chooseProj"]);for(var n=o.dsh_list||[],l=0,h=n.length;h>l;l++)if(n[l].name==a)return void d(e.tips["dash.duplicateDashName"]);i.dashboard.create(t).success(function(t){"0"==t.status?(e.selected.proj_id=s,e.selected.dsh_id=t.result.dsh_id,p(o),r()):errorHandle(t)})},e.tapDashboard=function(i,a,d,o){var l=r.path(),n=l.indexOf("dash_edit")>-1,h=l.indexOf("dash_tpl")>-1,c="dash_edit";if(!(n||h||isThirdIframe))return!1;c=n?"dash_edit":"dash_tpl";var _=e.selected.proj_id=a.proj_id;if(e.selected.rule_id=a.rule_id,t.proj_share=a.is_share,t.global.rule_id=a.rule_id?a.rule_id:"",e.selected.dsh_id=i,e.selected.dsh_id_rule_id=a.rule_id?i+a.rule_id:i+"",e.showEmptyDash=0==a.dsh_list.length,o)return void r.url(o);var p=!d&&s.params.df_id?"?df_id="+s.params.df_id+"&range="+s.params.range:"";isThirdIframe?r.path("/third_iframe/"+_+"/"+i+p):r.url(a.rule_id?"/"+c+"/"+_+"/"+i+"/"+a.rule_id+p:s.params.wsId?"/"+c+"_ws/"+s.params.wsId+"/"+_+"/"+i+p:"/"+c+"/"+_+"/"+i+p),"dash_edit"==c&&j.setItem(g,JSON.stringify({proj_id:_,dash_id:i}))},e.tapAllProject=function(t,i){angular.forEach(t,function(t,r){var r=t.proj_id+(t.rule_id?"$"+t.rule_id:"");e.projFolding[r]=i,_(e.projFolding)}),o(function(){f(e.selected.proj_id,e.selected.dsh_id,i)},100)},e.tapProject=function(t,i){var r=t.proj_id+(t.rule_id?"$"+t.rule_id:"");i&&(e.projFolding[r]^=1,_(e.projFolding))},e.getProjectById=n,e.setDashboard=h,e.getTree=u,u(),e.saveFoldingState=_,e.$on("updateProjTree",function(t,i){if(i){e.all_project_list.push(i),e.project_list.push(i);var r=i.proj_id+(i.rule_id?"$"+i.rule_id:"");e.projFolding[r]=0,_(e.projFolding)}}),$("body").on("changeDashboard",function(t,i){e.tapDashboard(i.dshId,i.projInfo,!1,i.url)}),l(["dash.emptyProject","dash.projectNameRequired","dash.duplicateProjectName","dash.dashNameLessThan100","dash.dashNameRequired","dash.duplicateDashName","dash.dashboardLabelLimit","dash.dashboardCommentLimit","dash.chooseProj"],e)}])}();
;!function(){function e(e,a,r,i,d,s,o,l,n,h,c,u,f,p,g,m,_,y){function b(t,a){function i(e){return $.isEmptyObject(e)||"C400"===e.chart_type&&$.isEmptyObject(e.layers)||e.level&&!e.level[0].chart_type}1==a.meta.property||a.meta.ct_id.indexOf("text_")>-1||r.chart.getInfo({ct_id:a.meta.ct_id,ws_id:e.wsId}).success(function(d){"0"==d.status?i(d.result.meta)&&(e.chartdel["chart"+a.meta.ct_id]=!0,e.dashStandardItems.splice(t,1),r.chart.del({ct_id:a.meta.ct_id,ws_id:e.wsId,dsh_meta:{charts:M(e.dashStandardItems,!0)}}).success(function(t){0==t.status||h(e.tips["dash.delChartFail"])})):h(Number(d.status))})}function v(t){e.hitMemoryGlobalFilter=!1,e.hitGlobalFilterId=[],e.global.globalDashFilter=[],r.dash_global_filter.item({dash_id:t,rule_id:a.global.rule_id||""}).then(function(a){if("0"==a.status){if(e.selected.dsh_id!==t)return;e.global.originalGlobalFilter=angular.copy(a.result);var r=bdp.utils.handleGlobalFilterLevel(a.result),i=l.df_id,d=l.range;if(angular.forEach(r,function(e){if(i==e.df_id?w(d,e):I(e),"date"==e.data_type&&""==e.config.granularity){var t=e.config.range||"";if(t){var a=!1;angular.forEach(e.adv_date_list,function(e){e.opt_id==t&&(a=!0)}),a||(e.config.range="",e.config.default_select=!1,e.range=[])}}}),e.global.globalDashFilter=r,e.global.globalDashFilter.length?$(".gridster").removeClass("gridster-nofilters"):$(".gridster").addClass("gridster-nofilters"),e.hitMemoryGlobalFilter||e.hitJumpGlobalFilter)var s=e.$watch("global.dashboardLoaded",function(t,a){t===!0&&(a!==!0||void 0!==e.draw_chart_url)&&(e.$broadcast("useMemoryGlobalFilter",!0),s())})}else h(Number(a.status))})}function w(t,a){if("date"==a.data_type&&""==a.config.granularity)for(var r=0,i=a.adv_date_list.length;i>r;r++){var d=a.adv_date_list[r];a.range[0]=d.name==t?d.opt_id:t}else a.range[0]=t;e.hitJumpGlobalFilter=!0}function I(t){var r="global_filter_memory",i=angular.fromJson(window.localStorage.getItem(r))||[],d=!1,s=a.wsId||"";angular.forEach(i,function(a){a.ws_id==s&&t.data_type==a.data_type&&t.name==a.name&&t.config&&t.config.hasOwnProperty("granularity")&&t.config.granularity==a.granularity&&("date"==t.data_type&&""==t.config.granularity?angular.forEach(t.adv_date_list,function(e){e.opt_id==a.range[0]&&(t.range=a.range,d=!0)}):(t.range=a.range,t.range_type=a.range_type),e.hitMemoryGlobalFilter=!0,e.hitGlobalFilterId.push(t.df_id))})}function C(){var t=a.global.dshWatermarkImg,r="none";if(t){var i=$(".gridster"),d="dash-water-mark",s=1==a.usedThemeId?"water-mark-white":"water-mark-dark";if(e.isFullscreenMode&&(s=1===e.fullDisplayTheme?"water-mark-white":"water-mark-dark"),e.dashLayoutInfo.show_block)bdp.utils.browser().ie?i.addClass(s):$("."+d).remove();else if(r="url("+t+")",bdp.utils.browser().ie)i.addClass(s);else if(0==$("."+d).length){var o=document.createElement("div");o.className="water-mark "+d+" "+s,i.append(o)}else $("."+d).removeClass("water-mark-white").removeClass("water-mark-white").addClass(s)}}function T(){var e=angular.element(".dash-title-wrap .dash-title");if(e){i(function(){var t=angular.element(".dash-title-wrap .btn-layer");t&&angular.element(".dash-title-wrap .dash-title h2").css({width:e.width()-t.width()-32+"px"})},0);var t=oldWidth=document.documentElement.clientWidth||document.body.clientWidth;$(window).resize(function(){var e=angular.element(".dash-title-wrap .dash-title"),a=angular.element(".dash-title-wrap .btn-layer");t=document.documentElement.clientWidth||document.body.clientWidth,a.length>0&&Math.abs(t-oldWidth)>30&&(angular.element(".dash-title-wrap .dash-title h2").css({width:e.width()-a.width()-32+"px"}),oldWidth=t)})}}function D(e){return localforage.getItem("CACHE_DASH_ID").then(function(t){t!=e.dsh_id&&localforage.setItem("CACHE_DASH_ID",e.dsh_id)}),localforage.getItem("CACHE_DASH_DATA")}function L(t,r){a.dashLoading=!1;var d=r.result;if(!isObjectEmpty(d)){a.dashProperty=d.property,e.outer_share_info=d.outer_share_info,e.gis_flag=d.gis_flag,e.isTpl=d.is_template||0,e.dashTbId=e.isTpl&&d&&d.tb_ids?d.tb_ids[0]:"",e.dashLayoutInfo.show_block=defined(d.meta.show_block)?d.meta.show_block:!0,e.dashLayoutInfo.fixed_width=defined(d.meta.fixed_width)?d.meta.fixed_width:!1,e.dashLayoutInfo.layout_style=defined(d.meta.layout_style)?d.meta.layout_style:1,(a.proj_share||a.global.rule_id)&&(a.dashEditMode=!1),k(e.dashLayoutInfo.show_block,e.dashLayoutInfo.layout_style),e.dashTitle=d.name,e.dashLabel=d.label||"",e.dashComment=d.comment||"",e.property=d.property;var o=d.meta.charts||[];if(e.dashStandardItems=o||[],e.dashStandardItems.sort(function(e,t){return e.row==t.row?e.col-t.col:e.row<t.row?-1:1}),e.isFullscreenMode){var l=($(".main"),$(".dash-wrapper")),n=l.height(),h=9,c=n/h+10;e.dashPages=[],e.gridsterOpts.rowHeight=c,e.gridsterOpts.draggable.enabled=!1,e.gridsterOpts.resizable.enabled=!1;var u=[],f=0,p=0;e.dashStandardItems.forEach(function(t,a){var r=t.children[0].meta,i=r.tb_update_time;r.tb_update_time=1e3*i,t.sizeY=Math.min(t.sizeY,h),t.row+=p,t.row%=h,t.index=a;var d=!0;if(t.row+t.sizeY>h)d=!1;else for(var s=0;s<u.length;s++){var o=u[s];if(!(o.col>=t.col+t.sizeX||o.row>=t.row+t.sizeY||t.col>=o.col+o.sizeX||t.row>=o.row+o.sizeY)){d=!1;break}}d?u.push(t):(p+=h-t.row,e.dashPages.push(u),u=[],f++,t.row=0,u.push(t))}),u.length>0&&e.dashPages.push(u)}e.dashInit.load=!1,e.draw_chart_url={};var g,m;e.chartdel={};for(var _=0;_<e.dashStandardItems.length;_++)e.dashStandardItems[_].children[0].meta.filter_list=[];if(a.creatingChart)return a.creatingChart=!1,S(e.dashStandardItems[e.dashStandardItems.length-1].children[0].meta.type),delete a.creatingChartInfo,e.saveDashboard().then(function(){s.path().indexOf(e.currDash.dashSelected)>=0&&e.getDashboardInfo(e.currDash.dashSelected)}),!1;a.isGlobalCustom={};var y;y=e.isFullscreenMode?1===e.fullDisplayTheme?"dark":"default":1===a.usedThemeId?"dark":"default",window.dashChartsUpdateMap={};for(var v=0;v<o.length;v++){g=o[v];for(var w=0;w<g.children.length;w++)if(m=g.children[w],m.meta.filter_list=[],m.meta.type){window.dashChartsUpdateMap[m.meta.ct_id]=m.meta.tb_update_time+m.meta.update_time;var I="";a.isGlobalCustom[m.meta.ct_id]=!1,e.global.rule_id&&(I="&rule_id="+e.global.rule_id),e.draw_chart_url[m.dom_id]={options:{theme:y,device:e.isFullscreenMode?e.fullDisplayDevice:"pc",ws_id:a.wsId,dsh_id:t,ct_id:m.meta.ct_id,tb_id:m.meta.tb_id,rule_id:a.global.rule_id,read_cache:!0,optional:{linked_chart_type:m.meta.chart_link.linked_chart_type,link_info:m.meta.chart_link.link_info,chart_jump_info:m.meta.chart_jump}},lazyload:!0}}else!e.global.rule_id&&b(v,m)}if(e.global.dashboardLoaded=!0,!a.hasInitDashboard&&O&&window._BDP_TIME_LOGGER&&(BDPLogger.time("performance","loading","first_screen"),a.hasInitDashboard=!0),e.isFullscreenMode&&!e.$$phase&&e.$digest(),C(),2==e.dashLayoutInfo.layout_style){var L=$(".dash-wrapper")[0].scrollHeight;$(".gridster").height(L)}T(),D(d).then(function(t){window.dashChartsCache&&!window.dashChartsCache[d.dsh_id]?(window.dashChartsCache={},window.dashChartsCache[d.dsh_id]=null):(window.dashChartsCache={},window.dashChartsCache[d.dsh_id]=t||null);for(var r=0;r<o.length;r++){g=o[r];for(var s=0;s<g.children.length;s++)m=g.children[s],void 0!==e.draw_chart_url[m.dom_id]&&(e.draw_chart_url[m.dom_id].lazyload=r>2)}i(function(){e.lazy=new bdpChart.LazyLoad(".gridster",".gridster-item",{diff:50,handleResize:!0,onItemLoad:function(t){var a=$(t).find(".item-chart").attr("id");e.draw_chart_url[a]&&(e.draw_chart_url[a].lazyload=!1)},onItemsLoad:function(){e.$$phase||e.$digest()}}),e.$on("$destroy",function(){e.lazy.destroy()});var t=$.cookie("edit_chart_id");e.search_ct_id?setTimeout(function(){e.scrollToChart(e.search_ct_id)},10):t&&(setTimeout(function(){e.$broadcast("scrollToChart",t)},10),$.cookie("edit_chart_id","")),setTimeout(function(){a.wtbRelationSelectedItem&&(e.scrollToChart(a.wtbRelationSelectedItem.ct_id),a.wtbRelationSelectedItem=null)},0),setTimeout(function(){a.warnListSelectedItem&&(e.scrollToChart(a.warnListSelectedItem.ct_id),a.warnListSelectedItem=null)},0)})})}}function S(t){var r=e.dashStandardItems,i=r[r.length-1];switch(t){case"C310":i.sizeX=3,i.sizeY=2;break;case"C230":case"C261":case"C290":i.sizeX=4,i.sizeY=4;break;case"C271":case"C272":case"C330":case"C340":case"C360":case"C370":i.sizeX=6,i.sizeY=6;break;case"C400":i.sizeX=12,i.sizeY=7;break;case"C350":case"C351":case"C352":i.sizeX=6,i.sizeY=4}a.creatingChartInfo&&a.creatingChartInfo.split_compare&&(i.sizeX=12,i.sizeY=6);for(var d,s=r.length,o=0,l=0,n=0;s-1>n;n++)d=r[n],d.row+d.sizeY>o&&(d.col+d.sizeX>12-i.sizeX?(o=Math.max(o,d.row+d.sizeY),l=0):(o=Math.max(o,d.row),l=Math.max(l,d.col+d.sizeX)));i.row=o,i.col=l}function k(t,r){var d=bdpChart.helper.isMobile(),s=a.isThirdIframe;d&&s&&!function(){a.mobileMode=!0;var e=null;$(".gridster").on("click",".chart-box",function(){var t=$(this).find(".item-chart").get(0);return t==e?!1:($(t).addClass("reactive").removeClass("noscroll"),e&&$(e).removeClass("reactive"),e=t,void 0)}),$(document).on("touchmove",".item-chart.reactive",function(){return $(this).find(".chart-table").length>0?!0:!1}),$(document).on("scroll",function(){e&&($(e).removeClass("reactive"),e=null)})}(),e.gridsterOpts={layoutStyle:r,margins:t?d&&s?[8,0]:[8,8]:[0,0],outerMargin:!1,minColumns:2,minRows:2,columns:12,isMobile:d&&s?!0:!1,resizable:{enabled:!a.proj_share&&a.permision.dashOperate,handles:"se",start:function(t,a,r){e._draggingElemBox={width:r.width(),height:r.height()};var i=$(".gridster").height();$(".gridster").css("height",i+100)},resize:function(t,a,r){var i=r.find(".chart").data("chart-data");if(i&&!i.isSplitChart())if(1==e.dashLayoutInfo.layout_style)reflowChart(r);else if(2==e.dashLayoutInfo.layout_style){var d=$(".gridster").width(),s=a.position.left,o=(a.position.top,r.width());s>=d-o&&r.width(d-s)}},stop:function(t,a,r){i(function(){var t=r.find(".chart").data("chart-data");if(t){var a=e._draggingElemBox.width/e._draggingElemBox.height,i=r.width()/r.height(),d=1>a&&i>=1||a>=1&&1>i,s=t.getChartType(),o=d||t.isSplitChart()||s===bdpChart.ChartType.Line&&"dark"===t.theme||s===bdpChart.ChartType.TreeMap;reflowChart(r,!0,o)}},0),1==e.dashLayoutInfo.layout_style?e.saveDashboard():2==e.dashLayoutInfo.layout_style&&(F(),N.save())}},draggable:{enabled:d&&s?!1:!a.proj_share&&a.permision.dashOperate,handle:".chart-box",cancel:".drag-disable",drag:function(t,a,r){if(2==e.dashLayoutInfo.layout_style){var i=$(".gridster").width(),d=a.position.left,s=a.position.top,o=r.width();0>d?a.position.left=0:d>i-o&&(a.position.left=i-o),0>s&&(a.position.top=0)}},stop:function(){e.lazy.fireLoad(),1==e.dashLayoutInfo.layout_style?e.saveDashboard():2==e.dashLayoutInfo.layout_style&&(F(),N.save())}}}}function F(){N.setFreeLayout();var e=N.getBlankPos().top,t=$(".dash-wrapper")[0].scrollHeight;$(".gridster").css("height",Math.min(e,t))}function x(){var t=e.dashLayoutInfo.show_block;e.gridsterOpts.margins=t?[8,8]:[0,0]}function E(t){for(var a,r,i=e.dashStandardItems||[],d=i.length,s=0,o=0,l=0,n=0;d>n;n++){var h=i[n];h.row+h.sizeY>o&&(h.col+h.sizeX>6?(o=h.row+h.sizeY,l=0):(o=h.row,l=h.col+h.sizeX));for(var c=0;c<h.children.length;c++)a=h.children[c],r=parseInt(a.dom_id.substr(2)),s=r>s?r:s}s++;var u={sizeX:6,sizeY:4,row:o,col:l,children:[{dom_id:"id"+s,meta:{name:e.tips["chart.untitledChart"],ct_id:"init_ctid"}}]};if("C101"===t&&(u.sizeX=3,u.sizeY=2,u.children[0].meta.type="C101"),e.dashLayoutInfo&&2==e.dashLayoutInfo.layout_style){N.setFreeLayout();var f=N.getBlankPos();"C101"===t?(u.width=200,u.height=100):(u.width=480,u.height=324),u.left=0,u.top=f.top+10}e.dashStandardItems||(e.dashStandardItems=[]),e.dashStandardItems.push(u)}function M(e,t){var a=angular.copy(e);return angular.forEach(a,function(e){e.children[0].meta={ct_id:e.children[0].meta.ct_id,dash_setting:e.children[0].meta.dash_setting,html:e.children[0].meta.html||""},t||delete e.children[0].meta.dash_setting}),a}function z(){return a.wsId?_.when():r.chart_tpl.typeList().then(function(t){"0"==t.status&&(e.tplTypeList=t.result.tpl_type_list)})}3==a.enterprise_type&&1==$.cookie("show_capacity_overflow")&&(o.open({templateUrl:"/static/partials/dialogTemplates/capacity_overflow.html",className:"ngdialog-theme-default ngDialog-width-320",data:{vipLevel:a.memberData.vipLevel}}),$.cookie("show_capacity_overflow","0"));var O=!1;if(!a.hasInitDashboard&&window._BDP_TIME_LOGGER){O=!0;for(var P=a.historyTime,j=P.length-1;j>=0;j--)P[j].indexOf("dash_edit")<0&&(O=!1);O&&(BDPLogger.time("performance","loading","first_init_dashboard"),BDPLogger.subTime("performance","loading","dashboard_dom_ready",window._BDP_TIME_LOGGER.domReady),BDPLogger.subTime("performance","loading","dashboard_white_screen",window._BDP_TIME_LOGGER.whiteScreen),window._BDP_TIME_LOGGER.onloadPushFlag&&window._BDP_TIME_LOGGER.onload>0&&(BDPLogger.subTime("performance","loading","dashboard_onload",window._BDP_TIME_LOGGER.onload),window._BDP_TIME_LOGGER.onloadPushFlag=!1))}if(e.$on("afterWindowResize",function(){e.getAllChartInstances().forEach(function(e){e.getChartType()===bdpChart.ChartType.Line&&"dark"===e.theme&&(e.destroy(),e.renderChart())})}),e.mouseleaveItem=function(){e.$broadcast("fire-mouseleave-item-event",!0)},e.chartOptions={},a.mainChartContainer=[],a.mainChartIdContainer=[],a.mainChartColorContainer={},e.global.dashboardLoaded=!1,l.projId){e.AllMap=["全部","全部时间","All"],a.last_dash_path=s.path(),e.$on("jumpToSearch",function(t,a){e.search_ct_id=a});var G="_websocketChartMessage_";if(e.$on(G,function(t,a){var r="string"==typeof a.data?$.parseJSON(a.data):a.data;1==r.type&&p.refresh({drawChartUrl:e.draw_chart_url,type:"dashboard",evt:t,scope:e,ret:a})}),e.$on("scrollToChart",function(t,a){setTimeout(function(){e.scrollToChart(a)},0)}),a.$editable=!0,e.currDash={activeProjId:l.projId,dashSelected:l.dashId},e.activeProjId=l.projId,e.dashSelected=l.dashId,e.wsId=a.wsId,a.view="dashboard",a.show_bdp_header=!0,e.dashInit={},e.dashInit.load=!0,l.ruleId)e.global.rule_id=l.ruleId;else{var A=s.path();A.indexOf("ru_")>=0&&(e.global.rule_id=A.substring(A.indexOf("ru_")))}e.selected={proj_id:l.projId,dsh_id:l.dashId,rule_id:e.global.rule_id,ws_id:a.wsId},e.scrollToChart=function(e,t){t=t||$(".gridster-desktop");var a=t.closest(".dash-wrapper");t.find(".gridster-item").each(function(t,r){var i=$(r);if(e==i.data("chart-id")){var d=a.height(),s=i[0].offsetTop;s+i.height()>d?a.animate({scrollTop:s-15},function(){i.addClass("highlight-chart")}):i.addClass("highlight-chart"),$(document).on("click.cancelHighlight",function(){i.removeClass("highlight-chart"),$(this).off("click.cancelHighlight")})}})},localStorage.setItem("mc_location_path",s.path());var A=s.path();A.indexOf("dash_fullscreen")>0?(e.isFullscreenMode=!0,a.view="dash-fullscreen",a.show_bdp_header=!0,e.$dashSlider=$("#dash-slider"),$(document).on("keyup.dash_fullscreen",function(t){switch(t.keyCode){case 37:e.$dashSlider.slick("slickPrev");break;case 39:e.$dashSlider.slick("slickNext");break;case 27:0===$(".fullscreen-chart").length&&e.exitFullScreen()}})):(e.isFullscreenMode=!1,a.view="dashboard",a.show_bdp_header=!0,$(document).off("keyup.dash_fullscreen")),e.dashLayoutInfo={},e.hitMemoryGlobalFilter=!1,e.hitGlobalFilterId=[],e.$on("useMemoryGlobalFilter",function(t,a){if(a){var r=[];angular.forEach(e.global.globalDashFilter,function(t){r.push({df_id:t.df_id,range:t.range,data_type:t.data_type,granularity:t.config.granularity||"",range_type:t.range_type||"1"}),e.hitGlobalFilterId.indexOf(t.df_id)>-1&&(e.global.globalDashFilterItems[t.df_id]={granularity:t.config.granularity||"",df_id:t.df_id,range:t.range,data_type:t.data_type,show_name:t.range,real_name:t.range,rela_charts:t.rela_ct_ids})}),angular.forEach(e.draw_chart_url,function(t){t.global_filter_value=[],angular.forEach(e.global.globalDashFilter,function(e){e.rela_ct_ids.indexOf(t.options.ct_id)>-1&&(t.options.optional.dsh_filter=r,delete t.options.optional.filter_list,t.options.read_cache=!1,t.options.optional._t=new Date)})})}}),e.dashboardAutoplay=!1;var B=null;e.toggleDashboardAutoplay=function(){e.dashboardAutoplay=!e.dashboardAutoplay;var t=e.dashboardAutoplay?"Play":"Pause";e.dashboardAutoplay&&(clearTimeout(B),B=setTimeout(function(){e.dashboardAutoplay&&$("#dash-slider").slick("slickNext")},1e3)),$("#dash-slider").slick("slick"+t)};var R=function(){$(".dash-fullscreen-wrap .page-nav, .dash-fullscreen-wrap .view-header .btn-layer").addClass("invisible"),$(".dash-fullscreen-wrap, .dash-fullscreen-wrap .gridster-item, .dash-fullscreen-wrap .gridster-item .item-chart").addClass("cursor-none")},J=function(){$(".dash-fullscreen-wrap .page-nav, .dash-fullscreen-wrap .view-header .btn-layer").removeClass("invisible"),$(".dash-fullscreen-wrap, .dash-fullscreen-wrap .gridster-item, .dash-fullscreen-wrap .gridster-item .item-chart").removeClass("cursor-none")};if(e.isFullscreenMode){var H=setTimeout(R,5e3);$(".dash-fullscreen-wrap").on("mousemove",function(){null!==H&&(window.clearTimeout(H),H=null,J(),setTimeout(function(){H=setTimeout(R,3e3)},200))})}e.getDashboardInfo=function(t){if(t?v(t):e.global.globalDashFilter=[],a.dashLoading=!0,""==t||"undefined"==typeof t)return a.dashLoading=!1,!1;var i={};return i.dsh_id=t,a.global.rule_id&&(i.rule_id=a.global.rule_id),r.dashboard.getInfo(i).then(function(e){if(0==e.status)if(a.projectLoaded)L(t,e);else var r=setInterval(function(){a.projectLoaded&&(L(t,e),clearInterval(r))},200);else{if(a.dashLoading=!1,3==e.status)return s.path(a.wsId?"/dash_edit_ws/"+a.wsId:"/dash_edit/"),void location.reload();h(e.status)}})},e.getDashboardInfo(e.currDash.dashSelected),e.$on("fire-refresh-dashboard",function(){"dashboard"==a.view&&e.getDashboardInfo(e.currDash.dashSelected)}),e.clearOuterShareInfo=function(){e.outer_share_info={}},e.showThirdIframeDshList=function(){$(".dash-sidebar").addClass("show-list"),$(".dashboard-item").off("click.showThirdIframeDshList").on("click.showThirdIframeDshList",function(){$(".dash-sidebar").removeClass("show-list")})},e.chooseTableOk=function(t,i){function d(){E();var a={dsh_id:e.currDash.dashSelected,tb_id:t,dsh_meta:{charts:M(e.dashStandardItems,!0)}};i&&angular.isFunction(i)?i(a).then(c):r.chart.create(a).then(c)}if(!t)return void h(e.tips["dash.plzSelectTable"]);var l,n,c=function(r){if("0"==r.status){o.closeAll(),$.cookie("grid_index","");var i=r.result.ct_id,d=angular.isArray(t)?"gis_edit":"chart_edit";if(a.creatingChart=!0,n){var c=s.path();l&&(c+=e.activeProjId),n&&(c+=e.currDash.dashSelected),window.setTimeout(function(){window.location.href=window.location.href.replace(s.path(),c.replace("dash_edit",d)+"/"+i),window.location.reload()},100)}o.closeAll(),n||(c=s.path(),c=c.replace("dash_edit",d),s.path(c+"/"+i))}else e.dashStandardItems.pop(),h(+r.status)};if(e.currDash.dashSelected)return d();var u=function(){var t={name:"仪表盘1",proj_id:e.currDash.activeProjId};return r.dashboard.create(t).success(function(t){t=t.data||t,"0"===t.status&&(e.currDash.dashSelected=t.result.dsh_id,e.dashTitle="仪表盘1",n=!0,d())})};void 0==e.currDash.activeProjId?r.project.create("文件夹1").success(function(t){t=t.data||t,"0"===t.status&&(e.currDash.activeProjId=t.result.proj_id,l=!0,u(!0))}):u()},e.filterMergedTable=function(e){return"excel"!==e.type&&"aggr"!==e.type},e.tplTypeList=[],e.addItem=function(){if(e.chooseType=function(t){e.selectedTplType=t;var a={type:t};r.chart_tpl.applyList(a).then(function(t){"0"==t.status&&(e.tplList=t.result.tpl_list,angular.forEach(e.tplList,function(e){u.get("/api/chart/data",{params:{ct_id:e.ct_id,is_chart_tpl:1}}).then(function(t){200==t.status&&0==t.data.status?e.chart_type=t.data.result.info.chart_type:e.error=t.data.errstr})}))})},e.selectedTpl=null,e.chooseTpl=function(t){e.selectedTpl=t},!e.isAdding){e.isAdding=!0,e.active=!1;var a=function(a){var r=o.open({template:"/static/partials/dialogTemplates/chart_select_table.html",className:"ngdialog-theme-default choose-table"+(e.tplTypeList.length?" ngdialog-drawer-open":""),data:{folders:a,choose_table:{tb_id:""}},scope:e,controller:["$scope",function(e){e.tabIndex=0,e.folderList=e.ngDialogData.folders,e.original_folderList=angular.copy(e.ngDialogData.folders),e.$on("recoverFolderList",function(t,a){e.folderList=a}),e.showTab=function(t){e.tabIndex=t,e.tabIndex?$("#"+r.id).removeClass("ngdialog-drawer-open"):e.tplTypeList.length&&($("#"+r.id).addClass("ngdialog-drawer-open"),e.chooseType())},e.confirm=function(){function a(e){angular.forEach(e,function(e){angular.forEach(e.tb_list,function(e){e.check&&r.push(e.tb_id)}),e.sub_folders&&e.sub_folders.length>0&&a(e.sub_folders)})}if(0==e.tabIndex){if(!e.ngDialogData.choose_table.tb_id)return void h(e.tips["dash.plzSelectTable"]);e.selectedTpl?o.open({templateUrl:"/static/chartTemplate/view/ngdialog_match_field.html",scope:e,className:"ngdialog-theme-default chart-tpl-field",controller:t}):e.chooseTableOk(e.ngDialogData.choose_table.tb_id)}else{var r=[];if(a(e.folderList),!r.length)return void h(e.tips["dash.plzSelectTable"]);e.chooseTableOk(r,"gis")}},e.changeChecked=function(t){function a(e){for(var a=0,r=e.length;r>a;a++){e[a].tb_id==t.tb_id&&(e[a].check=t.check);for(var i=0,d=e[a].tb_list.length;d>i;i++)e[a].tb_list[i].tb_id==t.tb_id&&(e[a].tb_list[i].check=t.check)}}a(e.folderList)},e.showTab(0)}]})},i=z();n.get("/api/folder/list_for_chart").then(function(t){e.isAdding=!1,0==t.status&&i["finally"](function(){a(t.result)})})}},e.saveDashboard=function(){if(!e.dashTitle)return void h(e.tips["dash.titleRequired"]);var t={};e.dashLayoutInfo.ct_id&&(t[e.dashLayoutInfo.ct_id]=e.dashLayoutInfo.dash_setting);var a={ws_id:e.wsId,dsh_id:e.currDash.dashSelected,chart_data:angular.toJson(t),data:angular.toJson({name:e.dashTitle,label:e.dashLabel,comment:e.dashComment,meta:{layout_style:e.dashLayoutInfo.layout_style||1,show_block:e.dashLayoutInfo.show_block,fixed_width:e.dashLayoutInfo.fixed_width||!1,charts:M(e.dashStandardItems,!0)}})};return r.dashboard.modify(a).then(function(t){0!==+t.status?(3204===+t.status&&h(e.tips["dash.titleDuplicate"]),h(Number(t.status))):s.path().indexOf(e.currDash.dashSelected)>=0&&v(e.currDash.dashSelected)})},e.$watch(function(){return a.proj_share||!a.permision.dashOperate},function(t){e.gridsterOpts&&(e.gridsterOpts.resizable.enabled=!t,e.gridsterOpts.draggable.enabled=!t)}),e.$watch("dashProperty",function(t){1==t&&e.gridsterOpts&&(e.gridsterOpts.resizable.enabled=!1,e.gridsterOpts.draggable.enabled=!1)}),e.goHelp=function(e){c(e)},e.chartChain=m(e),e.chartDashJump=y(e),e.getAllChartInstances=function(){var t=[];return e.dashStandardItems&&e.dashStandardItems.length>0&&e.dashStandardItems.forEach(function(e){var a=e.children[0].dom_id;if(a){var r=$("#"+a).find(".chart").data("chart-data");r&&t.push(r)}}),t},e.enterFullScreen=function(e){var t=s.path().replace("dash_edit","dash_fullscreen");if(a.isThirdIframe&&(t=s.path().replace("third_iframe","dash_fullscreen")),s.path(t),e){var r=$("body")[0],i=r.requestFullscreen||r.webkitRequestFullscreen||r.mozRequestFullScreen||r.msRequestFullscreen;i&&(i.apply(r),$(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",function(){var e=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement;if(e);else{if($("body").find(".fullscreen-chart").length>0);else{var t=s.path();t.indexOf("dash_fullscreen")&&(t=t.replace("dash_fullscreen","dash_edit"),a.isThirdIframe&&(t=t.replace("dash_fullscreen","third_iframe")),s.path(t))}$(document).off("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange")}}),$("body").hasClass("fullscreen-status")||$("body").addClass("fullscreen-status"))}},s.path().indexOf("/dash_fullscreen/")>-1&&(a.projectLoaded=!0),e.exitFullScreen=function(){a.projectLoaded=!1;var e=s.path().replace("dash_fullscreen","dash_edit");a.isThirdIframe&&(e=s.path().replace("dash_fullscreen","third_iframe")),s.path(e);var t=document.exitFullscreen||document.webkitExitFullscreen||document.webkitCancelFullScreen||document.mozCancelFullScreen||document.msExitFullscreen;t&&t.apply(document)},e.fullDisplayDevice=localStorage?localStorage.getItem("fullDisplayDevice")||"pc":$.cookie("fullDisplayDevice")||"pc",e.setFullDisplayDevice=function(t){t!==e.fullDisplayDevice&&(e.fullDisplayDevice=t,BDPLogger.log("interaction","click","setFullDisplayDevice",1),BDPLogger.log("feature","fullDisplayDevice",t,1),localStorage?localStorage.setItem("fullDisplayDevice",t):$.cookie("fullDisplayDevice",t),e.dashStandardItems.forEach(function(e){var r=e.children[0].dom_id;if(r){var i=$("#"+r).find(".chart").data("chart-data");i&&i.setDisplayDevice(t,a)}}),$(".fullscreen-chart").length>0&&$(".fullscreen-chart").each(function(e,r){var i=$(r).data("chart-data");i&&i.setDisplayDevice(t,a)}))},e.removeFullDisplayStyle=function(){e.isFullscreenMode||"pc"===e.fullDisplayDevice&&e.fullDisplayTheme===a.usedThemeId||e.dashStandardItems.forEach(function(e){var t=e.children[0].dom_id;if(t){var r=$("#"+t).find(".chart").data("chart-data");r&&r.setDisplayStyle("pc",1==a.usedThemeId?"dark":"default",a)}})},e.fullDisplayTheme=localStorage?+localStorage.getItem("fullDisplayTheme")||a.usedThemeId:+$.cookie("fullDisplayTheme")||a.usedThemeId,e.setFullDisplayTheme=function(t){if(t!==e.fullDisplayTheme){e.fullDisplayTheme=t,BDPLogger.log("interaction","click","setFullDisplayTheme",1),BDPLogger.log("feature","fullDisplayTheme",t,1),localStorage?localStorage.setItem("fullDisplayTheme",t):$.cookie("fullDisplayTheme",t);var r=1===t?"dark":"default";e.dashStandardItems.forEach(function(e){var t=e.children[0].dom_id;if(t){var i=$("#"+t).find(".chart").data("chart-data");i&&i.setTheme(r,a)}}),$(".fullscreen-chart").length>0&&$(".fullscreen-chart").each(function(e,t){var i=$(t).data("chart-data");i&&i.setTheme(r,a)})}},e.updateGridLayout=function(){var t=function(t){if(e.gridsterOpts.width=2==t?996:"auto",2==t){$(".dash-wrapper").hasClass("dash-fixed-width")||$(".gridster").removeClass("gridster-loaded"),$(".dash-wrapper").addClass("dash-fixed-width");var a,r=d(function(){a=$(".gridster-loaded"),a.length&&(N.setFreeLayout(),d.cancel(r),i(function(){e.gridsterOpts.layoutStyle=t,e.dashLayoutInfo.layout_style=t,e.saveDashboard()}))},100)}else e.dashLayoutInfo.fixed_width||$(".dash-wrapper").removeClass("dash-fixed-width"),e.gridsterOpts.layoutStyle=t,e.dashLayoutInfo.layout_style=t,e.saveDashboard()};t(e.dashLayoutInfo.layout_style)};var N={setMobLayout:function(t){e.global.showMobLayout=t},setFreeLayout:function(){var t,a=$("#J_gridster .gridster-item"),r="",i={};angular.forEach(a,function(a){if(r=$(a).attr("style"),t=$(a).data("chartId"),r){r.split(";").forEach(function(e){var t=e.replace(/\s/g,"").split(":");t[1]&&(i[t[0]]=t[1].replace("px",""))});for(var d=0;d<e.dashStandardItems.length;d++)t===e.dashStandardItems[d].children[0].meta.ct_id&&(e.dashStandardItems[d].left=+i.left,e.dashStandardItems[d].top=+i.top,e.dashStandardItems[d].width=+i.width,e.dashStandardItems[d].height=+i.height)}else console.log("布局尚未完成切换导致错误")})},getBlankPos:function(){var t=[];return angular.forEach(e.dashStandardItems,function(e){t.push(e.top+e.height)}),{top:Math.max.apply(this,t)}},save:function(){this.setFreeLayout(),e.saveDashboard()}};e.setMobLayout=N.setMobLayout,e.sortMobCharts={stop:function(){e.saveDashboard()}},e.makeDashEdit=function(t){a.dashEditMode=t,3==a.enterprise_type&&2==a.guide&&(t?e.$emit("okToGuide","designStart"):e.$emit("okToGuide","designEnd")),t?x():(1==e.dashLayoutInfo.layout_style?(x(),e.saveDashboard()):N.save(),e.dash.cancelEditState())},e.textComponentEditMode={},e.dash={addTextComponent:function(){E("C101"),r.chart.create({dsh_id:e.currDash.dashSelected,ct_type:2,dsh_meta:{charts:M(e.dashStandardItems,!0)}}).success(function(t){return 0!==+t.status?(e.dashStandardItems.pop(),!1):(e.dashStandardItems[e.dashStandardItems.length-1].children[0].meta.ct_id=t.result.ct_id,void $(".dash-wrapper").animate({scrollTop:$(".gridster").height()-15},function(){$(".gridster-item").last().addClass("highlight-chart"),i(function(){e.dash.editTextComponent(e.dashStandardItems[e.dashStandardItems.length-1].children[0]),i(function(){var e=g.retrieveEditor(t.result.ct_id).scope;e.displayElements.text.trigger("focus"),$(".gridster-item").last().removeClass("highlight-chart")},100)})}))})},delComponent:function(t){var a=angular.copy(e.dashStandardItems);a.forEach(function(e,r){e.children[0].meta.ct_id===t&&a.splice(r,1)}),r.chart.del({ct_id:t,dsh_meta:{charts:M(a,!0)}}).success(function(t){0===+t.status&&(e.dashStandardItems=a)})},clearAllTextEditState:function(){for(var t in e.textComponentEditMode)e.textComponentEditMode.hasOwnProperty(t)&&(e.textComponentEditMode[t]=!1)},editTextComponent:function(t){var a=t.meta.ct_id;e.dash.editChartMeta(t),angular.element(".gridster-item").map(function(e,t){angular.element(t).removeClass("selected")}),e.textComponentEditMode[a]=!0,i(function(){var t=$("#"+a);e.dash.setTaToolbarPos(t);var r=g.retrieveEditor(a).scope;r.displayElements.text.trigger("focus")})},setTaToolbarPos:function(e){var t=angular.element("body").height(),a=e[0].getBoundingClientRect();t-a.bottom<100||t-a.bottom<0?e.find(".ta-toolbar").removeClass("bottom").addClass("top"):e.find(".ta-toolbar").removeClass("top").addClass("bottom")},editTextFromMore:function(t){e.makeDashEdit(!0),this.editTextComponent(t)},saveTextComponent:function(t){var a=t.meta.ct_id;e.textComponentEditMode[a]=!1,e.saveDashboard()},editChartMeta:function(t){var a=t.meta.ct_id;e.dashLayoutInfo.id=t.dom_id,e.dashLayoutInfo.ct_id=a,e.dashLayoutInfo.chart_type=t.meta.type,e.dashLayoutInfo.show_navigator=t.meta.show_navigator,e.dash.clearAllTextEditState(),e.dashLayoutInfo.dash_setting=t.meta.dash_setting||{show_axis:!0,show_datalabels:["C230","C271","C272","C330","C360"].indexOf(t.meta.type)>-1,show_legend:!0,show_title:!0,show_total:!0,border_left:!1,border_top:!1,border_right:!1,border_bottom:!1,border_null:!0},e.dashLayoutInfo.hasTotal=t.meta.hasTotal,void 0===e.dashLayoutInfo.dash_setting.show_navigator&&e.dashLayoutInfo.show_navigator&&(e.dashLayoutInfo.dash_setting.show_navigator=!0),$(document).off("click.edit_dashboard").on("click.edit_dashboard",function(t){var a=$(t.target);a.parents(".gridster-item").length||a.parents(".dash-edit-wrapper").length||e.dash.cancelEditState()})},cancelEditState:function(){i(function(){e.dash.clearAllTextEditState(),e.dashLayoutInfo.id=void 0,e.dashLayoutInfo.ct_id="",e.dashLayoutInfo.chart_type=void 0},0)},canSetLegend:function(){var t=e.dashLayoutInfo.chart_type,a=t&&["C200","C261","C280","C300","C310","C320","C330","C340","C360","C370","C400"].indexOf(t)<0;return a},canSetAxis:function(){var t=e.dashLayoutInfo.chart_type,a=t&&["C210","C211","C212","C220","C240","C241","C242","C250","C280","C350","C351","C352"].indexOf(t)>-1;return a},canSetDataLabels:function(){var t=e.dashLayoutInfo.chart_type;return["C200","C261","C280","C300","C310","C340","C400"].indexOf(t)<0},canSetTotal:function(){var t=e.dashLayoutInfo.chart_type;return e.dashLayoutInfo.hasTotal&&"C210 C220 C230 C240 C261 C290 C350".indexOf(t)>-1&&e.dashLayoutInfo.showTotal},canSetTitle:function(){return!!e.dashLayoutInfo.ct_id&&e.dashLayoutInfo.ct_id.indexOf("text_")<0},canSetNavigator:function(){return e.dashLayoutInfo.show_navigator},modify:function(t){e.saveDashboard().then(function(){"legend"===t||"axis"===t||"total"===t||"navigator"===t?reflowChart(angular.element("#"+e.dashLayoutInfo.ct_id).find(".item-chart"),!0,!0):"title"===t?reflowChart(angular.element("#"+e.dashLayoutInfo.ct_id).find(".item-chart"),!0):("show_block"===t||"fixed_width"===t)&&(x(),angular.element(".item-chart").each(function(){reflowChart(angular.element(this),!0)})),C()})},toggleBorder:function(t){var a=e.dashLayoutInfo.dash_setting;a["border_"+t]=!a["border_"+t],"null"!==t?a.border_null=!Boolean(a.border_left+a.border_bottom+a.border_right+a.border_top):(a.border_top=!1,a.border_right=!1,a.border_bottom=!1,a.border_left=!1,a.border_null=!0);for(var r=0;r<e.dashStandardItems.length;r++){var i=e.dashStandardItems[r].children[0];if(i.dom_id===e.dashLayoutInfo.id){i.meta.dash_setting=e.dashLayoutInfo.dash_setting;
break}}e.saveDashboard().then(function(){})}},e.gotoTplSheet=function(){$.cookie("ds_tb_id",e.dashTbId),s.path("/tpl_replace/"+e.currDash.activeProjId+"/"+e.currDash.dashSelected)},e.personalDashExcelExport=function(){location.href="/api/personal/export?dsh_id="+e.currDash.dashSelected,o.open({templateUrl:"/static/partials/dialogTemplates/dash_tpl_step.html",scope:e,showClose:!1,className:"ngdialog-theme-default dash-tpl-step",data:{proj_id:e.currDash.activeProjId,dsh_id:e.currDash.dashSelected},controller:["$scope",function(e){e.goToTplDashborad=function(){o.closeAll()},e.goToReplaceTpl=function(){s.path("/tpl_replace/"+e.ngDialogData.proj_id+"/"+e.ngDialogData.dsh_id),o.closeAll()}}]})},f(["dash.delChartFail","dash.plzSelectTable","dash.selectTbTitle","dash.emptyFolderList","dash.titleRequired","dash.titleDuplicate","dash.delChartLinkSuccess","chart.untitledChart","saveSuccess","chart.chainChart","chart.chainField","dash.dashCartJump.errSameTip","dash.dashCartJump.successDelTip","dash.dashCartJump.selectDashPrefix","dash.dashCartJump.selectDashPrefix","dash.dashCartJump.selectFolder","dash.dashCartJump.selectDashboard","dash.dashCartJump.selectFilter","dash.dashCartJump.globalFilter","dash.dashCartJump.openType","dash.dashCartJump.thisWin","dash.dashCartJump.newWin","dash.dashCartJump.errEmptyTip"],e)}}function t(e,t,a,r,i,d,s,o,l,n,h,c,u,f,p){function g(){a.field.getList(e.ngDialogData.choose_table.tb_id).then(function(t){if("0"==t.status){e.fieldList=t.result.schema,e.fidToName={},e.tbType=t.result.tb_type,angular.forEach(e.fieldList,function(t){e.fidToName[t.fid]=t.name,0===t.is_build_aggregated?t.field_type="common":t.is_build_aggregated>0&&(t.field_type=t.hasOwnProperty("param")&&"group"==t.param.type?"group":"calc")});for(var a=e.fieldList.length;a--;)1==e.fieldList[a].is_build_aggregated&&e.fieldList.splice(a,1)}})}function m(t){a.chart_tpl.info(t).then(function(t){if("0"==t.status){var a=t.result.tpl_info.fid_explain;e.tplMatchInfo.tplFields=a}})}function _(){var a=e.selectedTpl;a.chart_options={theme:1===+t.usedThemeId?"dark":"default",ct_id:a.ct_id,is_chart_tpl:1,optional:{}}}function y(){g(),m(e.selectedTpl.tpl_id)}e.tplMatchInfo={tplFields:[],matchFields:[]},e.fieldDragging=null,e.fieldList=[],e.fidToName={},e.tbType="",e.matchTabIndex=1,e.showTab=function(t){e.matchTabIndex=t,2==t&&_()},e.dragThisField=function(t,a,r,i){e.fieldDragging=r},e.dropFieldMatch=function(t,a,r){if(e.fieldDragging){for(var i=e.tplMatchInfo.matchFields,d=i.length;d--;)if(i[d]&&i[d].fid==e.fieldDragging.fid)return l(p.instant("chartTemplate.duplicateUseField"));return e.tplMatchInfo.tplFields[r].data_type!=e.fieldDragging.data_type?l(p.instant("chartTemplate.dataTypeNotMatch")):void(e.tplMatchInfo.matchFields[r]=e.fieldDragging)}},e.optionsList={},e.autoMatch=function(){function t(t,a){return t&&!r[t.fid]?(r[t.fid]=!0,e.tplMatchInfo.matchFields[a]=t,!0):!1}e.tplMatchInfo.matchFields=[];var a={};e.fieldList.forEach(function(e){a[e.data_type+":"+e.name]=e,a[e.data_type+":"+e.original_name]=e,a[e.data_type]||(a[e.data_type]=[]),a[e.data_type].push(e)});var r={};e.tplMatchInfo.tplFields.forEach(function(e,r){var i=e.data_type+":"+e.title;t(a[i],r)}),e.tplMatchInfo.tplFields.forEach(function(r,i){if(!e.tplMatchInfo.matchFields[i]){var d=a[r.data_type];if(angular.isArray(d))for(;d[0]&&!t(d.shift(),i););!e.tplMatchInfo.matchFields[i]}})},e.chartTpl=function(){var t={},r=e.tplMatchInfo.tplFields,i=e.tplMatchInfo.matchFields,d=!1;if(r.forEach(function(e,a){return i[a]?t[e.fid]=i[a].fid:void(d=!0)}),d)return void l(p.instant("chartTemplate.plzFillAllTplFields"));var s=function(r){var i={tpl_id:e.selectedTpl.tpl_id,dsh_id:r.dsh_id,tb_id:r.tb_id,used_origin_fids_map:t,dsh_meta:r.dsh_meta};return a.chart_tpl.createChart(i)};e.chooseTableOk(e.ngDialogData.choose_table.tb_id,s)},y()}angular.module("BC.controllers.dashboard",["ngDragDrop","gridster","slick"]).controller("DashController",e).controller("chartTplConfigCtrl",t),e.$inject=["$scope","$rootScope","commonService","$timeout","$interval","$location","ngDialog","$stateParams","commonHttp","errHint","operatorHelpLink","$http","$jsTipTranslate","autoRefreshChart","textAngularManager","dashChartLink","$q","dashChartJump"],t.$inject=["$scope","$rootScope","commonService","$timeout","$location","ngDialog","$stateParams","commonHttp","errHint","operatorHelpLink","$http","$jsTipTranslate","autoRefreshChart","dateNameMap","$translate"]}();
;!function(){function e(e,a,l,t,r,s,i,o,d,n,c,h){function u(t){e.hitMemoryGlobalFilter=!1,e.hitGlobalFilterId=[],e.global.globalDashFilter=[],l.dash_global_filter.item({dash_id:t,rule_id:a.global.rule_id||"",is_tpl:1}).then(function(a){if("0"==a.status){if(e.selected.dsh_id!==t)return;e.global.originalGlobalFilter=angular.copy(a.result);var l=bdp.utils.handleGlobalFilterLevel(a.result);angular.forEach(l,function(e){if(f(e),"date"==e.data_type&&""==e.config.granularity){var a=e.config.range||"";if(a){var l=!1;angular.forEach(e.adv_date_list,function(e){e.opt_id==a&&(l=!0)}),l||(e.config.range="",e.config.default_select=!1,e.range=[])}}}),e.global.globalDashFilter=l,e.hitMemoryGlobalFilter&&e.$emit("hitMemoryGlobalFilter",!0)}else d(Number(a.status))})}function f(l){var t="global_filter_memory",r=angular.fromJson(window.localStorage.getItem(t))||[],s=!1,i=a.wsId||"";angular.forEach(r,function(a){a.ws_id==i&&l.data_type==a.data_type&&l.name==a.name&&l.config&&l.config.hasOwnProperty("granularity")&&l.config.granularity==a.granularity&&("date"==l.data_type&&""==l.config.granularity?angular.forEach(l.adv_date_list,function(e){e.opt_id==a.range[0]&&(l.range=a.range,s=!0)}):l.range=a.range,e.hitMemoryGlobalFilter=!0,e.hitGlobalFilterId.push(l.df_id))})}function p(){var l=a.global.dshWatermarkImg,t="none";if(l){var s=$(".gridster"),i="dash-water-mark",o=1==a.usedThemeId?"water-mark-white":"water-mark-dark",d=r.path();if(d.indexOf("dash_tpl_fullscreen")>-1&&(o="water-mark-white"),e.dashLayoutInfo.show_block)bdp.utils.browser().ie?s.addClass(o):$("."+i).remove();else if(t="url("+l+")",bdp.utils.browser().ie)s.addClass(o);else if(0==$("."+i).length){var n=document.createElement("div");n.className="water-mark "+i+" "+o,s.append(n)}else $("."+i).removeClass("water-mark-white").removeClass("water-mark-white").addClass(o)}}function g(l,r){a.dashLoading=!1;var s=r.result;if(!isObjectEmpty(s)){a.dashProperty=s.property,e.outer_share_info=s.outer_share_info,e.gis_flag=s.gis_flag,e.dashLayoutInfo.show_block=defined(s.meta.show_block)?s.meta.show_block:!0,e.dashLayoutInfo.fixed_width=defined(s.meta.fixed_width)?s.meta.fixed_width:!1,m(s.meta.show_block),e.dashTitle=s.name,e.dashLabel=s.label||"",e.dashComment=s.comment||"",e.property=s.property;var i=s.meta.charts||[];if(e.dashStandardItems=i||[],e.isFullscreenMode){var o=$(".main"),d=$(".dash-wrapper"),n=o.height()-parseInt($(".dash-title-wrap").height())-parseInt(d.css("paddingTop"))-parseInt(d.css("paddingBottom")),c=9,h=n/c+(e.global.globalDashFilter.length?16:20);e.dashPages=[],e.gridsterOpts.rowHeight=h,e.gridsterOpts.draggable.enabled=!1,e.gridsterOpts.resizable.enabled=!1;var u=[],f=0,g=0;e.dashStandardItems.sort(function(e,a){return e.row==a.row?e.col-a.col:e.row<a.row?-1:1}),e.dashStandardItems.forEach(function(a){a.sizeY=Math.min(a.sizeY,c),a.row+=g,a.row%=c;var l=!0;if(a.row+a.sizeY>c)l=!1;else for(var t=0;t<u.length;t++){var r=u[t];if(!(r.col>=a.col+a.sizeX||r.row>=a.row+a.sizeY||a.col>=r.col+r.sizeX||a.row>=r.row+r.sizeY)){l=!1;break}}l?u.push(a):(g+=c-a.row,e.dashPages.push(u),u=[],f++,a.row=0,u.push(a))}),u.length>0&&e.dashPages.push(u)}e.dashInit.load=!1,e.draw_chart_url={};for(var _,b,v=0;v<e.dashStandardItems.length;v++)e.dashStandardItems[v].children[0].meta.filter_list=[];e.hasChartLink=!1,a.isGlobalCustom={};for(var y=0;y<i.length;y++){_=i[y];for(var w=0;w<_.children.length;w++)if(b=_.children[w],b.meta.filter_list=[],b.meta.type){var D="";a.isGlobalCustom[b.meta.ct_id]=!1,e.global.rule_id&&(D="&rule_id="+e.global.rule_id),e.draw_chart_url[b.dom_id]={options:{theme:e.isFullscreenMode||1===a.usedThemeId?"dark":"default",device:e.isFullscreenMode?e.fullDisplayDevice:"pc",ws_id:a.wsId,dsh_id:l,ct_id:b.meta.ct_id,tb_id:b.meta.tb_id,rule_id:a.global.rule_id,is_tpl:1,optional:{linked_chart_type:b.meta.linked_chart_type}},lazyload:y>2}}}e.$$phase||e.$apply(),t(function(){e.lazy=new bdpChart.LazyLoad(".gridster-desktop",".gridster-item",{diff:50,handleResize:!0,onItemLoad:function(a){var l=$(a).find(".item-chart").attr("id");e.draw_chart_url[l]&&(e.draw_chart_url[l].lazyload=!1)},onItemsLoad:function(){e.$$phase||e.$apply()}}),e.search_ct_id&&setTimeout(function(){e.scrollToChart(e.search_ct_id)},10)}),p()}}function m(a){e.gridsterOpts={margins:a?[8,8]:[0,0],outerMargin:!1,minColumns:2,minRows:2,columns:12,resizable:{enabled:!1},draggable:{enabled:!1}}}if(e.mouseleaveItem=function(){e.$broadcast("fire-mouseleave-item-event",!0)},e.chartOptions={},i.projId){if(e.AllMap=["全部","全部时间","All"],a.last_dash_path=r.path(),a.dashEditMode=!1,e.currDash={activeProjId:i.projId,dashSelected:i.dashId},e.activeProjId=i.projId,e.dashSelected=i.dashId,a.view="dash_tpl",a.show_bdp_header=!0,e.dashInit={},e.dashInit.load=!0,i.ruleId)e.global.rule_id=i.ruleId;else{var _=r.path();_.indexOf("ru_")>=0&&(e.global.rule_id=_.substring(_.indexOf("ru_")))}e.selected={proj_id:i.projId,dsh_id:i.dashId,rule_id:e.global.rule_id,ws_id:a.wsId},e.$on("jumpToSearch",function(a,l){e.search_ct_id=l}),e.scrollToChart=function(e,a){a=a||$(".gridster-desktop");var l=a.closest(".dash-wrapper");a.find(".gridster-item").each(function(a,t){var r=$(t);if(e==r.data("chart-id")){var s=l.height(),i=r[0].offsetTop;i+r.height()>s?l.animate({scrollTop:i-15},function(){r.addClass("highlight-chart")}):r.addClass("highlight-chart"),$(document).on("click.cancelHighlight",function(){r.removeClass("highlight-chart"),$(this).off("click.cancelHighlight")})}})},e.$on("scrollToChart",function(a,l){setTimeout(function(){e.scrollToChart(l)},0)}),localStorage.setItem("mc_location_path",r.path());var _=r.path();_.indexOf("dash_tpl_fullscreen")>0?(e.isFullscreenMode=!0,a.show_bdp_header=!0,e.$dashSlider=$("#dash-slider"),$(document).on("keyup",function(a){switch(a.keyCode){case 37:e.$dashSlider.slick("slickPrev");break;case 39:e.$dashSlider.slick("slickNext");break;case 27:0===$(".fullscreen-chart").length&&e.exitFullScreen()}})):(e.isFullscreenMode=!1,a.view="dash_tpl",a.show_bdp_header=!0,$(document).off("keyup")),e.dashLayoutInfo={},e.hitMemoryGlobalFilter=!1,e.hitGlobalFilterId=[],e.getDashboardInfo=function(t){if(t?u(t):e.global.globalDashFilter=[],a.dashLoading=!0,""==t||"undefined"==typeof t)return a.dashLoading=!1,!1;var s={};return s.dsh_id=t,s.is_tpl=1,l.dashboard.getInfo(s).then(function(e){if(0==e.status)var l=setInterval(function(){g(t,e),clearInterval(l)},200);else{if(a.dashLoading=!1,3==e.status)return r.path("/dash_tpl/"),void location.reload();d(e.status)}})},e.getDashboardInfo(e.currDash.dashSelected),e.$on("fire-refresh-dashboard",function(){"dash_tpl"==a.view&&e.getDashboardInfo(e.currDash.dashSelected)}),e.goHelp=function(e){n(e)},e.enterFullScreen=function(e){var a=r.path().replace("dash_tpl","dash_tpl_fullscreen");if(r.path(a),$("body").addClass("route-dash-fullscreen"),e){var l=$("body")[0],t=l.requestFullscreen||l.webkitRequestFullscreen||l.mozRequestFullScreen||l.msRequestFullscreen;t&&(t.apply(l),$(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",function(){var e=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement;if(e);else{if($("body").find(".fullscreen-chart").length>0);else{var a=r.path();a.indexOf("dash_tpl_fullscreen")&&r.path(a.replace("dash_tpl_fullscreen","dash_tpl"))}$(document).off("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange")}}),$("body").hasClass("fullscreen-status")||$("body").addClass("fullscreen-status"))}},e.exitFullScreen=function(){var e=r.path().replace("dash_tpl_fullscreen","dash_tpl");r.path(e),$("body").removeClass("route-dash-fullscreen");var a=document.exitFullscreen||document.webkitExitFullscreen||document.webkitCancelFullScreen||document.mozCancelFullScreen||document.msExitFullscreen;a&&a.apply(document)},e.fullDisplayDevice=localStorage?localStorage.getItem("fullDisplayDevice")||"pc":$.cookie("fullDisplayDevice")||"pc",e.setFullDisplayDevice=function(l){l!==e.fullDisplayDevice&&(e.fullDisplayDevice=l,BDPLogger.log("interaction","click","setFullDisplayDevice",1),BDPLogger.log("feature","fullDisplayDevice",l,1),localStorage?localStorage.setItem("fullDisplayDevice",l):$.cookie("fullDisplayDevice",l),e.dashStandardItems.forEach(function(e){var t=e.children[0].dom_id;if(t){var r=$("#"+t).find(".chart").data("chart-data");r&&r.setDisplayDevice(l,a)}}),$(".fullscreen-chart").length>0&&$(".fullscreen-chart").each(function(e,t){var r=$(t).data("chart-data");r&&r.setDisplayDevice(l,a)}))},e.removeFullDisplayStyle=function(){e.isFullscreenMode||"pc"===e.fullDisplayDevice&&e.fullDisplayTheme===a.usedThemeId||e.dashStandardItems.forEach(function(e){var l=e.children[0].dom_id;if(l){var t=$("#"+l).find(".chart").data("chart-data");t&&t.setDisplayStyle("pc",1==a.usedThemeId?"dark":"default",a)}})},e.fullDisplayTheme=localStorage?+localStorage.getItem("fullDisplayTheme")||a.usedThemeId:+$.cookie("fullDisplayTheme")||a.usedThemeId,e.setFullDisplayTheme=function(a){if(a!==e.fullDisplayTheme){e.fullDisplayTheme=a,BDPLogger.log("interaction","click","setFullDisplayTheme",1),BDPLogger.log("feature","fullDisplayTheme",a,1),localStorage?localStorage.setItem("fullDisplayTheme",a):$.cookie("fullDisplayTheme",a);var l=1===a?"dark":"default";e.dashStandardItems.forEach(function(e){var a=e.children[0].dom_id;if(a){var t=$("#"+a).find(".chart").data("chart-data");t&&t.setTheme(l)}}),$(".fullscreen-chart").length>0&&$(".fullscreen-chart").each(function(e,a){var t=$(a).data("chart-data");t&&t.setTheme(l)})}},e.useTpl=function(){s.open({templateUrl:"/static/partials/dialogTemplates/use_tpl_option.html",scope:e,className:"ngdialog-theme-default use-tpl-option"})},e.useTplByOption=function(l,t){s.closeAll(),a.pageLoading=!0,o.post("/api/personal/apply",{dsh_id:l}).then(function(l){if(a.pageLoading=!1,"0"==l.status){var i=l.result;1===t?(location.href="/api/personal/export?dsh_id="+i.dsh_id,s.open({templateUrl:"/static/partials/dialogTemplates/library_tpl_step.html",scope:e,showClose:!1,className:"ngdialog-theme-default dash-tpl-step",data:{proj_id:i.proj_id,dsh_id:i.dsh_id},controller:["$scope",function(e){e.goToTplDashborad=function(){s.closeAll(),r.path("/dash_edit/"+e.ngDialogData.proj_id+"/"+e.ngDialogData.dsh_id)},e.goToReplaceTpl=function(){s.closeAll(),r.path("/tpl_replace/"+e.ngDialogData.proj_id+"/"+e.ngDialogData.dsh_id)}}]})):r.path("/dash_edit/"+i.proj_id+"/"+i.dsh_id)}})},h(["dash.delChartFail","dash.plzSelectTable","dash.selectTbTitle","dash.emptyFolderList","dash.titleRequired","dash.titleDuplicate","dash.delChartLinkSuccess","chart.untitledChart","saveSuccess","chart.chainChart","chart.chainField"],e)}}angular.module("BC.controllers.dashboard").controller("newDashController",e),e.$inject=["$scope","$rootScope","commonService","$timeout","$location","ngDialog","$stateParams","commonHttp","errHint","operatorHelpLink","$http","$jsTipTranslate","autoRefreshChart"]}();
;!function(){angular.module("BC.controllers.dashUpload",["ngDragDrop","gridster"]).controller("DashUploadController",["$scope","$rootScope","commonService","$timeout","$location","ngDialog","$stateParams","$state","commonHttp","errHint","personalSettingService","$jsTipTranslate","capacityHint",function(e,t,a,s,o,r,i,n,l,u,d,c,p){function f(){angular.element("#dashUploadFile").find("input").click()}e.isPersonal=!1,e.$watch(function(){return t.enterprise_type},function(){3==t.enterprise_type&&(e.isPersonal=!0)}),e.setCsvDelimiter=function(){var t=e.csvData.csv_terminate;return"other"==e.csvData.csv_terminate&&(t=e.csvData.csv_other,t.length>1)?void u(e.tips["upload.onlyOneDelimiter"]):t?(e.uploadData.field_terminate=t,void e.$broadcast("fileInputChange",e.hasFile)):void u(e.tips["upload.csvDesc"])},e.uploadData={opt:1,folder_id:"folder_root"};var g=52428800;e.uploadMethod=function(){e.operate_type="add",e.uploadData.opt=1,e.uploadDialogTitle=e.tips["wb.uploadData"],e.choose_file=!0,f()},e.onFileInputChange=function(a){e.hasFile=a&&a.length,e.file_name=e.hasFile?a[0].name:e.tips["wb.clickToUpload"];var s=t.personalInfo,o=s.capacity,r=a[0].size;if("personal"==t.global.domain&&r+s.used>o)return void p();if(a[0].size>=g){var i=a[0].size/(1<<20);return e.status="error",e.errMsg=e.tips["upload.fileSizeError"]+parseInt(i)+"M",void(e.$$phase||e.$digest())}/\.csv$/.test(e.file_name)?(e.status="setCsv",e.dialogTitle=e.tips["wb.setCsvTitle"],e.isCsv=1,e.csvData={csv_terminate:"comma",csv_other:""}):(e.isCsv=0,e.$broadcast("fileInputChange",a)),e.uploadData.size=a[0].size,e.show_adding_db(),e.$$phase||e.$digest()},e.uploadOption={},e.show_adding_db=function(t){e.uploadOption.method=t,e.uploadOption.default_tb=t?e.selected.tb.dstb_id:void 0,e.uploadOption.excel=null;var a="",t="";e.isCsv||(e.status="loading",e.dialogTitle=e.tips["wb.isUploading"]),e.upload_dialog=r.open({template:"/static/js/user-guide/guide_upload_data.html",className:"ngdialog-theme-default ngdialog-guide-upload"+t+" "+a,scope:e})},e.onUpload=function(t){console.log(e.tips["wb.isUploading"],t),e.status="loading",e.showProgress=!0,angular.element("#upload-progress .progress-bar").css("width","0")},e.onProgress=function(t){e.uploadProgress=(100*t).toFixed(2)+"%",angular.element("#upload-progress .progress-bar").css("width",e.uploadProgress)},e.onError=function(t){var a=t.data;return 23040==a.status?void p():(console.error(e.tips["wb.uploadFailed"],t),e.showProgress=!1,e.status="error",e.dialogTitle=e.tips["wb.uploadFailed"],e.responseData=t.data,void(e.errMsg=t.data.errstr))},e.onComplete=function(s){console.log(e.tips["wb.uploadDone"],s);var o=s.data;if(e.showProgress=!1,e.errSheet=[],0==o.status){e.status="taskStart",e.dialogTitle=e.tips["wb.isAnalyzing"],e.uploadMsg=e.tips["wb.isAnalyzing"],h=o.result.task_id;var r=function(s){e.sheetList=[],angular.forEach(s.info,function(t){e.sheetList.push({check:!1,name:t.name,errMsg:t.errmsg?t.errmsg:""})});var o=s.excel_id,r=[],i="folder_root";angular.forEach(e.sheetList,function(e){r.push(e.name)});var n=function(){e.status="taskStart",e.dialogTitle=e.tips["wb.isCreatingWorkSheet"],e.uploadMsg=e.tips["wb.isCreatingWorkSheet"],a.db.excelCreate({excel_id:o,sheet_names:angular.toJson(r),folder_id:i}).then(function(t){if(0==t.status){var a=[],s=!1;angular.forEach(t.result,function(t){0==t.status?(s=!0,a.push(t.task_id)):e.errSheet.push(t)}),s?(h=a.join(","),_(l)):(e.status="complete",e.upload_stat="analysis",e.dialogTitle=e.tips["wb.uploadDone"],e.createErrMsg=e.errSheet)}else e.status="complete",e.upload_stat="fail",e.errMsg=t.errstr})};1==e.sheetList.length?(e.showOffsetInfo(e.sheetList[0].name),n()):(e.status="selectSheet",e.dialogTitle="选择工作表",e.confirmCreateExcel=function(){r=[],angular.forEach(e.sheetList,function(e){e.check&&r.push(e.name)}),n()});var l=function(a){var s=!0;if(e.createErrMsg=[],e.errSheetList=[],a.tb_id?1==a.status&&(s=!1):angular.forEach(a,function(t){1==t.status?(s=!1,e.createErrMsg.push(t)):e.errSheetList.push(t)}),e.errSheetList=e.errSheetList.concat(e.errSheet),s)e.upload_stat="fail";else{e.upload_stat="success";var o=[];a.tb_id?o.push(a.tb_id):angular.forEach(a,function(e){1==e.status&&o.push(e.tb_id)}),e.getFolderList().then(function(){e.new_tb=[];var t=!1,s={},r="";if(1==o.length)r=a.tb_id;else for(var i in a){r=a[i].tb_id;break}var n=bdp.bdpTables.getFolderByTableId(e.originFolderList,r);angular.forEach(o,function(a){for(var o=0,r=n.tb_list.length;r>o;o++)if(a==n.tb_list[o].dstb_id){t=b(n.tb_list[o]),s=angular.copy(n.tb_list[o]),t&&(s.repeatName=!0,e.no_repeat_name=!1),e.new_tb.push(s);break}}),e.status="complete",e.upload_stat="success",e.dialogTitle=e.tips["wb.uploadDone"]}),3==t.enterprise_type&&e.$emit("changeCapacity","change")}}};_(r,"upload")}else e.onError(s)},e.offsetList=[],e.showOffsetInfo=function(t){var a=e.offsetList;angular.forEach(a,function(e){if(t==e.name&&(e.row_offset>=0||e.col_offset>=0)){var a=e.row_offset,s=e.col_offset;(0!=a||0!=s)&&u("文件数据处理结果：删除前 "+a+" 行,前 "+s+" 列")}else t!=e.name||e.row_offset>=0||e.col_offset>=0||u(e.errmsg)})};var h,_=function(t,o){a.getTaskStatus(h).then(function(a){if(!a.result.hasOwnProperty("excel_id"))if(a.result.hasOwnProperty("tb_id"))e.new_tb_id=a.result.tb_id;else{var r=[];for(var i in a.result)r.push(a.result[i]);e.new_tb_id=r[0].tb_id}if(e.offsetList=a.result.info,0==a.status){var n=a.result;if(void 0!==n.status)if(0==n.status||3==n.status)s(function(){_(t,o)},1e3);else if(2==n.status)e.status="complete",e.upload_stat="fail",e.errMsg=n.error_msg||n.errstr;else{if(!t)return;t(n)}else{var l=0;if(angular.forEach(n,function(e){(0==e.status||3==e.status)&&(l+=1)}),l>0)s(function(){_(t,o)},1e3);else{if(!t)return;t(n)}}}else e.status="complete",e.upload_stat="fail",e.errMsg=e.tips["wb.analysisFailed"]})};e.getFolderList=function(){function t(t){return e.folderList=[],t.map(function(t){e.folderList.push(t)}),e.originFolderList=t,e.original_folderList=t,e.no_datasource=bdp.bdpTables.checkNoTableInFolder(t,"list"),e.no_datasource?!1:void 0}return a.folder.getList().then(function(e){return e?t(e):void 0})};var b=function(t){function a(e){angular.forEach(e,function(e){s||(angular.forEach(e.tb_list,function(e){e.tb_id!=t.tb_id&&e.name==t.name&&(s=!0)}),!s&&e.sub_folders&&e.sub_folders.length>0&&a(e.sub_folders))})}var s=!1;return a(e.folderList),s};e.no_repeat_name=!0,e.rename_tb=function(t,s){var o=s.name,r=!1;return s.name=t,(r=b(s))?(s.repeatName=!0,s.name=o,u(e.tips["wb.changeWorkSheetName"]),void(e.no_repeat_name=!1)):(s.repeatName=!1,e.no_repeat_name=!0,angular.forEach(e.folderList[0].tb_list,function(e){e.tb_id==s.tb_id&&(e.name=s.name)}),a.tb.modify(angular.toJson([s])).success(function(t){0==t.status?(u(e.tips["wb.editSuccesss"]),e.getFolderList()):e.getFolderList()}),t)},e.preview_current_tb=function(){if(e.no_repeat_name){var t={tb_id:e.new_tb_id};e.chooseTableOk(t.tb_id)}},e.closeDialog=function(){e.upload_dialog.close()},e.checkAll=function(t){var a=t.currentTarget.checked;e.selectAll=a,angular.forEach(e.sheetList,function(e){e.errMsg||(e.check=a)})},e.reUpload=function(){e.uploadMethod()},e.resetUpload=function(){angular.element("#guideUploadFile").find("input").val(""),e.operate_type="add",e.uploadData.opt=1,e.uploadDialogTitle="上传数据",e.choose_file=!0},e.modify=function(){if(e.dashStandardItems.sort(function(e,t){return e.row-t.row}),!e.dashTitle)return void alert(e.tips["dash.titleRequired"]);var t=angular.copy(e.dashStandardItems);angular.forEach(t,function(e){e.children[0].meta={ct_id:e.children[0].meta.ct_id}});var s;return s={access_token:$.cookie("token"),dsh_id:e.dashSelected,data:angular.toJson({name:e.dashTitle,label:e.dashLabel||"",comment:e.dashComment||"",meta:{charts:t}})},a.dashboard.modify(s).success(function(t){"0"!=t.status?("3204"==t.status&&alert(e.tips["dash.titleDuplicate"]),errorHandle(t)):getGlobalFilterItem(e.dashSelected)})},c(["wb.isUploading","wb.uploadFailed","wb.analysisFailed","wb.uploadDone","wb.isAnalyzing","wb.isCreatingWorkSheet","wb.selectWorkSheet","wb.editSuccesss","wb.changeWorkSheetName","upload.csvDesc","upload.onlyOneDelimiter"],e)}])}();
;!function(){angular.module("BC.controllers.chartEdit",["ngDragDrop"]).controller("ChartController",["$scope","$rootScope","$timeout","$interval","$location","$stateParams","ngDialog","commonService","chartType","chartTypeTip","errHint","commonHttp","$http","$q","$jsTipTranslate","formulaKeyMap","dateNameMap","setAdvanceAggregatorName","formatFieldPercentile","setTableAdvSort",function(e,t,a,i,r,l,n,o,d,s,_,c,g,p,f,u,h,m,y,C){function v(){var e=t.wsId?t.wsId+"/":"",a=t.wsId?"/dash_edit_ws/":"/dash_edit/",i=a+e+lt+"/"+nt;return i}function b(e){if(1==e.y.length&&"row_summary"==e.y[0].fid||0==e.y.length){if(e.tb_statistic&&(e.tb_statistic.row=!1),e.tb_statistic&&(e.tb_statistic.col=!1),e.y=[],e.tb_conditional_formatting&&e.tb_conditional_formatting.length>0)for(var t=0,a=e.tb_conditional_formatting.length;a>t;t++){var i=e.tb_conditional_formatting[t];if("row_summary"===i.fid){e.tb_conditional_formatting.splice(t,1);break}}if(e.advanced_sort&&e.advanced_sort.length>0)for(var r=0,l=e.advanced_sort.length;l>r;r++){var n=e.advanced_sort[r];if("row_summary"==n.fid){e.advanced_sort.splice(r,1),e.is_advanced_sort=0;break}}}}function x(e){if(e.tb_statistic&&e.tb_statistic.subtotal){{e.x.length}e.tb_statistic.subtotal_setting={dimensions:[]}}}function w(e,t){if(t&&"C200"===e.chart_type&&e.advanced_sort&&e.advanced_sort.length>0)for(var a=0,i=e.advanced_sort.length;i>a;a++){var r=e.advanced_sort[a];if(t.uniq_id){if(t.uniq_id==r.uniq_id){e.advanced_sort.splice(a,1);break}}else if(t.fid===r.fid){e.advanced_sort.splice(a,1);break}}}function F(t){if(t){var a=e.selected_type,i=null,r=null;a&&(r=e.chart_ops.meta.level[e.drill_level],i="C200 C230 C250 C261 C271 C300 C310 C330".indexOf(a)<0&&!r.split_compare);var l=t.x||[],n=t.y||[],o=t.compare_axis||[];1!=n.length||o.length||(0==l.length||1==l.length&&"string"==l[0].data_type?t.title_formula="TOTAL":1==l.length&&"date"==l[0].data_type&&(t.title_formula="LAST"))}}function T(t,a){return o.field.getFilteredRange(e.ct_id,a,t).then(function(e){var t=e;return 0==t.status?t.result:null})}function S(a){T(a.meta.color_setting.field,e.tb_id).then(function(e){e&&e.total<=100&&t.$emit("triggerBuildEnumColorMap",e.result,!!a.reset,!!a.bindToMeta)}).then(function(){a.callback()})}function k(t){var a,i,r=e.chart_ops.meta.level[e.drill_level];for(a=0,i=r.y.length;i>a;a++)if(r.y[a].fid==t)return!1;for(a=0,i=r.x.length;i>a;a++)if(r.x[a].fid==t)return!1;if(r.compare_axis)for(a=0,i=r.compare_axis.length;i>a;a++)if(r.compare_axis[a].fid==t)return!1;if(r.y_optional)for(a=0,i=r.y_optional.length;i>a;a++)if(r.y_optional[a].fid==t)return!1;return!0}function D(){return!e.chart_ops||void 0!=e.chart_ops.name&&""!==e.chart_ops.name?!0:(_(e.tips["chart.emptyChartName"]),!1)}function A(){return e.chart_ops?e.originChartTitle!=e.chart_ops.name:void 0}function P(t,a){angular.forEach(a,function(a){if(a.QoQ&&(a.QoQ=t),a.YoY?("year"===t||["quarter","month","week"].indexOf(t)>-1&&"year"!==a.YoY)&&(delete a.YoY,delete a.yoyQoqType,delete a.formatter):a.yoyQoqSetting&&"custom"===a.yoyQoqSetting.type&&delete a.yoyQoqSetting,a.advance_aggregator)if(["retention","repetition","activity"].indexOf(a.advance_aggregator.type)>-1)a.advance_aggregator.setting.date_field_type=t;else if("running"===a.advance_aggregator.type){var i={day:"week",week:"month",month:"quarter",quarter:"year",year:"all"},r={week:["day"],month:["day","week"],quarter:["day","week","month"],year:["day","week","month","quarter"],all:["day","week","month","quarter","year"]};e.chart_ops.meta.level[e.drill_level].x[0].granularity_name?a.advance_aggregator.setting.reset_period="all":r[a.advance_aggregator.setting.reset_period].indexOf(t)<0&&(a.advance_aggregator.setting.reset_period=i[t])}})}function q(e,t){var a=t.offset.top<37||t.offset.left<230-t.item.width()||t.offset.left>$(".chart-right").offset().left-10;return a=a||t.offset.top>$("#chartBox").offset().top-5}function I(e,t){delete e.granularity,t.sort&&e.fid===t.sort.fid&&delete t.sort,e.is_new&&2!=e.is_build_aggregated||(e.aggregator="number"===e.data_type?"SUM":"COUNT",e.aggregator_name=u[e.aggregator]),e.uniq_id||(e.uniq_id=+new Date)}function E(t){return t.hasClass("not-sortable")?(e.deleteField={},t.sortable.cancel(),!1):void 0}function O(e){var t=e.is_build_aggregated,a=e.dragFieldType,i=e.dragFieldFormula||"";return i=i.toLowerCase(),1!==t||"date"==a&&(i.indexOf("MAX_DATE")>=0||i.indexOf("max_date")>=0||i.indexOf("MIN_DATE")>=0||i.indexOf("min_date")>=0)?!0:!1}function B(t,a,i){var r=t.tb_fid,l=t.tb_name,n=t.tb_data_type,o=t.tb_new,d=t.is_build_aggregated,s=t.meta,_=s.chart_type,c=t.axis_field,g=bdpChart.getColorsByType(_,"bdp"),p=[].concat(s.y||[],s.y_optional||[]);if("x"===a)x(s),c.push({fid:r,uniq_id:+new Date+(i?i:0),name:l,data_type:n,is_new:o,is_build_aggregated:d,granularity:"day"});else if("compare_axis"===a){var f={fid:r,name:l,data_type:n,is_new:o,is_build_aggregated:d,granularity:"day"};if(_===bdpChart.ChartType.Table&&0===c.length){var u=et(0,"compare_axis");c.push(u)}c.push(f)}else{var h={check:"num",num:{digit:0,millesimal:!0},percent:{digit:0}},m=e.getDefaultAggr(s,n,d),y=($.extend(!0,{},c),{fid:r,uniq_id:+new Date+(i?i:0),name:l,data_type:n,is_new:o,is_build_aggregated:d,aggregator:m.aggregator,aggregator_name:m.name,formatter:1==o?"":["string","date","sub_date"].indexOf(n)>-1?h:""});if(_===bdpChart.ChartType.Table&&s.tb_statistic&&s.tb_statistic.row&&"right"==s.tb_statistic.row_pos&&"y"===a)c.splice(c.length-1,0,y);else{var C=p.some(function(e){return!!e.series_color});C&&(y.series_color=g[p.length%g.length]),c.push(y)}if(s.color_setting&&0===+s.color_setting.mode)return void S({meta:s,bindToMeta:!0,callback:function(){W(!1,"add",!1)}})}}function N(e){var t=e.y.concat(e.y_scatter);angular.forEach(t,function(e){e.aggregator||1==e.is_build_aggregated||(e.aggregator=M(e.data_type))})}function L(t){e.global.show_discrete="C280"===t.chart_type;for(var a=0;a<t.y.length;a++)if("string"===t.y[a].data_type||1==t.y[a].is_build_aggregated){e.global.show_discrete=!1;break}if(t.y_scatter)for(var i=0;i<t.y_scatter.length;i++)if("string"===t.y_scatter[i].data_type||1==t.y_scatter[i].is_build_aggregated){e.global.show_discrete=!1;break}}function M(e){switch(e){case"string":case"date":case"sub_date":return"COUNT";case"number":return"SUM";default:return""}}function Q(e){return[rt.BubbleMap,rt.AreaMap].indexOf(e)>-1}function R(e){return[rt.NStackColumn,rt.NStackBar,rt.NStackArea,rt.PStackColumn,rt.PStackBar,rt.PStackArea].indexOf(e)>-1}function Y(t){var a=e.chart_type;for(var i in t)if(t.hasOwnProperty(i))for(var r=0;r<a.length;r++)if(a[r].type==i){a[r].status=t[i];break}}function G(t,a){var i,r,l=e.chart_ops.meta.level[e.drill_level],n=l.x.length,o=l.compare_axis?l.compare_axis.length:0,d=l.y.length+(l.y_scatter?l.y_scatter.length:0)+(l.y_optional?l.y_optional.length:0),s=e.chart_ops.meta.level_fields.length;l.y.forEach(function(e){"virtual"===e.data_type&&d--});var _=2>=d&&0===o;if(l.show_y_axis_optional)return n>1?(r="C200",i={C210:!1,C211:!1,C212:!1,C220:!1,C230:!1,C240:!1,C241:!1,C242:!1,C200:!0,C250:!1,C261:!1,C271:!1,C272:!1,C280:!1,C290:!1,C300:!1,C310:!1,C320:!1,C330:!1,C340:!1,C350:!1,C351:!1,C352:!1,C360:!1,C370:!1}):0===n?(r=d>0?"C250":"",i={C210:d>0,C211:!1,C212:!1,C220:!1,C230:d>0,C240:d>0,C241:!1,C242:!1,C200:d>0,C250:d>0,C261:!1,C271:!1,C272:!1,C280:d>0&&_,C290:!1,C300:!1,C310:d>0,C320:d>0,C330:d>1&&0===o,C340:!1,C350:d>0,C351:!1,C352:!1,C360:!1,C370:!1}):(r="C250",i={C210:!0,C211:!0,C212:!0,C220:!0,C230:1===d,C240:!0,C241:!0,C242:!0,C200:!0,C250:!0,C261:!1,C271:!1,C272:!1,C280:_,C290:!0,C300:!1,C310:!1,C320:!1,C330:!1,C340:!1,C350:!0,C351:!0,C352:!0,C360:!1,C370:!1}),Y(i),{default_type:r,type_status:i};if(0===n&&0===d&&$("#chartBox").find(".chart").html(""),0===n)0===d?(i={C210:!1,C211:!1,C212:!1,C220:!1,C230:!1,C240:!1,C241:!1,C242:!1,C200:!1,C250:!1,C261:!1,C271:!1,C272:!1,C280:!1,C290:!1,C300:!1,C310:!1,C320:!1,C330:!1,C340:!1,C350:!1,C351:!1,C352:!1,C360:!1,C370:!1},Y(i)):(r="C200"===t&&a?"C200":"C210",i={C210:!0,C211:!1,C212:!1,C220:!1,C230:0===o,C240:!0,C241:!1,C242:!1,C200:!0,C250:d>1,C261:1===d,C271:!1,C272:!1,C280:_,C290:d>2&&o>0,C300:!1,C310:1===d||2===d,C320:d>1&&0===o,C330:d>1&&0===o,C340:!1,C350:!0,C351:!1,C352:!1,C360:!1,C370:!1},Y(i));else if(n>1){"C280"!==t&&(r="C200","C230"===t?r="C360":"C300"===t&&(t=0===o&&1===d?t:"C200"));var c=2===n;i={C210:c&&d>0,C211:c&&(d>1||1==d&&o>0),C212:c&&(d>1||1==d&&o>0),C220:c&&d>0,C230:!1,C240:c&&d>0,C241:c&&(d>1||1==d&&o>0),C242:c&&(d>1||1==d&&o>0),C200:!0,C250:!1,C261:!1,C271:!1,C272:!1,C280:_,C290:!1,C300:c&&1===d&&0===o,C310:!1,C320:c&&1===d&&0===o,C330:!1,C340:!1,C350:!1,C351:!1,C352:!1,C360:1===d&&0===o&&0===s,C370:2>d&&0===o&&0===s},Y(i)}else if(0===d)i={C210:!1,C211:!1,C212:!1,C220:!1,C230:!1,C240:!1,C241:!1,C242:!1,C200:!0,C250:!1,C261:!1,C271:!1,C272:!1,C280:_,C290:!1,C300:!1,C310:!1,C320:!1,C330:!1,C340:1==n&&0==o&&"date"!==l.x[0].data_type&&"sub_date"!==l.x[0].data_type,C350:!1,C351:!1,C352:!1,C360:!1,C370:0===o&&0===s},r="C200",Y(i);else if(1===d){if("C360"===t)r="C230";else if("C370"===t&&0===o)r="C370";else if("C200"===t&&"remove"===a)r="C200";else if("C230 C271 C272".indexOf(t)>=0){var g="string"===l.x[0].data_type&&0===o;"C230"===t?(r=0===o?t:"C200",t=0===o?t:"C200"):(r=g?t:"C200",t=g?t:"C200")}else"C240 C241 C242 C280 C290 C350 C351 C352".indexOf(t)<0&&(r="date"===l.x[0].data_type?"C220":"C210",t="date"===l.x[0].data_type?"C220":"C210");i={C210:!0,C211:o>0,C212:o>0,C220:!0,C230:0===o,C240:!0,C241:o>0,C242:o>0,C200:!0,C250:!1,C261:!1,C271:"string"===l.x[0].data_type&&0===o,C272:"string"===l.x[0].data_type&&0===o,C280:_,C290:!0,C300:!1,C310:!1,C320:0===o,C330:0===o,C340:!1,C350:!0,C351:o>0,C352:o>0,C360:!1,C370:0===o&&0===s},Y(i)}else"C230"===t&&(r="C212"),"C200"===t&&(a?r="C200":(r="date"===l.x[0].data_type?"C220":"C210",t=r)),i={C210:!0,C211:!0,C212:!0,C220:!0,C230:!1,C240:!0,C241:!0,C242:!0,C200:!0,C250:!0,C261:!1,C271:!1,C272:!1,C280:_,C290:!0,C300:!1,C310:!1,C320:!1,C330:!1,C340:!1,C350:!0,C351:!0,C352:!0,C360:!1,C370:!1},Y(i);return i[t]&&(r=t),{default_type:r,type_status:i}}function V(){return e.drill_level>=e.chart_ops.meta.level.length&&(e.drill_level=e.chart_ops.meta.level.length-1),e.chart_ops.meta.level[e.drill_level].chart_type}function W(t,a,i){var r=V(),l=bdpChart.ChartType,n=G(r,a),o=e.chart_ops.meta.level[e.drill_level];if(t&&""!==e.chart_type)return void z();if(n.default_type)o.chart_type=n.default_type;else for(var d in n.type_status)if(n.type_status.hasOwnProperty(d)){if(n.type_status[d]){o.chart_type=d;break}e.chart_ops.meta.level[e.drill_level].chart_type=""}if(r===l.Gauge&&o.chart_type!==l.Gauge&&delete o.tb_conditional_formatting,r===l.Scatter&&o.chart_type!==l.Scatter&&j(o),[l.Line,l.Area,l.NStackArea,l.PStackArea,l.Biax].indexOf(o.chart_type)>-1&&void 0===o.use_spline&&(o.use_spline="0"),o.chart_type===l.Pie&&(void 0===o.shape&&(o.shape="pie"),void 0===o.show_connector_label&&(o.show_connector_label=!0)),o.chart_type===l.Pie&&o.compare_axis&&o.compare_axis.length&&(delete o.shape,o.chart_type="C210"),[l.Sunburst,l.Sankey].indexOf(r)>-1&&[l.Sunburst,l.Sankey].indexOf(o.chart_type)<0&&delete o.color_setting,(o.y.length>1||o.chart_type===l.Biax||o.compare_axis&&o.compare_axis.length)&&o.color_setting&&!$.isEmptyObject(o.color_setting)&&1==o.color_setting.mode&&delete o.color_setting,tt(o),o.sort)if("y"===o.sort.axis){for(var s=0,_=0;_<o.y.length;_++)if(o.y[_].uniq_id===o.sort.uniq_id){s=_;break}o.sort.col_index=o.x.length+s}else if("y_optional"===o.sort.axis){for(var s=0,_=0;_<o.y_optional.length;_++)if(o.y_optional[_].uniq_id===o.sort.uniq_id){s=_;break}o.sort.col_index=o.x.length+o.y.length+s}F(o),i?H({set_warn:!0}):H()}function j(e){e.y=e.y_scatter?e.y.concat(e.y_scatter):[];for(var t=0,a=e.y.length;a>t;t++){var i=e.y[t];""==i.aggregator&&1!=i.is_build_aggregated&&(i.aggregator=M(i.data_type),i.aggregator_name=u[i.aggregator]||"")}delete e.y_scatter}function H(t){function a(e){function t(e,t){for(var a=0,i=e.length;i>a;a++){var r=e[a];if(r&&t.fid==r.fid&&(t.uniq_id==r.uniq_id||"virtual"==r.data_type))return!0}return!1}function a(e,t){for(var a=0,i=e.length;i>a;a++){var r=e[a];if(r&&t.fid==r.fid)return!0}return!1}!$.isEmptyObject(e.sort)&&"y"==e.sort.axis&&e.sort.uniq_id&&(t(e.y.concat(e.y_optional||[]),e.sort)||(e.sort={})),$.isEmptyObject(e.sort)||"x"!=e.sort.axis||a(e.x,e.sort)||(e.sort={})}function i(e){t&&1==t.is_advanced_sort&&(e.is_advanced_sort=1)}var r=e.chart_ops.meta.level[0].y[0];if(!D())return!1;"C310"===e.chart_ops.meta.level[0].chart_type&&(e.chart_ops.name=r.nick_name?r.nick_name:r.name,$(".nick-name-value").text(e.chart_ops.name),$(".set-layer-title").remove());var d=e.chart_ops.meta.level[e.drill_level],s=d.y,_=s[0],g=s[s.length-1],p=null;if("right"==t){if(g&&"row_summary"!=g.fid){var p=s.shift();s.push(p)}}else if("left"==t&&_&&"row_summary"!=_.fid){var p=s.pop();s.unshift(p)}var f=$.extend(!0,{only_save_meta:!1,only_redraw:!1,not_need_redraw:!1,only_refresh_data:!1,closeDialog:!0,is_drill_chart:!!e.drill_level,callback:null},t);f.is_drill_chart||$(".drill-crumbs").remove();var u=e.chart_ops.meta;e.serviceFilterList={};for(var h=d.chart_type,m=0;m<d.x.length;m++)delete d.x[m].show_formula;if(d.compare_axis)for(var m=0;m<d.compare_axis.length;m++)delete d.compare_axis[m].show_formula;for(var y=0;y<d.y.length;y++)delete d.y[y].show_formula;if(d.y_optional)for(var C=0;C<d.y_optional.length;C++)delete d.y_optional[C].show_formula;if(d.y_scatter)for(C=0;C<d.y_scatter.length;C++)delete d.y_scatter[C].show_formula;if(d.color_setting&&(delete d.color_setting.is_series,$.isEmptyObject(d.color_setting)&&delete d.color_setting),"C200"!=h&&d.x.length>0&&"date"==d.x[0].data_type&&(d.sort={}),h===rt.Pie)d.title_formula="TOTAL",(0===d.x.length||d.color_setting&&d.color_setting.field&&d.color_setting.field[0].fid!==d.x[0].fid)&&delete d.color_setting;else if(h===rt.Sankey){if(!d.sankey_setting)for(var m=0;m<e.field_list.length;m++)if(["string","number"].indexOf(e.field_list[m].data_type)>-1){d.sankey_setting={relate_field_fid:e.field_list[m].fid};break}}else h===rt.KPICard&&(e.chart_ops.name=r.nick_name?r.nick_name:r.name,d.split_compare=d.compare_axis&&d.compare_axis.length>0);h===rt.WordCloud?d.word_count||(d.color_setting=U(d),d.word_count=e.maxWordCount,d.smart=!0,d.top&&(d.top.enabled=!1)):(delete d.word_count,delete d.smart,e.wordCloudValues=null,d.color_setting&&d.color_setting.noSet&&delete d.color_setting),[rt.Gauge].indexOf(h)>-1&&(d.split_compare=d.compare_axis&&d.compare_axis.length>0,d.tb_conditional_formatting&&0===d.tb_conditional_formatting.length&&(delete d.tb_conditional_formatting,d.y[0].series_color||(d.y[0].series_color="#A3ABB0")));var v=function(e){for(var t=d[e],a=0;a<t.length;a++)(t[a].YoY||t[a].QoQ)&&(t[a].formatter={check:"num",num:{digit:2,millesimal:!0},percent:{digit:0}}),delete t[a].YoY,delete t[a].QoQ,delete t[a].yoyQoqType,t[a].yoyQoqSetting&&"custom"===t[a].yoyQoqSetting.type&&delete t[a].yoyQoqSetting},b=function(e){for(var t=0;t<d[e].length;t++){var a=d[e][t],i=a.yoyQoqSetting;if(i){if("custom"===i.type)return;a.formatter={check:"num",num:{digit:2,millesimal:!0},percent:{digit:0}}}delete a.yoyQoqSetting}},x=function(e){for(var t,a=0;a<d[e].length;a++)t=d[e][a],t.advance_aggregator&&["moving","running"].indexOf(t.advance_aggregator.type)>-1&&(delete t.advance_aggregator,delete t.formatter)},w=function(e,t){for(var a=d[e],i=0;i<a.length;i++)a[i].advance_aggregator&&["retention","repetition"].indexOf(a[i].advance_aggregator.type)>-1&&(a[i].advance_aggregator.setting.date_field_type=t)};if(0===d.x.length?(v("y"),x("y"),"C250"===h&&d.y_optional&&(v("y_optional"),x("y_optional"))):d.x.length>=1&&("date"!==u.level[0].x[0].data_type?(v("y"),"C250"===h&&d.y_optional&&v("y_optional")):(b("y"),w("y",d.x[0].granularity),"C250"===h&&d.y_optional&&(b("y_optional"),w("y_optional",d.x[0].granularity)))),"C250"==h)for(var F=0;2>F;F++)"C212"===d.type_optional[F]&&angular.forEach(e.warnSetting.info,function(t,a){t.axis_type===F&&c.get("/api/warn/delete",{ct_id:l.chartId,warn_id:t.warn_id}).then(function(){e.warnSetting.info.splice(a,1),f.set_warn=!0})});angular.forEach(u.filter_list,function(e){e.total>100&&e.is_config&&0==e.range.length&&(e.is_all=!0,e.is_config=!1)}),i(d),a(d),L(d);d.y.map(function(e){if(e.BDP_TCF&&d.tb_conditional_formatting)for(var t=d.tb_conditional_formatting.length-1;t>=0;t--){var a=d.tb_conditional_formatting[t];a.uniq_id===e.uniq_id&&a.fid===e.fid&&d.tb_conditional_formatting.splice(t,1)}}),d.tb_conditional_formatting&&!d.tb_conditional_formatting.length&&delete d.tb_conditional_formatting;var T=angular.copy(u);K(T),e.loadingData=!0;var S={ct_id:ot,data:angular.toJson({meta:T,name:e.chart_ops.name||e.tips["chart.untitledChart"],tb_id:e.chart_ops.tb_id,description:e.chart_ops.description||""})};return o.chart.modify(S).success(function(a){if("0"===a.status){if(at(),f.closeDialog&&n.closeAll(),f.callback&&"function"==typeof f.callback&&f.callback(a),f.only_save_meta)return;if(e.serviceFilterList=angular.copy(u.filter_list),f.only_redraw){var i=e.$bdpChart;R(i.getChartType())&&i.chartData.y.reverse(),i.updateInfo(d,!0)}else f.is_drill_chart&&!f.not_need_redraw?e.draw_chart_url.options._t=(new Date).getTime():f.not_need_redraw?e.loadingData=!1:z();if(t&&(t.set_warn||t.getChartInfo)){var r=t?{set_warn:t.set_warn,getChartInfo:t.getChartInfo}:{};J(r)}e.orginChartTile=e.chart_ops.name}else 90101==a.status?n.openConfirm({templateUrl:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-320",data:{title:e.tips.tips,message:a.errstr,okValue:e.tips["wb.gotIt"],hideCancel:!0}}).then(function(){e.changeRoute()}):errorHandle(a)})}function U(e){var t=e.x[0],a={field:[t],aggregator:"",mode:"0",theme:"default",noSet:!0};return a}function K(a){angular.forEach(a.level,function(a,i){for(var r=a.chart_type,l=a.y,n=e.chart_ops.meta.level[i],o=0;o<l.length;o++)defined(l[o])||l.splice(o,1);angular.forEach(l,function(e){"MED"===e.aggregator?(e.aggregator="PERCENT",e.percent="0.5"):e.aggregator&&e.aggregator.indexOf("PERCENT")>=0&&(e.aggregator="PERCENT")}),a.compare_axis&&a.compare_axis.length&&a.split_compare?a.color_setting&&$.isEmptyObject(a.color_setting.enum_color_map)&&delete a.color_setting:(a.split_compare=!1,delete a.split_compare_setting);var d=a.y_optional;if(angular.forEach(d,function(e){"MED"===e.aggregator?(e.aggregator="PERCENT",e.percent="0.5"):e.aggregator&&e.aggregator.indexOf("PERCENT")>=0&&(e.aggregator="PERCENT")}),a.hasOwnProperty("y_scatter")){var s=a.y_scatter;angular.forEach(s,function(e){"MED"===e.aggregator?(e.aggregator="PERCENT",e.percent="0.5"):e.aggregator&&e.aggregator.indexOf("PERCENT")>=0&&(e.aggregator="PERCENT")})}if("C271"!==r&&"C272"!==r?delete a.map:a.map||(a.map={granularity:"province",region:1}),"C261"!==r&&(delete a.gauge_setting,delete n.gauge_setting),"C300"!==r&&delete a.sankey_setting,"C320"!==r?delete a.waterfall_setting:("C320"===n.chart_type&&(n.waterfall_setting||(n.series_theme="green_contrast_2",n.waterfall_setting={show_sum:!n.x.length||"date"!==n.x[0].data_type,sum_name:"en"===t.language?"Sum":"累计值",color_theme:bdpChart.getColorsByType("C320","bdp")})),a.waterfall_setting?(a.waterfall_setting.sum_name||(a.waterfall_setting.sum_name="en"===e.$parent.language?"Sum":"累计值"),defined(a.waterfall_setting.color_theme)||(a.waterfall_setting.color_theme=bdpChart.getColorsByType("C320","bdp"))):a.waterfall_setting={show_sum:!a.x.length||"date"!==a.x[0].data_type,sum_name:"en"===e.$parent.language?"Sum":"累计值",color_theme:bdpChart.getColorsByType("C320","bdp")}),"C200"!==r)delete a.tb_statistic,delete a.tb_flip,delete a.tb_pinned_index,delete n.tb_pinned_index,delete n.tb_statistic,delete a.compare_setting;else{void 0===n.tb_merge_cell&&(n.tb_merge_cell=!0);for(var _,c=a.compare_axis||[],o=0;o<c.length;o++){var g=c[o];if("virtual"===g.data_type){_=o;break}}void 0!==_?(a.compare_setting={sort:{index:_}},c.splice(_,1)):delete a.compare_setting,_=void 0;for(var p=a.y||[],o=0;o<p.length;o++){var g=p[o];if("virtual"===g.data_type){_=o;break}}void 0!==_?(a.tb_statistic.row_setting&&(a.tb_statistic.row_setting.pos=_),p.splice(_,1)):a.tb_statistic&&(a.tb_statistic.row_setting={})}"C280"===r||a.y_scatter&&i==e.drill_level?(a.scatter_setting.x_len=a.y.length,a.y=a.y.concat(a.y_scatter||[]),delete a.y_scatter):a.guide_line_x&&a.guide_line_x.length&&(a.guide_line=[].concat(a.guide_line_x),delete a.guide_line_x),"C330"!==r?delete a.funnel_setting:("C330"===n.chart_type&&(n.funnel_setting||(n.funnel_setting={show_detail:!0,layout:"vertical"}),ht.clearAdvance(n.y),ht.clearAdvance(n.y_optional)),ht.clearAdvance(a.y),ht.clearAdvance(a.y_optional),a.funnel_setting||(a.funnel_setting={show_detail:!0,layout:"vertical"})),"C360"!==r?(delete a.sunburst_setting,delete a.sunburst_color_setting):"C360"===n.chart_type&&(n.sunburst_setting||(n.sunburst_setting={show_detail:!0,showProportion:"text"})),r!==rt.Pie&&delete a.show_connector_label,r!==rt.TreeMap&&a.data_label_setting&&a.data_label_setting.show_percent&&delete a.data_label_setting.show_percent,tt(a,"save")}),angular.forEach(a.filter_list,function(e){"date"!=e.data_type&&(e.range=[])})}function z(){e.draw_chart_url?(e.draw_chart_url.options._t=(new Date).getTime(),e.draw_chart_url.options.optional={},t.wsId&&(e.draw_chart_url.options.ws_id=t.wsId)):(e.draw_chart_url={options:{theme:1===+t.usedThemeId?"dark":"default",ct_id:ot,optional:{}},lazyload:!1},t.wsId&&(e.draw_chart_url.options.ws_id=t.wsId))}function J(a){e.filterRangeList=e.filterRangeList||{},o.chart.getInfo(ot).success(function(i){if(a&&(a.set_warn||a.getChartInfo)&&"innerFilter"==a.getChartInfo)return void(e.chart_ops.meta.filter_list_inner=i.result.meta.filter_list_inner);if("0"==i.status){if("chart_edit"===t.view&&e.advDateService&&e.advDateService.list(ot),X(i.result.meta),Z(i.result),e.serviceFilterList=angular.copy(i.result.meta.filter_list),!i.result.update_time||!i.result.meta.hasOwnProperty("level")){e.isCreate=!0;try{var r=window.localStorage;0!=Object.keys(response.result.meta)||Number(r.getItem(yt))||e.show_user_guide()}catch(l){}}}else errorHandle(i)})}function X(t){var a=t.level;angular.forEach(a,function(t){for(var a=t.y,i=0;i<a.length;i++)defined(a[i])||a.splice(i,1);angular.forEach(a,function(t){e.formatFieldPercentile(t)})})}function Z(a){var i=a;e.pageInfo={},e.warnSetting={warn:i.warn,info:i.warn_info};var r={name:i.name||void 0,description:i.description,tb_id:i.tb_id||"",meta:{level_fields:[],level:[],filter_list:[],filter_list_inner:[]}};e.tb_id=i.tb_id,o.field.getList(i.tb_id).then(function(t){"0"==t.status&&(e.field_list=t.result.schema,e.fidToName={},e.tbType=t.result.tb_type,e.field_list=bdp.utils.addSpecParamsToFields(e.field_list),e.setDimensionAndMeasureStatus())}),e.chart_ops=r,r.meta=$.extend(!0,{},r.meta,angular.fromJson(i.meta)),r.meta.level[e.drill_level]&&r.meta.level[e.drill_level].chart_type||(r.meta.level[e.drill_level]={x:[],y:[],yaxis_max:0,yaxis_min:0,yaxis_max_disabled:!0,yaxis_min_disabled:!0,type_optional:["C210","C220"]});var l=r.meta.level[e.drill_level],n=l.chart_type;if(l.map?l.map.region||(l.map.region=1):l.map={granularity:"province",region:1},r.meta.level[0].show_y_axis_optional=!!r.meta.level[0].y_optional||!1,r.meta.level[0].show_y_axis_optional&&(e.pageInfo.type="double_y"),n===rt.Pie)void 0===l.shape&&(l.shape="pie"),l.pieContent&&"text"===l.pieContent.showProportion&&(l.show_connector_label=!0,delete l.pieContent);else if([rt.Line,rt.Area,rt.NStackArea,rt.PStackArea,rt.Biax].indexOf(n)>-1)void 0===l.use_spline&&(l.use_spline="0");else if(n===rt.Waterfall)l.waterfall_setting||(l.series_theme="green_contrast_2",l.waterfall_setting={show_sum:!0,sum_name:"en"===t.language?"Sum":"累计值",color_theme:bdpChart.getColorsByType("C320","bdp")});else if(n===rt.Funnel)l.funnel_setting||(l.funnel_setting={layout:"vertical"});else if(n===rt.Sunburst)l.sunburst_setting||(l.sunburst_setting={showProportion:"text"});else if(n===rt.TreeMap)l.data_label_setting||(l.data_label_setting={show_percent:!1});else if(n===rt.Gauge){if(!l.y[0].series_color&&!l.tb_conditional_formatting){var d=l.y[0].fid,s=l.y[0].uniq_id;l.y[0].BDP_TCF=!0,l.tb_conditional_formatting=[{fid:d,uniq_id:s,operator:4,value:1,isPercentage:[!0],style:{backgroundColor:"#40A276"}},{fid:d,uniq_id:s,operator:12,value:[.75,1],isPercentage:[!0,!0],style:{backgroundColor:"#F6CC4E"}},{fid:d,uniq_id:s,operator:12,value:[.25,.75],isPercentage:[!0,!0],style:{backgroundColor:"#F38000"}},{fid:d,uniq_id:s,operator:3,value:.25,isPercentage:[!0],style:{backgroundColor:"#EE4B4B"}}]}}else if(n===rt.KPICard){if(e.chart_ops.name=l.y[0].nick_name||l.y[0].name,!(l.tb_conditional_formatting&&l.tb_conditional_formatting.length||!l.y[1]||l.y[1].series_color)){var _=l.y[1].fid,c=l.y[1].uniq_id;l.y[0].BDP_TCF=!1,l.y[1].BDP_TCF=!0,l.tb_conditional_formatting=[{fid:_,uniq_id:c,operator:3,value:0,shape_type:"arrow-down",style:{color:"#40B27E"}},{fid:_,uniq_id:c,operator:0,value:0,shape_type:"arrow-equal",style:{color:"#A3ABB0"}},{fid:_,uniq_id:c,operator:2,value:0,shape_type:"arrow-up",style:{color:"#EF4B4A"}}]}}else if(n===rt.Scatter){var g=l.scatter_setting?l.scatter_setting.x_len:1;"number"!=typeof g&&(g=1),l.y_scatter=l.y.slice(g),l.y=l.y.slice(0,g)}else if(n===rt.Table){void 0===l.tb_merge_cell&&(l.tb_merge_cell=!0);var p=l.compare_axis;if(p&&p.length>0){var f;l.compare_setting&&l.compare_setting.sort?f=l.compare_setting.sort.index||0:(f=0,l.compare_setting={sort:{index:f}});var u=et(f,"compare_axis");p.splice(f,0,u)}if(l.tb_statistic&&l.tb_statistic.row&&l.y.length>0){if(!l.tb_statistic.row_setting){var h={check:"num",num:{digit:0,millesimal:!0},percent:{digit:0}},m=+new Date;l.tb_statistic.row_setting={pos:l.y.length,formatter:h,nick_name:"",unit_adv:"",description:"",uniq_id:m}}var y=l.tb_statistic.row_setting,C=l.y||[],f=y.pos,v=y.uniq_id,u=et(f,"y",v);C.splice(f,0,u)}}e.canSetSplitCompare(n)&&l.split_compare&&!l.split_compare_setting&&(l.split_compare_setting={rows:4,cols:4}),l.top&&(l.top.value=+l.top.value),l.top_compare&&(l.top_compare.value=+l.top_compare.value),defined(l.fullscreen_granularity)||(l.fullscreen_granularity=!0),defined(l.show_total)||(l.show_total=!0),W(!0,"");var b=e.chart_ops.meta.filter_list;angular.forEach(b,function(t,a){"number"===t.data_type&&o.field.getRange(e.tb_id,t.fid,ot).success(function(t){0==t.status&&(e.initNumRange["n"+a]={},e.initNumRange["n"+a].a=t.result.range[0],e.initNumRange["n"+a].b=t.result.range[1])})}),L(l),e.viewMeta=l,at()}function et(t,a,i){var r=e.chart_ops.meta.level[e.drill_level];t=t||0;var l,n="",o="",d={},s="",_="",c="";if("compare_axis"==a)l="zh"===bdpChart.language?"数值":"Metrics";else if("y"==a){var g=r.tb_statistic&&r.tb_statistic.row_setting;l="zh"===bdpChart.language?"总计":"Summary",n="total",o="row_summary",g&&(d=angular.copy(g.formatter||{}),s=g.nick_name,_=g.unit_adv,c=g.description)}return{data_type:"virtual",name:l,index:t,flag:n,fid:o,uniq_id:i,formatter:d,nick_name:s,unit_adv:_,description:c}}function tt(e,t,a){function i(i){for(var n,o=e[i]||[],d=et(0,i,a),s=0,_=0;_<o.length;_++)if("virtual"===o[_].data_type){n=_;break}e.chart_type===bdpChart.ChartType.Table&&"save"!==t?i==r?o.length>0&&void 0===n?(i==r&&e.compare_setting&&e.compare_setting.sort&&(s=e.compare_setting.sort.index||0),o.splice(s,0,d)):1===o.length&&0===n&&o.splice(0,1):i==l&&(e.tb_statistic&&e.tb_statistic.row&&void 0===n?(s=e.tb_statistic.row_setting&&e.tb_statistic.row_setting.pos||0,o.splice(s,0,d)):void 0!==n&&(e.tb_statistic.row||o.splice(n,1),e.tb_statistic.row_setting&&(e.tb_statistic.row_setting.pos=n))):void 0!==n&&(o.splice(n,1),e.tb_statistic&&e.tb_statistic.row_setting&&(e.tb_statistic.row_setting.pos=n))}var r="compare_axis",l="y";i(r),i(l)}function at(){e.conditionDemoText=["C200","C310"].indexOf(e.chart_ops.meta.level[e.drill_level].chart_type)>-1?"A":""}function it(){var t=(e.chart_ops.meta.level[e.drill_level].chart_type,e.chart_ops.meta.level_fields.length>1,$(".chart-args").height()+4);$(".chart-left-side").css("top",t),$(".toggle-nav").css("top",t),$("#chartBox").css("top",t),$(".J-toggle-nav-chart-left").css("top",0)}var rt=bdpChart.ChartType;e.ChartType=rt;var lt,nt,ot;lt=l.projId,nt=l.dashId,ot=l.chartId,t.view="chart_edit",t.show_bdp_header=!1,t.projectLoaded=!1,e.chartid=ot,$.cookie("edit_chart_id",ot),e.chart_type=d,e.chart_type_tip=s,e.ct_id=ot,e.formulaKeyMap=u,e.formatFieldPercentile=y,e.$on("emitChangeTableFormatting",function(){e.$broadcast("broadcastChangeTableFormattingName",!0)}),e.maxWordCount=100,e.hasShownVirtualFieldHint="1"===$.cookie("virtual_field_hint_showed"),e.turnOffVirtualFieldHint=function(){e.hasShownVirtualFieldHint=!0,$.cookie("virtual_field_hint_showed",1)},e.$on("afterWindowResize",function(){if(e.$bdpChart){var t=e.$bdpChart;t.getChartType()===rt.Line&&"dark"===t.theme&&(t.destroy(),t.renderChart())}}),$(window).on("resize.renderChart",$.debounce(300,function(){if("chart_edit"===t.view&&e.$bdpChart){var a=e.$bdpChart;(a.isSplitChart()||a.getChartType()===bdpChart.ChartType.Line&&"dark"===a.theme)&&a.renderChart()}})),e.$on("$destroy",function(){$(window).off("resize.renderChart")});var dt=$(".J_field_search"),st=$(".J_chart_data_info"),_t=$(".J_view_header"),ct=$(".J_field_list"),gt=0,pt=0,ft=0;$(".J_chart_left").on("scroll.fieldSearch",function(e){var t=$(e.target),a=t.scrollTop();gt="none"==st.css("display")?0:st.height(),pt=pt||_t.height(),ft=ft||dt.height(),a>=gt?(dt.css({position:"fixed",width:"174",top:pt,zIndex:99999}),ct.css({marginTop:ft+20+"px"}),dt.attr("data-isceil",1),dt.addClass("field-search-cover")):(dt.css({position:"relative",top:"auto",width:"auto"}),ct.css({"margin-top":"8px"}),dt.attr("data-isceil",0),dt.removeClass("field-search-cover"))}),e.changeRoute=function(){t.creatingChart&&(t.creatingChartInfo=e.chart_ops.meta.level[0]),t.$editable=!0,r.path(v())},e.canSetLeftAxis=function(){var t=e.selected_type;return t&&["C200","C230","C261","C271","C272","C290","C300","C310","C330","C340","C360","C370"].indexOf(t)<0},e.canSetRightAxis=function(){var t=e.selected_type;return t&&"C250"===t},e.canSetPlotLine=function(){var t=e.selected_type;return t&&["C230","C200","C271","C272","C290","C300","C310","C320","C330","C340","C360","C370"].indexOf(t)<0},e.canSetConditionFormat=function(){var t=e.selected_type;return t&&["C261","C200","C310"].indexOf(t)>-1},e.canSetChartDataLabels=function(){var t=e.selected_type;return t&&["C200","C230","C261","C280","C300","C310","C340","C400"].indexOf(t)<0},e.canSetRate=function(){var t=e.selected_type;return t&&["C370"].indexOf(t)>-1},e.canSetWarnLine=function(){var t=e.selected_type,a=e.drill_level||0;return t&&["C212","C230","C242","C271","C290","C300","C310","C320","C330","C340","C352","C360","C370"].indexOf(t)<0&&1>a},e.canSetTop=function(){var t=e.selected_type,a=!1;return t&&(a=["C220","C261","C271","C272","C300","C310","C320","C330","C340"].indexOf(t)<0),a},e.canSetNavigator=function(){var t=e.selected_type,a=!1;if(t){var i=e.chart_ops.meta.level[e.drill_level];a=[rt.Line,rt.Column,rt.NStackColumn,rt.PStackColumn,rt.Sankey,rt.Area,rt.NStackArea,rt.PStackArea,rt.Biax].indexOf(t)>-1&&i.x.length>0&&!i.split_compare&&e.$bdpChart.data.y[0]&&e.$bdpChart.data.y[0].data.length>1}return a},e.canDrawMarkPoint=function(){var t=e.selected_type,a=!1;if(t){var i=e.chart_ops.meta.level[e.drill_level];a=["C210","C211","C212","C220","C240","C241","C242","C250","C320","C350","C351","C352","C360"].indexOf(t)>-1&&1===i.x.length&&(!i.compare_axis||0===i.compare_axis.length)}return a},e.canSetSplitCompare=function(t){var a=t||e.selected_type,i=!1;if(a){var r=e.chart_ops.meta.level[e.drill_level];i=[rt.Line,rt.Area,rt.Column,rt.Bar,rt.KPICard,rt.Gauge].indexOf(a)>-1&&r.compare_axis&&r.compare_axis.length>0}return i},e.canSetSummaryDisplay=function(){var t=e.$bdpChart&&e.$bdpChart.info;if(t)var a=t.xAxis.length||0,i=t.yAxis.length||0,r=t.compare_axis.length||0;var l=e.selected_type,n=null;if(l){var o=e.chart_ops.meta.level[e.drill_level];n="C200 C230 C250 C261 C271 C300 C310 C330".indexOf(l)<0&&!o.split_compare&&(1==a||0==a)&&1==i&&0==r
}return n},e.needShowSplitCompareGuide=function(){var t=e.selected_type;return"C310"!==t&&"C261"!==t&&localStorage&&!localStorage.getItem("BDP_showSplitCompareGuide")},e.hideSplitCompareGuide=function(){e.hasShowedSplitCompareGuide=!0,localStorage.setItem("BDP_showSplitCompareGuide",1)},e.saveSplitCompareSetting=function(t){var a=e.chart_ops.meta.level[e.drill_level];a.split_compare_setting[t]||(a.split_compare_setting[t]=6),e.saveChartImmediate({only_redraw:!0})},e.newField={},e.handlerMorePos=function(e){var t=document.body.clientHeight,a=$(e.target).offset(),i=($(".field-list").height(),a.top+20),r=a.left-50;i+120>t&&(i-=140),angular.element(".field-editable-handler-more").css({top:i,left:r}),e.stopPropagation()},e.modifyField=function(a){t.pageLoading=!0,e.newField=angular.extend({aggregator:a.formula,original_field_name:a.name},a,{type:"modify",tb_id:e.tb_id,ct_id:ot});var i="ngdialog-theme-default add-field-dialog",r="/static/partials/add_field.html";a.hasOwnProperty("param")&&"group"==a.param.type&&(r="/static/partials/field_groups.html",i+=" group-field-dialog"),n.open({template:r,data:{fieldList:e.field_list},className:i,scope:e})},e.createFieldFormula=function(){t.pageLoading=!0,e.newField={type:"create",name:"",aggregator:""};var a="/static/partials/add_field.html";n.open({template:a,data:{fieldList:e.field_list},className:"ngdialog-theme-default add-field-dialog",scope:e})},e.createFieldGroup=function(){t.pageLoading=!0,e.newField={type:"create",name:"",aggregator:"",tb_id:e.tb_id,ct_id:ot};var a="/static/partials/field_groups.html";n.open({template:a,data:{fieldList:e.field_list},className:"ngdialog-theme-default add-field-dialog group-field-dialog",scope:e})},e.setFieldType=function(){e.field_list=bdp.utils.addSpecParamsToFields(e.field_list),e.fidToName={},angular.forEach(e.field_list,function(t){e.fidToName[t.fid]=t.name})},e.setDimensionAndMeasureStatus=function(){angular.forEach(e.field_list,function(t){"dimension"==t.type?e.field_list.hasDimension=!0:"measure"==t.type&&(e.field_list.hasMeasure=!0),e.fidToName[t.fid]=t.name})},e.addCalcField=function(t){e.dataInfo.length>1&&!t.data_type&&(t.data_type="number"),e.global.clickComplete=!1;var a=!1;return t.name?t.data_type||t.param?t.aggregator.trim()||t.param&&"group"==t.param.type||(_(e.tips["field.fieldFormulaRequired"]),a=!0):(_(e.tips["field.fieldTypeRequired"]),a=!0):(_(e.tips["field.fieldNameRequired"]),a=!0),a?(e.global.clickComplete=!0,!1):void o.field["create"===t.type?"create":"modify"]({tb_id:e.tb_id,original_field_name:t.original_field_name||"",new_field_name:t.name,aggregator:t.aggregator.trim(),data_type:t.data_type,param:angular.toJson(t.param),fid:t.fid||""}).success(function(a){e.global.clickComplete=!0,0==a.status?(n.closeAll(),o.field.getList(e.tb_id).then(function(a){if(0==a.status){a=a.result,e.field_list=a.schema,e.setFieldType(),e.setDimensionAndMeasureStatus();for(var i=0,r=e.field_list.length;r>i;i++)if(t.fid==e.field_list[i].fid){t.name=e.field_list[i].name,t.is_build_aggregated=e.field_list[i].is_build_aggregated;break}if("modify"==t.type){for(var i=0;i<e.chart_ops.meta.level.length;i++){if(e.chart_ops.meta.level[i].x)for(var l=0;l<e.chart_ops.meta.level[i].x.length;l++)if(e.chart_ops.meta.level[i].x[l].fid==t.fid){e.chart_ops.meta.level[i].x[l].name=t.name;break}if(e.chart_ops.meta.level[i].y)for(var n=t.is_build_aggregated,o=e.chart_ops.meta.level[i],d=0;d<o.y.length;d++)if(o.y[d].fid==t.fid){o.y[d].name=t.name,o.y[d].is_build_aggregated=n,o.y[d].aggregator=2==n?"number"===o.y[d].data_type?"SUM":"COUNT":"";break}if(e.chart_ops.meta.level[i].y_optional)for(var n=t.is_build_aggregated,o=e.chart_ops.meta.level[i],s=0;s<o.y_optional.length;s++)if(o.y_optional[s].fid==t.fid){o.y_optional[s].name=t.name,o.y_optional[s].is_build_aggregated=n,o.y_optional[s].aggregator=2==n?"number"===o.y_optional[s].data_type?"SUM":"COUNT":"";break}}if(e.chart_ops.meta.level_fields)for(var i=0;i<e.chart_ops.meta.level_fields.length;i++)e.chart_ops.meta.level_fields[i].fid==t.fid&&(e.chart_ops.meta.level_fields[i].name=t.name);var _=k(e.newField.fid);e.saveChartImmediate({not_need_redraw:_})}e.global.watch=new Date}})):_("7700"==a.status?isObjectEmpty(t.param)?e.tips["field.formulaInvalid"]:e.tips["field.groupInvalid"]:"40005"==a.status?a.errstr:Number(a.status))})},e.delNewField=function(t,a){function i(){o.field.del(a,e.tb_id).success(function(t){0==t.status?(o.field.getList(e.tb_id).then(function(t){0==t.status&&(t=t.result,e.field_list=t.schema,e.setFieldType(),e.setDimensionAndMeasureStatus())}),e.global.watch=new Date):_("7590"==t.status?e.tips["chart.fieldInUsing"]:"40006"==t.status?t.errstr:Number(t.status))})}e.chart_ops.meta.gauge_setting&&t==e.chart_ops.meta.gauge_setting.goal.field_name?n.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:e.tips["chart.delGaugeField"]+": "+t+" ?"}}).then(function(){e.chart_ops.meta.gauge_setting.goal={value_type:"constant",value:$.cookie("yaxis_max")},e.saveChartImmediate(),i()}):n.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:e.tips["chart.delField"]+": "+t+" ?"}}).then(function(){i()})},e.onSaveEnumOrder=function(t){var a=k(t);e.saveChartImmediate({not_need_redraw:a})},e.showEnumOrder=function(t,a,i){n.open({template:"/static/partials/dialogTemplates/enum_order.html",data:{fid:t,tb_id:e.tb_id,isCustomOrder:a,source:i},scope:e,controller:"enumOrderCtrl",className:"ngdialog-theme-default enum-order-dialog"})},e.verifyChartArgs=function(){D()&&(e.saveAfterCheckDirty({not_need_redraw:!0,only_refresh_data:!1}),e.changeRoute())},e.dragField={},e.dragTbFunc=function(t,a,i){e.removeFaild=!1,e.dragFlag="source",e.dragField=i,e.dragFieldFid=i.fid,e.dragFieldName=i.name,e.dragFieldType=i.data_type,e.dragFieldFormula=i.formula,e.dragFieldIsNew=void 0!=i.formula&&""!=i.formula,e.dragIsBuildAggregated=i.is_build_aggregated,angular.element(".chart-args,.chart-left-side").append('<div class="draggable-area"></div>')},e.stopDragField=function(){angular.element(".draggable-area").remove()},e.dragSubTbFunc=function(t,a,i,r){e.dragField={fid:i.fid+"_"+r,data_type:"sub_date",name:h[r]+"("+i.name+")"},e.dragFlag="source",e.dragFieldFid=i.fid+"_"+r,e.dragFieldType="sub_date",e.dragFieldIsNew=""!=i.formula,e.dragIsBuildAggregated=i.is_build_aggregated,e.dragFieldFormula=i.formula||"",e.removeFaild=!1,e.dragFieldName=h[r]+"("+i.name+")",angular.element(".chart-args,.chart-left-side").append('<div class="draggable-area"></div>')},e.setGranularity=function(t,a,i,r,l){var n=angular.element(t.target),o=n.parents(".data-tag").parents("li").index(),d=e.chart_ops.meta.level[e.drill_level],s=d[a],_=d.y,c=d.y_optional||[];s[o].granularity=r,s[o].granularity_name=l||"","x"===a&&(e.chart_ops.meta.level_fields.length>0&&(e.chart_ops.meta.level_fields[e.drill_level].granularity=r,e.chart_ops.meta.level_fields[e.drill_level].granularity_name=l||""),"date"===i.data_type&&0===o&&("hour"===r||"minute"===r||"second"===r?angular.forEach(_,function(e){delete e.YoY,delete e.QoQ,delete e.yoyQoqType,delete e.advance_aggregator}):(_.length>0&&P(r,_),c.length>0&&P(r,c))));var g=d.color_setting;if(g&&0===+g.mode){for(var p=0;p<g.field.length;p++)if(g.field[p].fid===i.fid){g.field.splice(p,1,i),delete g.enum_color_map;break}return void S({meta:d,reset:!0,bindToMeta:!0,callback:function(){e.saveChartImmediate()}})}e.saveChartImmediate()},e.showFormula=function(e){e.show_formula=!e.show_formula,$(".field-tip").css("display","none")},e.setDataShowType=function(t,a,i,r){{var l=angular.element(t.target),n=l.parents(".data-tag").parents("li").index(),o=e.chart_ops.meta.level[e.drill_level],d=o[a];o.y,o.y_optional||[]}d[n].data_show_type=r,"x"===a&&e.chart_ops.meta.level_fields.length>0&&(e.chart_ops.meta.level_fields[e.drill_level].data_show_type=r),e.saveChartImmediate()},e.join_field=function(t,a,i,r,l){if("source"===e.dragFlag){if(1===e.dragIsBuildAggregated)return _(e.tips["chart.buildAggregated"]),!1;if("C340"==e.selected_type||"C360"==e.selected_type||"C370"==e.selected_type)return void _(e.tips["chart.notdrill"]);var n=e.dragFieldFid,o=e.dragFieldName,d=e.dragFieldType,s=e.dragFieldIsNew,c=e.dragFieldFormula||"";if("x"===i||"drill"===i){var g={fid:n,name:o,data_type:d,is_new:s,nick_name:"",description:"",formula:c};if("date"===d&&(g.granularity="day"),"x"===i){if(0!==r)return alert(e.tips["chart.addDrillTip"]),!1;e.chart_ops.meta.level_fields.length||e.chart_ops.meta.level_fields.push(l)}e.chart_ops.meta.level_fields.push(g);var p=$.extend(!0,{},e.chart_ops.meta.level[0],{x:[g]});("C271"===p.chart_type||"C272"===p.chart_type)&&("string"===p.x[0].data_type?p.map={granularity:"city",region:"2"}:p.chart_type="C210"),("C280"==p.chart_type||p.y_scatter)&&(p.scatter_setting.x_len=p.y.length,p.y=p.y.concat(p.y_scatter),delete p.y_scatter),"C200"==p.chart_type&&(p.is_advanced_sort=0,p.advanced_sort=[]),e.chart_ops.meta.level.push(p),angular.element(".axis").find(".ico-remove").remove()}e.inheritInnerFilterOnDrill(),H({not_need_redraw:!1,only_refresh_data:!0,is_drill_chart:!!e.drill_level})}},e.inheritInnerFilterOnDrill=function(){var t=e.chart_ops.meta.level_fields.length,a=e.drill_level||0,i=e.chart_ops.meta.filter_list_inner,r=[];if(t>a)if(i instanceof Array){var l={};l[0]=i;for(var n=0;t>n;n++)0==n?l[n]=angular.copy(i):(r=angular.copy(i),angular.forEach(r,function(e){("number"==e.data_type||"number"!=e.data_type&&e.hasOwnProperty("aggregator"))&&(e.range=[])}),l[n]=r);e.chart_ops.meta.filter_list_inner=l}else r=angular.copy(i[0]),angular.forEach(r,function(e){("number"==e.data_type||"number"!=e.data_type&&e.hasOwnProperty("aggregator"))&&(e.range=[])}),i[t-1]=r},e.sortAxisField={start:function(t,a){e.dragFlag=t.target.id.replace("drag","").toLowerCase(),e.originDragFlag=angular.copy(e.dragFlag),e.originX=angular.copy(e.chart_ops.meta.level[e.drill_level].x),e.originY=angular.copy(e.chart_ops.meta.level[e.drill_level].y),e.originYoptional=angular.copy(e.chart_ops.meta.level[e.drill_level].y_optional);var i=a.item.sortable.model;!e.hasShownVirtualFieldHint&&i&&"virtual"===i.data_type&&e.turnOffVirtualFieldHint()},sort:function(e,t){angular.element(".ui-sortable-helper").css({width:$(this).width()+1});var a=angular.element(".ui-sortable-helper");q(e,t)?a.find(".ico-remove").length||a.find(".name").append('<i class="bdp-icon ico-remove"></i>'):a.find(".name").find(".ico-remove").remove()},over:function(){e.dragFlag=angular.element(".ui-sortable-placeholder").parent()[0].id.replace("drag","").toLowerCase()},beforeStop:function(t,a){var i=a.item.sortable.model,r=angular.element(".ui-sortable-placeholder").index()-1;e.deleteField=q(t,a)&&"virtual"!==i.data_type?{index:r,del:!0}:{index:r,del:!1}},update:function(t,a){var i=a.item.sortable.model,r=a.item.sortable.index,l=a.item.sortable.dropindex,n=e.chart_ops.meta.level[e.drill_level];if(e.doDragField=i,E(a.item),"virtual"===i.data_type)(e.originDragFlag!==e.dragFlag||"y"==e.originDragFlag)&&a.item.sortable.cancel();else if("y"==e.dragFlag&&n.tb_statistic&&n.tb_statistic.row){if(("y"==e.originDragFlag?n.y[n.y.length-1]&&"row_summary"==n.y[n.y.length-1].fid:n.y[n.y.length-2]&&"row_summary"==n.y[n.y.length-2].fid)&&l==n.y.length-1&&"right"==n.tb_statistic.row_pos){var o="y"==e.originDragFlag?n.y[n.y.length-1]:n.y[n.y.length-2],d=n.y[r];if("y"!=e.originDragFlag)n.y.splice(n.y.length-2,2,n.y[n.y.length-1],n.y[n.y.length-2]),I(i,n);else{var s=n.y.slice(0);s.splice(r,2),s.push(d,o),n.y=s.splice(0)}}if(("y"==e.originDragFlag?"row_summary"==n.y[0].fid:n.y[1]&&"row_summary"==n.y[1].fid)&&"left"==n.tb_statistic.row_pos&&0==l){var o="y"==e.originDragFlag?n.y[0]:n.y[1],d=n.y[r],s=n.y.slice(0);"y"==e.originDragFlag?(s.splice(r,1),s.shift(),s.unshift(o,d),n.y=s.slice(0)):(n.y.splice(0,2,n.y[1],n.y[0]),I(i,n))}}(!e.deleteField.del&&"x"===e.dragFlag||"compare_axis"===e.dragFlag)&&("y"===e.originDragFlag||"y_optional"===e.originDragFlag)&&1===i.is_build_aggregated&&(_("使用聚合函数的新字段无法做为"+("x"===e.dragFlag?"维度":"对比维度")+"使用"),a.item.sortable.cancel())},stop:function(t,a){var i=a.item.sortable.model,r=e.chart_ops.meta.level[e.drill_level],i=r[e.dragFlag][e.deleteField.index],l=(a.item.sortable.index,a.item.sortable.dropindex);if(E(a.item),void 0==l&&"x"!=e.dragFlag||"y"==e.originDragFlag&&("compare_axis"==e.dragFlag||"y"==e.dragFlag)||"compare_axis"==e.originDragFlag&&("y"==e.dragFlag||"compare_axis"==e.dragFlag)||x(r),"source"!==e.dragFlag){if(e.deleteField&&e.deleteField.del)return"x"==e.originDragFlag&&x(r),e.removeAxis({e:t,ui:a,delIndex:e.deleteField.index,dragFlag:e.dragFlag,originDragFlag:e.originDragFlag,dragField:i}),!1;if(i&&"virtual"!==i.data_type){if("x"===e.dragFlag||"compare_axis"===e.dragFlag){if(!i)return;delete i.aggregator,delete i.aggregator_name,delete i.YoY,delete i.QoQ,delete i.yoyQoqSetting,delete i.yoyQoqType,delete i.percentage,delete i.uniq_id,"date"===i.data_type&&(i.granularity="day"),b(r)}else["y","y_optional","y_scatter"].indexOf(e.dragFlag)>-1&&["x","compare_axis"].indexOf(e.originDragFlag)>-1&&I(i,r);W(!1,"remove",!1)}else("compare_axis"===e.dragFlag||"y"===e.dragFlag)&&(tt(r),H())}},appendTo:"body",helper:"clone",opacity:.6,"ui-floating":!0,items:".drag-item:not(.not-sortable)",connectWith:".drag-target-list-dimension"},e.sortAxisDrillField={start:function(){e.dragFlag="drill",e.originDragFieldIndex=angular.element(".ui-sortable-placeholder").index()-1},sort:function(e,t){var a=angular.element(".ui-sortable-helper");q(e,t)?a.find(".ico-remove").length||a.find(".name").append('<i class="bdp-icon ico-remove"></i>'):a.find(".name").find(".ico-remove").remove()},beforeStop:function(t,a){var i=angular.element(".ui-sortable-placeholder").index()-1;e.deleteField=q(t,a)?{index:i,del:!0}:{index:i,del:!1}},stop:function(t,a){var i=e.chart_ops.meta.level_fields[e.deleteField.index];if(e.drill_level=0,e.deleteField&&e.deleteField.del)return e.removeAxis({e:t,ui:a,delIndex:e.deleteField.index,dragFlag:"drill",dragField:i}),!1;var r=e.chart_ops.meta.level[e.originDragFieldIndex];e.chart_ops.meta.level.splice(e.originDragFieldIndex,1),e.chart_ops.meta.level.splice(e.deleteField.index,0,r),H()},appendTo:"body",helper:"clone",opacity:.6,"ui-floating":!0},e.batchOnDropAdd=function(t){return D()&&e.field_list&&0!=e.field_list.length?void n.open({template:"/static/partials/chart_batch_add_ondrop.html",className:"ngdialog-theme-default batch-add-axis-dialog",scope:e,data:{fieldList:e.field_list,axisType:t},controller:["$scope","$filter",function(e,t){e.fieldTypeList=[{type:"date",selected:!1},{type:"string",selected:!1},{type:"number",selected:!1}],e.initText={dialogFooterTip:function(t){switch(t){case"x":return e.tips["chart.batchAddTips"];case"y":return"";case"compare_axis":return e.tips["chart.batchAddTips"]}}(e.ngDialogData.axisType),dialogTitleKeyWord:function(t){switch(t){case"x":return e.tips["chart.addFieldsToAxisX"];case"y":return e.tips["chart.addFieldsToAxisY"];case"compare_axis":return e.tips["chart.addFieldsToAxisCampar"]}}(e.ngDialogData.axisType)},e.axisType=e.ngDialogData.axisType,angular.forEach(e.ngDialogData.fieldList,function(t){if(t.selected=!1,t.disabled=!1,"x"===e.axisType||"compare_axis"===e.axisType){var a={is_build_aggregated:t.is_build_aggregated,dragFieldType:t.data_type,dragFieldFormula:t.formula};O(a)||(t.disabled=!0)}}),e.selectedAllByType=function(a,i){var r=i.selected,l=t("getFieldsByDataType")(e.ngDialogData.fieldList,a);angular.forEach(l,function(e){e.disabled||(e.selected=r)})},e.checkBatchAddType=function(a,i){var r=0,l=0,n=t("getFieldsByDataType")(e.ngDialogData.fieldList,a);angular.forEach(n,function(e){e.disabled||(l+=1,e.selected&&(r+=1))}),i.selected=r==l?!0:!1},e.batchAdd=function(){var t=[],a=e.chart_ops.meta.level[e.drill_level],i=e.axisType;return angular.forEach(e.ngDialogData.fieldList,function(e){e.selected&&t.push(e)}),0==t.length?(_(e.tips["chart.canNotAddEmpty"]),!1):a[i].length+t.length>=50?(_(e.tips["chart.tooManyField"]),!1):(angular.forEach(t,function(e,t){var r={tb_fid:e.fid,tb_name:e.name,tb_data_type:e.data_type,tb_new:void 0!=e.formula&&""!=e.formula,is_build_aggregated:e.is_build_aggregated,meta:a,axis_field:a[i],axis_length:a[i].length,dragFieldFormula:e.formula,dragFieldType:e.data_type};B(r,i,t)}),W(!1,"add",!1),void e.closeThisDialog())}}]}):!1},e.onDropAdd=function(a,i,r){function l(e){for(var t=0,a=0,i=e.length;i>a;a++){if(e[a].uniq_id==n.uniq_id){t=a,e.splice(t,1);break}e[a].items&&e[a].items.length>0&&l(e[a].items)}return e}if(D()&&!i.draggable.hasClass("enum-item")){var n=e.doDragField;if($.inArray(e.originDragFlag,["x","y","y_optional"])>-1&&e.originDragFlag!=e.dragFlag&&n&&w(e.chart_ops.meta.level[e.drill_level],n),2==t.guide&&3==t.enterprise_type)if(8==t.guideStep){if("x"!=r)return!1;e.$emit("okToGuide","dropOnX")}else if(9==t.guideStep){if("y"!=r)return!1;e.$emit("okToGuide","dropOnY")}if(!e.dragFlag||"source"!==e.dragFlag){if(angular.element(".axis").find(".ico-remove").remove(),"y"==e.originDragFlag||"y_optional"==e.originDragFlag||"y_scatter"==e.originDragFlag){if("y"==e.dragFlag||"y_optional"==e.dragFlag||"y_scatter"==e.dragFlag)return;if("number"==n.data_type||"number"!=n.data_type&&n.hasOwnProperty("aggregator")){var o=e.chart_ops.meta.filter_list_inner;if(o instanceof Array)o=l(o);else{var d=e.drill_level||0;o[d]=l(o[d])}e.chart_ops.meta.filter_list_inner=o}}return!1}if(e.hide_add_to_axis(),e.hide_select_chart_type(),"x"===r||"compare_axis"===r){var s={is_build_aggregated:e.dragIsBuildAggregated,dragFieldType:e.dragFieldType,dragFieldFormula:e.dragFieldFormula||""};if(!O(s))return _(e.tips["polymer.useAggregate"]),!1}var c=e.chart_ops.meta.level[e.drill_level];if(c[r].length>=50)return void _(e.tips["chart.tooManyField"]);var g={tb_fid:e.dragFieldFid,tb_name:e.dragFieldName,tb_data_type:e.dragFieldType,tb_new:e.dragFieldIsNew,is_build_aggregated:e.dragIsBuildAggregated,meta:c,axis_field:c[r],axis_length:c[r].length,dragFieldFormula:e.dragFieldFormula};B(g,r),W(!1,"add",!1)}},e.getDefaultAggr=function(e,t,a){var i="",r=e.chart_type;if("C280"===r&&e.y.length+e.y_scatter.length<2){if(N(e,t,a),1!=a){var l=e.y.length+e.y_scatter.length,n=e.y[0]||e.y_scatter[0];i=1==l&&1!=n.is_build_aggregated&&n.aggregator.data_type===t?n.aggregator:M(t)}}else 1!=a&&(i=M(t));return{name:u[i]||"",aggregator:i}},e.enable_trend_line=function(){var t=e.chart_ops.meta.level[e.drill_level];t.scatter_setting.enable_trend_line&&(t.scatter_setting.trend_line_type=t.scatter_setting.trend_line_type||1,t.scatter_setting.poly_p=t.scatter_setting.poly_p||2),e.saveChartImmediate()},e.trend_line_type_change=function(){var t=e.chart_ops.meta.level[e.drill_level].scatter_setting;t.trend_line_type=+t.trend_line_type,e.saveChartImmediate()},e.onPolynomialBlur=function(){var t=e.chart_ops.meta.level[e.drill_level].scatter_setting;t.poly_p=t.poly_p||2,e.saveChartImmediate()},e.onPolynomialEnter=function(e){13==e.keyCode&&e.target&&a(function(){e.target.blur()})},e.removeAxis=function(t){var a=t.e,i=t.ui,r=t.delIndex,l=t.dragFlag,n=t.dragField,o=t.originDragFlag;if(D()&&(angular.element(".chart-main").css({"overflow-x":"auto"}),n)){var d=e.chart_ops.meta.level,s=d[e.drill_level];if("drill"===l){if(d.splice(r,1),r===e.drill_level){var _=d[e.drill_level];"C280"===_.chart_type&&(_.y_scatter=_.y.slice(1),_.y=_.y.slice(0,1),_.scatter_setting=_.scatter_setting||{},_.scatter_setting.x_len=1)}if(e.chart_ops.meta.level_fields.splice(r,1),1===e.chart_ops.meta.level_fields.length&&(e.chart_ops.meta.level_fields=[]),e.chart_ops.meta.filter_list_inner instanceof Array);else{var c={},g=0;angular.forEach(e.chart_ops.meta.filter_list_inner,function(e,t){t!=r&&(c[g]=e,g++)}),e.chart_ops.meta.filter_list_inner=c}}else if("x"===l)s.sort&&e.dragFieldFid===s.sort.fid&&(s.sort={}),s.x.splice(r,1),0===r&&i.item.hasClass("not-sortable")&&(d.splice(e.drill_level,1),e.chart_ops.meta.level_fields.splice(e.drill_level,1)),tt(s);else{var p=function(){s.sort&&e.dragFieldFid===s.sort.fid&&(e.chart_ops.meta.level[e.drill_level].sort={}),s.sort&&e.dragFieldFid===s.sort.fid&&(s.sort={}),s[l].splice(r,1),tt(s)},f=function(e){if(e&&e.length)for(var t=e.length;t--;)e[t].fid==n.fid&&e[t].uniq_id==n.uniq_id&&e.splice(t,1)};f(s.guide_line),f(s.guide_line_x),f(s.guide_line_right);var u=s.tb_conditional_formatting;if(u&&u.length)for(len=u.length;len--;)u[len].fid==n.fid&&u[len].uniq_id==n.uniq_id&&u.splice(len,1);var h=function(t){var a=!1;return angular.forEach(e.warnSetting.info,function(e){e.axis_type==t&&e.field_name==n.name&&(a=!0)}),a},m=void 0;if(m="dragY"==a.target.id?0:"dragY_optional"==a.target.id?1:void 0,void 0!==m&&1==e.warnSetting.warn&&h(m))return confirm(e.tips["chart.delWarnField"])?(p(),void W(!1,"remove",!0)):(s.x=angular.copy(e.originX),s.y=angular.copy(e.originY),s.y_optional=angular.copy(e.originYoptional),angular.element(".ui-draggable-dragging").find(".ico-remove").remove(),void angular.element(".ui-draggable-dragging").css({left:0,top:0}));p()}if("number"===n.data_type||"number"!=n.data_type&&n.hasOwnProperty("aggregator")){var y=e.drill_level||0,C=e.chart_ops.meta.filter_list_inner[y];angular.forEach(C,function(e,t){e.uniq_id==n.uniq_id&&C.splice(t,1)})}b(s),w(s,n),s.x.length||s.y.length||s.compare_axis&&s.compare_axis.length||s.y_optional&&(!s.y_optional||s.y_optional.length)||(s.chart_type="");var v=s.color_setting;if("x"===l||"x"===o||"compare_axis"===o){if(v&&0===+v.mode){var x=!1;if(v.field.length>0)for(var F=0;F<v.field.length;F++){if(v.field[F]&&n.fid===v.field[F].fid){v.field.splice(F,1),x=!0;break}if(!v.field[0]){v.field.splice(F,1),x=!0;break}}if(v.field&&0===v.field.length&&(delete s.color_setting,v=null),x&&v&&v.field.length>0)return void S({meta:s,bindToMeta:!0,callback:function(){W(!1,"remove")}})}}else if(("y"===l||"y_optional"===l)&&v&&0===+v.mode)return void S({meta:s,bindToMeta:!0,callback:function(){W(!1,"remove")}});(s.x.length+(s.compare_axis||[]).length===0||s.y.length+(s.y_optional||[]).length===0)&&v&&1===+v.mode&&(delete s.color_setting,v=null),W(!1,"remove")}};var ut;e.lazySaveChart=function(e,t){var a=e||{not_need_redraw:!1,only_refresh_data:!1},i=void 0===t||""===t?600:t;clearTimeout(ut),ut=setTimeout(function(){H(a)},i)},e.ifEnterDown=function(t){13==t.keyCode&&e.saveAfterCheckDirty({not_need_redraw:!0,only_refresh_data:!1,closeDialog:!1})},e.ifClearName=function(){(e.chart_ops&&"未命名图表"==e.chart_ops.name||"Untitled Chart"==e.chart_ops.name)&&(e.chart_ops.name="")},e.saveChartImmediate=H,e.saveAfterCheckDirty=function(e){return A()?void H(e):!1},e.switchChartType=function(t,a){if(e.chart_ops){var i=e.chart_ops.meta.level[e.drill_level],r=i.chart_type,l=e.chart_type[t].type,n=e.$bdpChart,o=0;if(n.data.x&&n.data.x.length>0&&n.data.x[0].data?o=n.data.x[0].data.length:n.data.y&&n.data.y.length>0&&n.data.y[0].data?o=n.data.y[0].data.length:n.data.y_optional&&n.data.y_optional.length>0&&n.data.y_optional[0].data&&(o=n.data.y_optional[0].data.length),window.bdpa&&bdpa.track("switch_chart_type",{is_disable:!!a,chart_name:e.chart_ops.name,chart_type:l,origion_chart_type:r,chart_edit:"图表编辑",mode_type:"图表类型",chart_row_num:o,dimension_num:i.x?i.x.length:0,y_num:i.y?i.y.length:0,compare_num:i.compare_axis?i.compare_axis.length:0,y_optional_num:i.y_optional?i.y_optional.length:0}),!a&&r!==l){if([rt.Line,rt.Area,rt.NStackArea,rt.PStackArea,rt.Biax].indexOf(l)>-1&&void 0===i.use_spline&&(i.use_spline="0"),l===rt.Pie&&(void 0===i.shape&&(i.shape="pie"),void 0===i.show_connector_label&&(i.show_connector_label=!0)),l!==rt.Scatter?r===rt.Scatter&&(delete i.color_setting,j(i)):"C280"!==r&&(delete i.color_setting,angular.forEach(i.y,function(e,t){"virtual"===e.data_type&&i.y.splice(t,1)}),i.y_scatter=i.y.slice(1),i.y=i.y.slice(0,1),i.scatter_setting=i.scatter_setting||{},i.scatter_setting.x_len=1),r===rt.Sunburst&&delete i.color_setting,l!==rt.Biax?r===rt.Biax&&(i.y=i.y_optional?i.y.concat(i.y_optional):[],delete i.y_optional,i.show_y_axis_optional=!1):r!==rt.Biax&&(angular.forEach(i.y,function(e,t){"virtual"===e.data_type&&i.y.splice(t,1)}),i.y_optional=[i.y.pop()],i.show_y_axis_optional=!0,i.type_optional=["C210","C220"]),l===rt.Gauge){var d=i.y[0].fid,s=i.y[0].uniq_id;i.y[0].BDP_TCF=!0,i.tb_conditional_formatting=[{fid:d,uniq_id:s,operator:4,value:1,isPercentage:[!0],style:{backgroundColor:"#40A276"}},{fid:d,uniq_id:s,operator:12,value:[.75,1],isPercentage:[!0,!0],style:{backgroundColor:"#F6CC4E"}},{fid:d,uniq_id:s,operator:12,value:[.25,.75],isPercentage:[!0,!0],style:{backgroundColor:"#F38000"}},{fid:d,uniq_id:s,operator:3,value:.25,isPercentage:[!0],style:{backgroundColor:"#EE4B4B"}}],delete i.y[0].series_color}else r===rt.Gauge&&delete i.tb_conditional_formatting;if(l===rt.KPICard){if(i.y.length>1&&!i.y[1].series_color){var _=i.y[1].fid,c=i.y[1].uniq_id;i.y[0].BDP_TCF=!1,i.y[1].BDP_TCF=!0,i.tb_conditional_formatting=[{fid:_,uniq_id:c,operator:3,value:0,shape_type:"arrow-down",style:{color:"#40B27E"}},{fid:_,uniq_id:c,operator:0,value:0,shape_type:"arrow-equal",style:{color:"#A3ABB0"}},{fid:_,uniq_id:c,operator:2,value:0,shape_type:"arrow-up",style:{color:"#EF4B4A"}}]}}else r===rt.KPICard&&delete i.tb_conditional_formatting;if(i.chart_type=l,setTimeout(function(){e.selected_type=l},0),tt(i),i.chart_type!==rt.Table)delete i.tb_flip,i.chart_type===rt.KPICard&&(e.chart_ops.name||(e.chart_ops.name=i.y[0].nick_name||i.y[0].name));else{var g=i.y_optional?i.y_optional.slice(0):[],p=i.y,f=p[p.length-1],u=p[p.length-2];if(f&&"row_summary"==f.fid){var h=f;p.pop(),p=p.concat(g).concat(h),i.tb_statistic.row_setting&&(i.tb_statistic.row_setting.pos=p.length-1)}else p=p.concat(g);if(i.y=p.slice(0),p=[],u&&"row_summary"==u.fid&&"right"==i.tb_statistic.row_pos){var m=(jQuery.extend(!0,{},i.y),u),y=f,C=i.y.slice(0);C.splice(p.length-2,2),C.push(y,m),i.y=C.splice(0)}delete i.y_optional,delete i.yaxis_name_right,delete i.yaxis_unit_right,delete i.yaxis_max_right,delete i.yaxis_min_right,delete i.yaxis_max_disabled_right,delete i.yaxis_min_disabled_right,delete i.type_optional,delete i.guide_line_right,i.show_y_axis_optional=!1}var v=[rt.Scatter,rt.Biax,rt.WordCloud,rt.Sankey,rt.KPICard,rt.Gauge,rt.Table,rt.Pie,rt.Sunburst,rt.TreeMap],b=[rt.Scatter,rt.Biax,rt.WordCloud,rt.Sankey,rt.KPICard,rt.Gauge,rt.Table,rt.Pie,rt.Sunburst,rt.TreeMap],x=v.indexOf(r)>-1||b.indexOf(l)>-1||Q(r)&&!Q(l)||!Q(r)&&Q(l);H({only_redraw:!x,is_drill_chart:!!e.drill_level})}}},e.showChartTypeTip=function(t,a){a.stopPropagation();var i=$(".chart-type-tip");if("block"!=i.css("display")){e.chartTypeConfigMesg={},e.chart_type_tip.map(function(a){a.type==t&&(e.chartTypeConfigMesg=angular.copy(a))});var r=$(a.target),l=$("body").outerWidth(),n=r.offset(),o=n.top-85,d=l-n.left+14;i.css("top",o),i.css("right",d),i.css("display","block")}},e.hideChartTypeTip=function(){var e=$(".chart-type-tip");e.css("display","none"),e.css("top",0),e.css("right",0)},e.saveWordCount=function(t){13==t.keyCode&&e.saveWordCountModify()},e.saveWordCountModify=function(){var t=e.chart_ops.meta.level[e.drill_level],a=t.word_count;a||(t.word_count=e.maxWordCount),e.lazySaveChart({not_need_redraw:!1,only_refresh_data:!1},0)},e.changeSmart=function(){e.lazySaveChart({not_need_redraw:!1,only_refresh_data:!1},0)},e.$on("checkChartTypeCondition",function(e,t,a){G(t,a)}),e.switchToScatter=function(){var t=e.chart_ops.meta.level[e.drill_level];t.y_scatter=t.y_scatter||t.y.slice(1),t.y=t.y.slice(0,1)},e.$watch("drill_level",function(t,a){if(e.chart_ops){var i=e.chart_ops.meta.level[a],r=e.chart_ops.meta.level[t];void 0!=a&&i&&"C280"==i.chart_type&&(i.y=i.y.concat(i.y_scatter),delete i.y_scatter),void 0!=t&&"C280"==r.chart_type&&e.switchToScatter(),r&&r.chart_type===bdpChart.ChartType.Table&&tt(r)}});var ht={clearAdvance:function(e){e&&e.forEach(function(e){delete e.advance_aggregator,delete e.YoY,delete e.QoQ,delete e.yoyQoqSetting,delete e.yoyQoqType})}},mt='<video class="slow-in" id="guide_video" src="../static/video/demo.mp4" controls="controls" ></video>';e.showGuideVideo=!1,e.isPersonal=!1,e.$watch(function(){return t.enterprise_type},function(t){3==t&&(e.isPersonal=!0)}),e.show_guide_video=function(){$(".guide-video").append(mt),e.showGuideVideo=!0,e.videoStatus="pause",e.showPlayBtn=!0,e.showPauseBtn=!1},e.close_guide_video=function(){e.showGuideVideo=!1,e.videoStatus="pause"},e.showVideoLayer=!0,e.showPlayBtn=!0,e.showPauseBtn=!1,e.videoStatus="pause",e.changeVideoStatus=function(t){t.stopPropagation(),"pause"==e.videoStatus?(e.videoStatus="play",document.getElementById("guide_video").play(),e.showPlayBtn=!1,e.showPauseBtn=!1):"play"==e.videoStatus&&(e.videoStatus="pause",document.getElementById("guide_video").pause(),e.showPlayBtn=!0,e.showPauseBtn=!1)},e.playVideo=function(t){t.stopPropagation(),e.videoStatus="play",document.getElementById("guide_video").play(),e.showPlayBtn=!1,e.showPauseBtn=!1,e.showVideoLayer=!1},e.pauseVideo=function(t){t.stopPropagation(),e.videoStatus="pause",document.getElementById("guide_video").pause(),e.showPlayBtn=!0,e.showPauseBtn=!1,e.showVideoLayer=!0},e.show_edit_help=function(){this.show_chart_edit_guide=!this.show_chart_edit_guide;var e=this;this.show_chart_edit_guide&&setTimeout(function(){$(document).on("click.hguide",function(){e.$apply(function(){e.show_chart_edit_guide=!1}),$(document).off("click.hguide")})},0)};var yt="mc_guide_edit_guide";e.show_user_guide=function(){e.add_to_axis_guide=!0,e.select_chart_type_guide=!0},e.hide_add_to_axis=function(){e.add_to_axis_guide=!1,localStorage.setItem(yt,"1")},e.hide_select_chart_type=function(){e.select_chart_type_guide=!1,localStorage.setItem(yt,"1")},e.canSetColor=function(t){if(!t)return!1;var a=["C200"],i=!0,r=e.chart_ops.meta.level[e.drill_level];if("C290"==t)r&&0==r.x.length&&(i=!1);else if("C261"==t)r&&r.tb_conditional_formatting&&r.tb_conditional_formatting.length>0&&(i=!1);else if("C310"==t&&r&&r.tb_conditional_formatting&&r.tb_conditional_formatting.length>0){var l=[0,0];r.tb_conditional_formatting.forEach(function(e){e.uniq_id===r.y[0].uniq_id&&(l[0]=1),r.y.length>1&&e.uniq_id===r.y[1].uniq_id&&(l[1]=1)}),i=l[0]+l[1]!==2}return a.indexOf(t)<0&&i},e.isSortField=function(t){var a=t.field,i=t.axis,r=e.chart_ops.meta.level[e.drill_level],l=["C200","C210","C211","C212","C220","C240","C241","C242","C250","C290","C330","C350","C351","C352"],n=["C320"].concat(l),o=r.sort;return"compare_axis"===i&&(o=r.compare_axis[t.index].compare_sort),l.indexOf(r.chart_type)<0?!1:o&&o.type?"x"==o.axis&&n.indexOf(r.chart_type)<0?!1:"virtual"==a.data_type&&"row_summary"==o.fid?!0:["x","y","compare_axis"].indexOf(o.axis)>-1?a.uniq_id&&o.uniq_id?o.uniq_id==a.uniq_id:o.fid==a.fid:!1:!1},e.fieldSortType=function(t){var a=e.chart_ops.meta.level[e.drill_level],i=a.sort;return t&&"compare_axis"===t.axis&&(i=a.compare_axis[t.index].compare_sort),i&&i.type?{"ico-sort-desc":"desc"==i.type,"ico-sort-asc":"asc"==i.type}:{}},e.axisHandle={add:function(t){var a=e.chart_ops.meta.level[e.drill_level];"y_optional"===t?(a.y_optional=[],a.chart_type="C250",a.type_optional=["C210","C220"],void 0==a.yaxis_max_disabled_right&&(a.yaxis_max_disabled_right=!0),void 0==a.yaxis_min_disabled_right&&(a.yaxis_min_disabled_right=!0),a.show_y_axis_optional=!0,delete e.chart_ops.guide_line,W()):"compare_axis"===t&&(a.compare_axis=[],e.saveChartImmediate())},remove:function(t){var a=e.chart_ops.meta.level[e.drill_level];if("y_optional"===t)a.chart_type="C210",a.y=a.y_optional?a.y.concat(a.y_optional):[],delete a.y_optional,delete a.yaxis_name_right,delete a.yaxis_unit_right,delete a.yaxis_max_right,delete a.yaxis_min_right,delete a.yaxis_max_disabled_right,delete a.yaxis_min_disabled_right,delete a.type_optional,delete a.guide_line_right,a.show_y_axis_optional=!1,W();else if("compare_axis"===t){var i=a.color_setting;if(i&&0===+i.mode){var r=!1;if(i.field.length>0&&angular.forEach(a.compare_axis,function(e){for(var t=0;t<i.field.length;t++)if(e.fid===i.field[t].fid){i.field.splice(t,1),r=!0;
break}}),i.field&&0===i.field.length&&(delete a.color_setting,i=null),r&&i&&i.field.length>0)return void S({meta:a,bindToMeta:!0,callback:function(){delete a.compare_axis,e.saveChartImmediate()}})}delete a.compare_axis,(a.chart_type="C290")?W():e.saveChartImmediate()}}},e.handleVirtualFieldForTable=tt,e.getCurrentLayerFilter=function(t){var a=e.drill_level||0,i=[];return i=t instanceof Array?t:t[a]},e.drill_level=0,J(),e.emitCrumbsClick=function(t){t<e.drill_level&&$(".drill-crumbs").find("span").eq(t).find("a").click()},e.getChartArgsHeight=it,e.setAdvanceAggregatorName=m,e.showFieldTip=function(e,t){if(t.nick_name){var a=$(e.target).parents(".data-tag").next(".field-tip"),i=parseInt(a.css("width")),r=a.children(".arrow"),l=$(e.target).parents("li").position(),n=parseInt($(e.target).parents("li").css("width")),o=($(e.target).parents("ul"),parseInt($(e.target).parents("ul").css("width")));a.css("display","block"),a.css("top",l.top+38),o>l.left+i?(a.css("left",l.left),r.css("left",16)):(a.css("left",l.left+n-i-5),r.css("left",i-16-15)),"row_summary"==t.fid&&a.css({left:0,top:l.top+32})}},e.hideFieldTip=function(e){var t=$(e.target).parents(".data-tag").next(".field-tip");t.css("display","none")},e.showAdvTip=!1,C.initGuide(e),e.showTableAdvSort=function(){C.show(e,H)},bdp.utils.fixedBlur($(".chart-right input, .chart-right textarea")),f(["field.fieldNameRequired","field.fieldTypeRequired","field.fieldFormulaRequired","field.addFieldSuccess","field.modifyFieldSuccess","field.formulaInvalid","field.groupInvalid","chart.delGaugeField","chart.delField","chart.fieldInUsing","chart.buildAggregated","chart.duplicateField","chart.tooManyField","chart.delWarnField","chart.untitledChart","chart.addDrillTip","chart.canNotAddEmpty","polymer.useAggregate","chart.notdrill","chart.emptyChartName","chart.showConnectorLabel","chart.batchAddTips","chart.addFieldsToAxisX","chart.addFieldsToAxisY","chart.addFieldsToAxisCampar"],e)}]).directive("chartDropDown",["$timeout",function(e){return{restrict:"A",scope:{dropDownFlag:"="},link:function(t){t.$watch("dropDownFlag",function(a,i){var r=".chart-left",l="scroll.chartfolder";if(a!==i&&1==a){var n=angular.element(r).scrollTop();e(function(){angular.element(r).on(l,function(a){Math.abs(n-$(a.target).scrollTop())>8&&(t.dropDownFlag=!1,e(function(){t.$digest()},0))})},0)}else a!==i&&0==a&&angular.element(r).off(l)})}}}])}();
;angular.module("BC.controllers.chartEdit").controller("gisCtrl",["$scope","$rootScope","$stateParams","$location","errHint","commonService","$q","ngDialog","$jsTipTranslate","formulaKeyMap","dateNameMap","setAdvanceAggregatorName","formatFieldPercentile","$translate",function(e,a,t,r,i,n,l,o,s,d,c,g,u,m){function f(){var a=e.chart_ops.meta.layers;if(a)for(var t=0,r=a.length;r>t;t++)if(!a[t].layer_name)return i(m.instant("chart.layerNameRequired")),!1;return!0}function p(){var e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var a=16*Math.random()|0,t="x"==e?a:3&a|8;return t.toString(16)});return"layer_"+e.replace(/-/g,"")}function h(e,a){for(var t=a.layer_name,r=0,i=1;r<e.length;r++){var n=e[r];a.layer_name=t+"_"+i,a.layer_name===n.layer_name&&(i++,a.layer_name=t+"_"+i)}}function y(a){e.chart_ops.meta.layers.splice(a,1),a==e.currentLayerIndex?e.currentLayerIndex=e.chart_ops.meta.layers.length?e.chart_ops.meta.layers.length-1:0:e.currentLayerIndex==e.chart_ops.meta.layers.length?e.currentLayerIndex--:a<e.currentLayerIndex&&e.currentLayerIndex--,e.viewData.currentLayer=e.chart_ops.meta.layers[e.currentLayerIndex],e.field_list=e.viewData.currentLayer?e.viewData.schemaMap[e.viewData.currentLayer.tb_id]:[];var t=e.$bdpChart;t.data.layers.splice(a,1),e.saveChart({only_redraw:!0})}function _(a){var t=e.chart_ops.meta&&e.chart_ops.meta.layers;return t=t||[],t.some(function(e){return e.tb_id===a})}function v(){window.localStorage.getItem("BDP_ShowGisEditGuide")||(a.showGisEditGuide=!0,a.gisEditGuide=0,window.localStorage.setItem("BDP_ShowGisEditGuide",1))}function b(e,a){var t=e.some(function(e){return!e.lng_field||!e.lat_field});return t?(a&&i(m.instant("chart.saveGisTableSettingFail")),!1):!0}function w(a){var t,r,i=e.viewData.currentLayer;for(t=0,r=i.y.length;r>t;t++)if(i.y[t].fid==a)return!1;for(t=0,r=i.x.length;r>t;t++)if(i.x[t].fid==a)return!1;return!0}function D(e,a){var t=Math.abs(e.x1+e.x2-a.x1-a.x2),r=e.x2-e.x1+(a.x2-a.x1),i=Math.abs(e.y1+e.y2-a.y1-a.y2),n=e.y2-e.y1+(a.y2-a.y1);return r>=t&&n>=i}function L(e,a){var t={x1:a.offset.left,y1:a.offset.top,x2:a.offset.left+a.helper.width(),y2:a.offset.top+a.helper.height()},r=$(".chart-args"),i=r.offset(),n={x1:i.left,y1:i.top,x2:i.left+r.width(),y2:i.top+r.height()};return!D(t,n)}function x(e,a){var t={x1:a.offset.left,y1:a.offset.top,x2:a.offset.left+a.helper.width(),y2:a.offset.top+a.helper.height()},r=$(".layers"),i=r.offset(),n={x1:i.left,y1:i.top,x2:i.left+r.width(),y2:i.top+r.height()};return!D(t,n)}function C(e,a){return"heatmap"==e&&a>0}function T(a,t){switch(a){case"x":if(1===Number(t.is_build_aggregated))return i(e.tips["polymer.useAggregate"]),!1;delete t.aggregator,delete t.aggregator_name;break;case"y":var r=e.viewData.currentLayer.color_setting,n=e.viewData.currentLayer.bubble_setting;if(r&&1===r.field[0].is_build_aggregated||n&&1===n.field.is_build_aggregated){var l=e.viewData.currentLayer.y[0];l&&l.aggregator?(t.aggregator="number"===t.data_type?"SUM":"COUNT",t.aggregator_name=d[t.aggregator]):"number"!==t.data_type&&(t.aggregator="COUNT",t.aggregator_name=d[t.aggregator],e.viewData.currentLayer.y.forEach(function(e){1===Number(e.is_build_aggregated)||e.aggregator||(e.aggregator="number"===e.data_type?"SUM":"COUNT",e.aggregator_name=d[e.aggregator])}))}else if(1!==Number(t.is_build_aggregated)){var l=e.viewData.currentLayer.y[0];l&&l.aggregator?(t.aggregator="number"===t.data_type?"SUM":"COUNT",t.aggregator_name=d[t.aggregator]):"number"!==t.data_type&&(t.aggregator="COUNT",t.aggregator_name=d[t.aggregator],e.viewData.currentLayer.y.forEach(function(e){1===Number(e.is_build_aggregated)||e.aggregator||(e.aggregator="number"===e.data_type?"SUM":"COUNT",e.aggregator_name=d[e.aggregator])}))}else 1===Number(t.is_build_aggregated)&&(t.aggregator="COUNT",t.aggregator_name=d[t.aggregator],e.viewData.currentLayer.y.forEach(function(e){1===Number(e.is_build_aggregated)||e.aggregator||(e.aggregator="number"===e.data_type?"SUM":"COUNT",e.aggregator_name=d[e.aggregator])}))}}function F(e,a){for(var t=0,r=0,i=a.length;i>r;r++)if(e==a[r].layer_id){t=r;break}return t}function I(){return e.originChartTitle!=e.chart_ops.name}function N(a){a&&(e.global.show_discrete=!0,a.y.some(function(a){return"string"===a.data_type||1==a.is_build_aggregated?(e.global.show_discrete=!1,!0):!1}))}function A(a){a&&a.y.forEach(function(a){e.formatFieldPercentile(a)})}function k(a){return n.chart.getInfo(a).then(function(a){var t=a;return 0==t.status?(e.advDateService&&e.advDateService.list(e.chartId),t.result):void i(+t.status)})}function M(e){return l.all(e.map(function(e){return n.tb.getInfo(e)}))}function S(a,t,r,i){e.saveDone=!1;var l={ct_id:a,data:angular.toJson({meta:r,name:t})};return i&&(l.operate=angular.toJson(i)),n.chart.modify(l).then(function(a){return e.saveDone=!0,a})}a.view="chart_edit",a.currentView="gis_edit",a.show_bdp_header=!1,e.saveDone=!0,e.chartId=t.chartId,e.chartTitle="",e.projId=t.projId,e.dashId=t.dashId,e.wsId=t.wsId,e.gisTypes=["bubble","heatmap","massive","graph","trajectory","d_trajectory"],e.gisBubbleSymbol=["location","circle","triangle","rect","diamond","ripple"],e.timeAnimationSpeeds=[{name:"chart.animationSlow",val:1},{name:"chart.animationNormal",val:3},{name:"chart.animationFast",val:5}],e.formatFieldPercentile=u,$.cookie("edit_chart_id",e.chartId),e.gisGraphTypes=["pie","column","bar"],e.heatMapUnit=[{name:m.instant("chart.meter"),value:"m"},{name:m.instant("chart.pixel"),value:"px"}],e.gisTypeNames={bubble:m.instant("chart.bubble"),heatmap:m.instant("chart.heatmap"),massive:m.instant("chart.massive"),graph:m.instant("chart.graph"),trajectory:m.instant("chart.trajectory"),d_trajectory:m.instant("chart.d_trajectory")},e.timeGranularity=["year","quarter","month","week","day","hour","minute","second"],e.draw_chart_url={options:{theme:1===+a.usedThemeId?"dark":"default",ct_id:e.chartId,ws_id:e.wsId,optional:{}},lazyload:!1},e.currentLayerIndex=0,e.chart_ops={meta:{}},e.viewData={},e.back=function(){f()&&(a.pageLoading=!0,e.saveCenterAndZoom().then(function(){a.pageLoading=!1,r.path(a.wsId?"/dash_edit_ws/"+e.wsId+"/"+e.projId+"/"+e.dashId:"/dash_edit/"+e.projId+"/"+e.dashId)}))},e.saveCenterAndZoom=function(){var a=l.defer(),t=$("#chartBox").find(".chart").data("bdp-chart-instance");if(t&&!$.isEmptyObject(e.chart_ops.meta.layers)){t=t.gisMap.bmap;var r=t.getZoom(),i=t.getCenter();return e.chart_ops.meta.zoom=r,e.chart_ops.meta.center=[i.lng,i.lat],e.saveChart({not_need_redraw:!0})}return a.resolve(),a.promise},e.addLayer=function(a){var t={tb_id:a.tb_id,layer_name:a.name,layer_id:p(),lng:[],lat:[],x:[],y:[],type:"bubble",bubble_symbol:"circle",filter_list:[]};e.chart_ops.meta.layers=e.chart_ops.meta.layers||[];for(var r=e.chart_ops.meta.layers,i=0,n=1;i<r.length;i++){var l=r[i];t.layer_name===l.layer_name&&(t.layer_name=a.name+"_"+n,n++,i=-1)}e.chart_ops.meta.layers.push(t),e.setCurrentLayer(e.chart_ops.meta.layers.length-1),e.saveChart()},e.copyLayer=function(a){var t=e.chart_ops.meta.layers||[],r=angular.copy(e.chart_ops.meta.layers[a]),n=r.layer_id;return"d_trajectory"==r.type?(r=null,i(m.instant("chart.copyDTrajectoryLayerFail"))):(r.layer_id=p(),h(t,r),r.timeline&&delete r.timeline,e.chart_ops.meta.layers.push(r),e.setCurrentLayer(e.chart_ops.meta.layers.length-1),void e.saveChart({operate:{operator:"copy_layer",params:{origin_layer:n,dest_layer:r.layer_id}}}))},e.deleteLayer=function(a){o.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:m.instant("chart.deleteLayer")}}).then(function(){y(a)})},e.showAddTableDialog=function(){n.folder.getList().then(function(a){o.open({template:"/static/partials/choose_table_list.html",className:"ngdialog-theme-default data-source choose-table-list",data:{json_data:{title:e.tips["dash.selectTbTitle"],type:"choose",show_upload:!1},choose_table:{tb_id:""}},scope:e,controller:["$scope",function(e){e.folderList=a,e.original_folderList=angular.copy(a),e.chooseTableOk=function(a){e.addTableToChart(a.tb_id),e.closeThisDialog(),i(m.instant("chart.addWorksheetSuccess"))}}]})})},e.addTableToChart=function(a){for(var t=e.viewData.tbList,r=!1,l=0;l<t.length;l++){var o=t[l];if(a==o.tb_id){r=!0;break}}return r?i(m.instant("chart.addWorksheetDuplicated")):n.chart.addRelaTb(e.chartId,a).then(function(t){"0"==t.status&&n.tb.getInfo(a).then(function(t){if("0"==t.status){var r=t.result;e.viewData.schemaMap[a]=r.schema,e.viewData.tbList.push(r),r.lat_field&&r.lng_field||e.showSetCoordDialog(r)}})})},e.deleteTb=function(a,t){o.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-380",scope:e,data:{message:m.instant("chart.removeWorksheetWithLayer")}}).then(function(){for(var r=e.chart_ops.meta.layers,l=void 0!==r?r.length:0,o=!1;l--;)r[l].tb_id===a&&(r.splice(l,1),o=!0);e.viewData.tbList.splice(t,1),n.chart.delRelaTb(e.chartId,a).then(function(a){return"0"!=a.status?void i(m.instant("chart.removeWorksheetFail")):void(o&&e.saveChart())})})},e.showSetCoordDialog=function(a,t){if(void 0===a){var r=e.viewData.currentLayer;if(r&&e.viewData.tbList.forEach(function(e){e.tb_id===r.tb_id&&(a=e,gis_type=a.gis_type)}),void 0===a)return i(m.instant("chart.unselectedWorksheet"))}else gis_type=a.gis_type;o.open({template:"/static/partials/dialogTemplates/gis-coord-type.html",className:"ngdialog-theme-default gis-single-tb-setting",data:{table:a},scope:e,preCloseCallback:function(r){return"$closeButton"==r&&(e.viewData.currentLayer||b([a])?t&&v():e.back()),!0},showClose:!1,controller:["$scope",function(e){e.table={gis_type:e.ngDialogData.table.gis_type,tb_id:e.ngDialogData.table.tb_id,name:e.ngDialogData.table.name,field_list:e.ngDialogData.table.schema,lng_field:e.ngDialogData.table.lng_field||"",lat_field:e.ngDialogData.table.lat_field||""},e.coordTypeList=[{value:0,name:m.instant("chart.baiduMap")},{value:1,name:m.instant("chart.gaodeMap")},{value:2,name:m.instant("chart.tencentMap")},{value:3,name:m.instant("chart.aliyunMap")},{value:4,name:m.instant("chart.googleMap")}],e.confirm=function(){if(b([e.table],!0)){var a={gis_type:e.table.gis_type,lng_field:e.table.lng_field,lat_field:e.table.lat_field};n.tb.modifyTag([{tb_id:e.table.tb_id,tag:a}]).then(function(a){"0"===a.status&&(e.ngDialogData.table.gis_type=e.table.gis_type,e.ngDialogData.table.lng_field=e.table.lng_field,e.ngDialogData.table.lat_field=e.table.lat_field,i(e.tips["chart.saveSuccess"]),_(e.table.tb_id)&&e.saveChart())}),e.closeThisDialog(),t&&v()}},e.cancel=function(){e.closeThisDialog(),e.viewData.currentLayer||b([a])?t&&v():e.back()}}]})},e.toggleMoreAction=function(e){var a=$(e.target).siblings(".more-dropdown");a.toggleClass("hidden"),a.hasClass("hidden")||setTimeout(function(){$(document).one("click.more-dropdown",function(){a.addClass("hidden")})},0)},e.renameLayer=function(a){if(!a.layer_name)return i(m.instant("chart.layerNameRequired")),!0;for(var t=e.chart_ops.meta.layers||[],r=0,n=1;r<t.length;r++){var l=t[r];a.layer_id!==l.layer_id&&a.layer_name===l.layer_name&&(a.layer_name=a.layer_name+"_"+n,n++,r=0)}return e.saveChart({only_redraw:!0}),!1},e.onRenameLayerKeyUp=function(e){13===e.keyCode&&setTimeout(function(){e.target.blur()},0)},e.toggleVisible=function(a){a.invisible=!a.invisible,e.saveChart({only_redraw:!0})},window.scope=e;var j,E;e.dragTbFunc=function(e,a,t){j=t},e.onDrop=function(){j&&e.addLayer(j)},e.newField={},e.handlerMorePos=function(e){var a=document.body.clientHeight,t=$(e.target).offset(),r=($(".field-list").height(),t.top+20),i=t.left-50;r+120>a&&(r-=140),angular.element(".field-editable-handler-more").css({top:r,left:i}),e.stopPropagation()},e.modifyField=function(t){a.pageLoading=!0,e.newField=angular.extend({aggregator:t.formula,original_field_name:t.name},t,{type:"modify",tb_id:e.viewData.currentLayer.tb_id,ct_id:e.chartId});var r="ngdialog-theme-default add-field-dialog",i="/static/partials/add_field.html";t.param&&"group"==t.param.type&&(i="/static/partials/field_groups.html",r+=" group-field-dialog"),o.open({template:i,data:{fieldList:e.field_list},className:r,scope:e})},e.createFieldFormula=function(){a.pageLoading=!0,e.newField={type:"create",name:"",aggregator:""};var t="/static/partials/add_field.html";o.open({template:t,data:{fieldList:e.field_list},className:"ngdialog-theme-default add-field-dialog",scope:e})},e.createFieldGroup=function(){a.pageLoading=!0,e.newField={type:"create",name:"",aggregator:"",tb_id:e.viewData.currentLayer.tb_id,ct_id:e.chartId};var t="/static/partials/field_groups.html";o.open({template:t,data:{fieldList:e.field_list,tb_id:e.viewData.currentLayer.tb_id},className:"ngdialog-theme-default add-field-dialog group-field-dialog",scope:e})},e.setFieldType=function(){if(e.viewData.currentLayer){var a=e.viewData.schemaMap[e.viewData.currentLayer.tb_id];a=bdp.utils.addSpecParamsToFields(a),e.fidToName={},angular.forEach(a,function(a){e.fidToName[a.fid]=a.name})}},e.setCurrentLayer=function(a){e.viewData.currentLayer&&(e.viewData.currentLayer.filterRangeList=e.filterRangeList),e.currentLayerIndex=a,e.viewData.currentLayer=e.chart_ops.meta.layers[a],e.viewData.currentLayer.filterRangeList=e.viewData.currentLayer.filterRangeList||{},e.filterRangeList=e.viewData.currentLayer.filterRangeList,e.setGraphColor(),e.field_list=e.viewData.schemaMap[e.viewData.currentLayer.tb_id],e.setFieldType()},e.fetchTbInfo=function(a){return M(a).then(function(a){for(var t={},r=[],i={},l=!1,s=0,d=a.length;d>s;s++){var c=a[s].result;t[c.tb_id]=c.schema,r.push(c),i[c.tb_id]=c.tb_type,c.lng_field&&c.lat_field||(l=!0)}e.viewData.schemaMap=t,e.field_list=e.viewData.currentLayer?e.viewData.schemaMap[e.viewData.currentLayer.tb_id]:[],e.setFieldType(),e.viewData.tbList=r,l?r.length>1?o.open({template:"/static/partials/dialogTemplates/gis-coord-type.html",className:"ngdialog-theme-default gis-table-setting",scope:e,preCloseCallback:function(a){return"$closeButton"===a&&(e.viewData.currentLayer||b(r)?v():e.back()),!0},showClose:!1,controller:["$scope",function(e){e.coordTypeList=[{value:0,name:m.instant("chart.baiduMap")},{value:1,name:m.instant("chart.gaodeMap")},{value:2,name:m.instant("chart.tencentMap")},{value:3,name:m.instant("chart.aliyunMap")},{value:4,name:m.instant("chart.googleMap")}],e.gisSettingTbList=r,e.settingTable=r[0],e.confirm=function(){var a=e.gisSettingTbList;b(a,!0)&&(a=e.gisSettingTbList.map(function(e){return{tb_id:e.tb_id,tag:{gis_type:e.gis_type,lng_field:e.lng_field,lat_field:e.lat_field}}}),n.tb.modifyTag(a).then(function(t){if("0"===t.status){var r=a.some(function(e){return _(e.tb_id)});e.gisSettingTbList=null,r&&e.saveChart()}}),e.closeThisDialog(),v())},e.cancel=function(){e.closeThisDialog(),e.viewData.currentLayer||b(r)?v():e.back()},e.setCurrentTable=function(a){e.settingTable=e.gisSettingTbList[a]}}]}):e.showSetCoordDialog(r[0],!0):v()})},e.addCalcField=function(a){e.global.clickComplete=!1;var t=!1;return a.name?a.data_type||a.param?a.aggregator.trim()||a.param&&"group"==a.param.type||(i(e.tips["field.fieldFormulaRequired"]),t=!0):(i(e.tips["field.fieldTypeRequired"]),t=!0):(i(e.tips["field.fieldNameRequired"]),t=!0),t?(e.global.clickComplete=!0,!1):void n.field["create"===a.type?"create":"modify"]({tb_id:e.viewData.currentLayer.tb_id,original_field_name:a.original_field_name||"",new_field_name:a.name,aggregator:a.aggregator.trim(),data_type:a.data_type,param:angular.toJson(a.param),fid:a.fid||""}).success(function(t){if(e.global.clickComplete=!0,0==t.status){o.closeAll();var r=e.viewData.currentLayer.tb_id;n.field.getList(r).then(function(t){if(0==t.status){t=t.result,e.viewData.schemaMap[r]=e.field_list=t.schema,e.setFieldType();for(var i=0,n=e.field_list.length;n>i;i++)if(a.fid==e.field_list[i].fid){a.name=e.field_list[i].name,a.is_build_aggregated=e.field_list[i].is_build_aggregated;break}if("modify"==a.type){for(var i=0;i<e.chart_ops.meta.layers.length;i++)if(e.chart_ops.meta.layers[i].y)for(var l=a.is_build_aggregated,o=e.chart_ops.meta.layers[i],s=0;s<o.y.length;s++)if(o.y[s].fid==a.fid){o.y[s].name=a.name,o.y[s].is_build_aggregated=l,o.y[s].data_type=a.data_type,o.y[s].aggregator=2==l?"number"===o.y[s].data_type?"SUM":"COUNT":"";break}{w(e.newField.fid)}e.saveChartImmediate({not_need_redraw:!0})}}})}else i("7200"==t.status?isObjectEmpty(a.param)?e.tips["field.formulaInvalid"]:e.tips["field.groupInvalid"]:"40005"==t.status?t.errstr:Number(t.status))})},e.delNewField=function(a,t){function r(){n.field.del(t,e.viewData.currentLayer.tb_id).success(function(a){0==a.status?(n.field.getList(e.viewData.currentLayer.tb_id).then(function(a){0==a.status&&(a=a.result,e.viewData.schemaMap[e.viewData.currentLayer.tb_id]=e.field_list=a.schema,e.setFieldType())}),e.global.watch=new Date):i("7590"==a.status?e.tips["chart.fieldInUsing"]:"40006"==a.status?a.errstr:Number(a.status))})}e.chart_ops.meta.gauge_setting&&a==e.chart_ops.meta.gauge_setting.goal.field_name?o.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:e.tips["chart.delGaugeField"]+": "+a+" ?"}}).then(function(){e.chart_ops.meta.gauge_setting.goal={value_type:"constant",value:$.cookie("yaxis_max")},e.saveChartImmediate(),r()}):o.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:e.tips["chart.delField"]+": "+a+" ?"}}).then(function(){r()})},e.onSaveEnumOrder=function(a){var t=w(a);e.saveChartImmediate({not_need_redraw:t})},e.showEnumOrder=function(a,t,r){o.open({template:"/static/partials/dialogTemplates/enum_order.html",data:{fid:a,tb_id:e.viewData.currentLayer.tb_id,isCustomOrder:t,source:r},scope:e,controller:"enumOrderCtrl",className:"ngdialog-theme-default enum-order-dialog"})},e.dragFieldFunc=function(a,t,r){E=r,e.dragField=r,e.removeFaild=!1,e.dragFieldFid=r.fid,e.dragFieldName=r.name,e.dragFieldType=r.data_type},e.dragSubFieldFunc=function(a,t,r,i){e.dragField={fid:r.fid+"_"+i,data_type:"sub_date",name:c[i]+"("+r.name+")"},E=e.dragField,e.removeFaild=!1,e.dragFieldFid=r.fid+"_"+i,e.dragFieldType="sub_date",e.dragFieldIsNew=""!=r.formula,e.dragIsBuildAggregated=r.is_build_aggregated,e.dragFieldFormula=r.formula||"",e.dragFieldName=c[i]+"("+r.name+")"},e.dropFieldTo=function(a,t,r){if("x"===r){if(1===E.is_build_aggregated)return i(e.tips["polymer.useAggregate"]),!1}else if("lng"===r||"lat"===r){if(1===E.is_build_aggregated)return i(e.tips["polymer.gisUseAggregate"]),!1}else if("y"===r&&1===E.is_build_aggregated){if("string"===E.data_type||"date"===E.data_type)return i(e.tips["polymer.buildAggregateY"]),!1}else if("y"===r&&1!==E.is_build_aggregated){var n=e.viewData.currentLayer.color_setting,l=e.viewData.currentLayer.bubble_setting;if(n&&1===n.field[0].is_build_aggregated||l&&1===l.field.is_build_aggregated){var o=e.viewData.currentLayer.y[0],s=e.dragField;o&&o.length>0?e.viewData.currentLayer.y.forEach(function(e){1===Number(e.is_build_aggregated)||e.aggregator||(e.aggregator="number"===e.data_type?"SUM":"COUNT",e.aggregator_name=d[e.aggregator])}):(s.aggregator="number"===s.data_type?"SUM":"COUNT",s.aggregator_name=d[s.aggregator])}}e.addField(r,angular.copy(E))};var U=e.sortAxisField={originAxis:"",targetAxis:"",updated:!1,currentAction:"",start:function(e){U.originAxis=e.target.id.replace("drag","").toLowerCase(),U.targetAxis=e.target.id.replace("drag","").toLowerCase(),U.updated=!1},sort:function(e,a){var t=a.helper;t.css({width:$(this).width()+1}),L(e,a)?t.find(".ico-remove").length||t.find(".name").append('<i class="bdp-icon ico-remove"></i>'):t.find(".name").find(".ico-remove").remove()},over:function(e){U.targetAxis=e.target.id.replace("drag","").toLowerCase()},beforeStop:function(a,t){U.currentAction=L(a,t)?"del":"";var r=e.viewData.currentLayer[U.targetAxis].length,n="lat"==U.targetAxis||"lng"==U.targetAxis;("del"==U.currentAction||n&&r)&&t.item.sortable.cancel(),"x"==U.targetAxis&&e.dragField&&1===e.dragField.is_build_aggregated&&(i(e.tips["polymer.useAggregate"]),t.item.sortable.cancel()),"y"==U.targetAxis&&C(e.viewData.currentLayer.type,r)&&(i(m.instant("chart.heatMapOneField")),t.item.sortable.cancel()),t.item.sortable.model&&T(U.targetAxis,t.item.sortable.model)},receive:function(e){U.targetAxis=e.target.id.replace("drag","").toLowerCase(),U.updated=!0},update:function(){},stop:function(a,t){var r=t.item.sortable.model;return"del"==U.currentAction?(e.removeField(U.originAxis,r),!1):void e.saveChart()},appendTo:"body",helper:"clone",opacity:.6,"ui-floating":!0,items:".drag-item:not(.not-sortable)",connectWith:".drag-target-list-dimension"};e.removeField=function(a,t){var r=e.viewData.currentLayer[a].indexOf(t);r>-1&&e.viewData.currentLayer[a].splice(r,1),e.saveChart()},e.addField=function(a,t){switch(a){case"lng":case"lat":0===e.viewData.currentLayer[a].length&&(e.viewData.currentLayer[a][0]=t),e.viewData.currentLayer[a].length=1;break;case"x":e.viewData.currentLayer.x.some(function(e){return e.fid===t.fid})||(T("x",t),e.viewData.currentLayer.x.push(t));break;case"y":C(e.viewData.currentLayer.type,e.viewData.currentLayer.y.length)?i(m.instant("chart.heatMapOneField")):(T("y",t),t.is_new=void 0!=t.formula&&""!=t.formula,e.viewData.currentLayer.y.push(t))}e.saveChart()};var O=e.sortLayers={currentAction:"",sort:function(e,a){var t=a.helper;t.css({width:$(this).width()+1}),x(e,a)?t.find(".ico-remove").length||t.find(".layer-name").append('<i class="bdp-icon ico-remove"></i>'):t.find(".layer-name").find(".ico-remove").remove()},beforeStop:function(e,a){O.currentAction=x(e,a)?"del":"","del"==O.currentAction&&a.item.sortable.cancel()},stop:function(a,t){if("del"==O.currentAction){var r=0;return r=F(t.item.sortable.model.layer_id,e.chart_ops.meta.layers),void y(r)}$(".layers").find(".layer-name").find(".ico-remove").remove();for(var i=0,n=e.chart_ops.meta.layers.length;n>i;i++)if(e.chart_ops.meta.layers[i]===e.viewData.currentLayer){e.currentLayerIndex=i;break}e.saveChart()}};e.saveAfterCheckDirty=function(a){return I()?void e.saveChart(a):!1},e.ifEnterDown=function(a){13==a.keyCode&&e.saveAfterCheckDirty({not_need_redraw:!0,only_refresh_data:!1,closeDialog:!1})},e.setGisType=function(a){var t=e.viewData.currentLayer;if(!e.viewData.currentLayer)return i(m.instant("chart.noLayerErr"));if("heatmap"==a&&e.viewData.currentLayer.y.length>1)return i(m.instant("chart.heatMapOneField")+m.instant("chart.removeExtraField"));if("heatmap"==a&&$.isEmptyObject(e.viewData.currentLayer.heatmap_setting)&&(e.viewData.currentLayer.heatmap_setting={radius:10,unit:"px"}),"graph"!==a||e.viewData.currentLayer.graph_type||(e.viewData.currentLayer.graph_type="pie"),"trajectory"===a||"d_trajectory"===a){if("d_trajectory"==a){var r=e.chart_ops.meta.layers.some(function(e){return e==t?!1:e.timeline&&e.timeline.enabled});if(r)return i(m.instant("chart.enableDTrajectoryFail"))}var n=!1;if(e.viewData.currentLayer.y.forEach(function(e){e.aggregator="",e.aggregator_name="",n=!0}),!e.viewData.currentLayer.trajectory){var l=null,o=e.field_list.some(function(e){return"date"!==e.data_type?(l=e,!0):!1});if(!o)return delete e.viewData.currentLayer.sequence,i(m.instatnt("chart.noStrFieldForTrajectory"));e.viewData.currentLayer.trajectory=[l],n=!0}if(!e.viewData.currentLayer.sequence){var s=null,d=e.field_list.some(function(e){return"date"==e.data_type?(s=e,!0):!1});if(!d)return delete e.viewData.currentLayer.trajectory,i(m.instant("chart.noDateFieldForTrajectory"));var c=angular.copy(s);delete c.granularity,delete c.granularity_name,e.viewData.currentLayer.sequence=[c],n=!0}if("d_trajectory"==a&&!e.viewData.currentLayer.timeline){var c=angular.copy(e.viewData.currentLayer.sequence[0]);c.granularity="day",e.viewData.currentLayer.timeline={enabled:!0,field:c,loop:!1,speed:3},n=!0}if(n)return e.viewData.currentLayer.type=a,e.saveChart()}else delete e.viewData.currentLayer.sequence,delete e.viewData.currentLayer.trajectory;e.viewData.currentLayer.type=a,e.saveChart({only_redraw:!0})},e.setGisSymbolType=function(a){e.viewData.currentLayer&&(e.viewData.currentLayer.bubble_symbol=a,e.saveChart({only_redraw:!0}))},e.setGisGraphType=function(a){e.viewData.currentLayer&&(e.viewData.currentLayer.graph_type=a,e.saveChart({only_redraw:!0}))},e.checkRadius=function(){var a=e.viewData.currentLayer.heatmap_setting;return!a||!a.radius||a.radius<0?(i(m.instant("chart.positiveNumber")),void(a.radius=10)):void e.saveChart({only_redraw:!0})},e.onRadiusKeyUp=function(a){13===a.keyCode&&e.checkRadius()},e.onUnitChange=function(){e.saveChart({only_redraw:!0})},e.setGraphColor=function(){if(e.seriesColors=[],e.viewData.currentLayer&&"graph"===e.viewData.currentLayer.type){var a=bdpChart.getColorsByType("C400","bdp");e.viewData.currentLayer.y.forEach(function(t,r){var i=t.nick_name||t.name;t.series_color=t.series_color||a[r%a.length],e.seriesColors.push({color:t.series_color,show_name:i})})}},e.changeTrajectory=function(){e.viewData.currentLayer.sequence[0]&&e.saveChartImmediate()},e.changeSequence=function(){var a=e.viewData.currentLayer;"d_trajectory"==a.type&&(a.timeline||(a.timeline={enabled:!0,loop:!1,speed:3}),a.timeline.field=angular.copy(a.sequence[0]),a.timeline.field.granularity="day"),a.trajectory[0]&&e.saveChartImmediate()},e.enableTimeline=function(){var a=e.viewData.currentLayer;if(!a.tb_id)return delete e.viewData.currentLayer,i(m.instant("chart.noLayerErr"));var t=a.timeline.enabled;if(t){var r=e.chart_ops.meta.layers.some(function(e){return e==a?!1:e.timeline&&e.timeline.enabled});if(r)return delete a.timeline,i(m.instant("chart.enableTimeAnimationFail"));var n=null,l=e.field_list.some(function(e){return"date"==e.data_type?(n=e,!0):!1});if(!l)return delete a.timeline,i(m.instant("chart.noDateFieldForAnimation"));a.timeline.field||(a.timeline.field=n,a.timeline.field.granularity="day"),a.timeline.speed=a.timeline.speed||3}else delete a.timeline;e.saveChartImmediate()},e.setGranularity=function(a,t,r,i,n){r.granularity=i,r.granularity_name=n||"",e.show_timeline_granularity=!1,e.saveChartImmediate()},e.saveChart=function(a){if(!e.saveDone){var t=l.defer();return t.resolve(),t.promise}a=a||{};var r=$("#chartBox").find(".chart").data("bdp-chart-instance");if(r&&r.gisMap&&!$.isEmptyObject(e.chart_ops.meta.layers)){r=r.gisMap.bmap;var i=r.getZoom(),n=r.getCenter();e.chart_ops.meta.zoom=i,e.chart_ops.meta.center=[n.lng,n.lat]}var s,d=e.chart_ops.meta;if(d&&(e.setGraphColor(),s=angular.copy(d),e.viewData.currentLayer)){var c=e.viewData.currentLayer.y.concat(e.viewData.currentLayer.x);angular.forEach(c,function(e){delete e.show_formula}),N(e.viewData.currentLayer),s.layers.some(function(a){return a.layer_id===e.viewData.currentLayer.layer_id?(a.y.forEach(function(e){"MED"===e.aggregator?(e.aggregator="PERCENT",e.percent="0.5"):e.aggregator&&e.aggregator.indexOf("PERCENT")>=0&&(e.aggregator="PERCENT")}),!0):!1})}return S(e.chartId,e.chart_ops.name,s,a.operate).then(function(t){if(e.saveDone=!0,"0"==t.status)if(o.closeAll(),a.callback&&"function"==typeof a.callback&&a.callback(t),A(e.viewData.currentLayer),a.only_redraw){var r=e.$bdpChart;r.updateInfo({meta:s},!0)}else a.not_need_redraw||(e.draw_chart_url.options.t=+new Date)})},e.showFormula=function(e){e.show_formula=!e.show_formula,$(".field-tip").css("display","none")},e.setAdvanceAggregatorName=g,e.showFieldTip=function(e,a){if(a.nick_name){var t=$(e.target).parents(".data-tag").siblings(".field-tip"),r=parseInt(t.css("width")),i=t.children(".arrow"),n=$(e.target).parents("li").position(),l=($(e.target).parents("ul"),parseInt($(e.target).parents("ul").css("width")));t.css("display","block"),t.css("top",n.top+38),l>n.left+r?(t.css("left",0),i.css("left",16)):(t.css({left:"auto",right:"5px"}),i.css("left",r-16-15))}},e.hideFieldTip=function(e){var a=$(e.target).parents(".data-tag").next(".field-tip");a.css("display","none")},e.saveChartImmediate=e.saveChart,k(e.chartId).then(function(a){return a?(e.chart_ops.meta=a.meta,e.chart_ops.name=a.name,e.chart_ops.meta.chart_type=e.chart_ops.meta.chart_type||"C400",e.chart_ops.ct_id=e.tb_id,a.meta.layers&&(e.viewData.currentLayer=a.meta.layers[e.currentLayerIndex],N(e.viewData.currentLayer)),e.fetchTbInfo(a.tb_ids)):void 0}),s(["field.fieldNameRequired","field.fieldTypeRequired","field.fieldFormulaRequired","field.addFieldSuccess","field.modifyFieldSuccess","field.formulaInvalid","field.groupInvalid","chart.delGaugeField","chart.delField","chart.fieldInUsing","chart.buildAggregated","chart.duplicateField","chart.tooManyField","chart.delWarnField","chart.untitledChart","chart.addDrillTip","polymer.useAggregate","polymer.buildAggregateY","polymer.gisUseAggregate","chart.notdrill","chart.emptyChartName","chart.saveSuccess"],e)}]).directive("gisFieldSetting",["ngDialog","errHint","$jsTipTranslate",function(e,a){return{link:function(t){t.setNumDigit=function(a){var r=2,i=angular.copy(a);i.formatter||(i.formatter={check:"num",num:{digit:r,millesimal:!0},percent:{digit:r}}),e.open({template:"/static/partials/dialogTemplates/set_numdigit.html",className:"ngdialog-theme-default numdigit-model",data:{field:i,field_index:a},scope:t})},t.saveNumdigit=function(r,i){return"num"==r.formatter.check&&(r.formatter.num.digit>6||r.formatter.num.digit<0)?void a(t.tips["chart.numDigitInvalid"]):"percent"==r.formatter.check&&(r.formatter.percent.digit>4||r.formatter.percent.digit<0)?void a(t.tips["chart.percentDigitInvalid"]):(i.formatter=r.formatter,t.saveChartImmediate(),void e.closeAll())},t.setNickName=function(a){var r=angular.copy(a);e.open({template:"/static/partials/dialogTemplates/nick_name.html",className:"ngdialog-theme-default nick-model",data:{origin_name:r.nick_name,field_index:a,field:r},scope:t})},t.saveNickName=function(a,r){r.nick_name=a.nick_name,r.unit_adv=a.unit_adv,r.description=a.description,t.saveChartImmediate(),e.closeAll()},t.setAggrFilter=function(a){var r=angular.copy(a);e.open({template:"/static/partials/dialogTemplates/aggr_filter.html",className:"ngdialog-theme-default aggr-filter-model",data:{field_index:a,field:r},scope:t,controller:["$scope",function(e){e.toggleAggrFilterMax=function(){e.field.aggr_filter.disable_max&&(e.field.aggr_filter.max=null)},e.toggleAggrFilterMin=function(){e.field.aggr_filter.disable_min&&(e.field.aggr_filter.min=null)},e.onMaxChange=function(){a.aggr_filter.disable_max=null==e.field.aggr_filter.max},e.onMinChange=function(){a.aggr_filter.disable_min=null==e.field.aggr_filter.min};var a=e.field=e.ngDialogData.field;e.field.aggr_filter?(a.aggr_filter.disable_max=""===a.aggr_filter.max,a.aggr_filter.disable_min=""===a.aggr_filter.min,a.aggr_filter.max=""===a.aggr_filter.max?null:Number(a.aggr_filter.max),a.aggr_filter.min=""===a.aggr_filter.min?null:Number(a.aggr_filter.min)):a.aggr_filter={disable_max:!0,disable_min:!0}}]})},t.saveAggrFilter=function(a,r){null===a.aggr_filter.max&&null===a.aggr_filter.min?delete r.aggr_filter:(null===a.aggr_filter.max&&(a.aggr_filter.max=""),null===a.aggr_filter.min&&(a.aggr_filter.min=""),r.aggr_filter={max:void 0!==a.aggr_filter.max?""+a.aggr_filter.max:"",min:void 0!==a.aggr_filter.min?""+a.aggr_filter.min:""}),t.saveChartImmediate(),e.closeAll()}}}}]);
;!function(){function a(a,n,i,t,r,e){function o(n){var i=angular.copy(n);a.warnConfigData.warnName=i.warn_name,0!=i.warn_time?(a.warnConfigData.warnTime=1,a.warnConfigData.warnExactTime=Number(i.warn_time)):a.warnConfigData.warnTime=i.warn_time,a.warnConfigData.logic=i.meta.logic,i.meta.option.length>0&&angular.forEach(i.meta.option,function(a){7==a.compare_type&&(a.compare_value_left=a.compare_value[0],a.compare_value_right=a.compare_value[1]),a.compare_type=String(a.compare_type)}),a.warnConfigData.warnConditions=i.meta.option,a.warnConfigData.warnName=i.warn_name,a.warnConfigData.warnName=i.warn_name,a.warnConfigData.switchOn=i.switch||1}function w(n,i){var t=!1,r=0,e=0;if("y"==a.warnConfigData.currentAxisType){for(r=0,e=a.warnConfigData.warnItemsYList.length;e>r;r++)if(n==a.warnConfigData.warnItemsYList[r].warn_name&&i!=a.warnConfigData.warnItemsYList[r].warn_id&&a.warnConfigData.type==a.warnConfigData.warnItemsYList[r].type){t=!0;break}}else for(r=0,e=a.warnConfigData.warnItemsYOptionalList.length;e>r;r++)if(n==a.warnConfigData.warnItemsYOptionalList[r].warn_name&&i!=a.warnConfigData.warnItemsYOptionalList[r].warn_id&&a.warnConfigData.type==a.warnConfigData.warnItemsYOptionalList[r].type){t=!0;break}return t}function s(){var n=!0,i=a.warnConfigData;if(!i.warnName)return r(a.tips["warn.inputWarnName"]),n=!1;if(w(i.warnName,i.warnId))return r(a.tips["warn.repeatWarnName"]),n=!1;if(1==i.warnTime&&!i.warnExactTime)return r(a.tips["filter.inputCompleteCondition"]),n=!1;for(var t={},e=0,o=i.warnConditions.length;o>e;e++){if(t=i.warnConditions[e],!t.fid){r(a.tips["filter.inputCompleteCondition"]),n=!1;break}if(!t.compare_type){r(a.tips["filter.inputCompleteCondition"]),n=!1;break}if(7==t.compare_type){if(void 0===t.compare_value_left||void 0===t.compare_value_right){r(a.tips["warn.inputFormatError"]),n=!1;break}if(null===t.compare_value_left||""===t.compare_value_left||null===t.compare_value_right||""===t.compare_value_right){r(a.tips["filter.inputCompleteCondition"]),n=!1;break}if(t.compare_value_left>=9007199254740992||t.compare_value_left<=-9007199254740992||t.compare_value_right>=9007199254740992||t.compare_value_right<=-9007199254740992){r(a.tips["warn.valueOutOfRange"]+":-9007199254740991 ~ 9007199254740991"),n=!1;break}if(t.compare_value_left>t.compare_value_right){r(a.tips["warn.valueCompareTips"]),n=!1;break}}else{if(void 0===t.compare_value){r(a.tips["warn.inputFormatError"]),n=!1;break}if(null===t.compare_value||""===t.compare_value){r(a.tips["filter.inputCompleteCondition"]),n=!1;break}if(t.compare_value>=9007199254740992||t.compare_value<=-9007199254740992){r(a.tips["warn.valueOutOfRange"]+":-9007199254740991 ~ 9007199254740991"),n=!1;break}}}return n}function f(){var n=angular.copy(a.warnConfigData);a.warnConfigData.modifyData.warn_name=n.warnName,a.warnConfigData.modifyData.axis_type="y"==n.currentAxisType?0:1,a.warnConfigData.modifyData.warn_id=n.warnId,a.warnConfigData.modifyData.type=n.type,a.warnConfigData.modifyData.switch=n.switchOn?1:0,1==n.warnTime&&(a.warnConfigData.modifyData.warn_time=n.warnExactTime),a.warnConfigData.modifyData.meta.logic=n.logic,a.warnConfigData.modifyData.meta.option=[],angular.forEach(n.warnConditions,function(n){7==n.compare_type&&(n.compare_value=[],n.compare_value.push(n.compare_value_left),n.compare_value.push(n.compare_value_right)),n.compare_type=parseInt(n.compare_type),a.warnConfigData.modifyData.meta.option.push(n)})}function l(){a.warnConfigData.currentAction="",a.warnConfigData.currentAxisType="",a.warnConfigData.warnId="",a.warnConfigData.warnTime="0",a.warnConfigData.warnExactTime=1,a.warnConfigData.warnConditions=[],a.warnConfigData.warnName="",a.warnConfigData.logic="and",a.warnConfigData.switchOn=!0,a.warnConfigData.modifyData={warn_name:"",warn_id:"",axis_type:0,meta:{logic:"",option:[]},warn_time:0}}function g(){if(a.warnConfigData.isDash)a.warnConfigData.isDash&&(a.$emit("refreshChartForWarn",!0),a.warnConfigDialog.close());else{if(!$(".drill-crumbs").length){var n=[bdpChart.ChartType.Table,bdpChart.ChartType.BubbleMap,bdpChart.ChartType.AreaMap];if(n.indexOf(a.$bdpChart.getChartType())>-1)a.saveChartImmediate({set_warn:!0});else{var i=a.$bdpChart.info,r=a.warnConfigData.warnItemsYList.concat(a.warnConfigData.warnItemsYOptionalList);i.warn_info=r,a.saveChartImmediate({only_redraw:!0})}}t.closeAll()}}a.warnConfigData={ct_id:"",rule_id:"",currentAction:"",currentAxisType:"",isYAxis:null,isYOptionalAxis:null,warnConfigView:"",warnItemsYList:[],warnItemsYOptionalList:[],warnConditions:[],warnAxisFields:[],warnAxisYFields:[],warnAxisYOptionalFields:[],warnId:"",warnTime:"0",warnExactTime:1,warnName:"",switchOn:null,logic:"and",type:0,isDash:null,modifyData:{warn_name:"",warn_id:"",axis_type:0,meta:{logic:"",option:[]},warn_time:0,type:0,"switch":!0}},a.warnConfigData.warnConfigView="list",a.warnConfigData.ct_id=a.ngDialogData.ct_id?a.ngDialogData.ct_id:"",a.warnConfigData.rule_id=a.ngDialogData.rule_id?a.ngDialogData.rule_id:"",a.warnConfigData.type=a.ngDialogData.role_type?a.ngDialogData.role_type:0,a.warnConfigData.isYAxis=a.ngDialogData.isYAxis,a.warnConfigData.isYOptionalAxis=a.ngDialogData.isYOptionalAxis,a.warnConfigData.warnItemsYList=a.ngDialogData.warnYList?a.ngDialogData.warnYList:[],a.warnConfigData.warnItemsYOptionalList=a.ngDialogData.warnYOptionalList?a.ngDialogData.warnYOptionalList:[],a.warnConfigData.warnAxisYFields=a.ngDialogData.yFieldsList?a.ngDialogData.yFieldsList:[],a.warnConfigData.warnAxisYOptionalFields=a.ngDialogData.yOptionalFieldsList?a.ngDialogData.yOptionalFieldsList:[],a.warnConfigData.isDash=a.ngDialogData.isDash;var m={fid:"",uniq_id:0,fid_name:"",compare_type:"",compare_value:""};a.warnTimeMap=[{value:1,name:"1:00"},{value:2,name:"2:00"},{value:3,name:"3:00"},{value:4,name:"4:00"},{value:5,name:"5:00"},{value:6,name:"6:00"},{value:7,name:"7:00"},{value:8,name:"8:00"},{value:9,name:"9:00"},{value:10,name:"10:00"},{value:11,name:"11:00"},{value:12,name:"12:00"},{value:13,name:"13:00"},{value:14,name:"14:00"},{value:15,name:"15:00"},{value:16,name:"16:00"},{value:17,name:"17:00"},{value:18,name:"18:00"},{value:19,name:"19:00"},{value:20,name:"20:00"},{value:21,name:"21:00"},{value:22,name:"22:00"},{value:23,name:"23:00"},{value:24,name:"24:00"}],a.warnOperatorMap=i,a.addWarnItem=function(n){if(a.warnConfigData.warnItemsYList.length+a.warnConfigData.warnItemsYOptionalList.length>=20)return void r(a.tips["warn.warnNumMoreThanTwenty"]);var i=[];a.warnConfigData.currentAction="add",a.warnConfigData.warnConfigView="edit",a.warnConfigData.warnId="",a.warnConfigData.currentAxisType=n,a.warnConfigData.switchOn=!0,a.warnConfigData.warnAxisFields="y"==n?a.warnConfigData.warnAxisYFields:a.warnConfigData.warnAxisYOptionalFields,i=a.warnConfigData.warnAxisFields,a.warnConfigData.warnConditions.push({fid:i[0].fid,uniq_id:i[0].uniq_id,fid_name:i[0].name,compare_type:"3",compare_value:0})},a.editWarnItem=function(n,i){a.warnConfigData.currentAction="edit",a.warnConfigData.warnConfigView="edit",a.warnConfigData.currentAxisType=i,a.warnConfigData.warnAxisFields="y"==i?a.warnConfigData.warnAxisYFields:a.warnConfigData.warnAxisYOptionalFields,a.warnConfigData.warnId=n.warn_id,o(n)},a.delWarnItem=function(i,t,e){var o={ct_id:a.warnConfigData.ct_id,rule_id:a.warnConfigData.rule_id,warn_id:t.warn_id};a.showLoading=!0,n.warn.del(o).then(function(n){a.showLoading=!1,0==Number(n.status)?(r(a.tips["chart.warnDelSuccess"]),"y"==e?a.warnConfigData.warnItemsYList.splice(i,1):a.warnConfigData.warnItemsYOptionalList.splice(i,1)):r(Number(n.status))})},a.addWarnCondition=function(){a.warnConfigData.warnConditions.push(angular.copy(m)),scrollToBottom($(".warn-edit-list"))},a.delWarnCondition=function(n){a.warnConfigData.warnConditions.splice(n,1)},a.changeWarnField=function(n,i,t){angular.forEach(a.warnConfigData.warnAxisFields,function(n){n.uniq_id==i&&(a.warnConfigData.warnConditions[t].fid=n.fid,a.warnConfigData.warnConditions[t].fid_name=n.name)})},a.saveWarnConfig=function(){function i(n){var i=0,r=0;if("edit"==a.warnConfigData.currentAction)if("y"==a.warnConfigData.currentAxisType)for(i=0,r=a.warnConfigData.warnItemsYList.length;r>i;i++)a.warnConfigData.warnId==a.warnConfigData.warnItemsYList[i].warn_id&&(a.warnConfigData.warnItemsYList[i]=t);else for(i=0,r=a.warnConfigData.warnItemsYOptionalList.length;r>i;i++)a.warnConfigData.warnId==a.warnConfigData.warnItemsYOptionalList[i].warn_id&&(a.warnConfigData.warnItemsYOptionalList[i]=t);else"add"==a.warnConfigData.currentAction&&(t.switch=!0,t.warn_id=n,"y"==a.warnConfigData.currentAxisType?a.warnConfigData.warnItemsYList.push(t):a.warnConfigData.warnItemsYOptionalList.push(t));a.warnConfigData.warnConfigView="list",l()}if(s()){f();var t=angular.copy(a.warnConfigData.modifyData),e={ct_id:a.warnConfigData.ct_id,rule_id:a.warnConfigData.rule_id,data:t,warn_id:a.warnConfigData.warnId};"add"==a.warnConfigData.currentAction?(e={ct_id:a.warnConfigData.ct_id,rule_id:a.warnConfigData.rule_id,data:t},a.showLoading=!0,n.warn.add(e).then(function(n){a.showLoading=!1,0==Number(n.status)?(r(a.tips["chart.warnAddSuccess"]),i(n.result)):r(Number(n.status))})):(e={ct_id:a.warnConfigData.ct_id,rule_id:a.warnConfigData.rule_id,data:t,warn_id:a.warnConfigData.warnId},a.showLoading=!0,n.warn.modify(e).then(function(n){a.showLoading=!1,0==Number(n.status)?(r(a.tips["chart.warnModifySuccess"]),i("")):r(Number(n.status))}))}},a.cancelWarnConfig=function(){a.warnConfigData.warnConfigView="list",l()},a.saveChartWarn=function(){var i=[],t=[],e=0,o=0;if(a.warnConfigData.isYAxis)for(e=0,o=a.warnConfigData.warnItemsYList.length;o>e;e++)a.warnConfigData.warnItemsYList[e].switch?i.push({warn_id:a.warnConfigData.warnItemsYList[e].warn_id,type:a.warnConfigData.warnItemsYList[e].type}):t.push({warn_id:a.warnConfigData.warnItemsYList[e].warn_id,type:a.warnConfigData.warnItemsYList[e].type});if(a.warnConfigData.isYOptionalAxis)for(e=0,o=a.warnConfigData.warnItemsYOptionalList.length;o>e;e++)a.warnConfigData.warnItemsYOptionalList[e].switch?i.push({warn_id:a.warnConfigData.warnItemsYOptionalList[e].warn_id,type:a.warnConfigData.warnItemsYOptionalList[e].type}):t.push({warn_id:a.warnConfigData.warnItemsYOptionalList[e].warn_id,type:a.warnConfigData.warnItemsYOptionalList[e].type});if(a.warnConfigData.isYAxis&&a.warnConfigData.warnItemsYList.length>0||a.warnConfigData.isYOptionalAxis&&a.warnConfigData.warnItemsYOptionalList.length>0){var w={ct_id:a.warnConfigData.ct_id,open_warn_ids:angular.toJson(i),off_warn_ids:angular.toJson(t),rule_id:a.warnConfigData.rule_id};a.showLoading=!0,n.warn.warnSwitch(w).then(function(n){a.showLoading=!1,0==Number(n.status)?(r(a.tips["chart.warnSetSuccess"]),g()):r(Number(n.status))})}else g()},a.cancelChartWarn=function(){g()},e(["warn.inputWarnName","warn.repeatWarnName","filter.inputCompleteCondition","warn.inputFormatError","warn.valueOutOfRange","warn.valueCompareTips","warn.warnNumMoreThanTwenty","chart.warnAddSuccess","chart.warnModifySuccess","chart.warnSetSuccess","chart.warnDelSuccess"],a)}angular.module("BC.controllers.setWarn",[]).controller("chartWarnConfigCtrl",a),a.$inject=["$scope","commonService","warnOperatorMap","ngDialog","errHint","$jsTipTranslate"]}();
;!function(){function e(){return{templateUrl:"/static/partials/directiveTemplates/trainModelList.html",link:function(e){e.getModelList()},controller:t}}function t(e,t,a,i,r,n){t.view="train",t.show_bdp_header=!0;var o=a.mdlId||"";e.getModelList=function(){r.model.list({}).then(function(t){if(0===+t.status&&(e.modelList=t.result||[],e.modelList.length>0)){var a;if(o){for(var i=0;i<t.result.length;i++)if(t.result[i].mdl_id===o){a=t.result[i];break}}else a=e.modelList[0];e.selectModelByTab(a)}})},e.selectModelByTab=function(t){e.selectedModel=t,i.path("/train/"+t.mdl_id)},e.delModel=function(t,a){confirm(e.tips["model.deleteConfirm"])&&r.model.del({mdl_id:t}).then(function(r){0===+r.status&&(e.selectedModel.mdl_id===t?(e.modelList.splice(a,1),e.modelList.length>0?e.selectModelByTab(e.modelList[0]):(e.selectedModel={},i.path("/train"))):e.modelList.splice(a,1))})},e.addNewModel=function(){i.path("/train_model")},n(["model.deleteConfirm"],e)}function a(e,t,a,i,r,n,o,l,s){function d(){t.show_bdp_header=!0,h=a.mdlId,e.modelSetData={},e.modelSetInfo={},e.activeTab={index:1},e.modelAlgoList=l,e.formulaKeyMap=o,y={1:{marker:{enabled:!1,symbol:"circle",lineColor:null,lineWidth:2,radius:3,fillColor:"rgba(255,255,255,0)",states:{hover:{enabled:!0,lineColor:"#FFF",lineWidth:3,radius:3,fillColor:"rgba(255,255,255,0)"}}},halo:{opacity:1,size:8,attributes:{zIndex:2,fill:"rgba(255,255,255,0.15)","stroke-width":6,stroke:"rgba(255,255,255,0.05)"}}},2:{marker:{enabled:!1,symbol:"circle",lineColor:null,lineWidth:2,radius:3,fillColor:"#FFF",states:{hover:{enabled:!0,lineColor:null,lineWidth:3,radius:3,fillColor:"#FFF"}}},halo:{opacity:.3,size:8,attributes:{zIndex:2,"stroke-width":6}}}},b="zh"==language?{0:"训练成功",1:"排队中",2:"训练中",3:"训练失败",4:"训练完成，需要手动设置聚类字段的相关信息"}:{0:"Training success.",1:"In the training queue.",2:"Training...",3:"Training failed.",4:"Training completed, you have to config the field manually."},e.clusterRsData={},h&&e.getPreviewData(h)}function u(e){var t=bdpChart.helper,a={head:[],body:[]},i=e.x.length?e.x[0].data.length:e.y.length?e.y[0].data.length:0;e.x.forEach(function(e){a.head.push({name:e.name,fid:e.fid,data_type:e.data_type,is_build_field:e.is_build_field,nick_name:e.nick_name})}),e.y.forEach(function(e){a.head.push({name:e.name,fid:e.fid,data_type:e.data_type,is_build_field:e.is_build_field,nick_name:e.nick_name})});for(var r,n,o=0;i>o;o++)a.body[o]=[],e.x.forEach(function(e){r=e.data[o],"date"===e.data_type&&(n=e.granularity,r=t.checkGranularity(n,r)),a.body[o].push(r)}),e.y.forEach(function(e){a.body[o].push(e.data[o])});return a}function m(t){i.model.result({mdl_id:t}).then(function(a){if(0===+a.status){var i=a.result;e.trainStatus=i.status,e.trainStatusText=b[i.status],(1==i.status||2==i.status)&&n(function(){m(t)},2e3)}})}function f(t){var a=t.train_meta.train_set_info,i=[];t.train_result.model_parameters.forEach(function(r,n){n<t.train_result.model_parameters.length-1?i.push(r>=0?"+ "+r:"- "+-r," * ["+a.features[n].nick_name+"("+e.formulaKeyMap[a.features[n].aggregator]+")]"):i.push(r>=0?"+ "+r:"- "+-r)});var r=i.join(" ");"+"===r[0]?r=r.replace(/^\+\s/,""):"-"===r[0]&&(r=r.replace(/^\-\s/,"-"));var n="["+a.predict_value[0].nick_name+"("+e.formulaKeyMap[a.predict_value[0].aggregator]+")]";e.formulaStr=n+" = "+r}function c(){var e={};return"1"==usedThemeId&&(e={tooltip:{style:{color:"rgba(255,255,255,0.8)"}},xAxis:{title:{style:{color:"rgba(255, 255, 255, 0.3)"}},labels:{style:{color:"rgba(255, 255, 255, 0.3)"}},lineColor:"rgba(255, 255, 255, 0.1)"},yAxis:[{title:{style:{color:"rgba(255, 255, 255, 0.3)"}},labels:{style:{color:"rgba(255, 255, 255, 0.3)"}},lineColor:"rgba(255, 255, 255, 0.1)"}]}),e}function p(e){for(var t=c(),a=[],i=1;i<=e.train_result.iterator_num;i++)a.push(i);var r={chart:{type:"line"},colors:["#3EB27E","#FFCA63","#FF8549","#5182E4","#ABDB9C","#96C8F5","#5CBBF6","#4660BA","#8058E1","#E56FB7","#EF6064","#606C84"],title:{text:""},tooltip:{useHTML:!0,crosshairs:!1,style:{color:"rgba(0,0,0,.6)"},formatter:function(){var e=this.x,t=this.y;void 0===this.y&&(t="NaN");var a='<table class="tooltips-table">';return a+='<tr><td style="text-align:right;">迭代次数</td><td style="text-align: left;">：'+e+"</td></tr>",a+='<tr><td style="text-align:right;">均方误差</td><td style="text-align: left;">：'+t+"</td></tr>"}},plotOptions:{line:{lineWidth:4,marker:y[usedThemeId].marker,states:{hover:{halo:y[usedThemeId].halo}}},spline:{lineWidth:4,marker:y[usedThemeId].marker,states:{hover:{halo:y[usedThemeId].halo}}}},xAxis:{title:{text:"迭代次数"},categories:a},yAxis:[{title:{text:"均方误差"},lineWidth:0}],series:[{name:"均方误差",data:e.train_result.mse_history}]};$.extend(!0,r,t),$("#modelResultChart").highcharts(r)}function g(t){var a=t.result,i={edit:4===+t.status,groupName:a.train_result.name||"",groups:a.train_result.cluster_names||[],centers:a.train_result.centers||[],train_set_info:a.train_meta.train_set_info||{},head:[{name:"聚类结果"},{name:"组间距"},{name:"分类数量"}],body:[]},r=a.train_result.centers,n=a.train_meta.train_set_info.features,o=a.train_result.cluster_mean_distance,l=a.train_result.cluster_numbers;i.head=i.head.concat(n);for(var s=0;s<r.length;s++)i.body[s]=["结果"+(s+1),o[s],l[s]].concat(r[s]),4===+t.status&&i.groups.push("");if(i.body[0]&&i.head.length<i.body[0].length)for(var d=i.head.length,u=i.body[0].length,s=0;u-d>s;s++)i.head.push({name:"未知"});e.clusterRsData=i}function _(t){if(0!=t.status&&4!=t.status)return!1;var a=t.result;e.modelChartInfo={},1==a.train_meta.type?(f(a),p(a)):2==a.train_meta.type&&g(t)}var h,y,b;e.showTab=function(t){e.activeTab.index!=t&&(e.activeTab.index=t,3===t&&e.getModelResult(e.selectedModel.mdl_id))},e.getPreviewData=function(t){e.trainStatus=0,i.model.preview({mdl_id:t}).then(function(a){if(0===+a.status){var i=a.result;e.modelSetData=u(i.data),e.modelSetInfo=i.info,e.trainStatus=i.info.status,e.trainStatusText=b[i.info.status],(1==i.info.status||2==i.info.status)&&n(function(){m(t)},2e3)}})},e.getModelInfo=function(t){i.model.info({mdl_id:t}).then(function(t){if(0===+t.status){var a=t.result;e.modelSetInfo=a.meta}})},e.getModelResult=function(t){e.trainStatus=0,i.model.result({mdl_id:t}).then(function(t){if(0===+t.status){var a=t.result;e.trainStatus=a.status,e.trainStatusText=b[a.status],_(a)}})},e.editModel=function(e){r.path("/train_model/"+e)},e.editRsField=function(){e.clusterRsData?e.clusterRsData.edit=!0:e.clusterRsData={edit:!0}},e.saveRsField=function(){var t;if(t)return!1;var a=e.clusterRsData.groups;if(!e.clusterRsData.groupName)return s("请填写聚类字段名称"),!1;for(var r=0;r<a.length;r++){if(!a[r])return s("请填写第"+(r+1)+"个分类别名"),!1;if(a.indexOf(a[r])!=r)return s("请修改重复分类别名“"+a[r]+"”"),!1}t=!0;var n={train_set_info:e.clusterRsData.train_set_info,centers:e.clusterRsData.centers,name:e.clusterRsData.groupName,cluster_names:a};i.model.saveClusterRs({mdl_id:e.modelSetInfo.mdl_id,tb_id:e.modelSetInfo.tb_id,ws_id:"",meta:angular.toJson(n)}).then(function(a){t=!1,0===+a.status&&(s("保存成功"),e.clusterRsData.edit=!1)})},d()}function i(e,t,a,i,r,n,o,l,s,d,u,m,f){function c(t,a){o.get("/api/data_aggr/fields",{tb_id:t}).then(function(r){0==+r.status?(i.closeAll(),e.trainSetInfo.fields=r.result.fields,e.trainSetInfo.chooseTableTbType=r.result.tb_type,e.trainSetInfo.current_tb_id!==t&&(e.trainSetInfo.meta=angular.copy(v)),e.trainSetInfo.current_tb_name=a,e.trainSetInfo.current_tb_id=t,y()):n(30003==+r.status?r.errstr:40002==+r.status?r.errstr?e.tips["error.fieldRepeat"]+":"+r.errstr:+r.status:r.errstr)})}function p(e,t){var a=Math.abs(e.x1+e.x2-t.x1-t.x2),i=e.x2-e.x1+(t.x2-t.x1),r=Math.abs(e.y1+e.y2-t.y1-t.y2),n=e.y2-e.y1+(t.y2-t.y1);return i>=a&&n>=r}function g(e,t){var a={x1:t.offset.left,y1:t.offset.top,x2:t.offset.left+t.helper.width(),y2:t.offset.top+t.helper.height()},i=$(".polymer-content-hd"),r=i.offset(),n={x1:r.left,y1:r.top,x2:r.left+i.width(),y2:r.top+i.height()};return!p(a,n)}function _(){r(function(){var t=$("#polymer-content-hd").height();e.polymerView.top=t+23+"px"},10)}function h(t){s.model.modify({mdl_id:b,tb_id:e.trainSetInfo.current_tb_id,name:e.trainSetInfo.model_name,model_type:e.trainSetInfo.meta.type||1,meta:angular.toJson(t)}).then(function(t){e.global.clickComplete=!0,e.showLoading=!1,0===+t.status&&(n(e.tips.saveSuccess),e.back(t.result))})}function y(){e.trainSetInfo.fields_list=bdp.utils.addSpecParamsToFields(e.trainSetInfo.fields),angular.forEach(e.trainSetInfo.fields_list,function(e){e.origin_name=e.name,e.name=e.nick_name})}t.view="train",t.show_bdp_header=!1;var b=l.mdlId;e.polymerView={show_formula_y:[],show_formula_predict:[],show_formula_date:{},loading:!1,show_edit:{}},e.formulaKeyMap=d;var v={type:1,train_set_info:{dimensions:[],features:[],predict_value:[],scaler:0},train_option:{iterator_num:100,step_size:1e-6,train_algorithm:0,max_batch_num:1e5,model_initiation:0,k:1,init_algorithm:0,distance_function:0}};e.trainSetInfo={meta:angular.copy(v),current_tb_name:"",model_name:"",modelAlgoList:f,current_field:{},formula:[{name:"求和",type:"SUM",show:"number"},{name:"平均值",type:"AVG",show:"number"},{name:"计数",type:"COUNT",show:"all"},{name:"去重计数",type:"COUNT_DISTINCT",show:"all"},{name:"最大值",type:"MAX",show:"number"},{name:"最小值",type:"MIN",show:"number"}],date_formula:[{name:"按年",type:"year"},{name:"按季",type:"quarter"},{name:"按月",type:"month"},{name:"按周",type:"week"},{name:"按日",type:"day"},{name:"按时",type:"hour"},{name:"按分",type:"minute"},{name:"按秒",type:"second"}]},e.back=function(e){e&&(b=e);var t=b?"/train/"+b:"/train";a.path(t)},e.chooseTbModel=function(){var t=function(t){e.saveFolderList=angular.copy(t),angular.forEach(e.saveFolderList,function(e){"folder_root"==e.folder_id&&(e.name="en"==$.cookie("locale")?"Root":"根目录")}),e.folderList=t,e.original_folderList=angular.copy(t),e.$broadcast("updatefolderList",e.original_folderList),i.open({template:"/static/partials/choose_table_list.html",className:"ngdialog-theme-default data-source choose-table-list",data:{json_data:{title:"选择数据表",type:"choose",show_upload:!1},choose_table:{tb_id:""}},scope:e})};o.get("/api/folder/list").then(function(e){0==e.status&&t(e.result)})},e.chooseTableOk=function(t){return t.tb_id?(e.trainSetInfo.chooseTableTbType=t.tb_type,void c(t.tb_id,t.name)):void n(e.tips["wb.selectWorkSheet"])},e.getModelInfo=function(t){s.model.info({mdl_id:t}).then(function(t){if(0===+t.status){var a=t.result;e.trainSetInfo.meta=a.meta,e.trainSetInfo.model_name=a.name,e.trainSetInfo.current_tb_name=a.tb_name,e.trainSetInfo.current_tb_id=a.tb_id,c(a.tb_id,a.tb_name)}})},b?e.getModelInfo(b):e.chooseTbModel(),e.sortPolymerOption={originAxis:"",targetAxis:"",currentAction:""},e.sortPolymerField={connectWith:".axis-field-list",opacity:.6,"ui-floating":!0,start:function(t,a){var i=$(a.item[0].parentNode);i.hasClass("x-field-list")?e.sortPolymerOption.originAxis="x":i.hasClass("y-field-list")?e.sortPolymerOption.originAxis="y":i.hasClass("predict-field-list")&&(e.sortPolymerOption.originAxis="predict")},sort:function(e,t){var a=t.helper;a.css({width:$(this).width()+1});var i=angular.element(".ui-sortable-helper");g(e,t)?i.find(".ico-remove").length||i.find(".name").append('<i class="bdp-icon ico-remove"></i>'):i.find(".name").find(".ico-remove").remove()},beforeStop:function(t,a){e.sortPolymerOption.currentAction=g(t,a)?"del":"sort"},update:function(t,a){var i=$(a.item.sortable.droptarget);i.hasClass("x-field-list")?e.sortPolymerOption.targetAxis="x":i.hasClass("y-field-list")?e.sortPolymerOption.targetAxis="y":i.hasClass("predict-field-list")&&(e.sortPolymerOption.targetAxis="predict");var r=e.sortPolymerOption.targetAxis;"predict"!=r||a.item.sortable.received||0===a.item.sortable.droptargetModel.length||a.item.sortable.cancel(),e.formatFieldForAxis(r)},stop:function(t,a){var i=e.sortPolymerOption.originAxis;return"del"==e.sortPolymerOption.currentAction?void e.deleteField(i,a.item.sortable.model):void _()}},e.sortFieldAtX=function(e){return e={fid:e.fid,name:e.name,nick_name:e.nick_name||e.name,data_type:e.data_type,is_build_aggregated:e.is_build_aggregated,formula:e.formula},"date"==e.data_type&&(e.granularity="day"),e},e.sortFieldAtY=function(t){var a,i="SUM";return"number"!==t.data_type&&(i="COUNT"),a=d[i],t={fid:t.fid,name:t.name,nick_name:t.nick_name||t.name,data_type:t.data_type,aggregator:1!=t.is_build_aggregated?i:"",aggregator_name:1!=t.is_build_aggregated?a:"",is_build_aggregated:t.is_build_aggregated,formula:t.formula},"date"==t.data_type&&(t.granularity="day"),e.polymerView.show_formula_y.push(!1),t},e.formatFieldForAxis=function(t){if("x"==t)angular.forEach(e.trainSetInfo.meta.train_set_info.dimensions,function(e){"date"==e.data_type&&""!=e.granularity&&(e.granularity="day"),e.hasOwnProperty("aggregator")&&(delete e.aggregator,delete e.aggregator_name)});else{var a="",i="",r="y"===t?e.trainSetInfo.meta.train_set_info.features:e.trainSetInfo.meta.train_set_info.predict_value;angular.forEach(r,function(e){e.hasOwnProperty("aggregator")||(a="number"!==e.data_type?"COUNT":"SUM",i=d[a],e.aggregator=1!=e.is_build_aggregated?a:"",e.aggregator_name=1!=e.is_build_aggregated?a:""),"date"==e.data_type&&""!=e.granularity&&(e.granularity="day")})}},e.deleteField=function(t,a){if("x"==t){var i=e.trainSetInfo.meta.train_set_info.dimensions.indexOf(a);i>-1&&e.trainSetInfo.meta.train_set_info.dimensions.splice(i,1)}else if("y"==t){var i=e.trainSetInfo.meta.train_set_info.features.indexOf(a);i>-1&&e.trainSetInfo.meta.train_set_info.features.splice(i,1)}else if("predict"==t){var i=e.trainSetInfo.meta.train_set_info.predict_value.indexOf(a);i>-1&&e.trainSetInfo.meta.train_set_info.predict_value.splice(i,1)}_()},e.startDragField=function(t,a,i,r){return e.trainSetInfo.current_field={},curField=e.trainSetInfo.current_field,curField.fid=i.fid,curField.name=i.name,curField.data_type=i.data_type,curField.nick_name=i.nick_name,curField.is_build_aggregated=i.is_build_aggregated,curField.formula=i.formula,angular.element(".axis").append('<div class="draggable-area"></div>'),r?(e.sortPolymerOption.originAxis=r,curField.fid=i.fid+"_"+r,curField.data_type="sub_date",void(curField.name=u[r]+"("+curField.name+")")):void(e.sortPolymerOption.originAxis="field-list")},e.stopDragField=function(){angular.element(".draggable-area").remove()},e.onDropAdd=function(t,a,i){if(["x","y","predict"].indexOf(e.sortPolymerOption.originAxis)>-1)return void angular.element(".axis").find(".ico-remove").remove();var r=e.trainSetInfo.current_field,o={},l=e.trainSetInfo.meta.train_set_info;if("x"==i){if(1===r.is_build_aggregated&&!("date"==r.data_type&&(r.formula.indexOf("MAX_DATE")>=0||r.formula.indexOf("max_date")>=0||r.formula.indexOf("MIN_DATE")>=0)||r.formula.indexOf("min_date")>=0))return n(e.tips["polymer.useAggregate"]),!1;for(var s=l.dimensions,u=0,m=s.length;m>u;u++)if(s[u].fid==r.fid)return void n(e.tips["polymer.isAdd"]);o={fid:r.fid,name:r.name,nick_name:r.nick_name||r.name,data_type:r.data_type,is_build_aggregated:r.is_build_aggregated,formula:r.formula},"date"==r.data_type&&(o.granularity="day"),s.push(o)}else{var f,c="SUM";if("number"!==r.data_type&&(c="COUNT"),f=d[c],o={fid:r.fid,name:r.name,nick_name:r.nick_name||r.name,data_type:r.data_type,aggregator:1!=r.is_build_aggregated?c:"",aggregator_name:1!=r.is_build_aggregated?f:"",is_build_aggregated:r.is_build_aggregated,formula:r.formula},"date"==r.data_type&&(o.granularity="day"),"y"===i){if(2==e.trainSetInfo.meta.type){if("number"!==r.data_type)return n("聚类分析特征值只可以是数值类型"),!1;for(var u=0;u<l.features.length;u++)if(r.fid===l.features[u].fid)return n("已经添加过该字段"),!1;delete o.aggregator,delete o.aggregator_name,delete o.formula}l.features.push(o),e.polymerView.show_formula_y.push(!1)}else"predict"===i&&0===l.predict_value.length&&(l.predict_value.push(o),e.polymerView.show_formula_predict.push(!1))}_()},e.switchGranularity=function(t,a){e.trainSetInfo.meta.train_set_info.dimensions[a].granularity=t.type},e.switchAggregator=function(t,a,i){var r=e.trainSetInfo.meta.train_set_info;"y"===i?(r.features[a].aggregator=t.type,r.features[a].aggregator_name=t.name):"predict"===i&&(r.predict_value[a].aggregator=t.type,r.predict_value[a].aggregator_name=t.name)},e.switchAlgo=function(t){var a=e.trainSetInfo.meta.train_set_info,i=e.trainSetInfo.meta.train_option;1==t?(a.predict_value=[],a.dimensions=[],a.features=[],i.step_size=1e-6,i.iterator_num=100):2==t&&(a.features=[],i.k=5,i.init_algorithm=0,i.distance_function=0,i.iterator_num=50)},e.save=function(){var t=e.trainSetInfo.meta,a=t.train_set_info,r=t.train_option,o=!0;return e.trainSetInfo.model_name?a.features.length<1&&(n(e.tips["model.vFeaturesCantNull"]),o=!1):(n(e.tips["model.vNameCantNull"]),o=!1),1==t.type?a.predict_value.length<1?(n(e.tips["model.outputCantNull"]),o=!1):!r.iterator_num||!isPositiveInteger(r.iterator_num)||r.iterator_num>100?(n(e.tips["model.iterationNumberErr1"]),o=!1):r.step_size<=0&&(n(e.tips["model.iterationStepErr"]),o=!1):2==t.type&&(!r.iterator_num||!isPositiveInteger(r.iterator_num)||r.iterator_num>50?(n(e.tips["model.iterationNumberErr2"]),o=!1):(r.k<=0||r.k>100||void 0===r.k)&&(n(e.tips["model.clusterCountErr"]),o=!1)),o?void(1==t.type?(e.global.clickComplete=!1,e.showLoading=!0,delete r.k,delete r.init_algorithm,delete r.distance_function,a.scaler=0,h(t)):2==t.type&&(delete a.predict_value,delete a.dimensions,delete r.step_size,delete r.train_algorithm,delete r.max_batch_num,delete r.model_initiation,a.scaler=1,i.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngdialog-width-340",scope:e,data:{message:"保存后将开始训练，训练完成后请对聚类结果进行标示。",okClick:function(){e.global.clickComplete=!1,e.showLoading=!0,h(t)},calcelClick:function(){e.global.clickComplete=!0,e.showLoading=!1}}}))):(e.global.clickComplete=!0,e.showLoading=!1,!1)},e.createFieldFormula=function(){if(e.newField={type:"create",name:"",aggregator:"",tb_id:e.trainSetInfo.current_tb_id},e.newField.tb_id){t.pageLoading=!0;var a="/static/partials/add_field.html";i.open({template:a,data:{fieldList:e.trainSetInfo.fields_list},className:"ngdialog-theme-default add-field-dialog",scope:e})}else n(3009)},e.createFieldGroup=function(){if(e.newField={type:"create",name:"",aggregator:"",tb_id:e.trainSetInfo.current_tb_id},e.newField.tb_id){t.pageLoading=!0;var a="/static/partials/field_groups.html";i.open({template:a,data:{fieldList:e.trainSetInfo.fields_list},className:"ngdialog-theme-default add-field-dialog group-field-dialog",scope:e})}else n(3009)},e.addCalcField=function(t){e.global.clickComplete=!1;var a=!1,a=!1;if(t.name?t.data_type||t.param?t.aggregator.trim()||t.param&&"group"==t.param.type||(n(e.tips["field.fieldFormulaRequired"]),a=!0):(n(e.tips["field.fieldTypeRequired"]),a=!0):(n(e.tips["field.fieldNameRequired"]),a=!0),a)return e.global.clickComplete=!0,!1;var l="create"==t.type?e.tips["polymer.addFieldSuccess"]:e.tips["polymer.editFieldSuccess"];if("create"!=t.type){var d=!1,u=e.trainSetInfo.meta.train_set_info.dimensions,m=e.trainSetInfo.meta.train_set_info.features;if(u&&u.length>0)for(var f=0;f<u.length;f++)t.fid==u[f].fid&&(d=!0);if(!d&&m&&m.length>0)for(var c=0;c<m.length;c++)t.fid==m[c].fid&&(d=!0);d&&(l=l+"!  "+e.tips["polymer.pleaseDragAgain"])}s.field["create"===t.type?"create":"modify"]({tb_id:t.tb_id,original_field_name:t.original_field_name||"",new_field_name:t.name,aggregator:t.aggregator,data_type:t.data_type,param:angular.toJson(t.param),fid:t.fid||""}).success(function(a){e.global.clickComplete=!0,0==a.status?(i.closeAll(),e.isRequestFieldList=!0,o.get("/api/data_aggr/fields",{tb_id:e.trainSetInfo.current_tb_id}).then(function(t){if(e.isRequestFieldList=!1,0==Number(t.status)){e.trainSetInfo.fields=t.result.fields,e.trainSetInfo.chooseTableTbType=t.result.tb_type,y(),i.closeAll();var a=i.open({template:"/static/partials/dialogTemplates/alert_success.html",scope:e,className:"ngdialog-theme-default ngDialog-width-300",data:{message:l},preCloseCallback:function(){r.cancel(o)}}),o=r(function(){i.close(a)},3e3)}else n(30003==Number(t.status)?t.errstr:40002==Number(t.status)?t.errstr?e.tips["error.fieldRepeat"]+":"+t.errstr:Number(t.status):t.errstr)})):n("7200"==a.status?isObjectEmpty(t.param)?e.tips["polymer.fieldFormularError"]:e.tips["polymer.groupMessageError"]:"40005"==a.status?a.errstr:a.errstr)})},e.modifyField=function(a){t.pageLoading=!0,e.newField=angular.extend({aggregator:a.formula,original_field_name:a.nick_name||a.name},a,{type:"modify",tb_id:e.trainSetInfo.current_tb_id,name:a.nick_name||a.name});var r="/static/partials/add_field.html";a.hasOwnProperty("param")&&"group"==a.param.type&&(r="/static/partials/field_groups.html"),i.open({template:r,data:{fieldList:e.trainSetInfo.fields_list},className:"ngdialog-theme-default add-field-dialog group-field-dialog",scope:e})},e.delNewField=function(t,a){var r=e.trainSetInfo.meta.train_set_info.dimensions,l=e.trainSetInfo.meta.train_set_info.features;if(r&&r.length>0)for(var d=0;d<r.length;d++)if(a==r[d].fid)return void n(e.tips["chart.fieldInUsing"]);if(l&&l.length>0)for(var u=0;u<l.length;u++)if(a==l[u].fid)return void n(e.tips["chart.fieldInUsing"]);i.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:e.tips["chart.delField"]+": "+t+" ?"}}).then(function(){s.field.del(a,e.trainSetInfo.current_tb_id).success(function(t){0==t.status?(e.isRequestFieldList=!0,o.get("/api/data_aggr/fields",{tb_id:e.trainSetInfo.current_tb_id}).then(function(t){e.isRequestFieldList=!1,0==Number(t.status)?(e.trainSetInfo.fields=t.result.fields,e.trainSetInfo.chooseTableTbType=t.result.tb_type,y()):n(30003==Number(t.status)?t.errstr:40002==Number(t.status)?t.errstr?e.tips["error.fieldRepeat"]+":"+t.errstr:Number(t.status):t.errstr)})):n(7590==Number(t.status)?e.tips["chart.fieldInUsing"]:40006==Number(t.status)?t.errstr:30003==Number(t.status)?t.errstr:40002==Number(t.status)?t.errstr?e.tips["error.fieldRepeat"]+":"+t.errstr:Number(t.status):t.errstr)})})},m(["wb.selectWorkSheet","polymer.selectWorkSheet","polymer.year","polymer.month","polymer.day","polymer.hour","polymer.minute","polymer.second","polymer.useAggregate","polymer.isAdd","chart.fieldInUsing","saveSuccess","polymer.saveFailed","polymer.addFieldSuccess","polymer.editFieldSuccess","polymer.fieldFormularError","polymer.groupMessageError","filter.checkSuccess","chart.delField","chart.fieldInUsing","polymer.pleaseDragAgain","error.fieldRepeat","model.vNameCantNull","model.vFeaturesCantNull","model.outputCantNull","model.iterationNumberErr1","model.iterationNumberErr2","model.iterationStepErr","model.clusterCountErr"],e)}angular.module("BC.controllers.train",[]).controller("TrainModelListCtrl",t).controller("TrainModelCtrl",a).directive("trainModelList",e).controller("TrainModelEditCtrl",i),e.$inject=["commonService"],t.$inject=["$scope","$rootScope","$stateParams","$location","commonService","$jsTipTranslate"],a.$inject=["$scope","$rootScope","$stateParams","commonService","$location","$timeout","formulaKeyMap","modelAlgoList","errHint"],i.$inject=["$scope","$rootScope","$location","ngDialog","$timeout","errHint","commonHttp","$stateParams","commonService","formulaKeyMap","dateNameMap","$jsTipTranslate","modelAlgoList"]}();
;!function(){function t(t,e,a,l,s,i,o,d,n,p,b){a.show_bdp_header=!1,t.back=function(){for(var e=0,a=0;a<t.tpl.tbList.length;a++)t.tpl.tbList[a].noLastModify&&(e+=1);e?p.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:"还有"+e+"张模板数据表没有被替换过，确定返回吗？"}}).then(function(){l.path("/dash_edit/"+b.projId+"/"+b.dashId)}):l.path("/dash_edit/"+b.projId+"/"+b.dashId)},t.changeTb=function(e){a.pageLoading=!0,o.tb.preview(t.tpl.tbList[e].tbId).then(function(l){t.tbModel=t.tpl.tbList[e],t.tbModel.tbThead=l.schema,t.tbModel.tbTbody=l.data.splice(0,25),t.tbModel.unshowIndex={};for(var s=l.schema.length-1;s>=0;s--)l.schema[s].flag&&(t.tbModel.unshowIndex[s]=!0);1==l.status&&(l.count>0&&0==l.data.length?(t.tpl.state="fail",t.tpl.stateText="工作表加载失败"):"fail"==t.tpl.state&&(t.tpl.state=void 0,t.tpl.stateText=void 0)),3==l.status||6==l.status?(t.tpl.state="updateSuccess",t.tpl.stateText="工作表正在更新，请耐心等待..."):2==l.status?(t.tpl.state="updateFail",t.tpl.stateText="工作表更新失败，请联系客服"):t.tpl.state&&(t.tpl.state=void 0,t.tpl.stateText=void 0),localStorage.setItem("TPL_LIBRARY_TBID",t.tpl.tbList[e].tbId),a.pageLoading=!1})},t.toReplaceSheet=function(){l.path("/page_upload/replace/"+t.tbModel.tbId)},t.init=function(){t.tpl={tplAciveIndex:1,tplName:"运营模板",tbList:[]},t.tbModel={};var e={dsh_id:b.dashId};a.pageLoading=!0,o.tb.getTplExcel(e).then(function(e){if(0==e.status){var l=e.result;t.tpl.tplName=l.name;for(var s=0,i=l.tb_list.length;i>s;s++)l.tb_list[s].ex_list.tpl&&t.tpl.tbList.push({tbName:l.tb_list[s].title,tbId:l.tb_list[s].tb_id,exList:l.tb_list[s].ex_list,lastModifyTime:l.tb_list[s].ex_list.add_by_user.length>0?l.tb_list[s].ex_list.add_by_user[0].time:void 0,lastModifyName:l.tb_list[s].ex_list.add_by_user.length>0?l.tb_list[s].ex_list.add_by_user[0].name:void 0,noLastModify:l.tb_list[s].ex_list.add_by_user.length>0?!1:!0});for(var o=0,s=0;s<t.tpl.tbList.length;s++)t.tpl.tbList[s].tbId==localStorage.getItem("TPL_LIBRARY_TBID")&&(o=s);t.changeTb(o)}a.pageLoading=!1})},t.init()}angular.module("BC.controllers.dashboard").controller("tplReplaceCtrl",t),t.$inject=["$scope","commonHttp","$rootScope","$location","$timeout","warnOperatorMap","commonService","errHint","$filter","ngDialog","$stateParams"]}();
;!function(){angular.module("BC.controllers.template.home",[]).controller("TemplateHomeController",["$scope","$rootScope","$location",function(t,e,o){e.view="template",e.show_bdp_header=!0,e.last_template_path=o.path(),t.back=function(){var e=localStorage.getItem("mc_location_path");o.path(e||"/dash_edit"),t.back_guide=!1}}])}();
;!function(){function t(t,e,a,i,l,s,n,o,p){function c(e){angular.forEach(e,function(e){t.chart.chartList.push({ct_id:e.ct_id,name:e.name,check:!0})}),t.chart.checkAll=!0}e.view="template_config",e.show_bdp_header=!1,t.templateData={create:{},dashList:[],chooseDshList:[],choosedDshList:[],name:"",templateInfo:[],del_dsh:[],add_dsh:[]},t.templateView={model:"cat",empty:"init",tplEdit:{},tplEditName:""};var m=t.templateData,h=t.templateView,d=function(e,i){a.get("/api/template/list").then(function(a){if(0==a.status){t.templateData.templateList=a.result;var l=t.templateData.templateList;if(0==t.templateData.templateList.length)t.templateView.empty="empty";else{if(t.templateView.empty="has",t.templateView.model="cat",void 0!==i&&!i)return;0==e?t.templateView.activeTpl=angular.copy(l[e]):"last"==e&&(t.templateView.activeTpl=angular.copy(l[l.length-1])),t.switchTplInfo()}}})},r=function(){a.get("/api/project/all_list").then(function(e){if(0==e.status){var a=e.result;0==a.length&&(t.templateView.dashList=0),t.templateData.dashList=[];var i,l=t.templateData.dashList;angular.forEach(a,function(t,e){i=l.length-1,0==e&&l.push({name:t.proj_name,proj_id:t.proj_id,list:[{dsh_name:t.dsh_name,dsh_id:t.dsh_id}]}),0!=e&&(t.proj_id==l[l.length-1].proj_id?l[i].list.push({dsh_name:t.dsh_name,dsh_id:t.dsh_id}):l.push({name:t.proj_name,proj_id:t.proj_id,list:[{dsh_name:t.dsh_name,dsh_id:t.dsh_id}]}))}),d(0)}})};t.createTpl=function(){for(var e in t.templateView.tplEdit)if(1==t.templateView.tplEdit[e])return i(t.tips["template.templateRenaming"]),!1;t.templateView.model="create",t.templateData.chooseDshList=angular.copy(t.templateData.dashList),t.templateData.name=t.tips["template.unnameTemplate"],t.templateView.empty="has",t.templateView.createName=!0,t.templateView.activeTpl="",t.templateData.sourceChoosedDsh=[],s(function(){$("#newtplName").select().focus()},100)},t.delTpl=function(e,i){i&&i.stopPropagation();var l=e.tpl_id,s=e.name;n.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:t.tips["template.delTemplate"]+": "+s+" ?"}}).then(function(){a.get("/api/template/delete",{tpl_id:l}).then(function(e){0==e.status&&(l==t.templateView.activeTpl.tpl_id?d(0):d())})})},t.switchTplInfo=function(i){i&&(t.templateView.activeTpl=i),e.pageLoading=!0,a.get("/api/template/info",{tpl_id:t.templateView.activeTpl.tpl_id}).then(function(a){if(0==a.status){var i=a.result;if(t.templateData.name=i.name,t.templateData.choosedDshList=i.dsh_list,t.templateData.dashList.length>0){var l=t.templateData.dashList,s=[],n=[],o=-1;angular.forEach(l,function(t){angular.forEach(t.list,function(e){angular.forEach(i.dsh_list,function(a){a.dsh_id==e.dsh_id&&(o=$.inArray(t.proj_id,n),-1==o?(n.push(t.proj_id),s.push({name:t.name,id:t.proj_id,list:[a]})):s[o].list.push(a))})})})}t.templateData.choosedProjList=s,t.templateView.model="cat",e.pageLoading=!1}})},t.editTpl=function(){var e=t.templateData.dashList,a=angular.copy(e),i=t.templateData.choosedDshList;if(t.templateData.sourceChoosedDsh=[],i.length>0){var l=[];angular.forEach(i,function(e){l=[];for(var i=0,s=a.length;s>i;i++)for(var n=0,o=a[i].list.length;o>n;n++)if(a[i].list[n].dsh_id==e.dsh_id){a[i].list[n].choose=!0,a[i].list[n].is_all=e.is_all,a[i].list[n].ct_list=e.ct_list,angular.forEach(e.ct_list,function(t){l.push(t.ct_id)}),a[i].list[n].ct_ids=l;break}t.templateData.chooseDshList=a,t.templateData.sourceChoosedDsh.push(e.dsh_id)})}else t.templateData.chooseDshList=a;a.map(function(t){var e=0;t.list.map(function(t){t.choose&&e++}),t.list.length==e&&(t.choose=!0)}),t.templateView.model="edit",t.templateData.del_dsh=[]},t.checkAll=function(t){var e=t.choose;t.list.map(function(t){t.choose=e,e||(t.is_all=1)})},t.dshChooseChange=function(e,a){var i=t.templateData.chooseDshList[a];if(e.choose){var l=0;i.list.map(function(t){t.choose&&l++}),l==i.list.length&&(i.choose=!0)}else e.is_all=1,i.choose=!1},t.modifyTpl=function(){var e=t.templateView.model;if(""==t.templateData.name)return void i(t.tips["template.nameCanNotNull"]);var a=t.templateData.sourceChoosedDsh,l=[],s=[],n=t.templateData.chooseDshList,p=0;if("edit"==t.templateView.model?angular.forEach(n,function(t){angular.forEach(t.list,function(t){t.choose?(p+=1,l.push({dsh_id:t.dsh_id,ct_ids:t.ct_ids||[],is_all:void 0!==t.is_all?t.is_all:1})):$.inArray(t.dsh_id,a)>-1&&s.push(t.dsh_id)})}):angular.forEach(n,function(t){angular.forEach(t.list,function(t){t.choose&&(p+=1,l.push({dsh_id:t.dsh_id,ct_ids:t.ct_ids||[],is_all:void 0!==t.is_all?t.is_all:1}))})}),0==p)return void i(t.tips["template.selectDash"]);var c={name:t.templateData.name,dsh:angular.toJson(l)};"edit"==e&&(c.tpl_id=t.templateView.activeTpl.tpl_id,c.del_dsh_ids=angular.toJson(s)),o.tpl.tplCommit(c).then(function(a){0==a.status&&("edit"==e?(t.switchTplInfo(),d(),t.templateView.model="cat"):d("last"))})},t.renameTpl=function(e,a,l){if(e&&e.stopPropagation(),"create"==t.templateView.model)i(t.tips["template.finishCreateFirst"]);else{t.templateView.tplEdit[a]=!0;for(var s in t.templateView.tplEdit)t.templateView.tplEdit[s]=s==a;t.templateView.tplEditName=l.name}},t.saveTplName=function(e,l){var s=t.templateView.model;if("create"==s){if(!t.templateData.name)return void i(t.tips["template.inputTemplateName"]);for(var n=0,o=m.templateList.length;o>n;n++)if(t.templateData.name==m.templateList[n].name)return void i(t.tips["template.templateNameRepeat"]);h.createName=!1,h.editCreateName=!1}else{var p=h.tplEditName;if(!p)return void i(t.tips["template.inputTemplateName"]);var c={tpl_id:e.tpl_id,name:p};a.get("/api/template/commit",c).then(function(e){0==e.status&&(i(t.tips["template.editSuccess"]),m.templateList[l].name=p,h.tplEdit[l]=!1)})}},r(),t.cancelTpl=function(){"create"==t.templateView.model?d(0):t.switchTplInfo(t.templateData.cur_tpl)},t.keyupFun=function(e,a,i){13==e.keyCode&&t.saveTplName(a,i)},t.cancelEditName=function(){angular.forEach(h.tplEdit,function(t,e){h.tplEdit[e]=!1})},t.clickTplList=function(t){t.stopPropagation()},t.back=function(){e.click_show_view("template_home",{wsId:e.wsId})},t.chart={};var u=null;t.modifyChart=function(a){var i=t.templateView.model;t.chart={check:"1",checkAll:!1,dsh_id:a.dsh_id,dsh_index:a.dsh_index,proj_index:a.proj_index,is_all:void 0===a.is_all?1:a.is_all,chartList:[]},u=t.chart,e.pageLoading=!0,o.tpl.chartList({dsh_id:u.dsh_id}).then(function(a){if(e.pageLoading=!1,0==a.status){if("create"!=i)if(u.is_all)c(a.result);else{u.check=2;var l=0,s=t.templateData.chooseDshList[u.proj_index].list[u.dsh_index].ct_ids;angular.forEach(a.result,function(t){$.inArray(t.ct_id,s)>=0&&(t.check=!0,l++)}),l==a.result.length&&(u.checkAll=!0),u.chartList=a.result}else c(a.result);n.open({template:"/static/partials/dialogTemplates/tpl_choose_chart.html",className:"ngdialog-theme-default ngDialog-width-520",scope:t})}})},t.modifyCheckAll=function(){angular.forEach(u.chartList,function(t){t.check=u.checkAll})},t.modifyCheck=function(){var t=0;angular.forEach(u.chartList,function(e){e.check&&t++}),u.checkAll=t==u.chartList.length},t.confirmChart=function(){var e=[],a=[],l=t.templateData.chooseDshList,s=l[u.proj_index].list[u.dsh_index];if(1==u.check)s.is_all=1;else{if(angular.forEach(u.chartList,function(t){t.check&&(e.push(t.ct_id),a.push(t))}),0==e.length)return void i(t.tips["template.selectAChart"]);s.is_all=0,s.ct_ids=e,s.ct_list=a}n.closeAll()},t.catChart=function(e){t.chart={check:e.is_all,chartList:e.ct_list},n.open({template:"/static/partials/dialogTemplates/tpl_cat_chart.html",className:"ngdialog-theme-default ngDialog-width-520",scope:t})},p(["template.unnameTemplate","template.delTemplate","template.nameCanNotNull","template.selectDash","template.editSuccess","template.saveSuccess","template.templateRenaming","template.finishCreateFirst","template.inputTemplateName","template.templateNameRepeat","template.selectAChart","template.unnameTemplate"],t)}angular.module("BC.controllers.template.config",[]).controller("TemplateConfigController",t),t.$inject=["$scope","$rootScope","commonHttp","errHint","$location","$timeout","ngDialog","commonService","$jsTipTranslate"]}();
;!function(){angular.module("BC.controllers.template.rule",[]).controller("templateRuleCtrl",["$scope","$rootScope","commonHttp","errHint","$location","ngDialog","commonService","$jsTipTranslate","conditionTypeVal",function(e,t,l,a,i,c,s,r,d){function o(){var e=n.target.selectedField;if(e.fid&&n.source.selectedField.fid){var t=n.target.selectedTb.tb_id;angular.forEach(n.fieldRules,function(e){-1==$.inArray(t,e.rela_tb_id)?(e.disabled=!0,e.check=!1):(e.disabled=!1,e.check=!0)})}}t.view="template_rule",t.show_bdp_header=!1,e.ruleData={},e.conditionTypeVal=d,e.batchSetView={loading:!1};var n=e.ruleData,u=function(){t.pageLoading=!0,l.get("/api/rule/list").then(function(l){if(t.pageLoading=!1,0==l.status){var a=l.result;e.ruleData.ruleList=a}})};u();e.back=function(){t.click_show_view("template_home",{wsId:t.wsId})},e.createRule=function(){$.cookie("tpl_rule_id",""),t.click_show_view("template_rule_create",{wsId:t.wsId})},e.copyRule=function(e){$.cookie("tpl_rule_id",e),t.click_show_view("template_rule_create",{wsId:t.wsId})},e.delRule=function(t){var i=t.rule_id,s=t.name;c.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:e.tips["template.delRule"]+": "+s+" ?"}}).then(function(){l.get("/api/rule/delete",{rule_id:i}).then(function(t){0==t.status&&(a(e.tips["template.delSuccess"]),u())})})};var f=function(e){for(var t=[],l=0;l<e.length;l++)1==e[l].is_rule_used&&t.push(e[l]);return t};e.batchSet=function(){t.pageLoading=!0,s.tpl.ruleTbInfo().then(function(l){t.pageLoading=!1,0==l.status&&(e.tbInfo=angular.copy(l.result),e.refTbInfo=f(l.result),c.open({template:"/static/partials/dialogTemplates/batch_set.html",className:"ngdialog-theme-default batch-set-model",scope:e}),e.ruleData.source={},e.ruleData.source.selectedTb={name:e.tips["template.selectWorkSheet"],fields:[]},e.ruleData.source.selectedField={name:e.tips["template.selectWorkField"]},e.ruleData.target={},e.ruleData.target.selectedTb={name:e.tips["template.selectWorkSheet"],fields:[]},e.ruleData.target.selectedField={name:e.tips["template.selectWorkField"]})})},e.refTbFieldChange=function(t){n.tbField="",n.source.selectedField=t,e.getRules()},e.refTbChange=function(t){n.tbName="",n.source.selectedTb=t,n.source.selectedTb.fields=f(e.ruleData.source.selectedTb.fields),n.source.selectedField={},n.fieldRules=[]},e.setTbChange=function(e){n.name="",n.target.selectedField={},n.target.selectedTb=e},e.setTbFieldChange=function(e){n.field="",n.target.selectedField=e,o()},e.changeSourceTb=function(){n.source.selectedField={},n.fieldRules=[]},e.getRules=function(){t.pageLoading=!0;var l=e.ruleData.source.selectedTb.tb_id,a=e.ruleData.source.selectedField.fid;s.tpl.getFieldRule({tb_id:l,fid:a}).then(function(l){t.pageLoading=!1,0==l.status&&(e.ruleData.fieldRules=l.result,angular.forEach(e.ruleData.fieldRules,function(e){e.check=!0}))})},e.$watch("ruleData.fieldRules",function(t){if(t){var l=n.target,a=!0,i=!!l.selectedField.fid,c=l.selectedTb.tb_id;angular.forEach(t,function(e){i&&-1==$.inArray(c,e.rela_tb_id)&&(e.disabled=!0),e.check||e.disabled||(a=!1)}),e.ruleData.checkall=a}},!0),e.ruleCheck=function(){var e=n.checkall;angular.forEach(n.fieldRules,function(t){t.disabled||(t.check=e)})},e.saveBatchSet=function(){var t=e.ruleData;if(!t.source.selectedTb.tb_id)return void a(e.tips["template.selectWorkSheet"]);if(!t.source.selectedField.fid||!t.target.selectedField.fid)return void a(e.tips["template.selectWorkField"]);if(!t.target.selectedTb.tb_id)return void a(e.tips["template.selectSetWorkSheet"]);var l=[],i=e.ruleData.fieldRules,r=t.target;return angular.forEach(i,function(e){e.check&&angular.forEach(e.filter,function(t){l.push({condition_type:t.condition_type,operator:t.operator,opt_val:t.opt_val,tb_id:r.selectedTb.tb_id,fid:r.selectedField.fid,rule_id:e.rule_id})})}),0==l.length?void a(e.tips["template.selectRule"]):(e.batchSetView.loading=!0,void s.tpl.saveBatchRule({filter_list:angular.toJson(l)}).then(function(t){0==t.status&&(a(e.tips["template.setSuccess"]),u(),c.closeAll()),e.batchSetView.loading=!1}))},r(["template.delRule","template.delSuccess","template.selectWorkSheet","template.selectWorkField","template.selectSetWorkSheet","template.selectRule","template.setSuccess"],e)}])}();
;!function(){function t(t,e,a,r,i,l,o,n,u,d){function c(){function t(t){var e="";return angular.forEach(_.sqlFilterList,function(a){a.tb_id==t&&(e=a.fl_id)}),e}var e={filter_type:_.filter_type,filter_list:[]};if(0==e.filter_type){angular.forEach(_.filters,function(t){e.filter_list.push({fl_id:t.fl_id,tb_id:t.tb_id,fid:t.fid,operator:t.operator,opt_val:t.opt_val,condition_type:t.condition_type,start_date:t.start_date||null,end_date:t.end_date||null})})}else angular.forEach(_.sql,function(a,r){if(a&&$.inArray(r,_.tbIds)>-1){var i={tb_id:r,expression:a};"create"!=l.module&&(i.fl_id=t(i.tb_id)),e.filter_list.push(i)}});return e}function s(e){if(_.batchSql.common&&_.choosedTb.length>0){var a=_.choosedTb[0].tb_id;r.tb.sqlTrans({tb_id:a,sql:_.batchSql.common}).then(function(a){0==a.status?e?e(!0):i(t.tips["filter.checkSuccess"]):e&&e(!1)})}else e(!0)}function p(){function e(t,e){{var a=[];e[0]}return a.push(t),angular.forEach(e,function(e,r){r>0&&angular.forEach(e.schema,function(r){r.data_type==t.data_type&&r.name==t.name&&a.push({fid:r.fid,name:r.name,original_name:r.original_name,data_type:r.data_type,tb_id:e.tb_id,tb_name:e.name})})}),a.length==e.length?a:!1}var a=_.choosedTb=[];t.ruleData.commonFields=[],t.ruleData.commonFieldOpts=[],_.commonCurFilter.tbField[0].fields=[],angular.forEach(t.ruleData.filterlist,function(t){t.check&&_.choosedTb.push(t)}),0!=a.length&&(angular.forEach(a[0].schema,function(t){var r={fid:t.fid,name:t.name,title:t.name,original_name:t.original_name,data_type:t.data_type,tb_id:a[0].tb_id,tb_name:a[0].name},i=e(r,a);i&&(_.commonFieldOpts.push(r),_.commonCurFilter.tbField[0].fields.push(r),_.commonFields.push(i))}),t.$broadcast("updateTbList"))}function f(){var t;angular.forEach(_.commonFilters,function(e){t=void 0,I(e)||(t=S(e),void 0!==t&&(e.condition_type=t),_.filters.push(e))})}function m(e){if(e){var a=_.batchSql.common;if(a){angular.forEach(_.choosedTb,function(t){_.sql[t.tb_id]=_.sql[t.tb_id]?"("+_.sql[t.tb_id]+") and "+a:a});for(var r,i=_.tbInfo,l=0;l<i.length;l++)if(i[l].open){r=i[l].tb_id;break}t.$broadcast("initSql",r)}o.closeAll()}}e.view="template_rule",e.show_bdp_header=!1,t.ruleView={view:"list",tab:"group",filter:{},modifyFilter:!0},t.ruleData={fields:[],del_filters:[],operators:n,tbInfo:[],filter_type:0,filters:[],sql:{},batchSql:{},choosedTb:[]},t.ruleData.curFilter={tb:{},field:{type:"string"},opt_val:"",operator:"",condition_type:0};var _=t.ruleData,h=t.ruleView,g=function(e){a.get("/api/template/list").then(function(a){0==a.status&&(t.ruleData.tplList=[],"create"==e&&angular.forEach(a.result,function(e){t.ruleData.tplList.push({tpl_id:e.tpl_id,name:e.name,check:!1})}))})},F=function(){t.ruleData.groupList=[],t.ruleData.userList=[],r.user.groupList().then(function(e){if(0==e.status){var a=e.result;angular.forEach(a,function(e){"00000000000000000000000000000000"!==e.group_id&&t.ruleData.groupList.push({group_id:e.group_id,group_name:e.group_name,check:!1})})}}),a.get("/api/sub/list").then(function(e){0==e.status&&(e=e.result,angular.forEach(e,function(e){t.ruleData.userList.push({name:e.name,user_id:e.userid,check:!1,username:e.username})}))})},b=function(t){_.tbInfo=angular.copy(t),_.tbIds=[];var e=[];angular.forEach(t,function(t){e.push(t.tb_id)}),_.tbIds=e,angular.forEach(_.tbInfo,function(t){t.fields=angular.copy(t.schema),delete t.schema,angular.forEach(t.fields,function(t){t.title=t.name})})},v=function(e){return 0==e.length?(_.filterlist=[],_.fields=[],_.filter_list=[],_.tbInfo=[],void(_.tbIds=[])):void a.get("/api/tb/rule_filter",{tpl_ids:e.join(",")}).then(function(e){0==e.status&&(_.filterlist=e.result,b(e.result),t.ruleData.fields=[],d(function(){t.$broadcast("initTbList")},10))})},y=function(e,a){t.ruleData.tplList=[],t.ruleData.sourceTpls=[];var r={};angular.forEach(e,function(e){e.selected?(r={tpl_id:e.tpl_id,name:e.name,check:!0},"create"!=a&&t.ruleData.sourceTpls.push(e.tpl_id)):r={tpl_id:e.tpl_id,name:e.name,check:!1},t.ruleData.tplList.push(r)})},D=function(e){var a=e.length-1;"00000000000000000000000000000000"==e[a].group_id&&e.splice(a,1),t.ruleData.groupList=[],t.ruleData.sourceGroups=[];var r={};angular.forEach(e,function(e){e.selected?(r={group_id:e.group_id,group_name:e.group_name,check:!0},t.ruleData.sourceGroups.push(e.group_id)):r={group_id:e.group_id,group_name:e.group_name,check:!1},t.ruleData.groupList.push(r)})},C=function(e){t.ruleData.userList=[],t.ruleData.sourceUsers=[];var a=[];angular.forEach(e,function(e){e.selected?(a={name:e.name,user_id:e.userid,check:!0,username:e.username},t.ruleData.sourceUsers.push(e.userid)):a={name:e.name,user_id:e.userid,check:!1,username:e.username},t.ruleData.userList.push(a)})},k=function(t){if(_.filter_type=t.filter_type,1==_.filter_type){var e=_.sqlFilterList=t.filter_list;angular.forEach(e,function(t){_.sql[t.tb_id]=t.expression})}else _.filters=t.filter_list},E=function(e){t.ruleData.filter_list=[],t.ruleData.sourceFilters=[];var a=[],r=[];angular.forEach(e,function(t){-1==$.inArray(t.tb_id,r)&&(a.push({tb_id:t.tb_id,tb_name:t.tb_name,fields:{}}),a[a.length-1].fields[t.fid]={condition_type:t.condition_type,list:[]},r.push(t.tb_id))}),angular.forEach(e,function(e,i){var l=$.inArray(e.tb_id,r),o=a[l].fields;o[e.fid]||(o[e.fid]={condition_type:e.condition_type,list:[]});var n=o[e.fid].list;n.push({tb:{name:e.tb_name,tb_id:e.tb_id},field:{name:e.fid_name,fid:e.fid,data_type:e.data_type,type:"string"==e.data_type?"string":"all"},operator:e.operator,start_date:e.start_date,end_date:e.end_date,opt_val:e.opt_val,condition_type:e.condition_type,fl_id:e.fl_id,key:i}),e.fl_id&&t.ruleData.sourceFilters.push(e.fl_id)}),t.ruleData.filter_list=a};if(t.$watch("ruleData.filters",function(e){h.modifyFilter&&(e&&e.length>0?E(e):t.ruleData.filter_list=[])},!0),"create"==l.module){F("create"),t.ruleData.name="";var w=$.cookie("tpl_rule_id");w?a.get("/api/rule/info",{rule_id:w}).then(function(e){if(0==e.status){var a=e.result;t.ruleData.filterlist=a.SchemaInfo,b(a.SchemaInfo),y(a.TemplateInfo,"create"),k(a.FilterInfo),d(function(){t.$broadcast("initTbList")},10)}}):(t.ruleData.filterlist=[],t.ruleData.filter_list=[],g("create"))}else{var T=l.module;a.get("/api/rule/info",{rule_id:T}).then(function(e){if(0==e.status){var a=e.result;t.ruleData.name=a.name,t.ruleData.rule_id=T,t.ruleData.filterlist=a.SchemaInfo,b(a.SchemaInfo),y(a.TemplateInfo),D(a.GroupInfo),C(a.SubUserInfo),k(a.FilterInfo),d(function(){t.$broadcast("initTbList")},10)}})}t.setcurFieldType=function(){var e=t.ruleData.curFilter;e.field.type="string"==e.field.data_type?"string":"all","date"==e.field.data_type?(e.operator=10,e.opt_val="",e.start_date=null,e.end_date=null):(e.operator=0,e.opt_val="")},t.changeCheck=function(e){_.curFilter.tb={},_.curFilter.field={},_.curFilter.operator="";var a=[];t.ruleData.tpls=[],angular.forEach(t.ruleData.tplList,function(e){e.check&&(a.push(e.tpl_id),t.ruleData.tpls.push({tpl_id:e.tpl_id,name:e.name}))});var r;e.check||(r="del"),v(a,r)},t.updateSelected=function(){if(!t.ruleData.curFilter.tb)return t.ruleData.curFilter={tb:{},field:{type:"string"},opt_val:"",operator:0,condition_type:0},!1;_.curFilter.field={};for(var e=t.ruleData.curFilter.tb.tb_id,a=t.ruleData.filterlist,r=0,i=a.length;i>r;r++)if(a[r].tb_id==e){t.ruleData.fields=a[r].schema;break}},t.updateCtrl=function(e){_.curFilter.tb=e,_.tbName="",t.updateSelected()},t.addKeyUp=function(e){13==e.keyCode&&t.addFilter()},t.addFilter=function(){var e=angular.copy(t.ruleData.curFilter);if(delete e.tb.schema,$.isEmptyObject(e.tb))return void i(t.tips["template.selectSheet"]);if($.isEmptyObject(e.field))return void i(t.tips["template.selectField"]);if(!e.opt_val&&8!=e.operator&&9!=e.operator&&10!=e.operator)return void i(t.tips["template.inputValue"]);if(10==e.operator&&!e.start_date&&!e.end_date)return void i(t.tips["template.inputValue"]);if(""===e.operator)return void i(t.tips["template.selectCondition"]);h.modifyFilter=!0;var a=1;_.filters[0]&&(a=_.filters[0].condition_type),_.filters.push({condition_type:a,operator:e.operator,opt_val:e.opt_val,fid:e.field.fid,fid_name:e.field.name,data_type:e.field.data_type,tb_id:e.tb.tb_id,tb_name:e.tb.name,start_date:e.start_date,end_date:e.end_date}),t.ruleData.curFilter={tb:{},field:{},operator:"",opt_val:"",condition_type:0},10==e.operator&&(t.ruleData.curFilter.start_date=null,t.ruleData.curFilter.end_date=null),t.ruleData.fields=[]},t.filterChange=function(t,e){t.operator=e.value,(8==t.operator||9==t.operator||10==t.operator)&&(t.opt_val="")},t.conditionTypeFun=function(e,a,r){var i,l,o=t.ruleData.filter_list[e].fields[r],n=o.condition_type;angular.forEach(o.list,function(t){t.condition_type=n,i=t.tb.tb_id,l=t.field.fid}),angular.forEach(_.filters,function(t){t.tb_id==i&&t.fid==l&&(t.condition_type=n)})},t.delFilter=function(e){h.modifyFilter=!0;var a=e.key;_.filters.splice(a,1),e.fl_id&&t.ruleData.del_filters.push(e.fl_id),t.$$phase||t.$apply()},t.modifyFilter=function(t){h.modifyFilter=!1;var e=t.key;(8==t.operator||9==t.operator||10==t.operator)&&(t.opt_val=""),10!=t.operator&&(t.start_date=null,t.end_date=null),_.filters[e].operator=t.operator,_.filters[e].opt_val=t.opt_val,_.filters[e].start_date=t.start_date,_.filters[e].end_date=t.end_date},t.updateModel=function(t,e){t.operator=e.value},t.saveRule=function(){if(!e.pageLoading){var r=t.ruleData,o="/api/rule/create";if(!r.name)return void i(t.tips["template.inputRuleName"]);var n={};n.name=r.name;var u=[];if(angular.forEach(t.ruleData.tplList,function(t){t.check&&u.push(t.tpl_id)}),0==u.length)return void i(t.tips["template.selectTemplate"]);var d=[],s=[];if(angular.forEach(t.ruleData.groupList,function(t){t.check&&d.push(t.group_id)}),angular.forEach(t.ruleData.userList,function(t){t.check&&s.push(t.user_id)}),0==d.length&&0==s.length)return void i(t.tips["template.selectUserOrGroup"]);e.pageLoading=!0;var p=c();if("create"==l.module)o="/api/rule/create",n.tpl_ids=u.join(","),n.group_ids=d.join(","),n.user_ids=s.join(","),n.rule_filter=angular.toJson(p);else{o="/api/rule/modify",n.rule_id=r.rule_id;var f=[],m=[],_=t.ruleData.sourceTpls;angular.forEach(_,function(t){-1==$.inArray(t,u)&&m.push(t)}),angular.forEach(u,function(t){-1==$.inArray(t,_)&&f.push(t)});var h=[],g=[],F=t.ruleData.sourceGroups;angular.forEach(F,function(t){-1==$.inArray(t,d)&&g.push(t)}),angular.forEach(d,function(t){-1==$.inArray(t,F)&&h.push(t)});var b=[],v=[],y=t.ruleData.sourceUsers;angular.forEach(y,function(t){-1==$.inArray(t,s)&&v.push(t)}),angular.forEach(s,function(t){-1==$.inArray(t,y)&&b.push(t)}),n.rule_filter=angular.toJson(p),n.add_tpls=f.join(","),n.del_tpls=m.join(","),n.add_groups=h.join(","),n.del_groups=g.join(","),n.add_users=b.join(","),n.del_users=v.join(",")}a.post(o,n).then(function(a){e.pageLoading=!1,0==a.status&&(i(t.tips["template.saveSuccess"]),e.click_show_view("template_rule",{wsId:e.wsId}))})}},t.back=function(){var a=[];angular.forEach(t.ruleData.tplList,function(t){t.check&&a.push(t.tpl_id)}),t.ruleData.name&&a.length>0?o.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngdialog-width-340",scope:t,data:{message:t.tips["template.confirmToBack"]}}).then(function(){e.click_show_view("template_rule",{wsId:e.wsId})}):e.click_show_view("template_rule",{wsId:e.wsId})},t.batch_add_filter=function(){o.open({template:"/static/partials/dialogTemplates/batch_add_filter.html",className:"ngdialog-theme-default batch-add-filter-model ngDialog-width-740",scope:t}),_.common_selected=!1,_.commonFieldOpts=[],_.batchSql="",t.ruleData.commonCurFilter={operator:"",field:{name:t.tips["template.selectField"]},tbField:[{tb_id:"common",name:"",fields:[]}]},t.ruleData.commonFilters=[],t.ruleView.checkall=!1,angular.forEach(_.filterlist,function(t){t.check=!1})},t.$on("toSqlTrans",function(){s()}),t.changeCtrl=function(e){_.commonCurFilter.field=e,_.tbField="",t.changefield()},t.updateField=function(e){_.curFilter.field=e,_.tbField="",t.setcurFieldType()},t.modifyCommonTb=function(e){_.commonCurFilter.field.name=t.tips["template.selectField"],_.commonCurFilter.operator="",_.commonFilters.length>0&&(confirm(t.tips["template.clearFilterCondition"])?_.commonFilters=[]:e.check=!e.check);var a=0;angular.forEach(_.filterlist,function(t){t.check&&a++}),h.checkall=a==_.filterlist.length,p()},t.changefield=function(){var t=_.commonCurFilter;t.field&&(t.field.type="string"==t.field.data_type?"string":"all"),t.field&&"date"==t.field.data_type?(t.operator=10,t.opt_val="",t.start_date=null,t.end_date=null):(t.operator=0,t.opt_val="")},t.batchAddKeyUp=function(e){13==e.keyCode&&t.batchAddFilter()},t.batchAddFilter=function(){if(!_.commonCurFilter.field)return void i(t.tips["template.selectField"]);if(void 0===_.commonCurFilter.opt_val||""===_.commonCurFilter.opt_val&&8!=_.commonCurFilter.operator&&9!=_.commonCurFilter.operator&&10!=_.commonCurFilter.operator)return void i(t.tips["template.inputValue"]);if(10==_.commonCurFilter.operator&&!_.commonCurFilter.start_date&&!_.commonCurFilter.end_date)return void i(t.tips["template.inputValue"]);for(var e=!1,a=0,r=_.commonFilters.length;r>a;a++)if(10!=_.commonCurFilter.operator){if(_.commonCurFilter.field.fid==_.commonFilters[a].fid&&_.commonCurFilter.operator==_.commonFilters[a].operator&&_.commonCurFilter.opt_val==_.commonFilters[a].opt_val)return e=!0,void i(t.tips["template.repeatRuleFilter"])}else if(_.commonCurFilter.field.fid==_.commonFilters[a].fid&&_.commonCurFilter.operator==_.commonFilters[a].operator&&Highcharts.dateFormat("%Y-%m-%d",new Date(_.commonCurFilter.start_date))==Highcharts.dateFormat("%Y-%m-%d",new Date(_.commonFilters[a].start_date))&&Highcharts.dateFormat("%Y-%m-%d",new Date(_.commonCurFilter.end_date))==Highcharts.dateFormat("%Y-%m-%d",new Date(_.commonFilters[a].end_date)))return e=!0,void i(t.tips["template.repeatRuleFilter"]);angular.forEach(_.commonFields,function(t){t[0].fid==_.commonCurFilter.field.fid&&angular.forEach(t,function(t){_.commonFilters.push({fid:t.fid,fid_name:t.name,data_type:t.data_type,opt_val:_.commonCurFilter.opt_val,operator:_.commonCurFilter.operator,condition_type:1,tb_id:t.tb_id,tb_name:t.tb_name,start_date:_.commonCurFilter.start_date,end_date:_.commonCurFilter.end_date})})}),_.commonCurFilter.operator="",_.commonCurFilter.opt_val="",scrollToBottom($(".batch-add-filter-model .right .common-filter-list"))};var L=function(t){var e=[];angular.forEach(t,function(t,a){0==a?e.push(t):10!=t.operator?9==t.operator||8==t.operator?(e[e.length-1].fid_name!==t.fid_name||e[e.length-1].operator!==t.operator)&&e.push(t):(e[e.length-1].fid_name!==t.fid_name||e[e.length-1].operator!==t.operator||e[e.length-1].opt_val!==t.opt_val)&&e.push(t):(e[e.length-1].fid_name!==t.fid_name||e[e.length-1].operator!==t.operator||Highcharts.dateFormat("%Y-%m-%d",new Date(e[e.length-1].start_date))!==Highcharts.dateFormat("%Y-%m-%d",new Date(t.start_date))||Highcharts.dateFormat("%Y-%m-%d",new Date(e[e.length-1].end_date))!==Highcharts.dateFormat("%Y-%m-%d",new Date(t.end_date)))&&e.push(t)});var a,r=[],i=0;angular.forEach(e,function(t,e){0==e?(h.commonFilters[i]=[],h.commonFilters[i].push(t),r.push(t.fid_name),i++):(a=$.inArray(t.fid_name,r),-1==a?(h.commonFilters[i]=[],h.commonFilters[i].push(t),r.push(t.fid_name),i++):h.commonFilters[a].push(t))})};t.$watch("ruleData.commonFilters",function(t){h.commonFilters=[],t&&t.length>0&&L(t)},!0),t.delCommonFilter=function(t){for(var e=_.commonFilters,a=e.length-1,r=0;a>=r;a--)e[a].fid_name==t.fid_name&&e[a].operator==t.operator&&e[a].opt_val==t.opt_val&&e.splice(a,1)};var I=function(t){var e=!1;return angular.forEach(_.filters,function(a){10!=t.operator?a.fid==t.fid&&a.tb_id==t.tb_id&&a.operator==t.operator&&a.opt_val==t.opt_val&&(e=!0):a.fid==t.fid&&a.tb_id==t.tb_id&&a.operator==t.operator&&Highcharts.dateFormat("%Y-%m-%d",new Date(a.start_date))==Highcharts.dateFormat("%Y-%m-%d",new Date(t.start_date))&&Highcharts.dateFormat("%Y-%m-%d",new Date(a.end_date))==Highcharts.dateFormat("%Y-%m-%d",new Date(t.end_date))&&(e=!0)}),e},S=function(t){var e=void 0;return angular.forEach(_.filters,function(a){a.fid==t.fid&&a.tb_id==t.tb_id&&(e=a.condition_type)}),e};t.addBatchFilter=function(){h.modifyFilter=!0,0==_.filter_type?(f(),o.closeAll()):s(m)},t.changeCheckAll=function(){return _.commonFilters.length>0?confirm(t.tips["template.clearFilterCondition"])?(_.commonFilters=[],angular.forEach(_.filterlist,function(t){t.check=h.checkall}),p(),!1):(h.checkall=!h.checkall,!1):(angular.forEach(_.filterlist,function(t){t.check=h.checkall}),void p())},u(["template.eq","template.neq","template.gt","template.lt","template.egt","template.elt","template.selectSheet","template.inputValue","template.selectCondition","template.inputRuleName","template.repeatRuleFilter","template.selectTemplate","template.selectUserOrGroup","template.clearFilterCondition","template.inputCondition","filter.checkSuccess","template.selectField","template.confirmToBack"],t)}angular.module("BC.controllers.template.modify",[]).controller("templateRuleModifyCtrl",t),t.$inject=["$scope","$rootScope","commonHttp","commonService","errHint","$stateParams","ngDialog","filterOperatorMapWithType","$jsTipTranslate","$timeout"]}();
;!function(){function e(e,t,r,n,i,a,o,l,s,u){function d(e,t){return"number"==e&&"fixed"==t?0:"number"==e&&"custom"==t?1:"string"==e&&"condition"==t?21:"string"==e&&"item"==t?22:"date"==e&&"custom"==t?3:"date"==e&&"group_year"==t?4:"date"==e&&"group_month"==t?5:"date"==e&&"group_week"==t?6:"date"==e&&"fixed"==t?7:"expression"==t?8:-1}function p(){var t=b[e.selected.field.fid]||[];t.length>0||e.showLoading?(e.searchList=t,e.searchListAll=t):e.fieldRangeMap[e.selected.field.fid]||(e.showLoading=!0,n.post("/api/field/item_search",{tb_id:e.tb_id||e.ngDialogData.tb_id,field:angular.toJson(e.selected.field),keyword:""}).then(function(t){var r=t.result;e.fieldTotalItems=r.total,e.searchList=e.fieldRangeMap[e.selected.field.fid]=r.items,e.searchListAll=e.fieldRangeMap[e.selected.field.fid]=r.items,b[e.selected.field.fid]=r.items,e.showLoading=!1,e.itemEvent.noSearchList()}))}function g(t,r){var n,a={default_name:e.defaultGroupName};return"expression"===r?n={type:r,groups:[]}:"number"==t?"fixed"==r?(n={type:r,range:[]},i.field.getRange(e.newField.tb_id,e.selected.field.fid,e.newField.ct_id).success(function(e){0==e.status&&(n.range[0]=e.result.range[0],n.range[1]=e.result.range[1])})):"custom"==r&&(n={type:r,groups:[]}):"string"==t?("item"===r&&p(),n={type:r,groups:[],default_name:e.defaultGroupName}):"date"==t&&(n="custom"==r||y(r,"group_")?{type:r,groups:[]}:{type:r,aggregator:"year",start:[],step:""}),n&&n.groups&&n.groups.push(f(t,r)),angular.extend(a,n)}function f(t,r){var n={name:e.newGroupPrefix+1};return"expression"===r?n.expression="":"number"==t&&"custom"==r?(n.range=[],n.boundary=[0,0]):"string"==t?r&&"condition"!==r||(n.logic="AND",n.conditions=[],"condition"===r&&(n.conditions=[{operator:"0",value:""}])):"date"==t&&(n.range="group_year"==r?[1,1,1,1]:"group_month"==r?[1,1]:"group_week"==r?[1,1]:[]),n}function c(){return a(["field.defaultGroup","field.itemWithoutGroup","field.groupPrefix","field.meetAll","field.to","field.meetAny","field.general","field.yearsGroup","field.monthsGroup","field.weeksGroup","field.fixedStep","chart.dateFilterExpression","lang","year","quarter","month","week","day","equal","contain","notContain"]).then(function(t){e.operatorMap={0:t.equal,1:t.contain,2:t.notContain},e.logicMap={AND:t["field.meetAll"],OR:t["field.meetAny"]},e.dateGroupTypeList=[{type:"custom",name:t["field.general"]},{type:"group_year",name:t["field.yearsGroup"]},{type:"group_month",name:t["field.monthsGroup"]},{type:"group_week",name:t["field.weeksGroup"]},{type:"fixed",name:t["field.fixedStep"]},{type:"expression",name:t["chart.dateFilterExpression"]}],e.lang=t.lang,e.aggregators=[{type:"year",name:t.year},{type:"quarter",name:t.quarter},{type:"month",name:t.month},{type:"week",name:t.week},{type:"day",name:t.day}],e.to=t["field.to"],e.newGroupPrefix=t["field.groupPrefix"],e.itemWithoutGroup=t["field.itemWithoutGroup"],e.defaultGroupName=t["field.defaultGroup"]})}function m(){if(e.groupData.info.groups){for(var t=e.groupData.info.groups,r=0;r<t.length;r++)if(""==t[r].name||!t[r].name)return!0;return!1}}function h(){if(e.groupData.info.groups){var t,r=e.groupData.info.groups,n=[];for(t=0;t<r.length;t++)n.push(r[t].name);for(n=n.sort(),t=0;t<n.length;t++)if(n[t]==n[t+1])return!0;return!1}}function v(e){return 10>e?"0"+e:e+""}function y(e,t){return null==t||""==t||0==e.length||t.length>e.length?!1:e.substr(0,t.length)==t?!0:!1}function x(e,t){var r={"M+":e.getMonth()+1,"d+":e.getDate()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(var n in r)new RegExp("("+n+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?r[n]:("00"+r[n]).substr((""+r[n]).length)));return t}var D=e.groupData=angular.copy(e.newField.param)||{type:"group",info:{groups:[]}};!D.info.default_name&&D.info.default&&(D.info.default_name=D.info.default,delete D.info.default),"string"===D.data_type&&void 0===D.info.type&&(D.info.type="condition");var _="",G=[],w="create"==e.newField.type;e.LessThen=[{value:0,text:"<"},{value:1,text:"≤"}],e.selectedlist=!0,e.addmanually=!1,e.select={},e.selected={field:null,dateGroupType:null},e.fieldRangeMap={},e.searchList=[],e.searchListAll=[],e.field_list=e.ngDialogData.fieldList,e.fieldList=e.field_list,e.dateList={monthList:[1,2,3,4,5,6,7,8,9,10,11,12],weekDayList:[1,2,3,4,5,6,7],dayList:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31]},e.dayList1=e.dateList.dayList,e.dayList2=e.dateList.dayList;var b=(e.dateList.dayList,{});e.initGroupInfo=function(t){e.itemEvent.keyword="";var r=e.selected.field.data_type;t="date"==r?t||e.selected.dateGroupType&&e.selected.dateGroupType.type||"custom":"string"==r?t||"condition":t||"fixed",D.info.type=t;var n=d(r,t);e.select={},(w||n!=e.groupType)&&(e.groupType=n,D.info=g(r,t)),D.info.groups&&e.selectGroup(D.info.groups[0],r,t)},e.$watch("groupData.info.aggregator",function(t){"date"==e.selected.field.data_type&&"fixed"==D.info.type&&n.get("/api/field/range",{ct_id:e.newField.ct_id,tb_id:e.newField.tb_id,granularity:t,fid:e.selected.field.fid,adv_enum_display:0}).then(function(r){0==r.status&&(e.dateRanges=r.result.range,w||_&&_!=t?"day"==t?e.groupData.info.start[1]=e.dateRanges[e.dateRanges.length-1]:e.groupData.info.start[0]=bdpChart.helper.checkGranularity(t,e.dateRanges[e.dateRanges.length-1]):_&&_==t&&G.length&&("day"==t?e.groupData.info.start[1]=G[1]:e.groupData.info.start[0]=G[0]))})}),e.getAggreName=function(){for(var t=0;t<e.aggregators.length;t++)if(e.aggregators[t].type==e.groupData.info.aggregator)return"en"==e.lang&&e.groupData.info.step>1?e.aggregators[t].name+"s":e.aggregators[t].name};var L=[];e.checkInvalidNumber=function(t,n){var i=t.target;angular.element(i).hasClass("ng-invalid-number")?(L[n]=!0,r(e.tips["field.invalidNumber"])):L[n]=!1},o.$on("$translateChangeSuccess",c),e.addNewNumberGroup=function(t){for(var t,n=e.groupData.info.groups,i=0;i<n.length;i++){var a=n[i];if(a.name||(a.name=e.newGroupPrefix+n.length),0==a.range.length||void 0==a.range[0]&&void 0==a.range[1]||L[0]||L[1])return void r(e.tips["field.mustBeNumber"]);if(a.range[0]>a.range[1])return void r(e.tips["field.numberRangeErr"]);void 0==a.range[0]?a.range[0]=null:void 0==a.range[1]&&(a.range[1]=null)}t={name:e.newGroupPrefix+(D.info.groups.length+1),range:[],boundary:[0,0]},D.info.groups.push(t),L=[]},e.addNewStringGroup=function(){function t(){var t=!0;return angular.forEach(e.groupData.info.groups,function(e){e.name||(t=!1)}),t}if(!t())return void r(e.tips["field.nameRequired"]);var n=D.info.type,i=D.info.groups,a={name:e.newGroupPrefix+(i.length+1),conditions:[]};if("condition"===n){for(var o=0;o<i.length;o++)for(var l=i[o].conditions,s=0;s<l.length;s++){var u=l[s];if(!u.value)return void r(e.tips["field.conditionRequired"])}a.logic="AND",a.conditions.push({operator:"0",value:""})}else if("item"===n)for(var o=0;o<i.length;o++){var l=i[o].conditions;if(!l.length)return void r(e.tips["field.conditionRequired"])}i.push(a),e.selectGroup(a,"string",n)},e.addNewDateGroup=function(t){var n,i=e.groupData.info.groups;if("custom"==t){for(var a=0;a<i.length;a++){var o=i[a];if(o.name||(o.name=e.newGroupPrefix+i.length),0==o.range.length||void 0==o.range[0]&&void 0==o.range[1])return r(e.tips["field.plzChooseLeastOneOfStart_endDate"]),!1}n={name:e.newGroupPrefix+(D.info.groups.length+1),range:[]}}else if("group_year"==t){for(var a=0;a<i.length;a++){var o=i[a];if(o.name||(o.name=e.newGroupPrefix+i.length),o.range[0]>o.range[2]||o.range[0]==o.range[2]&&o.range[1]>o.range[3])return r(e.tips["field.endDateGtStartDate"]),void(o.range=[1,1,1,1])}n={name:e.newGroupPrefix+(D.info.groups.length+1),range:[1,1,1,1]}}else if("group_month"==t){for(var a=0;a<i.length;a++){var o=i[a];if(o.name||(o.name=e.newGroupPrefix+i.length),o.range[0]>o.range[1])return r(e.tips["field.endDateGtStartDate"]),void(o.range=[1,1])}n={name:e.newGroupPrefix+(D.info.groups.length+1),range:[1,1]}}else if("group_week"==t){for(var a=0;a<i.length;a++){var o=i[a];if(o.name||(o.name=e.newGroupPrefix+i.length),o.range[0]>o.range[1])return r(e.tips["field.endDateGtStartDate"]),void(o.range=[1,1])}n={name:e.newGroupPrefix+(D.info.groups.length+1),range:[1,1]}}D.info.groups.push(n)},e.addNewExpressionGroup=function(){if("default"!==e.select.group.type&&e.select.group&&!e.select.group.expression)return void r(e.tips["filter.checkFailed"]);var t={name:e.newGroupPrefix+(D.info.groups.length+1),expression:""};D.info.groups.push(t),e.selectGroup(t,e.selected.field.data_type,"expression")},e.removeGroup=function(t){var r=e.groupData.info.groups.splice(t,1);r=r[0],angular.toJson(r)==angular.toJson(e.select.group)&&(e.groupData.info.groups.length?e.selectGroup(e.groupData.info.groups[0],e.groupData.data_type,e.groupData.info.type):e.selectGroup("default"))},e.selectGroup=function(t,n,i){if(e.select.group!=t){if(e.select.group&&!e.select.group.name&&"default"!=e.select.group.type)return void r(e.tips["field.nameRequired"]);if("default"===t)return e.select.group={},e.select.group.name=D.info.default_name,void(e.select.group.type="default");e.select.group=t;var a=d(n,i);if(21==a)e.select.group.conditions||(e.select.group.conditions=[],e.select.group.logic="AND",e.select.group.conditions.push({operator:"0",value:""}));else if(22==a)p(),e.select.group.conditions||(e.select.group.conditions=[]);else if(8==a){e.select.group.expression||(e.select.group.expression="");var o=new RegExp("\\[_field_id_\\]","g");e.select.group.expression=e.select.group.expression.replace(o,"["+e.selected.field.name+"]"),u(function(){e.$broadcast("changeDateExpression",e.select.group.expression)})}e.itemEvent.noSearchList(),e.selectgroup=!1,e.selectedlist=!0}},e.addCondition=function(t,n){for(var n,i=t.conditions,a=0;a<i.length;a++){var o=i[a];if(!o.value)return void r(e.tips["field.conditionRequired"])}n={operator:"0"},t.conditions.push(n)},e.sortGroupField={start:function(){},stop:function(){},items:"li:not(.default-group-name)"},e.showDefaultGroup=function(){return e.select.group&&"default"===e.select.group.type},e.showConditionList=function(){return e.select.group&&!e.showDefaultGroup()},e.removeCondition=function(e,t){e.splice(t,1)},e.commit=function(){if(!e.selected.field)return!1;if(0==e.newField.name.length)return void r(e.tips["field.nameRequired"]);if(e.newField.name.length>200)return void r(e.tips["field.newFieldNameTooLong"]);for(var t=0;t<e.field_list.length;t++)if(e.field_list[t].name===e.newField.name&&e.field_list[t].fid!==e.newField.fid)return r(e.tips["error.fieldRepeat"]),!1;if(m())return void r(e.tips["field.plzCommitAfterCheckGroupName"]);if(h())return void r(e.tips["field.groupNameRepeated"]);e.groupData.info.default_name||(e.groupData.info.default_name="zh"==o.language?"未分组":"Ungrouped");var n,i=function(){return n=e.groupData.info.groups,n&&0!=n.length?n:(r(e.tips["field.atLeastOneGroup"]),!1)};e.groupData.fid=e.selected.field.fid,e.groupData.data_type=e.selected.field.data_type;{var a=d(e.groupData.data_type,e.groupData.info.type);angular.copy(e.groupData.info)}switch(a){case 0:var l=e.groupData.info.range,s=e.groupData.info.step;if(void 0==l[0]||void 0==l[1])return r(e.tips["field.stepStartAndEnd"]),!1;if(void 0==s)return r(e.tips["field.stepValueRequired"]),!1;break;case 1:if(n=e.groupData.info.groups,!n||0==n.length)return r(e.tips["field.atLeastOneGroup"]),!1;for(var t=0;t<n.length;t++){var u=n[t];if(0==u.range.length||void 0==u.range[0]&&void 0==u.range[1]||L[0]||L[1])return void r(e.tips["field.mustBeNumber"]);if(void 0!=u.range[0]&&void 0!=u.range[1]&&u.range[0]>u.range[1])return void r(e.tips["field.numberRangeErr"]);void 0==u.range[0]?u.range[0]=null:void 0==u.range[1]&&(u.range[1]=null)}break;case 21:case 22:if(n=e.groupData.info.groups,!n||0==n.length)return r(e.tips["field.atLeastOneGroupItem"]),!1;for(var p,t=0,g=n.length;g>t;t++){if(p=n[t],0==p.conditions.length)return r(p.name+" "+e.tips["field.groupConditionRequired"]),!1;if(p.conditions.length>1e3)return r(p.name+" "+e.tips["filter.groupItemOver1000"]),!1}if(21===a)for(var t=0,g=n.length;g>t;t++)for(var f=n[t].conditions,c=0;c<f.length;c++){var u=f[c];if(!u.value)return void r(e.tips["field.conditionRequired"])}break;case 3:n=e.groupData.info.groups;for(var t=0;t<n.length;t++){var u=n[t];if(0==u.range.length||void 0==u.range[0]&&void 0==u.range[1])return r(e.tips["field.plzChooseLeastOneOfStart_endDate"]),!1;if(void 0!=u.range[0]&&void 0!=u.range[1]&&u.range[0]>u.range[1])return void r(e.tips["field.endDateGtStartDate"]);u.range[0]=void 0==u.range[0]?null:x(new Date(u.range[0]),"yyyy-MM-dd"),u.range[1]=void 0==u.range[1]?null:x(new Date(u.range[1]),"yyyy-MM-dd")}break;case 4:n=i();for(var t=0;t<n.length;t++)n[t].range[0]=v(n[t].range[0])+v(n[t].range[1]),n[t].range[1]=v(n[t].range[2])+v(n[t].range[3]),n[t].range.splice(2,2);break;case 7:var s=e.groupData.info.step,y=e.groupData.info.aggregator,D=e.groupData.info.start;if(!s)return r(e.tips["field.stepValueRequired"]),!1;if(1>s)return r(e.tips["field.stepValueGtOne"]),!1;if(!D.length)return r(e.tips["field.plzChooseAStartDate"]),!1;if("year"==y||"quarter"==y||"month"==y||"week"==y){if(!D[0])return r(e.tips["field.plzChooseAStartDate"]),!1;D.length>1&&D.splice(1,1);var _=D[0].match(/\d+/g);"zh"==e.lang?angular.extend(D,_):angular.extend(D,_.reverse())}else{if(!D[1])return r(e.tips["field.plzChooseAStartDate"]),!1;D[0]=x(new Date(D[1]),"yyyy-MM-dd"),D.splice(1,1)}break;case 8:if(n=i(),!n)return!1;break;default:if(n=i(),!n)return!1}var G=angular.extend(e.newField,{param:e.groupData,data_type:"string"});e.addCalcField(G)},c().then(function(){if(w){e.selected.field=e.fieldList[0];var t=e.selected.field.data_type;"date"==t&&(e.selected.dateGroupType=e.dateGroupTypeList[0]),e.initGroupInfo("string"===t?"condition":"custom")}else{e.groupType=d(D.data_type,D.info.type);for(var r=0,n=e.fieldList.length;n>r;r++)if(D.fid==e.fieldList[r].fid){e.selected.field=e.fieldList[r];break}if("date"==e.selected.field.data_type){for(var i=0;i<e.dateGroupTypeList.length;i++)if(e.dateGroupTypeList[i].type==D.info.type){e.selected.dateGroupType=e.dateGroupTypeList[i];break}var a=D.info.groups;if("fixed"==D.info.type){var o=D.info.aggregator,l=D.info.start;if(_=angular.copy(o),"day"!==o&&"week"!=o){var s=new Date(l[0]+"-01-01 00:00:00");"quarter"==o?s.setMonth(3*l[1]-1):"month"==o&&s.setMonth(l[1]-1),l[0]=bdpChart.helper.checkGranularity(o,s.getTime())}else"week"==o?l[0]="zh"==e.lang?l[0]+"年第"+l[1]+"周":"Week "+l[1]+"-"+l[0]:"day"==o&&(l[1]=l[0]);G=angular.copy(l)}else if("group_year"==D.info.type)for(var r=0;r<a.length;r++)a[r].range[3]=Number(a[r].range[1].substr(2,2)),a[r].range[2]=Number(a[r].range[1].substr(0,2)),a[r].range[1]=Number(a[r].range[0].substr(2,2)),a[r].range[0]=Number(a[r].range[0].substr(0,2));else if("group_month"==D.info.type)for(var r=0;r<a.length;r++)a[r].range[0]=Number(a[r].range[0]),a[r].range[1]=Number(a[r].range[1])}e.initGroupInfo(D.info.type)}}),e.fixDatePickerPos=function(t){e.datePickerPos={left:t.clientX,top:t.clientY}},e.groupExpression={setExpression:function(t){e.groupData.info.groups&&e.select.group&&(e.select.group.expression=t)},expressionChanged:function(t,r){e.expressionChangedFlag=t,e.groupExpression.setExpression(r)},insertFieldNameToExpression:function(t){e.expressionChangedFlag=!0,e.$broadcast("insertFieldNameToExpression",t)},checkFormulaGrammar:function(t,i){""==t&&(t=e.selected.field.name),t=bdp.utils.requote(t);var a=new RegExp("\\["+t+"\\]","g");e.select.group.expression=e.select.group.expression.replace(a,"[_field_id_]");var o={tb_id:e.tb_id,fid:i,expression:e.select.group.expression};return e.expressionChangedFlag=!1,n.post("/api/field/group_expr_verify",o,{errHint:!1}).then(function(t){return 0==t.status?(r(e.tips["filter.checkSuccess"]),e.checkFormulaGrammarFlag=!0,!0):(r(e.tips["filter.checkFailed"]),e.checkFormulaGrammarFlag=!1,!1)})}},e.itemEvent={addItem:function(t){var n=!1,i=$(".add-manually");return $.inArray(t,e.select.group.conditions)>-1&&(n=!0),n?void r(e.tips["filter.itemExist"]):e.select.group.conditions.length>=1e3?(r(e.tips["filter.groupItemOver1000"],{dialog:!0}),!1):(e.select.group.conditions.push(t),i.val(""===i.val()?i.val()+t:i.val()+"\n"+t),void u(function(){var e=$(".add-list").find("ul"),t=e[0].scrollHeight;e.animate({scrollTop:t}),i.focus()},300))},delItem:function(t){e.select.group.conditions.splice(t,1),e.nosearch_list=[],e.itemEvent.noSearchList()},addAll:function(){return e.select.group.conditions.length>=1e3?(r(e.tips["filter.groupItemOver1000"],{dialog:!0}),!1):void angular.forEach(e.searchList,function(t){e.select.group.conditions.indexOf(t)<0&&e.select.group.conditions.push(t)})},delAll:function(){e.select.group.conditions.length=0,e.nosearch_list=[]},search:function(t){var r={tb_id:e.tb_id,field:angular.toJson(e.selected.field),rule_id:o.global.rule_id||"",keyword:t};n.post("/api/field/item_search",r).then(function(t){0==t.status&&(e.searchList=t.result.items,e.show=!0)})},keyupEvent:function(t,r){13===t.keyCode&&e.itemEvent.search(r)},mouseLeave:function(){e.show=!1},itemEdit:function(){e.selectedlist=!1,e.addmanually=!0,e.selectgroup=!0;var t=e.select.group.conditions,r=$(".add-manually");r.val(""),setTimeout(function(){r.focus()},300);var n=r.val(),i=n.split("\n"),a=0,o="";if(""==n)o+=t.join("\n");else for(var l=0;l<t.length;l++){for(var s=0;s<i.length;s++)i[s]==t[l]&&(a=1);0===a&&(o+="\n"+t[l])}r.val(n+o)},addDone:function(){{var t=$(".add-manually").val().split("\n");e.select.group.conditions}return e.select.group.conditions=[],angular.forEach(t,function(r,n){e.select.group.conditions.indexOf(r)<0&&""!==t[n]&&e.select.group.conditions.push(r)}),e.select.group.conditions.length<=1e3?(e.itemEvent.noSearchList(),e.selectedlist=!0,e.addmanually=!1,void 0):(r(e.tips["filter.groupItemOver1000"],{dialog:!0}),!1)},noSearchList:function(){if(e.nosearch_list=[],"item"===e.groupData.info.type&&e.select.group.conditions.length>0){if(e.select.group.conditions.length>1e3)return r(e.tips["filter.groupItemOver1000"],{dialog:!0}),!1;n.post("/api/field/item_validate",{tb_id:e.tb_id,field:angular.toJson(e.selected.field),items:angular.toJson(e.select.group.conditions)}).then(function(t){var r=t.result;"0"==t.status&&angular.forEach(e.select.group.conditions,function(t,n){r[t]||e.nosearch_list.push(n)})})}}},l(["field.numberRangeErr","field.invalidNumber","field.mustBeNumber","field.conditionRequired","field.nameRequired","field.stepStartAndEnd","field.stepValueRequired","field.atLeastOneGroup","field.atLeastOneGroupItem","field.groupConditionRequired","field.newFieldNameTooLong","field.plzCommitAfterCheckGroupName","field.groupNameRepeated","field.stepValueGtOne","field.plzChooseAStartDate","field.plzChooseLeastOneOfStart_endDate","field.endDateGtStartDate","filter.itemExist","filter.groupItemOver1000","error.fieldRepeat"],e)}angular.module("BC.controllers.chartEdit").controller("FieldGroupController",e),e.$inject=["$scope","$stateParams","errHint","commonHttp","commonService","$translate","$rootScope","$jsTipTranslate","$filter","$timeout"]}();
;!function(){angular.module("BC.controllers.chartEdit").controller("enumOrderCtrl",["$scope","commonService","errHint","alphaOrderType",function(e,t,a,n){function r(e){var t=angular.extend({},e);return 2==e.type&&(t.type="ascending"==e.alpha_order_type?2:3,delete t.alpha_order_type),4!=t.type?delete t.template:t.template=angular.toJson(t.template),t}function o(e){var t=angular.extend({},e);return t.alpha_order_type=3==e.type?"descending":"ascending",t.type=3==e.type?2:e.type,t}function i(a,n,r){e.loading=!0,t.enumField.getOrderInfo(a,n).then(function(t){e.originOrder=t,r&&(t.type=4),e.viewData=o(t),e.loading=!1,t.template.length>100&&(e.disable_sort=!0)},function(){e.loading=!1})}var l=e.ngDialogData.fid,p=(e.ngDialogData.uniq_id,e.ngDialogData.tb_id),s=e.ngDialogData.isCustomOrder;fieldIndex=e.ngDialogData.fieldIndex,e.alpha_order_types=n,e.sortEnumField={start:function(){},stop:function(){}},e.incOnePos=function(t){var a=e.viewData.template;if(t>0){var n=a[t];a[t]=a[t-1],a[t-1]=n}},e.descOnePos=function(t){var a=e.viewData.template;if(t<a.length-1){var n=a[t];a[t]=a[t+1],a[t+1]=n}},e.save=function(n,o){var i=r(e.viewData),l=e.chart_ops.meta.level[e.drill_level],s={config_list:[]},d={tb_id:p,fid:n,type:i.type,template:i.template?$.parseJSON(i.template):[]};4!=i.type&&delete d.template,s.config_list.push(d),s.config_list=angular.toJson(s.config_list),t.enumField.updateOrder(s).then(function(t){var r=t;0==r.status?("x"===o&&l.sort&&"x"===l.sort.axis&&l.sort.fid===n&&(l.sort.type="custom"),l.compare_axis&&l.compare_axis.forEach(function(e){"compare_axis"===o&&e.fid===n&&(e.compare_sort?e.compare_sort.type="custom":e.compare_sort={type:"custom",fid:n,axis:"compare_axis"})}),e.onSaveEnumOrder(n),e.closeThisDialog()):a(r.errstr,{dialog:!0})})},i(p,l,s)}])}();
;!function(){angular.module("BC.controllers.authorManageCtrl",[]).controller("authorManageCtrl",["$scope","ngDialog","commonService","errHint","$jsTipTranslate",function(t,e,o,i,n){t.isInt=function(t){return t%1===0},t.getInfo=function(){o.authority.info().then(function(e){var o=e.result;t.manager=o.manager,t.authorizing=o.authorizing,t.authorized=o.authorized})},t.getInfo(),t.checkValue=function(e){if(0==e.time_type){if(0==e.timeLength){if(""===e.customizeTimeLength)return i(t.tips["author.err.setHour"]),!1;if(e.customizeTimeLength>1e4||e.customizeTimeLength<0)return i(t.tips["author.err.setHourLimit"]),!1;if(!t.isInt(e.customizeTimeLength))return i(t.tips["author.err.setHourInt"]),!1}}else{{new Date}if(!e.byDate)return i(t.tips["author.err.setDate"]),!1;if(e.byHour>23||e.byHour<0)return i(t.tips["author.err.setHourRange"]),!1;if(e.byMinute>59||e.byMinute<0)return i(t.tips["author.err.setMinuteRange"]),!1;if(e.bySecond>59||e.bySecond<0)return i(t.tips["author.err.setSecondRange"]),!1}return!0},t.addAuthorization=function(o){var i={name:o.name,time_type:0,end:1,timeLength:1,customizeTimeLength:0,byHour:0,byMinute:0,bySecond:0};e.open({template:"/static/partials/dialogTemplates/add_authorization.html",className:"ngdialog-theme-default ngdialog-width-344 ngdialog-add-authorization",data:i,scope:t,controller:"addAuthorCtrl"})},t.changeAuthorizationTime=function(o){var i={auth_id:o.auth_id,auth_user:o.auth_user,end:o.time_setting.end,time_type:o.time_setting.time_type,byHour:0,byMinute:0,bySecond:0};if(0==i.time_type)switch(i.end){case 1:i.timeLength=1;break;case 2:i.timeLength=2;break;case 3:i.timeLength=3;break;case 5:i.timeLength=5;break;default:i.timeLength=0,i.customizeLength=!0,i.customizeTimeLength=i.end}else{var n=new Date(Number(i.end));i.byDate=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate(),i.byHour=n.getHours(),i.byMinute=n.getMinutes(),i.bySecond=n.getSeconds()}e.open({template:"/static/partials/dialogTemplates/modify_authorization.html",className:"ngdialog-theme-default ngdialog-width-344 ngdialog-add-authorization",data:i,scope:t,controller:"modifyAuthorCtrl"})},t.stopAuthorization=function(o){e.open({template:"/static/partials/dialogTemplates/stop_authorization.html",className:"ngdialog-theme-default ngdialog-width-344 ngdialog-stop-authorization",data:{auth_id:o.auth_id},scope:t,controller:"stopAuthorCtrl"})},t.operationHistory=function(i){o.authority.oplog({auth_id:i.auth_id}).then(function(o){t.operHistory=o.result,e.open({template:"/static/partials/dialogTemplates/operation_history.html",className:"ngdialog-theme-default ngDialog-width-520 auth-operation-history",data:{auth_data:i},scope:t,controller:"operationHistoryCtrl"})})},n(["author.err.setHour","author.err.setHourLimit","author.err.setHourInt","author.err.setDate","author.err.setHourRange","author.err.setMinuteRange","author.err.setSecondRange"],t)}]).controller("addAuthorCtrl",["$scope","commonService","errHint","$jsTipTranslate",function(t,e,o,i){t.needConfirm=!0,t.picker_date=null,t.customizeLength=!1,t.showPicker=!1,t.showTimeLength=!0,t.toggleTimeLength=function(e){t.showTimeLength="show"==e},t.switchDate=function(e,o){e.stopPropagation(),o||(t.showPicker=!t.showPicker)},t.toggleCustomize=function(t){t.customizeLength=0==t.timeLength},t.$watch("picker_date",function(e){e&&(t.ngDialogData.byDate=Highcharts.dateFormat("%Y-%m-%d",e))}),t.addAuthority=function(i){if(1==t.needConfirm){if(!t.checkValue(i))return!1;if(0==i.time_type){var n=new Date;i.auth_start_time=Math.floor(n.valueOf()/1e3),i.end=0==i.timeLength?i.customizeTimeLength:i.timeLength}else if(1==i.time_type){var a=i.byDate.split("-");a[3]=i.byHour,a[4]=i.byMinute,a[5]=i.bySecond;var r=new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5]),n=new Date;i.endDate=r.valueOf(),i.auth_start_time=Math.floor(n.valueOf()/1e3),i.end=Math.floor(r.valueOf()/1e3)-Math.floor(n.valueOf()/1e3)}if(i.end<0)return o(t.tips["author.err.setTimeBeforeNow"]),!1;t.needConfirm=!1}else e.authority.create({time_type:i.time_type,end:i.end}).then(function(){t.getInfo(),t.closeThisDialog()})},t.closeAddAuthority=function(){1==t.needConfirm?t.closeThisDialog():t.needConfirm=!0},i(["author.err.setTimeBeforeNow"],t)}]).controller("modifyAuthorCtrl",["$scope","commonService","errHint","$jsTipTranslate",function(t,e,o,i){t.needConfirm=!0,t.picker_date=null,t.customizeLength=!1,t.showPicker=!1,t.showTimeLength=!0,t.toggleTimeLength=function(e){t.showTimeLength="show"==e},t.switchDate=function(e,o){e.stopPropagation(),o||(t.showPicker=!t.showPicker)},t.toggleCustomize=function(t){t.customizeLength=0==t.timeLength},t.$watch("picker_date",function(e){e&&(t.ngDialogData.byDate=Highcharts.dateFormat("%Y-%m-%d",e))}),t.addAuthority=function(i){if(1==t.needConfirm){if(!t.checkValue(i))return!1;if(0==i.time_type){var n=new Date;i.auth_start_time=Math.floor(n.valueOf()/1e3),i.end=0==i.timeLength?i.customizeTimeLength:i.timeLength}else if(1==i.time_type){var a=i.byDate.split("-");a[3]=i.byHour,a[4]=i.byMinute,a[5]=i.bySecond;var r=new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5]),n=new Date;i.endDate=r.valueOf(),i.auth_start_time=Math.floor(n.valueOf()/1e3),i.end=Math.floor(r.valueOf()/1e3)-Math.floor(n.valueOf()/1e3)}if(i.end<0)return o(t.tips["author.err.setTimeBeforeNow"]),!1;t.needConfirm=!1}else e.authority.modify({auth_id:i.auth_id,time_type:i.time_type,end:i.end}).then(function(){t.getInfo(),t.closeThisDialog()})},t.closeAddAuthority=function(){1==t.needConfirm?t.closeThisDialog():t.needConfirm=!0},i(["author.err.setTimeBeforeNow"],t)}]).controller("stopAuthorCtrl",["$scope","commonService",function(t,e){t.stopAuthority=function(o){e.authority.stop({auth_id:o.auth_id}).then(function(){t.getInfo(),t.closeThisDialog()})}}]).controller("operationHistoryCtrl",["$scope","commonService",function(t,e){t.getList=function(o){var i=t.ngDialogData.auth_data.auth_id;e.authority.oplog({auth_id:i,page:o}).then(function(e){t.operHistory=e.result})}}])}();
;!function(){function a(a,t,e,r,n,i){a.page={dataList:[],curpage:1,lastpage:!1},a.warnListLoading=!1,e.show_bdp_header=!1,a.warnOperatorMap=i;var o=function(r){a.warnListLoading=!0,t.get("/api/warn/history",{page:r?r:1}).then(function(t){a.warnListLoading=!1,e.unread=0,e.view="warning";var r="en"==$.cookie("locale")?"Untitled Chart":"未命名图表";if(0==t.status){t.result.cur_page==t.result.page_count&&(a.page.lastpage=!0),a.page.curpage=t.result.cur_page;var n=t.result.warn_his,i=a.page.dataList;angular.forEach(n,function(a){a.ct_name||(a.ct_name=r),0==i.length?i.push({time:bdpChart.helper.checkGranularity("day",new Date(a.ctime)),list:[a]}):bdpChart.helper.checkGranularity("day",new Date(a.ctime))==i[i.length-1].time?i[i.length-1].list.push(a):i.push({time:bdpChart.helper.checkGranularity("day",new Date(a.ctime)),list:[a]})})}})};o(),a.goDash=function(a,t,n,i){e.dashSelected=t,e.activeProjId=a,e.warnListSelectedItem={ct_id:i},n?(e.global.rule_id=a,r.path(e.wsId?"/dash_edit_ws/"+e.wsId+"/"+a+"/"+t+"/"+n:"/dash_edit/"+a+"/"+t+"/"+n)):r.path(e.wsId?"/dash_edit_ws/"+e.wsId+"/"+a+"/"+t:"/dash_edit/"+a+"/"+t)},a.showMore=function(){var t=a.page.curpage+1;o(t)},a.back=function(){var t=localStorage.getItem("mc_location_path");r.path(t||"/dash_edit"),a.back_guide=!1}}angular.module("BC.controllers.warn",[]).controller("WarnController",a),a.$inject=["$scope","commonHttp","$rootScope","$location","$timeout","warnOperatorMap"]}();
;!function(){function e(e,t,n,i,a,o,c,r,l,s,g){function u(t,i){var a={purpose:t.typeId,page:i};e.noticeListModel=void 0,n.pageLoading=!0,c.notice.getListByType(a).then(function(i){if(0==i.status){var a=i.result.new_data;e.noticeListModel=[];for(var o=0,c=a.length;c>o;o++)e.noticeListModel.push({id:a[o].log_id,type:t.typeId,link:angular.fromJson(a[o].link),content:a[o].htmlStr,releaseTime:a[o].ctime,picList:a[o].img_list,isRead:a[o].is_read});e.initConfig.page.total=i.result.page_count}else r(i.errstr);n.pageLoading=!1})}function p(t){var n={notice_id_list:[]},i=(e.noticeListModel,t.unReadNewsLen);n.notice_id_list.push(t.id);for(var a=e.tabs.length-1;a>=0;a--)e.tabs[a].typeId==t.type&&(e.tabs[a].unReadNewsLen-=1);t.isRead=!0,n.notice_id_list.length>0&&(n.notice_id_list=angular.toJson(n.notice_id_list),c.notice.setNoticeReaded(n).then(function(e){0==e.status||(t.unReadNewsLen=i,r(e.errstr))}))}n.show_bdp_header=!1,e.noticeListModel=void 0,e.tabs=[],e.initConfig={currentTab:{typeId:g.noticeTpye},page:{current:1,total:1}},e.showBigImg=function(e,t){s.open({template:'<div><div class="notice-img-wrap J-close-by-bg" ng-click="closeByBg($event)"><img class="notice-img" ng-src="{{playFlag.currentImgSrc}}"></div>                           <div class="close-btn" ng-click="closeThisDialog()"><i class="bdp-icon ico-cancel-white"></i></div>                           <div class="play-control clearfix">                                <div class="fl play-left" ng-click="changePaly(playFlag.current - 1)"><i class="bdp-icon ico-prev"></i></div>                                <div class="fl play-number">{{playFlag.current + 1}}/{{playFlag.total}}</div>                                <div class="fl play-right" ng-click="changePaly(playFlag.current + 1)"><i class="bdp-icon ico-next"></i></div>                           </div></div>',plain:!0,showClose:!1,closeByDocument:!0,className:"ngdialog-theme-default notice-img-dialog",closeByEscape:!0,data:{imgList:e.picList,currentIndex:t},preCloseCallback:function(){$("body").off("keyup.showBigImg"),$("#MEIQIA-BTN-HOLDER").show()},controller:["$scope",function(e){e.init=function(){var t=e.ngDialogData.currentIndex||0;e.playFlag={total:e.ngDialogData.imgList.length,current:t,currentImgSrc:e.ngDialogData.imgList[t]},$("#MEIQIA-BTN-HOLDER").hide()},e.init(),$("body").on("keyup.showBigImg",function(t){37==t.keyCode?e.changePaly(e.playFlag.current-1):39==t.keyCode&&e.changePaly(e.playFlag.current+1)}),e.changePaly=function(t){0>t&&(t=e.ngDialogData.imgList.length-1),t>e.ngDialogData.imgList.length-1&&(t=0),e.playFlag.current=t,e.playFlag.currentImgSrc=e.ngDialogData.imgList[t],e.$$phase||e.$digest()},e.closeByBg=function(t){$(t.target).hasClass("J-close-by-bg")&&e.closeThisDialog()}}]})},e.changeNoticeType=function(t){for(var n=e.tabs.length-1;n>=0;n--)e.tabs[n].active=!1;e.initConfig.currentTab=t,t.active=!0;var i=localStorage.getItem("noticTipsMol")?angular.fromJson(localStorage.getItem("noticTipsMol")):{};i[t.typeId].show=!1,localStorage.setItem("noticTipsMol",angular.toJson(i)),e.initConfig.page.current=1,c.notice.getNoticeType().then(function(t){if(0==t.status){for(var n=t.result,i=0,a=n.length;a>i;i++)for(var o=e.tabs.length-1;o>=0;o--)e.tabs[i].typeId==n[i].purpose&&(e.tabs[i].unReadNewsLen=n[i].unread_num);u(e.initConfig.currentTab,1)}})},e.changeNoticePage=function(){a(function(){u(e.initConfig.currentTab,e.initConfig.page.current)},0,!1)},e.back=function(){e.$emit("noticeListClose"),n.back()},e.openMessagePage=function(e,t){return"A"==t.target.tagName?!1:(e.isRead||p(e),void window.open(e.link.href))},e.init=function(){c.notice.getNoticeType().then(function(t){if(0==t.status){for(var n=t.result,i=0,a=n.length;a>i;i++)e.tabs.push({title:l("noticeTypeMap")(n[i].purpose),active:!1,unReadNewsLen:n[i].unread_num,typeId:n[i].purpose}),g.noticeTpye&&g.noticeTpye==n[i].purpose&&(e.initConfig.currentTab=e.tabs[e.tabs.length-1],e.tabs[e.tabs.length-1].active=!0);g.noticeTpye||(e.initConfig.currentTab=e.tabs[0]),u(e.initConfig.currentTab,e.initConfig.page.current)}else r(t.errstr)})},e.init()}angular.module("BC.controllers.notice",[]).controller("noticeCtrl",e).filter("noticeTypeMap",[function(){return function(e){switch(e){case 1:return"产品更新";case 2:return"干货分享";case 3:return"系统消息";case 4:return"预警消息";case"产品更新日志":return 1;case"干货分享":return 2;case"系统消息":return 3;case"预警消息":return 4;default:return"请选择消息类型"}}}]),e.$inject=["$scope","commonHttp","$rootScope","$location","$timeout","warnOperatorMap","commonService","errHint","$filter","ngDialog","$stateParams"]}();
;angular.module("BC.directives",["ngDialog"]).directive("bdpLocalQuery",function(){function e(e,t){if(t.indexOf(".")<0)return e[t];for(var a=t.split("."),r=e;a.length;)r=r[a.shift()];return r}function t(t,a,r,o,n){function i(t){var n=e(t,r);return"number"==typeof n&&(n=n.toString()),"fuzzy"==o&&n.toLowerCase().indexOf(a.toLowerCase())>-1?!0:"exactly"==o&&n.toLowerCase()==a.toLowerCase()?!0:!1}r=r||"name",o=o||"fuzzy",n=n||["[]"],a=void 0==a?"":String(a);var s=t;return function c(e,t){if(!t.length)return e.hide_by_query=!i(e),e.hide_by_query;var r=t[0].match(/^(.*)(\[\])$/);if(!r)throw new Error("invalid struct, syntx error.");var o,n=!1;return o=""==r[1]?e:e[r[1]],o.forEach(function(e){n=!c(e,t.slice(1))||n}),""!=r[1]&&(e.hide_by_query=!n&&!(""==a||!a)),e}(s,n)}return{restrict:"A",scope:{tree:"=bdpLocalQuery",query:"=ngModel",struct:"=queryStruct",key:"=queryKey"},link:function(e,a){function r(){e.query&&""!=e.query?a.addClass("has-text"):a.removeClass("has-text")}var o=function(){t(e.tree,e.query,e.key,null,e.struct)};e.$watch("query",function(e,t){(e||t)&&e!=t&&o()}),e.$watch("tree",function(t){t&&(e.query="",a.blur(),r(),o())}),a.on("keyup.localQuery",function(t){27==t.which&&(e.$apply('query=""'),a.blur()),r()}),r()}}}).directive("chartOperate",["$location","$stateParams","$rootScope","setTableAdvSort",function(e,t,a,r){return{restrict:"A",templateUrl:"/static/js/dashboard/tpl/chart_operate.html",replace:!0,link:function(a,r,o){function n(){return{grid_index:o.pIndex}}a.edit=function(){var r=a.dashStandardItems[n().grid_index].children[0].meta,o=r.ct_id,i="C400"==r.type?"/gis_edit":"/chart_edit";$.cookie("grid_index",n().grid_index);var s=t.wsId?i+"_ws/"+t.wsId+"/":i+"/",c=s+t.projId+"/"+t.dashId+"/"+o;e.path(c)},a.refreshChart=function(e){var t=$(r).parents(".chart-box").find(".chart"),o=t.data("chart-data");t.find(".hz-table").length>0&&t.attr("data-drill","true"),"warn"===e.type?(localforage.getItem("CACHE_DASH_DATA",function(e,t){t&&(delete t[a.ct_id],localforage.setItem("CACHE_DASH_DATA",t))}),o.emit("reflow")):o.emit("reflow")}},controller:["$scope","commonHttp","warnOperatorMap","ngDialog",function(e,t,o,n){e.switchWarn=function(a){var r=1==a.meta.warn?2:1;t.get("/api/warn/switch",{ct_id:a.meta.ct_id,opt:r}).then(function(t){0===+t.status&&(a.meta.warn=r,e.refreshChart({type:"warn"}))})},e.chartInfo=[],e.chartData=[],e.$on("chart_data_load",function(t,a){e.ct_id=a.ct_id,e.rule_id=a.rule_id,e.chartInfo=a.info,e.chartData=a.chartData,e.warnList=e.chartInfo.warn_info||[],e.warnMark=e.chartData.warn_mark||[],e.warnSwitchOn=!1;for(var r=0;r<e.warnList.length;r++)if(e.warnList[r].switch){e.warnSwitchOn=!0;break}}),e.showTableAdvSort=function(t){$.isEmptyObject(t.advanced_sort)&&(t.advanced_sort=[]),r.show(e,e.saveChartImmediate,t)},e.canSetWarnLine=function(){var t=e.selected_type,a=e.drill_level||0;return t&&["C212","C230","C242","C271","C290","C300","C310","C320","C330","C340","C352","C360","C370","C400"].indexOf(t)<0&&1>a},e.getWarnYaxisFields=function(){function t(t){var a=[];return angular.forEach(t,function(t){if("row_summary"!=t.fid)if(t.nick_name)field_name=t.nick_name,a.push({name:field_name,fid:t.fid,uniq_id:t.uniq_id});else{field_name=t.name;var r=e.setAdvanceAggregatorName(t);a.push(r?{name:field_name+r,fid:t.fid,uniq_id:t.uniq_id}:{name:field_name,fid:t.fid,uniq_id:t.uniq_id})}}),a}e.chartInfo.yAxis&&e.chartInfo.yAxis.length>0&&(e.field_list_y=t(e.chartInfo.yAxis)),e.chartInfo.yAxisOptional&&e.chartInfo.yAxisOptional.length>0&&(e.field_list_y_optional=t(e.chartInfo.yAxisOptional))},e.field_list_y=[],e.field_list_y_optional=[],e.showSetWarningDialog=function(){var t=[],r=[];e.getWarnYaxisFields(),angular.forEach(e.warnList,function(e){0==e.axis_type?t.push(e):r.push(e)});var o=0;e.selected.rule_id&&a.proj_share?o=2:!e.selected.rule_id&&a.proj_share&&(o=1),e.warnConfigDialog=n.open({template:"/static/partials/chart_warning_config.html",className:"ngdialog-theme-default ngDialog-width-600 set-warning-dialog",scope:e,data:{warnYList:t,warnYOptionalList:r,yFieldsList:e.field_list_y,yOptionalFieldsList:e.field_list_y_optional,isYAxis:!0,isYOptionalAxis:e.chartInfo.hasOwnProperty("yAxisOptional")&&e.chartInfo.yAxisOptional.length>0,rule_id:e.rule_id||"",ct_id:e.ct_id||"",role_type:o,isDash:!0},controller:"chartWarnConfigCtrl"})},e.$on("refreshChartForWarn",function(){e.refreshChart({type:"warn"}),e.warnSwitchOn=!1;for(var t=0;t<e.warnList.length;t++)if(e.warnList[t].switch){e.warnSwitchOn=!0;break}})}]}}]).directive("fixMore",[function(){return{restrict:"A",scope:!0,link:function(e,t){$(t).on("mouseover",function(e){var t=$(this),a=t.next("ul.more-list");if(a.length){var r=e.pageY,o=a.height(),n=$(".chart-right");if(n[0]){var i=a&&a.css("width")?a.css("width").substr(0,a.css("width").indexOf("px")):null,s=i?i:t.outerWidth();n[0].getBoundingClientRect().left-t[0].getBoundingClientRect().right<s-6?a.css("left","-"+s+"px"):t.parent().parent().hasClass("more-list")?"-"==t.parent().parent().css("left").substr(0,1)?a.css("left","-"+s+"px"):n[0].getBoundingClientRect().left-t.parent()[0].getBoundingClientRect().right<s?a.css("left","-"+s+"px"):a.css("left","100%"):a.css("left","100%")}var c=document.body.clientHeight;a.css(r+o>c?{top:24-o}:{top:0})}})}}}]).directive("topChart",["errHint","$jsTipTranslate",function(e,t){return{restrict:"A",templateUrl:"/static/partials/directiveTemplates/topChart.html",scope:!0,link:function(a,r){function o(e){document.getElementById(e).focus()}var n;a.onToggleTop=function(){var e=0;a.global.chartData&&(e=a.global.chartData.x[0].data.length);var t=a.chart_ops.meta.level[a.drill_level].top;t.value||(t.value=e),t&&t.value?a.saveTop():t.enabled=!0},a.saveTop=function(){a.saveChartImmediate()},a.onTopChange=function(){var e=a.chart_ops.meta.level[a.drill_level].top;"undefined"!=typeof e.value&&""!==e.value&&a.saveTop()},a.onTopValueKeyup=function(e){13==e.keyCode&&a.onTopValueChange()},a.onTopValueChange=function(){var t=a.chart_ops.meta.level[a.drill_level].top;if(""!==t.value){var r=Number(t.value);if("percent"==t.type){var n=100>=r&&r>=0;if(!n)return e("请输入0 ~ 100之间的数"),o("topC"),!1}else if(isNaN(r)||0>=r||r>1500)return e(a.tips["chart.topChartRange"]),o("topD"),!1}a.saveTopCompare()},a.onToggleTopCompare=function(){var e=0;if(a.global.chartData){var t=a.global.chartData.y.concat(a.global.chartData.y_optional);e=t.length}var r=a.chart_ops.meta.level[a.drill_level].top_compare;r.value||(r.value=e),r&&r.value&&a.saveTopCompare()},a.saveTopCompare=function(){var e=a.chart_ops.meta.level[a.drill_level],t=e.top_compare,r=!1;for(var o in t)if(t.hasOwnProperty(o)&&n[o]!=t[o]){r=!0;break}r&&e.sort&&e.sort.col_index&&delete e.sort.col_index,n=angular.copy(t),a.saveChartImmediate()},a.onTopCompareChange=function(){var e=a.chart_ops.meta.level[a.drill_level].top_compare;"undefined"!=typeof e.value&&""!==e.value&&a.saveTopCompare()},a.onTopCompareValueKeyup=function(e){13==e.keyCode&&a.onTopCompareValueChange()},a.onTopCompareValueChange=function(){var t=a.chart_ops.meta.level[a.drill_level].top_compare;if(""!==t.value){var r=Number(t.value);if("percent"==t.type){var o=100>=r&&r>0;if(!o)return e("请输入0 ~ 100之间的数"),!1}else if(!/^[1-9][0-9]*$/.test(r)||r>1e3)return e(a.tips["chart.topChartRange"]),!1}a.saveTopCompare()},a.$watch("chart_ops.meta.level[drill_level]",function(e){e&&("object"!=typeof e.top_compare&&(e.top_compare={enabled:!1,reversed:0,type:"items"}),"object"!=typeof e.top&&(e.top={enabled:!1,reversed:0,value:e.top||"",type:"items"}),n=angular.copy(e.top_compare))}),bdp.utils.fixedBlur(r.find("input")),t(["chart.topChartRange","all"],a)}}}]).directive("exportImg",["$http","$rootScope","ngDialog",function(e,t,a){return{restrict:"A",scope:!0,link:function(e,r,o){function n(e,t,a){var r=Number(a.type),o=1;return[1,2,3,4].indexOf(r)>-1?o=r:5===r?o=a.width_value.div(e):6===r&&(o=a.height_value.div(t)),o}var i,s=bdpChart.ChartType,c=bdpChart.language;r.on("click",function(){e.mode=o.mode,e.setting=angular.fromJson(o.setting),"dashboard"===e.mode?i=r.parents(".chart-box").find(".chart").data("chart-data"):"fullscreen"===e.mode&&(i=r.parents(".control-pane").siblings(".fs-chart-main").find(".fullscreen-chart.active").data("chart-data")),e.chartType=i.info.chart_type,e.theme=i.theme,e.disableScale="C340"===e.chartType||"C400"===e.chartType,e.disableLabel="C400"===e.chartType,a.open({template:"/static/partials/dialogTemplates/export_img.html",className:"ngdialog-theme-default export-img-modal",scope:e,data:{type:"fullscreen"===e.mode?1:2,width_value:1024,height_value:1024,show_label:!0}})}),e.exportImg=function(a){function l(){var a=u,n="";if(t.global.dshWatermarkImg&&(n="dashboard"==e.mode&&2==t.usedThemeId||"fullscreen"==e.mode&&2==e.fullDisplayTheme?" url("+t.global.dshWatermarkImg+")":" url("+t.global.fullscreenWatermarkImg+")"),"dashboard"===e.mode?d=$(r).parents(".chart-box").find(".chart"):"fullscreen"===e.mode&&(d=$(r).parents(".fullscreen-modal").find(".fullscreen-chart")),-1=="C340,C400".indexOf(e.chartType))g*=m,_*=m;else if("C400".indexOf(e.chartType)>-1){var i=0;i=m>=2?bdpChart.helper.getPixelRatio(d.find("canvas")):m}"C400"===e.chartType?(a="transparent",p='<div style="position:relative;overflow:hidden;background:'+a+";width:"+g+"px;height:"+_+'px">'+p+'<div style="position:absolute;top:0;left:0;right:0;bottom:0;z-index:5;background:'+n+';"></div></div>'):p='<div style="position:relative;background:'+a+";width:"+g+"px;height:"+_+'px">'+p+'<div style="position:absolute;top:0;left:0;right:0;bottom:0;z-index:5;background:'+n+';"></div></div>',Highcharts.post("/api/chart/export_png",{filename:o.filename||"chart",type:"image/png",background:u,width:g,height:_,svg:p})}var h,d,u="#FFF";"dashboard"===e.mode?(d=$(r).parents(".chart-box").find(".chart"),1==window.usedThemeId&&(u="#24273E")):"fullscreen"===e.mode&&(d=$(r).parents(".fullscreen-modal").find(".fullscreen-chart"),1==e.fullDisplayTheme&&(u="#24273E"));var p,f="",g=d.find("svg").width(),_=d.find("svg").height(),m=n(g,_,a);if(["C300","C330","C360"].indexOf(e.chartType)>-1)a.show_label===!1&&"C330"===e.chartType?(d.find(".funnel-datalabels").css("display","none"),p=d.html(),d.find(".funnel-datalabels").css("display","")):a.show_label===!1&&"C360"===e.chartType?(d.find(".sunburst-labels").css("display","none"),p=d.html(),d.find(".sunburst-labels").css("display","")):p=d.html();else{if("C200 C310".indexOf(e.chartType)>-1)return void alert("zh"==c?"当前图表不支持导出图片":"The current chart couldn't export as images");if(["C340"].indexOf(e.chartType)>-1){var v=(navigator.userAgent,d.find("canvas")[0]),C=window.devicePixelRatio||1;g=v.width/C*m,_=v.height/C*m,m=n(g,_,a);var a=Canvas2Image.convertToPNG(v,g,_).src;p='<img src="'+a+'" width="'+g+' height="'+_+'" />'}else{if("C400"===e.chartType){var g=d.width(),_=d.height();m=n(g,_,a),g*=m,_*=m,f='<div style="font-size:32px;color:#000;text-align:center;line-height:3em;">'+o.filename+"</div>";var y=0;return y=m>=2?bdpChart.helper.getPixelRatio(d.find("canvas")):m,void i.gisMap.exportImage(m).then(function(e){e[0].style.zIndex=0,p=e[0].outerHTML,l()})}if(h=d.highcharts()){angular.forEach(h.options.yAxis,function(e){angular.forEach(e.plotLines,function(e){e.label&&(e.label.text="")})}),"C261"!==e.chartType||"C280"===e.chartType?e.chartType==s.BubbleMap||e.chartType==s.AreaMap?(h.options.series[1]&&(h.options.series[1].dataLabels={enabled:a.show_label}),h.options.legend={enabled:!1}):h.series.forEach(function(e,t){/^Navigator/.test(e.name)||(e.options.dataLabels.enabled=a.show_label,h.options.series[t].dataLabels?h.options.series[t].dataLabels.enabled=a.show_label:h.options.series[t].dataLabels={enabled:a.show_label})}):e.chartType==s.BubbleMap&&e.chartType==s.AreaMap&&(h.options.legend={enabled:!1});var w={chart:{borderRadius:0,backgroundColor:u,width:g,height:_,spacingTop:40}};"dashboard"===e.mode&&(e.setting.show_total||(w.title={text:""})),p=h.getSVG(Highcharts.merge(w))}}}l()}}}}]).directive("exportExcel",["$rootScope","commonService","ngDialog",function(e,t,a){return{restrict:"A",scope:!0,link:function(r,o,n){o.on("click",function(){var o,i=n.mode,s=n.charttype;"dashboard"===i?o=r.chartUrl:"fullscreen"===i&&(o=r.fullscreen.info);var c=bdpChart.helper.params(o.options.optional),l={ct_id:o.options.ct_id,dsh_id:o.options.dsh_id,access_token:$.cookie("token"),rule_id:o.options.rule_id||""};e.wsId&&(l.ws_id=e.wsId),r.fireOfflineTaskList=function(){e.fireOfflineTaskList=!e.fireOfflineTaskList},t.chart.exportExcelType(angular.extend(l,c)).then(function(o){0==o.status&&(1==o.result||"C300"==s||"C400"==s?Highcharts.post("/api/chart/export_excel",angular.extend(l,c)):2==o.result&&t.chart.exportLargeExcel(angular.extend(l,c)).then(function(){var t=e.language,o="en"==t?"ngDialog-width-400":"ngDialog-width-330";a.open({template:"/static/partials/dialogTemplates/export_large_tip.html",className:"ngdialog-theme-default "+o,scope:r})}))})})}}}]).directive("operateMore",["$rootScope","$window","$timeout","$http","commonService","ngDialog","$stateParams","commonHttp","errHint","$jsTipTranslate",function(e,t,a,r,o,n,i,s,c,l){return{restrict:"A",templateUrl:"/static/js/dashboard/tpl/chart_operate_more.html",replace:!0,scope:!0,link:function(t,r,h){function d(){return{grid_index:h.pIndex}}function u(e,t){var a=angular.copy(e);return angular.forEach(a,function(e){e.children[0].meta={ct_id:e.children[0].meta.ct_id,dash_setting:e.children[0].meta.dash_setting},t||delete e.children[0].meta.dash_setting}),a}function u(e,t){var a=angular.copy(e);return angular.forEach(a,function(e){e.children[0].meta={ct_id:e.children[0].meta.ct_id,dash_setting:e.children[0].meta.dash_setting},t||delete e.children[0].meta.dash_setting}),a}function p(){t.dashStandardItems.splice(d().grid_index,1),t.getDashboardInfo(t.dashSelected)}t.$on("fire-mouseleave-item-event",function(){t.more_show=!1}),t.$watch(h.chartUrl,function(e){e&&(t.chartUrl=e)}),t.del=function(){function r(){var r=angular.copy(t.dashStandardItems);r.splice(d().grid_index,1),o.chart.del({ct_id:c,ws_id:e.wsId,dsh_meta:{charts:u(r,!0)}}).success(function(e){"0"===e.status||"3211"===e.status?(t.dashStandardItems.splice(d().grid_index,1),a(function(){2==s.meta.chart_link.linked_chart_type&&t.getDashboardInfo(t.dashSelected)})):errorHandle(e)})}var i=t.dashStandardItems[d().grid_index],s=i.children[0],c=s.meta.ct_id;2==s.meta.chart_link.linked_chart_type?n.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:t.tips["chart.checkToContinueMove"]}}).then(function(){r()}):n.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:t.tips["chart.confirmDelChart"]+": "+s.meta.name+"?"}}).then(function(){r()})};var f=function(e){for(var a=t.copyChartData.project_list,r=0,o=a.length;o>r;r++)a[r].proj_id==t.copyChartData.projId&&(t.copyChartData.dash_list=a[r].dsh_list,"change"==e&&(t.copyChartData.dashId=a[r].dsh_list.length>0?a[r].dsh_list[0].dsh_id:""))},g=function(e){var a=t.dashStandardItems[d().grid_index],r=a.children[0];t.copyChartData={curProId:i.projId,curDshId:i.dashId,chartInfo:{chart_id:r.meta.ct_id,name:r.meta.name},projId:i.projId,dashId:i.dashId,project_list:e},n.open({template:"/static/partials/copy_chart_model.html",className:"ngdialog-theme-default ngDialog-width-360",scope:t}),f()};t.changeProject=function(){f("change")},t.copyChartSave=function(){t.global.clickComplete=!1;var e=t.copyChartData;e.dashId&&s.get("/api/chart/copy",{ct_id:e.chartInfo.chart_id,from:angular.toJson({proj_id:e.curProId,dsh_id:e.curDshId}),to:angular.toJson({proj_id:e.projId,dsh_id:e.dashId})}).then(function(e){if(0==e.status){c(t.tips["chart.copyChartSuccess"]),n.closeAll();var a=t.copyChartData;a.curProId==a.projId&&a.curDshId==a.dashId&&t.getDashboardInfo(a.curDshId)}t.global.clickComplete=!0})},t.copy_chart=function(){g(t.project_list)},t.move_chart=function(){_(t.project_list)};var _=function(e){t.global.clickComplete=defined(t.global.clickComplete)?t.global.clickComplete:!0;{var a=t.dashStandardItems[d().grid_index],r=a.children[0];r.meta.ct_id}t.moveChartData={curProId:i.projId,curDshId:i.dashId,chartInfo:{chart_id:r.meta.ct_id,name:r.meta.name},projId:i.projId,dashId:i.dashId,project_list:e},n.open({template:"/static/partials/move_chart_model.html",className:"ngdialog-theme-default ngDialog-width-360",scope:t});for(var o=t.moveChartData.project_list,s=0,c=o.length;c>s;s++)o[s].proj_id==t.moveChartData.projId&&(t.moveChartData.dash_list=o[s].dsh_list)};t.changeProjectForMove=function(){for(var e=t.moveChartData.project_list,a=0,r=e.length;r>a;a++)e[a].proj_id==t.moveChartData.projId&&(t.moveChartData.dash_list=e[a].dsh_list,t.moveChartData.dashId=e[a].dsh_list.length>0?e[a].dsh_list[0].dsh_id:"")},t.moveChartSave=function(){var e=t.moveChartData;if(t.global.clickComplete=!1,!e.dashId)return c(t.tips["template.selectDash"]),void(t.global.clickComplete=!0);if(e.curProId==e.projId&&e.curDshId==e.dashId)return c(t.tips["chart.selectOtherPlace"]),void(t.global.clickComplete=!0);var a=[].concat(t.dashStandardItems);a.splice(d().grid_index,1),s.post("/api/chart/move",{ct_id:e.chartInfo.chart_id,from:angular.toJson({proj_id:e.curProId,dsh_id:e.curDshId}),to:angular.toJson({proj_id:e.projId,dsh_id:e.dashId}),check:"do",dsh_meta:angular.toJson({charts:u(a,!0)})}).then(function(e){if(t.global.clickComplete=!0,e.result.ismoved)c(t.tips["chart.moveChartSuccess"]),n.closeAll(),p();else if(confirm(t.tips["chart.checkToContinueMove"])){var r=t.moveChartData;s.post("/api/chart/move",{ct_id:r.chartInfo.chart_id,from:angular.toJson({proj_id:r.curProId,dsh_id:r.curDshId}),to:angular.toJson({proj_id:r.projId,dsh_id:r.dashId}),check:"pass",dsh_meta:angular.toJson({charts:u(a,!0)})}).then(function(e){e.result.ismoved?(c(t.tips["chart.moveChartSuccess"]),n.closeAll(),p()):(c(t.tips["chart.moveChartFail"]),n.closeAll())})}})},l(["chart.copyChartSuccess","chart.confirmDelChart","template.selectDash","chart.selectOtherPlace","chart.checkToContinueMove","chart.moveChartSuccess","chart.moveChartFail"],t)},controller:["$scope",function(e){e.setOperatorPos=function(t){var a=$(t.currentTarget),r=angular.element("body").height();e.more_show=!e.more_show,a.find("ul").css(r-t.clientY<176?{bottom:24,top:"inherit"}:{top:24,bottom:"inherit"})}}]}}]).directive("shareDash",["ngDialog","$rootScope","commonService","errHint","$jsTipTranslate",function(e,t,a,r,o){return{restrict:"A",link:function(n,i,s){i.on("click",function(e){e.stopPropagation(),n.openShare(e)});var c=[],l=[],h=[],d=[],u=[],p=[],f=[],g=[],_=s.type,m=s.id,v={};n.shareView={select:{all_user:!1,all_group:!1},sharetab:"user"},n.commitData={},n.shareUserNum=0,n.shareGroupNum=0;var C=function(){n.commitData={share_user:[],cancel_user:[],share_group:[],cancel_group:[]},c=[],l=[],h=[],d=[],"dashboard"==_?(v.type=0,v.dsh_id=m):(v.type=1,v.proj_id=m),a.share.getList(v).success(function(e){0==e.status&&(n.userList=e.result,angular.forEach(n.userList.share_user,function(e){e.check=!0,c.push(e.user_id)}),angular.forEach(n.userList.other_user,function(e){e.check=!1,l.push(e.user_id)}),0==n.userList.other_user.length?(n.shareView.select.all_user=!0,n.shareView.select.user_check="all"):0==n.userList.share_user.length?(n.shareView.select.all_user=!1,n.shareView.select.user_check="uncheck"):(n.shareView.select.all_user=!1,n.shareView.select.user_check="uncheckall"),angular.forEach(n.userList.share_group,function(e){e.check=!0,h.push(e.user_id)}),angular.forEach(n.userList.other_group,function(e){e.check=!1,d.push(e.user_id)}),0==n.userList.other_group.length&&(n.shareView.select.all_group=!0),0==n.userList.other_group.length?(n.shareView.select.all_group=!0,n.shareView.select.group_check="all"):0==n.userList.share_group.length?(n.shareView.select.all_group=!1,n.shareView.select.group_check="uncheck"):(n.shareView.select.all_group=!1,n.shareView.select.group_check="uncheckall"),n.shareUserNum=c.length,n.shareGroupNum=h.length)})};n.openShare=function(){t.pageLoading=!0,n.jsonData={show_upload:!1},n.dialogInit=function(){t.pageLoading=!1},v={},e.open({template:"/static/partials/share_dashboard.html",className:"ngdialog-theme-default share-dashboard",scope:n}),C()},n.closeDialog=function(){e.closeAll()},n.checkFun=function(e){"user"==e?y():w()},n.checkAllFun=function(e){"user"==e?(n.shareView.select.all_user?(angular.forEach(n.userList.share_user,function(e){e.check=!0}),angular.forEach(n.userList.other_user,function(e){e.check=!0})):(angular.forEach(n.userList.share_user,function(e){e.check=!1}),angular.forEach(n.userList.other_user,function(e){e.check=!1})),y()):(n.shareView.select.all_group?(angular.forEach(n.userList.share_group,function(e){e.check=!0}),angular.forEach(n.userList.other_group,function(e){e.check=!0})):(angular.forEach(n.userList.share_group,function(e){e.check=!1}),angular.forEach(n.userList.other_group,function(e){e.check=!1})),w())},n.commitShare=function(){t.pageLoading||(t.pageLoading=!0,v.share_user=u.join(","),v.cancel_user=p.join(","),v.share_group=f.join(","),v.cancel_group=g.join(","),a.share.share(v).success(function(a){0==a.status&&(C(),n.commitData={share_user:[],cancel_user:[],share_group:[],cancel_group:[]},u=[],p=[],f=[],g=[]),r(n.tips["chart.saveSuccess"]),t.pageLoading=!1,e.closeAll()}))};var y=function(){u=[],p=[];var e=n.userList.share_user,t=n.userList.other_user,a=0;angular.forEach(e,function(e){e.check?a+=1:p.push(e.user_id)}),angular.forEach(t,function(e){e.check&&(u.push(e.user_id),a+=1)}),n.shareUserNum=a;var r=n.shareView.select;0==p.length&&u.length==t.length?(r.user_check="all",n.shareView.select.all_user=!0):0==u.length&&p.length==e.length?(r.user_check="uncheck",n.shareView.select.all_user=!1):(r.user_check="uncheckall",n.shareView.select.all_user=!1),n.commitData.share_user=u,n.commitData.cancel_user=p},w=function(){f=[],g=[];var e=n.userList.share_group,t=n.userList.other_group,a=0;angular.forEach(e,function(e){e.check?a+=1:g.push(e.group_id)}),angular.forEach(t,function(e){e.check&&(f.push(e.group_id),a+=1)}),n.shareGroupNum=a;var r=n.shareView.select;0==g.length&&f.length==t.length?(r.group_check="all",n.shareView.select.all_group=!0):0==f.length&&g.length==e.length?(r.group_check="uncheck",n.shareView.select.all_group=!1):(r.group_check="uncheckall",n.shareView.select.all_group=!1),n.commitData.share_group=f,n.commitData.cancel_group=g};o(["chart.saveSuccess"],n)},controller:angular.noop}}]);
;!function(){function e(e,i,o,n,t,a,s,r,l,d,u){function c(){function i(){var n="en"==$.cookie("locale")?"Try again":"重试";e.mobile_info.waitCodeTime=o--+"s "+n,0>=o?($("#getcode").removeAttr("disabled"),e.mobile_info.sending=!1,e.mobile_info.waitCodeTime=e.tips["user.getVerifyCode"],$("#phone_num").removeAttr("readonly")):($("#getcode").attr("disabled","disabled"),e.waiting=r(function(){i()},1e3))}var o=60;i()}function m(i){i=i||"",e.settingView.href=getMailHref(i),t.open({template:"/static/partials/dialogTemplates/send_email.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e})}i.log_unread=!1,i.noticeStore={},i.memberData={},e.init=function(){e.resetDashFilterCache(),e.closeBrowserLogout(),e.checkNeedMobileBind(),e.passwordWarn(),e.userSetting(),e.getUserInfo(),e.themeInit()},e.getUserInfo=function(){o.user.getUserInfo().then(function(o){if(0==o.status){var n=o.result;e.checkThemeChange(n.theme_id),1==n.should_complete_profile&&(location.href="/info.html");var t=n.role;i.master_role=t,i.share=1==t?1:n.security_info.share_inside_group,i.global.watterMark=n.security_info.watermark_strategy||n.auth_info.name,i.global.exportDataSetting=n.security_info.export_data_setting;var a;i.user_id=n.user_id,i.noticeStore={offlineTaskNewFile:n.has_new_file,showOfflineTip:n.show_export_notification},i.enterprise_type=a=n.enterprise_type?+n.enterprise_type:0,i.role_code=t,i.photo_id=n.photo_id,i.global.domain=n.domain,i.global.username=n.username,i.personalInfo={},i.securityStrategy={closeBrowserTokenFailure:n.security_info.close_browser_token_failure},3==i.enterprise_type&&(i.personalInfo=n.personal_info,i.memberData={vipLevel:n.personal_info.vip_level,lessDay:n.personal_info.less_day,vipDeadline:1e3*n.personal_info.vip_deadline,vipShowTip:"1"==$.cookie("vip_show_tip")?!0:!1},$.cookie("vip_show_tip",null),e.setZhLanguage());var s="";switch(t){case 1:s="data_admin";break;case 0:case 99:s="s_admin";break;case 3:s="user";break;case 2:s=1==n.account_permission?1==n.data_permission?"all_admin":"account_admin":1==n.data_permission?"data_admin":"";break;default:s="user"}i.role=s,userGuideFlags.reset(n.guide),3!=n.enterprise_type||i.guide||(1===userGuideFlags.get("origin")?userGuideFlags.set("origin",0):0===userGuideFlags.get("origin")&&userGuideFlags.set("tplLibrary",3),i.guide=userGuideFlags.get("origin")),3==n.enterprise_type&&(i.tplLibraryGuide=userGuideFlags.get("tplLibrary")),0==n.enterprise_type&&-1!=[0,2].indexOf(i.role_code)&&(i.db_enterprise_guide=userGuideFlags.get("origin")),(0==i.enterprise_type||3==i.enterprise_type)&&e.checkUnread();var r=i.workspaceList=n.workspace_list,l=["haizhi","renrenche","t6_admin","fangfang","lbx03","web","bdp_autotest","CZHB","kangda"],d=i.global.authInfoName=n.auth_info&&n.auth_info.name;i.permision={projEdit:1!=a&&4!=t&&5!=a&&6!=a,dashEdit:1!=a&&4!=t&&5!=a&&6!=a,dashOperate:1!=a&&4!=t&&5!=a&&6!=a,outerShare:3==a,innerShare:3!=a,subTpl:2!=a,sqlTable:3!=a,assignWorkTable:1!=a,navDashboard:!0,navWorktable:1!=a&&4!=t&&5!=a,navUser:3!=a&&5!=a&&6!=a&&!d,navDatabase:0==a||3==a||4==a||5===a||6===a,navTpl:(0==a||1==a||4==a)&&!d,navSecurity:(0==a||4==a)&&0==t,navWorkspace:(0==t||r&&(r.dash.length>0||r.worktable.length>0||r.template.length>0))&&$.inArray(i.global.domain,l)>=0&&!d,newLogShow:0==a,modifyPassword:2!=a,showRelationUser:3!=a,personalSetIcon:3==a,wranPush:3!=a,userEdit:2!=a,partner1:(1==a||4==a)&&"s_admin"===i.role,userLimitType:4==a||1==a?2:1,userShowOnlyReadOption:4!=a?!1:!0,userOnlyReadOption:1==a,showDeveloper:3!=a&&5!==a&&6!==a,isPartner:{shopex:5===a||6===a,shopexNeedInit:(5===a||6===a)&&0===n.is_init},baiduSearchIndustry:1===n.industry&&!d,tableImg:"wanli"==i.global.domain||"haizhi"==i.global.domain||"demo"==i.global.domain,sysSetting:!d,accountSetting:!d&&5!=a&&6!=a,allowExporting:!d,isAuthorized:!!d,isPersonal:3==a,isNormalUser:3==t,authorizedPrivilege:0==a,showAllSetting:!0,isSuperAdminInPersonal:"587595a4a8ed0d5cc3a22609cf816c21"===n.user_id},i.wsId&&angular.forEach(i.workspaceList.dash,function(e){e.ws_id==i.wsId&&(i.wsAdmin=e.admin)}),i.$watch("wsAdmin",function(e){i.permision.projEdit=void 0!==e?e:1!=a&&4!=t&&5!=a&&6!=a}),e.shopexSetTitle(a),e.runOnceAction&&(e.runOnceAction=!1,e.user=n,i.userInfoObj=n,i.is_extrace=n.is_extrace),e.getDomainForPartner()}})},e.userSetting=function(){e.runOnceAction=!0,e.accountInfoSetting=!1,e.userSystemSetting=!1,e.settingView={},e.hideOpt={editName:!0,modifyPassword:!0,newLogShow:!0},e.isBinding=0,e.mobile_info={orig_phone_num:"",phone_num:"",code:"",sending:!1,waitCodeTime:e.tips["user.getVerifyCode"]},e.verifyCodeErrorTooMuch=0,e.info={},e.info.old_pw="",e.info.new_pw="",e.info.confirm_pw="",e.info.pwdStrong="",e.info.err_hint="",e.info.hint_pwd="",e.current_language="en"==$.cookie("locale")?"English":"简体中文",e.select_language_flag="",e.pics=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],e.isDoubleClickTask=!0,e.offlineTaskData={page:1,totalPages:1,fileList:[],offlineFileName:null,offlineStatus:0},i.fireOfflineTaskList=!0,i.$watch("fireOfflineTaskList",function(i,o){i!=o&&e.showOfflineTask()});var o="_websocketChartMessage_";e.$on(o,function(o,n){var t="string"==typeof n.data?$.parseJSON(n.data):n.data;2==t.type&&(e.offlineTaskData.offlineFileName=t.filename,i.noticeStore.showOfflineTip=!0,i.noticeStore.offlineTaskNewFile=!0,e.offlineTaskData.offlineStatus=t.status)}),e.generatedCoordinateList={success:[],failed:[]},e.$on(o,function(i,o){if(8==o.data.type){if(1==o.data.status){var n={tb_name:o.data.name,tb_id:o.data.tb_id};e.generatedCoordinateList.success.push(n)}else if(2==o.data.status){var n={tb_name:o.data.name,tb_id:o.data.tb_id};e.generatedCoordinateList.failed.push(n)}e.$apply()}}),e.user={},i.userInfoObj={}},e.getDomainForPartner=function(){$.cookie("partner_login",""),i.userInfoObj.is_personalized?($.cookie("domain")||$.cookie("domain",e.userInfoObj.domain,{expire:31536e4,path:"/"}),$.cookie("partner_login",e.userInfoObj.domain),i.userInfoObj.partnerLogoSrc="/api/domain/download_image?domain="+e.userInfoObj.domain,angular.element("#logo").children("a.logo-link").removeAttr("href")):angular.element("#logo").children("a.logo-link").addClass("bdp-logo")},e.showNotificationSetting=function(){var i="/static/partials/dialogTemplates/notification_setting.html",o=e.user.push_setting||{warn:{app:1,email:0}};e.warnNotificationSetting=[{type:e.tips["user.pushSettingApp"],checked:o.warn.app>0},{type:e.tips["user.pushSettingEmail"],checked:o.warn.email>0,hint:e.user.email?void 0:e.tips["user.emailUnbind"]}],e.notificationSettingDialog=t.open({template:i,className:"ngdialog-theme-default ngDialog-width-330",scope:e})},e.saveNotificationSetting=function(){var i={warn:{app:e.warnNotificationSetting[0].checked?1:0,email:e.warnNotificationSetting[1].checked?1:0}};o.user.modifyInfo({push_setting:JSON.stringify(i)}).then(function(o){0==o.status?(e.user.push_setting=i,a(e.tips["user.saveSuccess"]),e.notificationSettingDialog.close()):a(o.errstr)})},e.checkThemeChange=function(e){if(i.usedThemeId!=e){window.usedThemeId=i.usedThemeId=e,$.cookie(window.BDPThemes.bdpThemeIdCookieName,i.usedThemeId);for(var o=window.BDPThemes.themes,n=$("#"+window.BDPThemes.themeLinkCssId),t=o.length-1;t>=0;t--)i.usedThemeId==o[t].id&&n.attr("href",o[t].fileUrl)}},e.resetDashFilterCache=function(){window.localStorage.setItem("global_filter_memory",angular.toJson([]))},e.closeBrowserLogout=function(){if(window.localStorage.getItem("latestLeaveTime")>0){var e=10,n=(new Date).getTime(),t=parseInt(window.localStorage.getItem("latestLeaveTime")),a=Math.max(Math.abs(e-Math.ceil((n-t)/1e3)),0);if(a>=e){var s={access_token:$.cookie("token")};o.user.logout(s).then(function(){if($.cookie("token","",{expires:-1,path:"/"}),$.cookie("master_role","",{expires:-1,path:"/"}),$.cookie("is_weak","",{expires:-1}),5==i.enterprise_type||6==i.enterprise_type)return window.location.href="http://yunqi.shopex.cn/",!1;if(window.localStorage.setItem("latestLeaveTime",0),i.userInfoObj.is_personalized){var e=i.userInfoObj.domain;window.location.href="https://"+e+".bdp.cn"}else window.location.href$window.location.href="/login.html"})}}else window.localStorage.setItem("latestLeaveTime",0)},e.checkUnread=function(){o.user.unreadNewFeatures().then(function(e){0==e.status&&(i.log_unread=0===e.result.status)})},e.setZhLanguage=function(){var e="zh";i.language=e,s.use(e)},e.shopexSetTitle=function(e){(5==e||6==e)&&(angular.element("title").html("生意罗盘"),angular.element("#J_favicon_ico").attr("href","./static/images/shopex_favicon.ico"))},e.getCapacity=function(){o.user.getUserInfo().then(function(e){if(0==e.status&&3==i.enterprise_type){var o=e.result;i.personalInfo.capacity_info=o.personal_info.capacity_info}})},e.routeTo=function(e){l.path(e)},e.checkNeedMobileBind=function(){1==$.cookie("need_mobile_bind")&&t.open({template:"/static/partials/dialogTemplates/telephone_warn.html",className:"ngdialog-theme-default ngdialog-width-348",scope:e,showClose:!1,preCloseCallback:function(){i.mobileBinding=1,e.$$phase||e.$apply()}})},e.doBindingNow=function(){t.closeAll(),i.mobileBinding=1,e.accountInfoSetting=!0,e.editPhoneNumber()},e.passwordWarn=function(){var i=Number($.cookie("is_weak")),o=$.cookie("is_weak_hint");i&&!o&&1!=$.cookie("need_mobile_bind")&&(t.open({template:"/static/partials/dialogTemplates/password_warn.html",className:"ngdialog-theme-default passwordWarn",scope:e,data:{}}),$.cookie("is_weak_hint","1",{expires:1}))},e.modifyNow=function(){t.closeAll(),e.editPassword()},e.$on("getUserInfo",function(){e.getUserInfo()}),e.$on("getCapacity",function(){e.getCapacity()}),e.goWarnList=function(){d.params.wsId?i.click_show_view("warn",{wsId:d.params.wsId}):i.click_show_view("warn"),i.global.rule_id=""},e.cancelUserName=function(){o.user.getUserInfo().then(function(i){0==i.status&&(e.user.contact=i.result.contact,t.closeAll())})},e.editPhoneNumber=function(){e.session_id=bdp.utils.getSessionId();var i="/static/partials/dialogTemplates/edit_phone.html";t.open({template:i,className:"ngdialog-theme-default ngDialog-width-300",showClose:!1,scope:e,data:{isBindingNew:$.cookie("need_mobile_bind")}}),e.phoneEditing=!0,e.isBinding=e.user.mobile?2:1,e.mobile_info={orig_phone_num:"",phone_num:"",code:"",sending:!1,session_id:e.session_id,pic_verify_code:"",waitCodeTime:e.tips["user.getVerifyCode"]},$("#phone_num").removeAttr("readonly")},e.cancelPhone=function(){e.phoneEditing=!1,e.isBinding=0;var i=e.mobile_info.sending,o=e.mobile_info.waitCodeTime;e.mobile_info={orig_phone_num:"",phone_num:"",code:"",sending:i,waitCodeTime:o},$("#phone_num").removeAttr("readonly"),t.closeAll()},e.getMobileCode=function(){var n={usage:0,orig_phone_num:"",phone_num:""};if(!e.mobile_info.sending){if(1==e.isBinding){if(""==e.mobile_info.phone_num)return void a(e.tips["user.inputPhoneNumber"]);if(!verifyHandle.mobile(e.mobile_info.phone_num))return void a(e.tips["user.phoneNumberFormatError"]);n.usage=1,n.phone_num=e.mobile_info.phone_num}else{if(""==e.mobile_info.orig_phone_num)return void a(e.tips["user.inputOrigPhoneNumber"]);if(!verifyHandle.mobile(e.mobile_info.orig_phone_num))return void a(e.tips["user.phoneNumberFormatError"]);if(""==e.mobile_info.phone_num)return void a(e.tips["user.inputNewPhoneNumber"]);if(!verifyHandle.mobile(e.mobile_info.phone_num))return void a(e.tips["user.phoneNumberFormatError"]);e.mobile_info.orig_phone_num==e.mobile_info.phone_num,n.usage=2,n.orig_phone_num=e.mobile_info.orig_phone_num,n.phone_num=e.mobile_info.phone_num}if(!e.mobile_info.pic_verify_code)return void a(e.tips["user.inputPicVerifyCode"]);n.verify_code=e.mobile_info.pic_verify_code,n.session_id=e.mobile_info.session_id,e.mobile_info.sending=!0,$("#getcode").attr("disabled","disabled"),o.user.getMobileCode(n).then(function(o){if(0!=o.status){e.$broadcast("changeCode","change"),e.mobile_info.sending=!1,$("#getcode").removeAttr("disabled");var n=Number(o.status),t="",s=i.language;switch(n){case 1020:t="en"==s?"Phone number has been bound":"该账号已绑定手机";break;case 1021:t="en"==s?"The phone number has not been bound":"手机未绑定";break;case 1022:t="en"==s?"Original phone number is wrong":"原手机号错误";break;case 1023:t="en"==s?"The phone number is already bound by another account":"手机号已被其他账号绑定";break;case 1024:t="en"==s?"Get code failed":"发送验证码失败";break;case 1025:t="en"==s?"Get frequently, please try again after 24 hours":"获取频繁，请24小时后再试";break;case 1026:t="en"==s?"You can only get a code three times an hour, please try again later":"一小时内只可获取三次验证码，请稍后再试";break;case 23023:t="en"==s?"The account exits":"该账号已存在",e.show=!0;break;case 23003:t="en"==s?"The account does not exit":"该账号不存在",e.show=!0;break;case 11:t="en"==s?"Parameters error":"参数错误";break;case 1018:t="en"==s?"Verification code error":"验证码错误";break;case 23006:case 23016:t="en"==s?"Get frequently, please try again after 24 hours":"获取频繁。请24小时后再试";break;default:t="en"==s?"Send failed":"发送失败"}a(t)}else e.mobile_info.sending=!0,e.verifyCodeErrorTooMuch=0,$("#phone_num").attr("readonly","readonly"),c()})}},e.saveNewPhoneNumber=function(){if(""==e.mobile_info.phone_num)return void a(e.tips["user.inputPhoneNumber"]);if(""==e.mobile_info.pic_verify_code)return void a(e.tips["user.inputPicVerifyCode"]);if(""==e.mobile_info.code)return void a(e.tips["user.inputVerifyCode"]);if(e.verifyCodeErrorTooMuch)return a(e.tips["user.errorAndGetAgain"]),void(e.mobile_info.code="");var o={usage:1,verify_code:e.mobile_info.code};o.usage=1==e.isBinding?1:2,u.post("/api/user/verify_captcha",o).success(function(o){0==o.status?(a(e.tips["user.phoneNumHasBound"]),$(".nav-function").css("display","block"),$.cookie("need_mobile_bind",0),e.phoneEditing=!1,e.isBinding=0,e.user.mobile=e.mobile_info.phone_num.substr(0,3)+"****"+e.mobile_info.phone_num.substr(7),e.mobile_info={orig_phone_num:"",phone_num:"",code:"",sending:!1,waitCodeTime:e.tips["user.getVerifyCode"]},r.cancel(e.waiting),$("#phone_num").removeAttr("readonly"),e.hideOpt={editName:!0,modifyPassword:!0,newLogShow:!0},i.needMobileBind&&(location.href="/index.html",i.needMobileBind=!1),t.closeAll()):1017==o.status?(a(e.tips["user.errorAndGetAgain"]),e.verifyCodeErrorTooMuch=1,e.mobile_info.code=""):a(1018==o.status?e.tips["user.verifyCodeError"]:e.tips["user.sendFailed"])})},e.savePhoneNumber=function(){if(""==e.mobile_info.orig_phone_num)return void a(e.tips["user.inputOrigPhoneNumber"]);if(""==e.mobile_info.phone_num)return void a(e.tips["user.inputNewPhoneNumber"]);if(""==e.mobile_info.pic_verify_code)return void a(e.tips["user.inputPicVerifyCode"]);if(""==e.mobile_info.code)return void a(e.tips["user.inputVerifyCode"]);if(e.verifyCodeErrorTooMuch)return a(e.tips["user.errorAndGetAgain"]),void(e.mobile_info.code="");var i={usage:2,verify_code:e.mobile_info.code};i.usage=1==e.isBinding?1:2,u.post("/api/user/verify_captcha",i).success(function(i){0==i.status?(a(e.tips["user.numberHasChanged"]),e.phoneEditing=!1,e.isBinding=0,e.user.mobile=e.mobile_info.phone_num.substr(0,3)+"****"+e.mobile_info.phone_num.substr(7),e.mobile_info={orig_phone_num:"",phone_num:"",code:"",sending:!1,waitCodeTime:e.tips["user.getVerifyCode"]},r.cancel(e.waiting),$("#phone_num").removeAttr("readonly"),t.closeAll()):1017==i.status?(a(e.tips["user.errorAndGetAgain"]),e.verifyCodeErrorTooMuch=1,e.mobile_info.code=""):a(1018==i.status?e.tips["user.verifyCodeError"]:e.tips["user.sendFailed"])})},e.checkPwd=function(){e.info.err_hint="";var i=e.info.new_pw;if(!i)return e.info.pwdStrong="empty",void(e.info.hint_pwd="");var o,n;switch(o=e.info.pwdStrong=verifyHandle.pwdStrong(i)){case"weaker":n="低";break;case"weak":n="中";break;case"strong":n="高"}e.info.hint_pwd=n},e.modifyPassword=function(){var i=e.info.new_pw,n=e.info.old_pw;return n?i?i!==e.info.confirm_pw?(a("两次密码不一致!"),!1):void(verifyHandle.password(i)?a("密码强度过低，请重新输入包含字母与数字的并且长度不小于8位的密码"):o.user.modifyPassword({old_password:n,new_password:i,access_token:$.cookie("token")}).then(function(e){0==e.status&&($.cookie("is_weak",0),$.cookie("is_weak_hint",0),a("修改密码成功"),o.user.logout().then(function(){window.location.href=bdp.bdpLogin.checkPartnerLogin()}))})):void a("请输入新密码"):void a("请输入旧密码")},e.readNewFeatures=function(){o.user.readNewFeatures().then(function(e){0==e.status&&(i.log_unread=!1)})},e.editPassword=function(){t.open({template:"/static/partials/dialogTemplates/edit_password.html",className:"ngdialog-theme-default ngDialog-width-330",scope:e})},e.personalMemberInfo=function(){e.memberOrderHistory={vipLevel:i.memberData.vipLevel,vipDeadline:i.memberData.vipDeadline,orderList:[]},o.pay.personalOrderHistory().then(function(i){0==i.status&&(e.memberOrderHistory.orderList=i.result.order_list,e.memberOrderHistory.vipLevel=i.result.cur_vip_info.vip_level,e.memberOrderHistory.vipDeadline=i.result.cur_vip_info.vip_deadline,t.open({template:"/static/pay/member/view/member_info.html",className:"ngdialog-theme-default ngDialog-width-350",scope:e}))})},e.changeLanguage=function(o){i.language=o,window.locale=o,"zh"==o?(e.current_language="简体中文",s.use(o)):"en"==o&&(e.current_language="English",s.use(o))},e.modifyPic=function(){var i="/static/partials/dialogTemplates/modify_head_pic.html";e.user.pic=e.user.photo_id,t.open({template:i,className:"ngdialog-theme-default ngDialog-width-330",scope:e})},e.savePic=function(){var n=e.user.pic;o.user.modifyPersonal({photo_id:n}).then(function(o){0==o.status&&(i.photo_id=e.user.photo_id=n,t.closeAll())})},e.editUsername=function(){t.open({template:"/static/partials/dialogTemplates/edit_username.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e})},e.saveUsername=function(){var n=e.user.contact;if(0==n.length)return void a(e.tips["user.nameCanNotNull"]);var s=i.permision.isPersonal,r=s?o.user.modifyPersonal:o.user.modifyInfo;r({contact:n}).then(function(o){(0==o.status||!i.permision.personalSetIcon&&23008==o.status)&&(e.user.contact=n,a(e.tips["user.saveSuccess"]),t.closeAll())})},e.modifyEmail=function(){var i="/static/partials/dialogTemplates/modify_email.html";e.user.old_email="",e.user.new_email="",e.modifyEmailDialog=t.open({template:i,className:"ngdialog-theme-default ngDialog-width-330",scope:e})};var p=!1;e.saveEmail=function(){if(!p){var n=e.user,t=i.permision.isPersonal;if(n.email&&!n.old_email&&t)return void a("请输入原邮箱");if(n.email&&!verifyHandle.email(n.old_email)&&t)return void a("原邮箱格式错误");if(!n.new_email)return void a("请输入新邮箱");if(!verifyHandle.email(n.new_email))return void a("新邮箱格式错误");p=!0,t?o.user.modifyPersonal({old_email:n.old_email||"",email:n.new_email}).then(function(i){0==i.status&&(e.modifyEmailDialog.close(),m(n.new_email)),p=!1}):n.new_email!=n.email?o.user.modifyInfo({email:n.new_email}).then(function(i){0==i.status?(e.modifyEmailDialog.close(),e.user.email=n.new_email,a(e.tips["user.saveSuccess"])):1035==i.status&&a(e.tips["user.emailExist"]),p=!1}):(e.modifyEmailDialog.close(),p=!1)}},e.showOfflineTask=function(){e.isDoubleClickTask&&(e.isDoubleClickTask=!1,i.noticeStore.offlineTaskNewFile=!1,o.user.exportFileList().then(function(i){e.isDoubleClickTask=!0,0==i.status&&(e.offlineTaskData.fileList=i.result.files,e.offlineTaskData.totalPages=i.result.total_pages,e.offlineTaskData.page=i.result.page,t.open({template:"/static/partials/dialogTemplates/export_large_data.html",className:"ngdialog-theme-default ngDialog-width-844",scope:e}))}))},e.offlineFileListPage=function(i){var n={};i>0&&i<=e.offlineTaskData.totalPages&&(n={page:i},o.user.exportFileList(n).then(function(i){0==i.status&&(e.offlineTaskData.fileList=i.result.files,e.offlineTaskData.totalPages=i.result.total_pages,e.offlineTaskData.page=i.result.page)}))},e.hideOfflineTipAction=function(){i.noticeStore.showOfflineTip&&(o.user.hideNotification().then(function(){}),i.noticeStore.showOfflineTip=!1)},e.checkTableDetail=function(o){e.generatedCoordinateList.success=e.generatedCoordinateList.success.filter(function(e){return e.tb_id!=o}),e.generatedCoordinateList.failed=e.generatedCoordinateList.failed.filter(function(e){return e.tb_id!=o}),$.cookie("ds_tb_id",o),i.wsId?d.go("data_source_ws",{wsId:i.wsId},{reload:!0}):d.go("data_source",{},{reload:!0})},e.closeGeneratedTip=function(){e.generatedCoordinateList={success:[],failed:[]}},e.themeInit=function(){function o(){s(n).then(function(i){for(var o=0,n=e.themes.length;n>o;o++)1==e.themes[o].id&&(e.themes[o].name=i["theme.StarryBlue"]),2==e.themes[o].id&&(e.themes[o].name=i["theme.ElegantWhite"])})}e.themes=angular.copy(window.BDPThemes.themes);var n=["theme.StarryBlue","theme.ElegantWhite"];i.$on("$translateChangeSuccess",o)},e.changeSelectedTheme=function(n){if(n!=window.usedThemeId){var t=$("#"+window.BDPThemes.themeLinkCssId);i.themeChangeFlag=!1;for(var a=e.themes.length-1;a>=0;a--)e.themes[a].id==n&&(t.attr("href",e.themes[a].fileUrl),o.global_config.themeModify(n).then(function(e){0==e.status&&(i.themeChangeFlag=!i.themeChangeFlag,window.usedThemeId=i.usedThemeId=n,$.cookie(window.BDPThemes.bdpThemeIdCookieName,n))}))}},e.hideUserSystemSetting=function(){e.userSystemSetting=!1},n(["user.nameCanNotNull","user.saveSuccess","user.saveFailed","user.sendFailed","user.inputPhoneNumber","user.verifyCodeError","user.errorAndGetAgain","user.nameCanNotTooLog","user.numberHasChanged","user.inputOrigPhoneNumber","user.inputNewPhoneNumber","user.phoneNumberFormatError","user.inputVerifyCode","user.inputPicVerifyCode","user.phoneNumHasBound","user.verifyCodeError","user.nameInvalid","user.getVerifyCode","user.pushSettingApp","user.pushSettingEmail","user.emailUnbind"],e),e.init()}function i(e,i,o,n,t,a){function s(){u.commpleted=!1,o.post("/api/partner/upgrade",{update_type:d.updateType,activation:d.code}).then(function(e){u.commpleted=!0,0==e.status&&(r(e.result),i.$emit("userInfoChange","change"))})}function r(e){a.open({template:"/static/partials/dialogTemplates/upgradeAccountInfo.html",className:"ngdialog-theme-default ngDialog-width-355",scope:i,data:{allPremission:e.used_all_permission,onlyRead:e.used_only_read,onlyReadLimit:e.staff_limit-e.all_permission,allLimit:e.all_permission,failureTime:e.failure_time.split(" ")[0],enterprise_type:e.enterprise_type}})}e.view="upgrade",e.show_bdp_header=!1;var l=e.language||"zh";i.upgradeData={},i.view={};var d=i.upgradeData,u=i.view;u.activated=!1,u.commpleted=!1,i.verifyCode=function(){var e=d.activationCode;return e?void o.post("/api/partner/code_verity",{invitation_code:e}).then(function(i){0==i.status?(d.type=i.result.type,d.updateType=3==d.type?1:2,d.code=e):d.type=null,u.activated=!0}):(t("zh"===l?"激活码不能为空":"Activation code couldn't be empty"),n(function(){u.activated=!0},0),!1)},i.upgrade=function(){u.commpleted=!0,s()}}var o=angular.module("mainNav",[]);o.directive("toggleImg",[function(){return{restrict:"A",replace:!0,scope:{sessionid:"="},template:'<img ng-src="{{url}}" class="cursor-pointer vt-img" ng-click="toggleImg()"/>',controller:["$scope","$http",function(e){e.url="/api/register/pic?session_id="+e.sessionid,e.toggleImg=function(){e.url="/api/register/pic?session_id="+e.sessionid+"&t="+(new Date).getTime()},e.$on("changeCode",function(){e.toggleImg()})}]}}]),o.controller("mainNavCtrl",e),e.$inject=["$scope","$rootScope","commonService","$jsTipTranslate","ngDialog","errHint","$translate","$timeout","$location","$state","$http"],o.controller("partnerUpgradeController",i),i.$inject=["$rootScope","$scope","commonHttp","$timeout","errHint","ngDialog","$location"]}();
;!function(){angular.module("BC.directives").constant("formulaDocument",{SUM:{usage:"SUM(表达式/数值字段)",description:"返回表达式或数值字段所有值的合计，只适用于数值字段，空值不会计算",example:'SUM(销售额)，返回"销售额"字段对应的所有非空值的总和',type:"SUM",aggregate:1},AVG:{usage:"AVG(表达式/数值字段)",description:"返回表达式或数值字段所有值的平均值，只适用于数值字段，空值不会计算",example:'AVG(销售额)，返回"销售额"字段对应的所有非空值的平均值',type:"AVG",aggregate:1},MAX:{usage:"MAX(表达式/数值字段)",description:"返回表达式或数值字段中的最大值，只适用于数值字段",example:'MAX(销售额)，返回"销售额"字段对应值的最大值',type:"MAX",aggregate:1},MIN:{usage:"MIN(表达式/数值字段)",description:"返回表达式或数值字段中的最小值，只适用于数值字段",example:'MIN(销售额)，返回"销售额"字段对应值的最小值',type:"MIN",aggregate:1},COUNT:{usage:"COUNT(表达式/字段)",description:"返回表达式所有有效字段的数据条目数，空值不会计算",example:'COUNT(销售额)，返回"销售额"字段对应的所有非空值的数据条目数',type:"COUNT",aggregate:1},COUNT_DISTINCT:{usage:"COUNT(DISTINCT(表达式/字段))",description:"去重计数，返回表达式所有有效字段的不同数据条目数，空值不会计算",example:'COUNT(DISTINCT(销售额))，返回"销售额"字段对应的所有非空值的不同数据条目数',type:"COUNT_DISTINCT",aggregate:1},ROUND:{usage:"ROUND(表达式／数值字段,自然数)",description:"按指定的位数对数值进行四舍五入",example:"ROUND([销售额],1) 将销售额四舍五入至小数点后一位",type:"ROUND",aggregate:0},FLOOR:{usage:"FLOOR(表达式／数值字段)",description:"对指定数值向下取整数",example:"FLOOR([销售额]) 将销售额向下取整数",type:"FLOOR",aggregate:0},CEIL:{usage:"CEIL(表达式／数值字段)",description:"对指定数值向上取整数",example:"CEIL([销售额]) 将销售额向下取整数",type:"CEIL",aggregate:0},ABS:{usage:"ABS（表达式／数值字段）",description:"对指定数值取绝对值",example:"ABS(利润)取利润的绝对值",type:"ABS",aggregate:0},PMOD:{usage:"PMOD(表达式1／数值字段1,表达式2／数值字段2)",description:"取数值1除数值2的余数的绝对值",example:"PMOD([销售额],[员工数])取销售额除员工数的的余数的绝对值",type:"PMOD",aggregate:0},UNIX_TIMESTAMP:{usage:"UNIX_TIMESTAMP(日期字段)",description:"返回‘1970-01-01 00:00:00’到日期字段的秒数",example:"UNIX_TIMESTAMP([数据获取日期])，返回‘1970-01-01 00:00:00’到[数据获取日期]的秒数",type:"UNIX_TIMESTAMP",aggregate:0},ROW_MAX:{usage:"ROW_MAX(表达式1/字段1,表达式2/字段2……)",description:"对比同行中各列的值，返回值最大的，可传入2～8个数值型参数",example:"ROW_MAX([部门1销售额],[部门2销售额])，返回该行中部门1销售额与部门1销售额两个字段中的最大值",type:"ROW_MAX",aggregate:0},ROW_MIN:{usage:"ROW_MIN(表达式1/字段1,表达式2/字段2……)",description:"对比同行中各列的值，返回值最小的，可传入2～8个数值型参数",example:"ROW_MIN([部门1销售额],[部门2销售额],345)，返回该行中部门1销售额、部门1销售额两个字段以及值345中的最大值",type:"ROW_MIN",aggregate:0},MAX_DATE:{type:"MAX_DATE",usage:"MAX_DATE(日期字段)",description:"返回该字段所有日期数据中最大值",example:"MAX_DATE([登陆时间])，返回该字段中最大的日期",aggregate:1},MIN_DATE:{type:"MIN_DATE",usage:"MIN_DATE(日期字段)",description:"返回该字段所有日期数据中最小值",example:"MIN_DATE([登陆时间])，返回该字段中离当前时间最远的日期",aggregate:1},HOUR_DIFF:{type:"HOUR_DIFF",usage:"HOUR_DIFF(日期字段1，日期字段2)",description:"返回两个日期相差的小时数，只允许传入日期型字段",example:"HOUR_DIFF([登陆时间],[离线时间] )，返回同一行上“登陆时间”至“离线时间”间隔小时数",aggregate:0},MINUTE_DIFF:{type:"MINUTE_DIFF",usage:"MINUTE_DIFF(日期字段1，日期字段2)",description:"返回两个日期相差的分钟数，只允许传入日期型字段",example:"MINUTE_DIFF([登陆时间],[离线时间] )，返回同一行上“登陆时间”至“离线时间”间隔分钟数",aggregate:0},SECOND_DIFF:{type:"SECOND_DIFF",usage:"SECOND_DIFF(日期字段1，日期字段2)",description:"返回两个日期相差的秒钟数，只允许传入日期型字段",example:"SECOND_DIFF([登陆时间],[离线时间] )，返回同一行上“登陆时间”至“离线时间”间隔秒钟数",aggregate:0},DAY_DIFF:{usage:"DAY_DIFF(日期字段1,日期字段2)",description:"返回两个日期相差的天数，只允许传入日期型字段",example:'DAY_DIFF([离职日期],[入职日期] )，返回同一行上"离职日期"至"入职日期"间隔天数',type:"DAY_DIFF",aggregate:0},MONTH_DIFF:{usage:"MONTH_DIFF(日期字段1,日期字段2)",description:"返回两个日期相差的月数，只允许传入日期型字段",example:'MONTH_DIFF([离职日期],[入职日期] )，返回同一行上"离职日期"至"入职日期"间隔月数',type:"MONTH_DIFF",aggregate:0},YEAR_DIFF:{usage:"YEAR_DIFF(日期字段1,日期字段2)",description:"返回两个日期相差的年数，只允许传入日期型字段",example:'YEAR_DIFF([离职日期],[入职日期] )，返回同一行上"离职日期"至"入职日期"间隔年数',type:"YEAR_DIFF",aggregate:0},WEEK:{usage:"WEEK(日期字段)",description:"返回该日期在当年的第几周，只允许传入日期型字段",example:"WEEK([入职日期])，返回入职日期为该年的第几周",type:"WEEK",aggregate:0},QUARTER:{usage:"QUARTER(日期字段)",description:"返回该日期在当年的第几个季度，只允许传入日期型字段",example:"QUARTER([入职日期])，返回入职日期为该年的第几个季度",type:"QUARTER",aggregate:0},NOW:{usage:"NOW()",description:"返回当前系统时间，无需参数",type:"NOW",aggregate:0},FIRST_DAY_OF_MONTH:{usage:"FIRST_DAY_OF_MONTH(表达式1/字段1,表达式2/字段2)",description:"返回某月第一天，函数参数为数值型字段，依次代表年，月",example:'FIRST_DAY_OF_MONTH(2015,1)，返回"2015年1月1日 00:00:00"',type:"FIRST_DAY_OF_MONTH",aggregate:0},LAST_DAY_OF_MONTH:{usage:"LAST_DAY_OF_MONTH(表达式1/字段1,表达式2/字段2)",description:"返回某月最后一天，函数参数为数值型字段，依次代表年，月",example:'LAST_DAY_OF_MONTH(2015,1)，返回"2015年1月31日 00:00:00"',type:"LAST_DAY_OF_MONTH",aggregate:0},WORK_DAY_OF_MONTH:{usage:"WORK_DAY_OF_MONTH(表达式1/字段1,表达式2/字段2)",description:"返回某月工作天数，函数参数为数值型字段，依次代表年，月",example:"WORK_DAY_OF_MONTH(2015,1)，返回2015年1月工作日天数",type:"WORK_DAY_OF_MONTH"},DAY_OF_WEEK:{usage:"DAY_OF_WEEK(日期字段)",description:"返回该日期对应该周的天数",example:"DAY_OF_WEEK([下单时间])",type:"DAY_OF_WEEK",aggregate:0},IF:{usage:"IF(表达式，结果1，结果2)",description:'IF为判断函数，表达式为比较型或计算型语句。若表达式的计算结果正确，则返回"结果1"，否则，返回"结果2"',example:'IF([订单数]  > 500, "合格", "不合格")。结果为若该行"订单数"字段对应值大于500，则返回"合格"，否则返回"不合格"',type:"IF",aggregate:0},YEAR:{usage:"YEAR(日期字段)",description:"返回该日期对应的年份。只允许传入日期型字段",example:'YEAR([下单时间])，返回该行"下单时间"字段对应的年份',type:"YEAR",aggregate:0},MONTH:{usage:"MONTH(日期字段)",description:"返回该日期对应的月份。只允许传入日期型字段",example:'MONTH([下单时间])，返回该行"下单时间"字段对应的年份',type:"MONTH",aggregate:0},DAY:{usage:"DAY(日期字段)",description:"返回该日期对应的日的值。只允许传入日期型字段",example:'DAY([下单时间])，返回该行"下单时间"字段对应的日的值',type:"DAY",aggregate:0},HOUR:{usage:"HOUR(日期字段)",description:"返回该日期对应的小时的值。只允许传入日期型字段",example:'HOUR([下单时间])，返回该行"下单时间"字段对应的小时的值',type:"HOUR",aggregate:0},MINUTE:{usage:"MINUTE([时间字段])",description:"返回该日期对应的分钟的值。只允许传入日期型字段",example:"MINUTE([下单时间])，返回该行下单时间字段对应的分钟的值",type:"MINUTE",aggregate:0},SECOND:{usage:"SECOND([时间字段])",description:"返回该日期对应的秒的值。只允许传入日期型字段",example:"SECOND([下单时间])，返回该行下单时间字段对应的秒的值",type:"SECOND",aggregate:0},TO_DATE:{type:"TO_DATE",usage:"TO_DATE(日期字段)",description:"返回日期字段的年月日部分",example:"TO_DATE([入库日期])，返回入库日期的年月日时间",aggregate:0},DATE_ADD:{type:"DATE_ADD",usage:"DATE_ADD(起始日期, 数值字段)",description:"返回从起始日期算起，数值字段对应天数之后的日期",example:"DATE_ADD([入库日期], 1)，返回货品入库第二天的日期",aggregate:0},DATE_SUB:{type:"DATE_SUB",usage:"DATE_SUB(起始日期, 数值字段)",description:"返回从起始日期算起，数值字段对应天数之前的日期",example:"DATE_SUB([出库日期], 1)，返回货品出库前一天的日期",aggregate:0},CONCAT:{type:"CONCAT",usage:"CONCAT(字段1, 字段2...)",description:"返回顺序联结各参数的字符串",example:"CONCAT([货品编号], [类型编号])，返回货品编号和类型编号联结后的字符串",aggregate:0},INSTRING:{type:"INSTRING",usage:"INSTRING(字符串1, 字符串2[, 起始位置])",description:"返回字符串2在字符串1的起始位置后第一次出现时的位置，其中起始位置可选",example:'INSTRING([名字],"尔”)，返回“尔”在名字字段中第一次出现时的位置',aggregate:0},LENGTH:{type:"LENGTH",usage:"LENGTH(字符串)",description:"返回字符串的长度",example:"LENGTH([货品名])，返回货品名的长度",aggregate:0},REPEAT:{type:"REPEAT",usage:"REPEAT(字符串, 数值)",description:"返回字符串重复对应数值次数后的新字符串结果",example:"REPEAT([货品名], 2)，返回货品名重复2次得到字符串",aggregate:0},REVERSE:{type:"REVERSE",usage:"REVERSE(字符串)",description:"返回字符串倒转后的新字符串结果",example:"REVERSE([类型编号])，返回类型编号倒转后的字符串",aggregate:0},SUBSTR:{type:"SUBSTR",usage:"SUBSTR(字符串, 起始位置[, 长度])",description:"返回从起始位置起对应长度的字符串的子字符串，长度为可选项",example:"SUBSTR([商品类型], 4)，返回商品类型的索引为4起至末尾的子字符串",aggregate:0},REGEXP_EXTRACT:{type:"REGEXP_EXTRACT",usage:"REGEXP_EXTRACT(字符串, 正则表达式[, 索引])",description:"返回字符串正则表达式解析结果,需要注意的是正则表达式的\\需要使用\\进行转义，即\\\\d)，'索引'是返回结果(0表示返回全部结果，1表示返回正则表达式中第一个() 对应的结果)",example:"REGEXP_EXTRACT([货品ID],'[\\\\d+\\\\-]+', 0)，返回货品ID中的数字部分",aggregate:0},REGEXP_REPLACE:{type:"REGEXP_REPLACE",usage:"REGEXP_REPLACE(字符串A, 正则表达式, 字符串B)",description:"返回将字符串A中符合正则表达式的部分替换成字符串B后的结果",example:"REGEXP_REPLACE([货品名], '[\\\\d＋]+', '')，返回将货品名中数字部分替换成空字符串后的结果",aggregate:0},TIME_CONVERT:{type:"TIME_CONVERT",usage:"TIME_CONVERT(时间戳字段[, 类型])",description:"UNIX时间戳转日期，支持秒级，毫秒级，传入参数为unix时间戳，如果时间戳精确到毫秒级，第二个参数传1",example:"TIME_CONVERT([时间戳字段])；TIME_CONVERT(1441509383)；TIME_CONVERT([时间戳字段]，1)；TIME_CONVERT(1441509383000，1)",aggregate:0},PERCENT:{type:"PERCENT",usage:"PERCENT([数值字段], 百分位)",description:"求数值类型字段的中位数及百分位数, 传入参数为数值字段;第二个参数范围是0<p<1,例如0.1，0.25，0.75，0.95",example:"PERCENT([数学考试分数], 0.5)，返回考试分数的中位数",aggregate:1},IP_LOCATION:{type:"IP_LOCATION",usage:"IP_LOCATION([IP字段], 位置类型)",description:"返回IP对应的地理信息，第一个参数为ip字段或者具体ip，第二个参数为返回类型，0代表国家，1代表地区，2代表城市",example:'IP_LOCATION("111.207.151.66", 2)，返回北京市',aggregate:0},COALESCE:{type:"COALESCE",usage:"COALESCE([字段1], [字段2], '默认')",description:"返回参数中的第一个非空值；如果所有值都为NULL，那么返回NULL",example:"COALESCE(null, '100', '50')",aggregate:0},TLD:{type:"TLD",usage:"TLD(合法的URL链接/字段)",description:"返回合法URL链接的一级域名，注意需带有协议部分，如http。对于不合法的链接均范围null",example:"TLD('https://www.bdp.cn'), 返回'bdp.cn",aggregate:0}}).directive("bdpFormula",["formulaDocument",function(e){return{restrict:"A",link:function(a,t,i){function r(a){return a=a.toUpperCase(),"WHEN"==a?a="CASE_WHEN":"DISTINCT"==a&&(a="COUNT_DISTINCT"),e[a]}function s(){g=CodeMirror.fromTextArea(t[0],{mode:"text/x-bdp-formula",indentWithTabs:!0,smartIndent:!0,lineWrapping:!0,matchBrackets:!0,theme:"paraiso-light",fields:a.fields,placeholder:i.p?"":"SUM([A]) + SUM([B])"}),g.on("change",function(){a.newField.aggregator=g.getValue().replace(/0xa0/,"")}),p=bdp.utils.throttle(function(){for(var e=g.getCursor(),t=e.ch,i=0,s=t;s>-1;){var p=g.getTokenAt({line:e.line,ch:s});if(!p.string)break;if(null==p.type)for(var l=p.string.length;--l>-1;)")"==p.string.charAt(l)&&i++;else if("keyword"==p.type){if(0==i){var n=p.string;a.currFunc=r(n),a.$$phase||a.$digest();break}i--}s-=p.string.length}},300),g.on("cursorActivity",p)}var g,p;setTimeout(function(){var e={funcQueue:[],loadLibInProgress:!1};thirdPluginLoader({initFun:s,libSrc:"https://m1.bdp.cn/static/js/lib/bdpFormula/bdp-codemirror_4fc5c0e.js",otherSrc:"",libId:window.CodeMirror},e)},200),a.add_func_to_formula=function(e){var a=g.getCursor(),t="COUNT_DISTINCT",i=e.type===t?"COUNT(DISTINCT())":e.type+"()",r=a.ch+i.length-(t==e.type?2:1);g.replaceSelection(i),g.setCursor(a.line,r),g.focus()},a.add_field_to_formula=function(e){g.replaceSelection("["+e.name+"]"),g.focus()},a.isClassify=!0,a.search_formula=function(){if(a.isClassify=!1,a.formula_query){var e=[];angular.forEach(a.func_list[0],function(t){t.type.indexOf(a.formula_query)>=0||t.type.indexOf(a.formula_query.toUpperCase())>=0?e.push(t):(t.description.indexOf(a.formula_query)>=0||t.description.indexOf(a.formula_query.toUpperCase())>=0)&&e.push(t)}),a.func_list_result=e}else a.func_list_result=angular.copy(a.func_list[0]);a.$$phase||a.$digest()},a.formula_query="en"==$.cookie("locale")?"All":"全部",a.show_classify_list=!1,a.inputQuery=function(){a.show_classify_list=!1,a.show_top=!1,angular.element("#function_query").addClass("long")},a.clearContent=function(){a.isClassify&&(a.formula_query="",a.isClassify=!1)},a.cancelQuery=function(){angular.element("#function_query").removeClass("long"),""==a.formula_query&&(a.formula_query="en"==$.cookie("locale")?"All":"全部",a.isClassify=!0,a.func_list_result=a.func_list[0])},a.showClassify=function(){a.show_classify_list=!a.show_classify_list,a.show_top=!a.show_top,a.show_classify_list?angular.element("#function_query").focus():angular.element("#function_query").blur()},a.selectClassifyItem=function(e){switch(a.isClassify=!0,a.show_classify_list=!1,a.show_top=!1,e){case 0:a.formula_query="en"==$.cookie("locale")?"All":"全部";break;case 1:a.formula_query="en"==$.cookie("locale")?"Aggregate":"聚合统计";break;case 2:a.formula_query="en"==$.cookie("locale")?"Not Aggregate":"非聚合统计";break;case 3:a.formula_query="en"==$.cookie("locale")?"Date and Time":"日期和时间";break;case 4:a.formula_query="en"==$.cookie("locale")?"String":"字符串";break;case 5:a.formula_query="en"==$.cookie("locale")?"Logic":"逻辑";break;case 6:a.formula_query="en"==$.cookie("locale")?"Number":"数值"}a.func_list_result=a.func_list[e]},a.cancelSearch=function(){a.show_classify_list=!1,a.show_top=!1,angular.element("#function_query").blur()},a.search_field=function(){if(a.field_query){var e=[];angular.forEach(a.field_list,function(t){(t.name.indexOf(a.field_query)>=0||t.name.indexOf(a.field_query.toUpperCase())>=0)&&e.push(t)}),a.fieldListResult=e}else a.fieldListResult=angular.copy(a.field_list);a.fieldListResult=bdp.utils.addSpecParamsToFields(a.fieldListResult),a.$$phase||a.$digest()}}}}]).directive("funcTip",[function(){return{restrict:"A",link:function(e,a,t){var i=t.funcTip?a.closest(t.funcTip)[0]:a.parent().parent()[0];a.hover(function(){if(i){var e=a[0].offsetTop,t=i.scrollTop,r=$(this).find(".func-tip");r.css({top:e-t-r.outerHeight()/2+14})}})}}}])}();
;!function(){angular.module("BC.controllers.chartEdit").controller("FormulaEditController",["$scope","formulaDocument","dataTypeList","commonHttp",function(a,t,l,n){a.func_list=[];a.typeList=l;var i=a.field_list=a.ngDialogData.fieldList;a.fieldListResult=angular.copy(a.ngDialogData.fieldList),a.fieldListResult=bdp.utils.addSpecParamsToFields(a.fieldListResult),a.fields=[];for(var o=0,e=i.length;e>o;o++)i[o].name&&(a.fields[o]=i[o].name);a.showLoading=!0,n.get("/api/function/list").then(function(t){if("0"===t.status){var l=t.result.classification;a.func_list_result=angular.copy(l[0]),a.func_list=angular.copy(l);var n={};angular.forEach(l,function(a,t){n[t]=[],angular.forEach(l[t],function(a){n[t].push({usage:a.usage,description:a.desc,example:a.demo,type:a.name})})}),"wb"==a.newField.module&&(n[1]=[],n[0]=[],n[0]=n[0].concat(n[2]).concat(n[3]).concat(n[4]).concat(n[5]).concat(n[6])),a.func_list_result=angular.copy(n[0]),a.func_list=angular.copy(n),a.showLoading=!1}})}])}();
;!function(){function e(e,t,i,r,a,s,u){function p(e){var t=angular.copy(e),i={};i.share_inside_group=+!!t.share_inside_group,i.share_outside_group=+!!t.share_outside_group,i.device_strategy=parseInt(t.device_strategy),i.remote_login_strategy=parseInt(t.remote_login_strategy),i.watermark_strategy=parseInt(t.watermark_strategy),parseInt(t.is_ip_limit)?0==t.ip_whitelist.length?(i.ip_whitelist=[],i.ip_strategy=0):(i.ip_whitelist=t.ip_whitelist,i.ip_strategy=parseInt(t.ip_strategy)):(i.ip_whitelist=[],i.ip_strategy=0),i.remote_login_strategy=parseInt(t.remote_login_strategy),i.web_strategy=parseInt(t.web_strategy);var r={type:0};return r.type=parseInt(t.web_expire),i.web_expire_setting=angular.copy(r),r.type=parseInt(t.mob_expire),i.mob_expire_setting=angular.copy(r),null!=t.is_export&&(i.export_data_setting={is_export:+t.is_export,export_max_num:+(1!=t.export_max_num?t.export_max_num:t.custom_max_num),export_type:+(1!=t.export_max_num?0:1)}),i.ip_unlimited_users=t.white_users,i.ip_unlimited_groups=t.white_groups,i.close_browser_token_failure=t.close_browser_token?1:0,i}function o(e){var t=angular.copy(e),i={};return i.share_inside_group=!!t.share_inside_group,i.share_outside_group=!!t.share_outside_group,i.device_strategy=t.device_strategy,i.remote_login_strategy=t.remote_login_strategy,i.ip_whitelist=t.ip_whitelist,i.watermark_strategy=t.watermark_strategy,0==t.ip_whitelist.length?(i.is_ip_limit=0,i.ip_strategy=0,i.ip_whitelist=[]):(i.is_ip_limit=1,i.ip_strategy=t.ip_strategy,i.ip_whitelist=t.ip_whitelist),i.web_strategy=t.web_strategy,i.web_expire=t.web_expire_setting.type,i.mob_expire=t.mob_expire_setting.type,t.export_data_setting&&(i.is_export=t.export_data_setting.is_export,i.export_max_num=t.export_data_setting.export_max_num,i.export_type=t.export_data_setting.export_type,1==i.export_type&&(i.export_max_num=1),i.custom_max_num=1==t.export_data_setting.export_type?t.export_data_setting.export_max_num:0),i.white_users=t.ip_unlimited_users,i.white_groups=t.ip_unlimited_groups,i.close_browser_token=1==t.close_browser_token_failure,i}function n(e){var t=angular.copy(e),i={ip_whitelist:t.ip_whitelist,share_inside_group:!!t.share_inside_group,share_outside_group:!!t.share_outside_group,device_strategy:t.device_strategy,remote_login_strategy:t.remote_login_strategy,web_strategy:t.web_strategy,web_expire:t.web_expire_setting.type,mob_expire:t.mob_expire_setting.type,ip_strategy:0,is_ip_limit:0,watermark_strategy:t.watermark_strategy,ip:"",white_users:t.ip_unlimited_users||[],white_groups:t.ip_unlimited_groups||[],close_browser_token:1==t.close_browser_token_failure||!1};return t.ip_whitelist.length>0?(i.is_ip_limit=1,i.ip_strategy=t.ip_strategy):(i.is_ip_limit=0,i.ip_strategy=0),t.export_data_setting&&(i.is_export=t.export_data_setting.is_export,i.export_max_num=t.export_data_setting.export_max_num,i.export_type=t.export_data_setting.export_type,1==i.export_type&&(i.export_max_num=1),i.custom_max_num=1==t.export_data_setting.export_type?t.export_data_setting.export_max_num:0),i}function _(e,t){var i=angular.copy(e),r=angular.copy(t),a=angular.toJson(i),s=angular.toJson(r);return a==s?!0:!1}function c(){e.ipWhiteListData.listType="user",e.ipWhiteListData.noUser=!1,e.ipWhiteListData.noGroup=!1,e.ipWhiteListData.showCheckedUser=!1,e.ipWhiteListData.showCheckedGroup=!1,e.ipWhiteListData.userQuery="",e.ipWhiteListData.groupQuery=""}function y(e,t){return e.toLowerCase().indexOf(t.toLowerCase())>=0}var h=t.language||"zh";e.securityData={},e.View={expireOptions:[{name:"security.default",value:0},{name:"security.1hour",value:1},{name:"security.3hour",value:5},{name:"security.6hour",value:6},{name:"security.12hour",value:2},{name:"security.24hour",value:3},{name:"security.1week",value:4}],exportSelectNum:[{name:1e3,value:1e3},{name:5e3,value:5e3},{name:1e4,value:1e4},{name:5e4,value:5e4},{name:1e5,value:1e5},{name:2e5,value:2e5},{name:5e5,value:5e5},{name:1e6,value:1e6},{name:"en"==h?"Custom":"自定义",value:1}]},t.view="security",e.validity_period="en"==h?{0:"Default",1:"1 Hour",2:"12 Hour",3:"24 Hour",4:"1 Week"}:{0:"默认",1:"1 小时",2:"12 小时",3:"24 小时",4:"1 周"},e.userType=0,e.currentUserType=0,e.changeTab=function(t){e.userType=t,e.securityView=e.securityData[e.userType],e.shareConfEnable=!1,0!=e.userType&&(e.shareConfEnable=!0)},e.limitIp=function(){e.securityView.ip_strategy=+(1==e.securityView.is_ip_limit)},e.addIp=function(){var t=e.securityView.ip;return t?/^\d{1,3}\.\d{1,3}\.\d{1,3}.\d{1,3}$/.test(t)?(e.securityView.ip_whitelist.push(t),void(e.securityView.ip="")):void s(e.tips["security.errIP"]):void s(e.tips["security.plzTypeIP"])},e.keyUpAddIp=function(t){13===t.keyCode&&e.addIp()},e.delIp=function(t){e.securityView.ip_whitelist.splice(t,1)},e.saveDone=!0,e.saveConfig=function(){var t={0:p(e.securityData[0]),2:p(e.securityData[2]),3:p(e.securityData[3])};e.securityOriginalData=t;var r={security_info:angular.toJson(t)};e.saveDone=!1,i.post("/api/security/modify",r).then(function(t){e.saveDone=!0,0==t.status&&s(e.tips.saveSuccess)})},e.resetConfig=function(){e.securityData[0]=o(e.securityOriginalData[0]),e.securityData[2]=o(e.securityOriginalData[2]),e.securityData[3]=o(e.securityOriginalData[3]),e.securityView=e.securityData[e.userType]};var l=function(){i.get("/api/security/info").then(function(t){if(0==t.status){var i=t.result;e.userType=0,e.currentUserType=e.userType,e.securityOriginalData=angular.copy(i),e.securityData[0]=n(e.securityOriginalData[0]),e.securityData[2]=n(e.securityOriginalData[2]),e.securityData[3]=n(e.securityOriginalData[3]),e.securityView=e.securityData[0],e.shareConfEnable=!1}})};l(),e.changeStrToNum=function(e){e.device_strategy=Number(e.device_strategy),e.ip_strategy=Number(e.ip_strategy),e.is_ip_limit=Number(e.is_ip_limit),e.mob_expire=Number(e.mob_expire),e.remote_login_strategy=Number(e.remote_login_strategy),e.web_expire=Number(e.web_expire),e.web_strategy=Number(e.web_strategy)},e.changeUserType=function(){var t=n(e.securityOriginalData[e.currentUserType]);if(e.changeStrToNum(e.securityView),_(t,e.securityView))e.securityView=e.securityData[e.userType],e.currentUserType=e.userType;else if(confirm(e.tips["security.changedAndToSave"])){var r={0:p(e.securityData[0]),2:p(e.securityData[2]),3:p(e.securityData[3])};e.securityOriginalData=r;var a={security_info:angular.toJson(r)};e.saveDone=!1,i.post("/api/security/modify",a).then(function(t){e.saveDone=!0,0==t.status?(s(e.tips.saveSuccess),e.securityView=e.securityData[e.userType],e.currentUserType=e.userType):(s(Number(t.status)),e.userType=e.currentUserType)})}else e.securityData[e.currentUserType]=t,e.currentUserType=e.userType,e.securityView=e.securityData[e.userType];e.shareConfEnable=!1,0!=e.userType&&(e.shareConfEnable=!0)},e.checkShareInsideGroup=function(t){t||(e.securityView.share_outside_group=!1)},e.checkShareOutsideGroup=function(t){t&&(e.securityView.share_inside_group=!0)},e.ipWhiteListData={listType:"user",userList:[],groupList:[],noUser:!1,noGroup:!1,showCheckedUser:!1,showCheckedGroup:!1,userQuery:"",groupQuery:""},e.userListLoading=!1,e.addIpLimitUser=function(){a.open({template:"/static/partials/dialogTemplates/add_ip_limit_user.html",className:"ngdialog-theme-default ngDialog-width-450 add-ip-limit-user",scope:e}),0==e.ipWhiteListData.userList.length?(e.userListLoading=!0,r.user.userList().then(function(t){e.userListLoading=!1,angular.forEach(t.result,function(t){t.checked=!1,t.display=!0,e.securityView.white_users.indexOf(t.userid)>=0&&(t.checked=!0)}),e.ipWhiteListData.userList=t.result,e.ipWhiteListData.noUser=0==t.result.length})):(c(),angular.forEach(e.ipWhiteListData.userList,function(t){t.checked=!1,t.display=!0,e.securityView.white_users.indexOf(t.userid)>=0&&(t.checked=!0)})),0==e.ipWhiteListData.groupList.length?r.user.groupList().then(function(t){angular.forEach(t.result,function(t){t.checked=!1,t.display=!0,e.securityView.white_groups.indexOf(t.group_id)>=0&&(t.checked=!0)}),e.ipWhiteListData.groupList=t.result,e.ipWhiteListData.noGroup=0==t.result.length}):(c(),angular.forEach(e.ipWhiteListData.groupList,function(t){t.checked=!1,t.display=!0,e.securityView.white_groups.indexOf(t.group_id)>=0&&(t.checked=!0)}))},e.changeListTab=function(t){e.ipWhiteListData.listType=t;var i=0;"user"==t?(e.ipWhiteListData.showCheckedUser=!1,e.ipWhiteListData.userQuery="",angular.forEach(e.ipWhiteListData.userList,function(t){e.userType==t.role&&(t.display=!0,i++)}),e.ipWhiteListData.noUser=0==i):"group"==t&&(e.ipWhiteListData.showCheckedGroup=!1,e.ipWhiteListData.groupQuery="",angular.forEach(e.ipWhiteListData.groupList,function(t){e.userType==t.role&&(t.display=!0,i++)}),e.ipWhiteListData.noGroup=0==i)},e.showChecked=function(t){var i=!0;"user"==t?(i=!0,e.ipWhiteListData.showCheckedUser?angular.forEach(e.ipWhiteListData.userList,function(t){e.userType==t.role&&(t.display=t.checked,t.display&&e.ipWhiteListData.userQuery&&(t.display=y(t.name,e.ipWhiteListData.userQuery)||y(t.username,e.ipWhiteListData.userQuery)),i=i?!t.display:i)}):angular.forEach(e.ipWhiteListData.userList,function(t){e.userType==t.role&&(t.display=!0,e.ipWhiteListData.userQuery&&(t.display=y(t.name,e.ipWhiteListData.userQuery)||y(t.username,e.ipWhiteListData.userQuery)),i=i?!t.display:i)}),e.ipWhiteListData.noUser=i):(i=!0,e.ipWhiteListData.showCheckedGroup?angular.forEach(e.ipWhiteListData.groupList,function(t){t.display=t.checked,t.display&&e.ipWhiteListData.groupQuery&&(t.display=y(t.group_name,e.ipWhiteListData.groupQuery)),i=i?!t.display:i}):angular.forEach(e.ipWhiteListData.groupList,function(t){t.display=!0,e.ipWhiteListData.groupQuery&&(t.display=y(t.group_name,e.ipWhiteListData.groupQuery)),i=i?!t.display:i}),e.ipWhiteListData.noGroup=i)},e.doSearch=function(t){var i=!0;"user"==t?(i=!0,e.ipWhiteListData.userQuery?angular.forEach(e.ipWhiteListData.userList,function(t){e.userType==t.role&&(t.display=y(t.name,e.ipWhiteListData.userQuery)||y(t.username,e.ipWhiteListData.userQuery),t.display&&e.ipWhiteListData.showCheckedUser&&(t.display=t.checked),i=i?!t.display:i)}):angular.forEach(e.ipWhiteListData.userList,function(t){e.userType==t.role&&(t.display=!0,e.ipWhiteListData.showCheckedUser&&(t.display=t.checked),i=i?!t.display:i)}),e.ipWhiteListData.noUser=i):(i=!0,e.ipWhiteListData.groupQuery?angular.forEach(e.ipWhiteListData.groupList,function(t){t.display=y(t.group_name,e.ipWhiteListData.groupQuery),t.display&&e.ipWhiteListData.showCheckedGroup&&(t.display=t.checked),i=i?!t.display:i}):angular.forEach(e.ipWhiteListData.groupList,function(t){t.display=!0,e.ipWhiteListData.showCheckedGroup&&(t.display=t.checked),i=i?!t.display:i}),e.ipWhiteListData.noGroup=i)},e.saveIpWhiteList=function(){var t=[],i=[];angular.forEach(e.ipWhiteListData.userList,function(i){i.checked&&e.userType==i.role&&t.push(i.userid)}),angular.forEach(e.ipWhiteListData.groupList,function(e){e.checked&&i.push(e.group_id)}),e.securityView.white_users=t,e.securityView.white_groups=i,a.closeAll()},u(["saveSuccess","security.plzTypeIP","security.errIP","security.atLeastOneIP","security.changedAndToSave","security.default","security.1hour","security.3hour","security.6hour","security.12hour","security.24hour","security.1week"],e)}angular.module("BC.controllers.security",[]).controller("securityCtrl",e),e.$inject=["$scope","$rootScope","commonHttp","commonService","ngDialog","errHint","$jsTipTranslate"]}();
;angular.module("BC.directives").controller("bubbleTabCtrl",["$scope",function(o){o.tab={index:0},o.onDropToColor=function(o,n){$.$broadcast("onDropToColor",{originEvent:o,ui:n})},o.onDropToSize=function(o,n){$.$broadcast("onDropToSize",{originEvent:o,ui:n})}}]);
;!function(){function t(t,e,a,i,s,o,r,n){function l(t){angular.forEach(F.worktableList,function(e,a){angular.forEach(e.tb_list,function(i,s){i.tb_id==t&&(e.tb_list.splice(s,1),0==e.tb_list.length&&F.worktableList.splice(a,1))})})}function u(t){angular.forEach(F.dashList,function(e,a){angular.forEach(e.dsh_list,function(i,s){i.dsh_id==t&&e.dsh_list.splice(s,1),0==e.dsh_list.length&&F.dashList.splice(a,1)})})}function c(t,e,a,i){var i="folderList"==i?"folderList":"projList",s="folderList"==i?"tb_list":"dsh_list",o=V[i][e],r=o[s];if("folderList"==i?void 0!==r.selected?r[a].selected=t:t?r[a].add=!0:(l(r[a].tb_id),delete r[a].add):t||u(r[a].dsh_id),t){var n=0;angular.forEach(r,function(t){t.check&&n++}),n==r.length&&(o.check=t)}else{if(!o.check)return;o.check=t}}function d(t,e,a){var i="folderList"==a?"tb_list":"dsh_list";angular.forEach(V[a][e][i],function(e){e.disable||(e.check=t,e.check?e.add=!0:e.add&&("folderList"==a?l(e.tb_id):u(e.dsh_id),delete e.add))})}function f(){function e(){var e="/static/partials/dialogTemplates/add-dashboard.html";o.open({template:e,className:"ngdialog-theme-default ngDialog-width-700",scope:t})}V.projList?e():m().then(function(t){var a=[];angular.forEach(t.proj,function(t){0==t.type&&0==t.property&&a.push(t)}),V.projList=angular.copy(a),e()})}function h(){function e(e){var a="/static/partials/dialogTemplates/add-worktable.html";o.open({template:a,className:"ngdialog-theme-default ngDialog-width-700",scope:t,data:{init:e?!0:!1},controller:"addWorktableCtrl"})}V.originFolderList?(V.folderList=angular.copy(V.originFolderList),e()):w().then(function(t){function a(t){function e(t,i,s){t.sub_folders&&t.sub_folders.length>0&&a(t.sub_folders,e),0!=t.tb_list.length||t.sub_folders&&0!=t.sub_folders.length||s.splice(i,1)}var a=bdp.utils.descMap;return a(t,e),t}0==t.status&&(t.result.map(function(t){t.name||(t.name="根目录")}),V.folderList=a(t.result),V.originFolderList=angular.copy(V.folderList),e("initData"))})}function _(e,a){if("create"==e)return V.list.push(a),void t.$emit("userInfoChange","change");for(var i=V.list,s=0,o=i.length;o>s;s++)i[s].ws_id==a.ws_id&&(i[s].name=a.name);t.$emit("userInfoChange","change")}function p(){var t=[],e=[];return angular.forEach(V.groupList,function(a){a.check&&(t.push(a.group_id),e.push(a))}),{groupIds:t,groupList:e}}function g(e){V.curWorkspace=e,r.workspace.info({ws_id:e}).then(function(e){if(t.pageLoading=!1,0==e.status){var a=e.result;F.dashList=a.proj_list,F.worktableList=a.folder_list,F.originalworktableList=angular.copy(a.folder_list),F.groupList=a.group_list.list,F.groupListAll=a.group_list.is_all,b(),angular.forEach(a.authority_info,function(t){t.admin&&(t.admin=!0),t.rule&&(t.rule=!0),(t.dash_list.is_all||t.dash_list.proj_list&&t.dash_list.proj_list.length>0)&&(t.dash_list.check=!0),(t.tb_list.is_all||t.tb_list.tb_list&&t.tb_list.tb_list.leghth>0)&&(t.tb_list.check=!0)}),F.authorityInfo=a.authority_info,V.showTitle=e.result.name||"",V.authority={}}})}function b(){var t={};F.worktableList.map(function(e,a){var i={index:a};e.sub_folders&&e.sub_folders.length>0&&(i.sub_folders={},e.sub_folders.map(function(t,s){i.sub_folders[t.name]={subIndex:s,parentFolder:e.name,parentIndex:a}})),t[e.name?e.name:"根目录"]=i}),F.folderInfo=t}function m(){return r.project.getTree()}function w(t){var e={ws_id:V.curWorkspace};return"preview"!==t&&(e.is_all=!0),r.workspace.tbListPreview(e)}function L(){r.workspace.list().then(function(e){if(0==e.status&&(V.initView=!1,V.list=e.result,V.list.length>0)){var a=C.getItem("current_workspace_id")||"",i={},s=!1;if(a?angular.forEach(V.list,function(t){t.ws_id==a&&(s=!0,i=t)}):s=!1,s)V.curWorkspace=i.ws_id,V.admin=i.admin;else{var o=e.result[0];V.curWorkspace=o.ws_id,V.admin=o.admin}t.pageLoading=!0,g(V.curWorkspace)}})}function v(e){t.pageLoading=!0,r.workspace.workspaceLog(e).then(function(e){0==e.status?(t.pageLoading=!1,t.operateLogView.logData=e.result.log,angular.forEach(t.operateLogView.logData,function(t){t.c_time=n("date")(t.c_time,"yyyy-MM-dd HH:mm:ss")}),t.operateLogView.count=e.result.count,t.operateLogView.total_page=parseInt(t.operateLogView.count/100),t.operateLogView.count%D>0&&t.operateLogView.total_page++):i(Number(e.status))})}function k(t){return r.workspace.delete({ws_id:t})}function y(t){return r.workspace.modifyDashList(t)}function I(t){return r.workspace.modifyTableList(t)}function j(){return r.user.groupList()}function E(t){return r.workspace.modifyGroupList(t)}function x(t){return r.workspace.modifyAuthority(t)}function W(t){return r.workspace.userList(t)}e.view="workspace",t.workspaceTab="workspaceSetting",t.workspaceView={view:"cat",projList:null,list:[],curWorkspace:"",showPermisionUserList:!1,authority:{},showTitle:"",initView:!0},t.workspaceData={projList:null,worktableList:null};var V=t.workspaceView,F=t.workspaceData;L(),t.changeTab=function(e){"workspaceSetting"==e?(t.workspaceTab="workspaceSetting",V.view="cat",g(V.curWorkspace)):"operateLog"==e&&(t.workspaceTab="operateLog",t.operateLog.info(V.curWorkspace))};var C=window.localStorage;t.workspace={info:function(e){V.folderList=null,V.admin=e.admin,V.view="cat",t.workspaceTab="workspaceSetting",t.pageLoading=!0,C.setItem("current_workspace_id",e.ws_id),g(e.ws_id)},addWorkspace:function(){V.mode="create",V.workspaceName="",o.open({templateUrl:"/static/partials/dialogTemplates/create_workspace.html",scope:t,className:"ngdialog-theme-default ngdialog-small"})},createWorkspace:function(t){if(!t)return void i("请输入名称");var e=!1;return angular.forEach(V.list,function(a){a.name.toLocaleLowerCase()==t.toLocaleLowerCase()&&(e=!0)}),e?void i("该名称的工作区已存在，请重新输入"):void r.workspace.create({name:t}).then(function(e){if(0==e.status){var a=e.result,i={ws_id:a,name:t,admin:0};_("create",i),V.curWorkspace=i.ws_id,g(i.ws_id),V.mode="cat",V.admin=0,o.closeAll()}})},modifyWorkspace:function(e,a){var s=!1;if(angular.forEach(V.list,function(t){t.ws_id!=e&&t.name==a&&(s=!0)}),s)return void i("该名称的工作区已存在，请重新输入");var o={ws_id:e,name:a};return r.workspace.modify(o).then(function(e){0==e.status&&(i("修改成功"),t.workspaceView.showTitle=a,_("update",o))}),a},deleteWorkspace:function(a){confirm("确定要删除改工作区？")&&(t.pageLoading=!0,k(a).then(function(s){if(0==s.status){i("删除成功");for(var o,r=0,n=V.list.length;n>r;r++)if(V.list[r].ws_id==a){o=r;break}V.list.splice(o,1),a==V.curWorkspace&&V.list.length>0&&g(V.list[0].ws_id),t.$emit("userInfoChange","change"),e.last_dash_path&&e.last_dash_path.indexOf(a)>=0&&(e.last_dash_path=""),e.last_worktable_path&&e.last_worktable_path.indexOf(a)>=0&&(e.last_worktable_path=""),e.last_template_path&&e.last_template_path.indexOf(a)>=0&&(e.last_template_path=""),e.wsId==a&&(e.wsId="")}else i(Number(s.status));t.pageLoading=!1}))}},t.dash={add:function(){f()},cancel:function(){g(V.curWorkspace),V.view="cat"},projChange:function(t){var e=V.projList[t].check;d(e,t,"projList")},del:function(t,e,a){F.dashList[e].dsh_list.splice(a,1),angular.forEach(V.projList,function(e){angular.forEach(e.dsh_list,function(a){a.dsh_id==t&&(a.check=!1,e.check=!1)})})},dshChange:function(t,e){{var a=V.projList[t].dsh_list[e].check;V.projList[t].dsh_list[e]}c(a,t,e,"projList")},confirmAdd:function(){function t(t){function e(t,e){var a=!1,i=!1;angular.forEach(F.dashList,function(s){t==s.name&&(angular.forEach(s.dsh_list,function(t){t.dsh_id==e.dsh_id&&(i=!0)}),i||s.dsh_list.push({dsh_id:e.dsh_id,name:e.name,canDel:!0}),a=!0)}),a||F.dashList.push({name:t,dsh_list:[{dsh_id:e.dsh_id,name:e.name,canDel:!0}]})}F.dashList&&0==F.dashList.length?F.dashList=t:angular.forEach(t,function(t){angular.forEach(t.dsh_list,function(a){e(t.name,a)})})}function e(){var t=[],e=[],a=0;return angular.forEach(V.projList,function(i){angular.forEach(i.dsh_list,function(s){s.check&&(t[a]||(t[a]={name:i.name,proj_id:i.proj_id,dsh_list:[]}),t[a].dsh_list.push(s),e.push(s.dsh_id))}),t[a]&&a++}),t}var a=e();t(a),o.closeAll()},save:function(){return 0==F.dashList.length?void i("请选择至少一个仪表盘"):void(confirm("移入此工作区的仪表盘将从超级管理员的仪表盘中移除，是否继续？")&&(t.pageLoading=!0,y({ws_id:V.curWorkspace,proj_list:angular.toJson(F.dashList)}).then(function(a){t.pageLoading=!1,0==a.status&&(V.projList=null,w("preview").then(function(t){if(0==t.status){if(e.last_dash_path)var a=e.last_dash_path.replace(/\/dash.*\//,"");if(a){var s=!1;angular.forEach(F.dashList,function(t){angular.forEach(t.dsh_list,function(t){t.dsh_id==a&&(s=!0)})}),s&&(e.last_dash_path="")}i("保存成功"),g(V.curWorkspace),V.view="cat"}}))})))}},t.worktable={add:function(){h()},cancel:function(){g(V.curWorkspace),V.view="cat",V.folderList=null},save:function(){t.pageLoading=!0,I({ws_id:V.curWorkspace,folder_list:angular.toJson(F.worktableList)}).then(function(e){t.pageLoading=!1,0==e.status&&(i("修改成功"),V.view="cat",g(V.curWorkspace))}),V.folderList=null},folderChange:function(t){var e=V.folderList[t].check;d(e,t,"folderList")},tbChange:function(t,e){var a=V.folderList[t].tb_list[e].check;c(a,t,e,"folderList")},confirmAdd:function(){}},t.user={checkAll:function(){var t=V.groupListAll;angular.forEach(V.groupList,function(e){e.check=t})},groupChange:function(t){if(t){var e=0;angular.forEach(V.groupList,function(t){t.check&&e++}),V.groupListAll=e==V.groupList.length?!0:!1}else V.groupListAll=!1},modify:function(){var t=F.groupList;j().then(function(e){if(0==e.status){if(V.view="users",1==F.groupListAll)V.groupList=e.result;else{var a=[];angular.forEach(t,function(t){a.push(t.group_id)});var i=0;angular.forEach(e.result,function(t){$.inArray(t.group_id,a)>-1&&(t.check=!0,i++)}),V.groupListAll=i==e.result.length?!0:!1,V.groupList=e.result}V.groupRange=F.groupListAll}})},save:function(){var e=V.groupRange;if(0==e){var a=p();if(0==a.groupIds.length)return void i("请至少选择一个分组")}var s={ws_id:V.curWorkspace};1==e?s.is_all=1:s.group_list=angular.toJson(a.groupIds),t.pageLoading=!0,E(s).then(function(s){t.pageLoading=!1,0==s.status&&(F.groupList=1==e?[]:a.groupList,V.view="cat",V.userList=null,g(V.curWorkspace),i("保存成功"))})},cancel:function(){g(V.curWorkspace),V.view="cat"}},t.authority={checkGroupList:function(){F.groupListAll||0!=F.groupList.length?V.view="authorityInfo":i("请优先添加需要管理的用户组")},showUserList:function(){V.showPermisionUserList=!0,V.userList||(t.showLoading=!0,W({ws_id:V.curWorkspace}).then(function(e){0==e.status&&(V.userList=e.result,t.showLoading=!1)}))},addUser:function(t){if(F.authorityInfo||(F.authorityInfo=[]),F.authorityInfo.length>0){var e=!1;if(angular.forEach(F.authorityInfo,function(a){a.user_id==t.user_id&&(e=!0)}),e)return i("该用户已添加"),void(V.showPermisionUserList=!1)}F.authorityInfo.push({user_id:t.user_id,name:t.name,dash_list:{is_all:0,check:!1},tb_list:{is_all:0,check:!1},rule:0,admin:0}),V.showPermisionUserList=!1},del:function(t){F.authorityInfo.splice(t,1)},modify:function(){V.view="cat"},dashChange:function(t){var e=F.authorityInfo[t],a=e.dash_list.check;e.dash_list.is_all=a?1:0,a?e.dash_list.proj_list=[]:e.admin=!1},tbChange:function(t){var e=F.authorityInfo[t],a=e.tb_list.check;e.tb_list.is_all=a?1:0,e.tb_list.tb_list=[],a||(e.admin=!1)},setAdmin:function(t){var e=this;e._index=t;var a=F.authorityInfo[e._index],i=a.admin;a.dash_list.is_all=i?1:0,a.dash_list.check=i,a.dash_list.proj_list=[],a.tb_list.is_all=i?1:0,a.tb_list.check=i,a.tb_list.tb_list=[],a.rule=i},ruleChange:function(t){var e=this;e._index=t;var a=F.authorityInfo[e._index],i=a.rule;i||(a.admin=!1)},_index:0,userId:"",showDashDialog:function(e,a,i,s){function r(){var e=V.authority;e[l.userId]?e[l.userId].dash||(e[l.userId].dash=n(F.dashList)):(e[l.userId]={},e[l.userId].dash=n(F.dashList));var a="/static/partials/dialogTemplates/ws-choose-dashboard.html";o.open({template:a,className:"ngdialog-theme-default ngDialog-width-520",scope:t,data:{user_id:l.userId,index:l._index,mode:"cat"==s?"cat":"modify"}})}function n(t){function e(t,e){angular.forEach(i,function(a){a.proj_id==t&&(a.show=!0,"number"==typeof e?a.is_all=1:(a.is_all=0,angular.forEach(a.dsh_list,function(t){$.inArray(t.dsh_id,e)>-1&&(t.check=!0)})))})}var a=F.authorityInfo[l._index],i=angular.copy(t);return $.isEmptyObject(a.dash_list)||1==a.dash_list.is_all&&(!a.dash_list.proj_list||0==a.dash_list.proj_list.length)?(angular.forEach(i,function(t){t.is_all=0}),i):0==a.dash_list.is_all?(a.dash_list.proj_list.length>0&&angular.forEach(a.dash_list.proj_list,function(t){1!=t.is_all?e(t.proj_id,t.dash_list):e(t.proj_id,1)}),angular.forEach(i,function(t){t.hasOwnProperty("is_all")||(t.is_all=0)}),i):i}i.stopPropagation();var l=this;l._index=a,l.userId=e.user_id,r()},chooseDash:function(t){if("cat"==t)return void o.closeAll();var e=this,a=e._index,s=e.userId,r=V.authority[s].dash,n=[];angular.forEach(r,function(t){if(Number(t.is_all))n.push({is_all:1,proj_id:t.proj_id});else{n.push({is_all:0,proj_id:t.proj_id});var e=n.length;angular.forEach(t.dsh_list,function(t){t.check&&(n[e-1].dash_list||(n[e-1].dash_list=[]),n[e-1].dash_list.push(t.dsh_id))})}});for(var l=n.length-1;l>=0;)0!=n[l].is_all||n[l].dash_list||n.splice(l,1),l--;return"cat"!=t&&1!=F.authorityInfo[a].dash_list.is_all&&0==n.length?void i("未选择仪表盘"):(F.authorityInfo[a].dash_list.proj_list=n,void o.closeAll())},showTbDialog:function(e,a,i,s){function r(){var e="/static/partials/dialogTemplates/ws-choose-worktable.html";o.open({template:e,className:"ngdialog-theme-default ngDialog-width-700",scope:t,data:{user_id:n.userId,index:n._index,mode:"cat"==s?"cat":"modify"},controller:"authorityWorkTableCtrl"})}i.stopPropagation();var n=this;n._index=a,n.userId=e.user_id,r()},chooseWorktable:function(){},save:function(){function e(){var t=[];return angular.forEach(F.authorityInfo,function(e){if(e.dash_list.check||e.tb_list.check||e.admin||e.rule){var a={dash_list:{},tb_list:{}};a.user_id=e.user_id,a.admin=e.admin?1:0,a.rule=e.rule?1:0,a.dash_list.is_all=e.dash_list.is_all,e.dash_list.check?0==a.dash_list.is_all&&(a.dash_list.proj_list=e.dash_list.proj_list||[]):a.dash_list.proj_list=[],a.tb_list.is_all=e.tb_list.is_all,a.tb_list.is_all=e.tb_list.is_all,e.tb_list.check?a.tb_list.is_all&&(a.tb_list.tb_list=e.tb_list.tb_list||[]):a.tb_list.tb_list=[],t.push(a)}}),t}var a=e();t.pageLoading=!0,x({ws_id:V.curWorkspace,authority_info:angular.toJson(a)}).then(function(e){t.pageLoading=!1,0==e.status&&(i("保存成功"),V.view="cat",g(V.curWorkspace))})},cancel:function(){g(V.curWorkspace),V.view="cat"}};var D=100;t.operateLogView={logData:{},count:0,total_page:1,current_page:1,show_change_page:!1},t.operateLog={logData:{},total:0,info:function(t){var e={ws_id:t,page:1};v(e)},page:function(){},goPrevPage:function(){if(1!=t.operateLogView.current_page){var e={ws_id:V.curWorkspace,page:--t.operateLogView.current_page};v(e)}},goNextPage:function(){if(t.operateLogView.current_page!=t.operateLogView.total_page){var e={ws_id:V.curWorkspace,page:++t.operateLogView.current_page};v(e)}},goFirstPage:function(){if(1!=t.operateLogView.current_page){var e={ws_id:V.curWorkspace,page:1};t.operateLogView.current_page=1,v(e)}},goLastPage:function(){if(t.operateLogView.current_page!=t.operateLogView.total_page){var e={ws_id:V.curWorkspace,page:t.operateLogView.total_page};t.operateLogView.current_page=t.operateLogView.total_page,v(e)}},setPageListPos:function(t){var e=$(t.target).offset(),a=$(window).height(),i=30;a-e.top<110&&(i=-80),$(".page-list").css({top:i}),t.stopPropagation()}},s(["saveSuccess"],t)}function e(t,e,a){function i(t,e){function a(t,e){e.map(function(e){e.choose=t,e.selected||(t?e.add=!0:delete e.add)})}var i,s=[];s=void 0===e?l[t]:l[t].sub_folders[e],i=s.choose,a(i,s.tb_list),void 0===e&&s.sub_folders&&s.sub_folders.length>0&&s.sub_folders.map(function(t){t.choose=i,a(i,t.tb_list)})}function s(t){function e(){function e(t){t.sub_folders&&t.sub_folders.length>0&&t.sub_folders.map(e);var a=s(t.tb_list);!a||t.sub_folders&&0!=t.sub_folders.length?a&&i(t.sub_folders)&&(t.choose=!0,t.disable=!0):(t.choose=!0,t.disable=!0)}function i(t){var e=0;return 0==t.length?!1:(t.map(function(t){t.choose&&t.disable&&e++}),e==t.length?!0:!1)}function s(t){var e=0;return 0==t.length?!1:(t.map(function(t){(t.should_select||$.inArray(t.tb_id,a)>-1)&&(t.choose=!0,t.selected=!0,t.disable=!0,e++)}),e==t.length?!0:!1)}t.map(e)}var a=[];return n.worktableList&&(a=o()),e(),t}function o(){function t(a){a.tb_list.map(e),a.sub_folders&&a.sub_folders.length>0&&a.sub_folders.map(t),a.name||(a.name="根目录")}function e(t){a.push(t.dstb_id)}var a=[];return n.worktableList.map(t),a}function r(){function t(t,e){var s={tb_id:t.tb_id,name:t.name,type:t.type};if(1==e.level){var o=a[e.folderName];o?i[o.index].tb_list.push(s):(i.push({name:e.folderName,tb_list:[s]}),a[e.folderName]={index:i.length-1})}else{var o=a[e.folderName];if(o){var r=o.sub_folders;if(r&&r[e.subFolderName]){var n=r[e.subFolderName];i[n.parentIndex].sub_folders[n.subIndex].tb_list.push(s)}else{r||(i[o.index].sub_folders=[]);var l=i[o.index];l.sub_folders.push({name:e.subFolderName,tb_list:[s]}),o.sub_folders||(o.sub_folders={}),o.sub_folders[e.subFolderName]={subIndex:l.sub_folders.length-1,parentIndex:o.index}}}else i.push({name:e.folderName,tb_list:[],sub_folders:[{name:e.subFolderName,tb_list:[s]}]}),a[e.folderName]={index:i.length-1,sub_folders:{}},a[e.folderName].sub_folders[e.subFolderName]={parentIndex:i.length-1,subIndex:0}}}function e(e,a){e.map(function(e){e.add&&t(e,a)})}var a=angular.copy(n.folderInfo),i=angular.copy(n.originalworktableList);l.map(function(t){e(t.tb_list,{level:1,folderName:t.name}),t.sub_folders&&t.sub_folders.length>0&&t.sub_folders.map(function(a){e(a.tb_list,{level:2,folderName:t.name,subFolderName:a.name})})}),n.worktableList=angular.copy(i)}var n=t.workspaceData,l=t.workspaceView.folderList;t.curFolder={},t.setCurFolder=function(e,a){var i=t.curFolder;i.index=e,i.subIndex=a;var s;s=void 0===a?l[e]:l[e].sub_folders[a],t.curFolderItem=s},t.ngDialogData.init&&(l=s(l)),t.setCurFolder(0),t.openFolder=function(e,a){t.setCurFolder(e,a)},t.checkone=function(e,a){var i=e.choose;e.selected||(i?e.add=!0:delete e.add),bdp.bdpTables.initFolderListChoose(t.workspaceView.folderList,a)},t.checkAll=function(e,a){i(e,a),bdp.bdpTables.initFolderListChoose(t.workspaceView.folderList,e)},t.confirmAdd=function(){r(),a.closeAll()}}function a(t,e,a){function i(t){function e(t){t.sub_folders&&t.sub_folders.length>0&&t.sub_folders.map(e);var s=i(t.tb_list);s&&(t.show=!0),t.sub_folders&&a(t.sub_folders)&&(t.show=!0)}function a(t){var e=!1;return t.map(function(t){t.show&&(e=!0)}),e}function i(t){var e=!1;return t.map(function(t){$.inArray(t.tb_id,s.tb_list.tb_list)>-1&&(t.choose=!0,e=!0)}),e}var s=u.authorityInfo[n],o=angular.copy(t);return $.isEmptyObject(s.tb_list)||0==s.tb_list.is_all&&0==s.tb_list.tb_list.length?o:0==s.tb_list.is_all?(s.tb_list.tb_list.length>0&&o.map(e),o):o}var s=t.workspaceView,o=t.ngDialogData,r=o.user_id,n=o.index,l=o.mode,u=t.workspaceData;s.authority[r]?s.authority[r].tb||(s.authority[r].tb=i(u.worktableList)):(s.authority[r]={},s.authority[r].tb=i(u.worktableList));var c=s.authority[r].tb;t.curFolder={},t.setCurFolder=function(e,a){var i=t.curFolder;i.index=e,i.subIndex=a;var s;s=void 0===a?c[e]:c[e].sub_folders[a],t.curFolderItem=s},t.setCurFolder(0),t.openFolder=function(e,a){t.setCurFolder(e,a)},t.chooseWorktable=function(){function t(){function t(a){e(a.tb_list),a.sub_folders&&a.sub_folders.length>0&&a.sub_folders.map(t)}function e(t){t.map(function(t){t.choose&&o.push(t.tb_id)})}i.map(t)}if("cat"==l)return void a.closeAll();var i=s.authority[r].tb,o=[];return 0==u.authorityInfo[n].tb_list.is_all&&(t(),0==o.length)?void e("未选择工作表"):(u.authorityInfo[n].tb_list.tb_list=o,void a.closeAll())}}angular.module("BC.controllers.workspace",[]).controller("workspaceCtrl",t).controller("addWorktableCtrl",e).controller("authorityWorkTableCtrl",a),t.$inject=["$scope","$rootScope","commonHttp","errHint","$jsTipTranslate","ngDialog","commonService","$filter"],e.$inject=["$scope","$timeout","ngDialog"],a.$inject=["$scope","errHint","ngDialog"]}();
;!function(){window.console.err=window.console.error,window.console.error=function(){console.err.apply(console,arguments);var o=window.location.href,i=arguments[0].split(" at "),r=$.cookie("user"),e=$.cookie("domain"),n=o.split("dash_edit/")[1]?o.split("dash_edit/")[1].split("/"):[],t={user:r,domain:e,proj_id:n[0]||"",dsh_id:n[1]||"",ct_id:n[2]||"",intro:i[0],detail:i[1]};$.ajax({type:"POST",url:"/api/front_stat/web_error",data:t})}}();
;!function(){angular.module("BC.controllers.pay",[])}();
;!function(){function e(e,n,o){o.member_personal=!0,e.init=function(){e.memberData={vipLevel:0},o.personalInfo&&o.personalInfo.new_version&&(o.personalInfo.new_version=0),e.personalVipInfo(),window._BDP_TIME_LOGGER&&BDPLogger.subTime("member","memberPv",e.memberData.vipLevel,1)},e.personalVipInfo=function(){n.pay.personalVipInfo().then(function(n){0==n.status&&(e.memberData.vipLevel=n.result.vip_level)})},e.init()}angular.module("BC.controllers.pay").controller("memberCtrl",e),e.$inject=["$scope","commonService","$rootScope"]}();
;!function(){function e(e,a,t,r,p){var n={1:{12:490,3:147,1:49},2:{12:2990,3:897,1:299}};a.member_personal=!0,e.init=function(){var a=p.upgradeId?p.upgradeId:1;e.upgradeResultData={},e.memberUpgradeData={username:null,vipLevel:0,vipDeadline:null,selectedLevel:a,openData:null,discount:null,showDiscounttip:!1},e.memberList={},e.personalVipInfo(),window._BDP_TIME_LOGGER&&BDPLogger.subTime("member","memberUpgradePv",a,1)};var i="_websocketChartMessage_";e.$on(i,function(t,r){var p="string"==typeof r.data?$.parseJSON(r.data):r.data;3==p.type&&(e.upgradeResultData={vipLevel:p.pay_result.vip_level,vipDeadline:p.pay_result.vip_deadline},a.memberData.vipLevel=p.pay_result.vip_level,a.memberData.vipDeadline=e.upgradeResultData.vipDeadline,e.memberUpgradeData.vipLevel=p.pay_result.vip_level,e.memberUpgradeData.openData.vipDeadline=e.upgradeResultData.vipDeadline,e.memberUpgradeData.vipDeadline=e.upgradeResultData.vipDeadline,e.upgradeResult(),e.changeQrCode())}),e.personalVipInfo=function(){t.pay.personalVipInfo().then(function(a){0==a.status&&e.processMemData(a.result)})},e.processMemData=function(a){var t=e.memberUpgradeData.selectedLevel,r={vipDuration:null,payMoney:0,vipDeadline:null,payType:null,payQr:null};e.memberList[1]=angular.copy(r),e.memberList[1].vipDuration=12,e.memberList[1].payMoney=490,e.memberList[1].payType="wechat",e.memberList[2]=angular.copy(r),e.memberList[2].vipDuration=12,e.memberList[2].payMoney=2990,e.memberList[2].payType="wechat",e.memberUpgradeData.username=a.username,e.memberUpgradeData.vipLevel=a.vip_level,e.memberUpgradeData.vipDeadline=a.vip_deadline,e.memberUpgradeData.openData=e.memberList[t],(0==e.memberUpgradeData.vipLevel||t>=e.memberUpgradeData.vipLevel)&&e.changeQrCode()},e.changeQrCode=function(){var a="";a+="vip_level="+e.memberUpgradeData.selectedLevel,a+="&vip_duration="+e.memberUpgradeData.openData.vipDuration,a+="&pay_type="+e.memberUpgradeData.openData.payType,a+="&t="+(new Date).getTime(),e.memberList[e.memberUpgradeData.selectedLevel].payQr="/api/pay/qrcode?"+a},e.changeVipLevelTab=function(a){e.memberUpgradeData.selectedLevel=a,e.memberUpgradeData.openData=e.memberList[a],e.changeQrCode()},e.changeVipDuration=function(a){e.memberUpgradeData.openData.vipDuration=a,e.memberUpgradeData.openData.payMoney=n[e.memberUpgradeData.selectedLevel][a],e.changeQrCode()},e.changePayType=function(a){e.memberUpgradeData.openData.payType=a,e.changeQrCode()},e.upgradeResult=function(){r.open({template:"/static/pay/member/view/upgrade_result.html",className:"ngdialog-theme-default ngDialog-width-360",scope:e})},e.init()}angular.module("BC.controllers.pay").controller("memberUpgradeCtrl",e),e.$inject=["$scope","$rootScope","commonService","ngDialog","$stateParams"]}();
;!function(){function t(t,r){var n=0,i=0;try{n=t.toString().split(".")[1].length}catch(o){}try{i=r.toString().split(".")[1].length}catch(o){}var h=Math.pow(10,Math.max(n+1,i+1));return(t*h+r*h)/h}function r(t,r){var n=0,i=0;try{n=t.toString().split(".")[1].length}catch(o){}try{i=r.toString().split(".")[1].length}catch(o){}return t*Math.pow(10,n+1)*r*Math.pow(10,i+1)/Math.pow(10,n+i+2)}function n(t,r){var n=0,i=0;try{n=t.toString().split(".")[1].length}catch(o){}try{i=r.toString().split(".")[1].length}catch(o){}var h=Math.pow(10,Math.max(n,i));return t*h/(r*h)}Number.prototype.add=function(r){return t.call(this,this,r)},Number.prototype.sub=function(t){return this.add(-t)},Number.prototype.mul=function(t){return r.call(this,this,t)},Number.prototype.div=function(t){return n.call(this,this,t)}}();
;!function(){Highcharts.dateFormats={Q:function(t){var e=new Date(t),a=e.getMonth()+1;return Math.ceil(a/3)}},function(t){"object"==typeof module&&module.exports?module.exports=t:t(Highcharts)}(function(t){!function(t){"use strict";function e(){return!!this.points.length}function a(){var t=this;t.hasData()?t.hideNoData():t.showNoData()}var i=t.seriesTypes,r=t.Chart.prototype,n=t.getOptions(),o=t.extend,l=t.each;o(n.lang,{noData:"No data to display"}),n.noData={position:{x:0,y:0,align:"center",verticalAlign:"middle"}},n.noData.style={fontWeight:"bold",fontSize:"12px",color:"#666666"},l(["pie","gauge","waterfall","bubble","treemap"],function(t){i[t]&&(i[t].prototype.hasData=e)}),t.Series.prototype.hasData=function(){return this.visible&&void 0!==this.dataMax&&void 0!==this.dataMin},r.showNoData=function(t){var e=this,a=e.options,i=t||a.lang.noData,r=a.noData;e.noDataLabel||(e.noDataLabel=e.renderer.label(i,0,0,null,null,null,r.useHTML,null,"no-data"),e.noDataLabel.attr(r.attr).css(r.style),e.noDataLabel.add(),e.noDataLabel.align(o(e.noDataLabel.getBBox(),r.position),!1,"plotBox"))},r.hideNoData=function(){var t=this;t.noDataLabel&&(t.noDataLabel=t.noDataLabel.destroy())},r.hasData=function(){for(var t=this,e=t.series,a=e.length,i=e[0]&&"treemap"==e[0].userOptions.type;a--;)if(e[a].hasData()&&!e[a].options.isInternal||i)return!0;return!1},r.callbacks.push(function(e){t.addEvent(e,"load",a),t.addEvent(e,"redraw",a)})}(t)}),function(t){t.wrap(t.seriesTypes.pie.prototype,"drawPoints",function(e){0==this.options.borderWidth&&t.each(this.points,function(t){t.pointAttr[""]&&(t.pointAttr[""]["stroke-width"]=1,t.pointAttr[""].stroke=t.pointAttr[""].fill,t.pointAttr.hover["stroke-width"]=1,t.pointAttr.hover.stroke=t.pointAttr.hover.fill,t.pointAttr.select["stroke-width"]=1,t.pointAttr.select.stroke=t.pointAttr.select.fill)}),e.apply(this)})}(Highcharts),function(t){var e=t.each;t.wrap(t.Legend.prototype,"renderItem",function(t,a){function i(t,a,i){e(a,function(a){a!==t&&e(["group","markerGroup"],function(t){a[t].attr("opacity",i)})})}t.call(this,a);var r=this.chart,n=r.series,o=(this.options.useHTML?a.legendItem:a.legendGroup).element,l=r.userOptions.chart.type;if("pie"==l)o.onmouseover=function(){r.tooltip.refresh(r.series[0].data[$(o).parents(".highcharts-legend-item").index()])},o.onmouseout=function(){r.tooltip.hide()};else{if("map"==l)return!1;o.onmouseover=function(){i(a,n,.25)},o.onmouseout=function(){i(a,n,1)}}})}(Highcharts),function(t){t.wrap(t.Axis.prototype,"normalizeTimeTickInterval",function(t){var e=t.apply(this,[].slice.call(arguments,1));return e.count<arguments[1]/e.unitRange&&e.unitRange<=6048e5&&e.count++,e})}(Highcharts),function(t){t.wrap(t.seriesTypes.column.prototype,"translate",function(e){var a=this.options,i=a.borderRadiusTopLeft||0,r=a.borderRadiusTopRight||0,n=a.borderRadiusBottomRight||0,o=a.borderRadiusBottomLeft||0,l=a.topMargin||0,s=a.bottomMargin||0;e.call(this),(i||r||n||o)&&t.each(this.points,function(e){var a=e.shapeArgs,d=a.width,h=a.height,c=a.x,p=a.y;e.dlBox=e.shapeArgs,e.shapeType="path",e.originShapeArgs=t.extend({},e.shapeArgs),e.shapeArgs={d:["M",c+i,p+l,"L",c+d-r,p+l,"C",c+d-r/2,p,c+d,p+r/2,c+d,p+r,"L",c+d,p+h-n,"C",c+d,p+h-n/2,c+d-n/2,p+h,c+d-n,p+h+s,"L",c+o,p+h+s,"C",c+o/2,p+h,c,p+h-o/2,c,p+h-o,"L",c,p+i,"C",c,p+i/2,c+i/2,p,c+i,p,"Z"]}})})}(Highcharts),function(t){var e=t;e.map,e.each,e.stableSort,drawPieDataLabels=function(t){var a,i,r,n,o,l=t.options,s=l.dataLabels,d=t.points,h=t.hasRendered||0,c=e.pick(s.defer,!0),p=t.chart.renderer;(s.enabled||t._hasPointLabels)&&(t.dlProcessOptions&&t.dlProcessOptions(s),o=t.plotGroup("dataLabelsGroup","data-labels",c&&!h?"hidden":"visible",s.zIndex||6),c&&(o.attr({opacity:+h}),h||e.addEvent(t,"afterAnimate",function(){t.visible&&o.show(!0),o[l.animation?"animate":"attr"]({opacity:1},{duration:200})})),i=s,e.each(d,function(d){var h,c,u,f,m,g,y=e.extend,v=d.connector,_=!0,b={};a=d.dlOptions||d.options&&d.options.dataLabels;var x,C=d.dataLabel,w=d.dataLabel2;if(d.shapeArgs,h=e.pick(a&&a.enabled,i.enabled)&&null!==d.y,C&&!h)d.dataLabel=C.destroy(),w&&(d.dataLabel2=w.destroy());else{if(s=e.merge(i,a),g=s.style,x=s.style2,m=s.rotation,c=d.getLabelConfig(),r=s.format?format(s.format,c):s.formatter.call(c,s,"showPercentage"),x&&(n=s.format?format(s.format,c):s.formatter.call(c,s,"showConnectorLabel")),g.color=e.pick(s.color,g.color,t.color,"#000000"),x&&(x.color=e.pick(s.color,x.color,t.color,"#000000")),C)defined(r)?(C.attr({text:r}),_=!1):d.dataLabel=C=C.destroy();else if(defined(r)){u={fill:s.backgroundColor,stroke:s.borderColor,"stroke-width":s.borderWidth,r:s.borderRadius||0,rotation:m,padding:s.padding,zIndex:1},"contrast"===g.color&&(b.color=s.inside||s.distance<0||l.stacking?p.getContrast(d.color||t.color):"#000000"),l.cursor&&(b.cursor=l.cursor);for(f in u)void 0===u[f]&&delete u[f];C=d.dataLabel=p[m?"text":"label"](r,0,-9999,s.shape,null,null,s.useHTML,null,"data-label").attr(u),C.addClass("highcharts-data-label-color-"+d.colorIndex+" "+(s.className||"")),C.css(e.extend(g,b)),C.add(o),C.shadow(s.shadow),n&&(w=d.dataLabel2=p[m?"text":"label"](n,0,99,s.shape,null,null,s.useHTML,null,"data-label").attr(u),w.addClass("highcharts-data-label-color-"+d.colorIndex+" "+(s.className||"")),w.css(e.extend(x,b)),w.add(o),w.shadow(s.shadow))}if(w)defined(n)?(w.attr({text:n}),_=!1):(d.dataLabel2=w=w.destroy(),v&&(d.connector=v.destroy()));else if(defined(n)){u={fill:s.backgroundColor,stroke:s.borderColor,"stroke-width":s.borderWidth,r:s.borderRadius||0,rotation:m,padding:s.padding,zIndex:1},"contrast"===x.color&&(b.color=s.inside||s.distance<0||l.stacking?p.getContrast(d.color||t.color):"#000000"),l.cursor&&(b.cursor=l.cursor);for(f in u)void 0===u[f]&&delete u[f];w=d.dataLabel2=p[m?"text":"label"](r,0,-9999,s.shape,null,null,s.useHTML,null,"data-label").attr(u),w.addClass("highcharts-data-label-color-"+d.colorIndex+" "+(s.className||"")),w.css(y(x,b)),w.add(o),w.shadow(s.shadow),n&&(w=d.dataLabel2=p[m?"text":"label"](n,0,99,s.shape,null,null,s.useHTML,null,"data-label").attr(u),w.addClass("highcharts-data-label-color-"+d.colorIndex+" "+(s.className||"")),w.css(y(x,b)),w.add(o),w.shadow(s.shadow))}C&&t.alignDataLabel(d,C,s,null,_),w&&t.alignDataLabel(d,w,s,null,_)}}))},e.wrap(e.seriesTypes.pie.prototype,"drawDataLabels",function(){var t,a,i,r,n,o,l,s,d,h,c,p,u,f=(e.addEvent,e.arrayMax),m=(e.defined,e.each),g=(e.extend,e.format,e.map),y=(e.merge,e.noop,e.pick),v=(e.relativeLength,e.Series,e.seriesTypes,e.stableSort,this),y=e.pick,_=v.data,b=v.chart,x=v.options.dataLabels,C=y(x.connectorPadding,10),w=y(x.connectorWidth,1),k=b.plotWidth,A=b.plotHeight,S=x.distance,D=(x.pieTextPadding,v.center),$=D[2]/2,M=D[1],T=[[],[]],L=[[],[]],E=[0,0,0,0];v.visible&&(x.enabled||v._hasPointLabels)&&(drawPieDataLabels(v),m(_,function(t){t.dataLabel&&t.visible&&(L[t.half].push(t),t.dataLabel._pos=null)}),m(L,function(a,f){var m,y,_,w,L,O=a.length;if(O)for(v.sortByAngle(a,f-.5),a[0].dataLabel2&&(S=v.adjustDistance(a[0]),m=Math.max(0,M-$-S),y=Math.min(M+$+S,b.plotHeight),_=g(a,function(t){return t.dataLabel2?(L=1,{target:t.labelPos[1]-m+L/2,size:L,rank:t.y}):void 0}),e.distribute(_,y+L-m)),u=0;O>u;u++){if(t=a[u],n=t.labelPos,i=t.dataLabel,dataLabel2=t.dataLabel2,p=c=t.visible===!1?"hidden":"inherit",w=n[1],dataLabel2)if(_&&void 0===_[u].pos)p="hidden";else{var P=t.dataLabel2.text&&t.dataLabel2.text.element.getBoundingClientRect().height;h=Math.round(t.label2Pos[3]-P/5),0==T[f].length||h-T[f][T[f].length-1]>P?T[f].push(h):p="hidden"}if(i&&(d=w),dataLabel2){var F,N=t.dataLabel2.text&&t.dataLabel2.text.element.getBoundingClientRect().width;F=$>300?.45*$:$>150&&300>=$?200:$>110&&150>=$?$:1.35*$;var z=Math.min(b.plotWidth/2-$-15,F);s=D[0]+(f?-1:1)*($+z-N/2)}i&&(l=v.getX(m+2>d||d>y-2?w:d,f,t)),i._attr={visibility:c,align:n[6]},i._pos={x:l+x.x+({left:C,right:-C}[n[6]]||0),y:d+x.y-10},n.x=l,n.y=d,dataLabel2&&(dataLabel2._attr={visibility:p,align:n[6]},dataLabel2._pos={x:s+x.x+({left:C,right:-C}[n[6]]||0),y:h+x.y-10},n.x2=s,n.y2=h),null===v.options.size&&(r=i.width,C>l-r?E[3]=Math.max(Math.round(r-l+C),E[3]):l+r>k-C&&(E[1]=Math.max(Math.round(l+r-k+C),E[1])),0>d-o/2?E[0]=Math.max(Math.round(-d+o/2),E[0]):d+o/2>A&&(E[2]=Math.max(Math.round(d+o/2-A),E[2])))}}),(0===f(E)||this.verifyDataLabelOverflow(E))&&(this.placeDataLabels(),m(this.points,function(t){var e;a=t.connector,dataLabel2=t.dataLabel2,dataLabel2&&(dataLabel2&&dataLabel2._pos&&t.visible?(c=dataLabel2._attr.visibility,e=!a,e&&(t.connector=a=b.renderer.path().addClass("highcharts-data-label-connector highcharts-color-"+t.colorIndex).add(v.dataLabelsGroup),a.attr({"stroke-width":w,stroke:x.connectorColor||t.color||"#666666"})),a[e?"attr":"animate"]({d:v.connectorPath(t)}),a.attr("visibility",c)):a&&(t.connector=a.destroy()))})))}),e.wrap(e.seriesTypes.pie.prototype,"connectorPath",function(t){t.apply(this,[].slice.call(arguments,1));var e,a=arguments[1],i=a.labelPos,r=a.label2Pos,n=a.dataLabel2.text.element,o=n.getBoundingClientRect().width,l=n,s=i.x2,d=(i.y2,i.x,i.y,s+(a.half?1:-1)*(o/2+2)-r[2]>0?1:-1),h=a.half>0?-1:1;return d*h>0?(l.style.opacity=1,e=["M",r[0],r[1],"L",r[2],r[3],"H",s+(a.half?1:-1)*(o/2+2)]):(l.style.opacity=0,e=""),e}),e.wrap(e.seriesTypes.pie.prototype,"placeDataLabels",function(){e.each(this.points,function(t){var e,a=t.dataLabel,i=t.dataLabel2;a&&t.visible&&(e=a._pos,e?(a.attr(a._attr),a[a.moved?"animate":"attr"](e),a.moved=!0):a&&a.attr({y:-9999})),i&&t.visible&&(e=i._pos,e?(i.attr(i._attr),i[i.moved?"animate":"attr"](e),i.moved=!0):i&&i.attr({y:-9999}))})})}(Highcharts),!function(t){var e={}.hasOwnProperty,a=a||2,i={getMapMeta:function(t){$.ajax({type:"GET",async:!1,url:"/static/js/mapData/geoJson/"+t+".js",dataType:"script"})},mapType:["中国","广东","青海","四川","海南","陕西","甘肃","云南","湖南","湖北","黑龙江","贵州","山东","江西","河南","河北","山西","安徽","福建","浙江","江苏","吉林","辽宁","台湾","新疆","广西","宁夏","内蒙古","西藏","北京","天津","上海","重庆","香港","澳门","广东省","青海省","四川省","海南省","陕西省","甘肃省","云南省","湖南省","湖北省","黑龙江省","贵州省","山东省","江西省","河南省","河北省","山西省","安徽省","福建省","浙江省","江苏省","吉林省","辽宁省","台湾","新疆新疆维吾尔自治区","广西壮族自治区","宁夏回族自治区","内蒙古自治区","西藏自治区","北京市","天津市","上海市","重庆市","香港特别行政区","澳门特别行政区","台湾省","宁夏回族"],cityMap:{"安徽":"an_hui","澳门":"ao_men","北京":"bei_jing","重庆":"chong_qing","福建":"fu_jian","甘肃":"gan_su","广东":"guang_dong","广西":"guang_xi","贵州":"gui_zhou","海南":"hai_nan","河北":"he_bei","河南":"he_nan","黑龙江":"hei_long_jiang","湖北":"hu_bei","湖南":"hu_nan","吉林":"ji_lin","江苏":"jiang_su","江西":"jiang_xi","辽宁":"liao_ning","内蒙古":"nei_meng_gu","宁夏":"ning_xia","青海":"qing_hai","山东":"shan_dong","山西":"shan_xi_2","陕西":"shan_xi_1","上海":"shang_hai","四川":"si_chuan","台湾":"tai_wan","天津":"tian_jin","西藏":"xi_zang","香港":"xiang_gang","新疆":"xin_jiang","云南":"yun_nan","浙江":"zhe_jiang","世界":"world","中国":"china","安徽省":"an_hui","澳门特别行政区":"ao_men","北京市":"bei_jing","重庆市":"chong_qing","福建省":"fu_jian","甘肃省":"gan_su","广东省":"guang_dong","广西省":"guang_xi","贵州省":"gui_zhou","海南省":"hai_nan","河北省":"he_bei","河南省":"he_nan","黑龙江省":"hei_long_jiang","湖北省":"hu_bei","湖南省":"hu_nan","吉林省":"ji_lin","江苏省":"jiang_su","江西省":"jiang_xi","辽宁省":"liao_ning","内蒙古自治区":"nei_meng_gu","宁夏回族自治区":"ning_xia","青海省":"qing_hai","山东省":"shan_dong","山西省":"shan_xi_2","陕西省":"shan_xi_1","上海市":"shang_hai","四川省":"si_chuan","台湾省":"tai_wan","天津市":"tian_jin","西藏自治区":"xi_zang","香港特别行政区":"xiang_gang","新疆新疆维吾尔自治区":"xin_jiang","云南省":"yun_nan","浙江省":"zhe_jiang","宁夏回族":"ning_xia"},inherit:function(t,a){function i(){this.constructor=t}for(var r in a)e.call(a,r)&&(t[r]=a[r]);return i.prototype=a.prototype,t.prototype=new i,t.__super__=a.prototype,t},getTimeZoneOffset:function(){var t=new Date,e=t.getTimezoneOffset();return e/60},isEmptyChart:function(t){var e,a,i,r;for(e=0,r=t.x.length;r>e;e++)if(0!==t.x[e].data.length)return!1;for(a=0,r=t.y.length;r>a;a++)if(0!==t.y[a].data.length)return!1;for(i=0,r=t.y_optional.length;r>i;i++)if(0!==t.y_optional[i].data.length)return!1;return!0},params:function(t){var e={};return $.each(t,function(t,a){e[t]=angular.isObject(a)?angular.toJson(a):a}),e},checkIsAllDataNull:function(t,e){if(!t[e][0])return!0;var a=0;return t[e].forEach(function(t){t.data.forEach(function(t){(null===t||"null"===t)&&a++})}),a===t[e][0].data.length*t[e].length},isDrillChart:function(t){return t&&t.drill_level>0},getGranularity:function(t,e,a){a=void 0===a?0:a;var i,r=t.x[a],n={year:bdp.utils.isLeapYear(r.data[r.data.length-1])?316224e5:31536e6,quarter:7776e6,month:26784e5,week:6048e5,day:864e5,hour:36e5,minute:6e4,second:1e3},o=r.granularity||"day",l=r.granularity_name||"";return o=n[o]?o:"day",i=n[o],"day"==o&&e>20&&(i=n.week),{tickInterval:i,granularity:o,granularity_name:l}},subDateFormat:function(t,e){var a,i=$.cookie("NG_TRANSLATE_LANG_KEY");if(i&&"zh"!=i){a={year:"{{v}}",quarter:"Q{{v}}",week:"Week {{v}}",day:"Day {{v}}",hour:"{{v}}H",minute:"{{v}}min",second:"{{v}}s"};var r=["","January","February","March","April","May","June","July","August","September","October","November","December"];return"month"==t?r[e]:(a[t]||"").replace("{{v}}",e)}return a={year:"年",quarter:"季度",month:"月",week:"周",day:"日",hour:"时",minute:"分",second:"秒"},e+(a[t]||"")},setGranularityByDate:function(t,e){var a;return a="hour"===t?2592e5>=e?"c_hour":"day":"minute"===t?108e5>=e?"c_minute":2592e5>=e?"c_hour":"day":"second"===t?18e4>=e?"c_second":36e5>=e?"c_minute":864e5>=e?"c_hour":"day":t},checkGranularity:function(t,e,a,r,n){if(e=+e,isNaN(e))return"NaN";n=n||$.cookie("NG_TRANSLATE_LANG_KEY");var o;o=n&&"zh"!=n?"abb"==n?{year:"%Y",quarter:"%Y-Q%Q",month:"%Y/%b",day:"%Y/%b/%d",hour:"%d %HH",minute:"%H:%M",second:"%M'%S''",c_hour:"%d %HH",c_minute:"%H:%M",c_second:"%M'%S''",g_hour:"%Y/%b/%d %H:00",g_minute:"%Y/%b/%d %H:%M",g_second:"%Y/%b/%d %H:%M:%S"}:{year:"%Y",quarter:"Q%Q-%Y",month:"%m-%Y",day:"%m/%d/%Y",hour:"%d %HH",minute:"%H:%M",second:"%M'%S''",c_hour:"%d %HH",c_minute:"%H:%M",c_second:"%M'%S''",g_hour:"%m/%d/%Y %HH",g_minute:"%m/%d/%Y %H:%M",g_second:"%m/%d/%Y %H:%M:%S"}:{year:"%Y年",quarter:"%Y年第%Q季度",month:"%Y年%m月",day:"%Y年%m月%d日",hour:"%d日%H时",minute:"%H时%M分",second:"%M分%S秒",c_hour:"%d日%H时",c_minute:"%H时%M分",c_second:"%M分%S秒",g_hour:"%Y年%m月%d日%H时",g_minute:"%Y年%m月%d日 %H时%M分",g_second:"%Y年%m月%d日 %H时%M分%S秒"};var l="",s=new Date(e);if("month"===t&&a){var d=new Date(e),h=d.getDate();r!==h&&(s=new Date(e-3456e5))}return t in o?l=Highcharts.dateFormat(o[t],s,!1):"week"===t&&"number"==typeof e&&(l=i.getWeekWithOffset(e,r)),l},getWeekNumber:function(t,e){for(var e=e?e:1,a=new Date(t),r=new Date(a.getFullYear(),0,1),n=1,o=0===r.getDay()?7:r.getDay();o!==e;)r=new Date(r.getTime()+864e5),o=0===r.getDay()?7:r.getDay();return t<r.getTime()?i.getWeekNumber(new Date(a.getFullYear(),0,1).getTime()-864e5,e):(n=Math.ceil((a-r)/6048e5)+1,{week:n,year:a.getFullYear()})},getWeekWithOffset:function(t,e){var a=$.cookie("NG_TRANSLATE_LANG_KEY"),r=i.getWeekNumber(t,e),n=r.year;return text=a&&"zh"!=a?"Week "+r.week+"-"+n:n+"年第"+r.week+"周"},checkPercentLabel:function(t,e,a,i){var r=!1;if(i=i?"y_optional":"y","C280"===a?("percent"==e[i][1].formatter.check||"PERCENTAGE"===e[i][1].aggregator)&&(r=!0):angular.forEach(e[i],function(t){("percent"==t.formatter.check||"PERCENTAGE"===t.aggregator)&&(r=!0)}),"C212"===a||"C242"===a||"C352"===a)return this.numericSymbols(t.value)+"%";if(r){var n=t.value,o=n.toString().split(".")[1]||void 0,l=0===n?2:o?o.length:2;return Highcharts.numberFormat(Number(n).mul(100),Math.max(0,l-2))+"%"}return this.numericSymbols(t.value)},getPositiveOrNegative:function(t,e,a){a=a||[];for(var i,r=0,n=0,o=0;o<t[e].length;o++)if(!(a.indexOf(o)>-1))for(var l=0;l<t[e][o].data.length;l++)if(i=Number(t[e][o].data[l]),0>i?n++:i>=0&&r++,n>0&&r>0)return"mix";return n>0?"negative":"positive"},getSumByColumnFromMultiArray:function(t,e,a,i){i=i||[];for(var r,n=0,o=[],l=0;l<t[e][0].data.length;l++){o[l]=0;for(var s=0;s<t[e].length;s++)i.indexOf(s)<0&&(r=1*t[e][s].data[l],o[l]="max"===a?o[l]+(r>0?r:0):o[l]+(0>r?r:0))}return n=Math[a].apply(null,o)},getEdgeValueFromMultiArray:function(t,e,a,i,r){r=r||[],e=e?"y_optional":"y";var n=Number["min"===a?"MAX_VALUE":"MIN_VALUE"];if("C320"===i){var o=[];t.x.length?angular.forEach(t[e][0].data,function(t,e){o.push((o[e-1]||0)+Number(t))}):angular.forEach(t[e],function(t,e){o.push((o[e-1]||0)+Number(t.data[0]))}),n=Math[a](Math[a].apply(null,o),o[0])}else for(var l=0;l<t[e].length;l++)r.indexOf(l)<0&&(n=Math[a](Math[a].apply(null,t[e][l].data),n));return(n===Number.MIN_VALUE||n===Number.MAX_VALUE)&&(n=0),n},numericSymbols:function(t,e){var a=Math.abs(t),i=e||2,r=t>=0?"":"-";if(1>=a)return t;var n=["","K","M","B","T","P","E"],o=1e3,l=Math.floor(Math.log(a).div(Math.log(o)));l=l>n.length?n.length:l;var s=r+Highcharts.numberFormat(a.div(Math.pow(1e3,l)).toFixed(i),-1)+n[l];return s.indexOf("undefined")>-1&&(s=t),s},numericSymbolsWithDigit:function(t){var e=Math.abs(t),a=t>=0?"":"-",i=["","K","M","B","T","P","E"],r=1e3,n=Math.floor(Math.log(e).div(Math.log(r)));n=0>n?0:n,n=n>i.length?i.length:n;var o=Highcharts.numberFormat(e.div(Math.pow(1e3,n)),-1),l=isInteger(o)?0:o.toString().split(".")[1].length;return a+Number(o).toFixed(Math.min(4,l))+i[n]},formatNumber:function(t,e){var a=e?e:4,r=0>t;t=Math.abs("number"==typeof t?t:Number(t));var n,o,l;if(0==t||1==t)return t*(r?-1:1);if(1>t)return l=t.toString().split(".")[1].length,o=t*Math.pow(10,l),i.formatNumber(r?-1*o:o,a)/Math.pow(10,l);if(4>t){if(e)return l=t!==Math.ceil(t)?t.toString().split(".")[1].length:1,o=t*Math.pow(10,l),i.formatNumber(r?-1*o:o,e)/Math.pow(10,l);n=Math.ceil(t)}else l=Math.floor(t).toString().length,o=l>1?a*Math.pow(10,l-2):a,n=o*Math.pow(10,l)*Math.ceil(t/o)/Math.pow(10,l);return n*(r?-1:1)},formatMapNum:function(t,e,a){var r=e?e:4,n=0>t;t=Math.abs("number"==typeof t?t:Number(t));var o,l,s;if(0==t||1==t)return t*(n?-1:1);if(1>t){if(s=t.toString().split(".")[1].length,l=t*Math.pow(10,s),"ceil"===a)return i.formatNumber(n?-1*l:l)/Math.pow(10,s);if("floor"===a)return i.formatMapNum(n?-1*l:l,r,"floor")/Math.pow(10,s)}else 4>t?"ceil"===a?o=Math.ceil(t):"floor"===a&&(o=Math.floor(t)):(s=Math.floor(t).toString().length,l=s>1?r*Math.pow(10,s-2):r,"ceil"===a?o=l*Math.pow(10,s)*Math.ceil(t/l)/Math.pow(10,s):"floor"===a&&(o=l*Math.pow(10,s)*Math.floor(t/l)/Math.pow(10,s)));return o*(n?-1:1)},dataLabelFormatter:function(t,e,a){var i=2;return t?(""!==t[t.check].digit&&(i=t[t.check].digit),e="num"==t.check&&t.num.millesimal?Highcharts.numberFormat(e,i,".",","):"num"==t.check?Highcharts.numberFormat(e,i,".",""):Highcharts.numberFormat(100*e,i,".","")+"%"):(("COUNT"==a||"COUNT_DISTINCT"==a)&&(i=0),e=Highcharts.numberFormat(e,i)),e},tooltipFormatter:function(t,e,n,o,l){var s,d=r.ChartType,h="C271"===e||"C272"===e||"C280"==e||"C370"==e?t.key:t.points[0].key,c=l.unit_left||"",p="",u=!1,f=!1,m=!0;if("C370"===e){var g=t.point.parent;if(g){var y=h,v=t.series.nodeMap[g].name;h=v+" - "+y}else s=h}if("C320"===e&&(u=0===t.points[0].point.index&&0===t.points[0].point.category,f=t.points[0].point.isSum,(!o.xAxis.length||o.xAxis.length&&f)&&(m=!1)),1===n.x.length&&"date"===o.xAxis[0].data_type&&"C370"!==e){var _=o.xAxis[0],b=_.granularity||"day",x=_.granularity_name||"",C=_.month_start_day||0;"week"===b?(x&&(h+=864e5*(_.week_start_day_of_week-1)),C=_.week_start_day_of_week):("hour"===b||"minute"===b||"second"===b)&&(b="g_"+b),s=i.checkGranularity(b,h,x,C),"week"===b&&(s+="（"+Highcharts.dateFormat("%m/%d",new Date(h))+"~"+Highcharts.dateFormat("%m/%d",new Date(h+5184e5))+"）")}else if(1===n.x.length&&"sub_date"===n.x[0].data_type&&"C370"!==e){var w=n.x[0].fid.split("_")[1];s=i.subDateFormat(w,h)}else{var k=[d.Column,d.NStackColumn,d.PStackColumn,d.Bar,d.NStackBar,d.PStackBar,d.Line,d.Waterfall,d.TreeMap].indexOf(e)>-1;s=2===n.x.length&&k&&!f&&t.x&&t.x.parent?t.x.parent.name+" - "+t.x.name:h}m&&(p=0===n.x.length&&0===h?"":'<p class="text-center tooltips-title">'+s+"</p>"),p+='<table class="tooltips-table">';var A;if("C351"===e||"C211"===e||"C241"===e){var S=$.cookie("locale")||"zh",D="",M="en"===S?"Total":"总计",T="",L="",E="",O=0,P=0;$.each(t.points,function(t){var e;D=this.total,D>=0?O=D:P=D,T=this.series.options.aggregator,E=n.y_optional?n.y.concat(n.y_optional):n.y,e=E[this.series._i]||E[t],L=e.formatter}),D=O+P,D=i.dataLabelFormatter(L,D,T),p+='<tr><td style="text-align: right; " class="total">'+M+'：</td><td style="text-align: left; " class="total">'+D+"</td></tr>"}if("C370"===e){var F=1==a?"#FFF":t.color,N="en"==r.language?"count":"数值",z="en"==r.language?"rate":"占比",B=n.y[0]&&n.y[0].nick_name||n.y[0]&&n.y[0].name||N,I=n.y[0]&&i.dataLabelFormatter(n.y[0].formatter,t.point.value,n.y[0].aggregator)||t.point.value,H=t.point.sum||t.point.series.nodeMap[""].val,W=t.point.value/H*100;B+="：",p+='<tr><td style="text-align:right;color:'+t.color+'">'+$.trim(bdp.utils.encodeHTML(B))+'</td><td style="text-align: left; color:'+F+'">'+I+'</td></tr><tr><td style="text-align: right;color:'+t.color+'">'+$.trim(bdp.utils.encodeHTML(""+z+"："))+'</td><td style="text-align: left; color:'+F+'">'+W.toFixed(2)+"% </td></tr>"}if("C271"===e||"C272"===e||"C280"==e){var R,j,L=n.y[0].formatter,B=n.y[0].nick_name||n.y[0].name;"C271"===e?(R=t.point.value,A=t.point.color||"#72AFD9"):"C272"===e&&(R=t.point.z,A=t.point.color);var q="";n.y[0].hasOwnProperty("unit_adv")&&(j=n.y[0].unit_adv),q=""!=j?j:c,p+='<tr><td style="text-align:right;color:'+A+'">'+$.trim(bdp.utils.encodeHTML(B))+'</td><td style="text-align: left; color:'+A+'">： '+i.dataLabelFormatter(L,R)+q+"</td></tr>"}else if("C290"!=e||0!=n.x.length||t.points[0].series.options.name)"C370"!=e&&$.each(t.points,function(t){var r,s=this,d=1==a?"#FFF":s.series.color,h=s.series._i;if("C320"===e){if(r=s.point.nick_name||s.point.name,f){var u=$.cookie("locale")||"zh";r=o.waterfall_setting?o.waterfall_setting.sum_name:"en"===u?"Sum":"累计值"}}else r=s.series.options.nick_name||s.series.options.name;r+="：";var m,g=s.series.options.formatter,y=s.series.options.aggregator,v=s.y,_="",b="";if(s.series.options.hasOwnProperty("unit_adv")&&(b=s.series.options.unit_adv),"C212"===e||"C242"===e||"C352"===e){var x="";x=""!=b?b:c,v=i.dataLabelFormatter(g,v,y),p+='<tr><td style="text-align:right;color:'+s.series.color+'">'+$.trim(bdp.utils.encodeHTML(r))+'</td><td style="text-align: left; color:'+d+'">'+v+x+"（"+s.percentage.toFixed(1)+"%）</td></tr>"}else{var C=n.y_optional?n.y.concat(n.y_optional):n.y,w=C[h]||C[t];if(v=i.dataLabelFormatter(w.formatter,v,y),"C250"===e){var k=o.type_optional;s.series.options.yAxis&&(c=o.zero_aligned?l.unit_left||"":l.unit_right||"");var S=k[s.series.options.yAxis];"column"===s.series.options.type&&"C212"===S&&(_="（"+s.percentage.toFixed(1)+"%）")}"C290"===e&&(c=""),m=""!=b?v+b+_:v+c+_,A=s.point.color||s.series.color,d=1==a?"#FFF":A,p+='<tr><td style="text-align:right;color:'+A+'">'+$.trim(bdp.utils.encodeHTML(r))+'</td><td style="text-align: left; color:'+d+'">'+m+"</td></tr>"}});else{var G=t.points[0].series;p='<table class="tooltip-table"><tr> <td style="text-align: right;color:'+G.color+'">'+t.points[0].key+'</td><td style="text-align: left;color:'+G.color+'">：'+i.dataLabelFormatter(n.y[0].formatter,t.y)+"</td></tr>"}return p+="</table>"},legendFormatter:function(t){var e=t.options.nick_name||t.options.name;e=e.replace(/^\s+/,"");var a=10,i=e.length>a?e.substring(0,a-1)+"...":e;return'<div title="'+e+'">'+bdp.utils.encodeHTML(i)+"</div>"},generateTitle:function(t,e,a){var i="",r=e.summary.supply_summary||[];if("C230"!==t&&"C250"!==t&&1==e.y.length&&1===r.length)for(var n=0,o=r.length;o>n;n++){var l=r[n];i=i+'<div class="hz-chart-title-wrap nowrap"><span class="hz-chart-title-text" title="'+l.s_value+'">'+l.s_value+'</span><span class="hz-chart-title-default">'+l.s_title+"  </span></div>"}return a.hasOwnProperty("show_total")&&!a.show_total&&(i=""),i},getAdjustValue:function(t,e){var a,i,r=Math.abs(t.sub(e)),n=0;if(1>r)for(;1>r;)r=r.mul(10),n++;var o=1..div(Math.pow(10,n));return n-1>0?(a=Math.ceil(t.mul(Math.pow(10,n))).div(Math.pow(10,n)),i=Math.floor(e.mul(Math.pow(10,n))).div(Math.pow(10,n))):0>n-1?(a=Math.ceil(t),i=Math.floor(e)):(a=Math.ceil(t.mul(Math.pow(10,n))).div(Math.pow(10,n)),i=Math.floor(e)),{max:a,min:i,increment:o}},linearRangeColor:function(t,e){var a=d3.rgb(t),i=d3.rgb(e);return d3.interpolate(a,i)},createLinearScale:function(t,e){var a,i;a=defined(t.max)&&!t.disable_max?t.max:d3.max(e),i=defined(t.min)&&!t.disable_min?t.min:d3.min(e);var r=d3.scale.linear().domain([i,a]).range([0,1]);return function(t){var e=r(t);return isNaN(e)?e=0:(e=Math.max(e,0),e=Math.min(e,1)),e}},renderLinearGradient:function(t,e,a,i){var r=d3.interpolate(e,a),n={moz:"-moz",webkit:"-webkit",ms:"-ms",o:"-o"},o="-linear-gradient(left, "+e+", ",l=a+")",s="";if(i>1)for(var d=1,h=i;h>d;d++){var c=r((d-1)/(h-1)),p=r(d/(h-1));s+=c+" "+d/h*100+"%, "+p+" "+d/h*100+"%, "}angular.forEach(n,function(e){t.css({background:e+o+s+l})})},createLinearGradientCss:function(t,e,a){var i=d3.interpolate(t,e),r={moz:"-moz",webkit:"-webkit",ms:"-ms",o:"-o"},n="-linear-gradient(left, "+t+", ",o=e+")",l="";if(a>1)for(var s=1,d=a;d>s;s++){var h=i((s-1)/(d-1)),c=i(s/(d-1));l+=h+" "+s/d*100+"%, "+c+" "+s/d*100+"%, "}var p="";return angular.forEach(r,function(t){p+="background: "+t+n+l+o+";"}),p},polynomial:function(t){return function(e){for(var a=0,i=t.length,r=0;i>r;)a+=t[r]*Math.pow(e,r),r++;return a}},isMobile:function(){if(void 0===i._isMobile){var t=function(){var t=navigator.userAgent,e=/(?:Windows Phone)/.test(t),a=/(?:SymbianOS)/.test(t)||e,i=/(?:Android)/.test(t),r=/(?:Firefox)/.test(t),n=(/(?:Chrome|CriOS)/.test(t),/(?:iPad|PlayBook)/.test(t)||i&&!/(?:Mobile)/.test(t)||r&&/(?:Tablet)/.test(t)),o=/(?:iPhone)/.test(t)&&!n,l=o||i||e||a,s=!o&&!i&&!a;return{isTablet:n,isIPhone:o,isAndroid:i,isMobile:l,isPc:s}}();i._isMobile=t.isMobile&&$("body").width()<=667}return i._isMobile},getPixelRatio:function(e){var a=e.backingStorePixelRatio||e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1,i=(t.devicePixelRatio||1)/a;return i},initLoadingStatus:function(t){var t=t?t:"";return $('<div class="base-loading-layer"><div class="loader-outer '+t+'"><div class="loader-inner line-scale-pulse-out-rapid"><div></div><div></div><div></div><div></div><div></div></div></div></div>')},escapeHtml:function(t){if(t&&t.length>0){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return String(t).replace(/[&<>"'\/]/g,function(t){return e[t]})}return t},filterNullVal:function(t){for(var e=t.y[0].data,a=e.length,i=[],r=[],n=0;a>n;n++)null!==e[n]&&(i.push(t.x[0].data[n]),r.push(e[n]));return t.x[0].data=i,t.y[0].data=r,t}},r=t.bdpChart||{};t.bdpChart=r,r.helper=i}(window),!function(t){function e(){}function a(t,e,a){if(t){var i=0,r=t.length,n=e[0],o=e[1],l=e[2],s=!0;switch(e.length){case 0:for(;r>i;i+=2)s=t[i].call(t[i+1]||a)!==!1&&s;break;case 1:for(;r>i;i+=2)s=t[i].call(t[i+1]||a,n)!==!1&&s;break;case 2:for(;r>i;i+=2)s=t[i].call(t[i+1]||a,n,o)!==!1&&s;break;case 3:for(;r>i;i+=2)s=t[i].call(t[i+1]||a,n,o,l)!==!1&&s;break;default:for(;r>i;i+=2)s=t[i].apply(t[i+1]||a,e)!==!1&&s}}return s}function i(t){return"[object Function]"===Object.prototype.toString.call(t)}var r=/\s+/;e.prototype.on=function(t,e,a){var i,n,o;if(!e)return this;for(i=this.__events||(this.__events={}),t=t.split(r);n=t.shift();)o=i[n]||(i[n]=[]),o.push(e,a);return this},e.prototype.once=function(t,e,a){var i=this,r=function(){i.off(t,r),e.apply(this,arguments)};this.on(t,r,a)},e.prototype.off=function(t,e,a){var i,o,l,s;if(!(i=this.__events))return this;if(!(t||e||a))return delete this.__events,this;for(t=t?t.split(r):n(i);o=t.shift();)if(l=i[o])if(e||a)for(s=l.length-2;s>=0;s-=2)e&&l[s]!==e||a&&l[s+1]!==a||l.splice(s,2);else delete i[o];return this},e.prototype.trigger=function(t){var e,i,n,o,l,s,d=[],h=!0;if(!(e=this.__events))return this;for(t=t.split(r),l=1,s=arguments.length;s>l;l++)d[l-1]=arguments[l];for(;i=t.shift();)(n=e.all)&&(n=n.slice()),(o=e[i])&&(o=o.slice()),h=a(o,d,this)&&h,h=a(n,[i].concat(d),this)&&h;return h},e.prototype.emit=e.prototype.trigger,e.mixTo=function(t){t=i(t)?t.prototype:t;var a=e.prototype;for(var r in a)a.hasOwnProperty(r)&&(t[r]=a[r])};var n=Object.keys;return n||(n=function(t){var e=[];for(var a in t)t.hasOwnProperty(a)&&e.push(a);return e}),t.Events=e}(window.bdpChart),!function(t,e){function a(t,e){switch(t){case r.Column:return{type:"column"};case r.NStackColumn:return{type:"column",plotOptions:{column:{stacking:"normal"}}};case r.PStackColumn:return{type:"column",plotOptions:{column:{stacking:"percent"}}};case r.Line:return{type:+e.use_spline?"spline":"line"};default:return{}}}var i={1:{marker:{enabled:!1,symbol:"circle",lineColor:null,lineWidth:2,radius:3,fillColor:"rgba(255,255,255,0)",states:{hover:{enabled:!0,lineColor:"#FFF",lineWidth:3,radius:3,fillColor:"rgba(255,255,255,0)"}}},halo:{opacity:1,size:8,attributes:{zIndex:2,fill:"rgba(255,255,255,0.15)","stroke-width":6,stroke:"rgba(255,255,255,0.05)"}}},2:{marker:{enabled:!1,symbol:"circle",lineColor:null,lineWidth:2,radius:3,fillColor:"#FFF",states:{hover:{enabled:!0,lineColor:null,lineWidth:3,radius:3,fillColor:"#FFF"}}},halo:{opacity:.3,size:8,attributes:{zIndex:2,"stroke-width":6}}}},r={Table:"C200",Column:"C210",NStackColumn:"C211",PStackColumn:"C212",Line:"C220",Pie:"C230",Bar:"C240",NStackBar:"C241",PStackBar:"C242",Biax:"C250",Gauge:"C261",AreaMap:"C271",BubbleMap:"C272",Scatter:"C280",Radar:"C290",Sankey:"C300",KPICard:"C310",Waterfall:"C320",Funnel:"C330",WordCloud:"C340",Area:"C350",NStackArea:"C351",PStackArea:"C352",Sunburst:"C360",TreeMap:"C370",GIS:"C400"};e.ChartType=r;var n={},o=e.helper,l=function(t,e){n[t]=e};l(r.Column,function(){return{chart:{type:"column"},plotOptions:{column:{borderRadius:1.7}}}}),l(r.NStackColumn,function(){return{chart:{type:"column"},plotOptions:{column:{stacking:"normal"}}}}),l(r.PStackColumn,function(){return{chart:{type:"column"},plotOptions:{column:{stacking:"percent"}}}}),l(r.Line,function(t){var e=+t.info.use_spline?"spline":"line",a="dark"===t.theme?1:2;return{chart:{type:e},plotOptions:{line:{lineWidth:4,marker:i[a].marker,states:{hover:{halo:i[a].halo}}},spline:{lineWidth:3,marker:i[a].marker,states:{hover:{halo:i[a].halo}}}}}}),l(r.Pie,function(t){t.$elem.addClass("chart-pie");var e=t.info,a=t.data,i="",r="",n=e.xAxis.length,l="fullscreen"===t.mode?30:10,s="dark"===t.theme?"#fff":"#777";return n&&"date"===e.xAxis[0].data_type&&(i=e.xAxis[0].granularity,r=e.xAxis[0].granularity_name,gConfig=e.xAxis[0].month_start_day||0),{chart:{type:"pie"},legend:{labelFormatter:function(){var t=n||e.compare_axis.length?0:this.index,s=(this.series.options.formatter,this.series.options.aggregator,this.percentage.toFixed(2)+"%",""),d="";if(i){var h=this.x;"week"===i&&r&&(h+=864e5*(e.xAxis[0].week_start_day_of_week-1),gConfig=e.xAxis[0].week_start_day_of_week),d=s=["其它","Else"].indexOf(this.options.x)>=0?this.options.x:o.checkGranularity(i,h,r,gConfig)}else d=n?this.name:$.trim(a.y[t].nick_name||a.y[t].name),d=d.toString().replace(/^\s+/,""),s=d.length>l?d.substring(0,l-1)+"...":d;return'<div title="'+d+'">'+bdp.utils.encodeHTML(s)+"</div>"}},tooltip:{crosshairs:null,formatter:function(){var t=($.cookie("NG_TRANSLATE_LANG_KEY"),this.y),l=this.series.options.formatter,d=this.series.options.aggregator,h="",c=n||e.compare_axis.length?0:this.point.index;if(i){var p=this.point.x;"week"===i?r&&(p+=864e5*(e.xAxis[0].week_start_day_of_week-1),gConfig=e.xAxis[0].week_start_day_of_week):("hour"===i||"minute"===i||"second"===i)&&(i="g_"+i);var u=this.point.index||0,f=this.series.data&&this.series.data[u];h=["其它","Else"].indexOf(f.options.x)>=0?f.options.x:o.checkGranularity(i,p,r,gConfig)}else h=n?this.point.name:$.trim(a.y[c].nick_name||a.y[c].name);var m="";a.y[c].hasOwnProperty("unit_adv")&&""!=a.y[c].unit_adv&&(m=a.y[c].unit_adv),t=o.dataLabelFormatter(l,t,d);var g='<table class="tooltips-table">';return g+='<tr><td style="text-align:right;color:'+this.point.color+'">'+h+'</td><td style="text-align: left; color:'+this.point.color+'">：'+t+m+"</td></tr>",g+='<tr><td style="text-align: right;color:'+s+'">占比</td><td style="text-align: left;color:'+s+'">：'+this.percentage.toFixed(2)+"%</td></tr>"
}}}}),l(r.Bar,function(t){return t.options,{chart:{type:"bar"},plotOptions:{bar:{borderRadius:1.7}}}}),l(r.NStackBar,function(){return{chart:{type:"bar"},plotOptions:{bar:{stacking:"normal"}}}}),l(r.PStackBar,function(){return{chart:{type:"bar"},plotOptions:{bar:{stacking:"percent"}}}}),l(r.Biax,function(t){var e=t.info,r=t.chartData,n=t.options,o=a(e.type_optional[0],e),l=a(e.type_optional[1],e);(r.y.length>0||r.y_optional.length>0)&&(r.y.forEach(function(t){t.type=o.type,t.yAxis=0}),r.y_optional.forEach(function(t){t.type=l.type,t.yAxis=1}));var s="dark"===t.theme?1:2,d={marker:{symbol:"circle",lineColor:null,lineWidth:2,radius:0,fillColor:"rgba(255,255,255,0)",states:{hover:i[s].marker.states.hover}},states:{hover:{halo:i[s].halo}}};if($.extend(!0,n,{plotOptions:$.extend({line:d,spline:d,series:{connectNulls:!1}},o.plotOptions,l.plotOptions)}),n.series.length>0&&(["C211","C212"].indexOf(e.type_optional[0])>-1&&(n.series[0].borderRadiusTopLeft=1.7,n.series[0].borderRadiusTopRight=1.7,n.series[e.yAxis.length-1].borderRadiusBottomLeft=1.7,n.series[e.yAxis.length-1].borderRadiusBottomRight=1.7),["C211","C212"].indexOf(e.type_optional[1])>-1&&(n.series[e.yAxis.length].borderRadiusTopLeft=1.7,n.series[e.yAxis.length].borderRadiusTopRight=1.7,n.series[n.series.length-1].borderRadiusBottomLeft=1.7,n.series[n.series.length-1].borderRadiusBottomRight=1.7)),n.chart.marginRight=void 0,e.yAxis.length){var h="function"==typeof n.yAxis[0].tickPositioner?n.yAxis[0].tickPositioner():[0,1,2,3,4],c=h.indexOf(0),p=c>0?Math.abs(h[c-1]):h[1]-h[0];if(0>c)for(var u=0;u<h.length;u++){if(h[u]>=0){c=u;break}c=u}if(e.yAxisOptional.length){var f="function"==typeof n.yAxis[1].tickPositioner?n.yAxis[1].tickPositioner():[0,1,2,3,4],m=f.indexOf(0),g=m>0?Math.abs(f[m-1]):f[1]-f[0];if(0>m)for(var u=0;u<f.length;u++){if(f[u]>=0){m=u;break}m=u}c!==m&&e.yaxis_max_disabled&&e.yaxis_min_disabled&&(e.yaxis_max_disabled_right&&e.yaxis_min_disabled_right||(!e.yaxis_max_disabled_right||!e.yaxis_min_disabled_right)&&e.zero_aligned)&&(2!==c&&(n.yAxis[0].tickPositions=[-4*p,-2*p,0,2*p,4*p]),2!==m&&(n.yAxis[1].tickPositions=[-4*g,-2*g,0,2*g,4*g])),e.zero_aligned&&(e.yaxis_max_disabled&&e.yaxis_min_disabled?(c===m&&0>=c&&(p>=g?(p=h[h.length-1]/4,h=0===c?[0,p,2*p,3*p,4*p]:[-4*p,-3*p,-2*p,-1*p,0]):(g=f[f.length-1]/4,f=0===c?[0,g,2*g,3*g,4*g]:[-4*g,-3*g,-2*g,-1*g,0])),p>=g?n.yAxis[1].tickPositions=c!=m?n.yAxis[0].tickPositions:h:n.yAxis[0].tickPositions=c!=m?n.yAxis[1].tickPositions:f):n.yAxis[1].tickPositions=h,n.yAxis[1].labels.enabled=!1,n.yAxis[1].title.text="")}}}),l(r.Scatter,function(t){var e=t.data.y[0],a=t.info.xaxis_name,i=t.info.xaxis_unit;a||(a=e.name),i&&(a+="("+i+")"),$.extend(!0,t.options,{chart:{type:t.options.chart.type||"scatter"},xAxis:{title:{enabled:!0,text:a}},plotOptions:{line:{lineWidth:1,dashStyle:"fullscreen"===t.mode?"Dash":"ShortDash",enableMouseTracking:!1,marker:{enabled:!1,states:{hover:{enabled:!1}}}},spline:{lineWidth:1,dashStyle:"fullscreen"===t.mode?"Dash":"ShortDash",enableMouseTracking:!1,marker:{enabled:!1,states:{hover:{enabled:!1}}}},bubble:{marker:{states:{hover:{radiusPlus:0}}}},scatter:{marker:{states:{hover:{radiusPlus:0}}}},series:{states:{hover:{halo:{size:6}}},color:"rgba(114,175,217,0.6)",turboThreshold:10001}},tooltip:{formatter:function(){var e=t.data,a=t.info,i=t._getUnit().unit_left||"",r=t.info.xaxis_unit||"";return function(){var t,n;n=this.points?this.points[0].point:this.point;var l=n.index,s="",d=n.color,h=e.y[0].nick_name||e.y[0].name,c=e.y[1].nick_name||e.y[1].name,p="",u="";p=e.y[0].hasOwnProperty("unit_adv")&&""!=e.y[0].unit_adv?e.y[0].unit_adv:r,u=e.y[1].hasOwnProperty("unit_adv")&&""!=e.y[1].unit_adv?e.y[1].unit_adv:i;var f=o.dataLabelFormatter(e.y[0].formatter,n.x)+p,m=o.dataLabelFormatter(e.y[1].formatter,n.y)+u;if("scatter"==n.series.type||"bubble"==n.series.type)s+='<table class="tooltips-table">',angular.forEach(e.x,function(e,i){var r=t=e.data[l],n=e.nick_name||e.name;if("date"==e.data_type){var d=a.xAxis[i].granularity||"day",h=a.xAxis[i].granularity_name||"",c=a.xAxis[i].month_start_day||0;"week"===d&&(c=a.xAxis[i].week_start_day_of_week),r=o.checkGranularity(d,t,h,c),"week"===d&&(r+="（"+Highcharts.dateFormat("%b/%e",new Date(t))+"~"+Highcharts.dateFormat("%b/%e",new Date(t+5184e5))+"）"),(t.toString().length<10||"Invalid date"===r)&&(r=t)}else"sub_date"==e.data_type&&(r=o.subDateFormat(e.fid.split("_")[1],t));s+='<tr = class="tooltips-title"><td style="text-align:right;">'+bdp.utils.encodeHTML(n)+'</td><td style="text-align: left;">： '+r+"</td></tr>"});else if("line"==n.series.type){var g="y="+e.scatter_setting.linear_model.a+"* x "+(e.scatter_setting.linear_model.b<0?"-":"+")+" "+Math.abs(e.scatter_setting.linear_model.b);s+='<p class="tooltips-title text-center">'+g+"</p>",s+='<table class="tooltips-table">'}if(s+='<tr><td style="text-align:right;color:'+d+'">'+bdp.utils.encodeHTML(h)+'</td><td style="text-align: left; color:'+d+'">：'+f+"</td></tr>",s+='<tr><td style="text-align:right;color:'+d+'">'+bdp.utils.encodeHTML(c)+'</td><td style="text-align: left; color:'+d+'">：'+m+"</td></tr>",void 0!==n._z){var y=n._z;s+='<tr><td style="text-align:right;color:'+d+'">'+a.bubble_setting.field.name+'</td><td style="text-align: left; color:'+d+'">：'+y+"</td></tr>"}return s+="</table>"}}()},legend:{enabled:!1}})}),l(r.Radar,function(t){var e,a=t.options.series[0].data.length>3?"polygon":"circle",r="dark"===t.theme?1:2;e="dark"===t.theme?"fullscreen"==t.mode?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.12)":"fullscreen"==t.mode?"rgba(0, 0, 0, .2)":"rgba(0, 0, 0, .12)",$.extend(!0,t.options,{chart:{type:"line",polar:!0,backgroundColor:null,spacingBottom:15},plotOptions:{line:{lineWidth:t.isDashboardMode?2:"fullscreen"==t.mode?4:3,marker:$.extend(!0,i[r].marker,{enabled:!0,radius:"fullscreen"==t.mode?5:3,fillColor:null}),states:{hover:{halo:$.extend(!0,i[r].halo,{radiusPlus:"fullscreen"==t.mode?1:0})}}}},pane:{size:"90%",background:{borderColor:null,backgroundColor:null}},xAxis:{tickmarkPlacement:"on",lineWidth:0,gridLineWidth:"fullscreen"==t.mode?2:1,gridLineColor:e},yAxis:[{title:{enabled:!1,text:""},gridLineWidth:"fullscreen"==t.mode?2:1,gridLineColor:e,tickColor:e,lineWidth:0,gridLineInterpolation:a}]}),t.data.x.length&&"date"==t.data.x[0].data_type&&(t.options.xAxis.showLastLabel=!0)}),l(r.Gauge,function(t){e.setGaugeSpecialOption(t)}),l(r.Waterfall,function(t){return e.setWaterfallSpecialOption(t)}),l(r.Area,function(t){var e="dark"===t.theme?1:2;return{chart:{type:+t.info.use_spline?"areaspline":"area"},plotOptions:{area:{fillOpacity:.6,lineWidth:2,marker:i[e].marker,states:{hover:{halo:i[e].halo}}},areaspline:{fillOpacity:.6,lineWidth:2,marker:i[e].marker,states:{hover:{halo:i[e].halo}}},series:{connectNulls:!1}}}}),l(r.NStackArea,function(t){var e="dark"===t.theme?1:2;return{chart:{type:+t.info.use_spline?"areaspline":"area"},plotOptions:{area:{fillOpacity:.6,stacking:"normal",lineWidth:2,marker:i[e].marker,states:{hover:{halo:i[e].halo}}},areaspline:{fillOpacity:.6,stacking:"normal",lineWidth:2,marker:i[e].marker,states:{hover:{halo:i[e].halo}}},series:{connectNulls:!1}}}}),l(r.PStackArea,function(t){var e="dark"===t.theme?1:2;return{chart:{type:+t.info.use_spline?"areaspline":"area"},plotOptions:{area:{stacking:"percent",lineWidth:2,marker:i[e].marker,states:{hover:{halo:i[e].halo}}},areaspline:{stacking:"percent",lineWidth:2,marker:i[e].marker,states:{hover:{halo:i[e].halo}}},series:{connectNulls:!1}}}}),l(r.TreeMap,function(){return{chart:{type:"treemap"},plotOptions:{treemap:{layoutAlgorithm:"squarified",dataLabels:{enabled:!0,allowOverlap:!1,overflow:"none",crop:!0,style:{color:"#fff",fontSize:"12px",shadow:null,textOutline:null}},levels:[{level:1,dataLabels:{enabled:!0,align:"left",verticalAlign:"top",style:{fontSize:"14px"}}}]}}}}),e.definedChartType=l,e.chartTypeDelegate={getChartTypeOption:function(t,e){if(t.$elem.removeClass("chart-pie"),"function"==typeof n[e])return n[e](t);throw e+" is not defined"}}}(window,window.bdpChart),!function(t){var e=t.helper,a=t.ChartType,i={getModeOption:function(t,i,r,n){var o={showDataLabel:{dataLabels:{enabled:!0,color:"dark"===n.theme?"rgba(255, 255, 255, 1) ":"#666",inside:!1,style:{fontSize:"14px",textOutline:"none"},padding:5,formatter:function(){var t=this.series.options.formatter,a=this.series.options.aggregator;return e.dataLabelFormatter(t,this.y,a)}}},label:{color:"dark"===n.theme?"rgba(255, 255, 255, .6) ":"#666",fontSize:"13px"}},l=i.summary.supply_summary&&i.summary.supply_summary.length,s={noData:{style:{color:"dark"===n.theme?"rgba(255, 255, 255, 1) ":"#666",fontSize:"14px"}},legend:{layout:"vertical",align:"right",verticalAlign:"top",navigation:{activeColor:"dark"===n.theme?"rgba(255, 255, 255, 1) ":"#666",style:o.label},itemStyle:o.label,itemHoverStyle:{color:"dark"===n.theme?"#eee ":"#666"},margin:40,y:30},chart:{spacingTop:l?10:50},title:{style:o.label,margin:30},xAxis:{labels:{style:o.label},title:{style:o.label}},yAxis:[{title:{style:o.label,offset:70},labels:{style:t!==a.Gauge?o.label:{fontSize:"20px",color:"dark"===n.theme?"rgba(255, 255, 255, 1) ":"#666"},y:6}}],tooltip:{style:{fontSize:"14px"}},plotOptions:{series:{animation:{duration:1e3,easing:"swing"}},bar:angular.copy(o.showDataLabel),column:angular.copy(o.showDataLabel),waterfall:angular.copy(o.showDataLabel),line:angular.copy(o.showDataLabel),spline:angular.copy(o.showDataLabel),area:angular.copy(o.showDataLabel),areaspline:angular.copy(o.showDataLabel)},pane:{size:"95%"}};switch(t===a.Gauge&&n.isSplitChart()&&delete s.yAxis,s=$.extend(!0,n.options,s),t){case a.Biax:s.yAxis[1]&&(s.yAxis[1].title.style=o.label,s.yAxis[1].title.offset=70,s.yAxis[1].labels.style=o.label)}s.title.text||(s.chart.spacingTop=50)}},r={getModeOption:function(t,a,i,r){var n={dataLabels:{enabled:!0,color:"dark"===r.theme?"rgba(255, 255, 255, 0.6) ":"#666",inside:!1,style:{fontSize:"14px",textOutline:"none"},padding:5,formatter:function(){var t=this.series.options.formatter,a=this.series.options.aggregator;return e.dataLabelFormatter(t,this.y,a)}}};return{plotOptions:{bar:angular.copy(n),column:angular.copy(n),waterfall:angular.copy(n),line:angular.copy(n),spline:angular.copy(n),area:angular.copy(n),areaspline:angular.copy(n)}}}},n={getModeOption:function(t){var a=t.getChartType(),i=(t.data,t.mode),r=i.split("*");blockWidth=r[0]>>>0,blockHeight=r[1]>>>0;var n={dataLabels:{enabled:!0,color:"dark"===t.theme?"rgba(255, 255, 255, .6) ":"#666",inside:!1,style:{fontSize:"10px",fontWeight:"normal",textOutline:"none"},padding:5,formatter:function(){var t=this.series.options.formatter,a=this.series.options.aggregator;return e.dataLabelFormatter(t,this.y,a)}}},o={plotOptions:{bar:angular.copy(n),column:angular.copy(n),waterfall:angular.copy(n),line:angular.copy(n),spline:angular.copy(n),area:angular.copy(n),areaspline:angular.copy(n)}};switch(4>blockHeight&&4>blockWidth&&$.extend(!0,o,{legend:{enabled:!1}}),blockWidth){case 1:case 2:case 3:o=$.extend(!0,o,{chart:{},legend:{enabled:!1},plotOptions:{line:{lineWidth:3,hover:{lineWidth:3}}}}),o.labels=o.labels||{},o.labels.style=o.labels.style||{},o.labels.style.fontSize="8px";break;case 4:case 5:case 6:o=$.extend(!0,o,{plotOptions:{line:{lineWidth:3,hover:{lineWidth:3}}}})}if(3>blockHeight){var l={};switch(a){case"C220":case"C240":case"C241":case"C242":case"C210":case"C211":case"C212":case"C290":case"C350":case"C351":case"C352":l={xAxis:[{lineWidth:0,labels:{enabled:!1}}],title:{style:{overflow:"hidden"}},legend:{enabled:!1},tooltip:{enabled:!1},plotOptions:{line:{lineWidth:2}},yAxis:[{lineWidth:0,title:{text:""},labels:{enabled:!1}}]},o=$.extend(!0,o,l),o.colors=["#D8D8D8"]}}return"dark"===t.theme&&$.extend(!0,o,{plotOptions:{line:{lineWidth:3,states:{hover:{lineWidth:3}}}}}),o}};t.modeDelegate={getModeOption:function(t){var e=t.getChartType();switch(t.mode){case"fullscreen":return i.getModeOption(e,t.data,t.mode,t);case"edit":return r.getModeOption(e,t.data,t.mode,t);default:return t.isDashboardMode?n.getModeOption(t):{}}}}}(bdpChart),!function(){bdpChart.setPieSpecialOption=function(t){var e,a,i,r=t.info,n=(t.dash_setting,t.data),o=bdpChart.getColorsByType("C230","bdp"),l=t.$elem.height(),s=t.$elem.width(),d=t.gridWidth,h=t.gridHeight,c=Math.min(l,s),p=t.optional.drill_level?180*.7:140,u="10px",f=h>3&&d>h&&d!=h||!d&&!h&&l>250&&s>l;i="dark"==t.theme?"0.7 !important":"fullscreen"==t.mode?"0.5 !important":"0.38 !important",a="pie"==r.shape?c>500?4:5:c>350?3.5:4.7,u=d>3?250>c?"10px":c>=250&&300>c?s>l?"11px":"10px":c>=300&&400>c?s>l?"12px":"11px":c>=400&&500>c?s>l?"15px":"13px":c>=500&&650>c?s>l?"18px":"16px":s>l?"18px":"16px":250>c?"10px":c>=250&&300>c?"12px":c>=300&&350>c?"14px":c>=350&&400>c?"16px":"18px",r.pieContent&&"text"===r.pieContent.showProportion&&(r.show_connector_label=!0,delete r.pieContent),e=500>c?-(c-24)/(9.5-(c-250)/100*.5):-(c-24)/7;var m={cursor:t.info.is_drill||"2"==t.optional.linked_chart_type?"pointer":"default",borderWidth:1,borderColor:"dark"===t.theme?"#24273E":"#fff",dataLabels:{distance:e,style:{fontSize:u,textOutline:"none"},formatter:function(t,e){return"showPercentage"==e?this.point.percentage<a?"":this.point.percentage.toFixed(1)+"%":void 0}}};if(p>c?m.dataLabels={enabled:!1}:r.show_connector_label&&$.extend(!0,m.dataLabels,{connectorColor:"dark"===t.theme?"rgba(255, 255, 255, .12)":"rgba(0, 0, 0, .12)",connectorWidth:1,size:"80%",style2:{fontSize:"fullscreen"===t.mode?"14px":"11px",color:"dark"===t.theme?"#fff":"rgba(11,19,32)",opacity:"dark"===t.theme?"0.7 !important":"0.5 !important"},fontSize:"10px",softConnector:!1,formatter:function(e,i){if("showPercentage"==i)return this.point.percentage<a?"":this.point.percentage.toFixed(1)+"%";if("showConnectorLabel"==i&&f){var r=this.point.index||0,n=this.point.series.data[r],o=100,l=this.percentage>33?.33:this.percentage/100,s=0||Math.abs(this.point.shapeArgs.r*Math.sin(.5*Math.PI*l)*1.9);if(n&&"Slice"===n.name){var d="";return d=["其它","Else"].indexOf(n.options.x)>=0?n.options.x:o>s?t._formatXAxisLabel(n.x,0):t._formatXAxisLabel(n.x,0)}var h=o>s?this.key:this.key,c=o>s?"":"";return h+c}}}),!r.xAxis.length&&r.yAxis.length){var g;r.compare_axis.length?(g=[],angular.forEach(n.y,function(t,e){var a=t.compare_names,i=a.join("_");g.push({color:t.series_color?t.series_color:o[e%o.length],name:i,y:1*t.data[0]})})):(g=[],angular.forEach(n.y,function(t,e){var a=t.nick_name||t.name;g.push({color:t.series_color?t.series_color:o[e%o.length],name:a.substr(0,5),y:1*t.data[0]})})),$.extend(!0,t.options,{xAxis:{type:"category"},series:[{data:g,formatter:n.y[0].formatter}]})}if("donut"===t.info.shape){var y=-.14*c/2;$.extend(!0,m,{innerSize:"68%",dataLabels:{enabled:d>4&&h>3||"edit"==t.mode||"fullscreen"==t.mode,distance:y}})}$.extend(!0,t.options,{plotOptions:{pie:m}})}}(),!function(t){t.setScatterSpecialOption=function(e){function a(){for(var t=e.data,a=(e.info,0),i=0;i<t.y.length;i++)a=Math.max(a,t.y[i].data.length)}function i(e){var a=e.data.x.length?e.data.x[0].data:[],i=e.data.y;if(2!=i.length||i[0].data.length!=i[1].data.length)return!1;var r,n,o,l,s=[],d=i[0].data,h=i[1].data,c=0,p=d.length;for(r=n=Number(d[c]),o=l=Number(h[c]),p=d.length;p>c;c++){var u=Number(d[c]),f=Number(h[c]);r>u&&(r=u),u>n&&(n=u),o>f&&(o=f),f>l&&(l=f);var m={name:a[c],x:u,y:f};s.push(m)}var g=[{type:"scatter",marker:{symbol:"circle"},data:s}],y=e.data.scatter_setting,v={color:"rgba(0,0,0,.24)",type:"spline"};if("dark"===e.theme&&(v.color="rgba(81,129,228,0.5)"),y.enable_trend_line&&y.trend_line_type){var _,b,x=[];y.trend_line_type=+y.trend_line_type;var C=angular.copy(d).sort(function(t,e){return t-e}),w={1:"linear_model",2:"logarithm_model",3:"exponential_model",4:"poly_model"},k=w[y.trend_line_type],A=y[k];if(A){switch(y.trend_line_type){case 1:var S=A.a,D=A.b,M=[r,S*r+D],T=[n,S*n+D];v.type="line",x=[M,T];break;case 2:for(c=0;p>c;c++)if((0==c||C[c]!=C[c-1])&&(_=Number(C[c]),_>0)){b=A.a*Math.log(_)+A.b;var D=-0;A.b<D&&(b=0),isFinite(b)&&x.push([_,b])}break;case 3:for(c=0;p>c;c++)(0==c||C[c]!=C[c-1])&&(_=Number(C[c]),b=Math.exp(_*A.a+A.b),isFinite(b)&&x.push([_,b]));break;case 4:var L=t.helper.polynomial(A.coeffs);for(c=0;p>c;c++)(0==c||C[c]!=C[c-1])&&(_=Number(C[c]),b=L(_),x.push([_,b]))}v.data=x,$.extend(!0,v,{lineWidth:"fullscreen"===e.mode?2:1,dataLabels:{enabled:!1}}),g.push(v)}}e.options.series=g}function r(e){if(e.options.series&&e.options.series[0]){var a,i=e.options.series[0].data,r=0,n=e.info.color_setting;if(delete n.is_series,n)if(0!=n.mode||$.isEmptyObject(n.enum_color_map)||0==e.data.x.length){if(!$.isEmptyObject(e.data.colors)&&1===n.mode){var o=e.data.colors.map(function(t){return Number(t)}),l=t.helper.linearRangeColor(n.range_color.start_color,n.range_color.end_color),s=t.helper.createLinearScale(n.range_color,o),d=[],h=n.range_color.step;if(h>1){for(r=0;h-1>r;r++)d.push(l(r/(h-1)));d.push(l(1))}angular.forEach(i,function(t,e){var a,i=o[e],r=s(i);if(h){var n=Math.floor(h*r);n=Math.min(n,h-1),a=d[n]}else a=l(r);t.color=Highcharts.Color(a).setOpacity(.8).get()})}}else{a=t.colors[n.theme];var c,p=a.length,u=[],f=n.enum_color_map||null,m=null===f?[]:Object.keys(f).map(function(t){return t.split("_")});angular.forEach(i,function(t,i){if(u=e.data.x.map(function(t){return t.data[i]}),f){for(var r=0;r<m.length;r++)if(bdp.utils.isContain(u,m[r])){c=f[m[r].join("_")].color;break}c||(c=a[i%p])}else c=a[i%p];t.color=Highcharts.Color(c).setOpacity(.8).get()})}}}function n(t){function e(t,e,a){if(t=Number(t),isNaN(t))return 1;var i,r=e.length,n=r-1;for(i=0,r=e.length;r>i;i++){var o=e[i];if(t<o[0]){n=i;break}if(o[0]<=t&&t<o[1]){n=i;break}}return a?r-n:n+1}if($.isEmptyObject(t.info.bubble_setting))return!1;var a=t.data.bubble_sizes,i=t.data.bubble_size_groups,r=t.options.series[0],n=r.data,o=t.info.bubble_setting.reverse,l=t.info.bubble_setting.size_range,s=3;angular.forEach(a,function(t,a){n[a]._z=t,n[a].z=e(t,i,o)}),r.type="bubble",$.extend(!0,t.options,{chart:{type:"bubble"},plotOptions:{bubble:{sizeBy:"width",minSize:s*l[0],maxSize:s*l[1]}}})}a(),i(e),n(e),r(e)}}(bdpChart),!function(t){function e(e){var a=t.language,i="zh"===a?"当前图表无数据":"No data to display";e.html('<div class="chart-error"><p>'+i+"</p></div>").addClass("bdp-chart-loaded bdp-chart-error")}function a(a){var i=a.data.y[0]&&a.data.y[0].data,r=[],n=t.language||"zh";i&&i.forEach(function(t,e){if(""==t||0>=t){for(var i=a.data.x[0].data[e],n=a._formatXAxisLabel(i,0,!0),o=1;o<a.data.x.length;o++)n+="-"+a._formatXAxisLabel(a.data.x[o].data[e],o,!0);r.push(n)}}),a.once("load",function(){if(a.data.x[0].data.length==r.length&&e(a.$elem),r.length&&"edit"===a.mode){var t="";t="zh"===n?"有"+r.length+"项负值或空值数据":"There are "+r.length+" negative or null values.";var i='<div class="map-mismatch-text pa guide"><p><a class="cursor-pointer">'+t+'</a></p><div class="guide-tip dropdown-wrap">'+bdp.utils.encodeHTML(r.join("、"))+"</div></div>";a.$elem.append(i)}})}function i(e){var a={},i=[],s=e.data.x,d=e.data.y[0]&&e.data.y[0].data;colors=r(e)||t.getColorsByType(l.TreeMap),colorIdx=0,nodeId=1;for(var h=0;h<(d&&d.length||s[0].data.length);h++)for(var c=a,p=0;p<s.length;p++){var u=s[p].data[h],f=e._formatXAxisLabel(u,p);c[f]||(c[f]={name:f},0===p&&(c[f].color=colors[u]&&colors[u].color||colors[colorIdx%colors.length],colorIdx++),p===s.length-1?c[f].value=d?+d[h]:1:(c[f].children={},c[f].id=""+nodeId++,c.value)),c=c[f].children}n(a,function(t,e){var a={};a.name=t.name,o(t,a,"id"),o(t,a,"color"),o(t,a,"value"),e&&(a.parent=e.id),i.push(a)}),e.options.series=[{type:"treemap",data:i,animation:!1,borderColor:"default"===e.theme?"#fff":"#292D47",allowDrillToNode:!0,dataLabels:{enabled:"edit"==e.mode?e.info.show_datalabels:!0},events:{onDrillToNode:function(t,a,i){for(var r=e.$elem,n=e.info.xAxis[0].nick_name||e.info.xAxis[0].name,o=r.parent(),l=[],s=t;""!==s;){var d=a[s];l.push(s),s=d.parent}l.push(""),l=l.reverse(),"fullscreen"===e.mode&&(o=$(".fullscreen-modal"));var h=o.find(".treemap-drill-crumbs");h.length||(h=$('<div class="drill-crumbs treemap-drill-crumbs"></div>'),h.on("click",".drill-point",function(){i.drillToNode($(this).data("nodeid"))}),o.find(".drill-crumbs-wrap").append(h));var c="";l.length>1&&l.forEach(function(t){var e=""==t?n:a[t].name;""!=t&&(c+='<i class="bdp-icon ico-slicesnav-arrow"></i>'),c+='<span class="drill-point" data-nodeid="%nodeId%" title="%nodeName%">%nodeName%</span>'.replace("%nodeId%",t).replace(/%nodeName%/g,e)}),h.html(c),r.css({bottom:22})}}}],"fullscreen"==e.mode&&(e.options.chart.spacingTop=10,e.options.title.margin=0),delete e.options.xAxis,delete e.options.yAxis}function r(e){var a=[],i=e.data.x,r=e.info,n=r.color_setting,o={},s=t.getColorsByType(l.TreeMap),d=s.length;return i[0].data.forEach(function(t){""!==t&&["(空白)","(Blank)"].indexOf(t)<0&&a.indexOf(t)<0&&a.push(null===t?null:t.toString())}),n.enum_color_map?o=n.enum_color_map:a.forEach(function(t,e){""!==t&&["(空白)","(Blank)"].indexOf(t)<0&&(o[t]={name:t,color:s[e%d]})}),o}function n(t,e,a){for(var i in t)e(t[i],a),t[i].children&&n(t[i].children,e,t[i])}function o(t,e,a){void 0!==t[a]&&(e[a]=t[a])}var l=t.ChartType;t.setTreemapSpecialOption=function(t){i(t),a(t),$.extend(!0,t.options.plotOptions.treemap.dataLabels,{useHTML:!0,formatter:function(){if(this.point.shapeArgs){var e=this.point.shapeArgs.height,a=this.point.node.parent==this.series.rootNode&&42>e||this.series.nodeMap[this.point.node.parent].parent==this.series.rootNode&&36>e,i=this.point.dlOptions.align,r=t.info.data_label_setting&&t.info.data_label_setting.show_percent,n=this.point.dlOptions.style.cursor,o=this.point.dlOptions.style.fontSize,l=r&&!a?'<p style="opacity: 0.7;font-size:'+o+"; font-family:Avenir;font-weight:lighter; cursor:"+n+"; text-align:"+i+'">'+(this.point.value/this.point.sum*100).toFixed(2)+"%</p>":"",s='<p style="font-family:PingFang SC;font-weight:bold; font-size:'+o+"; cursor:"+n+"; text-align:"+i+';">'+(this.point.name||this.point.id)+"</p>"+l;return s}return""}})}}(bdpChart),!function(){function t(t){function e(t,e,r){var n=null,o=$("#"+a);o.length>0?(o.text(t),o.show()):(n=i("div",t,a),n.setAttribute("id",a),$(document.body).append(n),o=$("#"+a));var l=o.outerWidth(),s=o.height();$("#"+a).css({top:e.top-s-25+"px",left:e.left+r/2-l/2})}var a="tbTipBox";t.find("span").hover(function(){if(desc=$(this).attr("description")){var t=$(this);e(desc,t.offset(),t.outerWidth())}},function(){$("#"+a).hide()})}function e(t){function e(t,e,r){var n=null,o=$("#"+a);o.length>0?(o.attr("src",t),o.show()):(n=i("img","","table-data-show-type-img"),n.setAttribute("id",a),n.setAttribute("src",t),$(document.body).append(n),o=$("#"+a));var l=(o.outerWidth(),o.height());$("#"+a).css({top:e.top-l/2+"px",left:e.left+r+5})}var a="J_data_show_type_img";t.find(".J-hz-table-show-img").off("mouseenter mouseleave").on({mouseenter:function(){var t=$(this).attr("data-src");if(t){var a=$(this);e(t,a.offset(),a.outerWidth())}},mouseleave:function(){$("#"+a).hide()}}),$("#"+a).hide()}function a(t){for(var e=0,a=t.length;a>e;e++)if(1===Number(t[e]))return!0;return!1}function i(t,e,a){var i=document.createElement(t);if(e){var r=document.createTextNode(e);i.appendChild(r)}return a&&(i.className=a),i}var r={},n={},o={},l={};$.fn.scrollEnd=function(t,e,a){$(this).scroll(function(){var i=$(this);i.data("scrollTimeout")&&clearTimeout(i.data("scrollTimeout")),i.data("scrollTimeout",setTimeout(function(){t.call(i)},e)),a.attr("data-scrolling","true")})},bdpChart.setTableSpecialOption=function(s,d){function h(t){var e=0;return t.x.length?e=t.x[0].data.length:t.y.length?e=t.y[0].data.length:t.y_optional.length&&(e=t.y_optional[0].data.length),e}function c(){s.off("setAdvSort").on("setAdvSort",function(t){s.requestData(t).then(function(t){var e=s.info.tb_flip;"0"==t.status?e?(s.data=t.result.data,s.info=t.result.info,E.init()):O.init(t.result):errorHandle(t.errstr)})})}function p(t){var e=t.find(".fht-fixed-column .fht-thead"),a=t.find(".fht-thead .hz-table-header"),i=t.find(".fht-tbody .hz-table-header"),r=i.find("tr"),n=r.eq(0).find("th"),o=r.last().find("th"),l=e.clone(),s=a.clone(),d=i.clone(),h=d.find("tr"),c=s.find("tr:first").find("th"),p=s.find("tr:last").find("th"),u=l.find("tr:first").find("th"),f=l.find("tr:last").find("th"),m=0;h.eq(0).find("th").each(function(t){m=n.eq(t).width()+1,c.eq(t).find(".fht-cell").css({width:m}),u.eq(t).find(".fht-cell").css({width:m})}),h.last().find("th").each(function(t){m=o.eq(t).width()+1,$(this).append($('<div class="fht-cell" style="width:'+m+'px;"></div>')),p.eq(t).append($('<div class="fht-cell" style="width:'+m+'px;"></div>')),f.eq(t).append($('<div class="fht-cell" style="width:'+m+'px;"></div>'))}),e[0]&&(e[0]=bdp.utils.replaceHtml(e[0],l.html())),a[0]&&(a[0]=bdp.utils.replaceHtml(a[0],s.html())),i[0]&&(i[0]=bdp.utils.replaceHtml(i[0],d.html()))}var u,f,m,y,v=s.$elem,_="default",b=s.info.chart_id,x=s.info.tb_flip,C=!1,w=s.info.tb_pinned_index||0,k=void 0===s.info.tb_merge_cell?!0:s.info.tb_merge_cell,A="bottom",S="right",D=bdpChart.language||"zh",M="zh"===D?"当前图表无数据":"No data to display",T="[__subtotal__]";if(d&&d.length>0){var L=null;angular.forEach(d,function(t){t.ctId==b&&(L=t.pointData)}),s.pointData=L}"zh"==D?(u="加载更多...",f="表格数据超过100条不支持行列转置",m="总计",y="小计"):(u="Load more...",f="Table data more than 100 do not support transpose",m="Summary",y="Subtotal"),s.info.tb_statistic&&(!s.info.tb_statistic.col_pos&&(s.info.tb_statistic.col_pos="bottom"),A=s.info.tb_statistic.col_pos,!s.info.tb_statistic.row_pos&&(s.info.tb_statistic.row_pos=S),S=s.info.tb_statistic.row_pos),$(".table-flip").off().on("click",function(){var t=h(s.data);return t>100?(alert(f),!1):(window.bdpa&&bdpa.track("track_table_flip",{table_flip:1}),void s.emit("saveWithOpt",s.info.drill_level,{tb_flip:!x}))});var E={compareLevel:1,getRowHeight:function(){return 35},init:function(){var t=s.data.x.length;if(v.html(""),E.totalData=h(s.data),E.linkInfo=s.optional&&s.optional.link_info,E.jumpInfo=s.optional&&s.optional.chart_jump_info,E.pointData=s.pointData||new Array(t),E.dimensionsName=s.dimensionsName||new Array(t),s.pointData=E.pointData,0===E.totalData)return void v.append('<div class="chart-error"><p class="no-data">'+M+"</p></div>");var e;if(e=$("fullscreen"===s.mode?'<div class="chart-table"><table class="hz-table"><thead class="hz-table-header"></thead><tbody class="hz-table-body"></tbody></table></div>':'<table class="hz-table"><thead class="hz-table-header"></thead><tbody class="hz-table-body"></tbody></table>'),v.append(e),v.find(".hz-table-header")[0].appendChild(E.initHead()),v.find(".hz-table-body").append(E.initBody("y")),v.find(".hz-table-body").append(E.initBody("y_optional")),E.addId=(v[0].className.split(" ")[1]+s.ct_id).toUpperCase(),v.find(".hz-table").attr("id",E.addId),C||"edit"==s.mode||"fullscreen"==s.mode||"chartTpl"==s.mode)E.fixHeader();else{var a=$("#"+E.addId);a.wrap('<div style="width:100%; height: 100%; overflow: hidden"></div>'),a.wrap('<div class="no-fix-header J_no_fix"></div>'),a.css({width:"100%"})}E.mergeCell(),v.find(".fht-empty-cell").addClass("hidden"),E.bindEvents(s)},initHead:function(){var t,e,a,r,n=s.data,o=s.info,l=n.x||[],d=E.linkInfo,h=[],c=E.jumpInfo;d&&d.length>0&&angular.forEach(d[0].field_map,function(t){h.push(t.index)}),n.y.length?n.y[0].name==m&&n.y[1].compare_names?E.compareLevel=n.y[1].compare_names.length:n.y[0].compare_names&&(E.compareLevel=n.y[0].compare_names.length||E.compareLevel):n.y_optional.length&&n.y_optional[0].compare_names&&(E.compareLevel=n.y_optional[0].compare_names.length),E.compareLevel=E.compareLevel||1;for(var p=document.createDocumentFragment(),u=0;u<l.length;u++){e=l[u].data_type;for(var f,g,y,v=o.xAxis[u].granularity||"day",_=o.xAxis[u].granularity_name||"",b=o.xAxis[u].month_start_day||0,x=document.createElement("tr","",a),C=/^(http:|https:|ftp:)[\S]+\.(jpg|jpeg|bmp|gif|png)$/i,w=0;w<E.compareLevel;w++){var k=l[u].name;f=i("th","","th"),g=i("div","","td-wrap"),y=o.xAxis[u]?o.xAxis[u].description:void 0;var S=i("span",l[u].nick_name||k,"");y&&(S.setAttribute("description",y),S.className+=" description"),g.appendChild(S),f.appendChild(g),x.appendChild(f)}o.tb_statistic.col&&"top"===A&&this.drawColSummary(x,u);for(var D=0;D<l[u].data.length;D++){if(t=l[u].data[D],r=o.xAxis[u].alignment_method?o.xAxis[u].alignment_method:"right","center"===r?a="text-center":"left"===r?a="text-left":"right"===r&&(a="text-right"),null===t||""===t)f=i("th","",a),g=i("div","","td-wrap");else{if("date"===e){"week"===v&&(b=o.xAxis[u].week_start_day_of_week||1);var M=bdpChart.helper.checkGranularity(v,t,_,b);"week"===v&&(M+="（"+Highcharts.dateFormat("%b/%e",new Date(t))+"~"+Highcharts.dateFormat("%b/%e",new Date(t+5184e5))+"）")}else M=t;if(o.is_drill&&l[u].fid===o.level_fields[o.drill_level].fid){f=i("th","",a),g=i("div","","td-wrap");var T="";if("string"==e&&"img"==o.xAxis[u].data_show_type&&C.test(M)){T=i("img","","cursor-pointer chart-table-type-img J-hz-table-show-img drilldown"),T.setAttribute("src",M),T.setAttribute("data-src",M),T.setAttribute("data-drill-value",t),T.setAttribute("data-text",M);var L=i("i",M,"chart-table-type-img J-hz-table-show-img hidden");L.setAttribute("data-src",M),L.setAttribute("data-text",M),L.appendChild(T)}else T=i("a",M,"drilldown"),T.setAttribute("data-drill-value",t);g.appendChild(T),f.appendChild(g)}else{f=i("th","",a);var O=i("div","","td-wrap");if("string"==e&&"img"==o.xAxis[u].data_show_type&&C.test(M)){var P=i("img","","chart-table-type-img J-hz-table-show-img");P.setAttribute("src",M),P.setAttribute("data-src",M),P.setAttribute("data-text",M),O.appendChild(P);var L=i("i",M,"chart-table-type-img J-hz-table-show-img hidden");L.setAttribute("data-src",M),L.setAttribute("data-text",M),O.appendChild(L)}else if($.inArray(u,h)>-1){var F="td-wrap point-status J-link"+u;t==E.pointData[u]&&(F+=" cur-link-item"),O=i("div",M,F),O.setAttribute("data-current",t)}else if(c&&c.fid&&c.f_index==u){var F="td-wrap point-status J-jump";O=i("div",M,F),O.setAttribute("data-current",t)}else O=i("div",M,"td-wrap");f.appendChild(O)}if(!("http://"!==t.toString().substr(0,7)&&"https://"!==t.toString().substr(0,8)||"string"==e&&"img"==o.xAxis[u].data_show_type&&C.test(M))){var N=document.createTextNode("  "),z=i("a"),B=i("span",t,"");f=i("th",""),g=i("div","","td-wrap"),z.setAttribute("href",t),z.setAttribute("target","_blank"),z.appendChild(i("i","","bdp-icon ico-href")),g.appendChild(N),g.appendChild(B),g.appendChild(z),f.appendChild(g)}}x.appendChild(f)}o.tb_statistic.col&&"bottom"===A&&this.drawColSummary(x,u),p.appendChild(x)}return p},drawColSummary:function(t,e){var a,r,n=s.info;if(0===e){a=i("th","","th"),r=i("div",m,"td-wrap"),a.appendChild(r);var o=E.compareLevel;o=Math.max(o,n.xAxis.length),a.setAttribute("rowspan",o)}else a=i("th","","hidden"),r=i("div",m,"td-wrap"),a.appendChild(r);t.appendChild(a)},initBody:function(t){var e,r,n,o,l,d,h=s.data,c=s.info,p=h[t]||[],u=c.warn,f=[],g=!1,y={},v=document.createDocumentFragment();if(!c.drill_level&&1===u&&c.warn_info.length&&s.info.compare_axis.length>0){var _=s.data[t];angular.forEach(_,function(t){t.hasOwnProperty("warn_data")&&a(t.warn_data)&&(y[t.uniq_id]=!0)})}for(var b=0;b<p.length;b++){n=p[b].formatter,o=p[b].aggregator,e=p[b].compare_names||[p[b].nick_name||p[b].name];var x="";if(h[t][b].hasOwnProperty("unit_adv")&&h[t][b].unit_adv&&(x="("+h[t][b].unit_adv+")"),1==e.length&&p[b].name==m&&p[1].compare_names){var C=p[1].compare_names.length;e.length<C&&e.push(e[0]+x)}var w,k,S=document.createElement("tr"),D=i("i","","warn-label-left");if(g=!1,!c.drill_level&&1===u&&c.warn_info.length){var $=s.data[t][b];f=$,$.hasOwnProperty("warn_data")&&(g=a($.warn_data))}for(var M=0;M<e.length;M++){if(M>0&&(x=""),c.tb_statistic&&c.tb_statistic.row&&E.compareLevel>1&&1===e.length&&e[0]===m)w=i("td","","th"),k=i("div",m,"td-wrap"),w.appendChild(k),w.setAttribute("colspan",E.compareLevel);else{w=i("td",void 0,"th"),k=i("div","","td-wrap"),0===M&&y[h[t][b].uniq_id]?k.appendChild(D.cloneNode()):f&&f.fid===h[t][b].fid&&g&&k.appendChild(D.cloneNode());var T=i("span",e[M]+x);if(0===M||e.length==C&&p[b].name==m){var L=p[b].description;
L&&(T.setAttribute("description",L),T.className+=" description")}k.appendChild(T),w.appendChild(k)}S.appendChild(w)}c.tb_statistic.col&&"top"===A&&this.drawColSummaryData(S,p[b].col_summary,o,n,d);for(var O=0;O<p[b].data.length;O++){l=h.y[b]&&h.y[b].alignment_method?h[[t]][b].alignment_method:"right","left"===c.tb_statistic.row_pos&&"true"===c.tb_statistic.row&&c[t][b].alignment_method?h[t][0].alignment_method=c.tb_statistic.row_setting.alignment_method:"right"===c.tb_statistic.row_pos&&"true"===c.tb_statistic.row&&c[t][b].alignment_method&&(h[t][length-1].alignment_method=c.tb_statistic.row_setting.alignment_method),d="center"===l?"text-center":"left"===l?"text-left":"right"===l?"text-right":"text-right",r=p[b].data[O];var T,P=p[b].cell_styles?p[b].cell_styles[O]:null,F=!1;1===u&&p[b].hasOwnProperty("warn_data")&&angular.forEach(p[b].warn_data,function(t){1===t&&(F=!0)}),null!==r&&!c.drill_level&&F?(w=i("td","",1===u&&1===p[b].warn_data[O]?"cr":d),k=i("div","","td-wrap"),T=i("span",bdpChart.helper.dataLabelFormatter(n,p[b].data[O],o))):(w=i("td","",d),k=i("div","","td-wrap"),null===r||""===r?T=i("span","--"):(T=i("span",bdpChart.helper.dataLabelFormatter(n,p[b].data[O],o)),P&&P.hasOwnProperty("color")&&(w.style.color=P.color),P&&P.hasOwnProperty("backgroundColor")&&(w.style.backgroundColor=P.backgroundColor))),k.appendChild(T),w.appendChild(k),S.appendChild(w)}c.tb_statistic.col&&"bottom"===A&&this.drawColSummaryData(S,p[b].col_summary,o,n,d),v.appendChild(S)}return v},drawColSummaryData:function(t,e,a,r,n){var o=i("span",bdpChart.helper.dataLabelFormatter(r,e,a)),l=i("td",void 0,"th"),s=i("div","","td-wrap "+n);s.appendChild(o),l.appendChild(s),t.appendChild(l)},mergeCell:function(){var t,e=this.getRowHeight(),a=O.data.info.compare_axis.length,i=v.find(".fht-fixed-column .fht-thead"),r=v.find(".fht-fixed-column .fht-tbody"),n=v.find(".hz-table-body");t=v.find(E.pinnedIndex>0?".fht-fixed-body .fht-thead .hz-table-header":".fht-thead .hz-table-header");var o=(r.clone(),n.clone());if(t.clone(),i.clone(),k&&s.data.x.length>1)for(var l=0;l<s.data.x.length;l++)v.find(".hz-table-header").mergeRow(l,0,!0);if(a>0){for(var d=0;d<E.compareLevel-1;d++)o.mergeCol(d,e);n[0]&&(n[0]=bdp.utils.replaceHtml(n[0],o.html()))}},fixHeader:function(){var t={borderCollapse:!1,fixedColumn:!1};if("fullscreen"===s.mode){var e=$("#"+E.addId);e.fixedHeaderTable("destroy"),e.fixedHeaderTable(t)}else(C||"edit"==s.mode||"fullscreen"==s.mode)&&v.find(".hz-table").fixedHeaderTable(t);E.hoverDesc(),(E.compareLevel>1||s.data.x.length>1)&&p(v)},hoverDesc:function(){t(v)},handleLink:function(t,e,a,i,r){for(var n="cur-link-item",o=(E.linkInfo,e.attr("data-current")),l=v.find("."+a),s=0,d=l.length;d>s;s++){var h=$(l[s]);h.attr("data-current")==o?h.hasClass(n)?(h.removeClass(n),delete E.pointData[i]):(h.addClass(n),E.pointData[i]=o):h.removeClass(n)}t.pointData=E.pointData,t.emit("refreshLinkedCharts",r,t)},handleJump:function(t){s.emit("jumpToOtherDash",t,s)},bindEvents:function(){v.off().on("click",function(t){C||(C=!0,E.init(),v.parents(".item-chart").removeClass("noscroll").addClass("toggle-scroll"));var e=t.target,a=e.className;a.indexOf("drilldown")>-1&&s.emit("drilldown",e,s);var i=$(e),r=i[0]&&i[0].className.match(/J-link(\d+)/);if(r){var n=r&&r[0],o=r&&r[1];E.handleLink(s,i,n,o,t)}i.hasClass("J-jump")&&E.handleJump(i.attr("data-current"))}),E.hoverDesc(),e(v),c()}},O={data:s,pageNum:1,perPageNum:50,compareLevel:1,isPinned:!!w,pinnedIndex:w,scrollXNum:0,destroy:function(){l={},v.html("")},getRowHeight:function(){return 35},sort:function(t){var e,a=t[0]&&t[0].className,i=t.data("axis"),r=t.data("fid"),n=t.data("uniq-id"),o="";switch(/(?:^|\s*)(desc|asc)(?:\s*|$)/.test(a)&&(o=RegExp.$1),o){case"desc":e="asc";break;case"asc":e="";break;default:e="desc"}var l={axis:"y_optional"==i?"y":i,type:e,fid:r,uniq_id:n,col_index:t.index()};if(n&&(l.uniq_id=n),"edit"===s.mode){var d=O.data.info.drill_level;s.emit("saveWithOpt",d,{sort:l,is_advanced_sort:0})}else{var h={sort:JSON.stringify(l),is_advanced_sort:0};s.requestData(h).then(function(t){"0"==t.status?O.init(t.result):errorHandle(t)}),s.emit("dashboard_click_sort")}},mergeCell:function(t,e){var a,i=O.isPinned||n[b],r=this.getRowHeight(),o=O.data.info.compare_axis.length,l=v.find(".fht-fixed-column .fht-thead"),d=v.find(".fht-fixed-column .fht-tbody"),h=v.find(".hz-table-body"),c=O.data.info.x.length;a=v.find(e?".hz-table .hz-table-header":O.pinnedIndex>0&&i?".fht-fixed-body .fht-thead .hz-table-header":".fht-thead .hz-table-header");var p=d.clone(),u=h.clone(),f=a.clone(),m=l.clone();if(k)for(var g=0;t-1>g;g++)p.mergeCol(g,r),(O.pinnedIndex<1||!i||i&&O.pinnedIndex<t-1||e)&&u.mergeCol(g,r);d[0]&&(d[0]=bdp.utils.replaceHtml(d[0],p.html())),h[0]&&(h[0]=bdp.utils.replaceHtml(h[0],u.html()));var y=function(t){for(var e,a="fullscreen"===s.mode?49*O.compareLevel:33*O.compareLevel,i=0;o+1>i;i++)e=t.eq(i).find(".th-xaxis"),0===i?e.attr("rowspan",o+1).height(a+1):e.addClass("hidden")};if(o>0){for(var _=this.getPinnedIndex(),x=0;o>x;x++)c>_?f.mergeRow(x,c):f.mergeRow(x,i?_:c),m.mergeRow(x,c,!0);y(m.find("tr")),y(f.find("tr")),a[0]&&(a[0]=bdp.utils.replaceHtml(a[0],f.html())),l[0]&&(l[0]=bdp.utils.replaceHtml(l[0],m.html()))}},mergeCell0:function(t){var e=O.data.info.compare_axis.length,a=v.find(".fht-fixed-column .fht-thead"),i=v.find(".fht-fixed-column .fht-tbody"),r=v.find(".hz-table-header"),o=v.find(".hz-table-body");if(k)for(var l=0;t-1>l;l++)i.mergeCol(l),o.mergeCol(l);var d=function(t){for(var a,i="fullscreen"===s.mode?49*O.compareLevel:33*O.compareLevel-16,r=0;e+1>r;r++)a=t.eq(r).find(".th-xaxis"),0===r?a.attr("rowspan",e+1).height(i+1):a.addClass("hidden")};if(e>0){for(var h=this.getPinnedIndex(),c=O.isPinned||n[b],p=0;p<O.compareLevel;p++)r.mergeRow(p,c?h:0),a.mergeRow(p,0);d(a.find("tr"),"fixed"),d(r.find("tr"),"origin")}},hoverCell:function(){var t=v.find(".hz-table tbody tr");v.find("td").hover(function(){var e,a,i=$(this),r=i.parent(),n=i.siblings(),o=Number(i.attr("rowspan")||0),l=0,s=0;if(o>0)if(l=r.index(),s=i.index(),o<Number(i.prev().attr("rowspan")||0))for(e=l;l+o>e;e++){var d=t.eq(e).find("td");for(a=s;a<n.length+1;a++)d.eq(a).addClass("hover")}else for(e=l;l+o>e;e++)t.eq(e).addClass("hover");else if($.each(n,function(){$(this).attr("rowspan")&&(s=$(this).index())}),n.length&&(s||n.eq(s).attr("rowspan")))for(a=s+1;a<n.length+1;a++)i.parent().find("td").eq(a).addClass("hover");else r.addClass("hover")},function(){v.find(".hover").removeClass("hover")})},initHead:function(){var t=O.data.data,e=O.data.info,a=e.sort,r=e.is_advanced_sort;t.y.length?t.y[0].name==m&&t.y[1]&&t.y[1].compare_names?O.compareLevel=t.y[1].compare_names.length:t.y[0].compare_names&&(O.compareLevel=t.y[0].compare_names.length||O.compareLevel):t.y_optional.length&&t.y_optional[0].compare_names&&(O.compareLevel=t.y_optional[0].compare_names.length),O.compareLevel=O.compareLevel||1;for(var n,o=document.createDocumentFragment(),l=0;l<O.compareLevel;l++){var s,d,h,c,p,u,f=i("tr");if(0===l)for(var g=0;g<O.xaxisAmount;g++)_=t.x[g].uniq_id?a&&"x"===a.axis&&a.uniq_id===t.x[g].uniq_id?a.type:"":a&&"x"===a.axis&&a.fid===t.x[g].fid?a.type:"",_=_||"default",n=t.x[g].nick_name||t.x[g].name,s=i("th",void 0,"th-xaxis th table-sort "+_),d=i("div","","td-wrap trigger-col-sort"),u=i("span",n,"trigger-col-sort"),p=e.x[g]?e.x[g].description:void 0,p&&(u.setAttribute("description",p),u.className+=" description"),s.setAttribute("data-axis","x"),s.setAttribute("data-fid",t.x[g].fid),s.setAttribute("data-uniq-id",t.x[g].uniq_id),c=i("i","","trigger-col-sort bdp-icon ico-"+_+"-sort-arrow"),1==r&&(c=i("i","","trigger-col-sort bdp-icon")),u.appendChild(c),d.appendChild(u),s.appendChild(d),f.appendChild(s);else for(var y=0;y<O.xaxisAmount;y++)n=t.x[y].name,s=i("th","","th-xaxis th"),d=i("div","","td-wrap trigger-col-sort"),h=i("span",n,"trigger-col-sort"),d.appendChild(h),s.appendChild(d),f.appendChild(s);f.appendChild(F("y",O.yaxisAmount,l)),f.appendChild(F("y_optional",O.yaxisOptionalAmount,l)),o.appendChild(f)}v.find(".hz-table-header")[0].appendChild(o)},initBody:function(t){var e=O.data.info,a=O.data.data,r=O.linkInfo,n=O.jumpInfo,o=[];r&&r.length>0&&angular.forEach(r[0].field_map,function(t){o.push(t.index)});var l,s,d,h,c,p=0,u=t*O.perPageNum>O.totalData?O.totalData:t*O.perPageNum,f=document.createDocumentFragment(),m=function(t,a){return e.tb_statistic.col&&e.tb_statistic.subtotal&&!$.isEmptyObject(t)&&$.isArray(t[a])};if(O.xaxisAmount>0)for(var g=0,y=a.subtotal,_=p;u>_;_++){l=document.createElement("tr");for(var b,x,C,w,k,S=/^(http:|https:|ftp:)[\S]+\.(jpg|jpeg|bmp|gif|png)$/i,D=_+("top"===A),M=0;M<O.xaxisAmount;M++){if(s=e.xAxis[M].data_type,c=e.xAxis[M].alignment_method?e.xAxis[M].alignment_method:"right",d=a.x[M].data[_],"string"!==s||e.xAxis[M].alignment_method?e.xAxis[M].alignment_method||(c="right"):c="left","center"===c?h="text-center":"left"===c?h="text-left":"right"===c&&(h="text-right"),C=i("span"),null===d||""===d)C.innerHTML="",k="";else{k=O.handleXaxisDate(d,e.xAxis[M]);var w=e.xAxis[M].granularity||"day";"week"===w&&(h="text-left")}if(e.is_drill&&e.xAxis[M].fid===e.level_fields[e.drill_level].fid){var T="";if("string"==s&&"img"==e.xAxis[M].data_show_type&&S.test(k)){T=i("img","","cursor-pointer chart-table-type-img J-hz-table-show-img drilldown"),T.setAttribute("src",k),T.setAttribute("data-src",k),T.setAttribute("data-drill-value",d),T.setAttribute("data-text",k);var L=i("i",k,"chart-table-type-img J-hz-table-show-img hidden");L.setAttribute("data-src",k),L.setAttribute("data-text",k),C.appendChild(L)}else T=i("a",k,"drilldown"),T.setAttribute("data-drill-value",d);C.appendChild(T)}else if("string"==s&&"img"==e.xAxis[M].data_show_type&&S.test(k)){var E=i("img","","chart-table-type-img J-hz-table-show-img");E.setAttribute("src",k),E.setAttribute("data-src",k),E.setAttribute("data-text",k),C.appendChild(E);var L=i("i",k,"chart-table-type-img J-hz-table-show-img hidden");L.setAttribute("data-src",k),L.setAttribute("data-text",k),C.appendChild(L)}else C.innerHTML=""!==k?bdp.utils.encodeHTML(k):"";if(d=d||"",!("http://"!==d.toString().substr(0,7)&&"https://"!==d.toString().substr(0,8)||"string"==s&&"img"==e.xAxis[M].data_show_type&&S.test(k))){var F=document.createTextNode("  "),N=i("a");k=d,N.setAttribute("href",d),N.setAttribute("target","_blank"),N.appendChild(i("i","","bdp-icon ico-href")),C.appendChild(F),C.appendChild(N)}if(!e.is_drill&&$.inArray(M,o)>-1){var z=h+" point-status J-link"+M;d==O.pointData[M]&&(z+=" cur-link-item"),b=i("td","",z),b.setAttribute("data-current",d)}else if(!e.is_drill&&n&&n.fid&&n.f_index==M){var z=h+" point-status J-jump";b=i("td","",z),b.setAttribute("data-current",d)}else b=i("td","",h);x=i("div","","td-wrap"),x.appendChild(C),b.appendChild(x),l.appendChild(b)}l.className+=" r"+(g+D);var B=P("y",O.yaxisAmount,_),I=P("y_optional",O.yaxisOptionalAmount,_);if(l.appendChild(B),l.appendChild(I),f.appendChild(l),m(y,_))for(var H=0,W=y[_].length;W>H;H++){var R=y[_][H];g++,O.drawColSubTotal(f,R,"bottom","r"+(g+D))}}else for(var W=a.y.length&&a.y[0].data.length||a.y_optional.length&&a.y_optional[0].data.length||0,j=0;W>j;j++)l=i("tr"),l.appendChild(P("y",O.yaxisAmount,j)),l.appendChild(P("y_optional",O.yaxisOptionalAmount,j)),f.appendChild(l);e.tb_statistic.col&&this.drawColSummary(f,A),v.find(".hz-table-body").append(f)},mergeSummary:function(t){v.find(".summary-td").each(function(e){if(O.isPinned){var a=Math.min(O.xaxisAmount,O.pinnedIndex);t?0===e?$(this).attr("colspan",O.xaxisAmount):$(this).addClass("hidden"):0===e?$(this).attr("colspan",a):e===a?$(this).attr("colspan",O.xaxisAmount):$(this).addClass("hidden")}else e%O.xaxisAmount===0?$(this).attr("colspan",O.xaxisAmount):$(this).addClass("hidden")})},drawColSubTotal:function(t,e,a,r){for(var n,o,l,s,d,h,c,p,u=null,f="--",m="td-wrap",g="subtotal-td-"+r,v=" summary-td-value "+g,_=O.data.data,b=O.data.info,x=O.xaxisAmount,C=O.yaxisAmount,w=O.isPinned,k=O.pinnedIndex,A=" ",S=i("tr","",a+" summary bdp-merge-row "+r),D=0,M=e.length;M>D;D++){var L=e[D];if(x>D)u=i("td","",v+A),L===T?(L=y,tdDiv=i("div",L,m),u.appendChild(tdDiv),l=D,s=x-l,d=w&&k-l,h=w&&k>l&&x>=k,h?$(u).attr("colspan",d):$(u).attr("colspan",s)):(L=O.handleXaxisDate(L,b.xAxis[D]),tdDiv=i("div",L,m),u.appendChild(tdDiv),void 0!==l&&(h?D==k?$(u).attr("colspan",x-k):(k>D||D>k)&&$(u).addClass("hidden"):$(u).addClass("hidden"))),S.appendChild(u);else{var E=D-x,P=D-x-C,F={};D>=x+C?(p="y_optional",F=_[p][P]):(p="y",F=_[p][E]),c=F.alignment_method?F.alignment_method:"right","center"===c?A=" text-center":"left"===c?A=" text-left":"right"===c&&(A=" text-right"),n=F.formatter,o=F.aggregator,$.isArray(L)&&(L=L[0]),null===L||L==f?(tdclassname=v+A,tdText=f):(tdText=bdpChart.helper.dataLabelFormatter(n,L,o),tdclassname=A),u=i("td","",tdclassname),tdDiv=i("div",tdText,m),u.appendChild(tdDiv),S.appendChild(u)}}"bottom"===a&&t.appendChild(S)},handleXaxisDate:function(t,e){var a,i=e.data_type;if("date"===i){g=e.granularity||"day";var r=e.granularity_name||"",n=e.month_start_day||0;("hour"===g||"minute"===g||"second"===g)&&(g="g_"+g),"week"===g&&(n=e.week_start_day_of_week||1,currentClass="text-left"),["(空白)","(Blank)"].indexOf(t)>-1?a=t:(a=bdpChart.helper.checkGranularity(g,t,r,n),"week"===g&&(a+="（"+Highcharts.dateFormat("%b/%e",new Date(t))+"~"+Highcharts.dateFormat("%b/%e",new Date(t+5184e5))+"）"))}else"sub_date"==i?(g=e.fid.split("_")[1],a=bdpChart.helper.subDateFormat(g,t)):a=t;return a=a?a.toString():""},drawColSummary:function(t,e){if(O.xaxisAmount){var a,r,n,o,l,s,d,h,c=O.data.data;O.data.info,a=i("tr","","summary bdp-merge-row "+e),"top"===e&&(a.className+=" r0");for(var p=0;p<O.xaxisAmount;p++)r=i("td","","summary-td summary-td-value text-left"),n=i("div",m,"td-wrap"),r.appendChild(n),a.appendChild(r);for(var u=0;u<O.yaxisAmount;u++)o=c.y[u].col_summary,l=c.y[u].formatter,s=c.y[u].aggregator,d=c.y[u].alignment_method?c.y[u].alignment_method:"right","center"===d?h="text-center":"left"===d?h="text-left":"right"===d&&(h="text-right"),null===o?(r=i("td","",h),n=i("div","--","td-wrap"),r.appendChild(n)):(r=i("td","",h),n=i("div",bdpChart.helper.dataLabelFormatter(l,o,s),"td-wrap"),r.appendChild(n)),a.appendChild(r);for(var f=0;f<O.yaxisOptionalAmount;f++)o=c.y_optional[f].col_summary,l=c.y_optional[f].formatter,s=c.y_optional[f].aggregator,d=c.y_optional[f].alignment_method?c.y_optional[f].alignment_method:"right","center"===d?h="text-center":"left"===d?h="text-left":"right"===d&&(h="text-right"),null===o?(r=i("td","",h),n=i("div","--","td-wrap"),r.appendChild(n)):(r=i("td","",h),n=i("div",bdpChart.helper.dataLabelFormatter(l,o,s),"td-wrap"),r.appendChild(n)),a.appendChild(r);"bottom"===e?t.appendChild(a):"top"===e&&t.firstChild&&t.insertBefore(a,t.firstChild)}},initLoadMore:function(){O.pageNum*O.perPageNum>=O.totalData||v.find(".load-more").length||v.find(".fht-tbody").append('<button class="load-more J-table-load-more">'+u+"</button>")},init:function(t,e){O.destroy(),O.data=t,O.linkInfo=t.optional&&t.optional.link_info,O.jumpInfo=t.optional&&t.optional.chart_jump_info,O.pageNum=e||1;var a=t.data;if(O.xaxisAmount=a.x.length,O.yaxisAmount=a.y.length,O.yaxisOptionalAmount=a.y_optional.length,O.pointData=s.pointData||new Array(O.xaxisAmount),s.pointData=O.pointData,O.totalData=a.x[0]&&a.x[0].data.length||a.y[0]&&a.y[0].data.length||a.y_optional[0]&&a.y_optional[0].data.length||0,0===O.totalData)return void v.append('<div class="chart-error"><p class="no-data">'+M+"</p></div>");var i;i=$("fullscreen"==s.mode?'<div class="chart-table"><table class="hz-table"><thead class="hz-table-header"></thead><tbody class="hz-table-body"></tbody></table></div>':'<table class="hz-table"><thead class="hz-table-header"></thead><tbody class="hz-table-body"></tbody></table>'),v.append(i),O.initHead(),O.initBody(O.pageNum),O.addId=(v[0].className.split(" ")[1]+b).toUpperCase(),v.find(".hz-table").attr("id",O.addId);var r="ico-pin-gray";if(v.find("th > .td-wrap").prepend('<i class="pin bdp-icon '+r+'"></i>'),"true"==v.attr("data-drill")||"true"==v.attr("data-drill-status")||C||"edit"==s.mode||"fullscreen"==s.mode||"chartTpl"==s.mode)O.fixHeader(),O.mergeCell(O.xaxisAmount),this.mergeSummary();else{var n=$("#"+O.addId);n.wrap('<div style="width:100%; height: 100%; overflow: hidden"></div>'),n.wrap('<div class="no-fix-header J_no_fix"></div>'),n.css({width:"100%"}),O.mergeCell(O.xaxisAmount,!0),this.mergeSummary(!0)}v.find(".fht-empty-cell").addClass("hidden"),this.changePinIcon(),O.initLoadMore(),O.bindEvents($.extend(s,t)),O.scrollToPosition()},scrollToPosition:function(){for(var t=v.find(".fht-tbody .hz-table-body"),e=0,a=v.find(".fht-tbody .hz-table .hz-table-body").find("tr"),i=0;i<(O.pageNum-1)*O.perPageNum;i++)e+=a.eq(i).height();e=e-v.find(".fht-tbody").height()+v.find(".load-more").height(),t.find(".summary").length&&(e+=t.find(".summary").height()),O.isPinned?v.find(".fht-fixed-body .fht-tbody").scrollTop(e):v.find(".fht-tbody").scrollTop(e),O.scrollXNum>0&&O.pageNum>1&&v.find(".fht-tbody").scrollLeft(O.scrollXNum)},getPinnedIndex:function(){var t=r[b]||O.pinnedIndex;return"edit"===s.mode&&(t=O.pinnedIndex||o[b]),t},changePinIcon:function(){var t=O.data.data,e=this.getRowHeight();if(O.isPinned||n[b]){var a="ico-pin-gray",i="ico-pinned-blue",r=O.data.info.tb_statistic.row,o=[].concat(t.x,t.y,t.y_optional||[]).length,l=t.y.length&&t.y[0].fid,s=this.getPinnedIndex(),d=$("#"+O.addId).parents(".chart-table").find(".fht-fixed-column thead"),h=d.clone(),c="row_summary";h.find("tr").each(function(n){if(r&&(s===o&&0===n||s!==o)||!r||l==c){var d=$(this).find("th"),h=d.last().find(".pin"),p=$(this).find('[data-fid="'+c+'"]').attr("rowspan"),u=$(d[s-1]).attr("data-fid");d.height(),h.removeClass(a).addClass(i),0==t.x.length&&p&&u==c&&l==c&&d.height((e-1)*p-1)}}),d[0]&&(d[0]=bdp.utils.replaceHtml(d[0],h.html()))}},fixHeader:function(){var t=O.isPinned||n[b],e=O.data.data,a=e.x.length+e.y.length+e.y_optional.length,i=r[b]||O.pinnedIndex;i>a&&(t=!1),"edit"===s.mode&&(i=O.pinnedIndex||o[b],n[b]=!1);var l=t?{borderCollapse:!1,fixedColumn:!0,fixedColumns:i,$elem:v}:{},d=$("#"+O.addId);if(d.fixedHeaderTable("destroy"),d.fixedHeaderTable(l),O.pageNum*O.perPageNum<O.totalData){var h=v.find(".fht-fixed-column .fht-tbody");d.parent().append('<button class="load-more J-table-load-more">'+u+"</button>"),h.append('<button class="load-more J-table-load-more"></button>')}if("edit"===s.mode){var c=O.data.info.drill_level;O.isPinned||(O.pinnedIndex=0),s.emit("saveWithOpt",c,{tb_pinned_index:O.pinnedIndex},{not_need_redraw:!0}),o[b]=O.isPinned?s.info.tb_pinned_index:0}O.hoverDesc(),(O.compareLevel>1||O.xaxisAmount>1)&&p(v)},hoverDesc:function(){t(v)},bindEvents:function(t){v.off().on("click",function(e){var a=e.target,i=a.className,o=$(a).closest("td"),l=o[0]&&o[0].className.match(/J-link(\d+)/);if(l){var s=$(a).closest("tr").find("td:first-child"),d=s.find("span:first-child").html(),h=l&&l[0],c=l&&l[1];O.handleLink(t,o,h,c,d)}if(i.indexOf("load-more")>-1){var p=v.find(".fht-fixed-body .fht-thead .fht-table");p.length<=0&&(p=v.find(".fht-thead .fht-table")),O.scrollXNum=p.css("marginLeft").replace(/(px)|-/g,""),O.pageNum*O.perPageNum<O.totalData?setTimeout(function(){new Date,O.init(t,++O.pageNum),new Date},100):$(a).text("数据已经全部加载").fadeOut()}else if(i.indexOf("drilldown")>-1)v.attr("data-drill","true"),t.emit("drilldown",a,t);else if(i.indexOf("pin")>-1){O.isPinned=i.indexOf("ico-pinned")<0,n[b]=O.isPinned;var u=$(a).parents(".td-wrap").parent();O.pinnedIndex=u.index()+ +(u.attr("colspan")||1),r[b]=O.pinnedIndex,v.find(".added-watch-scroll").each(function(){$(this).prev().show(),$(this).remove()}),new Date,O.init(t,O.pageNum);var e=new Date}else i.indexOf("table-sort")>-1?O.sort($(a)):i.indexOf("trigger-col-sort")>-1?O.sort($(a).parents(".table-sort")):o[0]&&o[0].className.indexOf("J-jump")>-1&&O.handleJump(o.attr("data-current"));C||"edit"==t.mode||"fullscreen"==t.mode||(C=!0,O.init(t,O.pageNum),v.parents(".item-chart").removeClass("noscroll").addClass("toggle-scroll"))}),O.bindFixedEvent(),"fullscreen"===t.mode&&O.hoverCell(),("true"==v.attr("data-drill")||C||"edit"==t.mode||"fullscreen"==t.mode)&&O.addScrollEvent(t),O.hoverDesc(),e(v),c()},bindFixedEvent:function(){var t=s.$elem;if(O.isPinned){var e=v.find(".fht-fixed-column .fht-tbody"),a=v.find(".fht-fixed-body .fht-tbody");e.bind("scroll",function(){t.attr("data-scrolling-fixed","true"),t.attr("data-scrolling-right","false"),t&&"true"===t.attr("data-scrolling-right")||a.scrollTop(e.scrollTop())})}},handleLink:function(t,e,a,i){for(var r="cur-link-item",n=(O.linkInfo,e.attr("data-current")),o=v.find("."+a),l=0,s=o.length;s>l;l++){var d=$(o[l]);d.attr("data-current")==n?d.hasClass(r)?(d.removeClass(r),delete O.pointData[i]):(d.addClass(r),O.pointData[i]=n):d.removeClass(r)}t.pointData=O.pointData,t.emit("refreshLinkedCharts",e,t)},handleJump:function(t){O.jumpInfo,s.emit("jumpToOtherDash",t,s)},addScrollEvent:function(t){var a,i=v.find(".r0").find("td").last().outerHeight(),r=this.getPinnedIndex();if(v.find(".fht-tbody").length>1){var a=v.find(".fht-fixed-column .fht-tbody table");a.css({position:"relative"})}var n=v.find(".hz-table-body"),o=v.find(".summary").hasClass("top");v.find(".fht-tbody").scrollEnd(function(){var l=$(this),s=t.$elem,d=l[0].scrollTop,h=l[0].getBoundingClientRect(),c=l[0].scrollLeft,p=parseInt(d/i,10),u="r"+p,f=$(this).find("."+u)[0];s&&s.attr("data-scrolling","false"),s&&s.attr("data-scrolling-fixed","false"),s&&s.attr("data-scrolling-right","false");var m=v.find(".fht-fixed-column .fht-tbody"),g=v.find(".fht-fixed-body .fht-tbody");g.scrollTop(m.scrollTop());var y,_,b,x,C,w,k,A,S,D=function(a,r,n){if(_=$(a).next().find(r),b=v.find(r).find(".added-watch-scroll"),b.siblings().find("span").show(),b.remove(),!_.length&&(x=$(a).prevAll().find(r),C=$(a).find(r),x.length||C.length)){if(x.length&&(w=$(x)[x.length-1]),C.length&&(w=$(C)[0]),$(a).next().find("td").eq($(w).index()).is(":visible"))return;if(k=$(w).find("span"),A=w.getBoundingClientRect(),S=$(w).find(".added-watch-scroll"),!$(S).length){var l=o?(Math.floor(d/i)+1)*i+6:Math.ceil(d/i)*i+6;$(k).clone().addClass("added-watch-scroll").css({position:"absolute",left:A.left-h.left+(n?c:0)+16,top:l}).appendTo(w);var s=t.info.xAxis[M];(["number","sub_date"].indexOf(s.data_type)>-1||"date"===s.data_type&&"week"!==s.granularity)&&$(k).parent(".td-wrap").next().css({left:A.left-h.left+(n?c:0)+A.width-$(k).width()-16}),$(k).hide(),$(w).find(".J-hz-table-show-img").length>0&&e($(w))}}};if(a)for(var M=0;r>=M;M++){y=a.find($("tr :nth-child("+(M+1)+")").filter(function(){return this.rowSpan>1}));var T=a.find("tr").eq(p);D(T,y,!1)}for(var M=O.isPinned?r:0;M<O.xaxisAmount;M++)y=n.find($("tr :nth-child("+(M+1)+")").filter(function(){return this.rowSpan>1})),D(f,y,!0)},300,v)}},P=function(t,e,a){var r,n,o,l,s,d,h=O.data.data,c=O.data.info,p=c.warn,u="text-right",f=document.createDocumentFragment();1===p&&c.warn_info.length&&c.warn_info.forEach(function(e){(0===e.axis_type&&"y"===t||1===e.axis_type&&"y_optional"===t)&&(s=e)});for(var m=0;e>m;m++){d=h[t][m]&&h[t][m].alignment_method?h[t][m].alignment_method:"right","left"===c.tb_statistic.row_pos&&"true"===c.tb_statistic.row&&c[t][m].alignment_method?h[t][0].alignment_method=c.tb_statistic.row_setting.alignment_method:"right"===c.tb_statistic.row_pos&&"true"===c.tb_statistic.row&&c[t][m].alignment_method&&(h[t][e-1].alignment_method=c.tb_statistic.row_setting.alignment_method),u="center"===d?"text-center":"left"===d?"text-left":"right"===d?"text-right":"text-right",n=h[t][m].formatter,o=h[t][m].aggregator,r=h[t][m].data[a];var g,y,v,_=h[t][m].cell_styles?h[t][m].cell_styles[a]:null,b=!1;h[t][m].hasOwnProperty("warn_data")&&angular.forEach(h[t][m].warn_data,function(t){1===t&&(b=!0)}),null!==r&&!c.drill_level&&b?(l="cr "+u,g=i("td","",u),v=bdpChart.helper.dataLabelFormatter(n,h[t][m].data[a],o),y=i("div",v,"td-wrap"),1==p&&1==h[t][m].warn_data[a]&&(g.className=l)):null===r?(g=i("td","",u),v="--",y=i("div",v,"td-wrap")):(g=i("td","",u),v=bdpChart.helper.dataLabelFormatter(n,h[t][m].data[a],o),y=i("div",v,"td-wrap"),_&&angular.forEach(_,function(t,e){g.style[e]=t})),g.appendChild(y),f.appendChild(g)}return f},F=function(t,e,r){var n,o,l,d=O.data.data,h=O.data.info,c=h.sort,p=h.warn,u=[],f=!1,g=document.createDocumentFragment(),y=h.is_advanced_sort,v=h.compare_setting&&h.compare_setting.sort.index||0,b={};if(!h.drill_level&&1===p&&h.warn_info.length&&O.data.info.compare_axis.length>0&&0===r){var x=s.data[t];angular.forEach(x,function(t){t.hasOwnProperty("warn_data")&&a(t.warn_data)&&(b[t.uniq_id]=!0)})}for(var C=0;e>C;C++){n="y"===t?d.x.length+C:d.x.length+d.y.length+C,_="default";var w="y_optional"==t?"y"==c.axis:t==c.axis,k=defined(c.uniq_id)&&c.uniq_id==d[t][C].uniq_id||!defined(c.uniq_id);c&&w&&c.fid===d[t][C].fid&&k&&(defined(c.uniq_id)&&0==r?_=c.type:defined(c.col_index)?_=c.col_index===n?c.type:"":0===r&&(_=c.type),_=_||"default"),o=d[t][C].compare_names||[d[t][C].nick_name||d[t][C].name],1==o.length&&d[t][C].name==m&&(l=C,o[r]=o[0]);var A="";if(d[t][C].hasOwnProperty("unit_adv")&&d[t][C].unit_adv&&r===v&&(A="("+d[t][C].unit_adv+")"),f=!1,!h.drill_level&&1===p&&h.warn_info.length){var S=s.data[t][C];u=S,S.hasOwnProperty("warn_data")&&(f=a(S.warn_data))}var D,$;if(h.yAxisOptional.length&&"y_optional"!==t||!h.tb_statistic.row||C!=l){D=i("th","","th table-sort "+_),D.setAttribute("data-axis",t),D.setAttribute("data-fid",d[t][C].fid),D.setAttribute("data-uniq-id",d[t][C].uniq_id),$=i("div","","td-wrap trigger-col-sort"),0===r&&b[d[t][C].uniq_id]?$.appendChild(i("i","","warn-label-left")):u&&u.fid===d[t][C].fid&&f&&$.appendChild(i("i","","warn-label-left"));var M=i("span",o[r]+A,"trigger-col-sort"),T=i("i","","trigger-col-sort bdp-icon ico-"+_+"-sort-arrow");1==y&&(T=i("i","","trigger-col-sort bdp-icon")),M.appendChild(T);var L;r===v&&(L=d[t][C]?d[t][C].description:void 0,L&&(M.setAttribute("description",L),M.className+=" description")),$.appendChild(M),D.appendChild($)}else{if(C==l){D=i("th","","th table-sort "+_),$=i("div","","td-wrap trigger-col-sort");var E=i("span",o[r]+A,"trigger-col-sort"),T=i("i","","trigger-col-sort bdp-icon ico-"+_+"-sort-arrow");1==y&&(T=i("i","","trigger-col-sort bdp-icon")),E.appendChild(T);var L;r===v&&(L=d[t][C]?d[t][C].description:void 0,L&&(E.setAttribute("description",L),E.className+=" description")),$.appendChild(E)}else D=i("th","","cursor-default th"),$=i("div","","td-wrap");D.setAttribute("data-axis",t),D.setAttribute("data-fid",d[t][C].fid),D.setAttribute("data-uniq-id",d[t][C].uniq_id),u&&u.fid===d[t][C].fid&&f&&$.appendChild(i("i","","warn-label-left")),0!==r?D.className+=" hidden":D.setAttribute("rowSpan",O.compareLevel),C!=l&&$.appendChild(document.createTextNode(o[r])),D.appendChild($)}g.appendChild(D)}return g};x?E.init():O.init(s)}}(),!function(){function t(t,e){var a=(t.info,t.data),i=a.y[e].data[0],r=0,n=1,o=!$.isEmptyObject(a.gauge_setting),l="--";return i>=0&&1/0!==i?(r=i,o?(n=a.gauge_setting.goal.values?a.gauge_setting.goal.values[e]:a.gauge_setting.goal.value,n>0&&1/0!==n?l=r/n:n=0==i?1:i):(n=0==i?1:i,l=r/n)):(r=1/0!==i?i:0,o?(n=a.gauge_setting.goal.values?a.gauge_setting.goal.values[e]:a.gauge_setting.goal.value,n>0&&1/0!==n||(n=1)):n=1),{showNumber:+r,tickMaxNumber:+n,percentage:l}}function e(t,e,i){var r=t.data.y[e],n=!t.info.tb_conditional_formatting||!t.info.tb_conditional_formatting.length;return r.series_color?r.series_color:r.cell_styles&&r.cell_styles.length>0&&r.cell_styles[0]?r.cell_styles[0].backgroundColor:n?(i.tickMaxNumber,0===i.showNumber?a[4]:a[1]):a[0]}bdpChart.setGaugeSpecialOption=function(a){var i=a.$elem,r=a.info,n=a.data,o=o||2;if(0==n.y.length){i.find(".solidgauge-title").remove();var l="zh"==bdpChart.language?"当前图表无数据":"No data to display";return void i.append('<div class="chart-error"><p class="no-data">'+l+"</p></div>")}i.find(".chart-error").remove();var s={1:"rgba(255,255,255,0.1)",2:"#E5E5E5"},d=n.y[0].name;$.isEmptyObject(n.gauge_setting)?$.isEmptyObject(r.gauge_setting)?r.gauge_setting={}:d=r.gauge_setting.name||n.y[0].name:d=n.gauge_setting.name||n.y[0].name;var h=n.y.length,c=Math.min(i.height(),i.width());if(h>0){var p=a._getGridSetting();c=Math.min(p.boxWidth,p.boxHeight)}var u=r.gauge_setting.rateDigit||0,f=[25,20,16,14,14],m="20px",g="12px",y=.002*c+.15;350>c?m=.03*c+10+"px":400>c?(m="22px",g="14px"):450>c?(m="24px",g="16px"):(m="32px",g="18px");var v="";(1==a.gridHeight||1==a.gridWidth)&&(v=111>c?"position:absolute;top:-6px;left:-40px;":"margin-top:-6px;");var _=[],b=[];n.y.forEach(function(i,r){var o=t(a,r),l=o.showNumber,s=o.tickMaxNumber,d=o.percentage,h=e(a,r,o);_.push({lineColor:"red",lineWidth:0,tickWidth:0,minorTickInterval:null,tickPositioner:function(){return[0,s]},title:{text:""},min:0,max:s,stops:[[0,h],[1,h]],labels:{style:{fontSize:g},y:24,useHTML:!0,formatter:function(){var t=0;return n.gauge_setting&&n.gauge_setting.goal&&void 0!==n.gauge_setting.goal.digit&&(t=n.gauge_setting.goal.digit),this.value?x(this.value,t):this.value}}}),b.push({name:n.y.length>0?n.y[0].name:"",data:[l],innerRadius:"75%",outerRadius:"100%",dataLabels:{useHTML:!0,formatter:function(){var t,i;"--"===d?(t=-120,i="--"):(i=(100*d).toFixed(u)+"%",t=-120+Math.floor(240*d)),t=t>120?121:t;var n=e(a,r,o);return'<div class="solidguage-custom" style="transform:scale('+y+");-webkit-transform:scale("+y+");"+v+'"><span class="solidgauge-percent">'+i+'</span><div class="pa solidgauge-angle" style="background-color:'+n+";transform:rotate("+t+"deg);-webkit-transform:rotate("+t+'deg)"><span class="solidgauge-angle-arrow" style="border-bottom-color:'+n+'"></span></div></div>'}}})});var x=function(t,e){if(0>=t)return t;var a,i,r=bdpChart.helper.numericSymbols(t,e).toString();return 1e3>r?(a=r,i=""):(a=Number(r.substring(0,r.length-1)).toFixed(6),i=r.substr(r.length-1,1)),a=Highcharts.numberFormat(a,e,".",","),a+i},C=a.options,w=b[0].data[0],k='<div class="solidgauge-title"><p class="unit">'+bdpChart.helper.dataLabelFormatter(n.y[0].formatter,w,n.y[0].aggregator)+'</p><p class="title" >'+d+"</p></div>";$.extend(!0,C,{chart:{type:"solidgauge",style:{overflow:"visible"}},title:{text:k,floating:!0,y:0},subtitle:{text:r.title,y:0,style:{fontSize:"16px"}},exporting:{filename:r.title},tooltip:{enabled:!1,crosshairs:null},legend:{enabled:!1},pane:{center:["50%","72%"],startAngle:-120,endAngle:120,size:"90%",background:{backgroundColor:s[o],borderWidth:0,innerRadius:"75%",outerRadius:"100%",shape:"arc"}},plotOptions:{solidgauge:{animation:!0,dataLabels:{y:-20,borderWidth:0,useHTML:!0,style:{fontSize:f[u]+"px"},crop:!1,overflow:"none"}}},xAxis:{visible:!1},yAxis:_,series:b}),C.series[0].data.splice(1),"fullscreen"==a.mode&&(C.plotOptions.series.animation=!0),"dark"===a.theme&&(C=$.extend(!0,C,{pane:{background:{backgroundColor:"#343752"}}}))};var a={0:"#A3ABB0",1:"#40A276",2:"#F6CC4E",3:"#F38000",4:"#EE4B4B"}}(),!function(){var t=bdpChart.helper;bdpChart.setMapAreaSpecialOption=function(e){function a(){var t=O.series;angular.forEach(t,function(t){angular.forEach(t.data,function(t){t.color=t.value<b.add(T.mul(.25))?"#DBECF7":t.value<b.add(T.mul(.5))?"#A6D3F3":t.value<b.add(T.mul(.75))?"#72AFD9":"#5C8EB0"})})}function i(e){var a=e.info,i=O.series,r=a.color_setting;if(delete a.color_setting.is_series,!$.isEmptyObject(r))if(1!=r.mode){var n=bdpChart.colors[r.theme],o=r.enum_color_map;if(r.field[0].fid==a.xAxis[0].fid){var l="hz-code";angular.forEach(i,function(t){angular.forEach(t.data,function(t,e){var a=angular.isArray(t)?t[0]:t[l];t.color=o.hasOwnProperty(a)?o[a].color:n[e%n.length]})}),delete O.colorAxis,O.legend.enabled=!1}}else if(1===r.mode){delete O.colorAxis;var s=[];e.data.colors.map(function(t){null!==t&&s.push(Number(t))});var d=t.linearRangeColor(r.range_color.start_color,r.range_color.end_color),h=t.createLinearScale(r.range_color,s),c=[],p=r.range_color.step;if(p>1){for(S=0;p-1>S;S++)c.push(d(S/(p-1)));c.push(d(1))}angular.forEach(i,function(t){angular.forEach(t.data,function(t,e){var a=s[e],i=h(a);if(p){var r=Math.floor(p*i);
r=Math.min(r,p-1),t.color=c[r]}else t.color=d(i)})}),$.extend(!0,O.legend,{symbolWidth:0,symbolHeight:0,labelFormatter:function(){var t=bdpChart.helper.createLinearGradientCss(r.range_color.start_color,r.range_color.end_color,r.range_color.step);return'<span class="map-legend-text-left">'+r.field[0].name+'</span><div class="color-linear-gradient map-legend" style="'+t+'"></div>'}})}}e.$elem.addClass("chart-map");var r=e.info,n=t.filterNullVal(e.chartData),o=r.drill_level,l=o&&e.optional.drill_value.concat().reverse(),s="中国",d=+r.map.region,h=r.map.granularity,c=bdpChart.language||"zh";if(2===d)if(o){if(s=e.optional.drill_value[o-1],t.mapType.indexOf(s)<0)for(var p=0;p<l.length;p++)if(t.mapType.indexOf(l[p])>-1){s=l[p];break}t.mapType.indexOf(s)<0&&(s=n.x[0].origin_name)}else s=n.x[0].origin_name;var u;u=t.mapType.indexOf(s)>-1?t.cityMap[s]:"china";var f=Highcharts.maps["countries/cn/"+u+"_geo"];f||(t.getMapMeta(u+"_geo"),f=Highcharts.maps["countries/cn/"+u+"_geo"]);var m=[],g=n.x[0].data.length,y=t.getEdgeValueFromMultiArray(n,"","max")||0,v=t.getEdgeValueFromMultiArray(n,"","min")||0,_=0,b=0;g&&(_=t.formatMapNum(y,4,y>0?"ceil":"floor"),b=t.formatMapNum(v,4,v>0?"floor":"ceil"));var x=bdpChart.helper.numericSymbols(_),C=bdpChart.helper.numericSymbols(b),w=x.toString().substr(x.toString().length-1,1),k=C.toString().substr(C.toString().length-1,1);if(w==k&&(Math.abs(_)>1e3||Math.abs(b)>1e3)){x=t.formatMapNum(x.toString().substr(0,x.length-1),4,y>0?"ceil":"floor"),C=t.formatMapNum(C.toString().substr(0,C.length-1),4,v>0?"floor":"ceil");for(var A=["","K","M","B","T","P","E"],S=0;S<A.length&&A[S]!==k;S++);_=x*Math.pow(10,3*S),b=C*Math.pow(10,3*S)}for(var D,M,T=_.sub(b),L=isInteger(_.mul(.25))?0:_.mul(.25).toString().split(".")[1].length,E=n.x[0].mismatch.length,S=0;g>S;S++)D=n.x[0].data[S],M=n.y[0].data[S],(1===d&&"city"!==h||2===d&&"province"!==h&&(D.indexOf("0000")<0||["110000","310000","120000","500000"].indexOf(D)>-1))&&(m.push({"hz-code":D,name:D,value:Number(M)}),m[S].dataLabels=M>=_.mul(.5)?{style:{color:"#fff",textOutline:"none"}}:{style:{color:"rgba(0, 0, 0, .6)",textOutline:"none"}});var O=$.extend(!0,e.options,{chart:{type:"map",spacing:[15,15,10,15]},title:{text:""},subtitle:{text:r.title,y:0,style:{"font-size":"fullscreen"===e.mode?"20px":"16px",color:"dark"===e.theme?"#FFFFFF":"#333333"}},exporting:{filename:r.title},mapNavigation:{enabled:!1},plotOptions:{map:{cursor:r.is_drill||"2"==e.optional.linked_chart_type?"pointer":"default",borderColor:"#fff",nullColor:"#E6E8EA",dataLabels:{align:"center",allowOverlap:!0,crop:!1,enabled:"edit"===e.mode||e.isDashboardMode&&e.gridWidth>=4&&e.gridHeight>=4,style:{color:"#777",fontSize:"10px",textOutline:"none"}},events:{legendItemClick:function(){return!1}}}},legend:{enabled:!e.isMobileMode&&(!e.isDashboardMode||e.isDashboardMode&&e.dash_setting.show_legend),align:"left",verticalAlign:"bottom",floating:!0,y:-5,layout:"horizontal",valueDecimals:L,backgroundColor:null,symbolRadius:0,symbolHeight:0,symbolWidth:0,useHTML:!0,itemHoverStyle:{cursor:"default"},labelFormatter:function(){var t="background:-webkit-linear-gradient(left, #DBECF7, #DBECF7 25%, #A6D3F3 25%, #A6D3F3 50%, #72AFD9 50%, #72AFD9 75%, #5C8EB0 75%, #5C8EB0);background:-moz-linear-gradient(left, #DBECF7, #DBECF7 25%, #A6D3F3 25%, #A6D3F3 50%, #72AFD9 50%, #72AFD9 75%, #5C8EB0 75%, #5C8EB0);background:-ms-linear-gradient(left, #DBECF7, #DBECF7 25%, #A6D3F3 25%, #A6D3F3 50%, #72AFD9 50%, #72AFD9 75%, #5C8EB0 75%, #5C8EB0);background:-o-linear-gradient(left, #DBECF7, #DBECF7 25%, #A6D3F3 25%, #A6D3F3 50%, #72AFD9 50%, #72AFD9 75%, #5C8EB0 75%, #5C8EB0);";return'<span class="map-legend-text-left">'+bdpChart.helper.numericSymbols(b)+'</span><span class="map-legend-text-right" style="float:right">'+bdpChart.helper.numericSymbols(_)+'</span><div class="color-linear-gradient map-legend" style="'+t+'"></div>'}},tooltip:{crosshairs:null,formatter:e._generateTooltipFormatter()},series:[{data:m,mapData:f,joinBy:"hz-code",mapData:f,enableMouseTracking:!1,dataLabels:{format:"{point.name}"},showInLegend:!1},{data:m,mapData:f,joinBy:"hz-code",name:n.y[0].name,states:{hover:{brightness:.1}},dataLabels:{formatter:function(){return void 0!==this.point.value||null!==this.point.value?this.point.value:""},y:-14}}]});2===e.gridWidth&&(O.legend.enabled=!1),"fullscreen"===e.mode&&$.extend(!0,O,{plotOptions:{map:{dataLabels:{enabled:!0}}},tooltip:{style:{fontSize:"14px"}}}),"dark"===e.theme&&$.extend(!0,O,{plotOptions:{map:{borderColor:"rgba(0, 0, 0, 0.1)",nullColor:"#343752",dataLabels:{style:{color:"rgba(255, 255, 255,  .4)",textOutline:"none"}}}},tooltip:{backgroundColor:"none",borderWidth:0,style:{padding:0}}}),a(e),i(e),e.once("load",function(){if(E&&"edit"===e.mode){var t="";t="zh"===c?"有"+E+"条未知地区":"There are "+E+" unknown area.";var a='<div class="map-mismatch-text pa guide"><p><a class="cursor-pointer">'+t+'</a></p><div class="guide-tip dropdown-wrap">'+bdp.utils.encodeHTML(n.x[0].mismatch.join("、"))+"</div></div>";e.$elem.append(a)}}),e.$elem.highcharts("Map",O)}}(),!function(){var t=bdpChart.helper;bdpChart.setMapBubbleSpecialOption=function(e,a){function i(t,e){var i=t.info,r=t.data,n=i.chart_id,o={},l=[];if(a&&(!a||0!=a.length)){angular.forEach(a,function(t){t.ctId==n&&(o=t.pointInfo,l=t.pointData)});var s=o.hzCode;t.pointData=l;var d,h=e[1].data;h.length>1&&(angular.forEach(r.x[0].data,function(t,e){t==s&&(d=e)}),angular.isNumber(d)&&(h[d].selected=!0))}}function r(e){var a=e.info,r=D.series,n=a.color_setting;if(i(e,r),delete a.color_setting.is_series,!$.isEmptyObject(n)){if(1!=n.mode){var o=bdpChart.colors[n.theme],l=n.enum_color_map;if(n.field[0].fid==a.xAxis[0].fid){var s="hz-code";angular.forEach(r,function(t){angular.forEach(t.data,function(t,e){var a=angular.isArray(t)?t[0]:t[s];t.color=l.hasOwnProperty(a)?l[a].color:o[e%o.length]})}),delete D.colorAxis,D.legend.enabled=!1}}else if(1==n.mode){delete D.colorAxis,D.legend.enabled=!1;var d=[];e.data.colors.map(function(t){null!==t&&d.push(Number(t))});var h=t.linearRangeColor(n.range_color.start_color,n.range_color.end_color),c=t.createLinearScale(n.range_color,d),p=[],u=n.range_color.step;if(u>1){for(S=0;u-1>S;S++)p.push(h(S/(u-1)));p.push(h(1))}angular.forEach(r,function(t){angular.forEach(t.data,function(t,e){var a=d[e],i=c(a);if(u){var r=Math.floor(u*i);r=Math.min(r,u-1),t.color=p[r]}else t.color=h(i)})})}angular.forEach(r,function(t){angular.forEach(t.data,function(t,a){e.data.y[0].hasOwnProperty("warn_data")&&1==e.data.y[0].warn_data[a]&&(t.color="rgba(255, 133, 90,0.5)")})})}}e.$elem.addClass("chart-map");var n=e.info,o=t.filterNullVal(e.chartData),l=n.drill_level,s=l&&e.optional.drill_value.concat().reverse(),d="中国",h=+n.map.region,c=n.map.granularity,p=bdpChart.language||"zh";if(2===h)if(l){if(d=e.optional.drill_value[l-1],t.mapType.indexOf(d)<0)for(var u=0;u<s.length;u++)if(t.mapType.indexOf(s[u])>-1){d=s[u];break}t.mapType.indexOf(d)<0&&(d=o.x[0].origin_name)}else d=o.x[0].origin_name;var f;f=t.mapType.indexOf(d)>-1?t.cityMap[d]:"china";var m="province"===c?Highcharts.maps["countries/cn/china_geo"]:Highcharts.maps["countries/cn/city-point"];m||(t.getMapMeta("province"===c?"china_geo":"city-point"),m="province"===c?Highcharts.maps["countries/cn/china_geo"]:Highcharts.maps["countries/cn/city-point"]);var g=Highcharts.maps["countries/cn/"+f+"_geo"];g||(t.getMapMeta(f+"_geo"),g=Highcharts.maps["countries/cn/"+f+"_geo"]);var y=[],v=o.x[0].data.length,_=o.x[0].mismatch.length,b=t.getEdgeValueFromMultiArray(o,"","max"),x=t.getEdgeValueFromMultiArray(o,"","min");0>x&&(x=0);var C=10,w=x?x*C/b:1;w=1>w?1:w;for(var k,A,S=0;v>S;S++)k=o.x[0].data[S],A=o.y[0].data[S],(1===h||2===h&&"province"!==c&&k.indexOf("0000")<0)&&null!==A&&(y.push({"hz-code":k,z:Number(A)}),o.y[0].hasOwnProperty("warn_data")&&1==o.y[0].warn_data[S]&&(y[S].color="rgba(255, 133, 90,0.5)"));y.sort(function(t,e){return e.z-t.z});var D=$.extend(!0,e.options,{chart:{type:"map",spacing:[15,15,10,15]},title:{text:""},subtitle:{text:n.title,y:0,style:{"font-size":"fullscreen"===e.mode?"20px":"16px",color:"dark"===e.theme?"#FFFFFF":"#333333"}},exporting:{filename:n.title},mapNavigation:{enabled:!1},plotOptions:{map:{borderColor:"#fff",nullColor:"#E6E8EA",dataLabels:{align:"center",enabled:"edit"===e.mode||e.isDashboardMode&&e.gridWidth>=4&&e.gridHeight>=4,style:{color:"#777",textOutline:"none"},formatter:function(){return this.key}}},mapbubble:{cursor:n.is_drill||"2"==e.optional.linked_chart_type?"pointer":"default",marker:{enabled:!1,states:{select:{fillColor:"#7BE",lineWidth:2,lineColor:"#59C"}}},dataLabels:{align:"center",allowOverlap:!0,crop:!1,enabled:!(e.isDashboardMode&&(e.gridWidth<4||e.gridHeight<4)),style:{color:"dark"==e.theme?"#fff":"#555",textOutline:"dark"==e.theme?"0 0 3px rgba(0,0,0,0.2)":null},y:"province"===c?14:0},stickyTracking:!1}},legend:{enabled:!1},tooltip:{crosshairs:null,formatter:e._generateTooltipFormatter()},series:[{mapData:g,enableMouseTracking:!1},{allowPointSelect:"2"==e.optional.linked_chart_type,type:"mapbubble",mapData:m,name:o.y[0].name,joinBy:"hz-code",data:y,minSize:w+"%",maxSize:C+"%",color:"rgba(121,188,233,0.5)"}]});"fullscreen"===e.mode&&$.extend(!0,D,{plotOptions:{map:{dataLabels:{enabled:!0}}},tooltip:{style:{fontSize:"14px"}}}),"dark"===e.theme&&$.extend(!0,D,{plotOptions:{map:{borderColor:"rgba(0, 0, 0, 0.1)",nullColor:"#343752",dataLabels:{style:{color:"rgba(255, 255, 255, .3)"}}}},tooltip:{backgroundColor:"none",borderWidth:0,style:{padding:0}}});var M=e.deviceStyle.plotOptions?e.deviceStyle.plotOptions.map:{};$.extend(!0,D.plotOptions.map,M),r(e),e.once("load",function(){if(_&&"edit"===e.mode){var t="";t="zh"===p?"有"+_+"条未知地区":"There are "+_+" unknow area.";var a='<div class="map-mismatch-text pa guide"><p><a class="cursor-pointer">'+t+'</a></p><div class="guide-tip dropdown-wrap">'+bdp.utils.encodeHTML(o.x[0].mismatch.join("、"))+"</div></div>";e.$elem.append(a)}}),e.$elem.highcharts("Map",D)}}(),!function(){bdpChart.setSankeySpecialOption=function(t){function e(e,a){if(e.origin_data=$.extend(!0,{},e.data),"date"===e.data_type){var i=e.granularity,r=e.granularity_name||"",n=e.month_start_day||0;"week"===i&&(n=e.week_start_day_of_week);var o,l=t.data.x[a].data,s=l.length;0===a?o=l[s-1]-l[0]:1===a&&(o=l[s-1].name-l[0].name),i=bdpChart.helper.setGranularityByDate(i,o),0===a?e.data.forEach(function(t,a){e.data[a]=bdpChart.helper.checkGranularity(i,t,r,n)}):1===a&&e.data.forEach(function(t,a){e.data[a].name=bdpChart.helper.checkGranularity(i,t.name,r,n)}),e.data_type="string"}}function a(t){this.nodeWidth=20,this.padding=28,this.paddingmultiplier=10,this.lowopacity=.1,this.highopacity=.2,this.d3Elem=d3.selectAll(i.toArray()),this.data=t.data,this.info=t.info}var i=t.$elem,r=t.mode,n=t.theme,o=t.info.yAxis[0].formatter,l=bdpChart.helper,s="dark"===t.theme?1:2;if(bdpChart.language||(bdpChart.language="zh"),!t.data.x.length||!t.data.x[1].data.length){var d="zh"===bdpChart.language?"当前图表无数据":"No data to display";return void i.html('<div class="chart-error"><p>'+d+"</p></div>").addClass("bdp-chart-loaded bdp-chart-error")}var h="zh"===bdpChart.language?"数值":"Value",c={top:0,right:0,bottom:30,left:0};t.isDashboardMode&&(c.top=8);var p=1==s?"#fff":"#000",u=1==s?"fullscreen"===r?"#fff":"rgba(255, 255, 255, .5)":"#606060",f="fullscreen"===r?"12px":"10px",m="transparent";"dark"===n&&(this.lowopacity=.1),a.prototype={constructor:a,initSvg:function(){var t=this;t.color=t._getColor(),e(t.data.x[0],0),e(t.data.x[1],1);var a=0,n=0;return"edit"===r&&(n=64,a=80),t.width=i[0].offsetWidth-a,t.height=i[0].offsetHeight-n,t.width*t.height<=0?!1:(t.svg=t.d3Elem.append("svg").attr("style",'font-family:arial, "lucida grande", "lucida sans unicode", verdana, helvetica, sans-serif;font-size:12px;').attr("width",t.width).attr("height",t.height).attr("viewBox","0 0 "+t.width+" "+t.height).attr("perserveAspectRatio","xMinYMid"),t._setSeries(),void t.draw())},_setSeries:function(){for(var t=this.data,e={nodes:[],links:[]},a=[],i=0;i<t.x[0].data.length;i++){e.nodes[i]={origin_name_value:t.x[1].origin_data[i].name,origin_value:t.x[0].origin_data[i]};var r=t.x[0].data[i],n=t.x[1].data[i].name,o=t.x[1].data[i].value;a.indexOf(r)<0?(a.push(r),e.nodes[i].layer=a.length-1):e.nodes[i].layer=a.indexOf(r),e.nodes[i].name=n,e.nodes[i].value=o}this.layers=a.length,e.links=t.y[0].data,this.sankeyData=e},_getLayers:function(){return this.layers},_getColor:function(){var t=bdpChart.getColorsByType("C300","bdp");return d3.scale.ordinal().range(t)},_setColor:function(t){var e=this.color(t),a=this.info.color_setting||{};return a&&a.enum_color_map&&a.enum_color_map.hasOwnProperty(t)&&(e=a.enum_color_map[t].color),e},draw:function(){var t=this,e=t.sankeyData,a=t.svg;a.selectAll("g").remove();var i;this.sankey=i=d3.sankey().nodeWidth(t.nodeWidth).nodePadding(t.paddingmultiplier).size([t.width,t.height-c.top-c.bottom]);var r=i.reversibleLink();i.nodes(e.nodes).links(e.links).layout(32),t._initBackground(a),t._renderLinks(i,a,r,e.links),t._renderNodes(i,a,r,e.nodes),t._renderXaxisLabel(i,a)},_initBackground:function(t){t.append("rect").attr("class","sankey-background").attr("width",this.width).attr("height",this.height).attr("fill",m)},_renderNodes:function(t,e,a,r){function n(e){d3.select(this).attr("transform","translate("+e.x+","+(e.y=Math.max(0,Math.min(s.height-c.top-c.bottom-e.dy,d3.event.y)))+")"),t.relayout(),s.path1.attr("d",a(1)),s.path0.attr("d",a(0)),s.path2.attr("d",a(2))}var s=this,d="date"===s.info.xAxis[1].data_type,p=e.append("g").attr("transform","translate("+c.left+","+c.top+")").selectAll(".node").data(r).enter().append("g").attr("class","node").attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).attr("posx",function(t){return t.x}).call(d3.behavior.drag().origin(function(t){return t}).on("dragstart",function(){this.parentNode.appendChild(this)}).on("drag",n));p.append("rect").attr("height",function(t){return Math.max(0,t.dy)}).attr("width",s.nodeWidth).style("fill",function(t){return t.color=t.fill?t.fill:s._setColor((d?t.origin_name_value.toString():t.name).replace(/ .*/,""))}).on("mouseover",function(t){e.selectAll(".link").filter(function(e){return e.source==t||e.target==t}).transition().style("opacity",s.highopacity),s.tooltip=i.find(".sankey-tooltip");var a="";if(s.info.yAxis[0].hasOwnProperty("unit_adv")&&(a=s.info.yAxis[0].unit_adv),!s.tooltip.length){var r=s.setTooltipPosition();s.tooltip=$('<div class="sankey-tooltip" style="position: absolute; left:'+r.x+"px;top:"+r.y+'px;"><p class="text-center tooltips-title">'+l.escapeHtml(t.name)+'</p><table class="tooltip-table"><tr style="color:'+t.color+'"><td>'+h+"：</td><td>"+l.dataLabelFormatter(o,t.value)+a+"</td></tr></table></div>"),i.append(s.tooltip)}}).on("mouseout",function(t){e.selectAll(".link").filter(function(e){return e.source===t||e.target===t}).transition().style("opacity",s.lowopacity),s.tooltip.remove()}).on("mousemove",function(){var t=s.setTooltipPosition();s.updateTooltipPosition(t.x,t.y)}),s._renderText(t,p)},setTooltipPosition:function(){if(null===this.tooltip)return{x:0,y:0};var t=this.tooltip.outerWidth(),e=this.tooltip.outerHeight(),a=d3.event.clientX+10,r=d3.event.clientY,n=i[0].getBoundingClientRect();return d3.event.pageX+t>n.right&&(a=a-t-20),d3.event.pageY+e>n.bottom-30&&(r-=e),{x:a-n.left,y:r-n.top}},updateTooltipPosition:function(t,e){this.tooltip.css({left:t,top:e})},_renderLinks:function(t,e,a,r){var n=this,s=n.link=e.append("g").attr("transform","translate("+c.left+","+c.top+")").selectAll(".link").data(r).enter().append("g").attr("class","link").sort(function(t,e){return e.dy-t.dy});n.path0=s.append("path").attr("d",a(0)),n.path1=s.append("path").attr("d",a(1)),n.path2=s.append("path").attr("d",a(2)),n.link.attr("fill",p).attr("opacity",n.lowopacity).on("mouseover",function(t){d3.select(this).style("opacity",n.highopacity),n.tooltip=i.find(".sankey-tooltip");var e="";if(n.info.yAxis[0].hasOwnProperty("unit_adv")&&(e=n.info.yAxis[0].unit_adv),!n.tooltip.length){var a=n.setTooltipPosition();n.tooltip=$('<div class="sankey-tooltip" style="position: absolute; left:'+a.x+"px;top:"+a.y+'px;"><p class="text-center tooltips-title">'+t.source.name+" → "+t.target.name+'</p><table class="tooltip-table"><tr style="color:'+t.source.color+'"><td>'+h+"：</td><td>"+l.dataLabelFormatter(o,t.value)+e+"</td></tr></table></div>"),i.append(n.tooltip)}}).on("mouseout",function(){d3.select(this).style("opacity",n.lowopacity),n.tooltip.remove()}).on("mousemove",function(){var t=n.setTooltipPosition();n.updateTooltipPosition(t.x,t.y)}).on("click",function(t){n.drillDown(t)}),n.info.is_drill&&n.link.attr("cursor","pointer")},drillDown:function(e){this.info.is_drill&&t.emit("drilldown",e,t)},_renderText:function(t,e){var a=this;e.append("text").attr("x",-4).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("class","label-text").attr("fill",u).attr("stroke","none").style("font-size",f).attr("text-anchor","end").attr("transform",null).text(function(t){return t.name}).filter(function(t){return t.x<a.width/2}).attr("x",4+t.nodeWidth()).attr("text-anchor","start"),e.append("text").attr("x",function(t){return-t.dy/2}).attr("y",function(t){return t.dx/2+4}).attr("transform","rotate(270)").attr("fill","#fff").attr("stroke","none").attr("text-anchor","middle").text(function(t){return t.dy>50?l.dataLabelFormatter(o,t.value):void 0})},_renderXaxisLabel:function(t,e){var a=this;e.append("g").attr("class","sankey-xaxis-label").attr("transform","translate(0,"+(a.height-10)+")");var i,r=a.data.x[0],n=bdp.utils.arrayUnique(r.data),o=a.getLayerPosition(e),l=o[1],s=0,d=[],h="visible",c=[];n.forEach(function(t,r){var p=e.select(".sankey-xaxis-label").append("text");if(p.text(t).attr("fill",u).style("font-size",f),i=a._getTextWidth(p),s=0===r?o[0]:r===n.length-1?o[r]-i+a.nodeWidth:o[r]-.5*i+.5*a.nodeWidth,d.push([s,i]),0===r)h=i+a.nodeWidth>=l?"hidden":"visible";else if(r<n.length-1){var m=Math.ceil(i/l);if(1>=m)h="visible","visible"===c[r-1]&&d[r-1][0]+d[r-1][1]>=d[r][0]&&(h="hidden");else for(var g=m-1;g>0;g--){if(0>r-g){h="hidden";break}if("visible"===c[r-g]){h="hidden";break}h="visible"}}else h=i+a.nodeWidth>=l?"hidden":"visible","visible"===c[r-1]&&d[r-1][0]+d[r-1][1]>=d[r][0]&&(h="hidden");c.push(h),p.attr("transform","translate("+s+",0)").style("visibility",h)})},_getTextWidth:function(t){var e=0;return t.each(function(){e=this.getComputedTextLength()}),e},getLayerPosition:function(){var t=this.sankeyData.nodes,e=[];return t.forEach(function(t){var a=t.x;e.indexOf(a)<0&&e.push(a)}),e.sort(function(t,e){return t-e})},resize:function(){var t=this,e=i[0].offsetWidth,a=i[0].offsetHeight;t.svg&&(t.svg.attr("width",e).attr("height",a),t.sankey.size([e,a-30]))}};var g=new a(t);g.initSvg(),window.onresize=function(){g.resize()}}}(),!function(){function t(t){var e="zh"===i?"当前图表无数据":"No data to display";t.html('<div class="chart-error"><p>'+e+"</p></div>").addClass("bdp-chart-loaded bdp-chart-error")}function e(t,e,i,r){e.find(".chart-text-updown").remove();var i=r.data,n=r.info;if(2===n.y.length){var o,l=i.y.length/2,s=i.y[t+l],d=s.data[0],h=s.formatter,c=s.aggregator;o=null==d?"--":a.dataLabelFormatter(h,d,c);var p=$('<div class="chart-text-updown nowrap">'),u=s.compare_names[0]||s.nick_name||s.name,f=$('<span class="hd nowrap">').text(u);p.append(f);var m,g,y=(r.info.tb_conditional_formatting||[]).some(function(t){return t.fid===s.fid&&t.uniq_id===s.uniq_id?!0:void 0});s.series_color?m=s.series_color:y?s.cell_styles&&s.cell_styles.length>0&&s.cell_styles[0]?(g=s.cell_styles[0].shape_type||"",m=s.cell_styles[0].color):m="#A3ABB0":d>0?(g="arrow-up",m="#EF4B4A"):null==d?(g=void 0,m="#A3ABB0"):0==d?(g="arrow-equal",m="#A3ABB0"):(g="arrow-down",m="#40B27E");var v="";g&&(v='<i class="icomoon icomoon-'+g+'"></i>'),p.append('<span class="bd up" style="color:'+m+';">'+v+o+"</span>"),e.append(p)}}var a=bdpChart.helper;bdpChart.language||(bdpChart.language="zh");var i=bdpChart.language;bdpChart.setTextSpec=function(i){var r=i.$elem,n=i.data,o=n.y[0];if(!o.data.length)return t(r),!1;r.find(".chart-error").remove(),"fullscreen"===i.mode&&r.html("");var l=o.formatter,s=o.aggregator,d=o.nick_name||o.name;r.addClass("text-chart"),r.html("");var h=n.y.length/i.info.y.length,c=r;if(h>1){var p,u;i.info.split_compare_setting?(p=i.info.split_compare_setting.rows,u=i.info.split_compare_setting.cols):p=u=h>16?4:Math.ceil(Math.sqrt(h)),h>p*u&&r.css("overflow-y","auto");var f=h>p*u&&i.isDashboardMode?r.width()-15:r.width(),m=f/u,g=r.height()/p,y={left:parseInt(r.css("padding-left")),top:parseInt(r.css("padding-top"))}}for(var v=(2==i.info.y.length,0);h>v;v++){var _,b=n.y[v],x=null===b.data[0]?"--":+b.data[0],C=$('<div class="chart-text-box">'),w=$('<div class="chart-text-box-inner">'),k=$('<div class="chart-text-item">'),A=$('<div class="chart-text-title">'),S=$('<div class="chart-text-value nowrap">'),D=d,M=(i.info.tb_conditional_formatting||[]).some(function(t){return t.fid===b.fid&&t.uniq_id===b.uniq_id?!0:void 0});if(b.series_color?S.css("color",b.series_color):M&&(b.cell_styles&&b.cell_styles.length>0&&b.cell_styles[0]?(_=b.cell_styles[0].shape_type||"",_&&S.append('<i class="icomoon icomoon-'+_+'"></i>'),S.css("color",b.cell_styles[0].color)):S.css("color","#A3ABB0")),b.compare_values&&b.compare_values.length&&(D=d=b.compare_values[0],k.append($('<div class="chart-text-title">').text(b.compare_values.slice(1).join("_")))),"edit"===i.mode?(D=$('<span class="nick-name-value nowrap">').text(d),A.append(D)):A.text(D),k.append(A).append(S),w.append(k),C.append(w),h>1){C=$("<div>").append(C).addClass("grid-box");var T={left:m*(v%u)+y.left,top:g*parseInt(v/u)+y.top};C.css({position:"absolute",left:T.left,top:T.top,width:m,height:g})}if(c.append(C),0/0===x||isNaN(x))S.text("--");else{var L=$("<div>").append($("<sub>").text(o.unit_adv));x=a.dataLabelFormatter(l,x,s);var E=S.append(x+L.html());"fullscreen"!=i.mode&&"edit"!=i.mode&&E.attr("title",x)}e(v,k,n,i),"edit"===i.mode&&(k.find(".chart-text-updown .hd").off("click.nickname").on("click.nickname",function(){i.emit("setNickName","event",1)}),r.find(".chart-text-title").off("click.nickname").on("click.nickname",".nick-name-value",function(){i.emit("setNickName","event",0)}))}}}(),!function(){bdpChart.setWaterfallSpecialOption=function(t){var e,a,i=[],r=t.data,n=t.info,o=t.options.series[0].data,l=bdpChart.helper,s=$.cookie("locale")||"zh",d=r.x.length?r.x[0].data_type:"",h=r.x.length&&"date"===d?"datetime":"category",c=n.waterfall_setting||{show_sum:!n.xAxis.length||"date"!==n.xAxis[0].data_type,sum_name:"en"===s?"Sum":"累计值",color_theme:bdpChart.getColorsByType("C320","bdp")},p=c.show_sum,u=c.sum_name,f=c&&c.color_theme||bdpChart.getColorsByType("C320","bdp"),m={color:f[1],upColor:f[0]};if("date"===d)var g=l.getGranularity(r,r.x[0].data.length),y=g.granularity||"day",v=g.granularity_name||"",_=n.xAxis[0].month_start_day||0;if(t.data.x.length){var b=r.x[0].data;if("date"===d&&1===t.data.x.length){var x=b[b.length-1]-b[0],C={year:bdp.utils.isLeapYear(b[b.length-1])?316224e5:31536e6,quarter:79488e5,month:26784e5,week:6048e5,day:864e5,hour:36e5,minute:6e4,second:1e3,c_second:1e3,c_minute:6e4,c_hour:36e5,g_hour:36e5,g_minute:6e4,g_second:1e3};y=l.setGranularityByDate(y,x);var w=o[o.length-1].x+C[y];e={name:w,isSum:!0,x:w,formatter:t.data.y[0].formatter}}else e={name:u,isSum:!0,formatter:t.data.y[0].formatter};2===t.data.x.length&&t.options.xAxis.categories.push({categories:[c.sum_name],name:""}),angular.forEach(o,function(t,e){a={name:t.name,nick_name:r.y[0].nick_name,x:"date"===d?t.x:this.x,y:1*r.y[0].data[e],formatter:r.y[0].formatter},i.push(a)})}else angular.forEach(t.data.y,function(t){a={name:t.nick_name||t.name,nick_name:t.nick_name,y:1*t.data[0],formatter:t.formatter},i.push(a)}),e={name:u,isSum:!0,formatter:t.data.y[0].formatter};p&&i.push(e);var k={chart:{type:"waterfall"},legend:{enabled:!1},plotOptions:{waterfall:{lineColor:"dark"===t.theme?"rgba(255,255,255,0.35)":"#333",borderWidth:0,lineWidth:1}},xAxis:{type:h,labels:{enabled:!0}}};return t.options.series=[{upColor:m.upColor,color:m.color,data:i}],1===t.data.x.length&&(k.xAxis.labels.formatter=function(){var t=this.axis.chart.options.series[0].data;if(this.isLast&&p&&this.value===t[t.length-1].x)return u;if("date"===d){var e=this.value;if("week"===y){_=1,v&&(_=n.xAxis[0].week_start_day_of_week);var a=new Date(e).getDay();a>_?e-=864e5*(a-_):e+=864e5*(_-a)}return l.checkGranularity(y,e,v,_)}return this.value}),k}}(),!function(t){function e(t){this.mapOption={centerLng:105.403119,centerLat:38.028658,zoom:5},this.animationThreshold=2e3,this.watermark=t?t.watermark:null,this.chartInstance=t}function a(t){if(t.nick_name)return t.nick_name;var e=t.name;return t.aggregator&&1!==!t.is_build_aggregated&&h[t.aggregator]&&(e+=" ("+h[t.aggregator]+")"),e}function i(t,e){var a,i=t.map(function(t){return Number(t)}),r=bdpChart.helper.linearRangeColor(e.start_color,e.end_color),n=bdpChart.helper.createLinearScale(e,i),o=[],l=e.step;if(l>1){for(a=0;l-1>a;a++)o.push(r(a/(l-1)));o.push(r(1))}return function(t){var e,a=n(t);if(l){var i=Math.floor(l*a);i=Math.min(i,l-1),e=o[i]}else e=r(a);return e}}function r(t,e,a){if(isNaN(t))return 1;var i,r=e.length,n=r-1;for(i=0,r=e.length;r>i;i++){var o=e[i];if(t<o[0]){n=i;break}if(o[0]<=t&&t<o[1]){n=i;break}}return a?r-n:n+1}function n(t){t||(t=document.createElement("canvas").getContext("2d"));var e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e}function o(t){for(var e=t.split(","),a=e[0].match(/:(.*?);/)[1],i=atob(e[1]),r=i.length,n=new Uint8Array(r);r--;)n[r]=i.charCodeAt(r);var o=new Blob([n],{type:a});return URL.createObjectURL(o)}var l={funcQueue:[],loadLibInProgress:!1};bdpChart.setGisSpec=function(t){window.HOST_TYPE="2",window.BMap_loadScriptTime=(new Date).getTime();var a="https://api.map.baidu.com/getscript?v=2.0&ak=1XjLLEhZhQNUzd93EjU5nOGQ",i=function(){var a=t.gisMap||new e(t);t.info.meta.layers&&t.info.meta.layers.forEach(function(e){var a=t.info.tb_gis_type[e.tb_id]||0;e.coordType=d[a]}),a.render(t.$elem[0],t.data.layers,t.info.meta),t.gisMap=a,t.$elem.addClass("chart-gis"),t.$elem.data("bdp-chart-instance",t)};thirdPluginLoader({initFun:i,libSrc:a,otherSrc:"https://m1.bdp.cn/static/js/lib/mapv/mapv.min_4a2e6d7.js",libId:window.BMap&&window.LabelControl&&window.VizToolControl&&window.LegendControl},l)};var s=bdpChart.helper,d={0:"bd09ll",1:"gcj-02",2:"gcj-02",3:"gcj-02",4:"gcj-02"},h={SUM:"求和",AVERAGE:"平均值",AVG:"平均值",MIN:"最小值",MAX:"最大值",COUNT:"计数",COUNT_DISTINCT:"去重计数",sum:"求和",average:"平均值",avg:"平均值",min:"最小值",max:"最大值",count:"计数",count_distinct:"去重计数",YoY:"同比",QoQ:"环比",TOTAL:"总计",MED:"中位数",PERCENTILE:"百分位",PERCENT_5:"5",PERCENT_10:"10",PERCENT_25:"25",PERCENT_50:"50",PERCENT_75:"75",PERCENT_90:"90",PERCENT_95:"95"};e.prototype={constructor:e,render:function(t,e,a){this.layerData=e,this.layerInfo=a.layers,this.$elem=$(t),a.center&&(this.mapOption.centerLng=a.center[0],this.mapOption.centerLat=a.center[1]),a.zoom&&(this.mapOption.zoom=a.zoom),this.bmap?(this.clear(),this.setMapStyle(),this.setCenterAndZoom(),this.configData(),this.emit("loaded"),this.chartInstance.emit("load",this.chartInstance),$(t).addClass("bdp-chart-loaded"),this.vizToolControl.reset(),this.legendControl.reset(),this.labelControl&&this.labelControl.reset()):(this.initBmap(t),this.setMapStyle(),this.setCenterAndZoom(),this.once("tilesloaded",function(){this.initMapv(),this.configData(),this.emit("loaded"),this.chartInstance.emit("load",this.chartInstance),setTimeout(function(){$(t).addClass("bdp-chart-loaded")},200)}))},initBmap:function(e,a){a=t.extend({enableMapClick:!1,enableHighResolution:!0},a);var i=this.bmap=new BMap.Map(e,a);i.enableAutoResize();var r=this;if(i.addEventListener("tilesloaded",function(){setTimeout(function(){r.emit("tilesloaded")})}),this.scrollWheelZoom(!0),this.watermark){var n='url("'+this.watermark.url+'") '+(this.watermark.repeat||"repeat");$(e).find(".BMap_mask").eq(0).css("background",n)}var o=new BMap.ScaleControl({anchor:BMAP_ANCHOR_TOP_LEFT}),l=new BMap.NavigationControl;this.bmap.addControl(o),this.bmap.addControl(l);var s=this.legendControl=new LegendControl(this);this.bmap.addControl(s);var d=this.vizToolControl=new VizToolControl(this);this.bmap.addControl(d)},scrollWheelZoom:function(t){t?this.bmap.enableScrollWheelZoom():this.bmap.disableScrollWheelZoom()},setMapStyle:function(){if(this._usedMapStyle!==this.chartInstance.theme){var t;"dark"===this.chartInstance.theme?(t="#24273e",this.mapStyle=[{featureType:"all",elementType:"all",stylers:{color:"#24273e"}},{featureType:"road",elementType:"all",stylers:{color:"#303349"}},{featureType:"administrative",elementType:"labels.text.fill",stylers:{color:"#555869"}},{featureType:"water",elementType:"all",stylers:{lightness:5,visibility:"on"}},{featureType:"green",elementType:"all",stylers:{lightness:-5}},{featureType:"poi",elementType:"labels.icon",stylers:{lightness:34,visibility:"off"}},{featureType:"subway",elementType:"all",stylers:{visibility:"off"}},{featureType:"arterial",elementType:"labels",stylers:{visibility:"on"}},{featureType:"highway",elementType:"labels.icon",stylers:{visibility:"off"}},{featureType:"label",elementType:"labels.icon",stylers:{visibility:"off"}},{featureType:"boundary",elementType:"geometry.fill",stylers:{color:"#303349",weight:"1",lightness:-1}}]):(t="#f8f8f8",this.mapStyle=[{featureType:"all",elementType:"labels.text.fill",stylers:{color:"#999999"}},{featureType:"all",elementType:"geometry.fill",stylers:{hue:"#d3e3f2",lightness:50,saturation:-84}},{featureType:"all",elementType:"labels.text.stroke",stylers:{color:"#ffffff"}},{featureType:"road",elementType:"geometry.stroke",stylers:{lightness:50,saturation:-84}},{featureType:"label",elementType:"labels.icon",stylers:{visibility:"off"}},{featureType:"highway",elementType:"labels.icon",stylers:{visibility:"off"}}]),this.bmap.setMapStyle({styleJson:this.mapStyle}),this._usedMapStyle=this.chartInstance.theme,this.bmap.getContainer().style.background=t}},setCenterAndZoom:function(t,e){t&&(this.mapOption.centerLng=t.lng,this.mapOption.centerLat=t.lat),e&&(this.mapOption.zoom=e);var a=new BMap.Point(this.mapOption.centerLng,this.mapOption.centerLat);this.bmap.centerAndZoom(a,this.mapOption.zoom)},getCenterAndZoom:function(){if(!this.bmap)return{};var t=this.bmap.getZoom(),e=this.bmap.getCenter();return{center:e,zoom:t}},initMapv:function(){var t=this;this.mapv=new Mapv({map:this.bmap,click:function(e,a){t.emit("point_click",a,e)},hover:function(e,a){e.length?t.showTooltip(e[0],a.clientX,a.clientY):t.hideTooltip(),t.emit("point_hover",a,e)}})},configData:function(){var t=this.layerData,e=this.layerInfo,a=this.mapv,i=this;this._configuredData=[],this._layers=[],t.forEach(function(t,r){if(!$.isEmptyObject(t)&&!e[r].invisible){var n=i.configLayerData(t,e[r]),t=new Mapv.Layer(n);t.setMapv(a),i._layers.push(t),i._configuredData.push(n)}})},getConfiguredData:function(){return this._configuredData},getDrawedLayers:function(){return this.mapv.get("layers")},configLayerData:function(t,e){var a,o={zIndex:1,dataType:"point",drawType:this._getDrawType(e),dataRangeControl:!1,coordType:e.coordType},l=[],d=e.timeline&&e.timeline.enabled&&e.timeline.field;if("heatmap"===e.type){a={unit:e.heatmap_setting.unit||"px",size:e.heatmap_setting.radius||10,type:"radius",maxOpacity:.8},a.gradient={.4:"blue",.7:"cyan",.8:"lime",.9:"yellow","1.0":"red"};var h,c=t.y[0]&&t.y[0].data;t.lng[0].data.forEach(function(e,a){var i={lng:+e,lat:+t.lat[0].data[a],count:1};c&&(h=defined(h)?Math.max(h,+c[a]):+c[a],i.count=+c[a]),d&&(i.t=+t.timeline[0].data[a]),l.push(i)}),a.max=h}else if("bubble"===e.type){"ripple"===e.bubble_symbol?(a={fps:24,rippleStyle:"fill_stroke",fillStyle:"#5182e4",strokeStyle:"#5182e4",globalCompositeOperation:"screen",shuffle:!d,stepIn:!d,minScale:.5,maxScale:3,size:3},o.dataType="ripple"):(a={lineWidth:0,fillStyle:"rgb(238, 75, 75)",fillAlpha:1,size:"location"==e.bubble_symbol?16:4,maxScale:"location"===e.bubble_symbol?2.5:2,minScale:"location"===e.bubble_symbol?.3:.5,shape:e.bubble_symbol||"circle"},"location"===a.shape&&(a.icon={show:!0,font:"icomoon",text:""})),$.isEmptyObject(e.bubble_setting)||(a.scaleRange=this._getBubbleSize(t,e));
var p=e.color_setting,u=!$.isEmptyObject(e.bubble_setting),f=p&&1==e.color_setting.mode&&i(t.colors,e.color_setting.range_color),m=this._getLabelAxis(t,e);u&&(a.size=3),t.lng[0].data.forEach(function(a,i){var n={lng:+a,lat:+t.lat[0].data[i]};if(p){var o=t.colors;if(1==e.color_setting.mode)n.color=Highcharts.Color(f(o[i])).get();else{var h=bdpChart.getColorsByType("C400","bdp");n.color=e.color_setting.enum_color_map[o[i]]?e.color_setting.enum_color_map[o[i]].color:h[i%h.length]}}u&&(n._count=+t.bubble_sizes[i],n.count=r(+t.bubble_sizes[i],t.bubble_size_groups,e.bubble_setting.reverse)),d&&(n.t=+t.timeline[0].data[i]),n.labels=m.map(function(t){var e=t.data[i];return!t.field.aggregator&&"date"===t.field.data_type&&e?e=Highcharts.dateFormat("%Y-%b-%e %H:%M:%S",new Date(e)):(t.field.aggregator||"number"===t.field.data_type)&&e&&(e=s.dataLabelFormatter(t.field.formatter,e),t.field.unit_adv&&(e+=t.field.unit_adv)),e=null===e?"--":e,{name:t.name,value:e}}),l.push(n)})}else if(e.type.indexOf("trajectory")>=0){var g=this.chartInstance.theme;"d_trajectory"===e.type?(a={fillStyle:"#5182e4",lineWidth:1,globalCompositeOperation:"dark"==g?"screen":"darken"},o.dataType="trailline"):(a={strokeStyle:"rgba(50, 50, 255, 0.8)",lineWidth:.3,globalCompositeOperation:"dark"==g?"lighter":"multiply"},o.dataType="polyline");var y=t.trajectory?t.trajectory[0].data:[],v=t.sequence?t.sequence[0].data:[],_=t.lng[0].data,b=t.lat[0].data,x={},p=e.color_setting;if(f=p&&1==e.color_setting.mode&&i(t.colors,e.color_setting.range_color),y.length!==v.length)return;y.forEach(function(i,r){x[i]||(x[i]={geo:[]});var n=[+_[r],+b[r],+v[r]];if(p){var o,l=t.colors;o=1==e.color_setting.mode?Highcharts.Color(f(l[r])).get():e.color_setting.enum_color_map[l[r]]?e.color_setting.enum_color_map[l[r]].color:a.fillStyle,n.push(o),x[i].color=o}x[i].geo.push(n)});for(var C in x)x[C].geo.sort(function(t,e){return t[2]-e[2]}),l.push(x[C]);x=null}else if("massive"===e.type){a={size:2,fillStyle:"#94afdf"},o.context="webgl",o.preserveDrawingBuffer=!0;var p=e.color_setting,f=p&&1==e.color_setting.mode&&i(t.colors,e.color_setting.range_color);t.lng[0].data.forEach(function(a,i){var r={lng:+a,lat:+t.lat[0].data[i]};if(p){var n=t.colors;if(1==e.color_setting.mode)r.color=Highcharts.Color(f(n[i])).get();else{var o=bdpChart.getColorsByType("C400","bdp");r.color=e.color_setting.enum_color_map[n[i]]?e.color_setting.enum_color_map[n[i]].color:o[i%o.length]}}d&&(r.t=+t.timeline[0].data[i]),l.push(r)})}else if("graph"===e.type){var w=bdpChart.getColorsByType("C400","bdp"),k=[];e.y.forEach(function(t,e){var a=t.series_color||w[e%w.length];k.push(a)});var A=Math.sqrt(n());a={lineWidth:0,fillStyle:"rgb(81, 130, 228)",fillAlpha:1,size:12*A,graphType:e.graph_type||"pie",colors:k},$.isEmptyObject(e.bubble_setting)||(a.scaleRange=this._getBubbleSize(t,e));var u=!$.isEmptyObject(e.bubble_setting),m=this._getLabelAxis(t,e);u&&(a.size=6*A),t.lng[0].data.forEach(function(a,i){var n={lng:+a,lat:+t.lat[0].data[i],values:[]};t.y.forEach(function(t){n.values.push(+t.data[i])}),n.sum=n.values.reduce(function(t,e){return t+ +e},0),u&&(n.count=r(+t.bubble_sizes[i],t.bubble_size_groups,e.bubble_setting.reverse)),d&&(n.t=+t.timeline[0].data[i]),n.labels=m.map(function(t){var a,r=t.data[i];if(null===r)a="--";else if(!t.field.aggregator&&"date"===t.field.data_type&&r)a=Highcharts.dateFormat("%Y-%b-%e %H:%M:%S",new Date(r));else if((t.field.aggregator||"number"===t.field.data_type)&&r){var a="",o="pie"===e.graph_type&&e.y.indexOf(t.field)>-1;o&&(a+=(100*r/n.sum).toFixed(2)+"% ("),a+=s.dataLabelFormatter(t.field.formatter,r),t.field.unit_adv&&(a+=t.field.unit_adv),o&&(a+=")")}else a=r;return{name:t.name,value:a}}),l.push(n)})}if(d){var S=this;if(o.animation="time",o.animationOptions={tickFormatter:function(t,a){var i=S.chartInstance,r="current"==a?void 0:"abb";return i._formatTimeWithField(t,e.timeline.field,r)},control:{onInitialize:function(t){var e=$('<div class="mapv-play-control-progress"><span class="progress-cursor"></span></div>');$(t).append(e);var a;$(S.$elem).off("mousemove.gis_mouse_ctrl").on("mousemove.gis_mouse_ctrl",function(){$(t).removeClass("auto-hide"),clearTimeout(a),a=setTimeout(function(){$(t).addClass("auto-hide")},3e3)})},onUpdate:function(t,e,a){setTimeout(function(){$(t).find(".mapv-play-control-progress .progress-cursor").css("left",100*a+"%")})},onStateChange:function(t,e){"play"===e&&S.vizToolControl&&S.vizToolControl.reset()}},fps:.5*(+e.timeline.speed||3),loop:e.timeline.loop,loopInterval:1e3},e.type.indexOf("trajectory")>=0){var D=e.timeline.field.granularity||"day",M={year:31536e6,quater:7776e6,month:2592e6,week:6048e5,day:864e5,hour:36e5,minute:6e4};switch(o.animationOptions.scope=M[D],o.animationOptions.fps=60,e.timeline.speed){case 1:o.animationOptions.duration=6e4;break;case 5:o.animationOptions.duration=1e4;break;case 3:default:o.animationOptions.duration=2e4}}}else"bubble"===e.type&&"ripple"!==e.bubble_symbol&&l.length<=this.animationThreshold&&(o.animation=!0,o.animationOptions={duration:600,transition:"ease-out"});return o.drawOptions=a,o.data=l,o.type=e.type,o},showLayer:function(t){this._layers[t]&&this._layers[t].show(),this.vizToolControl.showSelectResultInLayer(t),this.layerInfo[t].tempInvisible=!1},hideLayer:function(t){this._layers[t]&&this._layers[t].hide(),this.vizToolControl.hideSelectResultInLayer(t),this.layerInfo[t].tempInvisible=!0},pauseTimeAnimation:function(){this.mapv&&this.mapv.pauseTimeAnimation()},startTimeAnimation:function(){this.mapv&&this.mapv.startTimeAnimation()},_getDrawType:function(t){return"heatmap"===t.type?t.type:"bubble"===t.type||"massive"===t.type||"trajectory"===t.type?"simple":"graph"===t.type?"graph":void 0},_getGradientColor:function(t){return t.color_setting&&1==t.color_setting.mode?{.3:t.color_setting.range_color.start_color,1:t.color_setting.range_color.end_color}:null},_getBubbleSize:function(t,e){return e.bubble_setting.size_range},_getLabelAxis:function(t,e){for(var i={},r=t.x.concat(t.y),n=e.x.concat(e.y),o=[],l=!1,s=0,d=r.length;d>s;s++){var h=n[s],c=r[s],p=(h.name,h.fid+"$"+(h.aggregator||""));l=h.aggregator?!0:!1,i[p]||(i[p]=1,o.push({name:a(h),data:c.data,type:h.data_type,field:h}))}if(e.color_setting){var u=e.color_setting.field[0];u.aggregator=e.color_setting.aggregator;var p=u.fid+"$"+u.aggregator;i[p]||(i[p]=1,!l&&"number"!==u.data_type&&u.aggregator&&(t.colors=t.colors.map(function(){return 1})),o.push({name:a(u),data:t.colors,field:u}))}if(e.bubble_setting){var u=e.bubble_setting.field;u.aggregator=e.bubble_setting.aggregator;var p=u.fid+"$"+u.aggregator;i[p]||(i[p]=1,o.push({name:a(u),data:t.bubble_sizes,field:u}))}return o},hideTooltip:function(){c.hideTooltip()},showTooltip:function(t,e,a){if(!t.labels||0!==t.labels.length){for(var i=['<table style="margin: 0 6px;">'],r=0,n=t.labels.length;n>r;r++)i.push('<tr><td class = "text-right" style = "padding-right:4px">'+bdp.utils.encodeHTML(t.labels[r].name)+':</td><td class = "text-left" >'+t.labels[r].value+"</td></tr>");i.push("</table>"),c.showTooltip(e,a,i.join(""))}},clear:function(){this.mapv&&this.mapv.clearAllLayer()},_bMap2ImageSrc:function(t,e,a){t=t||1;var i="/api/bmap/staticimage",r=this.getCenterAndZoom(),n={center:r.center.lng+","+r.center.lat,zoom:r.zoom,width:e,height:a,copyright:1,ak:"1XjLLEhZhQNUzd93EjU5nOGQ",scale:Math.round(t)},o=[];for(var l in n)n.hasOwnProperty(l)&&o.push(l+"="+n[l]);return i=i+"?"+o.join("&")},exportImage:function(t){var e=document.createElement("canvas");t=Math.min(t,2);var a=e.getContext("2d"),i=t||n(a),r=$.Deferred(),o=this.getBaseMapCanvas(),l=this.getCoverMapCanvas(),s=this.$elem.width(),d=this.$elem.height(),h=s*i,c=d*i;e.width=h,e.height=c;var p=!1,u=this.watermark,f=this.watermark,m=0,g=0,y=0,v=0,_=function(){if(o.box[0].style.left=parseInt(o.box[0].style.left)*i+"px",o.box[0].style.top=parseInt(o.box[0].style.top)*i+"px",o.map.children("div").each(function(t,e){e.style.left=parseInt(e.style.left)*i+"px",e.style.top=parseInt(e.style.top)*i+"px",$(e).children("img").each(function(t,e){m=parseInt(e.style.width),g=parseInt(e.style.height),$(e).width(m*i),$(e).height(g*i),y=parseInt(e.style.left),v=parseInt(e.style.top),e.style.left=y*i+"px",e.style.top=v*i+"px"})}),u){var t=a.createPattern(b,u.repeat||"repeat");a.fillStyle=t,a.fillRect(0,0,h,c)}l.canvasList.each(function(t,e){var a=Canvas2Image.convertToPNG(e,s,d).src,r=parseInt(e.style.left)*i+"px",n=parseInt(e.style.top)*i+"px";canvasToImage='<img src="'+a+'" width="'+s*i+'" height="'+d*i+'" style="position: absolute; top: '+n+"; left: "+r+';"/>',l.canvasLayer.append(canvasToImage)}),l.box.append(l.canvasLayer),o.box.append(l.box),o.box.append(o.map),r.resolve(o.box)};if(u){var b=new Image;b.onload=function(){f=!0,p&&_()},b.src=u.url}else _();return r.promise()},getBaseMapCanvas:function(){var t=this.$elem.children("div:first-child"),e={map:[],box:null};return e.box=this.$elem.children("div:first-child").clone(),e.box.children("div").remove(),e.map=t.children("div:eq(-3)").clone(),e},getCoverMapCanvas:function(){var t=this.$elem.children("div:first-child"),e={box:null,canvasLayer:null,canvasList:[]};return e.box=t.children("div:eq(1)").clone(),e.box.children("div").remove(),e.canvasLayer=t.children("div:eq(1)").children("div:last-child").clone(),e.canvasList=this.$elem.children("div:first-child").children("div:eq(1)").children("div:last-child").children("canvas"),e.canvasLayer.children("canvas").remove(),e},toObjectURL:o};var c=function(){var t;return{showTooltip:function(e,a,i){t||(t=new Tooltip(void 0,{typeClass:"sankey-tooltip"})),t.content(i).position(e,a).show()},hideTooltip:function(){t&&t.hide()}}}();bdpChart.Events.mixTo(e)}(angular),!function(){function t(t){var e=bdpChart.language,a="zh"===e?"当前图表无数据":"No data to display";t.html('<div class="chart-error"><p>'+a+"</p></div>").addClass("bdp-chart-loaded bdp-chart-error")}function e(t){t.info.funnel_setting||(t.info.funnel_setting={show_detail:!0,layout:"horizontal"}),this.chart=t,this.$elem=t.$elem,this.theme=t.theme,this.d3Elem=d3.selectAll(this.$elem.toArray()),this.data=[],this.tooltip=null,this.displayMode=t.mode,this.layout=this.chart.info.funnel_setting.layout||"horizontal",this.modeColor=this.chart.deviceStyle.bg}var a=bdpChart.helper;bdpChart.language||(bdpChart.language="zh"),e.prototype={constructor:e,draw:function(){return this.$elem.width()*this.$elem.height()===0?!1:(this._setOptions(),this._setSeries(),this.data.length?(this._setOptionsByMode(),this._bindEvents(),new D3Funnel(this.d3Elem).draw(this.data,this.options),void this.chart.emit("load",this.chart,null)):(t(this.$elem),!1))},formatXaxisLabel:function(t){if("date"===t.data_type){var e=t.granularity,i=t.granularity_name||"",r=t.month_start_day||0;"week"===e&&(r=t.week_start_day_of_week);var n=t.data[t.data.length-1]-t.data[0];e=bdpChart.helper.setGranularityByDate(e,n),t.data.forEach(function(n,o){t.data[o]=a.checkGranularity(e,n,i,r)})}return t.data},getColor:function(){var t=[],e=this.chart.info.funnel_setting;return t=e&&e.color_theme||bdpChart.getColorsByType("C330","bdp"),this.colorTheme=t,d3.scale.ordinal().range(t)},_setOptions:function(){var t=this,e=("fullscreen"===this.displayMode,"zh"===bdpChart.language?"转化率":"Conversion Rate"),i="zh"===bdpChart.language?"到达率":"Arrival Rate",r=!this.chart.isDashboardMode||this.chart.isDashboardMode&&("horizontal"===t.layout&&t.chart.gridHeight>3||"vertical"===t.layout&&t.chart.gridWidth>3);t.options={chart:{bottomPinch:1,layout:t.layout||"horizontal",width:this.$elem.width(),height:this.$elem.height()},block:{fill:{scale:this.getColor()},stroke:{color:"dark"===this.theme?"#24273E":"#fff"},highlight:!0,dynamicHeight:!1,autoSlope:!0,bottomBlock:{minWidth:40,height:30,text:{fill:"dark"===this.theme?"#FFF":"#333"}}},events:{mouseover:{block:function(r){t.tooltip=t.$elem.find(".sankey-tooltip");var n,o=t.chart.data,l=t.chart.info,s=r.index,d=t.data[s],h=(s<t.data.length-1?t.data[s+1]:[],t.data[0][1],o.y[0]),c=o.y[0];s<t.data.length-1&&(n=0===d[1]?"--":(t.data[s+1][1]/d[1]*100).toFixed(2)+"%");var p;s<t.data.length-1&&(p=0===t.data[0][1]||null===t.data[0][1]||void 0===t.data[0][1]?"--":(t.data[s+1][1]/t.data[0][1]*100).toFixed(2)+"%"),l.xAxis.length||(h=o.y[s],s<t.data.length-1&&(c=o.y[s+1]));var u=h.formatter,f=(h.nick_name||h.name,""),m="";h.hasOwnProperty("unit_adv")&&(f=h.unit_adv),c.hasOwnProperty("unit_adv")&&(m=c.unit_adv);var g,y=r.fill.actual;g="dark"===t.theme?"#FFF":y;var v=t.data.length-1;if(r.index===v)return!1;var _=d[0],b=t.data[s+1][0];if(l.xAxis.length>0&&"date"===l.xAxis[0].data_type){var x=l.xAxis[0].granularity;["hour","minute","second"].indexOf(x)>-1&&(x="g_"+x),_=a.checkGranularity(x,t.chart.origin_data.x[0].data[s]),b=a.checkGranularity(x,t.chart.origin_data.x[0].data[s+1])}if(!t.tooltip.length){var C=t.setTooltipPosition();t.tooltip=$('<div class="sankey-tooltip" style="position:absolute; border-color:'+y+";left:"+C.x+"px;top:"+C.y+'px;"><table class="tooltip-table"></tr><tr><td style="color:'+y+'">'+a.escapeHtml(_)+'：</td><td style="color:'+g+'">'+a.dataLabelFormatter(u,r.value)+f+'</td></tr><tr><td style="color:'+y+'">'+a.escapeHtml(b)+'：</td><td style="color:'+g+'">'+a.dataLabelFormatter(u,t.data[s+1][1])+m+'</td></tr><tr><td style="color:'+y+'">'+e+'：</td><td style="color:'+g+'">'+n+'</td></tr><tr><td style="color:'+y+'">'+i+'：</td><td style="color:'+g+'">'+p+"</td></tr></table></div>"),t.$elem.append(t.tooltip)}}},mouseout:{block:function(){t.tooltip.remove()}},mousemove:{block:function(){var e=t.setTooltipPosition();t.updateTooltipPosition(e.x,e.y)}}},label:{fontSize:"14px",fill:"#fff",format:function(e,i){var r=t.chart.data.y[0].formatter;return a.dataLabelFormatter(r,i)}},attrition:{rate:{enabled:r,label:{fontSize:"10px",fill:"dark"===this.theme?"rgba(255,255,255,0.3)":"#333",width:110},lineColor:"dark"===this.theme?"rgba(255,255,255,0.3)":"#ccc"},count:{enabled:r,label:{fontSize:"10px",fill:"dark"===this.theme?"rgba(255,255,255,0.3)":"#333",width:110},lineColor:"dark"===this.theme?"rgba(255,255,255,0.3)":"#ccc"}}}},_setOptionsByMode:function(){"fullscreen"===this.displayMode?this.options=$.extend(!0,this.options,{chart:{animate:200,padding:[20,0,20,0]},block:{bottomBlock:{text:{}},stroke:{color:"none"}},label:{fontSize:"14px"},attrition:{rate:{label:{fontSize:"14px",width:200}},count:{label:{fontSize:"14px",width:200}}}}):"dark"===this.chart.theme&&(this.options=$.extend(!0,this.options,{block:{bottomBlock:{text:{fill:"#fff"}},stroke:{color:"none"}},attrition:{rate:{label:{fill:"rgba(255, 255, 255, .5)"},lineColor:"rgba(255,255,255,0.3)"},count:{label:{fill:"rgba(255, 255, 255, .5)"},lineColor:"rgba(255,255,255,0.3)"}}}))},_setSeries:function(){var t,e,a=this,i=a.chart.data;i.x.length?(e=i.y[0].data,t=a.formatXaxisLabel(angular.copy(i.x[0]))||[],t.forEach(function(t,i){var r=[t,1*e[i]];defined(e[i])?r.push(a.colorTheme[i%a.colorTheme.length]):(r[1]=null,r.push(a.modeColor)),a.data.push(r)})):i.y.forEach(function(t,e){var i=[t.nick_name||t.name,1*t.data[0]];defined(t.data[0])?i.push(a.colorTheme[e%a.colorTheme.length]):(i[1]=null,i.push(a.modeColor)),a.data.push(i)}),a.data.length>0&&(a.data[a.data.length-1][2]=a.modeColor),a._setBottomWidth()},getEdgeVal:function(){for(var t,e=this.data,a=this.data[0][1],i=this.data[0][1],r=0;r<e.length;r++)t=e[r][1],a>t&&(a=t),t>i&&(i=t);return 0>i*a||0>i?a=0:0===i&&0===a&&(i=40,a=40),{max:i,min:a}},_setBottomWidth:function(){var t=this;if(t.data.length){var e=t.getEdgeVal(),a=null===e.max||isNaN(e.max)?1:Math.min(1,e.min/e.max);this.options=$.extend(!0,this.options,{chart:{bottomWidth:a}})}},_bindEvents:function(){var t=this;t.chart.info.is_drill&&(t.options=$.extend(!0,t.options,{events:{click:{block:function(e){t.chart.emit("drilldown",e,t.chart)}}}}))},setTooltipPosition:function(){if(null===this.tooltip)return{x:0,y:0};var t=this.tooltip.outerWidth(),e=this.tooltip.outerHeight(),a=d3.event.clientX+10,i=d3.event.clientY,r=this.$elem[0].getBoundingClientRect();return d3.event.pageX+t>r.right&&(a=a-t-20),d3.event.pageY+e>r.bottom-30&&(i-=e),{x:a-r.left,y:i-r.top}},updateTooltipPosition:function(t,e){this.tooltip&&this.tooltip.css({left:t,top:e})},resize:function(t){var e=this,a=t[0].offsetWidth,i=t[0].offsetHeight;e.d3Elem&&e.d3Elem.select("svg")&&e.d3Elem.select("svg").attr("width",a).attr("height",i)}},bdpChart.setFunnelSpecialOption=function(a){var i=a.$elem;if(!a.data.y[0].data.length)return void t(i);var r=new e(a);r.draw(),$(window).on("resize",function(){r.resize(i)})}}(),!function(){bdpChart.setWordCloudSpec=function(t){function e(t){if(v.html(""),r(),t?(w.width=b.width*_,w.height=b.height*_,w.style.width=b.width+"px",w.style.height=b.height+"px"):w=a(b),0==g.length){var e="zh"===bdpChart.language?"当前图表无数据":"No data to display";return void v.html('<div class="chart-error"><p>'+e+"</p></div>").addClass("bdp-chart-loaded bdp-chart-error")}WordCloud(w,k),v.append(w),$(w).on("wordcloudstop",function(){setTimeout(function(){v.addClass("bdp-chart-loaded")},0)})}function a(t){var e=document.createElement("canvas");return e.className="chart-canvas canvas-"+p.chart_type,e.width=t.width*_,e.height=t.height*_,e.style.width=t.width+"px",e.style.height=t.height+"px",e}function r(){n(m,g),o(),s(),h()}function n(t,e){var a=m.map(function(t,a){return[t,e[a]]});k.list=a}function o(){function t(t){if(0==t){var r=bdpChart.colors[a.theme||"default"];if(!a.enum_color_map){var n={};angular.forEach(m,function(t,e){void 0==n[t]&&(n[t]={name:t,color:r[e%r.length]})}),a.enum_color_map=n}a.enum_color_map=l(m,a.enum_color_map,r),x=a.enum_color_map,e=function(t){return a.enum_color_map.hasOwnProperty(t)?a.enum_color_map[t].color:void 0}}else{var n=g.map(function(t){return Number(t)}),o=y.linearRangeColor(a.range_color.start_color,a.range_color.end_color),s=y.createLinearScale(a.range_color,n),d=[],h=a.range_color.step;if(h>1){for(i=0;h-1>i;i++)d.push(o(i/(h-1)));d.push(o(1))}e=function(t,e){var a=s(e);if(h){var i=Math.floor(h*a);return i=Math.min(i,h-1),x[t]=d[i],d[i]}return x[t]=o(a),o(a)}}}var e=d3.scale.category20(),a=p.color_setting;f[0].fid==a.field[0].fid&&t(a.mode),k.color=e}function l(t,e,a){return e=e||{},angular.forEach(t,function(t,i){void 0==e[t]&&(e[t]={name:t,color:a[i%a.length]})}),e}function s(){var t=grid_s=0;$.each(m,function(e,a){var i=Math.sin(A(g[e])/100),r=0,n=1;/[\w-]/i.test(m[e])&&(r=m[e].match(/[\w-]/gi).length,n=1-.5*r/m[e].length),t+=i*a.length*i*n});var e=0;k.weightFactor=function(a){if(a=1.2*Math.round(Math.sin(A(a)/100)*Math.sqrt(b.width*b.height/t)),1==_&&(a/=2),b.width/b.height>2){var i=.9;1==_&&(i=.8),a*=i}return m[e].length*a>b.width*_*.9&&(a=b.width*_/m[e].length*.9),e++,a}}function d(){if(!v.find(".sankey-tooltip").length){var t=document.createElement("div"),e=document.createElement("p"),a=document.createElement("span");e.className="tooltips-title",a.className="tooltip-value",t.className="sankey-tooltip",$(t).css("display","none"),$(t).append(e).append(a),v.append(t)}return null}function h(){d(),k.hover=function(t,e,a){var i=v.find(".sankey-tooltip"),r="en"==bdpChart.language?"word frequency":"词频";if(t){v.find(".tooltips-title").text(t[0]),v.find(".tooltip-value").text(r+"："+t[1]).css("color",x[t[0]].color);var n=i.outerWidth(),o=i.outerHeight(),l=v[0].getBoundingClientRect(),s=a.clientX+10,d=a.clientY;a.pageX+n>l.right&&(s=s-n-20),a.pageY+o>l.bottom-30&&(d-=o),i.css({position:"absolute",left:s-l.left+"px",top:d-l.top+"px"}),i.show()}else i.hide()},v.off("mouseleave").on("mouseleave",function(){v.find(".sankey-tooltip").hide()})}function c(){(v.width()!=b.width||v.height()!=b.height)&&(k.clearCanvas=!0,setTimeout(function(){e(!0)},10))}var p=t.info,u=t.data,f=u.x,m=f[0].data||[],g=f[0].word_part_count||[],y=bdpChart.helper,v=t.$elem,_=window.devicePixelRatio||1,b={width:v.width(),height:v.height()},x={},C="fullscreen"==t.mode?" #272A30":"#fff";C="transparent";var w,k={shuffle:!1,rotateRatio:1,customRotations:[0,-Math.PI/2,0,Math.PI/2,0],fontFamily:"Arial, Helvetica, Microsoft Yahei, sans-serif",backgroundColor:C},A=d3.scale.linear().domain([g[g.length-1],g[0]]).range([20,157]);v.css("overflow","hidden"),setTimeout(function(){e()},500),window.onresize=function(){"edit"!=t.mode&&c()}}}(),!function(){function t(t){var e=bdpChart.language,a="zh"===e?"当前图表无数据":"No data to display";t.html('<div class="chart-error"><p>'+a+"</p></div>").addClass("bdp-chart-loaded bdp-chart-error")}function e(t){t.info.funnel_setting||(t.info.funnel_setting={show_detail:!0,layout:"horizontal"}),this.options={series:[],color:[]},this.$elem=t.$elem,this.d3Elem=d3.selectAll(t.$elem.toArray()),this.data={$elem:[],dataArray:[],width:"",height:""},this.chart=t,this.theme=t.theme,this.tooltip=null,this.data.$elem=d3.selectAll(t.$elem.toArray());var e="edit"===t.mode?32:0,a="edit"===t.mode?40:0;this.data.height=t.$elem[0].offsetHeight-2*e,this.data.width=t.$elem[0].offsetWidth-2*a,this.modeColor=this.chart.deviceStyle.bg}bdpChart.helper,bdpChart.language||(bdpChart.language="zh"),e.prototype={constructor:e,draw:function(){if(this.$elem.width()*this.$elem.height()===0)return!1;var e=this._structData(this._normalizeData());return!e.length||1===e.length&&1===e[0].firstNull?(t(this.$elem),!1):(this.data.dataArray=e,this._setOptions(),this._bindEvents(),new D3Sunburst(this.data,this.options),void this.chart.emit("load",this.chart,null))},_normalizeData:function(){var t=this,e=angular.copy(t.chart.data),a=bdpChart.language||"zh",i=e.y[0].data;t.chart.misMatchNum=[];for(var r=i.length-1;r>=0;r--)if(i[r]<0||null===i[r]){i.splice(r,1);var n,o=[];e.x.forEach(function(e,i){n=""===e.data[r]?"zh"===a?"(空白)":"(blank)":t.chart._formatXAxisLabel(e.data[r],i,!0),o.push(n),e.data.splice(r,1)}),t.chart.misMatchNum.push(o.join("-"))}return e},_makeFirstLevelPosItem:function(t,e){for(var a,i=t.data,e=e||0,r=[],n={},o=this.chart.info.xAxis,l=0,s=0;s<o.length;s++)if(o[s].fid===t.fid){l=s;break}for(var s=0,d=i.length;d>s;s++)if(a=this.chart._formatXAxisLabel(i[s],l,!0),n={originData:i[s],name:a,startPos:s+e,endPos:"",children:[],colorArray:[],color:"",size:""},0===s)r.push(n),1===d&&(n.endPos=s+e);else if(s>0&&i[s]!==i[s-1]){r.push(n);var h=r.length,c=s-1+e;if(r[h-2].endPos=c,s===d-1){var p=s+e;r[h-1].endPos=p}}else if(s===d-1){var h=r.length,p=s+e;r[h-1].endPos=p}return r},_makeOtherPosItem:function(t,e){for(var a,i,r=t.data,n=[],o=[],l=angular.copy(t),s=0,d=e.length;d>s;s++){a=e[s].startPos,i=e[s].endPos,l.data=[];for(var h=a,c=i+1;c>h;h++)l.data.push(r[h]);n=this._makeFirstLevelPosItem(l,a),o=o.concat(n)}return o},getPosArr:function(t,e){for(var a,i,r=[],n=t.length,o=0;n>o;o++)a=0===o?this._makeFirstLevelPosItem(t[o]):this._makeOtherPosItem(t[o],r[r.length-1]),r.push(a);i=r[r.length-1];for(var o=0,l=i.length;l>o;o++)i[o].size=1*e[o];return r},makeJsonData:function(t){for(var e,a,i=t.length-1;i>=1;i--)e=t[i],a=t[i-1],this.pushLevelItem(a,e);return a},pushLevelItem:function(t,e){for(var a,i,r,n,o,l,s,d=0,h=0,c=t.length;c>h;h++){a=t[h],i=a.startPos,r=a.endPos,d=0;for(var p=0,u=e.length;u>p;p++)n=e[p],o=parseFloat(n.size),l=n.startPos,s=n.endPos,l>=i&&r>=s&&(d+=o,a.size=d,["","(空白)","(Blank)"].indexOf(n.name)>-1&&(n.firstNull=1,n.children=[]),a.children.push(n))}},attrChildrenColor:function(t){var e=t.children;if(e)for(var a=0;a<e.length;a++)e[a].color=t.color,this.attrChildrenColor(e[a])},_attrColor:function(t,e){var a,i=e.data.x,r=e.info,n=bdpChart.colors["default"],o=n.length,l={},s=r.color_setting,d=t.length,h=[];i[0].data.forEach(function(t){""!==t&&["(空白)","(Blank)"].indexOf(t)<0&&h.indexOf(t)<0&&h.push(null===t?null:t)}),s.enum_color_map?l=s.enum_color_map:h.forEach(function(t,e){""!==t&&["(空白)","(Blank)"].indexOf(t)<0&&!l.hasOwnProperty(t)&&(l[t]={name:t,color:n[e%o]})});for(var c=0;d>c;c++)a=t[c],a.color=["date","sub_date"].indexOf(i[0].data_type)>-1&&l.hasOwnProperty(a.originData)?l[a.originData].color:l[a.name]?l[a.name].color:n[c],this.attrChildrenColor(a);return t},_structData:function(t){for(var e=this,a=(e.chart.data,t.y[0].data),i=this.makeJsonData(this.getPosArr(t.x,a)),r=0,n=i.length-1;n>=0;n--)("(空白)"===i[n].name||""===i[n].name)&&(i[n].firstNull=1,i[n].children=[]),r+=i[n].size;return i.size=r,i=e._attrColor(i,e.chart)},setTooltipPosition:function(){if(null===this.tooltip)return{x:0,y:0};var t=this.tooltip.outerWidth(),e=this.tooltip.outerHeight(),a=d3.event.clientX+10,i=d3.event.clientY,r=this.$elem[0].getBoundingClientRect();return d3.event.pageX+e>r.right&&(a=a-t-20),d3.event.pageY+e>r.bottom-30&&(i-=e),{x:a-r.left,y:i-r.top}},_setOptions:function(){var t,e=this,a=("fullscreen"===this.displayMode,!this.chart.isDashboardMode||this.chart.isDashboardMode,"zh"===bdpChart.language?"占比":"rate"),i=Math.min(e.data.height,e.data.width);t=250>i?"10":i>=250&&450>i?"12":i>=450&&850>i?"14":"16",e.options={chart:{fontSize:t,modeColor:e.modeColor,showProportion:e.chart.info.sunburst_setting&&e.chart.info.sunburst_setting.showProportion||"text"},events:{mouseover:{block:function(t,i){function r(t){var e=d3.rgb(t.color),a=e.r+25>255?255:e.r+25,i=e.g+25>255?255:e.g+25,r=e.b+25>255?255:e.b+25,n=d3.rgb(a,i,r);return n.toString()}function n(t){return t.parent?n(t.parent):t.size||(s=t.children.size),s}function o(t){return t.depth>1?(u=t.parent.name+"-"+u,o(t.parent)):1===t.depth,u}var l=angular.copy($(e.$elem).find("#path-"+i).css("fill"));t.normalColor=l,e.tooltip=e.$elem.find(".sankey-tooltip");var s,d=d3.hsl(t.color),h=t.depth%2===1?t.color:d3.hsl(d.h,d.s,1.15*d.l);if($(e.$elem).find("#path-"+i).css("fill",r(t)),!e.tooltip.length&&t.parent){var c=e.setTooltipPosition(),s=n(t),p=t.size/s*100,u=t.name,f=e.chart.info,m=o(t),g="default"===e.theme?"#8E8E8E":"#fff",y=f.y[0].nick_name||f.y[0].name,v=f.yAxis[0].formatter,_=f.yAxis[0].unit_adv||"",b=bdpChart.helper.dataLabelFormatter(v,parseFloat(t.size));e.tooltip=$('<div class="sankey-tooltip" style="position:absolute; border-color:'+h+";left:"+c.x+"px;top:"+c.y+'px;"><p class="text-center tooltips-title" style="color: '+g+'">'+m+'</p><table class="tooltip-table"></tr><tr><td class="nowrap" style="color:'+h+';text-align: right; max-width: 170px; overflow:hidden; text-overflow:ellipsis ">'+$.trim(bdp.utils.encodeHTML(y))+'：</td><td style="color:'+h+'">'+b+$.trim(bdp.utils.encodeHTML(_))+'</td></tr><tr><td style="color:'+h+'; text-align: right">'+a+'：</td><td style="color:'+h+'">'+p.toFixed(1)+"%</td></tr></table></div>"),e.$elem.append(e.tooltip)}}},mouseout:{block:function(t,a){$(e.$elem).find("#path-"+a).css("fill",t.normalColor),e.tooltip?e.tooltip.remove():null}},mousemove:{block:function(){var t=e.setTooltipPosition();e.updateTooltipPosition(t.x,t.y)}}}}},_bindEvents:function(){var t=this;t.options=t.options},updateTooltipPosition:function(t,e){this.tooltip&&this.tooltip.css({left:t,top:e})},resize:function(t){var e=this,a=t.width(),i=t.height();e.d3Elem&&e.d3Elem.select("svg")&&e.d3Elem.select("svg").attr("width",a).attr("height",i)}},bdpChart.setSunburstSpecialOption=function(a){var i=a.$elem;if(!a.data.y[0]||!a.data.y[0].data.length)return void t(i);var r=new e(a);$(window).on("resize",function(){r.resize(i)}),a.once("load",function(){var t=a.misMatchNum,e=bdpChart.language;if(t.length&&"edit"===a.mode&&"C360"===a.info.chart_type){var i="";i="zh"===e?"有"+t.length+"项负值或空值数据":"There are "+t.length+" negative or null values.";var r='<div class="map-mismatch-text pa guide"><p><a class="cursor-pointer">'+i+'</a></p><div class="guide-tip dropdown-wrap">'+bdp.utils.encodeHTML(t.join("、"))+"</div></div>";a.$elem.append(r)}}),a.on("reflow",function(){r.resize(i)}),r.draw()}}(),!function(t){return t.colors={"default":["#5182E4","#9BCC66","#3FB27E","#F7CB4A","#F88D48","#F35352","#CE62D6","#8954D4","#5156B8","#51B4F1","#69D4DB","#D42D6B"],contrast:["#006BC2","#FF8500","#0FA8E0","#197C90","#4D5FB0","#B98934","#4D8CAE","#72C8F2","#FFBF9A","#B6D0DE","#DCE292","#80ADC5"],vintage:["#984337","#5B6246","#999053","#E1D09F","#E39971","#9A4D2E","#DB5546","#E7824F","#DBA946","#BFA86F"],blue_sky:["#4A72C9","#6071C6","#78A9F2","#A3CCF8","#89A0D3","#4966B7","#479CE2","#7560BF","#47B8E2","#6087BF"],green_contrast:["#A1CB80","#3D8A6F","#FFCD5D","#C74A66","#42A4B8","#8B736E","#739E90","#08A86C","#4294B8","#76B55F"],green_contrast_2:["#B7D62D","#EB4B5C","#8D9E69","#D6D6D7","#67B9CD","#A4DED9","#8AC98B"],green:["#0D9347","#00633E","#D2EA57","#87CD43","#80AE9C","#AECDC3","#B4BBA5"],gray_blue:["#8DAFCE","#CE765B","#6B648D","#5491C5","#A16D6E","#4BB0D8","#D9C59D"],purple:["#7260AF","#A563AC","#D3C3DB","#A999C9","#D9A6D6"],blue_contrast:["#515FD7","#EEBDC1","#C5BEDC","#A6A7A9","#5787D8"],gray_red:["#5B68AA","#787B9B","#D95657","#D8D9DA","#85A0C1"],gray:["#5A6A7B","#9FB2BE","#5C6B86","#898E94","#CBD3DA"]},t.rangeColors={"default":["#FFA9A9","#EF6064"],golden:["#FAD961","#F76B1C"],green:["#C7CCAC","#0D9347"],blue:["#A3CCF8","#4A72C9"],purple:["#D3C3DB","#7260AF"],gray:["#CBD3DA","#5A6A7B"]},t.theme={bdp:function(e){var a=t.colors.default;switch(e){case 7:a=["#5182E4","#9BCC66","#3FB27E","#F7CB4A","#F88D48","#F35352","#CE62D6","#8954D4","#5156B8","#51B4F1","#69D4DB","#D42D6B"];break;case 0:a=["#5182E4","#F7CB4A","#3FB27E","#F88D48","#9BCC66","#69D4DB","#51B4F1","#5156B8","#8954D4","#CE62D6","#F35352","#D42D6B"];break;case 14:a=["#F88D48","#5182E4","#F7CB4A","#3FB27E","#9BCC66","#69D4DB","#51B4F1","#5156B8","#8954D4","#CE62D6","#F35352","#D42D6B"];break;case 21:a=["#3FB27E","#F7CB4A","#F88D48","#5182E4","#9BCC66","#69D4DB","#51B4F1","#5156B8","#8954D4","#CE62D6","#F35352","#D42D6B"];break;case 300:a=["#5182E4","#FFC064","#3FB27E","#F88D48","#9ACFFE","#81D069","#51B4F1","#CE62D6","#EE4B4A","#8954D4","#D42D6B","#385CD4"];break;case 310:a=["#A3ABB0"];break;case 320:a=["#EB4B5C","#B7D62D"];break;case 330:a=["#9BCC66","#FEC163","#40A376","#FE855A","#EF4C4C","#A139D5","#6738D5","#395DD5","#3886D4","#9BD0FE","#76797C","#71B0DA"];break;case 370:a=["#5182E4","#5355B7","#55B3F0","#40B27E","#9ACC67","#F78E4B","#F25554","rgba(81,130,228,0.85)","rgba(83,85,183,0.85)","rgba(85,179,240,0.85)","rgba(64,178,126,0.85)","rgba(154,204,103,0.85)","rgba(247,142,75,0.85)","rgba(242,85,84,0.85)"]}return a}},t.getColorsByType=function(e,a){var i=t.theme[a];$.isFunction(i)||(i=t.theme.bdp);var r;switch(e){case"C240":case"C242":case"C241":r=i(14);break;case"C210":case"C211":case"C212":case"C250":r=i(0);break;case"C260":case"C261":case"C220":r=i(21);break;case"C230":r=i(7);break;case"C300":r=i(300);break;case"C310":r=i(310);break;case"C320":r=i(320);break;case"C330":r=i(330);break;case"C370":r=i(370);break;default:r=i(0)}return r},{theme:t.theme}}(bdpChart),!function(t,e){function a(t,a){this.maxDataLen=1500,this.dsh_id=a.dsh_id,this.ct_id=a.ct_id,this.rule_id=a.rule_id,this.ws_id=a.ws_id,this.access_token=a.access_token,this.mode=t,this.is_tpl=a.is_tpl||0,this.is_chart_tpl=a.is_chart_tpl||0,this.theme=a.theme||"default",this.themeColor=angular.copy(e.themeColors[this.theme]),this.device=a.device||"pc",this.deviceStyle=e.deviceStyles[this.theme][this.device],/(\d+)\*(\d+)/.test(t)&&(this.isDashboardMode=!0,this.gridWidth=RegExp.$1>>>0,this.gridHeight=RegExp.$2>>>0),this.optional={},this.defaultOptions={},this.chartTypeDelegate=e.chartTypeDelegate,this.modeDelegate=e.modeDelegate,this.isMobileMode=r.isMobile()}var r=e.helper,n=e.ChartType;a.prototype={draw:function(t,e,a,i,r,o){var l=this;l.readCache=e&&e.read_cache||!1,"edit"===l.mode&&l.getChartType()!==n.GIS&&l.destroy(),l.$elem=t,e&&(l.ct_id!==e.ct_id&&l.destroy(),l.ct_id=e.ct_id,l.rule_id=e.rule_id,l.auto_play=i,l.setOptional(e.optional),l.isDashboardMode&&(l.dash_setting=r.child.meta.dash_setting),e.advanced_sort&&(this.advanced_sort=e.advanced_sort)),t.data("chart-data",l);var s=(new Date).getTime();l.readCache&&l.isDashboardMode?(l._loadingState(),l._drawChartWithCache(a,o,s)):l.requestData(a,o).then(function(t){l._drawChart(t,o,s)})},updateInfo:function(t,a){this.info=$.extend(!0,this.info,t),a&&!this.loading_data&&(this.getChartType()===n.GIS?e.setGisSpec(this):(this.destroy(),this.renderChart()))},renderChart:function(t){var a=this,i=a.ct_id,o=a.getChartType(),l=t&&t.mainChartContainer||a.mainChartContainer;
if("dark"===this.theme?this.$elem.removeClass("chart-theme-default").addClass("chart-theme-dark"):this.$elem.removeClass("chart-theme-dark").addClass("chart-theme-default"),r.isDrillChart(a.info)?a.isDashboardMode&&a.$elem.parent().removeClass("noscroll"):a.$elem.parent().find(".drill-crumbs").remove(),[n.Table,n.AreaMap,n.BubbleMap,n.Sankey,n.KPICard,n.Funnel,n.WordCloud,n.GIS,n.Sunburst].indexOf(o)>-1){switch(o!==n.GIS&&a.destroy(),a.options={},[n.AreaMap,n.BubbleMap].indexOf(o)>-1&&a._bindEventsOptions(),o){case n.Table:e.setTableSpecialOption(a,l);break;case n.AreaMap:e.setMapAreaSpecialOption(a);break;case n.BubbleMap:var s=a._needSetLinkCorlor();e.setMapBubbleSpecialOption(a,l,s);break;case n.Sankey:e.setSankeySpecialOption(a);break;case n.KPICard:e.setTextSpec(a);break;case n.GIS:e.setGisSpec(a);break;case n.Funnel:e.setFunnelSpecialOption(a);break;case n.Sunburst:e.setSunburstSpecialOption(a);break;case n.WordCloud:e.setWordCloudSpec(a);break;default:e.setTableSpecialOption(a)}[n.WordCloud,n.KPICard,n.Sankey,n.Table].indexOf(o)>-1&&a.emit("load",a),o!==n.WordCloud&&o!==n.GIS&&a.$elem.addClass("bdp-chart-loaded")}else{for(var d=a._config(t),h=d.series.length-1;h>=0;h--)d.series[h].id=h;if(a.translateMarkPoint(),a._isStackChart()){if(!a._isSettedColor()){var c=a.data.y.length;d.colors&&(d.colors=d.colors.splice(0,c).reverse())}d.series.length>0&&(d.series[0].borderRadiusTopLeft=1.7,d.series[0].borderRadiusTopRight=1.7,d.series[d.series.length-1].borderRadiusBottomLeft=1.7,d.series[d.series.length-1].borderRadiusBottomRight=1.7)}var p=a.chartInstance,u=!p||!p.series||[n.Radar,n.Waterfall].indexOf(o)>-1||p.series.length!==d.series.length||p.options.legend.enabled!==d.legend.enabled||p.options.legend.align!==d.legend.align||a.isSplitChart();if((a.info.is_drill||a.info.drill_level>0)&&(u=!0),u||p.series.length!==d.series.length||p.options.series.forEach(function(t,e){return t.nick_name!==d.series[e].nick_name?(u=!0,!0):void 0}),u||(p.userOptions.navigator&&!d.navigator||!p.userOptions.navigator&&d.navigator)&&(u=!0),u)a.destroy(),a.isSplitChart()&&!r.isEmptyChart(a.data)?a.renderChartInSplitMode(d):(p&&d.series&&d.series.forEach(function(t){t.animation=!0}),a.chartInstance=Highcharts.chart(a.$elem[0],d),a._setNavigatorRange(!0));else{var f=a.chartInstance.series,m=o===n.Scatter,g=a.info.xAxis.length>1;if(g)a.chartInstance.update(d);else{d.series.forEach(function(t,e){var i=f[e];if(i){if(m){for(var r=i.points.length,n=t.data.length,o=r-n,l=Math.abs(o)>50?!1:!0;o>0;){var s=r-o;i.removePoint(s,!1),o--}for(;0>o;)i.addPoint(t.data[n- -o],l),o++;i.options.animation=!0}i.setData(t.data,!1,!0,!0),$.extend(!0,i.options,{marker:t.marker})}else a.chartInstance.addSeries(t,!1,!0)}),[n.Gauge].indexOf(o)>-1?a.chartInstance.update({xAxis:d.xAxis,yAxis:d.yAxis,series:d.series}):(d.xAxis&&a.chartInstance.xAxis[0].update(d.xAxis,!1),a.chartInstance.yAxis.forEach(function(t,e){d.yAxis&&d.yAxis[e]&&t.update(d.yAxis[e],!1)}),$.extend(!0,a.chartInstance.options,d));var y=o==n.TreeMap?!1:{duration:800};a.chartInstance.setTitle(d.title,d.subtitle,!1),a.chartInstance.redraw(y)}a._setNavigatorRange(!1)}if(a.$elem.addClass("bdp-chart-loaded"),a.displayMissData(),-1==$.inArray(o,["C220","C250"])){var v=a.chartInstances||a.chartInstance;if(!v)return;if($.isArray(v))for(var h=0,_=v.length;_>h;h++)v[h].series&&a.setColorCache(i,v[h].series,h);else v.series&&a.setColorCache(i,v.series,0)}}},setArrColorCache:function(){},setColorCache:function(t,e,a){function i(){return r.mainChartColorContainer[t].chartColor[a].length<e.length}var r=this,n=r.data.x;r.mainChartColorContainer&&(r.mainChartColorContainer[t]=r.mainChartColorContainer[t]||{},r.mainChartColorContainer[t].chartColor=r.mainChartColorContainer[t].chartColor||[],r.mainChartColorContainer[t].chartColor[a]=r.mainChartColorContainer[t].chartColor[a]||[],i()&&angular.forEach(e,function(e){var o=[];angular.forEach(e.data,function(t,e){var a=t.color,i=[],r={};angular.forEach(n,function(t){i.push(t.data[e])}),r[i.toString()]=a,o.push(r)}),i()&&r.mainChartColorContainer[t].chartColor[a].push(o)}))},displayMissData:function(){var t=this,a=e.language||"zh",r=t.getChartType(),o=t.data.mismatch&&t.data.mismatch.length;if(o&&"edit"===t.mode){var l=[];for(i in t.data.mismatch)t.data.mismatch.hasOwnProperty(i)&&l.push(t._formatXAxisLabel(t.data.mismatch[i],0,!0));var s="";"zh"===a?r===n.Pie&&(s="有"+o+"项负值或空值数据"):r===n.Pie&&(s="There are"+o+" negative or null values");var d='<div class="map-mismatch-text pa guide"><p><a class="cursor-pointer">'+s+'</a></p><div class="guide-tip dropdown-wrap">'+bdp.utils.encodeHTML(l.join("、"))+"</div></div>";t.$elem.append(d)}},drawWithOption:function(t){this.draw(this.$elem,null,t)},_loadingState:function(){var t=this;t.isDashboardMode||0!==t.$elem.find(".load-outer").length||(t.$elem.append(r.initLoadingStatus("size-1x")),t.$elem.removeClass("bdp-chart-loaded bdp-chart-error").addClass("bdp-chart-loading")),t.$elem.addClass("bdp-chart-loading"),t.emit("data-loading"),t.loading_data=!0},_removeLoadingState:function(){var t=this;t.$elem.find(".base-loading-layer").remove(),t.$elem.removeClass("bdp-chart-loading"),t.emit("data-loaded"),t.loading_data=!1},requestData:function(t){var e=this,a={ct_id:e.ct_id,dsh_id:e.dsh_id};e.rule_id&&(a.rule_id=e.rule_id),e.ws_id&&(a.ws_id=e.ws_id),e.access_token&&(a.access_token=e.access_token),e.is_tpl&&(a.is_tpl=1),0!=t.is_advanced_sort&&this.advanced_sort&&(a.advanced_sort=this.advanced_sort,a.is_advanced_sort=1),this.is_chart_tpl&&(a.is_chart_tpl=1),$.extend(a,e.optional,t||{}),delete a.link_info,e._loadingState();var i=e.requestTimestamp=+new Date,o="/api/chart/data";a.sdo_id&&(o="/api/chart/share_data");var l=a;return $.ajax({url:o,type:"POST",dataType:"json",data:r.params(a)}).then(function(t){if(e.requestTimestamp>i)return null;if(t&&t.result&&BDPLogger.log("newtwork","api","chart/data",+new Date-e.requestTimestamp-(t.result.ts||0)),0===+t.status){var a=t.result.info,s=t.result.data;if(a.chart_type==n.GIS&&a.meta.layers){var d;a.meta.layers.some(function(t,e){return t.timeline&&t.timeline.enabled?(d=s.layers[e],!0):!1});var h=2e4;if(d&&d.timeline[0].data_count>h){for(var c=Math.min(Math.ceil((d.timeline[0].data_count-h)/h),9),p=[],u=d.timeline[0].start,f=d.timeline[0].end,m=2;c>0;)l.timeline_config={start:u,stop:f,page:m},p.push($.ajax({url:o,type:"POST",dataType:"json",data:r.params(l)})),c--,m++;return $.when.apply($,p).then(function(){var e=Array.prototype.slice.call(arguments),a=["lng","lat","trajectory","sequence","timeline","colors","x","y"];return s.layers.forEach(function(t,i){t.timeline&&t.timeline.length>0&&e.forEach(function(e){if(e[0]&&0===+e[0].status){var r=e[0].result.data.layers[i];a.forEach(function(e){"colors"==e?$.merge(t[e],r[e]):t[e]&&t[e].forEach(function(a,i){t[e][i]&&r[e][i]&&$.merge(t[e][i].data,r[e][i].data)})})}})}),t})}}}return t})},_writeCache:function(t){var e=this;if(dashChartsCache&&dashChartsCache[e.dsh_id]||(dashChartsCache={},dashChartsCache[e.dsh_id]={}),t&&t.result.info){var a=t.result.info;a.chart_type!==n.Sankey&&(dashChartsCache[e.dsh_id][e.ct_id]=t),e.readCache&&localforage.setItem("CACHE_DASH_DATA",dashChartsCache[e.dsh_id])}},_drawChartWithCache:function(t,e,a){var i,r=this;i=null,i?r._drawChart(i,e,a):r.requestData(t,e).then(function(t){t&&(r._writeCache(t),r._drawChart(t,e,a))})},_drawChart:function(t,e,a){var i=this;if(i._removeLoadingState(),t){var r=function(){var t=function(){var t=$.cookie("locale");Highcharts.setOptions({lang:{noData:"en"==t||!t&&"en"==navigator.language?"No data to display":"当前图表无数据"}}),i.renderChart(e)};bdp.utils.browser().safari?setTimeout(function(){t()},50):t()},n=(new Date).getTime();if(Math.ceil((n-a)/1e3),0===+t.status){var o=i.getChartType(),l=t.result.info?t.result.info.chart_type:"";o&&o!==l&&i.destroy(),i.data=t.result.data,i.info=t.result.info,void 0===i.info.show_datalabels&&(i.info.show_datalabels=["C230","C271","C272","C330","C360"].indexOf(i.info.chart_type)>-1),i.chartData=angular.copy(t.result.data),i.origin_data=angular.copy(t.result.data),e=e||{},i.mainChartContainer=e.mainChartContainer,i.mainChartIdContainer=e.mainChartIdContainer,i.mainChartColorContainer=e.mainChartColorContainer,i.chartData.message&&""!==i.chartData.message&&(setCurrentTipPosition("dataOver"),$("#dataOver").show().find("span").text(i.chartData.message),setTimeout(function(){$("#dataOver").hide()},3e3)),i.emit("data",i),r()}else{var s=t.errstr;i.$elem.html('<div class="chart-error"><p>'+s+"</p></div>").addClass("bdp-chart-loaded bdp-chart-error")}}},setOptional:function(t){this.optional=t},setMode:function(t){this.mode=t,/(\d+)\*(\d+)/.test(t)&&(this.isDashboardMode=!0,this.gridWidth=RegExp.$1>>>0,this.gridHeight=RegExp.$2>>>0)},getChartType:function(){return this.info?this.info.chart_type:""},supportNavigator:function(){var t=[n.Line,n.Column,n.NStackColumn,n.PStackColumn,n.Sankey,n.Area,n.NStackArea,n.PStackArea,n.Biax];return this.info,t.indexOf(this.getChartType())>-1&&this.data.x.length>0&&this.data.y[0]&&this.data.y[0].data.length>1},canDrillDown:function(){return this.info?this.info.is_drill:!1},_needSetLinkCorlor:function(){var t=this;return t.optional.linked_value,$.inArray(t.mode,["edit","fullscreen"])>-1?!1:-1==$.inArray(t.info.chart_id,t.mainChartIdContainer)?!1:!0},_isShowLegend:function(){var t=!0,e=this.info,a=e.chart_type,i=e.color_setting,r=[].concat(e.compare_axis||[]),o=r.map(function(t){return t.fid});return t=(a==n.Pie||!this.isMobileMode)&&(!this.isDashboardMode||this.isDashboardMode&&this.dash_setting.show_legend),t&&[n.Pie,n.Sunburst].indexOf(a)<0&&(i&&delete i.is_series,o&&i&&!$.isEmptyObject(i)&&(t=i.field.every(function(t){return o.indexOf(t.fid)<0?!1:!0}))),t},_config:function(t){var a=this;if(this.options={title:{text:""},subtitle:{text:this.info.title,y:-20,style:{"font-family":"Microsoft Yahei","font-size":"fullscreen"===this.mode?"20px":"16px",color:"dark"===this.theme?"#FFFFFF":"#333333"}},exporting:{filename:this.info.title},xAxis:{labels:{enabled:!a.isDashboardMode||a.isDashboardMode&&a.dash_setting.show_axis}},yAxis:[],tooltip:{crosshairs:!1,formatter:this._generateTooltipFormatter()},legend:{enabled:a._isShowLegend(),useHTML:!0,labelFormatter:this._generateLegendFormatter()}},r.isEmptyChart(this.data))return this.$elem.addClass("bdp-chart-loaded"),$.extend(this.options,{noData:{style:{color:"dark"===a.theme?"rgba(255, 255, 255, 0.36)":"#60606a"}},xAxis:{categories:[]},series:[]});this._setColorByTheme(),this._setBasicOptions(),this._bindEventsOptions(),this._setXaxisLabel(),this._setYaxisLabel(),this._setYaxisTitle(),this._setChartData(),this._setGuideLine(),this._setNavigatorOptions();var i=this.getChartType();"dark"===this.theme&&i===n.Biax&&(this.info.yAxisOptional.length?this.themeColor.yAxis[1]=angular.copy(this.themeColor.yAxis[0]):delete this.themeColor.yAxis[1]),$.extend(!0,this.options,this.themeColor),i===n.Pie&&e.setPieSpecialOption(this),i===n.Scatter&&e.setScatterSpecialOption(this),this._setChartTypeOptions(),a.needSetLinkCorlor=a._needSetLinkCorlor(),this._setColor(),a.needSetLinkCorlor&&this._setLinkColor(t),this._setModeOptions(),this._setSpecialOptions(),$.extend(!0,this.options,this.deviceStyle);var o=5,l=this.$elem.width()>this.$elem.height();this.getChartType()===n.Pie&&this.isDashboardMode&&(l=this.gridWidth>this.gridHeight+1);var s=l?{layout:"vertical",align:"right",verticalAlign:"top"}:{align:"center",layout:"horizontal",verticalAlign:"bottom",maxHeight:55,margin:o,padding:0};if(this.getChartType()===n.Pie&&(o=10,$.extend(!0,s,{enabled:!(this.isDashboardMode&&this.gridWidth<5&&3==this.gridHeight)&&this.isDashboardMode&&this.dash_setting.show_legend})),$.extend(!0,this.options,{legend:s}),"dark"===this.theme&&"fullscreen"!=this.mode){var d=[n.Pie];d.indexOf(i)>-1&&this.options.series.forEach(function(t){t.shadow=!0})}return i===n.TreeMap&&e.setTreemapSpecialOption(this),this.options},_setColorByTheme:function(){"fullscreen"!=this.mode&&1==this.theme_id&&Highcharts.setOptions({title:{style:{color:"rgba(255, 255, 255, 0.6)"}},legend:{navigation:{activeColor:"#999",inactiveColor:"#CCC",style:{color:"#666"}},itemStyle:{color:"#999"}},xAxis:{lineColor:"rgba(255,255,255,0.1)"},tooltip:{style:{color:"#FFF"}},plotOptions:{pie:{dataLabels:{style:{color:"#fefefe",textOutline:"1px 1px rgba(0,0,0,0.4)"}}}}})},_setBasicOptions:function(){var t=this.getChartType(),a=this.canDrillDown(),i=r.generateTitle(t,this.data,this.info),o=this.optional.chart_jump_info&&this.optional.chart_jump_info.can_jump,l=a||"2"==this.optional.linked_chart_type||"1"==o?"pointer":"",s={colors:e.getColorsByType(t),title:{text:i,margin:"edit"==this.mode?10:0},plotOptions:{series:{connectNulls:!0},column:{cursor:l},bar:{cursor:l},line:{cursor:l},spline:{cursor:l},scatter:{cursor:l},waterfall:{cursor:l},bubble:{cursor:l},area:{cursor:l},areaspline:{cursor:l}}};t!==n.Pie&&(t!==n.Biax&&1===this.data.y.length?$.extend(!0,s,{chart:{},legend:{enabled:!1}}):$.extend(!0,s,{chart:{spacingTop:""===i?22:12},legend:{y:-8}})),$.extend(!0,this.options,s)},_setNavigatorOptions:function(){var t=this,e=t.info,a=this.getChartType();if(this.supportNavigator()&&e.navigator_setting&&e.navigator_setting.enabled){if(this.isDashboardMode&&this.dash_setting.show_navigator===!1)return;if(this.info.split_compare)return;if(this.isDashboardMode&&this.gridWidth<4&&this.gridHeight<4||this.isDashboardMode&&this.gridHeight<4)return void $.extend(!0,this.options,{navigator:{enabled:!1}});var i="dark"===this.theme?{handles:{backgroundColor:"#3E4155",borderColor:"#717392"},outlineColor:"#3E4155",label:{textColor:"#bebfc6"}}:{handles:{backgroundColor:"#FFF",borderColor:"#BAC2C7"},outlineColor:"#E8EBED",label:{textColor:"#000"}},r=e.navigator_setting;if($.extend(!0,this.options,{chart:{spacingRight:3},navigator:{isDateAxis:"date"==this.info.x[0].data_type,enabled:!0,start:Math.max(0,r.start||0),end:Math.min(r.end||1,1),label:{formatter:function(e,a){return"object"==typeof e.category?e.category.parent.name+"_"+e.category.name:t._formatXAxisLabel(e.options.name||a||e.options.x,0)}}},xAxis:{minRange:1}},{navigator:i}),[n.PStackArea,n.NStackArea,n.NStackColumn,n.PStackColumn].indexOf(a)>-1){var o=this.options.series[this.options.series.length-1];$.extend(!0,o,{showInNavigator:!0})}if("edit"===this.mode){var t=this;$.extend(!0,this.options,{xAxis:{events:{afterSetExtremes:function(e){var a=e.target,i=(a.series[0].data,!1),r={},n=e.min,o=e.max;a.oldMin!==n&&(i=!0,r.start=(n-a.dataMin)/(a.dataMax-a.dataMin)),a.oldMax!==o&&(i=!0,r.end=(o-a.dataMin)/(a.dataMax-a.dataMin)),i&&t.emit("saveWithOpt",t.info.drill_level,{navigator_setting:r},{only_save_meta:!0})}}}})}}},_setNavigatorRange:function(t){var e=this.options;if(e.navigator&&e.navigator.enabled&&(0!=e.navigator.start||1!=e.navigator.end)){var a,i,r=(e.series[0].data,this.chartInstance.xAxis[0]),n=Math.max(0,r.dataMax-r.dataMin);a=r.dataMin+e.navigator.start*n,i=r.dataMin+e.navigator.end*n,r.setExtremes(a,i,t)}},_setSpecialOptions:function(){var t,e=this.info,a=this.getChartType(),i=[],r=this,o=e.yAxis,l=o.length,s=[];if("C370"!=a){for(var d=0;l>d;d++){var h={y:null};t=r.options.series[d],t&&t.data[d]&&t.data[d].color?h.color=t.data[d].color:t&&t.color&&(h.color=t.color),s.push(h)}if(!e.xAxis.length&&!e.compare_axis.length&&[n.Column,n.NStackColumn,n.PStackColumn,n.Bar,n.NStackBar,n.PStackBar].indexOf(a)>-1){for(var d=0;l>d;d++)i.push(o[d].nick_name||o[d].name),t=r.options.series[d],t.data=[].concat(s),t.data[d]={color:t.data[d].color,y:1*r.data.y[d].data[0]};$.extend(!0,this.options,{xAxis:{type:"category",categories:i,labels:{enabled:!0}},plotOptions:{column:{pointPadding:.2,borderWidth:0,stacking:"normal"},bar:{pointPadding:.2,borderWidth:0,stacking:"normal"}}})}}},isLoadingData:function(){return this.$elem.hasClass("bdp-chart-loading")},_bindEventsOptions:function(){var t=this,e=function(t,e){if(t.getChartType()===n.Pie&&"donut"===t.info.shape){var a=e.series[0].data[0];e.series[0].data.forEach(function(t){t.percentage>a.percentage&&(a=t)});var i=t.info.xAxis[0],o=i&&"date"===i.data_type?i.granularity:void 0,l=a.name;if(o){var s=a.x,d=i.granularity_name,h=i.month_start_day||0;"week"===o?d&&(s+=864e5*(i.week_start_day_of_week-1),h=i.week_start_day_of_week):("hour"===o||"minute"===o||"second"===o)&&(o="g_"+o),l=r.checkGranularity(o,s,d,h)}var c=a.percentage.toFixed(2)+"%",p=.4*e.plotHeight/250+.6,u=.6*e.plotHeight,f="dark"===t.theme?"#fff":"#666",m=e.plotLeft+e.series[0].center[0],g=e.plotTop+e.series[0].center[1],y=t.$elem.find(".pie-center-txt");if(y.length>0)y.find(".slice-name").text(l).css({color:a.color}),y.find(".slice-value").text(c);else{var y='<div class="pie-center-txt nowrap" style="position:absolute; text-align:center; transform: scale('+p+"); max-width: "+u+'px;">';y+='<span class="slice-name" style="font-size: 14px; line-height: 16px; color: '+a.color+'">'+l+"</span><br>",y+='<span class="slice-value" style="font-size: 30px; line-height: 32px; color: '+f+'">'+c+"</span>",y+="</div>",y=$(y),t.$elem.append(y)}var v="edit"===t.mode?[32,40,32,40]:[0,0,0,0];y.css({left:m+y.width()*-.5+v[3],top:g+y.height()*-.5+v[0]})}},a={chart:{events:{load:function(){t.$elem.addClass("bdp-chart-loaded"),t.emit("load",t,this),e(t,this)},redraw:function(){t.emit("redraw",t,this),e(t,this)}}}},i=["column","line","spline","bar","pie","map","mapbubble","scatter","waterfall","bubble","area","areaspline"];a.plotOptions={};var o=function(){var e=t.canDrillDown(),a=t.optional.chart_jump_info;e?t.emit("drilldown",this,t):t.emit("pointClick",this,t),"2"==t.optional.linked_chart_type&&t.emit("refreshLinkedCharts",this,t),a&&a.can_jump&&t.emit("jumpToOtherDash",this,t)};[n.Column,n.NStackColumn,n.PStackColumn,n.Bar,n.NStackBar,n.PStackBar,n.Waterfall].indexOf(t.getChartType())>-1&&t.data.x.length>0&&"date"!=t.data.x[0].data_type&&$.extend(this.options,{chart:{events:{click:function(t){var e=Math.abs(Math.round(t.xAxis[0].value));this.series[0].data[e].firePointEvent("click",event)}}}},!0),$.each(i,function(t,e){a.plotOptions[e]={point:{events:{click:o}}}}),this.options=this.options||{},$.extend(!0,this.options,a)},_setModeOptions:function(){return $.extend(!0,this.options,this.modeDelegate.getModeOption(this))},_setChartTypeOptions:function(){var t=this.getChartType(),e=this.chartTypeDelegate.getChartTypeOption(this,t);return $.extend(!0,this.options,e)},_generateTooltipFormatter:function(){var t=this.getChartType(),e=this._getUnit(),a=this.data,i=this.info;return function(){var n=this;return r.tooltipFormatter(n,t,a,i,e)}},_generateLegendFormatter:function(){var t=this.data;return function(){var e=this;return r.legendFormatter(e,t)}},_getUnit:function(){var t=this.info;return{unit_left:t.yaxis_unit,unit_right:t.yaxis_unit_right}},_setXaxisLabel:function(){var t,a=this.data,i=this.info,o=this.getChartType(),l=0;if(this.options.xAxis.plotLines=[],t=1===a.x.length?i.xAxis[0].data_type:"",o===n.Scatter&&i.yAxis){i.yAxis&&(t=i.yAxis[0].data_type);var s=i.chart_type===n.Scatter&&!$.isEmptyObject(i.bubble_setting);if("number"==t&&!s){var d,h,c,p,u={title:{text:""},gridLineWidth:0,endOnTick:!0};if(c=Math.max.apply(Math,a.y[0].data),p=Math.min.apply(Math,a.y[0].data),d=r.formatNumber(c),h=r.formatNumber(p),d=0>d?0:d,h=h>0?0:h,u.min=h,u.max=d,d==h)return;var f=4,m=[],g=Number(d.sub(h).div(f).toFixed(6));if(!g)return;for(var y=isInteger(g)?0:g.toString().split(".")[1].length,v=h;d>=v;v=Number(v.add(g).toFixed(y)))m.push(y?Number(v.toFixed(Math.min(y,6))):v);m.length<f+1&&m.push(v),u.tickPositions=m,$.extend(!0,this.options.xAxis,u)}$.extend(!0,this.options.xAxis,{labels:{formatter:function(){var t="percent"==a.y[0].formatter.check||"PERCENTAGE"===a.y[0].aggregator;if(t){var e=this.value,i=e.toString().split(".")[1]||void 0,n=0===e?2:i?i.length:2;return Highcharts.numberFormat(Number(e).mul(100),n-2)+"%"}return r.numericSymbols(this.value)}}})}else{for(var _=0;_<a.y.length;_++)l=Math.max(l,a.y[_].data.length);if(this.options.xAxis=this.options.xAxis||{},i.xAxis){if("date"===t&&o!==n.Scatter){var b=r.getGranularity(a,l),x=b.tickInterval,C=b.granularity||"day",w=b.granularity_name||"",k=i.xAxis[0].month_start_day||0,A=a.x[0].data,S=A[A.length-1]-A[0];C=r.setGranularityByDate(C,S),$.extend(!0,this.options,{xAxis:{type:"datetime",labels:{formatter:function(){var t=this.value;if("week"===C){k=1,w&&(k=i.xAxis[0].week_start_day_of_week);var e=new Date(t).getDay();e>k?t-=864e5*(e-k):t+=864e5*(k-e)}return r.checkGranularity(C,t,w,k)}},tickPixelInterval:120,minTickInterval:x}}),o===n.Radar&&(this.options.xAxis.tickPositioner=function(){return a.x[0].data})}else"sub_date"===t?(C=a.x[0].fid.split("_")[1],$.extend(!0,this.options,{xAxis:{labels:{formatter:function(){return e.helper.subDateFormat(C,this.value)}}}}),this.options.xAxis.type="category",this.options.xAxis.minTickInterval=void 0):("string"===t||"number"===t)&&(this.options.xAxis.type="category",this.options.xAxis.minTickInterval=void 0,$.extend(!0,this.options,{xAxis:{labels:{formatter:function(){var t=this.value,e=t.length>25?t.substring(0,25)+"...":t;return e}}}}));if((o===n.Bar||o===n.NStackBar||o===n.PStackBar)&&$.extend(!0,this.options,{xAxis:{labels:{x:-5,y:4},tickPixelInterval:10}}),2===i.xAxis.length){var D=[n.Column,n.NStackColumn,n.PStackColumn,n.Bar,n.NStackBar,n.PStackBar,n.Line,n.Waterfall].indexOf(o)>-1;if(D){var M=[],T={},L=a.x[0],E=a.x[1],O=[],P={},F=this,N="dark"===this.theme?"rgba(81, 130, 228, .12)":"rgba(232, 235, 237, .6)";L.data.forEach(function(t,e){t=F._formatXAxisLabel(t,0),P.name!==t&&(void 0!==P.from&&(P.to=e-.5,O.push(P)),P={name:t,color:O.length%2==0?N:null,from:e-.5,to:e-.5}),e===L.data.length-1&&(P.to=e+.5,O.push(P)),T.name!==t&&(T={name:t,categories:[]},M.push(T));var a=F._formatXAxisLabel(E.data[e],1);T.categories.push(a)}),$.extend(!0,this.options.xAxis,{type:"category",categories:M,plotBands:O,minTickInterval:void 0,tickColor:"dark"===this.theme?"rgba(255, 255, 255, .1)":"rgba(0, 0, 0, .1)",tickWidth:1,labels:{autoRotation:[-90],formatter:function(){var t=this.value,e=t.length>25?t.substring(0,25)+"...":t;return e}}})}}}}},_formatTimeWithField:function(t,e,a){if(t=+t,isNaN(t))return"NaN";var i=e.granularity||"day",n=e.granularityName||"",o=e.month_start_day||0;if(("hour"===i||"minute"===i||"second"===i)&&(i="g_"+i),"week"===i){o=1,n&&(o=e.week_start_day_of_week);var l=new Date(t).getDay();l>o?t-=864e5*(l-o):t+=864e5*(o-l)}return r.checkGranularity(i,t,n,o,a)},_formatXAxisLabel:function(t,a,i){var n=this.data,o=this.info,l=o.xAxis[a];if(l&&"date"===l.data_type){var s=n.x[a].data,d=r.getGranularity(n,s.length,a),h=(d.tickInterval,d.granularity||"day"),c=d.granularity_name||"",p=o.xAxis[a].month_start_day||0,u=s[s.length-1]-s[0];if(i?("hour"===h||"minute"===h||"second"===h)&&(h="g_"+h):h=r.setGranularityByDate(h,u),"week"===h){p=1,c&&(p=l.week_start_day_of_week);var f=new Date(t).getDay();f>p?t-=864e5*(f-p):t+=864e5*(p-f)}return r.checkGranularity(h,t,c,p)}if(l&&"sub_date"===l.data_type){var h=l.fid.split("_")[1];return e.helper.subDateFormat(h,t)}return t},_getYAxisLabelEdgeValue:function(t,e,a,i){var o=t===n.NStackColumn||t===n.NStackBar||t===n.NStackArea;return o?r.getSumByColumnFromMultiArray(this.data,e,a,i):Math[a](0,r.getEdgeValueFromMultiArray(this.data,"y_optional"===e?e:"",a,t,i))},_setYaxisLabel:function(){function t(t,e,l){l=l||[],t="right"===t?"_"+t:t;var d,h,c=t?"y_optional":"y",p=r.getPositiveOrNegative(a,c,l),u=0,f=0,m=e===n.PStackColumn||e===n.PStackBar||e===n.PStackArea,g=(e===n.NStackColumn||e===n.NStackBar||e===n.NStackArea,e===n.Scatter);if(m)"mix"===p?(u=100,f=-100):"negative"===p?(u=0,f=-100):"positive"===p&&(u=100,f=0);else if(g){if(a.y[1]&&a.y[1].data.length){var y=Math.max.apply(Math,a.y[1].data),v=Math.min.apply(Math,a.y[1].data);0>y*v?(i.yaxis_max_disabled?(d=Math.max.apply(Math,a.y[1].data),u=r.formatNumber(y)):(d=i.yaxis_max,u=d),i.yaxis_min_disabled?(h=Math.min.apply(Math,a.y[1].data),f=r.formatNumber(v)):(h=i.yaxis_min,f=h)):(i.yaxis_max_disabled?(d=Math.max.apply(Math,a.y[1].data),u=r.formatNumber(y),u=Math.max(0,u)):(d=i.yaxis_max,u=d),i.yaxis_min_disabled?(h=Math.min.apply(Math,a.y[1].data),f=r.formatNumber(v),f=Math.min(0,f)):(h=i.yaxis_min,f=h)),$.cookie("yaxis_min"+t,h),$.cookie("yaxis_max"+t,d)}}else{if(e===n.Waterfall&&(i.yaxis_max_disabled=!0,i.yaxis_min_disabled=!0),"mix"===p){var _=t?i.yaxis_max_disabled_right:i.yaxis_max_disabled,b=t?i.yaxis_min_disabled_right:i.yaxis_min_disabled,x=t?i.yaxis_max_right:i.yaxis_max,C=t?i.yaxis_min_right:i.yaxis_min;_?(d=o._getYAxisLabelEdgeValue(e,c,"max",l),u=r.formatNumber(d)):(d=x,u=d),b?(h=o._getYAxisLabelEdgeValue(e,c,"min",l),f=r.formatNumber(h)):(h=C,f=h)}else"positive"==p?(h=0,d=o._getYAxisLabelEdgeValue(e,c,"max",l),u=r.formatNumber(d)):"negative"==p&&(d=0,h=o._getYAxisLabelEdgeValue(e,c,"min",l),f=r.formatNumber(h)),!s["yaxis_max_disabled"+t]&&s["yaxis_max"+t]&&(u=Number(s["yaxis_max"+t]||i["yaxis_max"+t])),!s["yaxis_min_disabled"+t]&&s["yaxis_min"+t]&&(f=Number(s["yaxis_min"+t]||i["yaxis_min"+t]));$.cookie("yaxis_max"+t,d),$.cookie("yaxis_min"+t,h)}return{max:u,min:f,origin_max:d,origin_min:h}}function e(e,l,s){l="right"===l?"_"+l:l;var d={reversed:!1,title:{text:""},gridLineWidth:0,opposite:l?!0:!1,labels:{enabled:!o.isDashboardMode||o.isDashboardMode&&o.dash_setting.show_axis,formatter:function(){return r.checkPercentLabel(this,a,s,l)}}},h=s===n.PStackColumn||s===n.PStackBar||s===n.PStackArea,c=h?1:1.2,p=function(){var e,a,n,d,p=o.theme,u=o.mode.split("*"),f=(u[0]>>>0,u[1]>>>0),m="dark"===p&&4>f&&"fullscreen"!==o.mode?2:4,g=[],y=[],v=o._isStackChart();if(this.series){var _=this.series.length;this.series.forEach(function(t,e){if(t.visible===!1){var a=v?_-e-1:e;y.push(a)}})}var b=t(l,s,y);if(a=b.min,e=b.max,0>a*e){var x=l?i.yaxis_max_disabled_right:i.yaxis_max_disabled,C=l?i.yaxis_min_disabled_right:i.yaxis_min_disabled;if(x&&C){var w=Math.abs(e),k=Math.abs(a),A=w>k?1:-1,S=A>0?w:k,D=0>A?w:k;if(S>=3*D){if(S=r.formatNumber(Math.max(Math.abs(b.origin_max*c),Math.abs(b.origin_min*c)),3),n=Number(S.div(3).toFixed(6)),!n)return;d=isInteger(n)?0:n.toString().split(".")[1].length;for(var $=0;S>=$;$=Number($.add(n).toFixed(d)))g.push(A>0?d?Number($.toFixed(Math.min(d,6))):$:d?0===$?0:-Number($.toFixed(Math.min(d,6))):0===$?0:-$);return g.length<m&&g.push(A*$),g.push(Number((-A*n).toFixed(d))),g.sort(function(t,e){return t-e})}e=r.formatNumber(S*c),a=r.formatNumber(-S*c)}}else if(!h){var x=l?i.yaxis_max_disabled_right:i.yaxis_max_disabled,C=l?i.yaxis_min_disabled_right:i.yaxis_min_disabled;x&&C&&(a=r.formatNumber(b.origin_min*c),e=r.formatNumber(b.origin_max*c))}if(n=Number(e.sub(a).div(m).toFixed(6))){d=isInteger(n)?0:n.toString().split(".")[1].length;for(var $=a;e>=$;$=Number($.add(n).toFixed(d)))g.push(d?Number($.toFixed(Math.min(d,6))):$);return g.length<m+1&&g.push($),g}};if(e.max*e.min>=0&&e.max===e.min)return d;var u=i.chart_type===n.Scatter;return u&&i.yaxis_min_disabled&&i.yaxis_max_disabled||(d.tickPositioner=p),d}var a=this.data,i=this.info;this.options.yAxis=[];var o=this,l=this.getChartType(),s=i;if(i.chart_type===n.Biax)i.yAxis.length&&(this.options.yAxis[0]=r.checkIsAllDataNull(a,"y")?{reversed:!1,title:{text:""},gridLineWidth:0,opposite:!1,labels:{enabled:!o.isDashboardMode||o.isDashboardMode&&o.dash_setting.show_axis,formatter:function(){return r.checkPercentLabel(this,a,i.type_optional[0])}},tickPositioner:function(){return[0,1,2,3,4]}}:e(t("",i.type_optional[0]),"",i.type_optional[0])),i.yAxisOptional.length&&(this.options.yAxis[1]=r.checkIsAllDataNull(a,"y_optional")?{reversed:!1,title:{text:""},gridLineWidth:0,opposite:!0,labels:{enabled:!o.isDashboardMode||o.isDashboardMode&&o.dash_setting.show_axis,formatter:function(){return r.checkPercentLabel(this,a,i.type_optional[1],"right")}},tickPositioner:function(){return[0,1,2,3,4]}}:e(t("right",i.type_optional[1]),"right",i.type_optional[1]));else if(i.chart_type!==n.Gauge&&i.yAxis.length){if(0===i.compare_axis.length&&r.checkIsAllDataNull(a,"y"))return void(this.options.yAxis[0]?this.options.yAxis[0].gridLineWidth=0:this.options.yAxis[0]={gridLineWidth:0});this.options.yAxis[0]=e(t("",l),"",l)}[n.Line,n.Column,n.Bar,n.NStackColumn,n.PStackColumn,n.NStackBar,n.PStackBar].indexOf(i.chart_type)>-1&&"dark"===this.theme&&(this.options.yAxis[0].gridLineWidth=1,this.options.yAxis[0].gridLineColor="rgba(255, 255, 255, .06)")},_setYaxisTitle:function(){var t=this,e=this.info,a=e.yaxis_name,i=e.yaxis_unit||"";if(a||(a=this.getChartType()===n.Scatter?this.data.y[1]?this.data.y[1].name:"":this.data.y[0]?this.data.y[0].name:""),e.yAxis.length>0&&(!this.isDashboardMode||this.gridWidth>3)){var r=$.extend(!0,this.options,{yAxis:[{title:{text:!t.isDashboardMode||t.isDashboardMode&&t.dash_setting.show_axis?i?a+" ("+i+")":a:""}}]});if(e.chart_type===n.Biax&&r.yAxis[1]){var o=e.yaxis_name_right,l=e.yaxis_unit_right||"";o||(o=this.data.y_optional.length?this.data.y_optional[0].name:""),r.yAxis[1].title.text=!t.isDashboardMode||t.isDashboardMode&&t.dash_setting.show_axis?""==l?o:o+" ("+l+")":""}}else{var s=[{title:{text:""}}];e.chart_type===n.Biax&&s.push({title:{text:""}}),$.extend(!0,this.options,{yAxis:s})}},_setChartData:function(){var t=this,e=this.getChartType(),a=this.data,i=this.info,r=a.x.length,o=a.y.length,l=a.y_optional.length;if(e!==n.Scatter&&e!==n.TreeMap){if(e===n.Area&&!this.isSplitChart()){var s=[],d=[],h=[],c=[];a.y.forEach(function(t,e){s[e]=[t.data.reduce(function(t,e){return Math.abs(t)+Math.abs(e)},0),e]});for(var p=s.concat().stableSort(function(t,e){return e[0]-t[0]}),u=0;o>u;u++)d.push(a.y[p[u][1]]),i.y[p[u][1]]&&(h.push(i.y[p[u][1]]),c.push(i.yAxis[p[u][1]]));a.y=d,i.y=h,i.yAxis=c}if(0!==r||0===o&&0===l){if(this._setSeries(0),this.options.series=this.reverseStackChartData(),i.chart_type===n.Biax){this._setSeries(1);var f=0,m=0;if(1===i.xAxis.length&&"date"===i.xAxis[0].data_type){var g=i.xAxis[0].granularity,y={second:1e3,minute:6e4,hour:36e5,day:864e5,week:6048e5,month:26784e5,quarter:79488e5,year:316224e5};m=this.chartData.x[0].data.length;for(var v=m-1;v>0;v--){var _=v-1,b=this.chartData.x[0].data[v]-this.chartData.x[0].data[_];if(b>y[g]){for(var x=0;x<this.chartData.y.length;x++)this.chartData.y[x].data.splice(v,0,[this.chartData.x[0].data[v]-y[g],null]);for(var C=0;C<this.chartData.y_optional.length;C++)this.chartData.y_optional[C].data.splice(v,0,[this.chartData.x[0].data[v]-y[g],null]);f++}}}this.options.series=this.chartData.y.concat(this.chartData.y_optional),this.options.series[0]&&m+f>t.maxDataLen&&this.options.series.forEach(function(e){e.data.splice(0,m+f-t.maxDataLen)})}}else{if(e===n.Pie)return;if(e===n.Radar){if(o.length<3)return!1;var w=[],k=[];if(i.compare_axis.length){var A={},S={};angular.forEach(a.y,function(t){var e=t.compare_names,a=e.slice(1).join("_");S[t.uniq_id]||(w.push(e[0]),S[t.uniq_id]=1),A[a]?A[a].data.push(1*t.data[0]):(A[a]={name:a,data:[1*t.data[0]],compare_values:t.compare_values,uniq_id:t.uniq_id},k.push(A[a]))})}else{var D=[];angular.forEach(a.y,function(t){w.push(t.name),D.push(1*t.data[0])}),k=[{data:D}]}return void $.extend(!0,this.options,{xAxis:{type:"category",categories:w},series:k})}$.extend(!0,this.options,{xAxis:{type:"category",labels:{enabled:!1}}});for(var M=0;o>M;M++)for(var T=0;T<a.y[M].data.length;T++)this.chartData.y[M].data[T]={y:1*a.y[M].data[T]};if(e===n.Biax){for(var u=0;l>u;u++)for(var L=0;L<this.chartData.y_optional[u].data.length;L++)this.chartData.y_optional[u].data[L]={y:1*this.chartData.y_optional[u].data[L]};var k=[];angular.forEach(this.chartData.y,function(t){t.type="column",t.yAxis=0,t.zIndex=1,k.push(t)}),angular.forEach(this.chartData.y_optional,function(t){t.type="line",t.yAxis=1,t.zIndex=2,k.push(t)}),this.options.series=k}else this.options.series=this.reverseStackChartData()}this._handleLineMarker(this.options.series)}},_handleLineMarker:function(t){var e=this.getChartType();[n.Line,n.Area,n.NStackArea,n.PStackArea].indexOf(e)>-1?t.forEach(function(t){var e=t.data,a=e.reduce(function(t,e){return Number(t)+Number(!!e)},0);$.extend(!0,t,{marker:{enabled:1===a?!0:!1}})
}):e===n.Biax&&t.forEach(function(t){("line"===t.type||"spline"===t.type)&&$.extend(!0,t,{marker:{enabled:!0}})})},_needSetColor:function(){return[n.Table,n.Gauge,n.Scatter,n.Waterfall].indexOf(this.info.chart_type)<0},_isSettedColor:function(){var t=this,e=t.info.yAxis,a=t.info.yAxisOptional;return[e].concat(a).some(function(t){return"undefined"!=typeof t.series_color})},_isStackChart:function(){return"C211 C212 C241 C242 C351 C352".indexOf(this.info.chart_type)>-1},reverseStackChartData:function(){return this._isStackChart()?this.chartData.y.reverse():this.chartData.y},_setSeries:function(t){var e,a,i=this.data,r=this.info,o=0===t?"y":"y_optional",l=this.getChartType(),s=[],d={};this.xMap={};var h="category"===this.options.xAxis.type?"name":"x",c=0;if("date"===i.x[0].data_type&&i.x[0].granularity_name)switch(i.x[0].granularity){case"year":c=864e5*(r.xAxis[0].year_start_month-1)*30;break;case"month":c=864e5*(r.xAxis[0].month_start_day-31);break;case"week":c=864e5*(r.xAxis[0].week_start_day_of_week-1)}i.x[0].dateTimePadding=c;for(var p=i[o]&&i[o].length>0?i[o].length*i[o][0].data.length:0,u=3e3,f=Math.ceil(p/u),m=p>u&&$.inArray(l,["C210","C211","C212","C220","C240","C214"])>-1&&f>0,g=0;g<i[o].length;g++){e=i[o][g].data,a=e.length,s=[],d={};for(var y=0;y<e.length;y++){d={},d[h]="date"===i.x[0].data_type&&i.x[0].granularity_name?i.x[0].data[y]-c:i.x[0].data[y],m&&(d.dataLabels=d.dataLabels||{},y%f!=0&&(d.dataLabels.enabled=!1)),this.xMap[d[h]]=this.origin_data.x[0].data[y];var v=e[y];if(null==v)d.y=null;else if("string"==typeof e[y]||void 0===e[y].length)d.y=null!==e[y]?1*e[y]:null;else for(var _=0;_<e[y].length;_++)d.y=null!==e[y][_]?1*e[y][_]:null;s.push(d)}this.chartData[o][g]=angular.copy(i[o][g]),this.chartData[o][g].data=s,r.chart_type===n.Biax&&(i.y.length>0||i.y_optional.length>0)&&(this.chartData[o][g].type="C220"===r.type_optional[t]?"line":"column",this.chartData[o][g].yAxis=t,this.chartData[o][g].zIndex="line"===this.chartData[o][g].type?2:1)}},_setLinkColor:function(t){var e=this,a=e.getChartType(),i=(e.info,e.data),r=e.info.chart_id,n={},o=[];if($.isArray(e.mainChartContainer)&&0==e.mainChartContainer.length&&(e.mainChartContainer=t&&t.mainChartContainer||[],e.mainChartColorContainer=t&&t.mainChartColorContainer||[]),0!=e.mainChartContainer.length){angular.forEach(e.mainChartContainer,function(t){t.ctId==r&&(n=t.pointInfo,o=t.pointData)}),e.pointData=o;var l=(n.index,n.x,n.name),s=e.options.xAxis;if("C220"===a||"C250"===a){var d=e.options.series;angular.forEach(d,function(t){angular.forEach(t.data,function(t,e){var a=[];angular.forEach(i.x,function(t){a.push(t.data[e])}),angular.equals(a,o)&&(s.plotLines=[{value:e,color:"rgba(134,139,156,0.5)",width:1,id:"chartLinkPlotLine"}])})})}else if(["pie","map"].indexOf(e.options.chart.type)>-1){var h,c=e.options.series[0].data;c.length>1&&(angular.forEach(i.x[0].data,function(t,e){t==l?h=e:angular.isNumber(e)&&(c[e].selected=!1,c[e].sliced=!1,c[e].select=!1)}),angular.isNumber(h)&&(c[h].selected=!0,c[h].sliced=!0,c[key].select=!0))}else{var d=e.options.series;angular.forEach(d,function(t){angular.forEach(t.data,function(t,e){var a=[];angular.forEach(i.x,function(t){a.push(t.data[e])}),angular.equals(a,o)||(t.color="#ccc")})})}}},_setColor:function(){var t=this.info,a=this.data,o=this.options.series,l=this.getChartType(),s=t.color_setting,d=[].concat(t.y||[],t.y_optional||[]),h=d.some(function(t){return!!t.series_color}),c=e.getColorsByType(t.chart_type,"bdp");if(($.isEmptyObject(s)||s.is_series)&&(t.yAxis.length>0||l===n.Biax)&&h){if(l===n.Pie)return;return void angular.forEach(o,function(t,e){t.color=t.series_color?t.series_color:c[e%c.length]})}if(delete s.is_series,!$.isEmptyObject(s)&&this._needSetColor())if(1!==+s.mode){c=e.colors[s.theme];var p=s.enum_color_map||null,u=null===p?[]:Object.keys(p).map(function(t){return t.split("_")}),f={count:0,posInColorField:[],posInDimension:[]};if(angular.forEach(t.xAxis,function(t,e){for(var a=0;a<s.field.length;a++)if(t.fid===s.field[a].fid){f.count++,f.posInColorField.push(a),f.posInDimension.push(e);break}}),t.xAxis.length&&f.count>0){var m=[];angular.forEach(o,function(e,i){angular.forEach(e.data,function(r,n){f.posInDimension.forEach(function(o){var l=a.x[o].data[n];if(m=[e.uniq_id.toString()].concat(r.name,null===l?null:l.toString()),t.compare_axis.length>0&&(m=m.concat(e.compare_values)),p){for(var s=0;s<u.length;s++)if(bdp.utils.isContain(m,u[s])){r.color=p[u[s].join("_")].color;break}r.color||(r.color=c[(i*e.data.length+n)%c.length])}else r.color=c[(i*e.data.length+n)%c.length]})})})}else t.compare_axis.length&&angular.forEach(o,function(t,e){var a=t.compare_values.slice().reverse();if(a.splice(-1,1,t.uniq_id.toString()),p)if(p.hasOwnProperty(a.join("_")))t.color=p[a.join("_")].color;else{var i=[t.uniq_id.toString()].concat(t.compare_values);(t.compare_values.indexOf("")>-1||t.compare_values.indexOf(null)>-1)&&(i=i.concat(["(空白)","(Blank)"]));for(var r=0;r<u.length;r++)if(bdp.utils.isContain(i,u[r])){t.color=p[u[r].join("_")].color;break}}else t.color=c[e%c.length]})}else if(1===+s.mode){var g=t.compare_axis&&t.compare_axis.length>0;if([n.Line,n.Radar,n.Area,n.NStackArea,n.PStackArea].indexOf(l)>-1){var y=this.$elem.height()-34;if(s&&s.range_color){var v,_=s.range_color.start_color,b=s.range_color.end_color;v=_==b?_:{linearGradient:[0,0,0,y],stops:[[0,b],[1,_]]},this.options.series.forEach(function(t){t.color=v})}}var x=a.colors.map(function(t){return Number(t)}),C=r.linearRangeColor(s.range_color.start_color,s.range_color.end_color),w=r.createLinearScale(s.range_color,x),k=[],A=s.range_color.step;if(A>1){for(i=0;A-1>i;i++)k.push(C(i/(A-1)));k.push(C(1))}angular.forEach(o,function(t,e){g&&(x=a.colors[e%a.colors.length].map(function(t){return Number(t)}),w=r.createLinearScale(s.range_color,x)),angular.forEach(t.data,function(t,e){var a=x[e],i=w(a);if(A){var r=Math.floor(A*i);r=Math.min(r,A-1),t.color=k[r]}else t.color=C(i)})})}},_setGuideLine:function(){var t=this,e=this.info.drill_level,a=this.getChartType(),i=this.info,o=this.options,l=this.data;if(a===n.Pie&&a===n.Table||a===n.Radar||a===n.Waterfall)return!1;var s,d,h,c=o.yAxis[0].tickPositioner?o.yAxis[0].tickPositioner():[],p=[],u=o.yAxis[1]&&o.yAxis[1].tickPositioner?o.yAxis[1].tickPositioner():[],f=12,m=10,g=f*m,y="#8FC2EC",v="dark"===this.theme?"#EE4B4B":"#D0021B",_=1,b=3,x=[],C=[],w=[],k=!(a!==n.Bar&&a!==n.NStackBar&&a!==n.PStackBar);s=l.guide_line||[],d=l.guide_line_right||[],h=l.guide_line_x||[],x=o.yAxis[0].plotLines||[],C=o.xAxis.plotLines[0]||[];var A=function(t){if(t){for(var e=0;e<t.length;e++)if(0===+t[e])return!0;return!1}},S=function(e,a){var i=[{color:t.deviceStyle.xAxis?t.deviceStyle.xAxis.lineColor:"dark"===t.theme?"rgba(255, 255, 255, .06)":"#ccc",width:1,value:0}];if(!e){var r;r="dark"===this.theme?{text:"",style:{color:"#fff"},align:"left",x:-22,y:3}:{text:"",align:"left",x:-22,y:5},"right"===a&&(r.align="right",r.x=-r.x),i[0].label=r}return i};if(x.length&&0===+x[0].value)x=x.slice(0,1);else{var D=i.chart_type===n.Scatter&&!$.isEmptyObject(i.bubble_setting);a===n.Gauge||D?x=[]:(x=S(A(c),"left"),w=S(A(u),"right"))}"fullscreen"===this.mode&&(f=13,g=f*m,y="dark"===this.theme?"rgba(255,255,255,.3)":"rgba(0,0,0,.3)",_=2,b=4),angular.forEach(s,function(t){angular.forEach(l.y,function(e){t.fid===e.fid&&(t.formatter=e.formatter)})});var M=function(t,e,i,o){if(o){for(var l,s=50*f,d={},h=0,c=0;c<o.length;c++)h=Math.max(h,isInteger(o[c])?0:o[c].toString().split(".")[1].length);angular.forEach(e,function(e){var o=hz.cutString.cutStr(e.name,s+1,!1,f),h=hz.cutString.getP(o,f);d={width:Math.min(h,g),height:16*Math.ceil(h/g),top:16*-Math.ceil(h/g)-20};var c=e.value;e.formatter&&"percent"===e.formatter.check?c=Highcharts.numberFormat(100*c,e.formatter.percent.digit)+"%":(l=isInteger(e.value)?0:e.value.toString().split(".")[1].length,c=e.vale<1e3?r.numericSymbols(e.value,Math.min(4,l)):r.numericSymbolsWithDigit(e.value));var p=Math.ceil(hz.cutString.getP(c.toString(),f)),u=12;e.value>1e3&&(u=15),p=k?-.5*(p+u):-(p+u),i.push({color:y,dashStyle:"dash",value:e.value,width:_,zIndex:4,label:{text:'<span class="guide-label-'+t+" "+k+'">'+c+'<span class="guide-label-text" style="width:'+d.width+"px;height:"+d.height+"px;top:"+d.top+'px;">'+o+"</span></span>",align:t,verticalAlign:"bottom",x:"left"===t?k?p+6:p:-p,y:k?"left"===t?b+16:b-6:b,rotation:0,style:{color:"#fff",fontSize:f+"px",display:a===n.Gauge?"none":"block"},useHTML:!0}})})}};i.chart_type===n.Scatter&&M("left",h,C,p),M("left",s,x,c),d&&d.length>0&&(angular.forEach(d,function(t){angular.forEach(l.y_optional,function(e){t.fid===e.fid&&(t.formatter=e.formatter)})}),M("right",d,w,u)),!e&&[n.PStackColumn,n.PStackBar,n.PStackArea,n.Waterfall].indexOf(a)<0&&(angular.forEach(i.warn_info,function(t){0===Number(t.axis_type)?angular.forEach(l.y,function(e){t.field_id===e.fid&&(t.formatter=e.formatter)}):angular.forEach(l.y_optional,function(e){t.field_id===e.fid&&(t.formatter=e.formatter)})}),angular.forEach(i.warn_info,function(t){t.switch&&angular.forEach(t.meta.option,function(e){if(7===Number(e.compare_type))angular.forEach(e.compare_value,function(i,o){var l=e.compare_value[o];l=t.formatter&&"percent"===t.formatter.check?Highcharts.numberFormat(100*l,Number(t.formatter.percent.digit))+"%":r.numericSymbols(l);var s=hz.cutString.getP(l.toString(),f),d=24;e.compare_value[o]>1e3&&(d=27),s=k?-.6*(s+d):-(s+d),0===+t.axis_type?x.push({value:e.compare_value[o],width:_,color:v,zIndex:5,label:{text:'<span class="warn-label-left">'+l+"</span>",align:"left",verticalAlign:"bottom",x:k?s+10:s,y:k?b+18:b,rotation:0,style:{color:v,fontSize:f+"px",display:a===n.Gauge?"none":"block"},useHTML:!0}}):w.push({value:e.compare_value[o],width:_,color:v,zIndex:5,label:{text:'<span class="warn-label-right">'+l+"</span>",align:"right",x:-s,y:k?b-6:b,rotation:0,style:{color:v,fontSize:f+"px"},useHTML:!0}})});else{var i=e.compare_value;i=t.formatter&&"percent"===t.formatter.check?Highcharts.numberFormat(100*i,Number(t.formatter.percent.digit))+"%":r.numericSymbols(i);var o=hz.cutString.getP(i.toString(),f),l=24;e.compare_value>1e3&&(l=27),o=k?-.6*(o+l):-(o+l),0===Number(t.axis_type)?x.push({value:e.compare_value,width:_,color:v,zIndex:5,label:{text:'<span class="warn-label-left">'+i+"</span>",align:"left",verticalAlign:"bottom",x:k?o+10:o,y:k?b+18:b,rotation:0,style:{color:v,fontSize:f+"px",display:a===n.Gauge?"none":"block"},useHTML:!0}}):w.push({value:e.compare_value,width:_,color:v,zIndex:5,label:{text:'<span class="warn-label-right">'+i+"</span>",align:"right",x:-o,y:k?b-6:b,rotation:0,style:{color:v,fontSize:f+"px"},useHTML:!0}})}})})),(s.length||d&&d.length)&&(o.legend&&o.legend.enabled!==!1?o.legend.margin=Math.max(o.legend.margin||0,5):o.chart.marginRight=Math.max(o.chart.marginRight||0,10)),angular.isArray(o.yAxis)?(o.yAxis[0].plotLines=x,i.chart_type===n.Biax&&o.yAxis[1]&&(o.yAxis[1].plotLines=w)):o.yAxis.plotLines=x,i.chart_type===n.Scatter&&(o.xAxis.plotLines=C)},_setXaxisPlotLines:function(){var t=this.info,e=this.data,a=t.xAxis[0];if(a&&"date"===a.data_type){var i=a.granularity,n=this.options,o=new Date(e.x[0].data[0]),l=new Date(e.x[0].data[e.x[0].data.length-1]),s=r.getTimeZoneOffset(),d={year:o.getFullYear(),month:o.getMonth()},h={year:l.getFullYear(),month:l.getMonth()};if(d.year===h.year&&d.month===h.month||"year"===i)return;if("day"===i)for(var c=d.year;c<=h.year;c++)for(var p=0;12>p;p++)n.xAxis.plotLines.push({dashStyle:"ShortDash",color:"#CCC",width:1,value:Date.UTC(c,p,1)+3600*s*1e3});else for(var u=d.year;u<=h.year;u++)n.xAxis.plotLines.push({dashStyle:"ShortDash",color:"#CCC",width:1,value:Date.UTC(u,0,1)+3600*s*1e3})}},canDrawMarkPoint:function(){return"C210 C211 C212 C220 C240 C241 C242 C250 C320 C350 C351 C352".indexOf(this.getChartType())>-1},translateMarkPoint:function(){var t=this.info.field_comment;if($.isEmptyObject(t)||0===this.data.x.length||!this.canDrawMarkPoint())return this.markPoints=[];var e=[],a=this.data.x[0].data,i=this.info.yAxis.concat(this.info.yAxisOptional),r=this.data.x[0].data_type;return angular.forEach(t,function(t){for(var n=0,o=i.length;o>n;n++){var l=t.xaxis_value;("date"===r||"sub_date"===r)&&(l=Number(l));var s=angular.indexOf(a,l),d=i[n].uniq_id+"";if(i[n].fid===t.yaxis_id&&d==t.yaxis_uniq_id&&s>-1){e.push(angular.extend(t,{seriesIndex:n,xDataIndex:s}));break}}}),this.markPoints=e},destroy:function(){if(!this.$elem)return!0;this.chartInstance=null;var t=this.$elem.data("chart-data"),e=this.$elem.highcharts();this.$elem.removeClass("bdp-chart-loaded bdp-chart-loading bdp-chart-error");var a=t&&t.info?t.info.chart_type:"";if(e&&"function"==typeof e.destroy)[n.AreaMap,n.BubbleMap].indexOf(a)>-1&&this.$elem.removeClass("chart-map"),e.destroy(),a===n.Gauge&&this.$elem.find(".solidgauge-title").remove();else if(n.Table===a||n.KPICard===a)this.$elem.off("click"),this.$elem.html("");else if("C300 C330 C360".indexOf(a)>-1){var i=d3.selectAll(this.$elem.toArray());i.selectAll("svg").remove(),i.selectAll("*").remove(),i.text("")}else n.GIS===a?(this.gisMap&&this.gisMap.clear(),this.$elem.removeClass("chart-gis"),this.$elem.empty(),this.$elem.css("backgroundColor",""),delete this.gisMap):n.WordCloud.indexOf(a)>-1?(this.$elem.off("mouseleave"),this.$elem.find("canvas").off("mousemove"),this.$elem.html("")):a===n.Pie?"donut"===t.info.shape&&this.$elem.find(".pie-center-txt").remove():a===n.TreeMap}},e.Events.mixTo(a),e.Chart=a}(window,bdpChart),!function(t,e){function a(a){if(t.localStorage){var i=t.localStorage.getItem("BDP_hasShowAltGuide")||!1;if(!i&&!a.$elem.find(".alt-guide").length){var r=$("<div>").addClass("alt-guide"),n="zh"==e.language?"按住<strong>Alt</strong>键显示全部选中项的标签":"Hold<strong>Alt</strong>to show all selected labels";r.html(n),a.$elem.append(r)}}}function i(t,e,a){e.find("ul.bdp-legend").remove();var i=$("<ul>").addClass("bdp-legend").css({position:"absolute",top:parseInt(e.css("padding-top"))+5+"px",left:parseInt(e.css("padding-left"))+5+"px","z-index":2,width:e.width()-10,"text-align":"left"});return t.forEach(function(t){var e=$("<li>").css({display:"inline-block","margin-right":"20px",cursor:"pointer"}).addClass("bdp-legend-item"),a=$("<i>").css({display:"inline-block",background:t.color,width:"6px",height:"6px","border-radius":"50%",verticalAlign:"middle","margin-right":"3px"}),r=$("<span>").text(t.text);e.append(a).append(r),i.append(e)}),e.append(i),i.on("click","li.bdp-legend-item",function(){var t=$(this).index();$(this).hasClass("disabled")?$(this).css("opacity","1"):$(this).css("opacity",".5"),$(this).toggleClass("disabled"),a.chartInstances.forEach(function(e){var a=e.series[t];a.hoverPoint&&a.hoverPoint.setState(),a.setVisible(!a.visible)})}),i}var r=e.Chart,n=e.ChartType,o=!1;$(t).on("keydown",function(e){if(e.altKey){if(o=!0,t._interectingChart){var a=t._interectingChart.chartInstances,i=t._interectingChart;a.forEach(function(t){if(t!=i._interectingSubChart){var e=t.series.map(function(t){return t.hoverPoint});e&&(e=e.filter(function(t){return t&&!t.isNull}),e.length&&t.tooltip.refresh(e))}})}if(t.localStorage){var r=t.localStorage.getItem("BDP_hasShowAltGuide")||!1;r||(t.localStorage.setItem("BDP_hasShowAltGuide",1),$("body").find(".chart .alt-guide").remove())}}else o=!1}),$(t).on("keyup",function(){if(o&&(o=!1,t._interectingChart)){var e=t._interectingChart;e.chartInstances.forEach(function(t){t!=e._interectingSubChart&&t.tooltip.hide()})}}),r.prototype.isSplitChart=function(){var t=this.getChartType(),e=[n.Line,n.Column,n.Bar,n.Area].indexOf(t)>=0&&this.info.compare_axis.length&&this.info.split_compare||t==n.Gauge&&this.info.compare_axis.length;return e},r.prototype.renderChartInSplitMode=function(t){this.chartInstances&&this.chartInstances.length&&(this.chartInstances.forEach(function(t){t.destroy()}),this.$elem.off("click",".load-more"),this.$elem.html(""));var a=[];this.chartInstances=a,this._visibleSubChartsCount=0;var r=(this.info.yAxis,this),o=r.getChartType();if([n.Gauge,n.KPICard].indexOf(o)<0){var l=[];this.info.yAxis.forEach(function(e,a){e&&e.name&&l.push({text:e.name,color:e.series_color||t.colors[a%t.colors.length]})}),i(l,this.$elem,this)}var s=this._getGridSetting(),d=s.rows,h=s.cols,c=s.splitCount;if(s.offset,s.boxWidth,s.boxHeight,c>d*h){this.$elem.css({"overflow-y":"auto","overflow-x":"hidden"}),c=d*h;var p=("zh"==e.language?"加载更多":"Load more")+"...";this.$elem.append("<div class='load-more' style='position: absolute; line-height: 30px; height: 30px; text-align: center; width: "+this.$elem.width()+"px;'>"+p+"</div>"),this.$elem.on("click",".load-more",function(){r.renderSubCharts(t)})}this._allSeries=t.series,this.renderSubCharts(t)},r.prototype.renderSubCharts=function(i){var r=this.chartInstances,l=this.info.yAxis,s=this._getGridSetting(),d=s.rows,h=s.cols,c=Math.min(s.splitCount-this._visibleSubChartsCount,d*h),p=s.offset,u=s.boxWidth,f=s.boxHeight,m=this,g=this.data;if(!(0>=c)){for(var y=this._visibleSubChartsCount;y<c+this._visibleSubChartsCount;y++){var v=$("<div>"),_={left:u*(y%h)+p.left,top:f*parseInt(y/h)+p.top};v.css({position:"absolute",left:_.left+"px",top:_.top+"px",width:u,height:f}),y==s.splitCount-1&&v.css("margin-bottom",this.$elem.css("padding-bottom")),this.$elem.append(v),i.series=null;var b=angular.copy(i);if(i.series=this._allSeries,this.data.guide_line&&(this.data.guide_line.forEach(function(t){"calculate"===t.value_type&&(t.value=t.values[y])}),this._setGuideLine()),this.getChartType()==n.Gauge){b.yAxis[y].plotLines=i.yAxis[0].plotLines,b.yAxis=[b.yAxis[y],{lineWidth:0}],b.series=[this._allSeries[y]];var x=b.series[0].data[0],C='<div class="solidgauge-title"><p class="unit">'+e.helper.dataLabelFormatter(g.y[0].formatter,x,g.y[0].aggregator)+'</p><p class="title" >'+this.data.y[y].compare_names.slice(1).join("_")+'</p><p class="title" >'+this.data.y[0].name+"</p></div>";b.title={text:C,floating:!0,y:.05*f}}else{for(var w=[],k=this._allSeries.length/l.length,A=0;A<l.length;A++)w.push(this._allSeries[y+A*k]);b.series=w;var S=this.data.y[y].compare_names.slice(1).join("_");$.extend(!0,b,{title:{text:S,align:"center",style:{height:"22px"}},legend:{enabled:!1},yAxis:[{plotLines:i.yAxis[0].plotLines}],plotOptions:{series:{stickyTracking:!0,events:{mouseOut:function(){var e=this.chart;this.chart.hoverPoint&&""==this.chart.hoverPoint.state&&(r.forEach(function(t){t!=e&&(t.series.forEach(function(t){t.hoverPoint&&t.hoverPoint.setState(),t.hoverPoint=null}),t.tooltip.hide())}),m._interectingSubChart=null,t._interectingChart=null,m._triggerPointIndex=-1,m.$elem.find(".alt-guide").hide())},mouseOver:function(){m.$elem.find(".alt-guide").show()}},point:{events:{mouseOver:function(e){var i=this.index;if(this.series.index,e&&m._triggerPointIndex!==i){var n=this.series.chart;m._interectingSubChart=n,t._interectingChart=m,m._triggerPointIndex=i,r.forEach(function(t){t!=n&&t.series.forEach(function(e){var a=e.points[i];if(e.hoverPoint&&e.hoverPoint.setState(),a.setState("hover"),e.hoverPoint=a,o){var r=t.series.map(function(t){return t.points[i]});r&&(r=r.filter(function(t){return t&&!t.isNull}),r.length?t.tooltip.refresh(r):(t.tooltip.hide(),e.hoverPoint=null))}})}),a(m)}}}}}}})}v.highcharts(b),r.push(v.highcharts())}this._visibleSubChartsCount+=c,this._visibleSubChartsCount>=s.splitCount?(this.$elem.find(".load-more").remove(),this.$elem.off("click",".load-more"),i=null,this.$elem.find("")):this.$elem.find(".load-more").css({top:f*Math.ceil(this._visibleSubChartsCount/h)+p.top})}},r.prototype._getGridSetting=function(){var t,e=this.info.yAxis,a=this.data.y.length/e.length,i=20,r=this.getChartType();(r==n.Gauge||r==n.KPICard)&&(a=this.data.y.length,i=0);var o,l;this.info.split_compare_setting?(o=this.info.split_compare_setting.rows,l=this.info.split_compare_setting.cols):o=l=a>16?4:Math.ceil(Math.sqrt(a)),t=a>o*l?30:0;var s=a>o*l&&this.isDashboardMode?this.$elem.width()-15:this.$elem.width();return{rows:o,cols:l,boxWidth:s/l,boxHeight:(this.$elem.height()-i-t)/o,offset:{left:parseInt(this.$elem.css("padding-left")),top:parseInt(this.$elem.css("padding-top"))+i},splitCount:a}}}(window,bdpChart),!function(t,e){var a=(e.helper,e.ChartType,e.Chart),i={dark:{title:{style:{color:"rgba(255, 255, 255, 0.5)"}},xAxis:{title:{style:{color:"rgba(255, 255, 255, 0.5)"}},labels:{style:{color:"rgba(255, 255, 255, 0.5)"}},lineColor:"rgba(255, 255, 255, 0.1)"},yAxis:[{title:{style:{color:"rgba(255, 255, 255, 0.5)"}},labels:{style:{color:"rgba(255, 255, 255, 0.5)"}}}],legend:{itemStyle:{color:"#fff"}},tooltip:{backgroundColor:"none",borderWidth:0,style:{padding:0}}},"default":{}},r={"default":{pc:{bg:"#fff"},projector:{bg:"#fff",xAxis:{title:{style:{color:"rgba(0, 0, 0, 0.8)"}},labels:{style:{color:"rgba(0, 0, 0, 0.8)"}},lineColor:"rgba(0, 0, 0, 0.1)"},yAxis:[{title:{style:{color:"rgba(0, 0, 0, 0.8)"}},labels:{style:{color:"rgba(0, 0, 0, 0.8)"}}}],legend:{itemStyle:{color:"rgba(0, 0, 0, 0.6)"}},plotOptions:{map:{nullColor:"#DCDEE0",dataLabels:{style:{color:"rgba(0, 0, 0, 0.8)"}}}}},tv:{bg:"#fff",xAxis:{title:{style:{color:"rgba(0,0,0,0.8)"}},labels:{style:{color:"rgba(0,0,0,0.8)"}},lineColor:"rgba(0, 0, 0, 0.05)"},yAxis:[{title:{style:{color:"rgba(0,0,0,0.8)"}},labels:{style:{color:"rgba(0,0,0,0.8)"}}}],plotOptions:{map:{dataLabels:{style:{color:"gba(0, 0, 0, 0.8)"}}}}}},dark:{pc:{bg:"#24273E"},projector:{bg:"#1a1d29",xAxis:{title:{style:{color:"rgba(255, 255, 255, .8)"}},labels:{style:{color:"rgba(255, 255, 255, .8)"}},lineColor:"rgba(255, 255, 255, 0.3)"},yAxis:[{title:{style:{color:"rgba(255, 255, 255, .8)"}},labels:{style:{color:"rgba(285, 255, 255, .8)"}}}],plotOptions:{map:{nullColor:"rgba(0, 0, 0, .4)",dataLabels:{style:{color:"rgba(255, 255, 255, .8)"}}}}},tv:{bg:"#000000",xAxis:{title:{style:{color:"rgba(255, 255, 255, .5)"}},labels:{style:{color:"rgba(255, 255, 255, .5)"}},lineColor:"rgba(255, 255, 255, 0.3)"},yAxis:[{title:{style:{color:"rgba(255, 255, 255, .5)"}},labels:{style:{color:"rgba(255, 255, 255, .5)"}}}],plotOptions:{map:{nullColor:"rgba(255, 255, 255, .05)",dataLabels:{style:{color:"rgba(255, 255, 255, .8)"}}}}}}};a.prototype.setDisplayStyle=function(t,e,a){(this.displayDevice!==t||this.theme!==e)&&(this.theme=e,this.themeColor=i[e],this.displayDevice=t,this.deviceStyle=r[e][t],this.info&&(this.destroy(),this.renderChart(a)))},a.prototype.setDisplayDevice=function(t,e){this.setDisplayStyle(t,this.theme,e)},a.prototype.setTheme=function(t,e){this.setDisplayStyle(this.device,t,e)},e.themeColors=i,e.deviceStyles=r}(window,bdpChart),!function(){var t={font_family:'"Avenir", "wf_SegoeUI", "Segoe UI", "Segoe", "Segoe WP", "Tahoma", "Verdana", "Arial", "sans-serif"',date_format:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%Y年%b月%e日"}};Highcharts.setOptions({global:{useUTC:!1},lang:{contextButtonTitle:"图表导出菜单",printChart:"打印图表",downloadJPEG:"导出为JPEG格式",downloadPDF:"导出为PDF格式",downloadPNG:"导出为PNG格式",downloadSVG:"导出SVG格式",drillUpText:"向下攥取",loading:"",shortMonths:["1","2","3","4","5","6","7","8","9","10","11","12"],months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],weekdays:["星期一","星期二","星期三","星期四","星期五","星期六","星期日"],numericSymbols:["K","M","B","T","P","E"],thousandsSep:",",resetZoom:"重置缩放",resetZoomTitle:"重置到默认级别",noData:"当前图表无数据"},chart:{backgroundColor:null,spacingTop:10,spacingLeft:1,spacingRight:0,spacingBottom:4,style:{fontFamily:t.font_family}},title:{useHTML:!0,align:"left",margin:10,style:{height:"60px",lineHeight:"20px",fontSize:"12px",color:"#333",zIndex:0},y:3},exporting:{enabled:!1,url:"/api/chart/export_png",buttons:{contextButton:{}}},legend:{layout:"vertical",align:"right",verticalAlign:"top",itemMarginBottom:0,symbolRadius:3,symbolHeight:6,symbolWidth:6,navigation:{activeColor:"#999",animation:!0,arrowSize:8,inactiveColor:"#CCC",style:{color:"#666",fontSize:"12px"}},itemStyle:{color:"#a5a5a5",fontFamily:t.font_family,fontSize:"12px",fontWeight:"normal"}},xAxis:{allowDecimals:!1,lineColor:"#ccc",labels:{style:{fontSize:"10px"}},tickLength:0},yAxis:[{title:{text:"",style:{fontSize:"10px"}},labels:{style:{fontSize:"10px"}},maxPadding:.02,gridLineWidth:0}],tooltip:{animation:!1,borderWidth:0,borderRadius:0,shadow:!1,followPointer:!0,followTouchMove:!0,shared:!0,useHTML:!0,hideDelay:0,backgroundColor:"none",style:{padding:"0px"}},plotOptions:{column:{borderWidth:0},bar:{borderWidth:0},pie:{cursor:"pointer",showInLegend:!0,dataLabels:{distance:-24,style:{color:"#fefefe",fontSize:"10px",textOutline:"1px 1px rgba(0,0,0,0.4)"},softConnector:!0},states:{hover:{halo:{size:0}}},borderWidth:0},series:{turboThreshold:1501,animation:!1}},credits:{enabled:!1}})}(),!function(t){function e(t,e){if(!Array.isArray(t))return!1;for(var a=0,i=t.length;i>a;a++)if(t[a].uniq_id==e)return!0;return!1}function a(e,a,n,l,s,d,h,c,p,u,f,_,b){return{restrict:"A",controller:"yAxisUnitController",link:function(h,u,f){function _(){h.$watch(f.bdpChart,function(e){if(e&&null==B&&(h.$bdpChart=B=new t.Chart(f.displayMode,e),B.on("data",C).on("load",function(t,e){var a=t.getChartType();[y.WordCloud,y.Sankey,y.Table].indexOf(a)<0&&(o(t,h,e,d),a!==y.KPICard&&T(e,t))}).on("redraw",function(t,e){o(t,h,e,d),t.canDrawMarkPoint()&&h.$broadcast("reflow")}).on("drilldown",function(t,e){h.inAddingMarkPoint?E(t,e):e.isLoadingData()||A(t,e)}).on("saveWithOpt",k).on("data-loading",function(){var t=u.parents("li.gridster-item");t.addClass("data-loading")}).on("data-loaded",function(){var t=u.parents("li.gridster-item");t.removeClass("data-loading")}).on("jumpToOtherDash",N),"edit"==B.mode?B.on("pointClick",function(t,e){h.inAddingMarkPoint&&E(t,e)}).on("setNickName",function(t,e){d.setNickName(t,e)}):B.isDashboardMode?(B.on("refreshLinkedCharts",F),h.$watch(function(){return f.displayMode},function(t){B.setMode(t)}),B.on("reflow",function(){e.read_cache=!1,e.optional._t=new Date})):"fullscreen"===B.mode&&B.on("reflow",function(){e.optional._t=new Date})),B){var a=!1;"fullscreen"===B.mode&&(a=h.$eval(f.autoplay)),B.draw(u,e,{},a,h,d)}},!0)}function x(){var t="%",e=100,a="50%",i=24,r=$(".J_filterWrap"),n=$(".J_filterWrap_hidden"),o=$(".J_filter",r),l=$(".J_dateGranularity",r),s=$(".J_filter_hidden",n),d=$(".J_dateGranularity_hidden",n),h=r.width(),c=h/2,p=s.width(),u=d.width()+i,f=(p+2)/h*e,m=u/h*e;r.css({visibility:"hidden"}),o.css({width:(f>100?100:f)+t}),l.css({width:(m>100?100:m)+t}),c>p&&c>u?o.css({width:a}):p>=c&&u>=c?(o.css({width:a}),l.css({width:a})):p+u>=h&&p>=c&&c>=u?o.css({width:(h-u)/h*e+t}):p+u>=h&&c>=p&&u>=c&&0!=p&&l.css({width:(h-p)/h*e+t}),r.attr("has-add-diff","true"),r.css({visibility:"visible",minWidth:"1000px"})}function C(e){function a(t){function e(t){angular.forEach(t,function(t){t.hasOwnProperty("uniq_id")?t.hasOwnProperty("aggregator")||(p[t.uniq_id]?(s[t.fid]?t.uniq_id=s[t.fid]:(t.uniq_id=h.temp_uniq_id++,s[t.fid]=t.uniq_id),p[t.uniq_id]=!0):(s[t.fid]=t.uniq_id,p[t.uniq_id]=!0)):s[t.fid]?t.uniq_id=s[t.fid]:(t.uniq_id=h.temp_uniq_id++,s[t.fid]=t.uniq_id),t.items&&t.items.length>0&&e(t.items)})}e(t)}h.selected_type=e.getChartType(),"C400"==h.selected_type&&"edit"!=e.mode&&d.global.watterMark&&bdp.utils.browser().ie&&(e.watermark={url:d.global.dshWatermarkImg,repeat:"repeat"}),h.global.watch=new Date,h.global.chartData=e.data,h.global.chartInfo=e.info;var n=e.info,o=e.data;h.drill_level=n.drill_level,h.description=n.description,h.field_comment=n.field_comment,h.right_comment=n.right_comment,h.currentLevelInnerFilter=e.info.filter_list_inner;var l;if("edit"===e.mode){"C400"!==h.selected_type&&(h.viewMeta=h.chart_ops.meta.level[n.drill_level]),h.temp_uniq_id=(new Date).getTime(),h.isGranularity=n.enable_change_granularity;var s={},p={};if(a(h.currentLevelInnerFilter),h.chart_ops.meta.filter_list_inner instanceof Array)a(h.chart_ops.meta.filter_list_inner);else if(e.info.level_fields)for(var u=e.info.level_fields.length||1,f=0;u>f;f++)a(h.chart_ops.meta.filter_list_inner[f]);if(l=h.chart_ops.meta.filter_list_inner,l=angular.copy(h.currentLevelInnerFilter),v.handler(e,l),h.currentLevelInnerFilter=l,h.$broadcast("checkChartTypeCondition",h.selected_type,""),"C340"==h.selected_type&&(h.wordCloudValues=o.x[0].data),h.selected_type!==t.ChartType.GIS){var m=h.chart_ops.meta.level[h.drill_level];if(h.canSetSplitCompare()&&!m.split_compare_setting){var g=e.data.y.length/e.info.y.length;e.info.split_compare_setting=m.split_compare_setting=16>g?{rows:Math.ceil(Math.sqrt(g)),cols:Math.ceil(Math.sqrt(g))}:{rows:4,cols:4}}}e.supportNavigator()&&void 0===e.info.navigator_setting&&(h.chart_ops.meta.level[h.drill_level].navigator_setting={enabled:!1,start:0,end:1},h.saveChartImmediate({only_save_meta:!0}),e.info.navigator_setting={enabled:!1,start:0,end:1})}else if("chartTpl"===e.mode);else{i(e,n.filter_list);var _,m;if(n.filter_list_inner&&(_=bdp.utils.handleInnerFilterLevel(e.info.filter_list_inner),v.handler(e,_)),"fullscreen"===e.mode?(m=h.dashStandardItems[I].children[0].meta,m.filter_list_inner=_,m.adv_date_list=n.adv_date_list,m.description=n.description,m.xAxis=n.xAxis,m.yAxis=n.yAxis,m.isGranularity=n.enable_change_granularity,m.tb_update_time=1e3*n.tb_update_time,defined(n.fullscreen_granularity)||(n.fullscreen_granularity=!0),m.fullscreen_granularity=n.fullscreen_granularity):h.dashStandardItems[I]&&(m=h.dashStandardItems[I].children[0].meta,m.filter_list_inner=_,m.diff_filter=n.diff_filter,m.adv_date_list=n.adv_date_list,m.hasTotal=n.yAxis&&1==n.yAxis.length),m.x=n.xAxis,"C200"==n.chart_type&&(m.y=n.yAxis,n.tb_statistic&&angular.isObject(n.tb_statistic.row_setting)&&n.tb_statistic.row&&(m.row_setting=n.tb_statistic.row_setting),m.y_optional=n.yAxisOptional,m.advanced_sort=n.advanced_sort,m.is_advanced_sort=n.is_advanced_sort,e.on("dashboard_click_sort",function(){c(function(){m.is_advanced_sort=0})})),m.split_compare=n.split_compare,m.show_navigator=n.navigator_setting&&n.navigator_setting.enabled&&[y.Line,y.Column,y.NStackColumn,y.PStackColumn,y.Sankey,y.Area,y.NStackArea,y.PStackArea,y.Biax].indexOf(n.chart_type)>-1,void 0===n.show_datalabels&&(n.show_datalabels=["C271","C272","C330","C360"].indexOf(n.chart_type)>-1),m.drillChartType=e.getChartType(),"fullscreen"===e.mode){clearTimeout(H),H=setTimeout(function(){x()});var b,C=$(".fullscreen-modal"),k=C.find(".dash-filter-wrap").height(),A=C.find(".drill-crumbs-wrap").height();b=k>0?k+A+79:15+A+109,e.$elem.css({top:b})}}"C280"==e.getChartType()&&e.data.bubble_size_groups&&(h.bubble_size_groups=e.data.bubble_size_groups),h.fullscreen&&(h.fullscreen.chart_type=h.selected_type),h.$$phase||h.$digest(),"edit"===e.mode&&(h.getChartArgsHeight&&h.getChartArgsHeight(),h.loadingData=!1,"C400"!==e.getChartType()&&$("#chartBox").find(".chart-inner-filter").length?e.$elem.css({top:$("#chartBox").find(".chart-inner-filter").height()+10}):"C400"!==e.getChartType()&&e.$elem.css({top:47}),setTimeout(function(){h.draw_chart_url.options&&bdp.utils.reDrawWithoutHighCharts(h.draw_chart_url.options,e.getChartType())},100)),e.data.y&&e.data.y.length>0&&r(e.data,e.info),w(e),h.$broadcast("chart_data_load",e),h.$broadcast("chart_data_warn",e.info.warn_info),h.$broadcast("current_level_inner_filter",h.currentLevelInnerFilter)}function w(t){if(d.global.watterMark&&"edit"!=t.mode){var e="";e="dark"===t.theme?"water-mark-white":"water-mark-dark";var a=t.$elem;if(e)if(bdp.utils.browser().ie)a.removeClass("water-mark-white water-mark-dark").addClass(e);else if(0==a.parent().find(".chart-water-mark").length){var i=document.createElement("div");i.className="water-mark chart-water-mark "+e,a.parent().append(i)}else a.parent().find(".chart-water-mark").removeClass("water-mark-white water-mark-dark").addClass(e)}}function k(t,e,a){m(e,t,h,a)}function A(t,e){var a,i,r=e.info.xAxis[0],n=r.granularity||"day",o=r.granularity_name||"",l=r.month_start_day||0,s=e.getChartType(),d="C200"===s,c="C280"===s;if(c){var p=t.index,u=e.data.x[0];a=u.data[p],i="date"==r.data_type?g.checkGranularity(n,a,o,l):"sub_date"==r.data_type?g.subDateFormat(r.fid.split("_")[1],a):a}else if(d){var f=$(t).text();f||"img"!=$(t).get(0).tagName.toLowerCase()||(f=$(t).attr("data-text")),a=$(t).data("drill-value"),i=f
}else if("C300"===s){var m=t.source,y=t.target;a={type:"C300",fid:e.info.xAxis[0].fid,source:{stage:m.origin_value,state:m.origin_name_value},target:{stage:y.origin_value,state:y.origin_name_value}},i="date"==r.data_type?g.checkGranularity(n,m.origin_value,o,l)+m.name+" ~ "+g.checkGranularity(n,y.origin_value,o,l)+y.name:"sub_date"==r.data_type?g.subDateFormat(r.fid.split("_")[1],m.origin_value)+m.name+" ~ "+g.subDateFormat(r.fid.split("_")[1],y.origin_value)+y.name:m.origin_value+m.name+" ~ "+y.origin_value+y.name}else if("C330"===s)i=t.label.raw,a=e.origin_data.x[0].data[t.index];else{if("C320"===s&&t.isSum)return;a=t.name&&"slice"!==t.name.toString().toLowerCase()?t.name:t.x,"date"===r.data_type?("week"===n&&o&&(a+=864e5*(r.week_start_day_of_week-1),l=r.week_start_day_of_week),i=g.checkGranularity(n,a,o,l),a=2==e.info.x.length?e.xMap[t.name]:e.xMap[t.x],"C230"===s&&["其它","Else"].indexOf(t.options.x)>=0&&(i=t.options.x,a=t.options.x)):i="sub_date"==r.data_type?g.subDateFormat(r.fid.split("_")[1],t.name):t.name}var v=e.optional;v.drill_field=e.info.xAxis[0].fid,v.drill_level=(v.drill_level>>>0)+1,angular.isArray(v.drill_value)?v.drill_value.push(a):v.drill_value=[a],"edit"==e.mode&&(h.drill_field=v.drill_field,h.drill_value=v.drill_value),h.drillOption=e.optional,M(v.drill_level,e),S(e.$elem,e.info.xAxis[0],i,e.optional)}function S(t,e,a,i){var r=t.parent();"fullscreen"===B.mode&&(r=$(".fullscreen-modal"));var n=r.find(".drill-crumbs");if(a=bdp.utils.encodeHTML(a),n.length>0)n.append('<i class="bdp-icon ico-slicesnav-arrow"></i><span><a href="javascript:;" class="drill-point-name back-chart'+i.drill_level+'" data-level="'+i.drill_level+'" title="'+a+'">'+a+"</a></span>"),r.find(".back-chart"+i.drill_level).off("click").on("click",D);else{n=angular.element('<div class="drill-crumbs"></div>');var o=angular.element('<span><a href="javascript:;" class="backToMainChart" data-level="0">'+bdp.utils.encodeHTML(e.name)+"</a></span>");n.append(o).append('<i class="bdp-icon ico-slicesnav-arrow"></i><span><a href="javascript:;" class="drill-point-name back-chart'+i.drill_level+'" data-level="'+i.drill_level+'" title="'+a+'">'+a+"</a></span>"),r.find(".drill-crumbs").remove(),r.find(".drill-crumbs-wrap").append(n),r.find(".backToMainChart").off("click").on("click",D),r.find(".back-chart"+i.drill_level).on("click",D)}t.css({bottom:22}),"chart_edit"==d.view&&t.css({bottom:48})}function D(){var t=angular.element(this),e=t.parents(".drill-crumbs-wrap").siblings(".chart");$(".chart-error").remove();var a=t.attr("data-level")>>>0;0==a?(e.css({bottom:0}),t.parents(".drill-crumbs").remove()):t.parent().nextAll().remove(),M(a,null,e),e.attr("data-drill","true"),e.attr("data-drill-status","false")}function M(t,e,a){var i=e&&e.$elem||a,r={};e&&(r=e.optional||{});var n=h.$eval(f.bdpChart);n.read_cache=!1,$.extend(n.optional,r);var o=n.optional||{};0==t?(delete o.drill_field,delete o.drill_level,delete o.drill_value):(o.drill_level=t,o.drill_value=o.drill_value.slice(0,t)),h.$$phase||h.$digest(),i.attr("data-drill-status","true")}function T(t,e){if(e.canDrawMarkPoint()){var i=$(t.container).parent();i.find(".hchart-mark-point").remove();var r=$("<div chart-mark-points></div>").appendTo(i),n=[];angular.forEach(e.markPoints,function(a){var i=L(t,a,e.getChartType());if(null!=i){var r=a.comment.length>25?150:hz.cutString.getP(a.comment);r+=5,r=Math.min(150,r),"edit"==e.mode&&(r=Math.max(100,r)),n.push({point:i,pointModel:a,pos:P(i,16,16,e.mode),contentPixel:r,show:h.show_chart_description})}});var o=h.$new();o.markPoints=n,o.mode=e.mode,o.ct_id=e.ct_id,o.$on("toggleAllPoints",function(t,e){angular.forEach(o.markPoints,function(t){t.show=void 0==e?!t.show:e})}),o.$on("displayMarkPointModel",function(t,e){angular.forEach(o.markPoints,function(t,a){t.show=a==e})}),o.$on("reflow",function(){bdp.utils.throttle(function(){angular.forEach(o.markPoints,function(t){t.pos=P(t.point,12,13,e.mode)}),o.$$phase||o.$digest()},100)()}),setTimeout(function(){a(r)(o)},100)}}function L(t,e,a){var i=t.series[e.seriesIndex].points;if("C240"==a){var r=t.series.length,n=r-1-e.seriesIndex;i=t.series[n].points}for(var o=0;o<=e.xDataIndex;o++)if(i[o].index==e.xDataIndex)return i[o];return i[e.xDataIndex]}function E(t,a){var i=t.series._i,r=t.index,n=a.info.yAxis.concat(a.info.yAxisOptional),o=2==a.info.xAxis.length,l=o?1:0,s=null;(s=O(t,a))?h.editMarkPoint(s,a.ct_id):e.open({template:"/static/partials/dialogTemplates/mark_point_model.html",className:"ngdialog-theme-default ngdialog-small",scope:h,data:{point:{ct_id:a.ct_id,xaxis_id:a.info.xAxis[l].fid,xaxis_value:a.data.x[l].data[r],yaxis_id:n[i].fid,yaxis_uniq_id:n[i].uniq_id,originPoint:t},xAxis:a.info.xAxis[l],type:"create"},controller:"EditMarkPointCtrl"})}function O(t,e){for(var a=e.getChartType(),i=0,r=e.markPoints.length;r>i;i++){var n=e.markPoints[i];if(L(t.series.chart,n,a)==t)return n}return null}function P(t,e,a,i){if(t.series){var r,n=3,o=t.series,l=o.chart,s=o.type,d={},c=l.options.plotOptions[s]&&void 0!=l.options.plotOptions[s].stacking;if(c){var p=t.index;t=l.series[0].points[p]||t}if(!o.visible)return{left:-100,top:-100};switch(s){case"line":case"spline":var u=Math.round(t.plotX),f=Math.round(t.plotY);d.left=o.xAxis.pos+u,d.top=o.yAxis.pos+f,t.dataLabel&&h.show_data_label&&f>=20&&(d.top-=16);break;case"column":case"waterfall":r=c||t.series.options.borderRadiusBottomLeft?t.originShapeArgs:t.shapeArgs,d.left=o.xAxis.pos+r.x+r.width/2,d.top=o.yAxis.pos+Math.max(0,r.y),t.dataLabel&&h.show_data_label&&r.y>=20&&(d.top-=16);break;case"bar":r=c||t.series.options.borderRadiusTopLeft?t.originShapeArgs:t.shapeArgs,d.left=o.yAxis.len+o.yAxis.pos-Math.max(0,r.y),d.top=o.xAxis.len+o.xAxis.pos-r.x-r.width;break;case"area":case"areaspline":var u=Math.round(t.plotX),f=Math.round(t.plotY);d.left=o.xAxis.pos+u,d.top=o.yAxis.pos+f,t.dataLabel&&h.show_data_label&&f>=20&&(d.top-=16)}return"bar"!=s?(d.left-=e/2,d.top=d.top-a-n):(d.left=d.left-e,d.top=d.top-n-a),"edit"===i&&(d.left=d.left+40,d.top=d.top+32),d}}function F(t,e){W.init(t,e)}function N(t,e){b.init(t,e)}h.filterDisplay=!1;var z=h.$watch(f.lazyLoaded,function(t){t===!1&&(_(),z())}),B=null,I=h.$eval(f.index),H=null;p(["dash.polymerization"],h),h.chartOptions={},h.formulaKeyMap=n,h.setAdvanceAggregatorName=l,h.formatFieldPercentile=s,void 0!=f.index&&h.$watch(f.index,function(t){I=t}),h.getCurrentLayerFilter=function(t){var e=h.drill_level||0,a=[];return a=t instanceof Array?t:t[e]};var W={init:function(t,e){var a=e.info.chart_type;if("C200"===a)return void W.initFromTable(t,e);var i=e.optional.link_info,r=e.ct_id,n=e.data.x,o=["C271","C272"],l=[],s={x:t.x,name:t.name,index:t.index,hzCode:t["hz-code"]};$.inArray(a,o)>-1?l.push(t.name):angular.forEach(n,function(e){l.push(e.data[t.index])}),void 0===e.linked&&(e.linked=!0),e.linked=angular.equals(l,e.pointData)?!e.linked:!0,d.mainChartContainer=W.getAllMainChart(e.linked,!1,l,i,r,s),W.updateColor(t,e,r,l),e.pointData=l,W.reGetLinkData(i),h.$$phase||h.$apply()},initFromTable:function(t,e){var a=e.optional.link_info,i=e.ct_id,r=(e.data.x,e.info.chart_type,e.pointData);e.linked=!1;for(var n=0,o=r.length;o>n;n++)if(r[n]){e.linked=!0;break}d.mainChartContainer=W.getAllMainChart(e.linked,!0,r,a,i),e.pointData=r,W.reGetLinkData(a),h.$$phase||h.$apply()},getAllMainChart:function(t,e,a,i,r,n){var o=d.mainChartContainer.slice(0),l=$.inArray(r,d.mainChartIdContainer);if(t){if(l>-1)return o[l].pointData=a,!e&&(o[l].pointInfo=n),o;var s={ctId:r,linkInfo:i,pointData:a,pointInfo:n};!e&&(s.pointInfo=n),o.push(s),d.mainChartIdContainer.push(r)}else angular.forEach(o,function(t,e){t.ctId==r&&o.splice(e,1)}),d.mainChartIdContainer.splice(l,1);return o},getLinkValue:function(t){var e=[];return angular.forEach(d.mainChartContainer,function(a){var i=a.ctId,r=a.pointData;angular.forEach(a.linkInfo,function(a){if(a.link_ct_id==t){var n=[];angular.forEach(a.field_map,function(t){r[t.index]&&n.push({field:t.field,index:t.index,field_value:r[t.index]})}),e.push({ct_id:i,select_fields:n})}})}),e},refreshSubChart:function(t,e){delete t.options.optional.filter_list,t.options.read_cache=!1,t.options.optional.linked_value=e,t.options.optional._t=new Date},reGetLinkData:function(t){angular.forEach(h.draw_chart_url,function(e){var a=e.options.ct_id;angular.forEach(t,function(t){if(t.link_ct_id==a){var i=W.getLinkValue(a);W.refreshSubChart(e,i)}})})},updateColor:function(t,e,a,i){function r(a){e.linked?(a.xAxis[0].removePlotLine("chartLinkPlotLine"),a.xAxis[0].addPlotLine({value:t.x,color:"rgba(134,139,156,0.5)",width:1,id:"chartLinkPlotLine"})):a.xAxis[0].removePlotLine("chartLinkPlotLine")}function n(t,r){angular.forEach(t,function(t,n){var o=e.options.chart.type;if(["pie","map"].indexOf(o)>-1){var l,h=t.data;h.length>1&&(angular.forEach(h,function(t,e){var a=t.x||t.name;a==i[0]?l=e:angular.isNumber(e)&&(h[e].selected=!1,h[e].sliced=!1)}),angular.isNumber(l)&&(h[l].selected||h[l].sliced?(h[l].selected=!1,h[l].sliced=!1,h[l].select=!1):(h[l].selected=!0,h[l].sliced=!0,h[l].select=!0)))}else e.linked?angular.forEach(t.data,function(t,e){var o=[];if(angular.forEach(s,function(t){o.push(t.data[e])}),angular.equals(i,o)){var l;angular.forEach(d.mainChartColorContainer[a].chartColor[r][n],function(t){for(var e in t)angular.equals(e,i.toString())&&(l=t[e])}),l&&(t.color=l)}else t.color="#ccc"}):angular.forEach(t.data,function(t,e){var i;for(var o in d.mainChartColorContainer[a].chartColor[r][n][e])i=d.mainChartColorContainer[a].chartColor[r][n][e][o];t.color=i})})}var o=(t.index,[]);$.each(t.series.chart.series,function(e){/^Navigator/.test(t.series.chart.series[e].name)||o.push(t.series.chart.series[e])});var l=e.info.chart_type,s=e.data.x;if("C220"===l||"C250"===l)if(e.isSplitChart())e.chartInstances.forEach(function(t){r(t)});else{var h=t.series.chart;r(h)}else e.isSplitChart()?e.chartInstances.forEach(function(t,e){n(t.options.series,e),t.update({series:t.options.series})}):(n(e.options.series,0),t.series.chart.update({series:e.options.series}))}}}}}function i(t,e){var a=t.info.drill_level,i=t.info.level_fields;if(angular.forEach(e,function(t){void 0!=t.inner_range&&delete t.disabled}),a)for(var r=0,n=Number(a);n>r;r++)angular.forEach(e,function(t){for(var e=0;a>e;e++)void 0!=t.inner_range&&t.fid==i[e].fid&&(t.disabled=!0)})}function r(t,e){for(var a,i=0;i<t.y.length;i++){a=t.y[i].data;for(var r=0;r<a.length;r++)"INF"===a[r]&&(a[r]=0)}if("C250"===e.type)for(var n,o=0;o<t.y_optional.length;o++){n=t.y_optional[o].data;for(var l=0;l<n.length;l++)"INF"==n[l]&&(n[l]=0)}}function n(t,e,a){var i=t.info,r=i.yAxis||[],n=i.yAxisOptional||[],o=r.concat(n);o=l(o.slice(),e);for(var s,d,h=[],c=0;c<o.length;c++)s=o[c],s&&(d=s.nick_name||s.name+e.setAdvanceAggregatorName(s)),d||(d=s.name),h.push({uniq_id:s.uniq_id,name:s.nick_name||s.name,color:s.series_color||a[c%a.length],show_name:d});return h}function o(e,a,i,r){var o=$.cookie("locale"),l=e.getChartType(),h=t.ChartType,p=e.info;if("edit"===e.mode){if(p.navigator_setting&&p.navigator_setting.enabled){var m=window.localStorage.getItem("hasUseNavigator");m||(a.showNavigatorGuide=!0)}l!==h.GIS&&d(e,a);var y;if(l===h.Waterfall){var v=p.waterfall_setting&&p.waterfall_setting.color_theme||t.getColorsByType("C320","bdp");a.seriesColors=[{name:"en"===o?"Increased":"增长",color:v[0],show_name:"en"===o?"Increased":"增长"},{name:"en"===o?"Decreased":"下降",color:v[1],show_name:"en"===o?"Decreased":"下降"}]}else if(l===h.Funnel){var v=p.funnel_setting&&p.funnel_setting.color_theme||t.getColorsByType("C330","bdp");if(a.seriesColors=[],e.data.x.length)for(var _=e.data.x[0].data,b=0;b<_.length;b++){if("date"===e.data.x[0].data_type){var x=e.data.x[0].granularity;["hour","minute","second"].indexOf(x)>-1&&(x="g_"+x),y=g.checkGranularity(x,_[b])}else y=_[b];a.seriesColors.push({name:_[b],color:v[b%v.length],show_name:y})}else a.seriesColors=n(e,a,v);a.seriesColors.splice(a.seriesColors.length-1,1)}else if(l===h.Pie){var v=t.getColorsByType("C230","bdp");e.data.x.length||(p.y[0].series_color&&(v=[].concat(p.y).map(function(t){return t.series_color})),a.seriesColors=n(e,a,v))}else if(l===h.KPICard){var v=t.getColorsByType("C310","bdp");a.seriesColors=n(e,a,v);var C=a.chart_ops.meta.level[0].tb_conditional_formatting;$.isEmptyObject(C)||0===C.length||C.forEach(function(t){for(var e=0;e<a.seriesColors.length;e++)if(t.uniq_id===a.seriesColors[e].uniq_id){a.seriesColors.splice(e,1);break}})}else if(l===h.GIS){var w=a.viewData.currentLayer;if(w){a.seriesColors=[];for(var k=0,A=w.y.length;A>k;k++){var S=w.y[k];a.seriesColors.push({color:S.series_color,show_name:S.nick_name||S.name})}}}else[h.Sunburst,h.TreeMap,h.AreaMap,h.BubbleMap].indexOf(l)<0&&(a.seriesColors=s(i,a,e));e._isStackChart()&&(a.seriesColors=a.seriesColors.reverse()),a.$$phase||a.$digest()}(i&&$(i.container).find(".highcharts-yaxis").length>0&&"C370"!==l||"C250"===l||"C261"===l)&&(e.isDashboardMode||(["C210","C212","C211","C220","C240","C242","C241","C250","C350","C351","C352"].indexOf(l)>-1&&c(a,e,i,r),"fullscreen"===e.mode&&"C212"!==l&&"C242"!==l&&"C352"!==l&&l!==h.Gauge&&"mix"!==g.getPositiveOrNegative(e.data,"y")&&u(e,i)),"edit"===e.mode&&(f(a,a.chart_ops),a.originChartTitle=a.chart_ops.name))}function l(t,e){return angular.forEach(t,function(t){e.formatFieldPercentile(t)}),t}function s(a,i,r){var o=r.info;if(o.compare_axis&&o.compare_axis.length){var s=t.getColorsByType(o.chart_type,"bdp");return n(r,i,s)}var d=o.hasOwnProperty("yAxis")?o.yAxis:[],h=o.hasOwnProperty("yAxisOptional")?o.yAxisOptional:[],c=d.concat(h);c=l(angular.copy(c),i);var p=[],u=a.options.colors,f=a.options.plotOptions,m=f.bar&&("percent"===f.bar.stacking||"normal"===f.bar.stacking)||f.column&&("percent"===f.column.stacking||"normal"===f.column.stacking)||f.area&&("percent"===f.area.stacking||"normal"===f.area.stacking);(0===o.xAxis.length&&m||"C250"==o.chart_type)&&(m=!1);for(var g=a.options.series,y=g.length,v="",_="",b=0,x=y;x>b;b++){var C=g[b],w=c[b];e(p,C.uniq_id)||(m&&(w=c[y-1-b]),w&&(v=w.nick_name?w.nick_name:w.name+i.setAdvanceAggregatorName(w),_=w.name),v||(m?(v=g[y-1-b].name,_=g[y-1-b].name):(v=C.name,_=C.name)),p.push({uniq_id:C.uniq_id,fid:C.fid,aggregator:C.aggregator,name:_,color:C.color||u[C._colorIndex],show_name:v||_}))}return m?p.reverse():p}function d(t,e){var a=t.$elem,i=a.find(".highcharts-title"),r=t.info.drill_level,n=t.getChartType(),o=t.info,l=!o.hasOwnProperty("show_total")||!!o.show_total,s=o.xAxis.length>0?o.xAxis[0].data_type:"",d="sub_date"===s||"date"===s,h="C200 C230 C250 C261 C271 C300 C310 C330".indexOf(n)<0&&!o.split_compare;if(i.length>0&&h){var c=$(i[0]),p=c.context.offsetTop,u="";u=d?o.title_formula||"LAST":o.title_formula||"TOTAL";var f=e.formulaKeyMap,g=f[u]||("zh"===e.language?"总计":"Total"),y="";d&&(y='<li class="dropdown-item"><a>'+f.LAST+"</a></li>");var v=$('<div class="set-layer-title"><div class="pa hz-chart-title-set"><span class="cursor-pointer hz-chart-title">'+g+'<i class="bdp-icon ico-triangle-down"></i></span><ul class="hz-chart-title-formula dropdown-wrap cursor-pointer"><li class="dropdown-item"><a>'+f.TOTAL+'</a></li><li class="dropdown-item"><a>'+f.AVG+'</a></li><li class="dropdown-item"><a>'+f.MAX+'</a></li><li class="dropdown-item"><a>'+f.MIN+"</a></li>"+y+"</ul></div></div>").appendTo(a),_=0,b="auto",x=$(".highcharts-title .hz-chart-title-default");"LAST"==u&&(_=x.width(),b=-x.width()+5,p-=5),v.find(".hz-chart-title-set").css({left:_,right:b,top:p-3}).hover(function(){$(this).find(".hz-chart-title-formula").show()},function(){$(this).find(".hz-chart-title-formula").hide()});var C=["TOTAL","AVERAGE","MAX","MIN","LAST"];a.find(".hz-chart-title-formula").children("li").click(function(){var t=$(this).index(),a=C[t];m({title_formula:a},r,e),$(this).parent().hide()}),l?$(".set-layer-title").show():$(".set-layer-title").hide()}}function h(t,e){var a=t.yAxis[0].axisTitle.element,i=e[0].getBoundingClientRect(),r=Math.ceil(i.width),n=Math.ceil(i.height),o=p(a.attributes,"x"),l=p(a.attributes,"y");return{x:o,y:l,width:r,height:n}}function c(t,e,a,i){var r="default",n=e.info,o=n.drill_level,l=n.sort&&n.sort.type||r,s=n.xAxis.length>0?n.xAxis[0].data_type:"",d=n.chart_type,c=e.$elem,p=c.find(".set-yaxis-sort"),u=c.find(".dot-guide-sort");if("date"!==s&&n.xAxis.length&&n.yAxis.length&&0===p.length){var f="ico-sort-",g="1",y=$('<span class="set-yaxis-sort '+l+'"><i class="bdp-icon '+f+l+g+'"></i></span>').appendTo(c);if(3==i.enterprise_type&&i.personalInfo&&5==i.personalInfo.chart_guide&&location.href.indexOf("chart_edit")>=0){var v='                        <div class="pa dot-guide-sort">                             <div class="circle-group">                                <div class="circle4"></div>                                <div class="circle3"></div>                                <div class="circle2"></div>                                <div class="circle1"></div>                            </div>                        </div>                    ',_=$(v).appendTo(c).position({my:"left top",at:"left top",of:".set-yaxis-sort"});y.on("click.dotguideSort",function(){_.remove(),i.personalInfo.chart_guide=0,$.ajax({url:"/api/user/guide_set",type:"POST",dataType:"json",data:{chart_guide:"0"}}).done(function(t){0!==t.status&&errorHandle(t.errstr)}).fail(function(t){errorHandle(t)})}),u=_}p=y,y.click(function(a){a.stopPropagation();var n,l=a.currentTarget.className,s=r;switch(/(?:^|\s+)(desc|asc)(?:\s+|$)/.test(l)&&(s=RegExp.$1),s){case"desc":n="asc";break;case"asc":n="";break;default:n="desc"}var d=e.info.sort;d&&d.uniq_id&&"y"==d.axis||(d={fid:e.data.y[0].fid,uniq_id:e.data.y[0].uniq_id});var h={axis:"y",type:n,fid:d.fid,uniq_id:d.uniq_id};"fullscreen"===e.mode||"chartTpl"===e.mode?e.drawWithOption({sort:h,rootScope:i}):"edit"===e.mode&&m({sort:h},o,t),$(a.currentTarget).removeClass(s).addClass(n||r),$(a.currentTarget).find(".bdp-icon").removeClass(f+s+g).addClass(f+(n||r)+g)})}var b=c.find(".highcharts-axis-title"),x=b.position();if(x&&a.yAxis){var C=h(a,b),w={};["C240","C241","C242"].indexOf(d)>-1?(w="edit"===e.mode?{left:+C.x-.5*C.width+18,bottom:a.chartHeight-C.y+26,transform:"rotate(90deg)"}:{left:+C.x-.5*C.width-22,bottom:a.chartHeight-C.y-6,transform:"rotate(90deg)"},p.css(w),u&&u.css({left:w.left-6,top:w.top+11})):"C261"!==d&&(w="edit"===e.mode?{left:+C.x+26,top:+C.y-.5*C.height+6}:{left:+C.x-14,top:+C.y-.5*C.height-26},p.css(w),u&&u.css({left:w.left-6,top:w.top+11}))}}function p(t,e){if(t.length){var a=t.getNamedItem(e);return a.value}}function u(t,e){var a=t.$elem,i=t.info.chart_type,r=a.find(".highcharts-yaxis"),n=r.position();if(n&&e.yAxis){var o=h(e,r.find(".highcharts-axis-title"));if(t.info.xAxis.length&&t.info.yAxis.length){var l=t.zoomYaxis?"ico-zoomout-white":"ico-zoomin-white",s=$('<i class="pa cursor-pointer zoom bdp-icon '+l+'"></i>');a.find(".zoom").length||s.appendTo(a),s.on("click",function(){if(t.zoomYaxis)delete t.options.yAxis[0].tickPositions;else{var e,r,n="C211"===i||"C241"===i||"C351"===i;if(n?(e=g.getSumByColumnFromMultiArray(t.data,"y","min"),r=g.getSumByColumnFromMultiArray(t.data,"y","max")):(e=g.getEdgeValueFromMultiArray(t.data,"","min"),r=g.getEdgeValueFromMultiArray(t.data,"","max")),r===e)return;var o=g.getAdjustValue(r,e),l=o.max.sub(o.min);t.options.yAxis[0].tickPositions=[o.min,o.min.add(l.mul(.25)),o.min.add(l.mul(.5)),o.min.add(l.mul(.75)),o.max]}t.zoomYaxis=!t.zoomYaxis,a.highcharts(t.options)})}["C240","C241","C242"].indexOf(i)>-1?a.find(".zoom").css({left:o.x-.5*o.width-44,bottom:e.chartHeight-o.y-3}):"C261"!==i&&a.find(".zoom").css({left:o.x-11,top:o.y-.5*o.height-48})}}function f(t,e){var a=e.meta;t.chartSetting={};var i=a.level[t.drill_level],r="";if(i.yaxis_name?r=i.yaxis_name:"C280"==i.chart_type&&i.y_scatter?r=i.y_scatter.length&&i.y_scatter[0].name:i.y.length>0&&(r=i.y[0].name),t.chartSetting.yaxis_left={name:r,unit:a.level[t.drill_level].yaxis_unit,max_value:+(a.level[t.drill_level].yaxis_max_disabled?$.cookie("yaxis_max"):a.level[t.drill_level].yaxis_max),min_value:+(a.level[t.drill_level].yaxis_min_disabled?$.cookie("yaxis_min"):a.level[t.drill_level].yaxis_min),max_disabled:"C261"===e.type?!1:!!a.level[t.drill_level].yaxis_max_disabled,min_disabled:!!a.level[t.drill_level].yaxis_min_disabled},"C280"===i.chart_type){var n=i.xaxis_name;!n&&i.y.length&&(n=i.y[0].name),t.chartSetting.xaxis={name:n,unit:i.xaxis_unit}}if("C250"===a.level[t.drill_level].chart_type){var o=void 0===a.level[t.drill_level].yaxis_max_disabled_right,l=void 0===a.level[t.drill_level].yaxis_min_disabled_right,s=i.yaxis_name_right;s||(s=i.y_optional.length?i.y_optional[0].name:""),t.chartSetting.yaxis_right={name:s,unit:a.level[t.drill_level].yaxis_unit_right,max_value:+(o||a.level[t.drill_level].yaxis_max_disabled_right?$.cookie("yaxis_max_right"):a.level[t.drill_level].yaxis_max_right),min_value:+(l||a.level[t.drill_level].yaxis_min_disabled_right?$.cookie("yaxis_min_right"):a.level[t.drill_level].yaxis_min_right),max_disabled:o?!0:!!a.level[t.drill_level].yaxis_max_disabled_right,min_disabled:l?!0:!!a.level[t.drill_level].yaxis_min_disabled_right}}t.originChartSetting=angular.copy(t.chartSetting)}function m(t,e,a,i){i||(i={not_need_redraw:!1}),$.extend(!0,a.chart_ops.meta.level[e],t),a.saveChartImmediate({only_save_meta:i.only_save_meta,not_need_redraw:i.not_need_redraw,only_refresh_data:!0,is_drill_chart:!!e})}angular.module("bdp.charts",[]).directive("bdpChart",a);var g=t.helper,y=t.ChartType;a.$inject=["ngDialog","$compile","formulaKeyMap","setAdvanceAggregatorName","formatFieldPercentile","$rootScope","$location","$timeout","$jsTipTranslate","commonService","errHint","$state","chartJumpFuns"];var v={travase:function(t){angular.forEach(t,function(t){delete t.disabled,t.items&&t.items.length>0&&v.travase(t.items)})},disabledItem:function(t,e){angular.forEach(e,function(e){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),e.fid==t&&""==e.inner_adv_type?e.disabled=!0:e.items&&e.items.length>0&&v.disabledItem(t,e.items)})},handler:function(t,e){var a=t.info.drill_level,i=t.info.level_fields;if(v.travase(e),a)for(var r=0,n=Number(a);n>r;r++)v.disabledItem(i[r].fid,e)}}}(bdpChart),!function(){function t(t,e){var a,i=600;t.lazySaveYaxisUnit=function(e,r,n){var o=i;13==e.keyCode&&(o=0),clearTimeout(a),a=setTimeout(function(){t.setYaxisUnit(r,n)},o)},t.ifEnterDownForY=function(e,a,i){13==e.keyCode&&t.setYaxisUnit(a,i)},t.setYaxisUnit=function(a,i){if(!t.originChartSetting)return!1;var r=t.originChartSetting["yaxis_"+i];if(JSON.stringify(r)==JSON.stringify(a))return!1;var n=a.name,o=a.unit,l=Number(a.max_value),s=Number(a.min_value),d=a.max_disabled,h=a.min_disabled;if(""==n)return e("标题不能为空。"),t.chartSetting["yaxis_"+i].name=r.name,!1;if(!a.max_disabled&&!a.min_disabled&&s>=l)return e("最小值不能超过最大值。"),!1;var c={},p="right"==i?"_right":"";c["yaxis_unit"+p]=o,c["yaxis_max"+p]=l,c["yaxis_min"+p]=s,c["yaxis_max_disabled"+p]=d||!1,c["yaxis_min_disabled"+p]=h||!1;var u="yaxis_name"+p;c[u]=n,$.extend(!0,t.chart_ops.meta.level[t.drill_level],c);var f={only_redraw:!0,is_drill_chart:!!t.drill_level},m=t.$bdpChart;if(r.unit!==o&&1===m.data.y.length){var g=m.data.summary;if(g&&1===g.supply_summary.length){var y=g.supply_summary[0];y.s_value=y.s_value.replace(r.unit,o)}}t.saveChartImmediate(f),angular.copy(a,t.originChartSetting["yaxis_"+i])},t.setValueAuto=function(e,a){return a="right"===a?"Right":"Left",t.chartSetting?("Left"===a?(t.chartSetting.yaxis_left[e+"_value"]=+$.cookie("yaxis_"+e),t.setYaxisUnit(t.chartSetting.yaxis_left,"left")):(t.chartSetting.yaxis_right[e+"_value"]=+$.cookie("yaxis_"+e+"_right"),t.setYaxisUnit(t.chartSetting.yaxis_right,"right")),void setTimeout(function(){"max"==e?$("#yAxis"+a+"MaxInput").select().focus():"min"==e&&$("#yAxis"+a+"MinInput").select().focus()},100)):!1},t.setZeroAligned=function(){var e=t.chart_ops.meta.level[t.drill_level];e.zero_aligned&&(e.yaxis_max_disabled=!0,e.yaxis_min_disabled=!0,e.yaxis_max_disabled_right=!0,e.yaxis_min_disabled_right=!0),t.saveChartImmediate()},t.judgeIsEnterPressForX=function(e){13==e.keyCode&&t.saveXaxisVareCheckDirty()},t.saveXaxisVareCheckDirty=function(){if(!t.chartSetting)return!1;var a=t.chartSetting.xaxis,i=t.originChartSetting.xaxis;if(!i||JSON.stringify(i)==JSON.stringify(a))return!1;if(""==a.name)return e("X轴标题不能为空。"),t.chartSetting.xaxis.name=i.name,!1;var r={only_redraw:!0,is_drill_chart:!!t.drill_level};i.name!=a.name&&(t.chart_ops.meta.level[t.drill_level].xaxis_name=a.name),i.unit!=a.unit&&(t.chart_ops.meta.level[t.drill_level].xaxis_unit=a.unit,r.not_need_redraw=!1),t.saveChartImmediate(r),angular.copy(a,t.originChartSetting.xaxis)}}angular.module("bdp.charts").controller("yAxisUnitController",t),t.$inject=["$scope","errHint"]}(),!function(t){function e(t,e){return $(t).position(e).top}var a=function(t,e,a){a=a||{},t=t||document,this.container=$(t),this.containerParent=t!==document?this.container.parent():$(window),this.diff=a.diff||100,this.selector=e,this.options=a||{},this._init()},i=null;a.prototype={_init:function(){this.threshold=this._getThreshold(),this.items=this._filterItems(),this.items.length&&(this._loader(!0),this._initLoadEvent())},_getThreshold:function(){var t=this.containerParent.height();return t+this.diff},_filterItems:function(){return this.container.find(this.selector)},_initLoadEvent:function(){var t=this;this.containerParent.on("scroll.lazy",function(){t._loader()}),this.options.handleResize&&$(window).on("resize.lazy",function(){t.threshold=t._getThreshold(),t._loader(!0)})},_loader:function(t){var e=this;return this.container,null!==i?!1:void(i=setTimeout(function(){e._loadItems(t),0===e.items.length&&($(window).off("resize.lazy"),e.containerParent.off("scroll.lazy")),i=null},100))},fireLoad:function(){this.threshold=this._getThreshold(),this._loader(!0)},destroy:function(){$(window).off("resize.lazy"),this.containerParent.off("scroll.lazy")},_loadItems:function(t){var a=this.containerParent.scrollTop();if(t||!(a<this.options.diff)){for(var i=this._filterItems(),r=this.options,n=this.container,o=this.threshold+a,l=!1,s=[],d=0,h=i.length;h>d;d++){var c=i[d];e(c,n)<=o?(l=!0,$.isFunction(r.onItemLoad)&&r.onItemLoad(c)):s.push(c)}l&&$.isFunction(r.onItemsLoad)&&r.onItemsLoad(),this.items=s}}},t.LazyLoad=a}(bdpChart),angular.module("bdp.charts").controller("EditMarkPointCtrl",["$scope","errHint","commonService","ngDialog",function(t,e,a,i){var r=t.point=t.ngDialogData.point;if(t.type=t.ngDialogData.type,"create"==t.type){var n=t.formatXValue=r.xaxis_value,o=t.xAxis=t.ngDialogData.xAxis;if("date"==o.data_type){var l=o.granularity||"day",s=o.granularity_name||"",d=o.month_start_day||0,h=bdpChart.helper.checkGranularity(l,n,s,d);"week"===l&&(h+="（"+Highcharts.dateFormat("%b/%e",new Date(n))+"~"+Highcharts.dateFormat("%b/%e",new Date(n+5184e5))+"）"),t.formatXValue=h}}t.save=function(){function n(a){var r=a;"0"==r.status?(i.closeAll(),t.saveChartImmediate()):e(r.errstr)}return r.comment?void("create"==t.type?a.fieldComment.create({ct_id:r.ct_id,xaxis_id:r.xaxis_id.split("_")[0],xaxis_value:r.xaxis_value,yaxis_id:r.yaxis_id,yaxis_uniq_id:r.yaxis_uniq_id,comment:r.comment}).then(n):a.fieldComment.modify({ct_id:r.ct_id,fc_id:r.fc_id,comment:r.comment}).then(n)):(e("标注内容不能为空"),!1)}}]),angular.module("ui.bootstrap.bindHtml").directive("markPointTooltipPopup",function(){return{restrict:"EA",replace:!0,scope:{content:"@",placement:"@",animation:"&",isOpen:"&"},templateUrl:"/static/js/dashboard/tpl/markPointTooltip.html"}}).directive("markPointTooltip",["$tooltip",function(t){return t("markPointTooltip","tooltip","mouseenter")}])}();