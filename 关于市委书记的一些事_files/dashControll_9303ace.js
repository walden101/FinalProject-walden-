!function(){var e=angular.module("app",["pascalprecht.translate","ui.router","BC.services","BC.directives","ui.bootstrap","ui.mask","bdp.charts","ngDialog","filter","gridster","datePicker","controllers","textAngular","ui.sortable","angular-click-outside"]),t=location.search.substring(1),a=null;/(^|&)shareId=([a-z0-9_]*)(&|$)/.test(t)&&(a=RegExp.$2),e.config(["$translateProvider",function(e){e.useLoaderCache(!0).useStaticFilesLoader({prefix:"/static/i18n/locale.",suffix:".json"}).registerAvailableLanguageKeys(["zh"],{"zh-CN":"zh","en-US":"en","en-UK":"en"}).preferredLanguage("zh")}]),e.config(["$stateProvider","$urlRouterProvider",function(){}]),e.config(["ngDialogProvider",function(e){e.setDefaults({showClose:!0,closeByDocument:!1,closeByEscape:!1})}]),e.factory("myInterceptor",function(){return{request:function(e){return e.params=e.params||{},e.params.sdo_id=a,e}}}).config(["$httpProvider",function(e){e.interceptors.push("myInterceptor")}]),e.factory("$api",["$http",function(e){return{getDashboardInfo:function(){return e.get("/api/dashboard/share_info",{params:{sdo_id:a}})},getCommentList:function(t){return e.get("/api/comment/list",{params:{sdo_id:a,page:t||1}})},submitComment:function(t,n){return e.post("/api/comment/create",{comment:t,sdo_id:a,response_id:n})},deleteComment:function(t){return e.post("/api/comment/delete",{cmt_id:t})},favor:function(){return e.get("/api/like/add",{params:{sdo_id:a}})},dashFilterItem:function(t){return e.post("/api/dsh_filter/item",{dsh_id:t.dash_id,sdo_id:t.sdo_id,rule_id:t.rule_id})}}}]),e.run(["$rootScope","$timeout",function(e){e.ready=!1,e.hideWarn=!0,e.appBrowserView=!1,"mobile"==$.cookie("client")&&(e.appBrowserView=!0)}]),angular.module("controllers",[]).constant("sdo_id",a).controller("dashCtrl",["$scope","$rootScope","commonService","$timeout","ngDialog","$api","sdo_id","commonHttp","errHint","$jsTipTranslate","dashChartLink",function(e,t,a,n,o,r,i,s,l,c,d){function u(t){r.dashFilterItem({dash_id:t,sdo_id:i}).then(function(t){var t=t.data;"0"===t.status&&(e.global.originalGlobalFilter=angular.copy(t.result),e.global.globalDashFilter=bdp.utils.handleGlobalFilterLevel(t.result),angular.forEach(e.global.globalDashFilter,function(e){if("date"==e.data_type&&""==e.config.granularity){var t=e.config.range||"";if(t){var a=!1;angular.forEach(e.adv_date_list,function(e){e.opt_id==t&&(a=!0)}),a||(e.config.range="",e.config.default_select=!1,e.range=[])}}}))})}function m(e){function t(e){var t=document.createElement("link");return t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href",e),t.setAttribute("id",window.BDPThemes.themeLinkCssId),t}function a(e){var a=t(e);"undefined"!=typeof a&&document.getElementsByTagName("head")[0].appendChild(a)}window.BDPThemes={themes:[{name:"简洁模式",filename:"light",fileUrl:"https://m1.bdp.cn/static/theme/light/css/light_df8f2e0.css",id:2,isInUsed:!1,backgroundImg:"https://m1.bdp.cn/static/theme/light/icons/preview-gray_07fbb60.png"},{name:"商务模式",filename:"dark",fileUrl:"https://m1.bdp.cn/static/theme/dark/css/dark_fd2be5c.css",id:1,isInUsed:!1,backgroundImg:"https://m1.bdp.cn/static/theme/dark/icons/preview-default_7ddfb28.png"}],bdpThemeIdCookieName:"theme_id",themeLinkCssId:"J-theme-linek-css"};for(var n=window.BDPThemes.themes,o=n[0].fileUrl,r=n.length-1;r>=0;r--)if(e==n[r].id){o=n[r].fileUrl;break}a(o)}function h(t,a){var o=bdpChart.helper.isMobile();o&&f(),e.gridsterOpts={layoutStyle:a,margins:t?o?[8,0]:[8,8]:[0,0],outerMargin:!1,minColumns:2,minRows:2,columns:12,isMobile:o,resizable:{enabled:!1,handles:"se",start:function(){},resize:function(e,t,a){reflowChart(a)},stop:function(t,a,o){n(function(){var t=o.find(".item-chart").attr("id");t&&(e.draw_chart_url[t].options._t=(new Date).getTime())},0),e.saveDashboard()}},draggable:{enabled:!1,handle:".chart-box",cancel:".drag-disable",stop:function(){e.saveDashboard()}}}}function f(){$("body").addClass("mobile-mode"),t.mobileMode=!0;var e=null;$(".gridster").on("click",".chart-box",function(){var t=$(this).find(".item-chart").get(0);return t==e?!1:($(t).addClass("reactive").removeClass("noscroll"),e&&$(e).removeClass("reactive"),e=t,void 0)}),$(document).on("touchmove",".item-chart.reactive",function(){return $(this).find(".chart-table").length>0?!0:!1}),$(document).on("scroll",function(){e&&($(e).removeClass("reactive"),e=null)})}e.mouseleaveItem=function(){e.$broadcast("fire-mouseleave-item-event",!0)},e.chartOptions={},t.mainChartContainer=[],t.mainChartIdContainer=[],t.mainChartColorContainer={},t.global={},e.fullDisplayDevice=localStorage?localStorage.getItem("fullDisplayDevice")||"pc":$.cookie("fullDisplayDevice")||"pc",e.setFullDisplayDevice=function(a){a!==e.fullDisplayDevice&&(e.fullDisplayDevice=a,BDPLogger.log("interaction","click","setFullDisplayDevice",1),BDPLogger.log("feature","fullDisplayDevice",a,1),localStorage?localStorage.setItem("fullDisplayDevice",a):$.cookie("fullDisplayDevice",a),e.dashStandardItems.forEach(function(e){var n=e.children[0].dom_id;if(n){var o=$("#"+n).find(".chart").data("chart-data");o&&o.setDisplayDevice(a,t)}}),$(".fullscreen-chart").length>0&&$(".fullscreen-chart").each(function(e,n){var o=$(n).data("chart-data");o&&o.setDisplayDevice(a,t)}))},e.removeFullDisplayStyle=function(){e.isFullscreenMode||"pc"===e.fullDisplayDevice&&e.fullDisplayTheme===t.usedThemeId||e.dashStandardItems.forEach(function(e){var a=e.children[0].dom_id;if(a){var n=$("#"+a).find(".chart").data("chart-data");n&&n.setDisplayStyle("pc",1==t.usedThemeId?"dark":"default",t)}})},e.fullDisplayTheme=localStorage?+localStorage.getItem("fullDisplayTheme")||t.usedThemeId:+$.cookie("fullDisplayTheme")||t.usedThemeId,e.setFullDisplayTheme=function(a){if(a!==e.fullDisplayTheme){e.fullDisplayTheme=a,BDPLogger.log("interaction","click","setFullDisplayTheme",1),BDPLogger.log("feature","fullDisplayTheme",a,1),localStorage?localStorage.setItem("fullDisplayTheme",a):$.cookie("fullDisplayTheme",a);var n=1===a?"dark":"default";e.dashStandardItems.forEach(function(e){var a=e.children[0].dom_id;if(a){var o=$("#"+a).find(".chart").data("chart-data");o&&o.setTheme(n,t)}}),$(".fullscreen-chart").length>0&&$(".fullscreen-chart").each(function(e,a){var o=$(a).data("chart-data");o&&o.setTheme(n,t)})}},e.dashLayoutInfo={},e.getDashboardInfo=function(a){return window.usedThemeId=t.usedThemeId=2,u(),t.dashLoading=!0,r.getDashboardInfo().then(function(o){if(o=o.data,t.dashLoading=!1,0==o.status){if(o=o.result,isObjectEmpty(o))return;var r=o.user_info.theme_id;window.usedThemeId=t.usedThemeId=o.user_info.theme_id,2!=r&&m(r),t.dashProperty=o.property,t.outer_share_info=o.outer_share_info,t.share_user_id=o.user_id,t.is_like=o.is_like,e.share_user_info=o.user_info,e.share_user_info.isLogin=$.cookie("token")?!0:!1,e.dashLayoutInfo.show_block=defined(o.meta.show_block)?o.meta.show_block:!0,e.dashLayoutInfo.fixed_width=defined(o.meta.fixed_width)?o.meta.fixed_width:!1,e.dashLayoutInfo.layout_style=defined(o.meta.layout_style)?o.meta.layout_style:1,h(o.meta.show_block,e.dashLayoutInfo.layout_style),e.dashTitle=o.name,document.title=o.name+" - BDP个人版",e.property=o.property;var s=o.meta.charts||[];e.dashStandardItems=s||[],e.dashStandardItems.sort(function(e,t){return e.row==t.row?e.col-t.col:e.row<t.row?-1:1}),e.draw_chart_url={};var l,c,d;d=e.isFullscreenMode?1===e.fullDisplayTheme?"dark":"default":1===t.usedThemeId?"dark":"default";for(var u=0;u<s.length;u++){l=s[u];for(var f=0;f<l.children.length;f++)c=l.children[f],c.meta.filter_list=[],c.meta.type&&(e.draw_chart_url[c.dom_id]={options:{theme:d,dsh_id:a,ct_id:c.meta.ct_id,tb_id:c.meta.tb_id,optional:{linked_chart_type:c.meta.chart_link.linked_chart_type,link_info:c.meta.chart_link.link_info,chart_jump_info:c.meta.chart_jump,sdo_id:i}},lazyload:u>2})}if(n(function(){e.lazy=new bdpChart.LazyLoad(".gridster",".gridster-item",{diff:50,handleResize:!0,onItemLoad:function(t){var a=$(t).find(".item-chart").attr("id");e.draw_chart_url[a]&&(e.draw_chart_url[a].lazyload=!1)},onItemsLoad:function(){e.$$phase||e.$apply()}}),e.search_ct_id&&setTimeout(function(){e.scrollToChart(e.search_ct_id)},10)}),2==e.dashLayoutInfo.layout_style){p.setFreeLayout();var g=p.getBlankPos().top;$(".gridster").css("height",g)}}else e.showError("该分享已被取消或不存在");t.ready=!0})},e.getDashboardInfo();var p={setFreeLayout:function(){var t,a=$("#J_gridster .gridster-item"),n="",o={};angular.forEach(a,function(a){n=$(a).attr("style"),t=$(a).data("chartId"),n.split(";").forEach(function(e){var t=e.replace(/\s/g,"").split(":");t[1]&&(o[t[0]]=t[1].replace("px",""))});for(var r=0;r<e.dashStandardItems.length;r++)t===e.dashStandardItems[r].children[0].meta.ct_id&&(e.dashStandardItems[r].left=+o.left,e.dashStandardItems[r].top=+o.top,e.dashStandardItems[r].width=+o.width,e.dashStandardItems[r].height=+o.height)})},getBlankPos:function(){var t=[];return angular.forEach(e.dashStandardItems,function(e){t.push(e.top+e.height)}),{top:Math.max.apply(this,t)}}};e.chartChain=d(e),e.showError=function(t){e.errMsg=t},c(["dash.delChartFail","dash.plzSelectTable","dash.selectTbTitle","dash.emptyFolderList","dash.titleRequired","dash.titleDuplicate","dash.delChartLinkSuccess"],e)}]).controller("commentCtrl",["$scope","$api","errHint","ngDialog",function(e,t,a,n){function o(t){var a,n=/@(.+)[:：]\s/;n.test(t)&&(a=RegExp.$1);for(var o=0,r=e.comment.list.length;r>o;o++){var i=e.comment.list[o];if(a==i.name)return i.cmt_id}return null}e.comment={list:[],cache:[],total:0,totalPage:0,currentPage:0,loadedAll:!1,renderSize:10,showAll:!1},e.currentComment={text:""},e.getCommentList=function(a,n){return t.getCommentList(a).then(function(t){var a=t.data;if(0==a.status){n&&(e.comment.list.length=0,e.comment.cache.length=0);var o=[];angular.forEach(a.result.comment,function(e){e.photo_content=e.photo_content.substring(0,3)+" "+e.photo_content.substring(3),o.push(e)}),e.comment.cache=o.concat(e.comment.cache),e.comment.total=a.result.total,e.comment.totalPage=a.result.page_count,e.comment.currentPage=a.result.current_page,e.comment.loadedAll=e.comment.cache.length>=a.result.total,e.current_user_id=a.result.user_id}})},e.renderComment=function(){var t=e.comment.cache;if(e.comment.showAll)e.comment.list=t.slice(0);else for(var a=Math.min(e.comment.renderSize,t.length),n=t.length-a,o=0;a>o;)e.comment.list.push(t[o+n]),o++},e.showAllComments=function(){function t(){e.getCommentList(e.comment.currentPage+1).then(function(){e.comment.loadedAll?e.renderComment():t()})}e.comment.showAll=!0,e.comment.loadedAll?e.renderComment():t()},e.calculateTime=function(e){var t,a=(new Date).getTime(),n=Math.round(a/1e3-e);return t=60>n?n+"秒前":3600>n?Math.round(n/60)+"分钟前":36e3>n?Math.round(n/3600)+"小时前":Highcharts.dateFormat("%Y年%m月%d日 %H:%M",1e3*e)},e.onReply=function(t){e.currentComment.text+="回复@"+t.name+": ",$(".comment-textarea").focus()},e.deleteComment=function(o){n.openConfirm({templateUrl:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngdialog-width-340",data:{title:"删除评论",message:"确认删除此条评论吗"}}).then(function(){return t.deleteComment(o.cmt_id).then(function(t){0==t.data.status?(a("删除评论成功"),e.getCommentList(1,!0).then(function(){e.renderComment()})):a("删除失败")})})},e.submitComment=function(){if(0==$.trim(e.currentComment.text).length)return void a("请输入评论内容");var n=e.currentComment.text,r=o(n);return t.submitComment(n,r).then(function(t){var n=t.data;0==n.status?(e.currentComment.text="",e.getCommentList(1,!0).then(function(){e.renderComment()})):a(23005==n.status?"评论达到上限":23030==n.status?"您的评论含有敏感词":"评论失败")})},e.getCommentList(1).then(function(){e.renderComment()})}]).controller("shareCtrl",["$scope","$window","$api","$rootScope",function(e,t,a,n){var o={type:"text",pic:[location.origin+"/static/images/bdp-dashboard-overview.png",location.origin+"/static/images/login_logo.png"],title:encodeURIComponent("我使用 #BDP# 制作了一个仪表盘，赶快来看看吧！"),desc:"BDP商业数据分析平台",sign:"off",summary:"BDP商业数据分析平台",searchPic:0,relateUid:0},r=location.href;e.shareDashboardTo=function(a,n){n=n||e.dashTitle;var i="快来看看分享自BDP商业数据平台的“"+n+"”数据仪表盘吧，数据翔实图表酷炫，满满都是干货哦～   BDP，为您提供便捷高效的数据分析和可视化服务。（来自@BDP商业数据平台）",s=angular.extend({},o,{url:r,to:a,product:"BDP",title:encodeURIComponent(i)}),l="http://share.baidu.com/s?",c=[];for(var d in s)if(s.hasOwnProperty(d))if("pic"==d&&angular.isArray(s[d])){var u;u="tsina"==a?s[d].join("||"):s[d][0],c.push(d+"="+u)}else c.push(d+"="+s[d]);l+=c.join("&"),t.open(l)},e.shareToWeChat=function(e){var t=e.target,a=$('<div class="share-wechat-pop"><div class="qrcode-wrap"></div><div class="foot">扫描二维码分享至微信</div><em class="arrow-left"></em></div>').appendTo("body"),n=$(t).offset();a.css({position:"absolute",zIndex:99999,top:n.top,left:n.left+$(t).width()+10}).find(".close-btn").on("click",function(){a.remove()}),a.find(".qrcode-wrap").qrcode({width:100,height:100,text:r}),$(t).on("mouseleave.showQrCode",function(){a.remove()})},e.addFavor=function(){return a.favor().then(function(t){var a=t.data;0==a.status?(e.outer_share_info.like_total++,n.is_like=1):23004==a.status&&alert("您已经点过赞了")})}}])}();