!function(){angular.module("monospaced.elastic",[]).constant("msdElasticConfig",{append:""}).directive("msdElastic",["$timeout","$window","msdElasticConfig",function(e,t,o){"use strict";return{require:"ngModel",restrict:"A, C",link:function(r,n,i,a){function l(){var e=m;h=p,x=getComputedStyle(p),angular.forEach(C,function(t){e+=t+":"+x.getPropertyValue(t)+";"}),w.setAttribute("style",e)}function d(){var t,o,n,i,a;h!==p&&l(),c||(c=!0,w.value=p.value+y,w.style.overflowY=p.style.overflowY,t=""===p.style.height?"auto":parseInt(p.style.height,10),o=getComputedStyle(p).getPropertyValue("width"),"px"===o.substr(o.length-2,2)&&(i=parseInt(o,10)-P.width,w.style.width=i+"px"),n=w.scrollHeight,n>$?(n=$,a="scroll"):E>n&&(n=E),n+=P.height,p.style.overflowY=a||"hidden",t!==n&&(p.style.height=n+"px",r.$emit("elastic:resize",u)),e(function(){c=!1},1))}function s(){c=!1,d()}var p=n[0],u=n;if("TEXTAREA"===p.nodeName&&t.getComputedStyle){u.css({overflow:"hidden","overflow-y":"hidden","word-wrap":"break-word"});var g=p.value;p.value="",p.value=g;var h,c,y=i.msdElastic?i.msdElastic.replace(/\\n/g,"\n"):o.append,b=angular.element(t),m="position: absolute; top: -999px; right: auto; bottom: auto;left: 0; overflow: hidden; -webkit-box-sizing: content-box;-moz-box-sizing: content-box; box-sizing: content-box;min-height: 0 !important; height: 0 !important; padding: 0;word-wrap: break-word; border: 0;",f=angular.element('<textarea aria-hidden="true" tabindex="-1" style="'+m+'"/>').data("elastic",!0),w=f[0],x=getComputedStyle(p),v=x.getPropertyValue("resize"),V="border-box"===x.getPropertyValue("box-sizing")||"border-box"===x.getPropertyValue("-moz-box-sizing")||"border-box"===x.getPropertyValue("-webkit-box-sizing"),P=V?{width:parseInt(x.getPropertyValue("border-right-width"),10)+parseInt(x.getPropertyValue("padding-right"),10)+parseInt(x.getPropertyValue("padding-left"),10)+parseInt(x.getPropertyValue("border-left-width"),10),height:parseInt(x.getPropertyValue("border-top-width"),10)+parseInt(x.getPropertyValue("padding-top"),10)+parseInt(x.getPropertyValue("padding-bottom"),10)+parseInt(x.getPropertyValue("border-bottom-width"),10)}:{width:0,height:0},z=parseInt(x.getPropertyValue("min-height"),10),I=parseInt(x.getPropertyValue("height"),10),E=Math.max(z,I)-P.height,$=parseInt(x.getPropertyValue("max-height"),10),C=["font-family","font-size","font-weight","font-style","letter-spacing","line-height","text-transform","word-spacing","text-indent"];u.data("elastic")||($=$&&$>0?$:9e4,w.parentNode!==document.body&&angular.element(document.body).append(w),u.css({resize:"none"===v||"vertical"===v?"none":"horizontal"}).data("elastic",!0),p.oninput="onpropertychange"in p&&"oninput"in p?p.onkeyup=d:d,b.bind("resize",s),r.$watch(function(){return a.$modelValue},function(){s()}),r.$on("elastic:adjust",function(){l(),s()}),e(d),r.$on("$destroy",function(){f.remove(),b.unbind("resize",s)}))}}}}])}();
;angular.module("BC.directives").directive("projectList",["$window","$location","$rootScope","$stateParams","commonService","commonHttp","$timeout","ngDialog","errHint","$jsTipTranslate",function(t,e,a,o,i,s,r,l,d,n){return{restrict:"A",transclude:!0,templateUrl:"/static/js/common/tpl/nav_project_list.html",link:function(t,o){function c(e){for(var a={},o=0;o<t.project_list.length;o++){a=t.project_list[o];for(var i=0;i<a.dsh_list.length;i++)if(a.dsh_list[i].dsh_id===e)return a}return a}function h(){var o=e.path().split("proj")[0].replace(/\/$/,"");if(0===t.all_project_list.length)return e.path(o),a.last_dash_path=o||"/dash_edit",void localStorage.setItem("mc_location_path",o);for(var i="",s="",r="",l=0,d=t.all_project_list.length;d>l;l++)if(t.all_project_list[l].dsh_list.length>0){i=t.all_project_list[l].proj_id,s=t.all_project_list[l].dsh_list[0].dsh_id,r=t.all_project_list[l].rule_id;break}!i&&t.all_project_list.length>0&&(i=t.all_project_list[0].proj_id),r?(t.selected.dsh_id_rule_id=s+r,o+="/"+i+"/"+s+"/"+r):s?(t.selected.dsh_id_rule_id=s,o+="/"+i+"/"+s):(t.selected.dsh_id_rule_id="",o+="/"+i+"/",t.showEmptyDash=!0),t.selected.proj_id=i||"",t.selected.dsh_id=s||"",e.path(o),a.last_dash_path=o||"/dash_edit",localStorage.setItem("mc_location_path",o)}t.editState={},t.current={},t.current.proName="",t.getPorName=function(e,a,i,s){t.current.proName=a,t.rename_index=e,t.rename_project_id=i,angular.forEach(t.editState,function(e,a){t.editState[a]=!1}),t.editState[i]=!0,r(function(){o.find(".list-hd > ul >li").eq(e).find(".rename-input").select().focus()},10),s&&s.stopPropagation()},t.dashboard={edit:function(e,a,o){function i(e,a){return 8!=e.keyCode&&a&&a.length>=20?(d(t.tips["dash.dashboardLabelLimit"]),!1):void 0}function s(e,a){return 8!=e.keyCode&&a&&a.length>=100?(d(t.tips["dash.dashboardCommentLimit"]),!1):void 0}var r=c(a.dsh_id),n={saveEdit:t.dashboard.save,hitExistDashLabel:t.hitExistDashLabel,labelLimit:i,commentLimit:s,dsh_id:a.dsh_id,proj_id:r.proj_id,name:a.name,label:a.label,comment:a.comment,extra_data:{project:o},type:"edit"};l.open({templateUrl:"/static/partials/dialogTemplates/create_dashboard.html",scope:t,className:"ngdialog-theme-default ngdialog-small",data:n})},save:function(e,a){if(e.name.length>100)return void d(t.tips["dash.dashNameLessThan100"]);var o=e.name,s=e.dsh_id,r=e.label||"",l=e.comment||"",n=e.extra_data.project;if(!o)return void d(t.tips["dash.dashNameRequired"]);for(var c=0,h=n.dsh_list.length;h>c;c++)if(n.dsh_list[c].name==o&&n.dsh_list[c].dsh_id!=s)return void d(t.tips["dash.duplicateDashName"]);var _={dsh_id:s,data:angular.toJson({name:o,label:r,comment:l,meta:{}})};i.dashboard.modify(_).success(function(){for(var e=0,i=n.dsh_list.length;i>e;e++)if(n.dsh_list[e].dsh_id===s){n.dsh_list[e].name=o,n.dsh_list[e].label=r,n.dsh_list[e].comment=l;break}t.project_dsh_label_list=[],angular.forEach(t.all_project_list,function(e){angular.forEach(e.dsh_list,function(e){e.label&&t.project_dsh_label_list.indexOf(e.label)<0&&t.project_dsh_label_list.push(e.label)})}),t.selected.dsh_id===s&&$(".dash-title").find("h2").text(o),a&&a()})}},t.hitLabelList={show:!1,list:[]},t.hitExistDashLabel=function(e){t.hitLabelList.list=[],t.hitLabelList.show=!0,e?angular.forEach(t.project_dsh_label_list,function(a){a.toLowerCase().indexOf(e.toLowerCase())>=0&&t.hitLabelList.list.push(a)}):t.hitLabelList.list=angular.copy(t.project_dsh_label_list)},t.editProject=function(e,a){var o=t.current.proName;if(!o)return void d(t.tips["dash.projectNameRequired"]);for(var s=0,r=t.all_project_list.length;r>s;s++)if(t.all_project_list[s].name==o&&t.all_project_list[s].proj_id!=a)return void d(t.tips["dash.duplicateProjectName"]);i.project.modify(a,o).success(function(i){0==i.status&&(t.all_project_list[e].name=o),t.editState[a]=!1})},t.delProject=function(e,a,o){o&&o.stopPropagation();var s=a.proj_id,n=a.name;l.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:t.tips["dash.confirmDelProject"]+": "+n+" ?"}}).then(function(){i.project.del(s).then(function(a){"0"==a.status?(angular.forEach(t.project_list,function(e,a){e.proj_id==s&&t.project_list.splice(a,1)}),t.all_project_list.splice(e,1),s==t.selected.proj_id&&(t.selected.proj_id="",t.selected.dsh_id="",r(function(){0===t.all_project_list.length?(t.all_project_list.length=0,t.showEmptyDash=!1,t.showEmptyFolder=!0,h()):h()},0))):d(Number(a.status))})})},t.delDashboard=function(e,a,o){var s=a.dsh_id,r=a.name;l.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:t.tips["dash.confirmDelDash"]+": "+r+" ?"}}).then(function(){i.dashboard.del(s).success(function(a){"0"==a.status?(o.dsh_list.splice(e,1),s===t.selected.dsh_id&&(t.selected.dsh_id="",h()),t.project_dsh_label_list=[],angular.forEach(t.all_project_list,function(e){angular.forEach(e.dsh_list,function(e){e.label&&t.project_dsh_label_list.indexOf(e.label)<0&&t.project_dsh_label_list.push(e.label)})})):d(Number(a.status))})})},t.copyDashboard={originProjId:"",open:function(e){for(var a=0;a<t.project_list.length;a++)for(var o=t.project_list[a].dsh_list,i=0;i<o.length;i++)e.dsh_id===o[i].dsh_id&&(t.copyDashboard.originProjId=t.project_list[a].proj_id);l.open({template:"/static/partials/dialogTemplates/copy_dashboard.html",className:"ngdialog-theme-default ngDialog-width-360",scope:t,data:{proj_list:t.project_list,dash_name:e.name,dsh_list:e.dsh_list,dash_new_name:e.name,dash_id:e.dsh_id,cur_proj_id:t.copyDashboard.originProjId,save:t.copyDashboard.save}})},save:function(e){if(t.global.clickComplete=!1,!e.cur_proj_id)return t.global.clickComplete=!0,!1;for(var o=e.proj_list,i=0;i<o.length;i++)if(o[i].proj_id==e.cur_proj_id)for(var r=0;r<o[i].dsh_list.length;r++)if(o[i].dsh_list[r].name===e.dash_new_name)return d(t.tips["dash.duplicateDashName"]),t.global.clickComplete=!0,!1;s.post("/api/dashboard/copy",{to_proj_id:e.cur_proj_id,dsh_id:e.dash_id,dsh_name:e.dash_new_name,ws_id:a.wsId||""}).then(function(e){t.global.clickComplete=!0,0==e.status&&(l.closeAll(),t.getTree())})},handlerMorePos:function(t){var e=$(t.target).offset(),a=angular.element("body").height(),o=e.left-60,i={};i=a-t.clientY>100?{top:e.top+20,left:o,bottom:"inherit"}:{bottom:a-t.clientY,left:o,top:"inherit"},$(t.currentTarget).find(".field-editable-handler-more").css(i),angular.element(".label-comment-tooltip").css({display:"none"})}},n(["dash.projectNameRequired","dash.duplicateProjectName","dash.dashNameLessThan100","dash.dashNameRequired","dash.duplicateDashName","dash.confirmDelProject","dash.confirmDelDash","dash.copyDashFolderErr","dash.dashboardLabelLimit","dash.dashboardCommentLimit"],t)},controller:["$scope","$rootScope",function(t,e){function a(a){if(""==a||"undefined"==typeof a)return!1;var o=t.getProjectById(a,e.global.rule_id);t.setDashboard(o)}t.isEnterKey=function(e,a,o){var i=e.which?e.which:event.keyCode;13===i&&("project"===a?t.createProject(t.current.project_name):"dashboard"===a?t.createDashboard(t.current.dashboard_name,o):"project_rename"===a?t.editProject(t.rename_index,t.rename_project_id):"dashboard_rename"===a&&t.dashboard.save(t.current))},t.sortProject={items:"li:not(.J-sort-disabled)",start:function(){t.$broadcast("project-move-fire")},stop:function(){i.project.order(t.all_project_list).then(function(t){"0"!=t.status})}};var o,s,r=!1;t.sortDashboard={items:"li:not(.J-sort-disabled)",placeholder:"dash-sort-placeholder",start:function(e,a){o=a.helper.sortable.model,t.$broadcast("project-move-fire")},receive:function(e,a){r=!0,s=$(e.target).attr("data-proj-id");for(var i=t.getProjectById(s),l=0;l<i.dsh_list.length;l++)if(i.dsh_list[l].name===o.name)return d(t.tips["dash.duplicateDashName"]),a.item.sortable.cancel(),t.getTree(),!1},stop:function(e,l){var d;if(!l.item.sortable._isCanceled){if(r){var n=(t.getProjectById($(e.target).attr("data-proj-id")),t.getProjectById(s));d=n.dsh_list.map(function(t){return t.dsh_id}),i.dashboard.move(n.proj_id,n.type,d,o.dsh_id).then(function(){a(n.proj_id)},function(){t.getTree()})}else{var c=$(e.target).attr("data-proj-id"),h=t.getProjectById(c);d=h.dsh_list.map(function(t){return t.dsh_id}),i.dashboard.order(c,h.type,d).then(function(t){"0"!=t.status})}r=!1}},items:"li:not(.J-sort-disabled)",cancel:".dash-template .dashboard-item"},t.sortOwnDashboard=angular.extend({},t.sortDashboard,{connectWith:".own-dash-list"}),e.$watch("permision.projEdit",function(e){if(void 0!=e){var a=!e;t.sortDashboard.disabled=t.sortOwnDashboard.disabled=t.sortProject.disabled=a}})}]}}]).directive("navProjectDropDown",["$timeout",function(t){return{restrict:"A",scope:{dropDownFlag:"="},link:function(e){e.$watch("dropDownFlag",function(a,o){var i=".J-scroll-project",s="scroll.projectfolder";if(a!==o&&1==a){var r=angular.element(i).scrollTop();t(function(){angular.element(i).on(s,function(a){Math.abs(r-$(a.target).scrollTop())>8&&(e.dropDownFlag=!1,t(function(){e.$digest()},0))})},0)}else a!==o&&0==a&&angular.element(i).off(s)}),e.$on("project-move-fire",function(){e.dropDownFlag=!1})}}}]);
;angular.module("BC.directives").directive("searchChart",["commonService","$rootScope","$timeout","pendingRequests",function(e,r,s,a){return{link:function(o,t){function c(){o.search_chart_list=[],o.search_dashboard_list=[],o.search_project_list=[],o.old_search_chart_list=[],o.old_search_dashboard_list=[],o.old_search_project_list=[]}function _(e,r){var s=0,a=0,t=0,c=0,_=o.all_project_list,h=_.length,i=0;if(r){for(s=0;h>s;s++)if(_[s].proj_id==e){t=s;break}}else for(s=0;h>s;s++)if(_[s].proj_id==e)for(t=s,a=0;a<_[s].dsh_list.len;a++)if(_[s].dsh_list[a]==r){c=a;break}$(".own-project-list > .project-item").each(function(e,r){t>e&&(i+=$(r).height())}),i+=32*c,scrollToTargetPos($(".project-list"),i)}c(),o.search_chart_list=[],o.search_dashboard_list=[],o.search_project_list=[],o.old_search_chart_list=[],o.old_search_dashboard_list=[],o.old_search_project_list=[],o.getFirstThreeSearchList=function(){o.search_chart_list=o.old_search_chart_list.slice(0,3),o.search_dashboard_list=o.old_search_dashboard_list.slice(0,3),o.search_project_list=o.old_search_project_list.slice(0,3)},o.getMoreSearchList=function(e,r){switch(r){case"chart":o.search_chart_list=o.old_search_chart_list.slice(0);break;case"dashboard":o.search_dashboard_list=o.old_search_dashboard_list.slice(0);break;case"project":o.search_project_list=o.old_search_project_list.slice(0)}},o.getFoldUpSearchList=function(e,r){switch(r){case"chart":o.search_chart_list=o.old_search_chart_list.slice(0,3);break;case"dashboard":o.search_dashboard_list=o.old_search_dashboard_list.slice(0,3);break;case"project":o.search_project_list=o.old_search_project_list.slice(0,3)}},o.showSearchBoxLoading=!1,o.showSearchBar=function(){o.show_search_box=!o.show_search_box,o.show_search_box&&(s(function(){angular.element(".dash-search-input").focus()},0),o.search_name="",c(),$(document).on("click.show_search_box",function(e){return $(e.target).closest(t).length>0?!1:(o.show_search_box=!1,o.$$phase||o.$apply(),$(document).off("click.show_search_box"),void 0)}))};var h=null;o.onSearchKeyUp=function(e){13==e.keyCode?o.search():(clearTimeout(h),o.search_name?h=setTimeout(function(){o.search()},200):o.search_chart_list=[])};var i=0;o.search=function(){if(o.search_name){var s=i=+new Date;!function(s){a.cancelOne("/api/chart/search"),o.showSearchBoxLoading=!0,c(),e.chart.search({name:o.search_name,is_tpl:"dash_tpl"===r.view?1:0}).then(function(e){o.showSearchBoxLoading=!1,i>s||e&&(o.old_search_chart_list=e.chart,o.old_search_dashboard_list=e.dsh,o.old_search_project_list=e.proj,o.search_result_empty=0===o.old_search_project_list.length&&0===o.old_search_dashboard_list.length&&0===o.old_search_chart_list.length,o.getFirstThreeSearchList())})}(s)}},o.jumpToSearchChart=function(e){function s(){if(l)o.$broadcast("scrollToChart",h);else{o.tapDashboard(t,d),o.$emit("onSearch",h);var e=a+(c?"$"+c:"");o.projFolding[e]||(o.projFolding[e]=1,localStorage.setItem("project_folding",angular.toJson(o.projFolding)))}}if(e){var a=e.proj_id,t=e.dsh_id,c=e.rule_id||"",h=e.ct_id,i=e.share_user_id||"",l=a==o.selected.proj_id&&o.selected.dsh_id==t&&r.global.rule_id==c,d=o.getProjectById(a,c,i);d&&(s(),_(a,t),o.show_search_box=!1)}},o.jumpToSearchDashboard=function(e){function s(){if(!i){o.tapDashboard(t,l);var e=a+(c?"$"+c:"");o.projFolding[e]||(o.projFolding[e]=1,localStorage.setItem("project_folding",angular.toJson(o.projFolding)))}}if(e){var a=e.proj_id,t=e.dsh_id,c=e.rule_id||"",h=e.share_user_id||"",i=a==o.selected.proj_id&&o.selected.dsh_id==t&&r.global.rule_id==c,l=o.getProjectById(a,c,h);l&&(s(),_(a,t),o.show_search_box=!1)}},o.jumpToSearchProject=function(e){function r(){if(!h){a&&o.tapDashboard(a,i);var e=s+(t?"$"+t:"");o.projFolding[e]||(o.projFolding[e]=1,localStorage.setItem("project_folding",angular.toJson(o.projFolding)))}}if(e){var s=e.proj_id,a="",t=e.rule_id||"",c=e.share_user_id||"",h=s==o.selected.proj_id,i=o.getProjectById(s,t,c);i&&(i.dsh_list.length>0&&(a=i.dsh_list[0].dsh_id),r(),_(s,a),o.show_search_box=!1)}}}}}]);
;!function(){angular.module("BC.directives").directive("dashFilter",["$timeout","commonService","$rootScope","commonHttp","$filter","ngDialog","errHint","$stateParams","AdvfilterOperatorMap","AdvfilterOperatorList","numberInnerFilterMap","operatorHelpLink","formulaKeyMap","setAdvanceAggregatorName","$jsTipTranslate","dateTimeByHalfHour",function(i,e,t,r,n,l,a,o,s,d,u,p,f,_,c,g){return{restrict:"A",templateUrl:"/static/js/dashboard/tpl/dash_filter.html",replace:!0,scope:{chartOptions:"=",opts:"=",advDateList:"="},link:function(e,n,f){function m(){e.isActive=!1,angular.forEach(e.filter_list_inner,function(i){void 0!=i.range&&i.range.length>0&&(e.isActive=!0)})}function h(i,t){var r=i.fid,n={right:0,top:26},l=bdp.utils.getArrayTextWidth(t,i);n.width=l,e.adjustWidth[r]=n}e.dateTimeByHalfHour=g,e.$on("fire-mouseleave-item-event",function(){e.show_dash_filter=!1}),e.adjustWidth={},e.fullscreen=!!f.fullscreen,e.goHelp=function(i){p(i)};var F=function(i){e.chartOptions.read_cache=!1,e.chartOptions.optional.filter_list=e.filter_list_inner,e.chartOptions.optional.filter_last_mod=i},v=!1,y=0,q=0,O=0;e.handleFilterPos=function(i){e.show_dash_filter=!e.show_dash_filter;var t=$(i.target),r=t.parent(),n=r.find(".J_filterLayer");n.removeClass("ng-hide");var l=r.width(),a=$(".J_dash_sidebar").width(),o=document.getElementById(e.opts.meta.ct_id),s=n.offset().left;O=o.style.left,O!=q&&(v=!1),v||(y=a>=s?l-n.width():-11,v=!0),n.css({right:y}),q=O},e.conditionList=[],e.operatorMap={1:"等于",2:"不等于",3:"包含",4:"不包含",5:"开头包含",6:"结尾包含"},e.operatorMap=s,e.AdvfilterOperatorList=d,e.numberInnerFilterMap=u,e.new_condition={operator:"",content:""},e.addNewCondition=function(i,t){return void 0!=t&&t.hasOwnProperty("operator")&&""!=t.content?(e.strFilter.conditionList.push({name:i,operator:t.operator,content:t.content}),angular.element(".new-condition").val(""),angular.element(".condition-select").val(""),void(e.new_condition={operator:"",content:""})):void a(e.tips["filter.inputCompleteCondition"])},e.removeCondition=function(i){e.strFilter.conditionList.splice(i,1)},e.saveDateRange=function(i){var t=i.sDate?i.sDate+" "+i.sDateHour:null,r=i.eDate?i.eDate+" "+i.eDateHour:null;if(!t&&!r)return a(e.tips["chart.dateRangeRequired"]),!1;if(t&&r){if(!i.sDateHour)return a(e.tips["filter.startDateErr2"]),!1;if(!i.eDateHour)return a(e.tips["filter.endDateErr2"]),!1;if(new Date(t)-new Date(r)>0)return a(e.tips["filter.dateRangeInvalid"]),!1}else{if(t&&!r&&!i.sDateHour)return a(e.tips["filter.startDateErr2"]),!1;if(!t&&r&&!i.eDateHour)return a(e.tips["filter.endDateErr2"]),!1}e.innerFilterModule.setInnerFilter({range:[t,r],index:i.data.index,fid:i.data.fid,type:"custom_date"})},e.isQuery=!1,e.strFilter={},e.queryKwd={},e.filterQueryModule={enterToQuery:function(i){13==i.e.keyCode&&(i.real_search?e.filterQueryModule.query(i.filter,i.is_advance):e.innerFilterItems[i.filter.fid].keyword=e.queryKwd[i.filter.fid])},delQueryField:function(i){e.tempQueryList&&(e.innerFilterItems[i].list=e.tempQueryList||[]),e.queryKwd[i]=""},query:function(i,n){e.showLoading=!0;var l="",s=i.fid;if(l=e.queryKwd[s]?e.queryKwd[s]:e.strFilter.keyword,!l)return e.showLoading=!1,e.isQuery=!1,void(e.strFilter.searchList=angular.copy(e.strFilter.originalSearchList));var d=e.opts.meta;e.tempDrillOption=e.$parent.drillOption?angular.copy(e.$parent.drillOption):{drill_field:"",drill_level:"",drill_value:[]};var u={ct_id:d.ct_id,tb_id:d.tb_id,fid:s,keyword:l,rule_id:t.global.rule_id,filter_list:angular.toJson(e.chartOptions.optional.filter_list?e.chartOptions.optional.filter_list:[]),granularity:i.granularity||"",dsh_id:o.dashId,dsh_filter:angular.toJson(e.chartOptions.optional.dsh_filter?e.chartOptions.optional.dsh_filter:[]),drill_field:e.tempDrillOption.drill_field,drill_level:e.tempDrillOption.drill_level,drill_value:angular.toJson(e.tempDrillOption.drill_value)};n&&(e.strFilter.loading=!0),r.post("/api/adv_enum/search",u).then(function(i){if(e.strFilter.loading=!1,e.showLoading=!1,0==i.status)if(e.tempQueryList=angular.copy(e.innerFilterItems[s].list),n){e.isQuery=!0;var t=[];angular.forEach(i.result,function(i){t.push({name:i,select:!1})}),e.strFilter.searchList=t}else e.innerFilterItems[s].list=i.result;else a(Number(i.status))})}},e.defaultRange={},e.nullRange={};var w;e.innerFilterModule={showDatePicker:function(i,t,r){if(navigator.userAgent.indexOf("Firefox")>=0&&t[0]&&t[0].indexOf("opt_")>=0);else if(navigator.userAgent.indexOf("Firefox")>=0&&t&&t.length>0){var n=null,a=null;t[0]&&(n=t[0].split("-"),n[1]<10&&(n[1]="0"+parseInt(n[1])),n[2]<10&&(n[2]="0"+parseInt(n[2])),n=n[0]+"-"+n[1]+"-"+n[2]),t[1]&&(a=t[1].split("-"),a[1]<10&&(a[1]="0"+parseInt(a[1])),a[2]<10&&(a[2]="0"+parseInt(a[2])),a=a[0]+"-"+a[1]+"-"+a[2]),t=[n,a]}if(t.length>1){var o=t[0]?t[0].split(" ")[1]||"00:00:00":"00:00:00",s=t[1]?t[1].split(" ")[1]||"23:59:59":"23:59:59";t=t.concat([o,s])}else 0===t.length&&(t=[+new Date,+new Date,"00:00:00","23:59:59"]);w=l.open({template:"/static/partials/dialogTemplates/custom_date_modal.html",className:"ngdialog-theme-default date-picker-modal daterange-bdp-modal",data:{fid:r,index:i,range:t},scope:e})},numberInnerFilterMap:u,getItemList:function(i,n,l){var a=n.fid,s=n.granularity||"";return n.hasOwnProperty("uniq_id")||(n.uniq_id=""),e.show_options[a+n.uniq_id]=!l&&!e.show_options[a+n.uniq_id],e.queryKwd[a]="",!e.show_options[a+n.uniq_id]&&!l||n.disabled?void(e.adjustWidth[n.fid]={top:26}):(e.showLoading=!0,e.currentChartId=i.ct_id,e.tempDrillOption=e.$parent.drillOption?angular.copy(e.$parent.drillOption):{drill_field:"",drill_level:"",drill_value:[]},void r.post("/api/field/inner_range",{dsh_id:o.dashId,ct_id:i.ct_id,tb_id:i.tb_id,fid:a,granularity:s,rule_id:t.global.rule_id,filter_list:angular.toJson(e.chartOptions.optional.filter_list?e.chartOptions.optional.filter_list:[]),dsh_filter:angular.toJson(e.chartOptions.optional.dsh_filter?e.chartOptions.optional.dsh_filter:[]),drill_field:e.tempDrillOption.drill_field,drill_level:e.tempDrillOption.drill_level,drill_value:angular.toJson(e.tempDrillOption.drill_value)}).then(function(i){if(e.showLoading=!1,0==i.status){var t=i.result;e.innerFilterItems[a]={list:t.range,total:t.total,keyword:""},l?l(n,t.range):h(n,t.range)}else errorHandle(i)}))},getItemListForNumber:function(i,n){if(e.currentChartId=i.ct_id,e.tempDrillOption=e.$parent.drillOption?angular.copy(e.$parent.drillOption):{drill_field:"",drill_level:"",drill_value:[]},e.show_options[n.fid+n.uniq_id]=!e.show_options[n.fid+n.uniq_id],e.show_options[n.fid+n.uniq_id]){e.nullRange[n.fid+n.uniq_id]=!1;var l=e.filter_list_inner;angular.forEach(l,function(l){if(l.fid==n.fid&&l.uniq_id==n.uniq_id)if(0==l.range.length)e.showLoading=!0,r.get("/api/field/inner_range",{dsh_id:o.dashId,ct_id:i.ct_id,tb_id:i.tb_id,fid:n.fid,uniq_id:n.uniq_id,granularity:"",rule_id:t.global.rule_id,filter_list:angular.toJson(e.chartOptions.optional.filter_list?e.chartOptions.optional.filter_list:[]),dsh_filter:angular.toJson(e.chartOptions.optional.dsh_filter?e.chartOptions.optional.dsh_filter:[]),drill_field:e.tempDrillOption.drill_field,drill_level:e.tempDrillOption.drill_level,drill_value:angular.toJson(e.tempDrillOption.drill_value)}).then(function(i){0==i.status&&(e.showLoading=!1,e.innerFilterItems[n.fid+n.uniq_id].numOpt=-1,e.innerFilterItems[n.fid+n.uniq_id].numRange=[],e.defaultRange[n.fid+n.uniq_id]=i.result.range,0==e.defaultRange[n.fid+n.uniq_id].length?e.nullRange[n.fid+n.uniq_id]=!0:e.defaultRange[n.fid+n.uniq_id]=e.handleNumberByFormatter(i.result.range,n.formatter,n.aggregator))});else{var a=l.range,s=angular.fromJson(a[0]).conditions;1==s.length?(e.innerFilterItems[n.fid+n.uniq_id].numOpt=s[0].calc_type,e.innerFilterItems[n.fid+n.uniq_id].numRange=[s[0].value]):s.length>1&&(e.innerFilterItems[n.fid+n.uniq_id].numOpt=12,e.innerFilterItems[n.fid+n.uniq_id].numRange=[s[0].value,s[1].value]),e.nullRange[n.fid+n.uniq_id]=!1,e.defaultRange[n.fid+n.uniq_id]=[]}})}},setInnerFilter:function(t){"custom_date"!==t.type?e.filter_list_inner[t.index].range=t.range||[]:(""==e.filter_list_inner[t.index].range&&(e.filter_list_inner[t.index].range=[]),e.filter_list_inner[t.index].range=t.range),t.type&&(t.hasOwnProperty("uniq_id")||(t.uniq_id=""),"string"===t.type?i(function(){e.innerFilterItems[t.fid].list=[],e.innerFilterItems[t.fid].keyword=""},10):"date"===t.type&&(e.filter_list_inner[t.index].range=t.range||[])),e.filter_list_inner[t.index].inner_adv_type="",e.filter_list_inner[t.index].is_defined=!1,e.filter_list_inner[t.index].range_type=1,e["show_custom_"+t.fid+t.uniq_id]=!1,e.show_options[t.fid+t.uniq_id]=!1,e.showLoading=!1,F(t.fid),m(),w&&l.close(w.id),w=null},setInnerFilterForNumber:function(i){var t="",r={condition_type:2,conditions:[]},n=e.innerFilterItems[i.fid+i.uniq_id];if(-1==n.numOpt)t=[];else if(12==n.numOpt){if("number"!=typeof n.numRange[0]||"number"!=typeof n.numRange[1])return void a(e.tips["filter.pleaseInputCondition"]);r.conditions.push({calc_type:4,value:n.numRange[0]}),r.conditions.push({calc_type:5,value:n.numRange[1]}),t=[angular.toJson(r)]}else{if("number"!=typeof n.numRange[0])return void a(e.tips["filter.pleaseInputCondition"]);r.conditions.push({calc_type:n.numOpt,value:n.numRange[0]}),t=[angular.toJson(r)]}e.numberConditionFormat(i.fid+i.uniq_id,n.numOpt,n.numRange),e.filter_list_inner[i.index].range=t,e.filter_list_inner[i.index].inner_adv_type="condition",e.filter_list_inner[i.index].is_defined=!1,e["show_custom_"+i.fid+i.uniq_id]=!1,i.hasOwnProperty("uniq_id")||(i.uniq_id=""),e.show_options[i.fid+i.uniq_id]=!1,F(i.fid),m()},openAdvanceModal:function(i,t){e.isQuery=!1,e.strFilter={fid:i.fid,uniq_id:i.uniq_id||"",name:i.name,granularity:i.granularity||"",keyword:"",data_type:i.data_type,is_compare:!!i.is_compare,searchList:[],originalSearchList:[],addList:[],inner_adv_type:i.inner_adv_type||"exact",range_type:"",condition_type:1,conditions:[],conditionList:[],expression_str:""},e.strFilter.range_type=i.hasOwnProperty("range_type")?i.range_type:1,e.conditionList=[],e.expressionChangedFlag=!1,e.checkFormulaGrammarFlag=!1,e.disabled_compare="C330"==e.opts.meta.type?!0:!1;var r=function(){var r=void 0==i.range?[]:i.range;angular.forEach(t,function(i){e.strFilter.searchList.push($.inArray(i,r)>-1?{name:i,select:!0}:{name:i,select:!1})}),e.strFilter.originalSearchList=angular.copy(e.strFilter.searchList)};if(i.inner_adv_type){if("exact"==i.inner_adv_type)e.strFilter.addList=angular.fromJson(i.range[0])||[],r();else if("condition"==i.inner_adv_type){e.strFilter.inner_adv_type="condition",r();var n=angular.fromJson(i.range[0]);e.strFilter.condition_type=n.condition_type,e.strFilter.conditions=n.conditions,angular.forEach(e.strFilter.conditions,function(t){e.strFilter.conditionList.push({name:i.name,operator:t.calc_type,content:t.value})})}else if("expression"==i.inner_adv_type){e.strFilter.inner_adv_type="expression",r(),e.strFilter.expression_str=i.range[0];var a=new RegExp("\\[_field_id_\\]","g");e.strFilter.expression_str=e.strFilter.expression_str.replace(a,"["+i.name+"]")}}else r(),angular.forEach(e.filter_list_inner,function(t){t.hasOwnProperty("uniq_id")||(t.uniq_id=""),t.fid==i.fid&&t.uniq_id==i.uniq_id&&(e.strFilter.addList=angular.copy(t.range))});e.originalFilter=angular.copy(e.strFilter),e.strInnerFilterDialog=l.open({template:"/static/partials/strInnerFilterModel.html",className:"ngdialog-theme-default str-filter-model dash-filter-adv-model",scope:e,preCloseCallback:function(){}})},addAdvanceItem:function(t,r){r&&r.stopPropagation();var n=!1;return $.inArray(t.name,e.strFilter.addList)>-1&&(n=!0),n?void a(e.tips["filter.itemExist"]):(e.strFilter.addList.push(t.name),void i(function(){var i=$(".add-list").find("ul"),e=i[0].scrollHeight;i.animate({scrollTop:e})},300))},delAdvanceItem:function(i,t){t&&t.stopPropagation();for(var r=e.strFilter.searchList,n=0,l=r.length;l>n;n++)if(r[n].name==e.strFilter.addList[i]){r[n].select=!1;break}e.strFilter.addList.splice(i,1)},addAll:function(){return 0==e.strFilter.addList.length?void angular.forEach(e.strFilter.searchList,function(i){e.strFilter.addList.push(i.name)}):void angular.forEach(e.strFilter.searchList,function(i){$.inArray(i.name,e.strFilter.addList)<0&&e.strFilter.addList.push(i.name)})},delAll:function(){e.strFilter.addList=[]},saveAdvance:function(){for(var i=e.filter_list_inner,t=function(e,t,r){var n=[];"exact"==t||"condition"==t?(i[e].rangeNumber=r.length,i[e].rangeFirstField=r[0],n.push(angular.toJson(r)),i[e].range=n):(i[e].rangeNumber=0,i[e].rangeFirstField="",n.push(r),i[e].range=n)},r=function(t,r){1==r?(e["show_custom_"+e.strFilter.fid+e.strFilter.uniq_id]=!0,i[t].is_defined=!0,e.is_defined=!0):0==r&&(i[t].inner_adv_type="",e["show_custom_"+e.strFilter.fid+e.strFilter.uniq_id]=!1,i[t].is_defined=!1)},n=0,l=i.length;l>n;n++){if(e.strFilter.hasOwnProperty("uniq_id")||(e.strFilter.uniq_id=""),i[n].fid==e.strFilter.fid&&i[n].uniq_id==e.strFilter.uniq_id){if(i[n].range_type=e.strFilter.range_type,i[n].range=e.strFilter.addList,i[n].is_compare=1&!!e.strFilter.is_compare,i[n].inner_adv_type=e.strFilter.inner_adv_type,"exact"==e.strFilter.inner_adv_type){if(0==e.strFilter.addList.length)return r(n,0),F(e.strFilter.fid),m(),void e.strInnerFilterDialog.close();t(n,"exact",e.strFilter.addList)}else if("condition"==e.strFilter.inner_adv_type){if(0==e.strFilter.conditionList.length)return r(n,0),F(e.strFilter.fid),m(),void e.strInnerFilterDialog.close();var o={condition_type:1,conditions:[]};o.condition_type=e.strFilter.condition_type,angular.forEach(e.strFilter.conditionList,function(i){o.conditions.push({calc_type:i.operator,value:i.content})}),t(n,"condition",o)}else if("expression"==e.strFilter.inner_adv_type){var s=e.checkFormulaGrammar(e.strFilter.name,e.strFilter.fid,"string");if(s)return s.then(function(i){i?(t(n,"expression",e.strFilter.expression_str),r(n,1),F(e.strFilter.fid),m(),e.strInnerFilterDialog.close()):a(e.tips["filter.checkFailed"])});return}return r(n,1),F(e.strFilter.fid),m(),void e.strInnerFilterDialog.close()}}},isShowFilter:function(i,t){return!!e["show_custom_"+i+t]},restoreFilter:function(){e.strFilter=e.originalFilter}},e.numberConditionFormatString={},e.numberConditionFormat=function(i,t,r){var n="",l="";switch(angular.forEach(u,function(i){i.value==Number(t)&&(l=i.text)}),t){case-1:n="en"==$.cookie("locale")?"All":"全部";break;case 0:case 1:case 2:case 3:case 4:case 5:n=l+" "+r[0];break;case 12:n=l+" "+r[0]+"~"+r[1];break;default:n=""}e.numberConditionFormatString[i]=n},e.is_defined=!1,e.checkFormulaGrammarFlag=!1,e.checkFormulaGrammar=function(i,t,n){if("string"==n){var l=e.strFilter.expression_str;if(""==l)return void a(e.tips["filter.pleaseInputExpression"]);if(l.indexOf(i)<0&&l.indexOf("[_field_id_]")<0)return void a(e.tips["filter.pleaseInputFieldName"]+": ["+i+"]");i=bdp.utils.requote(i);var o=new RegExp("\\["+i+"\\]","g");e.strFilter.expression_str=l.replace(o,"[_field_id_]");var s={ct_id:e.opts.meta.ct_id,tb_id:e.opts.meta.tb_id,fid:t,expression:e.strFilter.expression_str}}return e.expressionChangedFlag=!1,r.post("/api/expression/syntax_verify",s).then(function(i){return 0==i.status?(a(e.tips["filter.checkSuccess"]),e.checkFormulaGrammarFlag=!0,!0):(a(e.tips["filter.checkFailed"]),e.checkFormulaGrammarFlag=!1,!1)})},e.setExpression=function(i){e.strFilter.expression_str=i},e.expressionChanged=function(i){e.expressionChangedFlag=i},e.insertFieldNameToExpression=function(i){e.expressionChangedFlag=!0,e.$broadcast("insertFieldNameToExpression",i)},e.changeNumberOpt=function(i,n,l){if(e.tempDrillOption=e.$parent.drillOption?angular.copy(e.$parent.drillOption):{drill_field:"",drill_level:"",drill_value:[]},e.nullRange[n.fid+n.uniq_id]=!1,e.defaultRange[n.fid+n.uniq_id]=[],-1==l){e.rangeLoading=!0,e.chartOptions.optional.filter_list;var a=angular.copy(e.chartOptions.optional.filter_list)||[];if(a)for(var s=0;s<a.length;s++)a[s].fid==n.fid&&a[s].uniq_id==n.uniq_id&&(a[s].range=[]);r.get("/api/field/inner_range",{dsh_id:o.dashId,ct_id:i.ct_id,tb_id:i.tb_id,fid:n.fid,uniq_id:n.uniq_id,granularity:"",rule_id:t.global.rule_id,filter_list:angular.toJson(a),dsh_filter:angular.toJson(e.chartOptions.optional.dsh_filter?e.chartOptions.optional.dsh_filter:[]),drill_field:e.tempDrillOption.drill_field,drill_level:e.tempDrillOption.drill_level,drill_value:angular.toJson(e.tempDrillOption.drill_value)}).then(function(i){e.rangeLoading=!1,0==i.status&&(0==i.result.range.length&&(e.nullRange[n.fid+n.uniq_id]=!0),e.defaultRange[n.fid+n.uniq_id]=e.handleNumberByFormatter(i.result.range,n.formatter,n.aggregator))})}},e.handleNumberByFormatter=function(i,e,t){for(var r=2,n=0;n<i.length;n++)e?(""!==e[e.check].digit&&(r=e[e.check].digit),i[n]="num"==e.check&&e.num.millesimal?Highcharts.numberFormat(i[n],r,".",","):"num"==e.check?Highcharts.numberFormat(i[n],r,".",""):Highcharts.numberFormat(100*i[n],r,".","")+"%"):(("COUNT"==t||"COUNT_DISTINCT"==t)&&(r=0),i[n]=Highcharts.numberFormat(i[n],r));return i},e.setAdvanceAggregatorName=_,c(["filter.itemExist","filter.pleaseCheckGrammar","filter.checkSuccess","filter.checkFailed","filter.inputCompleteCondition","filter.pleaseInputCondition","filter.pleaseInputExpression","filter.pleaseInputFieldName","filter.pleaseSelectItem","filter.pleaseAddCondition","filter.hasChecked","chart.dateRangeRequired","filter.dateRangeInvalid","filter.startDateErr2","filter.endDateErr2"],e)},controller:["$scope",function(i){i.show_options={},i.isActive=!1,i.innerFilterItems={},i.$watch("opts",function(e){e&&(i.opts.meta.filter_list_inner?(i.filter_list_inner=angular.copy(i.opts.meta.filter_list_inner),0==i.filter_list_inner.length&&(i.show_filter=!1),i.isActive=!1,angular.forEach(i.filter_list_inner,function(e){if(i.show_filter=!0,void 0===e.range?e.range=[]:e.range.length>0&&(i.isActive=!0),"number"==e.data_type||"number"!=e.data_type&&e.hasOwnProperty("aggregator"))if(0==e.range.length)i.numberConditionFormatString[e.fid+e.uniq_id]="en"==$.cookie("locale")?"All":"全部";else{var t=angular.fromJson(e.range[0]),r=t.conditions;1==r.length?i.numberConditionFormat(e.fid+e.uniq_id,Number(r[0].calc_type),[r[0].value]):r.length>1&&i.numberConditionFormat(e.fid+e.uniq_id,12,[r[0].value,r[1].value])}"number"==e.data_type||"number"!=e.data_type&&e.hasOwnProperty("aggregator")?(e.hasOwnProperty("uniq_id")||(e.uniq_id=""),i.innerFilterItems[e.fid+e.uniq_id]={}):i.innerFilterItems[e.fid]={}})):i.opts.meta.filter_list=[])},!0),i.$watch("advDateList",function(e){e&&(i.adv_date_list=e)})}]}}])}();
;!function(){function t(t,r,n,i,o,l,d,g,s,c,_,p,u,m){function f(f,y,v){function h(e,t){var a=e[0],r=e[1],n=(t.week_start_day_of_week||1,new Date(a,0,1)),i=0==n.getDay()?7:n.getDay(),o=0;return o=1===i?7*(r-1):7*r-i,new Date(n.getTime()+864e5*o)}function b(e,t,a){var r=f.chart_ops.meta.level[f.drill_level][f.yAxis][t],n=null;n="num"===e?{check:"num",num:{digit:void 0!==a?a:2},percent:{digit:2}}:{check:"percent",num:{digit:0},percent:{digit:2}},r.formatter=angular.copy(n)}function x(e,t){return u.field.getFilteredRange(f.ct_id,t,e).then(function(e){var t=e;return 0==t.status?t.result:null})}function C(e){var t=e.date_field_type,a=1;if(defined(e.end)){var r,n,i,o,l,d="2"==e.end.type?e.end.offset:e.end.type,g=new Date;switch(t){case"day":g.setDate(g.getDate()-d);break;case"week":i=0===g.getDay()?7:g.getDay(),g.setDate(g.getDate()-(i-1)-7*d);break;case"month":r=g.getFullYear(),n=g.getMonth()+1,o=0==d?0:Math.ceil((d-n)/12),l=(n-d)%12,l>0?n-=d:0>l?(o=Math.ceil((d-n)/12),r-=o,n=n+12*o-d):(r-=Math.ceil(d/12),n=12),g.setYear(r),g.setMonth(n-1);break;case"quarter":r=g.getFullYear(),n=g.getMonth()+1,d=3*d,o=Math.ceil((d-n)/12),o=o?o:1,l=(n-d)%12,l>0?n-=d:0>l?(o=Math.ceil((d-n)/12),r-=o,n=n+12*o-d):(r-=o,n=12),g.setYear(r),g.setMonth(n-1);break;case"year":r=g.getFullYear(),o=d,r-=o,g.setYear(r)}var s=new Date(g.getFullYear(),g.getMonth(),g.getDate()).getTime();return bdpChart.helper.checkGranularity(t,s,"",a)}}var D=f.$eval(v.fieldFormula);f.dataType="number"===D.data_type?"number":"!number",f.yAxis=D.yAxis?D.yAxis:"y",f.formula_list=n,f.show_advance=!0,f.$watch(function(){return f.chart_ops.meta.chart_type||f.chart_ops.meta.level[f.drill_level].chart_type},function(e){return e?(f.is_gis="C400"===e,void(f.show_advance="C280"!==e&&!f.is_gis)):!1}),f.canSetAdvanceAggr=function(){var e=f.selected_type;return f.show_advance&&"C300"!==e&&"C330"!==e},f.setFormulaToField=function(e,t,a){if("more"!==t.type&&"PERCENTILE"!==t.type){var r=$(e.target).parents(".data-tag").parent().index(),n=t.type,i=t.name,o=f.chart_ops,l=f.is_gis?f.viewData.currentLayer:o.meta.level[f.drill_level],g=l[f.yAxis][r],c=l.bubble_setting,_=l.color_setting;if(""!==t.name&&f.is_gis&&l.type.indexOf("trajectory")>=0)return s(m.instant("chart.noAggregatorForTrajectory"));if(!n&&("C280"===l.chart_type||f.is_gis)&&c&&(c.fid&&1===+c.field.is_build_aggregated||"number"!==c.field.data_type))return s("数值字段计数方式为“无”时，只能使用非聚合数值作为尺寸"),void(a.show_formula=!1);if(!n&&("C280"===l.chart_type||f.is_gis)&&_&&_.field&&(_.field[0]&&_.field[0].fid&&1===+_.field[0].is_build_aggregated||"number"!==_.field[0].data_type))return s("数值字段计数方式为“无”时，只能使用非聚合数值作为颜色"),void(a.show_formula=!1);if(g.aggregator=n,g.aggregator_name=i,g.percent="","MED"===n&&(g.percent="0.5"),n.indexOf("PERCENT")>=0&&(g.percent=t.percent),a.show_formula=!1,a.drill_fields&&a.drill_fields.length&&(a.drill_fields[0].show_formula=!1),"COUNT"===g.aggregator||"COUNT_DISTINCT"===g.aggregator){var p=g.YoY||g.QoQ||g.yoyQoqSetting||g.advance_aggregator&&"cancel"!==g.advance_aggregator.type;p||g.formatter&&(g.formatter={check:"num",num:{digit:0},percent:{digit:0}})}if(f.is_gis&&l.y.length>0&&(t.type?(l.y.forEach(function(e){e===a||e.aggregator||1===+e.is_build_aggregated||(e.aggregator="number"===e.data_type?"SUM":"COUNT"),e.aggregator_name=d[e.aggregator]}),c&&c.fid&&!c.aggregator&&1!==+c.field.is_build_aggregated&&(c.aggregator="number"===c.field.data_type?"SUM":"COUNT")):(l.y.forEach(function(e){e!==a&&e.aggregator&&1!==+e.is_build_aggregated&&(e.aggregator="",e.aggregator_name="")}),c&&c.fid&&(c.aggregator=""))),"C280"===l.chart_type&&l.y.length+l.y_scatter.length===2){for(var u,y=a,v=l.y.concat(l.y_scatter),h=0,b=v.length;b>h;h++)if(v[h]!=y){u=v[h];break}t.type?(u.aggregator||1===+u.is_build_aggregated||(u.aggregator="number"===u.data_type?"SUM":"COUNT",u.aggregator_name=d[u.aggregator]),u.aggregator_name=d[u.aggregator],c&&c.fid&&!c.aggregator&&1!==+c.field.is_build_aggregated&&(c.aggregator="number"===c.field.data_type?"SUM":"COUNT")):u.aggregator&&1!==+u.is_build_aggregated&&(u.aggregator="",u.aggregator_name="",c&&c.fid&&(c.aggregator=""))}if(!(1!==l.y.length||"C280"===l.chart_type||l.y_optional&&l.y_optional.length)){var x=t.type;("COUNT"===t.type||"COUNT_DISTINCT"===t.type)&&(x="SUM")}var C=l[f.yAxis][r];!f.is_gis&&f.changeAggragatorForNumberFilter(C),f.$emit("emitChangeTableFormatting",!0),f.saveChartImmediate()}},f.setContrastField=function(e,t,a,r,n){var i=$(e.target).parents(".data-tag").parent().index(),o=f.chart_ops,l=o.meta.level[f.drill_level][f.yAxis][i];delete l.formatter,delete l.percentage,delete l.advance_aggregator;var d={check:"value"===n?"num":"percent",percent:{digit:2},num:{digit:2}};if(f.current_formula={},f.current_formula.formatter=d,l.formatter=d,"YoY"===a){if(t.YoY&&r===t.YoY&&(!t.yoyQoqType||n===t.yoyQoqType))return;delete l.QoQ,l.YoY=r,l.yoyQoqType=n}if("QoQ"===a){if(t.QoQ&&(!t.yoyQoqType||n===t.yoyQoqType))return;delete l.YoY,l.QoQ=o.meta.level[f.drill_level].x[0].granularity||"day",l.yoyQoqType=n}delete l.yoyQoqSetting,f.changeAggragatorForNumberFilter(l),f.saveChartImmediate()};var S={year:31536e6,quarter:7776e6,month:26784e5,week:6048e5,day:864e5,hour:36e5,minute:6e4,second:1e3};f.customYoYQoQ={updateSteppyItem:function(e,t,a){var r,n;"start"===e?(r=f.steppyStartDates=[],n=$("#steppyStart").find(".steppy-inner")):(r=f.steppyEndDates=[],n=$("#steppyEnd").find(".steppy-inner"));var i=a.granularity||"day",t=(a.granularity_name,new Date(t.getFullYear(),t.getMonth(),t.getDate())),o=t.getTime(),l={year:t.getFullYear(),month:t.getMonth(),dayInMonth:t.getDate(),dayInWeek:0===t.getDay()?7:t.getDay()};"week"===i&&(a.week_start_day_of_week||(a.week_start_day_of_week=1),l.dayInWeek>=a.week_start_day_of_week?o-=864e5*(l.dayInWeek-a.week_start_day_of_week):o+=864e5*(a.week_start_day_of_week-l.dayInWeek));for(var d=-10;11>d;d++)if("year"===i&&d>-10){var g=r[r.length-1];r.push(bdp.utils.isLeapYear(g)?g+316224e5:g+S[i])}else r.push(o+S[i]*d);n.css({width:1995,left:"-665px"})},addItems:function(e,t,a,r){c(function(){var n=7,i=95,o="start"===e?f.steppyStartDates:f.steppyEndDates;if(0===t){for(var l=0;n>l;l++)o.splice(0,0,o[0]-S[r]);a.css({width:a.width()+i*n,left:-i*n})}else{for(var l=0;n>l;l++)o.push(o[o.length-1]+S[r]);a.css({width:a.width()+i*n})}},10)},open:function(a){var a=a||e,r=$(a.target).parents(".data-tag").parent().index(),n=f.chart_ops,o=n.meta.level[f.drill_level],l=o.x[0].granularity||"day",d=o[f.yAxis][r];if(f.steppyStartDates=[],f.steppyEndDates=[],f.preCloseDialog=!1,delete d.show_formula,d.yoyQoqSetting){var g,s,c=d.yoyQoqSetting;"year"===l?(g=new Date(c.select_date[0],0,1),s=new Date(c.compare_date[0],0,1)):"quarter"===l?(g=new Date(c.select_date[0],3*c.select_date[1]-1),s=new Date(c.compare_date[0],3*c.compare_date[1]-1)):"month"===l?(g=new Date(c.select_date[0],c.select_date[1]-1),s=new Date(c.compare_date[0],c.compare_date[1]-1)):"week"===l?(g=h(c.select_date,o.x[0]),s=h(c.compare_date,o.x[0])):"day"===l&&(g=new Date(c.select_date[0],c.select_date[1]-1,c.select_date[2]),s=new Date(c.compare_date[0],c.compare_date[1]-1,c.compare_date[2])),f.customYoYQoQ.updateSteppyItem("start",g,o.x[0]),f.customYoYQoQ.updateSteppyItem("end",s,o.x[0])}else{f.preCloseDialog=!0,f.preCloseDialogSure=!1,d.yoyQoqSetting={checked:1,type:"custom",aggregator:1,compare_type:1,date_field_fid:o.x[0].fid,date_field_type:l},angular.forEach(o.y,function(e){return e.yoyQoqSetting?(d.yoyQoqSetting.date_field_fid=e.yoyQoqSetting.date_field_fid,void(d.yoyQoqSetting.date_field_type=e.yoyQoqSetting.date_field_type)):void 0}),angular.forEach(o.y_optional,function(e){return e.yoyQoqSetting?(d.yoyQoqSetting.date_field_fid=e.yoyQoqSetting.date_field_fid,void(d.yoyQoqSetting.date_field_type=e.yoyQoqSetting.date_field_type)):void 0});var _=new Date;f.customYoYQoQ.updateSteppyItem("start",_,o.x[0]),f.customYoYQoQ.updateSteppyItem("end",_,o.x[0])}var p=angular.copy(d);f.currentField=d,i.open({template:"/static/partials/set_custom_yoy.html",className:"ngdialog-theme-default custom-yoy-modal",data:{granularity:l},scope:f,preCloseCallback:function(){return delete d.show_formula,f.preCloseDialog?(f.preCloseDialogSure||delete o[f.yAxis][r].yoyQoqSetting,!0):angular.toJson(p)!==angular.toJson(d)?confirm(f.tips["chart.confirmCancelEdit"])?(o[f.yAxis][r]=angular.copy(p),!0):!1:void 0}}),t.$on("ngDialog.opened",function(){f.customYoYQoQ.loadScriptAsync(o)})},getSlideGrids:function(e){var t="start"===e?"#steppyStart":"#steppyEnd",a=95,r=$(t).find(".steppy-inner"),n=r.position(),i=n.left,o=Math.abs(i)/a+3;return Math.round(o)},getCompareRange:function(){var e,t,a=f.chart_ops.meta.level[f.drill_level],r=a.x[0].granularity||"day",n=(a.x[0].granularity_name,a.x[0].month_start_day||0),i=f.customYoYQoQ.getSlideGrids("start"),o=f.customYoYQoQ.getSlideGrids("end"),l=new Date(f.steppyStartDates[i]),d=new Date(f.steppyEndDates[o]),g={year:l.getFullYear(),month:l.getMonth()+1,dayInMonth:l.getDate(),dayInWeek:0===l.getDay()?7:l.getDay()},s={year:d.getFullYear(),month:d.getMonth()+1,dayInMonth:d.getDate(),dayInWeek:0===d.getDay()?7:d.getDay()};return"year"===r?(e=[g.year],t=[s.year]):"quarter"===r?(e=[g.year,Math.ceil(g.month/3)],t=[s.year,Math.ceil(s.month/3)]):"month"===r?(e=[g.year,g.month],t=[s.year,s.month]):"week"===r?(n=a.x[0].week_start_day_of_week||1,e=[g.year,bdpChart.helper.getWeekNumber(l.getTime(),n).week],t=[s.year,bdpChart.helper.getWeekNumber(d.getTime(),n).week]):"day"===r&&(e=[g.year,g.month,g.dayInMonth],t=[s.year,s.month,s.dayInMonth]),{select_date:e,compare_date:t}},save:function(){f.preCloseDialog=!0,f.preCloseDialogSure=!0;var e=f.currentField;e.formatter=2===+e.yoyQoqSetting.aggregator?{check:"percent",percent:{digit:2},num:{digit:0}}:{check:"num",num:{digit:2},percent:{digit:0}},delete e.percentage,delete e.advance_aggregator;var t=f.customYoYQoQ.getCompareRange();e.yoyQoqSetting.select_date=t.select_date,e.yoyQoqSetting.compare_date=t.compare_date,delete e.YoY,delete e.QoQ,delete e.yoyQoqType,f.saveChartImmediate()},loadScriptAsync:function(e){function t(){f.date={start:f.steppyStartDates[8],end:f.steppyEndDates[8]};var t=95,a={inner:".steppy-inner",item:".steppy-item",startindex:7,stepwidth:t,widthbetween:0},r=function(e){var n=$.extend({},e);$("#steppyStart").touchdraghsteppy($.extend(a,n,{events:{dragstop:function(){var e=$("#steppyStart").find(".steppy-inner"),a=e.position(),n=a.left,i=Math.abs(n)/t,o=f.steppyStartDates.length;(0===i||i>=o-7)&&(f.customYoYQoQ.addItems("start",i,e,granularity),c(function(){r({startindex:0===i?7:f.steppyStartDates.length-14})},20))}}}))},n=function(e){var r=$.extend({},e);$("#steppyEnd").touchdraghsteppy($.extend(a,r,{dragger:"#steppyStart",events:{dragstop:function(){var e=$("#steppyEnd").find(".steppy-inner"),a=e.position(),r=a.left,i=Math.abs(r)/t,o=f.steppyEndDates.length;(0===i||i>=o-7)&&(f.customYoYQoQ.addItems("end",i,e,granularity),c(function(){n({startindex:0===i?7:f.steppyEndDates.length-14})},20)),f.compareDate=f.steppyStartDates[i]}}}))},i=setInterval(function(){$("#steppyStart").length&&(clearInterval(i),r(),n())},300);f.$watch("date.start",function(t){t&&t!==f.steppyStartDates[8]&&f.customYoYQoQ.updateSteppyItem("start",t,e.x[0])}),f.$watch("date.end",function(t){t&&t!==f.steppyEndDates[8]&&f.customYoYQoQ.updateSteppyItem("end",t,e.x[0])}),window.TouchdragH="TouchdragH"}var a={funcQueue:[],loadLibInProgress:!1};thirdPluginLoader({initFun:t,libSrc:"https://m1.bdp.cn/static/js/chart/jquery.touchdragh_633f6b3.js",libId:window.TouchdragH},a)}},f.retentionEvents={addExceptField:function(e,t){return t?e.indexOf(t)>-1?!1:void e.push(t):void 0},delExceptField:function(e,t){e.splice(t,1)}},f.repetitionEvents={insertFieldNameToExpression:function(e){f.$broadcast("insertFieldNameToExpression",e)},setExpression:function(e){f.expression=e},checkFormulaGrammar:function(e){var t=e.setting.date_field_fid,a=f.fidToName[t],n=f.expression;if(!n)return s(f.tips["filter.pleaseInputExpression"]),!1;if(n.indexOf(a)<0&&n.indexOf("[_field_id_]")<0)return s(f.tips["filter.pleaseInputFieldName"]+": ["+a+"]"),!1;a=bdp.utils.requote(a);var i=new RegExp("\\["+a+"\\]","g"),o={ct_id:r.chartId,tb_id:f.chart_ops.tb_id,fid:t,expression:n.replace(i,"[_field_id_]")};return g.post("/api/expression/syntax_verify",o).then(function(t){return 0==t.status?(e.setting.calc_period.expression=o.expression,s(f.tips["filter.checkSuccess"]),!0):(s(f.tips["filter.checkFailed"]),!1)})}},f.formulaList=o(["sum","avg","min","max"]),f.setAdvanceAggregator=function(e,t,a){if(!$(e.target).hasClass("disabled")){var r,n,o=$(e.target).parents(".data-tag").parent().index(),l=f.chart_ops,d=l.meta.level[f.drill_level][f.yAxis][o];switch(d.advance_aggregator?r=d.advance_aggregator.type:d.advance_aggregator={},f.preCloseDialog=!1,delete d.show_formula,a){case"retention":case"activity":var g;if("activity"===a&&(i.closeAll(),g=localStorage.getItem("BDP_active_rate"),!g)){localStorage.setItem("BDP_active_rate",!0);{i.open({template:"/static/partials/dialogTemplates/first_active_rate.html",className:"ngdialog-theme-default",data:{e:e,field:t,type:a,know:f.setAdvanceAggregator}})}return!1}if(r!=a){f.preCloseDialog=!0,f.preCloseDialogSure=!1,d.advance_aggregator.setting={aggregator:"2",date_field_fid:"",date_field_type:"day",start:{range_type:"0",granularity:"day",range:[],date_range:[]},end:{type:"0",offset:"1",range_type:"0",date_range:[]},except_fields:[],checked:"1"};var s=l.meta.level[f.drill_level].x,c=d.advance_aggregator.setting;l.meta.level[0].x.length&&"date"===s[0].data_type&&(c.date_field_fid=s[0].fid,c.date_field_type=s[0].granularity,c.start.granularity=s[0].granularity),angular.forEach(l.meta.level[f.drill_level].y,function(e){e.advance_aggregator&&e.advance_aggregator.type===a&&(c.date_field_fid=e.advance_aggregator.setting.date_field_fid,c.date_field_type=e.advance_aggregator.setting.date_field_type)}),angular.forEach(l.meta.level[f.drill_level].y_optional,function(e){e.advance_aggregator&&e.advance_aggregator.type===a&&(c.date_field_fid=e.advance_aggregator.setting.date_field_fid,c.date_field_type=e.advance_aggregator.setting.date_field_type)})}n=angular.copy(d),i.open({template:"/static/partials/dialogTemplates/set_retention.html",className:"ngdialog-theme-default retention-modal activity-modal ngDialog-width-650",data:{type:a,field_index:o,meta:l.meta,setting:d.advance_aggregator.setting,text:"retention"===a?{title:f.tips["chart.retentionRateSetting"],rate:f.tips["chart.retentionRate"],num:f.tips["chart.retentionNumber"],typeText:f.tips["chart.retention"],period:f.tips["chart.retentionPeriod"]}:{title:f.tips["chart.activeRateSetting"],rate:f.tips["chart.activityRate"],num:f.tips["chart.activityNumber"],typeText:f.tips["chart.activity"],period:f.tips["chart.activePeriod"]}},scope:f,preCloseCallback:function(){return delete d.show_formula,f.preCloseDialog?!0:angular.toJson(n)!==angular.toJson(d)?confirm(f.tips["chart.notSave"])?(f.chart_ops.meta.level[f.drill_level][f.yAxis][o]=angular.copy(n),!0):!1:void 0}});break;case"repetition":var _;r!=a?(f.preCloseDialog=!0,f.preCloseDialogSure=!1,d.advance_aggregator.setting={aggregator:2,calc_type:1,calc_condition:{type:1,range:[1,2]},calc_period:{type:"fixed",fixed:{start:30,end:{type:0,value:1}},relative:{granularity:"week",week:{start:0,end:0},month:{start:0,end:0},quarter:{start:0,end:0},year:{start:0,end:0}},accurate:{start:"",end:""},expression:""}},_=d.advance_aggregator.setting,l.meta.level[0].x.length&&"date"===l.meta.level[0].x[0].data_type&&(_.date_field_fid=l.meta.level[0].x[0].fid,_.date_field_type=l.meta.level[0].x[0].granularity),angular.forEach(l.meta.level[f.drill_level].y,function(e){e.advance_aggregator&&"repetition"===e.advance_aggregator.type&&(_.date_field_fid=e.advance_aggregator.setting.date_field_fid,_.date_field_type=e.advance_aggregator.setting.date_field_type)}),angular.forEach(l.meta.level[f.drill_level].y_optional,function(e){e.advance_aggregator&&"repetition"===e.advance_aggregator.type&&(_.date_field_fid=e.advance_aggregator.setting.date_field_fid,_.date_field_type=e.advance_aggregator.setting.date_field_type)})):_=d.advance_aggregator.setting,n=angular.copy(d);var p=new RegExp("\\[_field_id_\\]","g");"expression"===_.calc_period.type&&(_.calc_period.expression=_.calc_period.expression.replace(p,"["+f.fidToName[_.date_field_fid]+"]")),i.open({template:"/static/partials/dialogTemplates/set_repetition.html",className:"ngdialog-theme-default repetition-modal",data:{field_index:o,meta:l.meta,setting:_},scope:f,preCloseCallback:function(){return delete d.show_formula,f.preCloseDialog?!0:angular.toJson(n)!==angular.toJson(d)?confirm(f.tips["chart.notSave"])?(f.chart_ops.meta.level[f.drill_level][f.yAxis][o]=angular.copy(n),!0):!1:void 0}});break;case"running":r!=a?(f.preCloseDialog=!0,f.preCloseDialogSure=!1,d.advance_aggregator.setting={method:"sum",reset_period:"all",running_start_type:0,running_start_date:new Date,checked:"1"}):void 0===d.advance_aggregator.setting.running_start_type&&(d.advance_aggregator.setting.running_start_type=0),n=angular.copy(d),i.open({template:"/static/partials/dialogTemplates/set_running.html",className:"ngdialog-theme-default running-modal",data:{field_index:o,meta:l.meta.level[f.drill_level],setting:d.advance_aggregator.setting,canSetPeriod:!l.meta.level[0].x[0].granularity_name},scope:f,preCloseCallback:function(){return delete d.show_formula,f.preCloseDialog?!0:angular.toJson(n)!==angular.toJson(d)?confirm(f.tips["chart.notSave"])?(f.chart_ops.meta.level[f.drill_level][f.yAxis][o]=angular.copy(n),!0):!1:void 0}});break;case"moving":r!==a&&(f.preCloseDialog=!0,f.preCloseDialogSure=!1,d.advance_aggregator.setting={method:"avg",prev_values:2,next_values:2}),n=angular.copy(d),i.open({template:"/static/partials/dialogTemplates/set_moving.html",className:"ngdialog-theme-default",data:{field_index:o,meta:l.meta,setting:d.advance_aggregator.setting},scope:f,preCloseCallback:function(){return delete d.show_formula,f.preCloseDialog?!0:angular.toJson(n)!==angular.toJson(d)?confirm(f.tips["chart.notSave"])?(f.chart_ops.meta.level[f.drill_level][f.yAxis][o]=angular.copy(n),!0):!1:void 0}});break;case"percentage":case"cancel":f.saveAdvanceAggregator(o,a)}}},f.saveAdvanceAggregator=function(e,t){f.preCloseDialog=!0,f.preCloseDialogSure=!0;var a=f.chart_ops.meta.level[f.drill_level][f.yAxis][e],r=a.advance_aggregator.setting,n=function(e,t){var a;if(a=["retention","activity"].indexOf(t)>-1?r[e].date_range:[r.calc_period.accurate.start,r.calc_period.accurate.end],["retention","activity"].indexOf(t)>-1&&[0,1].indexOf(+r[e].range_type)>-1){var n=+r[e].range_type;if(a=[],"start"===e){if(!isPositiveInteger(r[e].range[0]))return alert(f.tips["chart.retentionMustBeNumber"]),!1;if(1===n){if(!isPositiveInteger(r[e].range[1]))return alert(f.tips["chart.retentionMustBeNumber"]),!1}else r[e].range.splice(1,1)}else if("end"===e&&2===+r[e].type&&!isPositiveInteger(r[e].offset))return alert(f.tips["chart.dateMustBePositiveNumber"]),!1}else{if(["retention","activity"].indexOf(t)>-1&&(r[e].range=[]),a[0]&&a[1]&&new Date(a[1])-new Date(a[0])<0)return alert(f.tips["chart.dateRangeInvalid"]),!1;if(a[0]=a[0]?Highcharts.dateFormat("%Y-%m-%d",new Date(a[0])):"",a[1]=a[1]?Highcharts.dateFormat("%Y-%m-%d",new Date(a[1])):"","repetition"===t&&(r.calc_period.accurate.start=a[0],r.calc_period.accurate.end=a[1]),!a[0]&&!a[1])return void alert(f.tips["chart.dateRangeRequired"]);a[0]||(a[0]=null),a[1]||(a[1]=null)}return!0};switch(t){case"percentage":b("percent",e);break;case"cancel":delete a.formatter;break;case"retention":case"activity":if(!n("start",t)||!n("end",t))return;if(!r.date_field_fid)return alert(f.tips["chart.plzSelectDateField"]),!1;2===Number(r.aggregator)?b("percent",e):b("num",e,0),angular.forEach(f.chart_ops.meta.level[f.drill_level].y,function(a,n){n!==e&&a.advance_aggregator&&a.advance_aggregator.type===t&&(a.advance_aggregator.setting.except_fields=r.except_fields)}),angular.forEach(f.chart_ops.meta.level[f.drill_level].y_optional,function(a,n){n!==e&&a.advance_aggregator&&a.advance_aggregator.type===t&&(a.advance_aggregator.setting.except_fields=r.except_fields)});break;case"repetition":if(!("accurate"!==r.calc_period.type||n("start","repetition")&&n("end","repetition")))return;if(!r.date_field_fid)return alert(f.tips["chart.plzSelectDateField"]),!1;if(1===Number(r.calc_type)){if(!isPositiveInteger(r.calc_condition.range[0]))return alert(f.tips["chart.positiveNumber"]),!1;if(r.calc_condition.type>2&&!isPositiveInteger(r.calc_condition.range[0]))return alert(f.tips["chart.positiveNumber"]),!1}if(!("fixed"!==r.calc_period.type||isPositiveInteger(r.calc_period.fixed.start)&&isPositiveInteger(r.calc_period.fixed.end.value)))return alert(f.tips["chart.positiveNumber"]),!1;if(2===Number(r.aggregator)?b("percent",e):b("num",e,0),"expression"===r.calc_period.type){var i=f.repetitionEvents.checkFormulaGrammar(a.advance_aggregator);if(i)return i.then(function(e){e===!0&&(delete a.percentage,delete a.QoQ,delete a.YoY,delete a.yoyQoqType,delete a.yoyQoqSetting,a.advance_aggregator.type=t,f.saveChartImmediate())});return}break;case"moving":if(!isNaturalNumber(r.prev_values)||!isNaturalNumber(r.next_values))return alert(f.tips["chart.plzTypePositionInteger"]),!1;break;case"running":delete a.formatter,r.running_start_date=1===r.running_start_type?Highcharts.dateFormat("%Y-%m-%d",new Date(r.running_start_date)):null;var o=function(e){f.chart_ops.meta.level[f.drill_level][e]&&angular.forEach(f.chart_ops.meta.level[f.drill_level][e],function(e){e.advance_aggregator&&"running"===e.advance_aggregator.type&&(e.advance_aggregator.setting.running_start_date=r.running_start_date,e.advance_aggregator.setting.running_start_type=r.running_start_type)})};o("y"),o("y_optional")}delete a.percentage,delete a.QoQ,delete a.YoY,delete a.yoyQoqType,delete a.yoyQoqSetting,a.advance_aggregator.type=t;var l=f.chart_ops.meta.level[f.drill_level],d=l[f.yAxis][e];f.changeAggragatorForNumberFilter(d),"cancel"===t&&delete a.advance_aggregator,f.saveChartImmediate()},f.changeAggragatorForNumberFilter=function(e){function t(r){for(var n=0,i=r.length;i>n;n++)r[n].uniq_id==e.uniq_id&&(angular.forEach(a,function(t){e.hasOwnProperty(t)?r[n][t]=e[t]:r[n].hasOwnProperty(t)&&delete r[n][t]}),r[n].inner_show_name=e.name+f.setAdvanceAggregatorName(e)),r[n].items&&r[n].items.length>0&&t(r[n].items);return r}var a=["aggregator","aggregator_name","is_build_aggregated","advance_aggregator","yoyQoqType","yoyQoqSetting","YoY","QoQ","percentage"],r=f.chart_ops.meta.filter_list_inner;if(r instanceof Array)r=t(r);else for(var n=f.drill_level||0,i=0,o=r[n].length;o>i;i++)r[n]=t(r[n]);f.$emit("emitChangeTableFormatting",!0)},f.setNickName=function(t,a){t=t||e;var r=$(t.target).parents(".data-tag").parent().index(),n=a,o=f.is_gis?f.viewData.currentLayer:f.chart_ops.meta.level[f.drill_level];if(r>=0)var l=angular.copy(o[f.yAxis][r]);else if(n>=0)var l=angular.copy(o[f.yAxis][n]);i.open({template:"/static/partials/dialogTemplates/nick_name.html",className:"ngdialog-theme-default nick-model",data:{origin_name:l.nick_name,field_index:r>=0?r:n,field:l,save:f.saveNickName}})},t.setNickName=f.setNickName,f.saveNickName=function(e,a){function r(t){for(var a=0,n=t.length;n>a;a++)t[a].uniq_id==e.uniq_id&&(t[a].nick_name=e.nick_name,t[a].unit_adv=e.unit_adv),t[a].items&&t[a].items.length>0&&r(t[a].items);return t}{var n=f.is_gis?f.viewData.currentLayer:f.chart_ops.meta.level[f.drill_level],i=n.tb_statistic&&n.tb_statistic.row_setting,o=n[f.yAxis][a],l=o.fid,d=o.uniq_id;f.yAxis}if(o.nick_name=e.nick_name,o.unit_adv=e.unit_adv,o.description=e.description,"row_summary"==o.fid&&(i.nick_name=e.nick_name,i.unit_adv=e.unit_adv,i.description=e.description),"C310"===n.chart_type&&0===a&&(f.chart_ops.name=e.nick_name?e.nick_name:e.name),!f.is_gis){var g=f.chart_ops.meta.filter_list_inner;if(g instanceof Array)g=r(g);else for(var s=f.drill_level||0,c=0,_=g[s].length;_>c;c++)g[s]=r(g[s]);var p=n.color_setting&&0===+n.color_setting.mode;if(p&&n.color_setting.field.length>0)return void x(n.color_setting.field,f.tb_id).then(function(e){e.total<=100&&t.$emit("triggerBuildEnumColorMap",e.result)}).then(function(){f.$emit("emitChangeTableFormatting",!0),f.saveChartImmediate()})}if(n.advanced_sort&&n.advanced_sort.length>0)for(var c=0,_=n.advanced_sort.length;_>c;c++){{var u=n.advanced_sort[c],m=u.fid,y=u.uniq_id,v=!1;u.axis}if(d){if(y===d){v=!0,u.name=o.nick_name||u.originName;break}}else if(l=m){v=!0,u.name=o.nick_name||u.originName;break}}f.$emit("emitChangeTableFormatting",!0),f.saveChartImmediate()},f.setNumDigit=function(t){t=t||e;var a=$(t.target).parents(".data-tag").parent().index(),r=f.chart_ops,n=f.is_gis?f.viewData.currentLayer:r.meta.level[f.drill_level],o=2,l=angular.copy(n[f.yAxis][a]);if("COUNT"==l.aggregator||"COUNT_DISTINCT"==l.aggregator)o=0;else if(f.global.chartData&&f.global.chartData.y){var d;if("y_scatter"==f.yAxis){var g=a+r.meta.level[f.drill_level].y.length;d=f.global.chartData.y[g].formatter}else d=f.global.chartData[f.yAxis][a].formatter;o=d?d[d.check].digit:2}else o=l.formatter?l.formatter.num.digit:2;l.formatter||(l.formatter={check:"num",num:{digit:o||0,millesimal:!0},percent:{digit:o||0}}),i.open({template:"/static/partials/dialogTemplates/set_numdigit.html",className:"ngdialog-theme-default numdigit-model",data:{field:l,field_index:a},scope:f})},f.saveNumdigit=function(e,t){var a=e.formatter.check,r=e.formatter[a].digit,n=function(e){s("num"===e?f.tips["chart.numDigitInvalid"]:f.tips["chart.percentDigitInvalid"])};if(!defined(r)||!isInteger(r))return void n(a);if("num"===a&&(r>6||0>r)||"percent"===a&&(r>4||0>r))return void n(a);var i=f.is_gis?f.viewData.currentLayer:f.chart_ops.meta.level[f.drill_level],o=i.tb_statistic&&i.tb_statistic.row_setting;["C230","C320","C330","C360","C370"].indexOf(i.chart_type)>-1?i[f.yAxis].map(function(t){t.formatter=e.formatter}):i[f.yAxis][t]=e,o&&"row_summary"==e.fid&&(o.formatter=e.formatter),f.saveChartImmediate()},f.setPostFilter=function(e){var t=$(e.target).parents(".data-tag").parent().index(),r=f.is_gis?f.viewData.currentLayer:f.chart_ops.meta.level[f.drill_level],n=angular.copy(r[f.yAxis][t]);i.open({template:"/static/partials/dialogTemplates/post_filter.html",className:"ngdialog-theme-default aggr-filter-model",data:{conditions:n.post_filter?n.post_filter.conditions:[],enabled:n.post_filter&&0!=n.post_filter.enabled,onSave:function(e,a){var r=f.is_gis?f.viewData.currentLayer:f.chart_ops.meta.level[f.drill_level];e&&e.length?r[f.yAxis][t].post_filter={enabled:a?void 0:0,condition_type:2,conditions:e}:delete r[f.yAxis][t].post_filter,f.saveChartImmediate()}},scope:f,controller:a})},f.canSetSort=function(){var e=["C200","C210","C211","C212","C220","C240","C241","C242","C250","C290","C330","C350","C351","C352"],t=f.chart_ops.meta.chart_type||(f.chart_ops.meta.level[f.drill_level]?f.chart_ops.meta.level[f.drill_level].chart_type:"");return e.indexOf(t)>-1},f.setAxisSort=function(e,t,a){var r=$(event.target).parents(".data-tag").parent().index(),n=f.chart_ops.meta.level[f.drill_level],i=n[f.yAxis][r],o=n.tb_statistic&&n.tb_statistic.row_setting,l="sort",d={fid:i.fid,axis:"y",uniq_id:i.uniq_id,type:t};a.show_formula=!1,o&&"total"==i.flag&&(d.fid="row_summary",d.uniq_id=o.uniq_id),f.chart_ops.meta.level[f.drill_level][l]=d,n.is_advanced_sort=0,f.saveChartImmediate()},f.setStringFieldYoYQoQ=function(t){t=t||e;var a=$(t.target).parents(".data-tag").parent().index(),r=f.chart_ops;f.preCloseDialog=!1,f.current_formula=r.meta.level[f.drill_level][f.yAxis][a],delete f.current_formula.show_formula,f.current_formula.yoyQoqSetting||(f.preCloseDialog=!0,f.preCloseDialogSure=!1,f.current_formula.yoyQoqSetting={type:"qoq",aggregator:"1",date_field_fid:"",date_field_type:"day",compare_type:"1",granularity_name:"",start:{offset_to_end:"1"},end:{type:"0",offset:"0"},select_date_range:{start:"",end:""},compare_date_range:{start:"",end:""},checked:"1"},angular.forEach(r.meta.level[f.drill_level].y,function(e){if(e.yoyQoqSetting){var t=f.current_formula.yoyQoqSetting;return t.date_field_fid=e.yoyQoqSetting.date_field_fid,t.date_field_type=e.yoyQoqSetting.date_field_type,void(t.granularity_name=e.yoyQoqSetting.granularity_name)}}),angular.forEach(r.meta.level[f.drill_level].y_optional,function(e){if(e.yoyQoqSetting){var t=f.current_formula.yoyQoqSetting;return t.date_field_fid=e.yoyQoqSetting.date_field_fid,t.date_field_type=e.yoyQoqSetting.date_field_type,void(t.granularity_name=e.yoyQoqSetting.granularity_name)}}));var n=angular.copy(f.current_formula);g.post("/api/date_granularity/list",{tb_id:r.tb_id}).then(function(e){if(0==e.status){var t=e.result;f.customGranularity={year:[{day:1,month:1,name:"zh"==language?"自然年":"Natural Year",granularity_name:""}],month:[{day:1,name:"zh"==language?"自然月":"Natural Month",granularity_name:""}],week:[{day_of_week:1,name:"zh"==language?"自然周":"Natural Week",granularity_name:""}]},t.year.forEach(function(e){f.customGranularity.year.push($.extend(e,{granularity_name:e.name}))}),t.month.forEach(function(e){f.customGranularity.month.push($.extend(e,{granularity_name:e.name}))}),t.week.forEach(function(e){f.customGranularity.week.push($.extend(e,{granularity_name:e.name}))}),i.open({template:"/static/partials/set_string_field_yoy.html",className:"ngdialog-theme-default custom-string-yoy-modal",data:r,scope:f,preCloseCallback:function(){return delete f.current_formula.show_formula,f.preCloseDialog?(f.preCloseDialogSure||delete f.chart_ops.meta.level[f.drill_level][f.yAxis][a].yoyQoqSetting,!0):angular.toJson(n)!==angular.toJson(f.current_formula)?confirm(f.tips["chart.confirmCancelEdit"])?(f.chart_ops.meta.level[f.drill_level][f.yAxis][a]=angular.copy(n),!0):!1:void 0}})}});var o=f.current_formula.yoyQoqSetting;o&&(o.select_date_range&&o.select_date_range.start&&o.select_date_range.end&&(o.select_date_range.start=o.select_date_range.start,o.select_date_range.end=o.select_date_range.end),o.compare_date_range&&o.compare_date_range.start&&o.compare_date_range.end&&(o.compare_date_range.start=o.compare_date_range.start,o.compare_date_range.end=o.compare_date_range.end))},f.switchYoyGranularity=function(){f.current_formula.yoyQoqSetting.granularity_name="default"},f.switchCompareType=function(e){2==e&&(f.current_formula.yoyQoqSetting.date_field_type="day")},f.$watch("current_formula.yoyQoqSetting",function(e){e&&(f.yoyQoqDate=C(e))},!0),f.saveyoyQoqSetting=function(){f.preCloseDialog=!0,f.preCloseDialogSure=!0;var e=f.current_formula.yoyQoqSetting;if(!e.date_field_fid)return s(f.tips["chart.plzSelectDateField"]),!1;if("nodate_custom"===e.type&&"2"==e.compare_type){if(!e.select_date_range.start||!e.select_date_range.end)return s(f.tips["chart.plzSelectTime"]),!1;if(!e.compare_date_range.start||!e.compare_date_range.end)return s(f.tips["chart.plzCompareTime"]),!1}else if("nodate_custom"===e.type&&"1"==e.compare_type){if(!e.end.offset)return s(f.tips["chart.plzSelectTime"]),!1;if(!e.start.offset_to_end)return s(f.tips["chart.plzCompareTime"]),!1}"1"==e.checked?f.current_formula.formatter="2"==e.aggregator?{check:"percent",percent:{digit:2},num:{digit:0}}:{check:"num",num:{digit:2},percent:{digit:0}}:delete f.current_formula.formatter,delete f.current_formula.percentage,delete f.current_formula.advance_aggregator,delete f.current_formula.YoY,delete f.current_formula.QoQ,delete f.current_formula.yoyQoqType,f.changeAggragatorForNumberFilter(f.current_formula),f.saveChartImmediate()},f.setCustomPercentile=function(e,t){var a="";t.aggregator.indexOf("PERCENT")>=0&&t.percent&&[5,10,25,50,75,90,95].indexOf(100*t.percent)<0&&(a=100*t.percent),i.open({template:"/static/partials/dialogTemplates/set_custom_percentile.html",className:"ngdialog-theme-default ngDialog-width-300 set-custom-percentile",data:{customVal:a,event:e,field:t},scope:f})},f.savePercentileSetting=function(e,t,a){var r=new RegExp("^(\\d|[1-9]\\d|100)$");if(!r.test(a)||1>a||String(a).indexOf(".")>=0)return void s(f.tips["chart.inputIntBetweenZeroToHundred"]);var n={name:String(a),type:"PERCENT_"+a,show:"number",percent:a/100};
f.setFormulaToField(e,n,t)},f.isCustomPercentile=function(e){return""!=e.percent&&e.aggregator&&e.aggregator.indexOf("PERCENT")>=0&&[.05,.1,.25,.5,.75,.9,.95].indexOf(Number(e.percent))<0},f.goHelp=function(e){_(e)},f.setAlignmentMethod=function(e,t){var a=$(e.target).parents(".data-tag").parent(),r=a.index(),n=a.siblings().length,i=f.chart_ops.meta.level[f.drill_level],o=i[f.yAxis][r],l=i.tb_statistic,d="alignment_method";o[d]=t,(r==n&&l&&l.row&&"right"===l.row_pos||0==r&&l&&l.row&&"left"===l.row_pos)&&(l.row_setting[d]=t),f.saveChartImmediate()},f.setAdvanceAggregatorName=p,l(["chart.retentionMustBeNumber","chart.dateMustBePositiveNumber","chart.dateRangeInvalid","chart.dateRangeRequired","chart.plzSelectDateField","chart.plzTypePositionInteger","chart.digitInvalid","chart.numDigitInvalid","chart.percentDigitInvalid","chart.confirmCancelEdit","chart.topChartRange","chart.notSave","chart.positiveNumber","chart.retentionRateSetting","chart.retentionRate","chart.retentionNumber","chart.retention","chart.retentionPeriod","chart.activeRateSetting","chart.activity","chart.activePeriod","chart.activityRate","chart.activityNumber","chart.inputIntBetweenZeroToHundred","chart.plzCompareTime","chart.plzSelectTime"],f)}return{restrict:"A",transclude:!0,templateUrl:"/static/partials/formula_list.html",scope:!0,link:f,controller:angular.noop}}function a(e,t,a,r){function n(t){1==t.length?(e.filter.number_operator=t[0].calc_type,e.filter.number_both=t[0].value,e.filter.number_left="",e.filter.number_right=""):2==t.length?(e.filter.number_operator=12,e.filter.number_both="",4==t[0].calc_type?(e.filter.number_left=t[0].value,e.filter.number_right=t[1].value):(e.filter.number_left=t[1].value,e.filter.number_right=t[0].value)):e.filter.number_operator=e.operatorNumberMap[e.operatorNumberMap.length-1].value}function i(){if(!(e.filter.number_operator>=0))return void r(e.tips["filter.pleaseConfigCondition"]);var t=[],a=e.filter;if(12==a.number_operator){if("number"!=typeof a.number_left||"number"!=typeof a.number_right)return void r(e.tips["filter.pleaseInputCondition"]);t.push({calc_type:4,value:a.number_left}),t.push({calc_type:5,value:a.number_right})}else{if("number"!=typeof a.number_both)return void r(e.tips["filter.pleaseInputCondition"]);t.push({calc_type:a.number_operator,value:a.number_both})}return t}e.operatorNumberMap=a,e.filter_enabled=!1,e.filter={number_operator:"",number_both:"",number_left:"",number_right:""},e.confirmModify=function(){var a=i();(!e.filter_enabled||a)&&(e.filter_enabled||a||(a=[],t.global.hint=null),e.ngDialogData.onSave(a,e.filter_enabled))},n(e.ngDialogData.conditions),e.filter_enabled=!!e.ngDialogData.enabled,0===e.ngDialogData.conditions.length&&(e.filter_enabled=!0)}angular.module("BC.directives").directive("fieldFormula",t),t.$inject=["$rootScope","$stateParams","formula","ngDialog","$getCustomFormula","$jsTipTranslate","formulaKeyMap","commonHttp","errHint","$timeout","operatorHelpLink","setAdvanceAggregatorName","commonService","$translate"],a.$inject=["$scope","$rootScope","AdvfilterOperatorNumberMap","errHint"]}();
;!function(){function e(e,r,i,a,n,l,s,o,d,f){function c(t){function i(e,r){var i=!0;return angular.forEach(t.adv_date_list,function(a){r===a.name&&e!==a.opt_id&&1!=Number(a.is_global)&&(n(t.tips["filter.duplicatedNames"]),i=!1)}),i}function c(e){var r=t.adv_date_list;e===t.selected_opt_id&&r.length>0&&(t.selected_opt_id=r[0].opt_id,t.advDataModule.modify(t.selected_opt_id))}function u(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}var g=GlobalConstant.defaultAdvDateConfig;t.filter_list_require=[],t.getFilterList=function(){var e=t.chart_ops&&t.chart_ops.meta||{},r=e.chart_type;return"C400"===r?t.viewData.currentLayer?t.viewData.currentLayer.filter_list||[]:[]:e.filter_list||[]},t.getTbId=function(){var e=t.chart_ops.meta||{},r=e.chart_type;return"C400"===r?t.viewData.currentLayer?t.viewData.currentLayer.tb_id:"":t.chart_ops.tb_id},t.getLayerId=function(){return t.viewData&&t.viewData.currentLayer?scope.viewData.currentLayer.layer_id:""},t.advDateService={list:function(r){return e.adv_date.list(r).success(function(e){0===+e.status&&(t.adv_date_list=e.result,t.advanceView.empty=0==t.adv_date_list.length?!0:!1)})},modify:function(r,i,a,l){return e.adv_date.modify(r,i,a).success(function(e){if(0!==+e.status)n(Number(e.status));else{if(t.advDateService.list(r),n(i?t.tips.saveSuccess:t.tips.addSuccess),!i)return void(t.selected_opt_id=e.result.opt_id);i===t.getFilterList()[l].range[0]&&t.saveChartImmediate({},{closeDialog:!1})}})},info:function(r){0!=t.adv_date_list.length&&e.adv_date.info(r).success(function(e){if("0"==e.status){if(t.date=angular.fromJson(e.result),u(t.date))return;if("accurate"!==t.date.type?(t.date.accurate.start="",t.date.accurate.end=""):(t.date.accurate.start=e.result.accurate.start,t.date.accurate.end=e.result.accurate.end),t.date.fixed.hasOwnProperty("granularity")||(t.date.fixed.granularity="day"),"expression"===t.date.type){var r=new RegExp("\\[_field_id_\\]","g");t.date.expression=t.date.expression.replace(r,"["+t.current_config_field_name+"]"),s(function(){t.$broadcast("changeDateExpression",t.date.expression)},50)}else t.$broadcast("changeDateExpression","");t.original_is_global=t.date.is_global}else errorHandle(e)})},del:function(r,i,a,n,l){e.adv_date.del(i).success(function(e){0!==+e.status?errorHandle(e):(t.advDateService.list(r),a.range[0]===i&&(t.chart_ops.meta.filter_list[n].range=[],t.filterHandler.save({index:n,type:"date",range:[],closeDialog:!1})),l(i))})},order:function(t,r){e.adv_date.order(t,r).then(function(){})}},t.advDataModule={sort:{start:function(){},stop:function(){var e=[];angular.forEach(t.adv_date_list,function(t){e.push(t.opt_id)}),t.advDateService.order(a.chartId,angular.toJson(e))}},switchTab:function(e){t.date.type=e},modify:function(e){return"create"===e?(t.date=angular.copy(g),t.selected_opt_id=void 0,t.advanceView.empty=!1,t.original_is_global=0,void t.$broadcast("changeDateExpression",t.date.expression)):(t.advDateService.info(e),void(t.selected_opt_id=e))},save:function(){var e=t.date.accurate.start,r=t.date.accurate.end,l=t.selected_opt_id||"",s=a.chartId,o=t.date.name,d=t.date.type,f=t.date.is_global;if((0!=Number(f)||i(l,o))&&(1!==t.original_is_global||0!==Number(f)||confirm(t.tips["filter.changeScopeTip"]))){if("fixed"===d){if("0"===t.date.fixed.start)return n(t.tips["filter.inputPositiveNumber"]),!1;if(!isNaturalNumber(t.date.fixed.start)||!isNaturalNumber(t.date.fixed.end.value))return n(t.tips["chart.plzTypePositionInteger"]),!1}else if("accurate"===d){if("string"==typeof e&&(e=new Date(e)),"string"==typeof r&&(r=new Date(r)),!e&&!r)return alert(t.tips["filter.nullDate"]),!1;if(e.getTime()-r.getTime()>0)return alert(t.tips["chart.dateRangeInvalid"]),!1}else if("relative"===d);else if("expression"===d){var c=t.checkFormulaGrammar(t.current_config_field_name,t.date.fid,"date");if(c)return c.then(function(i){if(!i)return n(t.tips["filter.checkFailed"]),t.checkFormulaGrammarFlag=!1,!1;t.date.accurate.start=Highcharts.dateFormat("%Y-%m-%d",e),t.date.accurate.end=Highcharts.dateFormat("%Y-%m-%d",r);var a=angular.toJson(t.date);t.advDateService.modify(s,l,a,t.current_filter_index)});return}t.date.accurate.start=Highcharts.dateFormat("%Y-%m-%d",e),t.date.accurate.end=Highcharts.dateFormat("%Y-%m-%d",r);var u=angular.toJson(t.date);t.advDateService.modify(s,l,u,t.current_filter_index)}},del:function(e,r){var i=1==r.is_global?t.tips["filter.delTip"]:t.tips["filter.delTip2"];if(confirm(i)){var n=t.current_filter_index,l=t.getFilterList()[n];t.advDateService.del(a.chartId,e,l,n,c)}}},t.enum={config_choose:function(e){var r=t.stringConfig.options;return $.inArray(e,r)>-1?void n(t.tips["filter.itemExist"]):(t.stringConfig.keyword="",r.push(e),void(t.stringConfig.showList=!1))}},t.conditionList=[],t.operatorMap={0:"等于",1:"不等于",6:"包含",7:"不包含",10:"开头包含",11:"结尾包含"},t.operatorMap=o,t.operatorNumberMap={0:"等于",1:"不等于",2:"大于",3:"小于",4:"大于等于",5:"小于等于",12:"区间"},t.operatorNumberMap=d,t.AdvfilterOperatorList=f,t.new_condition={operator:"",content:""},t.addNewCondition=function(e,r){return void 0!=r&&r.hasOwnProperty("operator")&&""!==r.operator&&r.hasOwnProperty("content")&&""!=r.content?(t.conditionList.push({name:e,operator:r.operator,content:r.content}),angular.element(".new-condition").val(""),angular.element(".condition-select").val(""),t.new_condition={operator:"",content:""},void(t.$$phase||t.$digest())):void n(t.tips["filter.inputCompleteCondition"])},t.removeCondition=function(e){t.conditionList.splice(e,1)},t.addStrOpts=function(e,r){r&&r.stopPropagation();var i=!1;return $.inArray(e.name,t.strFilter.addList)>-1&&(i=!0),i?void n(t.tips["filter.hasTheFilter"]):(t.strFilter.addList.push(e.name),void s(function(){var e=$(".add-list").find("ul"),t=e[0].scrollHeight;e.animate({scrollTop:t})},300))},t.delStrOpts=function(e,r){r&&r.stopPropagation();for(var i=t.strFilter.searchList,a=0,n=i.length;n>a;a++)if(i[a].name==t.strFilter.addList[e]){i[a].select=!1;break}t.strFilter.addList.splice(e,1)},t.delAll=function(){t.strFilter.addList=[]},t.keyupFun=function(e){13==e.keyCode&&t.keyword_query()},t.keyword_query=function(){!t.strFilter.keyword,t.showLoading=!0;var e={fid:t.strFilter.fid,ct_id:a.chartId,tb_id:t.getTbId(),keyword:t.strFilter.keyword};r.get("/api/adv_enum/list",e).then(function(e){0==e.status&&(t.strFilter.searchList=[],t.showLoading=!1,angular.forEach(e.result,function(e){t.strFilter.searchList.push({name:e})}))})},t.addAll=function(){var e=[],r=t.strFilter.keyword;return r?angular.forEach(t.strFilter.searchList,function(t){t.name.toLowerCase().indexOf(r.toLowerCase())>-1&&e.push(t)}):e=angular.copy(t.strFilter.searchList),0==t.strFilter.addList.length?void angular.forEach(e,function(e){t.strFilter.addList.push(e.name)}):void angular.forEach(e,function(e){$.inArray(e.name,t.strFilter.addList)<0&&t.strFilter.addList.push(e.name)})},t.checkFormulaGrammarFlag=!1,t.checkFormulaGrammar=function(e,i,l){if(""==e&&(e=t.current_config_field_name),"string"==l||"sub_date"==l){var s=t.strFilter.expression_str;if(""==s)return void n(t.tips["filter.pleaseInputExpression"]);if(s.indexOf(e)<0&&s.indexOf("[_field_id_]")<0)return void n(t.tips["filter.pleaseInputFieldName"]+": ["+e+"]");e=bdp.utils.requote(e);var o=new RegExp("\\["+e+"\\]","g");t.strFilter.expression_str=s.replace(o,"[_field_id_]");var d={ct_id:a.chartId,tb_id:t.getTbId(),fid:i,expression:t.strFilter.expression_str}}else if("date"==l){var s=t.date.expression;if(""==s)return void n(t.tips["filter.pleaseInputExpression"]);if(s.indexOf(e)<0&&s.indexOf("[_field_id_]")<0)return void n(t.tips["filter.pleaseInputFieldName"]+": ["+e+"]");e=bdp.utils.requote(e);var o=new RegExp("\\["+e+"\\]","g");t.date.expression=s.replace(o,"[_field_id_]");var d={ct_id:a.chartId,tb_id:t.getTbId(),fid:t.current_fid,expression:t.date.expression}}else if("number"==l){var s=t.numberFilter.expression_str;if(""==s)return void n(t.tips["filter.pleaseInputExpression"]);if(s.indexOf(e)<0&&s.indexOf("[_field_id_]")<0)return void n(t.tips["filter.pleaseInputFieldName"]+": ["+e+"]");e=bdp.utils.requote(e);var o=new RegExp("\\["+e+"\\]","g");t.numberFilter.expression_str=s.replace(o,"[_field_id_]");var d={ct_id:a.chartId,tb_id:t.getTbId(),fid:i,expression:t.numberFilter.expression_str}}return t.expressionChangedFlag=!1,r.post("/api/expression/syntax_verify",d).then(function(e){return 0==e.status?(n(t.tips["filter.checkSuccess"]),t.checkFormulaGrammarFlag=!0,!0):(n(t.tips["filter.checkFailed"]),t.checkFormulaGrammarFlag=!1,!1)})},t.removeFilter=function(){t.is_new_add&&t.getFilterList().pop()},t.setFilterList=function(e){t.filterRangeList[e].list=[],angular.forEach(t.strFilter.addList,function(r){t.filterRangeList[e].list.push({name:r})}),t.filterRangeList[e].range=t.strFilter.addList},t.expressionChanged=function(e){t.expressionChangedFlag=e},t.insertFieldNameToExpression=function(e){t.expressionChangedFlag=!0,t.$broadcast("insertFieldNameToExpression",e)},l(["filter.duplicatedNames","filter.nullTitle","filter.nullDate","filter.delTip","filter.delTip2","filter.changeScopeTip","chart.plzTypePositionInteger","chart.dateRangeInvalid","filter.inputPositiveNumber","saveSuccess","addSuccess","filter.itemExist","filter.inputCompleteCondition","filter.hasTheFilter","filter.pleaseInputExpression","filter.pleaseInputFieldName","filter.pleaseCheckGrammar","filter.checkSuccess","filter.hasChecked","filter.checkFailed"],t)}return{restrict:"A",transclude:!0,replace:!0,templateUrl:"/static/partials/chart_filter.html",link:c,controller:t}}function t(e,t,r,i,a,n,l,s,o,d){function f(e){var i=e.tb_id,a=e.fid,n=e.ct_id;t.loading[a]=!0,r.field.getRange(i,a,n).success(function(r){t.loading[a]=!1,"0"==r.status?e.callback(r.result,a):errorHandle(r)})}function c(e,r){var i=e.data_type,a=e.range,n=e.total,l=t.getFilterList(),s=l.length-1;if(t["show_filter_"+r]=!0,"string"==i||"sub_date"==i)t.filterRangeList[r]={list:[],total:e.total,range:[]},angular.forEach(a,function(e){t.filterRangeList[r].list.push({name:e,check:!0})}),l[s].total=n,t.filterRangeList[r].range=a,t.filterRangeList[r].type="exact",t.filterRangeList[r].range_type=1,u(l[s].fid);else{var o=a?a:["",""];l[s].range=o,"number"==i&&(t.numRange["n"+s]={},t.numRange["n"+s].a=o[0],t.numRange["n"+s].b=o[1],t.initNumRange["n"+s]={},t.initNumRange["n"+s].a=o[0],t.initNumRange["n"+s].b=o[1])}"date"==i&&t.saveChartImmediate({not_need_redraw:"number"!==i,only_refresh_data:!1,is_drill_chart:!!$(".drill-crumbs").length})}function u(e,r){var i=t.getFilterList(),a=[];angular.forEach(i,function(i){if(i.fid==e){if(!t.filterRangeList[e])return;if(i.adv_type=r,i.range_type=t.strAdvFilter.range_type,"exact"==r)if(angular.forEach(t.filterRangeList[e].list,function(e){a.push(e.name)}),t.filterRangeList[e].range=a,t.filterRangeList[e].type=t.strAdvFilter.type,"date"===i.data_type)i.is_all=!1;else{var n=[];n.push(angular.toJson(a)),i.range=n,i.is_all=0===a.length||a.length===t.filterRangeList[e].list.length,i.is_all=!1}else if("condition"==r){t.loading[e]=!1,t.filterRangeList[e]={list:[],range:[],type:""},t.filterRangeList[e].range=angular.fromJson(t.strAdvFilter.config),t.filterRangeList[e].list=angular.fromJson(t.strAdvFilter.config),t.filterRangeList[e].type=t.strAdvFilter.type;var n=[];n.push(t.strAdvFilter.config),i.range=n,i.is_all=!1}else if("expression"==r){var n=[];n.push(t.strAdvFilter.config),i.range=n,i.is_all=!1}}})}function g(e,r){if(t.chart_ops.meta.filter_list_inner instanceof Array){var i=t.chart_ops.meta.filter_list_inner,a=function(t){angular.forEach(t,function(t){t.fid!=r||t.granularity?t.items.length>0&&a(t.items):t.range=e.range})};a(i)}else{var n=function(t){angular.forEach(t,function(t){t.hasOwnProperty("inner_adv_type")||(t.inner_adv_type=""),t.fid!=r||t.granularity||""!=t.inner_adv_type?t.items.length>0&&n(t.items):t.range=e.range})};if(t.chart_ops.meta.level_fields)for(var l=t.chart_ops.meta.level_fields.length||1,s=0;l>s;s++)n(t.chart_ops.meta.filter_list_inner[s])}}t.date_active={},t.numRange={},t.initNumRange={},t.selectAll={},t.filterRangeList=t.filterRangeList||{},t.loading={},t.advanceView={},e.dateTimeByHalfHour=d,t.goHelp=function(e){s(e)},t.filterHandler={startDelFilter:function(){angular.element(".gis-main,.chart-main,.chart-left-side").css({overflow:"visible"})},removePosition:function(){angular.element(".filter-layer").css({overflow:"visible"})},addFilter:function(){if(2==e.guide&&3==e.enterprise_type){if(8==e.guideStep)return!1;if(9==e.guideStep)return!1}if(1===t.dragField.is_build_aggregated)return l(t.tips["filter.buildAggregatedTip"]),!1;if(t.chart_ops&&!t.removeFaild){if(1===t.dragIsBuildAggregated)return l(t.tips["filter.buildAggregatedTip"]),!1;for(var r=t.getFilterList()||[],i=t.getTbId(),a=t.dragFieldFid,s=t.dragFieldName,o=t.dragFieldType,d=n.chartId,u=0;u<r.length;u++)if(a==r[u].fid)return alert(t.tips["filter.exist"]),!1;r.push({fid:a,name:s,data_type:o}),"string"==r[r.length-1].data_type&&t.strFilter.showAdvanceString("","",r.length-1,{fid:a,name:s,data_type:o}),"sub_date"==r[r.length-1].data_type&&t.strFilter.showAdvanceString("","",r.length-1,{fid:a,name:s,data_type:o}),"number"==r[r.length-1].data_type&&t.numberFilter.showAdvanceNumber("","",r.length-1,s),f({tb_id:i,fid:a,ct_id:d,data_type:o,callback:c})}},delFilter:function(e,r,a,l){var s=$(".filter-layer").width();t.show_custom_date&&(t.show_custom_date=!t.show_custom_date),angular.element(".gis-main,.chart-main,.chart-left-side,.filter-layer").css({overflow:""});var o=angular.element(".filter-layer").position().top;angular.element(".filter-layer").attr("style",""),angular.element(e.target).css("position","relative");var d=(Number($(e.target)[0].style.top.split("px")[0]),Number($(e.target)[0].style.left.split("px")[0]));if(angular.element(e.target).attr("style",""),d+s>0&&s>=d)return angular.element(".filter-layer").css({width:s+28,top:o}),void(t.removeFaild=!0);if(!("number"!=typeof a&&0>a)){var f=t.getFilterList(),c="";if("date"!=l&&("string"===l||"sub_date"===l?c="/api/adv_enum/delete":"number"===l&&(c="/api/adv_num/delete"),i.post(c,{ct_id:n.chartId,tb_id:t.getTbId(),layer_id:t.getLayerId(),fid:f[a].fid}).then(function(e){0!=e.status&&errorHandle(e)})),f.splice(a,1),angular.element(".filter-layer").css({width:s+28,top:o}),"string"===l){var u=t;t.saveChartImmediate({not_need_redraw:!0,only_refresh_data:!0,callback:function(){u.$broadcast("chartFilterChange",{saveChartOpts:{not_need_redraw:!1,only_refresh_data:!1,is_drill_chart:!!$(".drill-crumbs").length}})}})}else t.saveChartImmediate({not_need_redraw:!1,only_refresh_data:!1,is_drill_chart:!!$(".drill-crumbs").length})}},save:function(e){var r=e.index,i=e.range,a=t.getFilterList(),n=a[e.index].fid;if("number"==e.type){if((i[0]<t.initNumRange["n"+r].a||i[0]>t.initNumRange["n"+r].b)&&(a[r].range[0]=t.initNumRange["n"+r].a,i[0]=t.initNumRange["n"+r].a),(i[1]<t.initNumRange["n"+r].a||i[1]>t.initNumRange["n"+r].b)&&(a[r].range[1]=t.initNumRange["n"+r].b,i[1]=t.initNumRange["n"+r].b),isObjectEmpty(t.numRange["n"+r])&&(t.numRange["n"+r]={},t.numRange["n"+r]={}),t.numRange["n"+r].a==i[0]&&t.numRange["n"+r].b==i[1])return;t.numRange["n"+r].a=i[0],t.numRange["n"+r].b=i[1]}else"custom_date"==e.type&&(e.range=a[e.index].range=i);if(("date"==e.type||"custom_date"==e.type)&&(g(e,n),t.date_active[n]=e.range),"string"===e.type){var l=t;t.saveChartImmediate({not_need_redraw:!0,only_refresh_data:!0,getChartInfo:"date"!==e.type&&"custom_date"!==e.type,closeDialog:e.closeDialog!==!1,callback:function(){l.$broadcast("chartFilterChange",{saveChartOpts:{not_need_redraw:!1,only_refresh_data:!1,is_drill_chart:!!$(".drill-crumbs").length}})}})}else t.saveChartImmediate({not_need_redraw:!1,only_refresh_data:!1,is_drill_chart:!!$(".drill-crumbs").length,getChartInfo:"date"!==e.type&&"custom_date"!==e.type,closeDialog:e.closeDialog!==!1})},enterToSave:function(e,r){13==e.keyCode&&t.filterHandler.save(r)}},t.check_all=!0,t.filterItemHandler={getFilterRange:function(e,r,i){{var a=t.getFilterList()||[];t.getTbId(),n.chartId}if("string"!=e&&"sub_date"!=e||t["show_filter_"+r])if("number"==e){if(!a[i]||a[i].fid!=r)return;"condition"==a[i].adv_type?(t.loading[r]=!1,t.filterRangeList[r]={list:[],range:[],type:""},t.filterRangeList[r].range=angular.fromJson(a[i].range),t.filterRangeList[r].list=angular.fromJson(t.filterRangeList[r].range[0]),t.filterRangeList[r].type=a[i].adv_type,t["show_filter_"+r]=!t["show_filter_"+r]):"expression"==a[i].adv_type&&(t.loading[r]=!1,t.filterRangeList[r]={list:[],range:[],type:""},t.filterRangeList[r].range=angular.fromJson(a[i].range),t.filterRangeList[r].type=a[i].adv_type,t["show_filter_"+r]=!t["show_filter_"+r])}else t["show_filter_"+r]=!t["show_filter_"+r];else{if(!a[i]||a[i].fid!=r)return;if("exact"==a[i].adv_type){t.filterRangeList[r]={list:[],range:[],total:"",type:""},t.loading[r]=!1,t.filterRangeList[r].range_type=a[i].range_type,t.filterRangeList[r].range=a[i].range,t.filterRangeList[r].type=a[i].adv_type;var l=angular.fromJson(t.filterRangeList[r].range[0]);angular.forEach(l,function(e){t.filterRangeList[r].list.push({name:e})}),t["show_filter_"+r]=!t["show_filter_"+r]}else"condition"==a[i].adv_type?(t.loading[r]=!1,t.filterRangeList[r]={list:[],range:[],type:""},t.filterRangeList[r].range=angular.fromJson(a[i].range),t.filterRangeList[r].list=angular.fromJson(t.filterRangeList[r].range[0]),t.filterRangeList[r].type=a[i].adv_type,t["show_filter_"+r]=!t["show_filter_"+r]):"expression"==a[i].adv_type&&(t.loading[r]=!1,t.filterRangeList[r]={list:[],range:[],type:""},t.filterRangeList[r].range=angular.fromJson(a[i].range),t.filterRangeList[r].type=a[i].adv_type,t["show_filter_"+r]=!t["show_filter_"+r])}},isShowFilter:function(e){return!!t["show_filter_"+e]},setState:function(e){var r=t.filterRangeList[e],i=0;angular.forEach(r.list,function(e){e.check&&i++}),r.select_len=i},selectAll:function(e,r){t.filterRangeList[r].select_len=e?t.filterRangeList[r].list.length:0,angular.forEach(t.filterRangeList[r].list,function(t){t.check=e})},useConfig:function(e,r){e.is_config=r,angular.forEach(t.filterRangeList[e.fid].list,function(e){e.check=r})}},t.dateFilter={showFilterDatePicker:function(e,r){if(r.length>1){var i=r[0]?r[0].split(" ")[1]||"00:00:00":"00:00:00",n=r[1]?r[1].split(" ")[1]||"23:59:59":"23:59:59";r=r.concat([i,n])}else r=1===r.length&&r[0].indexOf("opt_")>-1?[+new Date,+new Date,"00:00:00","23:59:59"]:[+new Date,+new Date,"00:00:00","23:59:59"];a.open({template:"/static/partials/dialogTemplates/custom_date_modal.html",className:"ngdialog-theme-default date-picker-modal daterange-bdp-modal",data:{index:e,range:r},scope:t})},showAdvanceDate:function(e,r,i){t.current_config_field_name=r.name,t.current_fid=r.fid,t.current_filter_index=i,t.advanceView.empty=t.adv_date_list.length>0?!1:!0,t.checkFormulaGrammarFlag=!1,t.expressionChangedFlag=!1,e&&e.stopPropagation();var n=t.getFilterList()[i].range;1==n.length?t.selected_opt_id=n[0]:t.adv_date_list.length>0&&(t.selected_opt_id=t.adv_date_list[0].opt_id),t.selected_opt_id?t.advDataModule.modify(t.selected_opt_id):t.advanceView.empty=!0,a.open({template:"/static/partials/dialogTemplates/advance_date_filter.html",className:"ngdialog-theme-default advance-date-modal",scope:t})},setExpression:function(e){t.date.expression=e}},t.saveDateRange=function(e){var r=e.sDate?e.sDate+" "+e.sDateHour:null,i=e.eDate?e.eDate+" "+e.eDateHour:null;if(!r&&!i)return l(t.tips["chart.dateRangeRequired"]),!1;if(r&&i){if(!e.sDateHour)return l(t.tips["filter.startDateErr2"]),!1;if(!e.eDateHour)return l(t.tips["filter.endDateErr2"]),!1;if(new Date(r)-new Date(i)>0)return l(t.tips["filter.dateRangeInvalid"]),!1}else{if(r&&!i&&!e.sDateHour)return l(t.tips["filter.startDateErr2"]),!1;if(!r&&i&&!e.eDateHour)return l(t.tips["filter.endDateErr2"]),!1}t.filterHandler.save({range:[r,i],index:e.data.index,type:"custom_date"})},t.strFilter={fid:"",name:"",granularity:"",keyword:"",data_type:"string",is_compare:"",searchList:[],addList:[],condition_type:"",expression_str:"",type:"",total:0,showAdvanceString:function(e,i,l,s){if(e&&e.stopPropagation(),t.strFilter.total=0,t.strFilter.keyword="",t.strFilter.searchList=[],t.strFilter.addList=[],t.strFilter.conditionList=[],t.strFilter.condition_type=1,t.strFilter.expression_str="",t.checkFormulaGrammarFlag=!1,t.expressionChangedFlag=!1,i?(i.hasOwnProperty("range_type")||(i.range_type=1),t.strAdvFilter={ct_id:n.chartId,tb_id:t.getTbId(),layer_id:t.getLayerId(),type:i.adv_type,fid:i.fid,config:i.range,range_type:i.range_type,data_type:"string"},t.strFilter.fid=i.fid,t.strFilter.name=i.name,t.strFilter.granularity=i.granularity||"",t.strFilter.data_type=i.data_type,t.strFilter.adv_type=i.adv_type,t.strFilter.is_compare=!!i.is_compare,t.is_new_add=!1):(t.strAdvFilter={ct_id:n.chartId,tb_id:t.getTbId(),layer_id:t.getLayerId(),type:"exact",fid:t.dragFieldFid,config:[],range_type:1,data_type:"string"},t.strFilter.fid=s.fid,t.strFilter.name=s.name,t.strFilter.granularity="",t.strFilter.data_type=s.data_type,t.strFilter.adv_type="exact",t.strFilter.is_compare="",t.is_new_add=!0),t.current_filter_index=l,t.conditionList=[],t.current_config_field_name=t.strFilter.name,t.showLoading=!0,i)if(r.field.getRange(t.getTbId(),i.fid,n.chartId).success(function(e){"0"==e.status&&(t.strFilter.total=e.result.total,e.result.total>100,angular.forEach(e.result.range,function(e){t.strFilter.searchList.push({name:e})}),t.showLoading=!1)}),"exact"==i.adv_type){t.strFilter.addList=angular.fromJson(i.range[0])||[],t.filterRangeList[i.fid]={list:[],range:[],total:"",type:""},t.filterRangeList[i.fid].range_type=i.range_type,t.filterRangeList[i.fid].range=i.range,t.filterRangeList[i.fid].type=i.adv_type;var o=angular.fromJson(t.filterRangeList[i.fid].range[0]);angular.forEach(o,function(e){t.filterRangeList[i.fid].list.push({name:e})})}else if("condition"==i.adv_type){var d=angular.fromJson(i.range),f=angular.fromJson(d[0]);t.strFilter.condition_type=f.condition_type,angular.forEach(f.conditions,function(e){t.conditionList.push({name:i.name,operator:e.calc_type,content:e.value})}),t.filterRangeList[i.fid]={list:[],range:[],type:""},t.filterRangeList[i.fid].range=i.range,t.filterRangeList[i.fid].list=angular.fromJson(t.filterRangeList[i.fid].range[0]),t.filterRangeList[i.fid].type=i.adv_type}else if("expression"==i.adv_type){t.strFilter.expression_str=i.range[0];var c=new RegExp("\\[_field_id_\\]","g");t.strFilter.expression_str=t.strFilter.expression_str.replace(c,"["+i.name+"]"),t.filterRangeList[i.fid]={list:[],range:[],type:""},t.filterRangeList[i.fid].range=angular.fromJson(i.range),t.filterRangeList[i.fid].type=i.adv_type}i||(t.filterRangeList[t.strFilter.fid]={list:[],range:[],total:"",type:"",range_type:""},t.loading[t.strFilter.fid]=!1,t["show_filter_"+t.strFilter.fid]=!1,r.field.getRange(t.getTbId(),t.strFilter.fid,n.chartId).success(function(e){if("0"==e.status){t.strFilter.total=e.result.total,e.result.total>100;var r=t.getFilterList()||[],i=r.length-1;t.strFilter.searchList=[],angular.forEach(e.result.range,function(e){t.strFilter.searchList.push({name:e})}),t.selectAll[t.strFilter.fid]=1,r[i].total=e.result.total,u(r[i].fid,"exact"),t.showLoading=!1}else errorHandle(e)})),a.open({template:"/static/partials/dialogTemplates/advance_string_filter.html",className:"ngdialog-theme-default str-filter-model advance-string-modal ",scope:t,showClose:!1}),angular.element(".advance-string-modal .ngdialog-close").css("display","none"),angular.element(".advance-string-modal .search-list .query-text").val("")},saveAdvStrFilter:function(){var e=t.strAdvFilter.type;if("exact"==e){if(0==t.strFilter.addList.length)return void l(t.tips["filter.pleaseSelectItem"]);t.strAdvFilter.config=angular.toJson(t.strFilter.addList)}else if("condition"==e){if(0==t.conditionList)return void l(t.tips["filter.pleaseAddCondition"]);t.strAdvFilter.config={condition_type:1,conditions:[]},t.strAdvFilter.config.condition_type=t.strFilter.condition_type,angular.forEach(t.conditionList,function(e){t.strAdvFilter.config.conditions.push({calc_type:e.operator,value:e.content})}),t.strAdvFilter.config=angular.toJson(t.strAdvFilter.config)}else if("expression"==e){t.filterRangeList[t.strAdvFilter.fid].type=e;var r=t.checkFormulaGrammar(t.current_config_field_name,t.strFilter.fid,"string");if(r)return r.then(function(e){return e?(t.strAdvFilter.config=t.strFilter.expression_str,void t.strFilter.strFilterModify()):void l(t.tips["filter.checkFailed"])});return}t.filterRangeList[t.strAdvFilter.fid].range_type=t.strAdvFilter.range_type,t.filterRangeList[t.strAdvFilter.fid].type=e,t.strFilter.strFilterModify()},strFilterModify:function(){i.post("/api/adv_enum/modify",t.strAdvFilter).then(function(e){if(0==e.status){var r=t.strAdvFilter.fid,i=t.strAdvFilter.type;t["show_filter_"+r]=!0,"exact"==i?(t.setFilterList(r),u(r,i)):("condition"==i||"expression"==i)&&u(r,i),a.closeAll(),t.loading[r]=!1,t["show_filter_"+r]=!0,t.filterHandler.save({range:t.filterRangeList,index:t.current_filter_index,type:t.strAdvFilter.data_type})}})},setExpression:function(e){t.strFilter.expression_str=e}},t.numberFilter={number_operator:"",number_both:"",number_left:"",number_right:"",expression_str:"",field_name:"",type:"",showAdvanceNumber:function(e,i,l,s){e&&e.stopPropagation();var o=t.getTbId(),d=t.dragFieldFid,f=n.chartId;if(t.numberFilter.field_name=s,t.numberFilter.number_operator=12,t.numberFilter.type=i.adv_type||"condition",t.current_filter_index=l,t.current_config_field_name=s,t.checkFormulaGrammarFlag=!1,t.expressionChangedFlag=!1,i){if(t["show_filter_"+i.fid]=!0,t.numberAdvFilter={ct_id:n.chartId,tb_id:t.getTbId(),layer_id:t.getLayerId(),type:i.adv_type,fid:i.fid,config:i.range},"condition"==i.adv_type){var c=angular.fromJson(i.range),u=angular.fromJson(c[0]);1==u.conditions.length?(t.numberFilter.number_operator=u.conditions[0].calc_type,t.numberFilter.number_both=u.conditions[0].value,t.numberFilter.number_left="",t.numberFilter.number_right="",t.numberFilter.expression_str=""):(t.numberFilter.number_operator=12,t.numberFilter.number_both="",t.numberFilter.number_left=u.conditions[0].value,t.numberFilter.number_right=u.conditions[1].value,t.numberFilter.expression_str=""),t.filterRangeList[i.fid]={list:[],range:[],type:""},t.filterRangeList[i.fid].range=angular.fromJson(i.range),t.filterRangeList[i.fid].list=angular.fromJson(t.filterRangeList[i.fid].range[0]),t.filterRangeList[i.fid].type=i.adv_type}else if("expression"==i.adv_type){t.numberFilter.expression_str=i.range[0];var g=new RegExp("\\[_field_id_\\]","g");t.numberFilter.expression_str=t.numberFilter.expression_str.replace(g,"["+s+"]"),t.filterRangeList[i.fid]={list:[],range:[],type:""},t.filterRangeList[i.fid].range=angular.fromJson(i.range),t.filterRangeList[i.fid].type=i.adv_type}t.is_new_add=!1}else t.numberFilter.number_both="",t.numberFilter.number_left="",t.numberFilter.number_right="",t.numberFilter.expression_str="",t.numberAdvFilter={ct_id:n.chartId,tb_id:t.getTbId(),layer_id:t.getLayerId(),type:"condition",fid:t.dragFieldFid,config:[]},t.filterRangeList[t.strFilter.fid]={list:[],range:[],total:"",type:""},r.field.getRange(o,d,f).success(function(e){"0"==e.status&&(t.filterRangeList[d]={list:[],total:e.result.total,range:[],type:"condition"},t.filterRangeList[d].type="condition",t.filterRangeList[d].check_all=!1,t.selectAll[d]=1)}),t.is_new_add=!0;a.open({template:"/static/partials/dialogTemplates/advance_number_filter.html",className:"ngdialog-theme-default str-filter-model advance-string-modal advance-number-modal",scope:t,showClose:!1}),angular.element(".advance-number-modal .ngdialog-close").css("display","none")},saveAdvNumberFilter:function(){var e=t.numberAdvFilter.type;if("condition"==e){if(!(t.numberFilter.number_operator>=0))return void l(t.tips["filter.pleaseConfigCondition"]);if(t.numberAdvFilter.config={condition_type:2,conditions:[]},12==t.numberFilter.number_operator){if("number"!=typeof t.numberFilter.number_left||"number"!=typeof t.numberFilter.number_right)return void l(t.tips["filter.pleaseInputCondition"]);t.numberAdvFilter.config.conditions.push({calc_type:4,value:t.numberFilter.number_left}),t.numberAdvFilter.config.conditions.push({calc_type:5,value:t.numberFilter.number_right})}else{if(""==angular.element(".number-range .input-text-block")[0].value)return void l(t.tips["filter.pleaseInputCondition"]);t.numberAdvFilter.config.conditions.push({calc_type:t.numberFilter.number_operator,value:t.numberFilter.number_both})}}else if("expression"==e){var r=t.checkFormulaGrammar(t.current_config_field_name,t.numberAdvFilter.fid,"number");if(r)return r.then(function(e){return e?(t.numberAdvFilter.config=t.numberFilter.expression_str,void t.numberFilter.numberFilterModify()):void l(t.tips["filter.checkFailed"])});return}t.numberFilter.numberFilterModify()},numberFilterModify:function(){"condition"==t.numberAdvFilter.type&&(t.numberAdvFilter.config=angular.toJson(t.numberAdvFilter.config)),i.post("/api/adv_num/modify",t.numberAdvFilter).then(function(e){if(0==e.status){var r=t.numberAdvFilter.fid,i=t.numberAdvFilter.type,n=t.getFilterList();angular.forEach(n,function(e){if(e.fid==r){if(e.adv_type=i,t.filterRangeList[r]={list:[],range:[],type:i},!t.filterRangeList[r])return;if("condition"==i){t.loading[r]=!1,t.filterRangeList[r].range=angular.fromJson(t.numberAdvFilter.config),t.filterRangeList[r].list=angular.fromJson(t.numberAdvFilter.config);var a=[];a.push(t.numberAdvFilter.config),e.range=a,t.filterRangeList[r].type=i}else if("expression"==i){var a=[];a.push(t.numberAdvFilter.config),e.range=a,t.filterRangeList[r].type=i}e.is_all=!1}}),a.closeAll(),t.loading[r]=!1,t["show_filter_"+r]=!0,t.filterHandler.save({range:t.filterRangeList,index:t.current_filter_index,type:t.numberAdvFilter.data_type})}})},setExpression:function(e){t.numberFilter.expression_str=e}},o(["filter.buildAggregatedTip","filter.exist","chart.dateRangeRequired","filter.pleaseSelectItem","filter.pleaseAddCondition","filter.pleaseCheckGrammar","filter.pleaseInputExpression","filter.pleaseInputFieldName","filter.inputPositiveNumber","filter.pleaseConfigCondition","filter.pleaseInputNumber","filter.pleaseInputCondition","filter.itemsMoreThanOneHundred","filter.dateRangeInvalid","filter.startDateErr2","filter.endDateErr2"],t)}angular.module("BC.directives").directive("chartFilter",e),e.$inject=["commonService","commonHttp","ngDialog","$stateParams","errHint","$jsTipTranslate","$timeout","AdvfilterOperatorMap","AdvfilterOperatorNumberMap","AdvfilterOperatorList"],t.$inject=["$rootScope","$scope","commonService","commonHttp","ngDialog","$stateParams","errHint","operatorHelpLink","$jsTipTranslate","dateTimeByHalfHour"]}();
;angular.module("BC.directives").directive("exportDashboard",["ngDialog",function(t){return{link:function(a){a.showExportDialog=function(){t.open({templateUrl:"/static/partials/dialogTemplates/export_dash_modal.html",className:"ngdialog-theme-default export-img-modal export-dashboard-modal",scope:a,controller:"exportDashboardCtrl"})}}}}]).controller("exportDashboardCtrl",["$scope","$rootScope",function(t,a){function e(t){for(var a=t.find(".chart-canvas").length,e=[],r=window.devicePixelRatio||1,n=t.find(".chart-canvas"),o=0;a>o;o++){var i=n[o],d=Canvas2Image.convertToPNG(i,i.width,i.height).src,l='<img src="'+d+'" width="'+i.width/r+'" height="'+i.height/r+'" />';e.push(l)}return e}function r(t){var a=t.find(".chart-gis"),e=[],r=[];return a.each(function(t,a){var n=$(a).data("bdp-chart-instance").gisMap,o=n.exportImage(1).then(function(t){t[0].style.zIndex=0,e.push(t[0].outerHTML)});r.push(o)}),$.when.apply($,r).then(function(){return e})}function n(){var a=t.draw_chart_url;for(var e in a)a.hasOwnProperty(e)&&(t.draw_chart_url[e].lazyload=!1)}function o(){for(var t=$(".dash-wrapper .chart"),a=0,e=0,r=0,n=t.length;n>r;r++){var o=$(t[r]);o.hasClass("bdp-chart-loaded")&&a++,o.hasClass("bdp-chart-error")&&e++}return{total:n,loaded:a,error:e}}t.widthSetting="scale_1",t.state="init",t.exportSetting={scale:"scale_1",fixedWidth:1024},t.confirm=function(){var a={};switch(t.exportSetting.scale){case"scale_1":a.scale=1;break;case"scale_2":a.scale=2;break;case"fixed_width":+t.exportSetting.fixedWidth&&(a.width=+t.exportSetting.fixedWidth,a.width=Math.max(3600,a.width))}t.exportDashboard(a)};var i=null;t.exportDashboard=function(d){function l(){function n(){var a="light";1==window.usedThemeId&&(a="dark");var e=$.extend(!0,{dashboard:o,filename:t.dashTitle,originWidth:h[0].scrollWidth,data_type:"png",theme:a},d);Highcharts.post("/api/dashboard/export",e)}var o=h.prop("outerHTML");if(a.global.watterMark){var i=$("#watermarkStyle").prop("outerHTML");o=i+o}if(h.find(".chart-canvas").length>0){var l=e(h),c=new RegExp("<canvas.*></canvas>","gi"),s=0;o=o.replace(c,function(){return l[s++]})}h.find(".chart-gis").length>0?r(h).then(function(t){var a=document.createDocumentFragment(),e=document.createElement("div");a.appendChild(e),e.innerHTML=o;for(var r=e.querySelectorAll(".chart-gis"),i=0,d=r.length;d>i;i++)r[i].innerHTML=t[i]||"";o=e.innerHTML,n()},function(){alert("导出GIS失败")}):n(),t.closeThisDialog()}var c=t.loadedState=o(),h=$(".dash-wrapper");if(c.loaded===c.total)l();else{n();var s=6e4,p=1e3,u=+new Date;t.state="wait-chart-loading";var g=function(){var a=t.loadedState=o();a.loaded===a.total?l():+new Date-u>s?(alert("您还有图表没有加载完成, 暂不支持导出"),t.closeThisDialog()):i=setTimeout(g,p),t.$$phase||t.$digest()};i=setTimeout(g,p)}},t.$on("destroy",function(){i&&clearTimeout(i)})}]);
;!function(){angular.module("BC.directives").directive("chartInnerFilter",["commonHttp","$stateParams","$timeout","$rootScope","$filter","ngDialog","numberInnerFilterMap","errHint","$jsTipTranslate",function(e,t,n,i,r,a,l,o,d){return{restrict:"A",templateUrl:"/static/partials/chart_innerfilter.html",scope:!0,link:function(n){function r(e,t,i){var r=$(".chart-right"),a=r[0].getBoundingClientRect().left,l=t.fid,o=e.pageX<a-200?{left:0}:{right:0},d=bdp.utils.getArrayTextWidth(i,t);o.width=d,n.adjustWidth[l]=o}function s(e,t){function i(n){angular.forEach(n,function(n){n.fid==e?n.range=angular.copy(t):n.items&&n.items.length>0&&i(n.items)})}var r=n.chart_ops.meta.filter_list_inner;i(r)}function u(e,t){function i(n){angular.forEach(n,function(n){n.uniq_id==e&&"condition"==n.inner_adv_type?n.range=angular.copy(t):n.items&&n.items.length>0&&i(n.items)})}var r=n.getCurrentLayerFilter(n.chart_ops.meta.filter_list_inner);i(r)}function _(e,t){function i(n){angular.forEach(n,function(n){n.hasOwnProperty("inner_adv_type")||(n.inner_adv_type=""),n.fid==e&&""==n.inner_adv_type?n.range=angular.copy(t):n.items&&n.items.length>0&&i(n.items)})}for(var r=n.chart_ops.meta.level_fields.length||1,a=[],l=0;r>l;l++)a=n.chart_ops.meta.filter_list_inner[l],i(a)}n.adjustWidth={},n.$watch("currentLevelInnerFilter",function(e){if(e){var t=angular.copy(e);n.innerFilterList=angular.copy(bdp.utils.handleInnerFilterLevel(t))}},!0),n.$watch("innerFilterList",function(e){e&&angular.forEach(e,function(e){n.innerList[e.fid]||(n.innerList[e.fid]={})})},!0),n.queryKwd={},n.enterToQuery=function(e){13==e.e.keyCode&&(e.real_search?n.innerQrueryField(e.filter,e.is_advance):n.innerList[e.filter.fid].keyword=n.queryKwd[e.filter.fid])},n.innerQrueryField=function(r){n.showLoading=!0;var a=r.fid,l=n.queryKwd[a]||n.innerList[a].keyword;if(!l)return void(n.showLoading=!1);var o={ct_id:t.chartId,tb_id:n.chart_ops.tb_id,fid:a,rule_id:i.global.rule_id,keyword:l,granularity:r.granularity||""};e.get("/api/adv_enum/search",o).then(function(e){n.showLoading=!1,0==e.status&&(n.tempQueryList=angular.copy(n.innerList[a].list),n.innerList[a].list=e.result)})},n.delQueryField=function(e){n.tempQueryList&&(n.innerList[e].list=n.tempQueryList||[]),n.innerList[e].keyword="",n.queryKwd[e]=""},n.getInnerFilterList=function(i,a){if(!a.disabled&&!a.recent_date_button){a.hasOwnProperty("uniq_id")||(a.uniq_id=(new Date).getTime());for(var l in n.show_options)l!=a.fid+a.uniq_id&&(n.show_options[l]=!1);if(n.show_options[a.fid+a.uniq_id]=!n.show_options[a.fid+a.uniq_id],n.show_options[a.fid+a.uniq_id]){if("date"===a.data_type&&!a.granularity)return void r(i,a,n.adv_date_list);var o=a.fid;n.innerList[o]||(n.innerList[o]={});var d=n.chart_ops.meta.filter_list,s=!1,u=[],_=0,f=!1;angular.forEach(d,function(e){e.fid==o&&(s=!0,u=e.range,_=e.total,f=e.is_all)}),n.showLoading=!0,n.tempDrillOption=n.drillOption?angular.copy(n.drillOption):{drill_field:"",drill_level:"",drill_value:[]},e.get("/api/field/inner_range",{ct_id:t.chartId,tb_id:n.chart_ops.tb_id,fid:o,granularity:a.granularity||"",level:n.drill_level||0,drill_field:n.tempDrillOption.drill_field,drill_level:n.tempDrillOption.drill_level,drill_value:angular.toJson(n.tempDrillOption.drill_value)}).then(function(e){0==e.status&&(r(i,a,e.result.range),n.innerList[o].keyword="",n.innerList[o].list=e.result.range,n.innerList[o].total=e.result.total,n.innerList[o].is_all=!0,n.showLoading=!1)})}}},n.defaultRange={},n.nullRange={},n.numberInnerFilterMap=l,n.getInnerFilterListForNumber=function(i,r){n.tempDrillOption=n.drillOption?angular.copy(n.drillOption):{drill_field:"",drill_level:"",drill_value:[]},r.hasOwnProperty("uniq_id")||(r.uniq_id=(new Date).getTime());for(var a in n.show_options)a!=r.fid+r.uniq_id&&(n.show_options[a]=!1);if(n.show_options[r.fid+r.uniq_id]=!n.show_options[r.fid+r.uniq_id],n.show_options[r.fid+r.uniq_id]){var l=angular.copy(n.currentLevelInnerFilter);if(n.chart_ops.meta.filter_list_inner instanceof Array)l=angular.copy(n.chart_ops.meta.filter_list_inner);else{var o=n.drill_level||0;l=angular.copy(n.chart_ops.meta.filter_list_inner[o])}l=angular.copy(bdp.utils.handleInnerFilterLevel(l));var d=r.formatter||"";n.nullRange[r.fid+r.uniq_id]=!1,angular.forEach(l,function(i){if(i.uniq_id==r.uniq_id)if(0==i.range.length)n.showLoading=!0,e.get("/api/field/inner_range",{ct_id:t.chartId,tb_id:n.chart_ops.tb_id,fid:r.fid,uniq_id:r.uniq_id,level:n.drill_level||0,granularity:"",drill_field:n.tempDrillOption.drill_field,drill_level:n.tempDrillOption.drill_level,drill_value:angular.toJson(n.tempDrillOption.drill_value)}).then(function(e){0==e.status&&(n.showLoading=!1,n.innerList[r.fid].numOpt=-1,n.innerList[r.fid].numRange=[],n.defaultRange[r.fid+r.uniq_id]=e.result.range,0==n.defaultRange[r.fid+r.uniq_id].length?n.nullRange[r.fid+r.uniq_id]=!0:n.defaultRange[r.fid+r.uniq_id]=n.handleNumberByFormatter(n.defaultRange[r.fid+r.uniq_id],d,r.aggregator))});else{var a=i.range;n.defaultRange[r.fid+r.uniq_id]=[];var l=angular.fromJson(a[0]).conditions;1==l.length?(n.innerList[r.fid].numOpt=l[0].calc_type,n.innerList[r.fid].numRange=[l[0].value]):l.length>1&&(n.innerList[r.fid].numOpt=12,n.innerList[r.fid].numRange=[l[0].value,l[1].value]),n.nullRange[r.fid+r.uniq_id]=!1}})}},n.getCurrentLayerFilter=function(e){var t=n.drill_level||0,i=[];return i=e instanceof Array?e:e[t]},n.handleNumberByFormatter=function(e,t,n){for(var i=2,r=0;r<e.length;r++)t?(""!==t[t.check].digit&&(i=t[t.check].digit),e[r]="num"==t.check&&t.num.millesimal?Highcharts.numberFormat(e[r],i,".",","):"num"==t.check?Highcharts.numberFormat(e[r],i,".",""):Highcharts.numberFormat(100*e[r],i,".","")+"%"):(("COUNT"==n||"COUNT_DISTINCT"==n)&&(i=0),e[r]=Highcharts.numberFormat(e[r],i));return e},n.changeNumberOpt=function(i,r){n.defaultRange[i.fid+i.uniq_id]=[],-1==r&&(n.rangeLoading=!0,e.get("/api/field/inner_range",{ct_id:t.chartId,tb_id:n.chart_ops.tb_id,fid:i.fid,uniq_id:i.uniq_id,level:n.drill_level||0,granularity:""}).then(function(e){n.rangeLoading=!1,0==e.status&&(n.defaultRange[i.fid+i.uniq_id]=n.handleNumberByFormatter(e.result.range,i.formatter,i.aggregator))}))},n.$watch("chart_ops",function(e){},!0),n.modifyInnerFilter=function(e){n.chart_ops.meta.filter_list_inner instanceof Array?("date"!=e.data_type||e.granularity||angular.forEach(n.chart_ops.meta.filter_list,function(t){t.fid==e.fid&&(t.range=e.range)}),s(e.fid,e.range),n.show_options[e.fid]=!1):("date"!=e.data_type||e.granularity||angular.forEach(n.chart_ops.meta.filter_list,function(t){t.fid==e.fid&&(t.range=e.range)}),n.show_options[e.fid+e.uniq_id]=!1,_(e.fid,e.range)),n.saveChartImmediate({not_need_redraw:!1,only_refresh_data:!1,is_drill_chart:!!n.drill_level})},n.modifyInnerFilterForNumber=function(e){if("number"==e.data_type||"number"!=e.data_type&&e.hasOwnProperty("aggregator")){var t=n.innerList[e.fid],i={condition_type:2,conditions:[]};if(-1==t.numOpt)e.range=[];else if(12==t.numOpt){if("number"!=typeof t.numRange[0]||"number"!=typeof t.numRange[1])return void o(n.tips["filter.pleaseInputCondition"]);i.conditions.push({calc_type:4,value:t.numRange[0]}),i.conditions.push({calc_type:5,value:t.numRange[1]}),e.range=[angular.toJson(i)]}else{if("number"!=typeof t.numRange[0])return void o(n.tips["filter.pleaseInputCondition"]);i.conditions.push({calc_type:t.numOpt,value:t.numRange[0]}),e.range=[angular.toJson(i)]}}n.show_options[e.fid+e.uniq_id]=!1,u(e.uniq_id,e.range),n.saveChartImmediate({not_need_redraw:!1,only_refresh_data:!1,is_drill_chart:!!n.drill_level})},n.showInnerFilterDatePicker=function(e,t){if(t.length>1){var i=t[0]?t[0].split(" ")[1]||"00:00:00":"00:00:00",r=t[1]?t[1].split(" ")[1]||"23:59:59":"23:59:59";t=t.concat([i,r])}else t=1===t.length&&t[0].indexOf("opt_")>-1?[+new Date,+new Date,"00:00:00","23:59:59"]:[+new Date,+new Date,"00:00:00","23:59:59"];a.open({template:"/static/partials/dialogTemplates/custom_date_modal.html",className:"ngdialog-theme-default date-picker-modal daterange-bdp-modal",data:{index:e,range:t},scope:n})},n.saveDateRange=function(e){var t=e.sDate?e.sDate+" "+e.sDateHour:null,i=e.eDate?e.eDate+" "+e.eDateHour:null;if(!t&&!i)return o(n.tips["chart.dateRangeRequired"]),!1;if(t&&i){if(!e.sDateHour)return o(n.tips["filter.startDateErr2"]),!1;if(!e.eDateHour)return o(n.tips["filter.endDateErr2"]),!1;if(new Date(t)-new Date(i)>0)return o(n.tips["filter.dateRangeInvalid"]),!1}else{if(t&&!i&&!e.sDateHour)return o(n.tips["filter.startDateErr2"]),!1;if(!t&&i&&!e.eDateHour)return o(n.tips["filter.endDateErr2"]),!1}var r=[t,i],a=n.innerFilterList[e.data.index].fid;angular.forEach(n.chart_ops.meta.filter_list,function(e){e.fid==a&&(e.range=r)}),n.chart_ops.meta.filter_list_inner instanceof Array?s(a,r):_(a,r),n.saveChartImmediate({},{not_need_redraw:!0,only_refresh_data:!1,is_drill_chart:!1})},d(["filter.pleaseInputCondition"],n)},controller:["$scope",function(e){e.show_options={},e.innerList={},e.$watch("innerFilterList",function(t){t&&angular.forEach(t,function(t){e.innerList[t.fid]={list:[]}})})}]}}]).directive("chartInnerFilterLevel",["commonHttp","$stateParams","ngDialog","errHint","operatorHelpLink","formulaKeyMap","commonService","dateNameMap","setAdvanceAggregatorName","$timeout",function(e,t,n,i,r,a,l,o,d,s){return{restrict:"A",templateUrl:"/static/partials/chart_innerfilter_level.html",scope:{opts:"=",chartid:"=",save:"=",fields:"="},link:function(t){function a(){t.save({not_need_redraw:!1,only_refresh_data:!1,is_drill_chart:!!t.$parent.drill_level,getChartInfo:"innerFilter"})}function u(e){return"condition"==e.inner_adv_type?!0:!1}function _(e,t,n){function i(e,t,n){var r=!1;angular.forEach(n,function(a,l){a.hasOwnProperty("uniq_id")||(a.uniq_id=""),a.fid==e&&a.uniq_id==t&&(n.splice(l,1),r=!0),a.items&&a.items.length>0&&!r&&i(e,t,a.items)})}i(e,t,n)}function f(e,t){function n(t){angular.forEach(t,function(t){e.fid==t.fid?("date"==e.data_type?(t.range=t.granularity==e.granularity?e.range||[]:[],t.granularity=e.granularity,t.show_all=e.show_all,t.recent_date_button=e.recent_date_button):(t.show_all=e.show_all,t.recent_date_button=e.recent_date_button),t.inner_adv_type=e.inner_adv_type||""):t.items&&t.items.length>0&&n(t.items)})}n(t)}function c(e){var n=t.opts.meta.filter_list,i=void 0;return angular.forEach(n,function(t){t.fid==e.fid&&(i=t.range)}),i}t.goHelp=function(e){r(e)},t.addList=[],t.enableSort=!0,t.originalSortData={},t.treeOptions={beforeDrag:function(){return console.log("Is saving chart complete ?: ",!t.$parent.loadingData),!t.$parent.loadingData},beforeDrop:function(){t.originalSortData=angular.copy(t.currentLevelInnerFilter)},dragStop:function(e){function n(e,t){_=!1,angular.forEach(e,function(e,n){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),e.fid==t.fid&&""==e.inner_adv_type&&(v={},m=n,g=!0)})}function i(e,t){_=!1,angular.forEach(e,function(e){e.items&&e.items.length>0&&angular.forEach(e.items,function(n,i){n.hasOwnProperty("inner_adv_type")||(n.inner_adv_type=""),n.fid==t.fid&&""==n.inner_adv_type&&(v=e,m=i,_=!0)}),e.items&&e.items.length>0&&!_&&i(e.items,t)})}function r(e,t){return p=!1,y={},angular.forEach(e,function(n,i){n.hasOwnProperty("inner_adv_type")||(n.inner_adv_type=""),n.fid==t.fid&&""==n.inner_adv_type&&(y=n,e.splice(i,1),p=!0)}),p||angular.forEach(e,function(e){e.items&&e.items.length>0&&angular.forEach(e.items,function(n,i){n.hasOwnProperty("inner_adv_type")||(n.inner_adv_type=""),n.fid==t.fid&&""==n.inner_adv_type&&(y=n,e.items.splice(i,1),p=!0)}),e.items&&e.items.length>0&&!p&&r(e.items,t)}),y}function l(e,t,n){if(_=!1,g)if(m>=e.length)e.push(n);else{for(var i=[],r=0,a=e.length;a>r;r++)r==m&&i.push(n),i.push(e[r]);e=i}else angular.forEach(e,function(e){if(e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),e.fid==t.fid&&""==e.inner_adv_type)if(_=!0,m>=e.items.length)e.items.push(n);else{for(var i=[],r=0,a=e.items.length;a>r;r++)r==m&&i.push(n),i.push(e.items[r]);e.items=i}e.items&&e.items.length>0&&!_&&l(e.items,t,n)});return e}function o(e){var t=r(e,h);return e=l(e,v,t)}if(t.opts.meta.filter_list_inner instanceof Array)return void(t.opts.meta.filter_list_inner=t.currentLevelInnerFilter);t.enableSort=!0;var d=e.source.nodeScope.$modelValue,s=t.currentLevelInnerFilter;if(u(d)){var _=!1;angular.forEach(s,function(e){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),e.fid==d.fid&&"condition"==e.inner_adv_type&&(_=!0)}),_||(t.enableSort=!1)}else angular.forEach(s,function(e){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),u(e)&&e.items&&e.items.length>0&&(t.enableSort=!1)});if(!t.enableSort)return console.log("禁止操作"),void(t.currentLevelInnerFilter=t.originalSortData);if(t.opts.meta.filter_list_inner instanceof Array)t.opts.meta.filter_list_inner=t.currentLevelInnerFilter;else{var f=t.$parent.drill_level||0,c=t.opts.meta.level_fields.length||1,_=!1,g=!1,m=0;t.opts.meta.filter_list_inner[f]=t.currentLevelInnerFilter;var h=e.source.nodeScope.$modelValue,v={};n(t.currentLevelInnerFilter,h),g||i(t.currentLevelInnerFilter,h);for(var y={},w=0;c>w;w++)t.opts.meta.filter_list_inner[w]=f==w?t.currentLevelInnerFilter:o(t.opts.meta.filter_list_inner[w])}a()}},t.$on("current_level_inner_filter",function(e,n){t.currentLevelInnerFilter=n,t.$parent.getChartArgsHeight(),t.$$phase||t.$digest()}),t.$watch("opts",function(e){if(e){var n=t.$parent.drill_level||0;t.currentLevelInnerFilter=e.meta.filter_list_inner instanceof Array?e.meta.filter_list_inner:angular.copy(e.meta.filter_list_inner[n])}},!0),t.setParentAndChildren=function(e){function n(e,i,r){t.simple_filter_list_inner[i]||(t.simple_filter_list_inner[i]=[]),angular.forEach(e,function(e){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),t.simple_filter_list_inner[i].push({filter_fid:e.fid,filter_inner_type:e.inner_adv_type,filter_parent_fid:r}),e.items&&e.items.length>0&&n(e.items,i,e.fid)})}if(t.simple_filter_list_inner={},t.opts.meta.filter_list_inner instanceof Array)n(t.opts.meta.filter_list_inner,0,e);else for(var i=t.opts.meta.level_fields.length||1,r=0;i>r;r++)n(t.opts.meta.filter_list_inner[r],r,e)};var p=!1;t.getChildrenItemToDelete=function(e,n){return p=!1,angular.forEach(n,function(i,r){i.hasOwnProperty("inner_adv_type")||(i.inner_adv_type=""),e.fid==i.fid&&""==i.inner_adv_type&&(n.splice(r,1),p=!0),i.items.length>0&&!p&&t.getChildrenItemToDelete(e,i.items)}),n},t.getNumberItemToDelete=function(e,n){return p=!1,angular.forEach(n,function(i,r){i.hasOwnProperty("inner_adv_type")||(i.inner_adv_type=""),e.fid==i.fid&&"condition"==i.inner_adv_type&&(n.splice(r,1),p=!0),i.items.length>0&&!p&&t.getNumberItemToDelete(e,i.items)}),n};var g=!1;t.getParentNode=function(e,n,i){return g=!1,angular.forEach(e,function(e){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),e.fid==i&&""==e.inner_adv_type&&(n=e,g=!0),e.items&&e.items.length>0&&!g&&t.getParentNode(e.items,n,i)}),n},t.getSelfNode=function(e,n){g=!1;var i=angular.copy(n);return i.hasOwnProperty("uniq_id")||(i.uniq_id=""),angular.forEach(e,function(e){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),e.hasOwnProperty("uniq_id")||(e.uniq_id=""),e.fid==i.fid&&e.uniq_id==i.uniq_id&&""==e.inner_adv_type&&(n=e,g=!0),e.items&&e.items.length>0&&!g&&t.getSelfNode(e.items,i)}),n},t.innerFilter={level:function(e,n){function i(e,t){g=!1,angular.forEach(e,function(e,n){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),e.fid==t.fid&&""==e.inner_adv_type&&(y={},b=n,F=!0)})}function r(e,t){g=!1,angular.forEach(e,function(e){e.items&&e.items.length>0&&angular.forEach(e.items,function(n,i){n.hasOwnProperty("inner_adv_type")||(n.inner_adv_type=""),n.fid==t.fid&&""==n.inner_adv_type&&(y=e,b=i,g=!0)}),e.items&&e.items.length>0&&!g&&r(e.items,t)})}function l(e,t){return I=!1,q={},angular.forEach(e,function(n,i){n.hasOwnProperty("inner_adv_type")||(n.inner_adv_type=""),n.fid==t.fid&&""==n.inner_adv_type&&(q=n,e.splice(i,1),I=!0)}),I||angular.forEach(e,function(e){e.items&&e.items.length>0&&angular.forEach(e.items,function(n,i){n.hasOwnProperty("inner_adv_type")||(n.inner_adv_type=""),n.fid==t.fid&&""==n.inner_adv_type&&(q=n,e.items.splice(i,1),I=!0)}),e.items&&e.items.length>0&&!I&&l(e.items,t)}),q}function o(e,t,n){return g=!1,F?e.push(n):angular.forEach(e,function(e){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),e.fid==t.fid&&""==e.inner_adv_type&&(g=!0,e.items.push(n)),e.items&&e.items.length>0&&!g&&o(e.items,t,n)}),e}function d(e){var t=l(e,v);return e=o(e,y,t)}function s(e,t){g=!1,angular.forEach(e,function(e,n){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),e.fid==t.fid&&""==e.inner_adv_type&&(y={},b=n,F=!0)})}function _(e,t){g=!1,angular.forEach(e,function(e){e.items&&e.items.length>0&&angular.forEach(e.items,function(n,i){n.hasOwnProperty("inner_adv_type")||(n.inner_adv_type=""),n.fid==t.fid&&""==n.inner_adv_type&&(y=e,b=i,g=!0)}),e.items&&e.items.length>0&&!g&&_(e.items,t)})}function f(e,t){return I=!1,E={},angular.forEach(e,function(n,i){n.hasOwnProperty("inner_adv_type")||(n.inner_adv_type=""),n.fid==t.fid&&""==n.inner_adv_type&&(E=n,e.splice(i,1),I=!0)}),I||angular.forEach(e,function(e){e.items&&e.items.length>0&&angular.forEach(e.items,function(n,i){n.hasOwnProperty("inner_adv_type")||(n.inner_adv_type=""),n.fid==t.fid&&""==n.inner_adv_type&&(E=n,e.items.splice(i,1),I=!0)}),e.items&&e.items.length>0&&!I&&f(e.items,t)}),E}function c(e,t,n){return g=!1,F?e.push(n):angular.forEach(e,function(e){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),e.fid==t.fid&&""==e.inner_adv_type&&(g=!0,e.items.push(n)),e.items&&e.items.length>0&&!g&&c(e.items,t,n)}),e}function p(e){var t=f(e,v);return e=c(e,y,t)}var m=e.index(),h=e.$parentNodeScope,v={},y={},w=t.$parent.drill_level||0,L=t.opts.meta.level_fields.length||1,I=!1,F=!1,b=0,O=!1;if("down"===n){if(m){if(t.opts.meta.filter_list_inner instanceof Array)return e.prev().$modelValue.items.push(e.$modelValue),e.remove(),t.opts.meta.filter_list_inner=t.currentLevelInnerFilter,void a();if(v=angular.copy(e.$modelValue),y={},t.originalLevelData=angular.copy(t.currentLevelInnerFilter),1==L)return e.prev().$modelValue.items.push(e.$modelValue),e.remove(),O=!1,angular.forEach(t.currentLevelInnerFilter,function(e){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),u(e)&&e.items&&e.items.length>0&&(O=!0)}),O?void(t.currentLevelInnerFilter=t.originalLevelData):(t.opts.meta.filter_list_inner instanceof Array?t.opts.meta.filter_list_inner=t.currentLevelInnerFilter:t.opts.meta.filter_list_inner[0]=t.currentLevelInnerFilter,void a());if(F=!1,e.prev().$modelValue.items.push(e.$modelValue),e.remove(),O=!1,angular.forEach(t.currentLevelInnerFilter,function(e){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),u(e)&&e.items&&e.items.length>0&&(O=!0)}),O)return void(t.currentLevelInnerFilter=t.originalLevelData);i(t.currentLevelInnerFilter,v),F||r(t.currentLevelInnerFilter,v);for(var q={},D=0;L>D;D++)t.opts.meta.filter_list_inner[D]=w==D?t.currentLevelInnerFilter:d(t.opts.meta.filter_list_inner[D]);a()}}else if("up"===n&&(v=angular.copy(e.$modelValue),y={},h=e.$parentNodeScope,h&&e.$last)){if(t.opts.meta.filter_list_inner instanceof Array)return h.$parentNodesScope.$modelValue.push(e.$modelValue),e.remove(),t.opts.meta.filter_list_inner=t.currentLevelInnerFilter,void a();if(1==L)return h.$parentNodesScope.$modelValue.push(e.$modelValue),e.remove(),t.opts.meta.filter_list_inner instanceof Array?t.opts.meta.filter_list_inner=t.currentLevelInnerFilter:t.opts.meta.filter_list_inner[0]=t.currentLevelInnerFilter,void a();F=!1,h.$parentNodesScope.$modelValue.push(e.$modelValue),e.remove(),s(t.currentLevelInnerFilter,v),F||_(t.currentLevelInnerFilter,v);for(var E={},D=0;L>D;D++)t.opts.meta.filter_list_inner[D]=w==D?t.currentLevelInnerFilter:p(t.opts.meta.filter_list_inner[D]);a()}}},t.initInnerFilterField=function(){var e=t.$parent.drill_level||0,n=t.opts.meta.level[e];t.inner_field=[],angular.forEach(t.fields,function(e){"number"!=e.data_type&&(e.inner_adv_type="",e.inner_show_name="",t.inner_field.push(e))}),"C300"!=t.$parent.selected_type&&(n.y.length>0&&angular.forEach(n.y,function(e){e.inner_adv_type="condition",e.inner_show_name="","row_summary"!=e.fid&&t.inner_field.push(e)}),n.hasOwnProperty("y_optional")&&n.y_optional.length>0&&angular.forEach(n.y_optional,function(e){e.inner_adv_type="condition",e.inner_show_name="",t.inner_field.push(e)}),n.hasOwnProperty("y_scatter")&&n.y_scatter.length>0&&angular.forEach(n.y_scatter,function(e){e.inner_adv_type="condition",e.inner_show_name="",t.inner_field.push(e)}))};var m=[],h={};t.addInnerFilter=function(){if(t.opts){m=angular.copy(t.currentLevelInnerFilter);var e=angular.copy(m);t.initInnerFilterField(),t.addList=angular.copy(bdp.utils.handleInnerFilterLevel(e,!0)),h={},n.open({template:"/static/partials/dialogTemplates/innerFilterConfig.html",className:"ngdialog-theme-default str-filter-model inner-filter-model three-part",scope:t}),t.selectItemList=[],t.default_granularity="",t.fieldSortValueCache={},0!=t.addList.length&&t.showAllItem("",t.addList[0],0),t.showLoading=!1,s(function(){t.addListHighLight(0)},100)}},t.getCurrentLayerFilter=function(e){var n=t.$parent.drill_level||0,i=[];return i=e instanceof Array?e:e[n]},t.addInner=function(e,n,r){e.stopPropagation(),n.hasOwnProperty("uniq_id")||(n.uniq_id=(new Date).getTime());var a,l=t.addList,d=angular.copy(n);if(d.inner_show_name=d.name+t.setAdvanceAggregatorName(d),r&&(a=o[r],d.name=a+"("+d.name+")",d.data_type="sub_date",d.fid=d.fid+"_"+r,d.uniq_id=(new Date).getTime()),l.length>=10)return void i("内置筛选最多可设置10个");if(0==l.length)d.items=[],d.range=[],d.show_all=!0,d.recent_date_button=!1,"date"==d.data_type&&(d.granularity=""),l.push(d),t.showAllItem("",d,l.length-1),setTimeout(function(){t.addListHighLight(l.length-1)},10);else{for(var s=!0,u=!1,_=0,f=l.length;f>_;_++)if("number"===d.data_type||"number"!=d.data_type&&d.hasOwnProperty("aggregator")){if(l[_].fid==d.fid&&l[_].uniq_id==d.uniq_id){s=!1;break}}else if(l[_].fid==d.fid&&!l[_].hasOwnProperty("aggregator")){s=!1;break}if(s){d.hasOwnProperty("uniq_id")||(d.uniq_id=""),h[d.fid+d.uniq_id]?(d=h[d.fid+d.uniq_id],delete h[d.fid+d.uniq_id]):(d.items=[],d.range=[],d.show_all=!0,d.recent_date_button=!1,"date"==d.data_type&&(d.granularity="")),l.push(d),t.showAllItem("",d,l.length-1);var c=$("#addList > ul"),p=c.scrollTop(),g=c.height();setTimeout(function(){c.scrollTop(p+g),t.addListHighLight(l.length-1)},10)}else{if(u)return;i("该字段已添加！")}}},t.moreShow={},t.mouseoverFun=function(e){t.moreShow[e]=!0},t.delInnerFilter=function(e,n){e.stopPropagation();var i=t.addList[n];i.original&&(h[i.fid+i.uniq_id]=i),i.fid==t.current_select_field&&(t.default_granularity=""),t.selectItemList=[],t.addList.splice(n,1),"string"==i.data_type&&t.fieldSortValueCache[i.fid]&&delete t.fieldSortValueCache[i.fid]},t.handleInnerFilterByLayer=function(e){function n(e,t){var n=[];return angular.forEach(t,function(t){e.indexOf(t.uniq_id)>=0&&n.push(t)}),n}var i=t.$parent.drill_level||0,r=t.opts.meta.level_fields.length||1,a=angular.copy(t.opts.meta.filter_list_inner[i]),l=angular.copy(e),o=angular.copy(bdp.utils.handleInnerFilterLevel(a));l=angular.copy(bdp.utils.handleInnerFilterLevel(l));var d=[],s=[];angular.forEach(o,function(e){d.push(e.uniq_id)}),angular.forEach(l,function(e){s.push(e.uniq_id)});var _=getDiffItemsInTwoArray(d,s),f={add:[],del:[]};f.add=n(_.add,l),f.del=n(_.del,o),angular.forEach(f.add,function(e){if(u(e))t.opts.meta.filter_list_inner[i].push(e);else for(var n in t.opts.meta.filter_list_inner)0==t.opts.meta.filter_list_inner[n].length?t.opts.meta.filter_list_inner[n]=[e]:t.opts.meta.filter_list_inner[n].push(e)}),angular.forEach(f.del,function(e){function n(e,t){var i=!1;angular.forEach(e,function(r,a){r.uniq_id==t&&(e.splice(a,1),i=!0),r.items&&r.items.length>0&&!i&&n(r.items,t)})}if(u(e))angular.forEach(t.opts.meta.filter_list_inner[i],function(n,r){e.uniq_id==n.uniq_id&&t.opts.meta.filter_list_inner[i].splice(r,1)}),t.getNumberItemToDelete(e,t.opts.meta.filter_list_inner[i]);else for(var a=0;r>a;a++)n(t.opts.meta.filter_list_inner[a],e.uniq_id)})},t.setOtherAttributions=function(e){function n(e){angular.forEach(e,function(e){e.hasOwnProperty("inner_adv_type")||(e.inner_adv_type=""),"string"==e.data_type&&""==e.inner_adv_type&&(e.show_all=i[e.fid]?i[e.fid]:!1,e.recent_date_button=!1),"sub_date"==e.data_type&&""==e.inner_adv_type&&(e.recent_date_button=!1,e.granularity=a[e.fid]?a[e.fid]:""),"date"==e.data_type&&""==e.inner_adv_type&&(e.show_all=i[e.fid]?i[e.fid]:!1,e.recent_date_button=r[e.fid]?r[e.fid]:!1,e.granularity=a[e.fid]?a[e.fid]:"",e.range=l[e.fid]?l[e.fid]:[]),e.items&&e.items.length>0&&n(e.items)})}var i={},r={},a={},l={},o=t.opts.meta.level_fields.length||1;angular.forEach(e,function(e){i[e.fid]=e.show_all,r[e.fid]=e.recent_date_button,a[e.fid]=e.granularity,"date"==e.data_type&&""==e.inner_adv_type&&""==e.granularity&&angular.forEach(t.opts.meta.filter_list,function(t){t.fid==e.fid&&(l[e.fid]=t.range)}),"date"==e.data_type&&""==e.inner_adv_type&&""!=e.granularity&&(l[e.fid]=[])});for(var d=0;o>d;d++)n(t.opts.meta.filter_list_inner[d])},t.saveInnerFilter=function(){if(angular.forEach(t.addList,function(e){if("date"==e.data_type){var n=c(e);e.range=n?n:e.range}e.inner_show_name=e.name+t.setAdvanceAggregatorName(e),e.original?f(e,m):m.push(e)}),angular.forEach(h,function(e){e.hasOwnProperty("uniq_id")||(e.uniq_id=""),_(e.fid,e.uniq_id,m)}),t.opts.meta.filter_list_inner instanceof Array){for(var e={},n=t.opts.meta.level_fields.length||1,r=0;n>r;r++)e[r]=angular.copy(t.opts.meta.filter_list_inner);t.opts.meta.filter_list_inner=e}if(t.handleInnerFilterByLayer(m),t.setOtherAttributions(t.addList),$.isEmptyObject(t.fieldSortValueCache))a();else{var o={config_list:[]},d=t.opts.tb_id;angular.forEach(t.fieldSortValueCache,function(e,t){o.config_list.push({tb_id:d,fid:t,type:4,template:e})}),o.config_list=angular.toJson(o.config_list),l.enumField.updateOrder(o).then(function(e){0==e.status?a():i(Number(e.status))})}},t.current_select_field="",t.default_recent_str="",t.default_granularity="",t.selectItemList=[],t.itemDataType="",t.selectField={},t.fieldSortValueCache={},t.showAllItem=function(n,r,a){if(t.selectField=r,t.selectItemList=[],t.showLoading=!0,t.current_select_field=r.fid,t.itemDataType=r.data_type,t.addListHighLight(a),"sub_date"==t.selectField.data_type){var d=r.fid.lastIndexOf("_"),s=r.fid.length;t.default_granularity=r.fid.substring(d+1,s)}else t.default_granularity=r.granularity;if("date"==r.data_type&&""==t.default_granularity)l.adv_date.list(t.chartid).then(function(e){0==e.status?(t.selectItemList=e.result,t.selectField.recent_date_button=!1):i(Number(e.status)),t.showLoading=!1});else if("date"==r.data_type&&""!=t.default_granularity){{r.fid+"_"+t.default_granularity}t.beginTimer=(new Date).getTime(),e.post("/api/field/inner_range_preview",{ct_id:t.chartid,field:angular.toJson(r),granularity:t.default_granularity}).then(function(e){return t.endTimer=(new Date).getTime(),t.beginTimer>t.endTimer?void(t.selectItemList=[]):void(0==e.status?(t.selectItemList=e.result.range,t.showLoading=!1):i(Number(e.status)))})}else"number"==r.data_type||"number"!=r.data_type&&r.hasOwnProperty("aggregator")?(t.tempDrillOption=t.$parent.drillOption?angular.copy(t.$parent.drillOption):{drill_field:"",drill_level:"",drill_value:[]},t.beginTimer=(new Date).getTime(),e.post("/api/field/inner_range_preview",{ct_id:t.chartid,field:angular.toJson(r),uniq_id:r.uniq_id,level:t.$parent.drill_level||0,drill_field:t.tempDrillOption.drill_field,drill_level:t.tempDrillOption.drill_level,drill_value:angular.toJson(t.tempDrillOption.drill_value)}).then(function(e){return t.endTimer=(new Date).getTime(),t.beginTimer>t.endTimer?void(t.selectItemList=[]):void(0==e.status?(t.selectItemList=t.handleNumberByFormatter(e.result.range,t.selectField.formatter,t.selectField.aggregator),t.showLoading=!1):i(Number(e.status)))})):t.fieldSortValueCache[r.fid]&&t.fieldSortValueCache[r.fid].length>0?(t.selectItemList=t.fieldSortValueCache[r.fid],t.showLoading=!1):(t.beginTimer=(new Date).getTime(),e.post("/api/field/inner_range_preview",{ct_id:t.chartid,field:angular.toJson(r),granularity:""}).then(function(e){return t.endTimer=(new Date).getTime(),t.beginTimer>t.endTimer?void(t.selectItemList=[]):void(0==e.status?(t.selectItemList=e.result.range,t.showLoading=!1):i(Number(e.status)))}));t.default_recent_str=o[t.default_granularity],n&&n.stopPropagation()},t.setShowAllFlag=function(){t.selectField.show_all=!t.selectField.show_all},t.handleNumberByFormatter=function(e,t,n){for(var i=2,r=0;r<e.length;r++)t?(""!==t[t.check].digit&&(i=t[t.check].digit),e[r]="num"==t.check&&t.num.millesimal?Highcharts.numberFormat(e[r],i,".",","):"num"==t.check?Highcharts.numberFormat(e[r],i,".",""):Highcharts.numberFormat(100*e[r],i,".","")+"%"):(("COUNT"==n||"COUNT_DISTINCT"==n)&&(i=0),e[r]=Highcharts.numberFormat(e[r],i));return e},t.addListHighLight=function(e){angular.forEach(angular.element(".add-list #addList ul li > div"),function(t,n){angular.element(t).removeClass("active"),e==n&&angular.element(t).addClass("active")})},t.setAdvanceAggregatorName=d,t.sortInnerStringFilter={items:".J-sortable-string",start:function(){},update:function(){t.fieldSortValueCache[t.current_select_field]=t.selectItemList},stop:function(){}}},controller:angular.noop}}])}();
;!function(){function e(e,t){if(!Array.isArray(e))return!1;for(var o=0,r=e.length;r>o;o++)if(e[o].fid==t)return!0;return!1}function t(e,t){return e.x1<t.x1+(t.x2-t.x1)/2&&t.x2-(t.x2-t.x1)/2<e.x2&&e.y1<t.y1+(t.y2-t.y1)/2&&e.y2-(t.y2-t.y1)/2<e.y2}angular.module("BC.directives").constant("chartColorTheme",bdpChart.colors).directive("chartColorSetting",["formulaKeyMap","$rootScope","errHint",function(o,r,n){return{templateUrl:"/static/partials/chart_color_setting.html",scope:!0,link:function(e){e.dropField=function(){var t=bdpChart.ChartType;if(2==r.guide&&3==r.enterprise_type){if(8==r.guideStep)return!1;if(9==r.guideStep)return!1}var o=e.currentMeta.chart_type,a=(e.currentMeta.x,e.currentMeta.y);if(!o)return n("当前设置不支持拖动字段设置颜色"),!1;if("number"==e.dragField.data_type&&(a.length>1||o===t.Biax||e.currentMeta.compare_axis&&e.currentMeta.compare_axis.length))return n("当前设置不支持设置渐变颜色"),!1;if("date"==e.dragField.data_type)return n("不能对日期进行颜色设置"),!1;if([t.Pie,t.Gauge,t.Sankey,t.Waterfall,t.KPICard,t.Funnel,t.WordCloud,t.Sunburst,t.TreeMap].indexOf(o)>-1)return n("当前设置不支持拖动字段设置颜色"),!1;if(e.colorSetting&&void 0!==e.colorSetting.mode){for(var l=0;l<e.colorSetting.field.length;l++)if(e.colorSetting.field[l].fid===e.dragField.fid)return n("已经对该字段进行过颜色设置"),!1;0===+e.colorSetting.mode&&[t.AreaMap,t.BubbleMap].indexOf(o)<0?"number"==e.dragField.data_type?e.colorSetting={field:[e.dragField],theme:"default",mode:1,aggregator:"SUM"}:e.colorSetting.field.push(e.dragField):e.colorSetting={field:[e.dragField],theme:"default",mode:"number"==e.dragField.data_type?1:0,aggregator:"number"==e.dragField.data_type?"SUM":""}}else e.colorSetting={field:[e.dragField],theme:"default",mode:"number"==e.dragField.data_type?1:0,aggregator:"number"==e.dragField.data_type?"SUM":""};e.init(e.colorSetting),e.showColorSettingModalByField()},e.$on("onDropToColor",function(t,o){e.onDrop(o.originEvent,o.ui)}),e.formulaKeyMap=o,e.startDrag=function(){angular.element(".chart-left-side,.chart-main").css({overflow:"visible"})},e.removePosition=function(){angular.element(".color-setting-layer").css({overflow:"visible"})},e.del=function(o,n,a){var l=bdpChart.ChartType;angular.element(".color-setting-layer,.chart-left-side,.chart-main").css({overflow:""});var i=n.helper.position(),c=$(".color-setting"),s={width:c.width(),height:c.height()},g={width:n.helper.width(),height:n.helper.height()},d=t({x1:0,y1:0,x2:s.width,y2:s.height},{x1:i.left,y1:i.top,x2:g.width+i.left,y2:g.height+i.top});if(d)return void n.helper.css({left:0,top:0});if(0===a&&1===e.colorSetting.field.length){if(delete e.colorSetting,delete e.currentMeta.color_setting,[l.Pie,l.Gauge,l.Sankey,l.Waterfall,l.KPICard,l.Funnel,l.WordCloud,l.Sunburst,l.TreeMap].indexOf(e.currentMeta.chart_type)<0){var u=bdpChart.getColorsByType(e.currentMeta.chart_type,"bdp"),h=u.length;e.currentMeta.y.forEach(function(e,t){e.series_color=u[t%h]}),e.currentMeta.y_optional&&e.currentMeta.y_optional.forEach(function(t,o){t.series_color=u[(o+e.currentMeta.y.length)%h]})}e.saveChartImmediate()}else e.colorSetting.field.splice(a,1),e.getFieldValues(e.colorSetting.field,e.tb_id).then(function(t){t.total>100?e.viewData.showTips=!0:(e.viewData.showTips=!1,r.$emit("triggerBuildEnumColorMap",t.result),e.currentMeta.color_setting=e.colorSetting,e.saveChartImmediate())});o.stopPropagation()},e.clickPanel=function(){e.showColorSettingModalByField()}},controller:["$scope","$rootScope","ngDialog","commonService","chartColorTheme","operatorHelpLink","$q","$jsTipTranslate","$timeout",function(t,o,r,n,a,l,i,c,s){function g(e,o,r){if(r===b.Sunburst?o&&e.x[0].fid!==o.x[0].fid&&delete e.color_setting:r===b.Sankey?!o||e.x[1]&&e.x[1].fid===o.x[1].fid||delete e.color_setting:r===b.TreeMap&&(o&&e.x[0]&&e.x[0].fid!==o.x[0].fid||o&&!e.x[0])&&delete e.color_setting,!o||o.chart_type!==r||o.chart_type===r&&!e.color_setting){if(!o&&e.color_setting&&void 0!==e.color_setting.mode)t.colorSetting=angular.copy(e.color_setting),t.colorSetting.is_series=!1;else{var n={field:[e.x[0]],theme:"default",mode:0,aggregator:"",is_series:!1};r===b.Pie?0===e.x.length?t.colorSetting={is_series:!0}:e.color_setting?t.colorSetting=angular.copy(e.color_setting):t.colorSetting&&void 0!==t.colorSetting.mode?e.x[0].fid!==t.colorSetting.field[0].fid?t.colorSetting=angular.copy(n):1===+t.colorSetting.mode?delete t.colorSetting.enum_color_map:delete t.colorSetting.range_color:t.colorSetting=angular.copy(n):r===b.Sunburst||r===b.TreeMap?t.colorSetting=angular.copy(n):r===b.Sankey&&(e.x[1]&&(n.field=[e.x[1]]),t.colorSetting=angular.copy(n)),e.color_setting=angular.copy(t.colorSetting)}t.init(t.colorSetting)}}function d(e){var t=e.color_setting;t&&!$.isEmptyObject(t)&&1==t.mode&&delete e.color_setting}function u(o,r){if(t.currentMeta=o,o){if((o.chart_type===b.Biax||o.y.length>1)&&d(o),o.compare_axis&&o.compare_axis.length>0){if(d(o),[b.Table,b.Pie,b.Gauge,b.Sankey,b.Waterfall,b.KPICard,b.Funnel,b.WordCloud,b.Sunburst].indexOf(o.chart_type)<0){o.color_setting&&delete o.color_setting.is_series;var n=o.color_setting&&!$.isEmptyObject(o.color_setting)&&!$.isEmptyObject(o.color_setting.enum_color_map),a=[].concat(o.y||[],o.y_optional||[]);n||(n=a.some(function(e){return!!e.series_color})),n||(o.color_setting={field:[].concat(o.compare_axis),aggregator:"",theme:"default",mode:0,enum_color_map:{}})}o.split_compare&&o.color_setting&&$.isEmptyObject(o.color_setting.enum_color_map)&&delete o.color_setting}if([b.Sankey,b.Sunburst,b.Pie,b.Funnel,b.TreeMap].indexOf(o.chart_type)>-1)g(o,r,o.chart_type);else if(b.Gauge===o.chart_type){var l=!1,i=t.currentMeta.tb_conditional_formatting;if(t.colorSetting={is_series:!(i&&i.length>0)},i&&(l=i.some(function(e){return e.uniq_id===t.currentMeta.y[0].uniq_id?!0:void 0})),t.currentMeta.y[0]&&!t.currentMeta.y[0].series_color&&!l){var c=t.currentMeta.y[0].fid,s=t.currentMeta.y[0].uniq_id;t.currentMeta.y[0].BDP_TCF=!0,t.currentMeta.tb_conditional_formatting=[{fid:c,uniq_id:s,operator:4,value:1,isPercentage:[!0],style:{backgroundColor:"#40A276"}},{fid:c,uniq_id:s,operator:12,value:[.75,1],isPercentage:[!0,!0],style:{backgroundColor:"#F6CC4E"}},{fid:c,uniq_id:s,operator:12,value:[.25,.75],isPercentage:[!0,!0],style:{backgroundColor:"#F38000"}},{fid:c,uniq_id:s,operator:3,value:.25,isPercentage:[!0],style:{backgroundColor:"#EE4B4B"}}]}m(t.colorSetting)}else if(b.KPICard===o.chart_type){var u=!1,i=t.currentMeta.tb_conditional_formatting;if(t.colorSetting={is_series:!0},t.currentMeta.y[1]&&i&&(u=i.some(function(e){return e.uniq_id===t.currentMeta.y[1].uniq_id?!0:void 0})),t.currentMeta.y.length>1&&!t.currentMeta.y[1].series_color&&!u){var h=t.currentMeta.y[1].fid,f=t.currentMeta.y[1].uniq_id;t.currentMeta.y[1].BDP_TCF=!0,t.currentMeta.tb_conditional_formatting=[].concat([{fid:h,uniq_id:f,operator:3,value:0,shape_type:"arrow-down",style:{color:"#40B27E"}},{fid:h,uniq_id:f,operator:0,value:0,shape_type:"arrow-equal",style:{color:"#A3ABB0"}},{fid:h,uniq_id:f,operator:2,value:0,shape_type:"arrow-up",style:{color:"#EF4B4A"}}],t.currentMeta.tb_conditional_formatting||[])}m(t.colorSetting)}else o.color_setting&&o.color_setting.enum_color_map&&$.isEmptyObject(o.color_setting.enum_color_map)&&e(o.x,o.color_setting.field[0].fid)&&o.color_setting.field[0].fid!==o.x[0].fid&&delete o.color_setting,t.colorSetting=angular.copy(o.color_setting),m(t.colorSetting)}}function h(e,o){if(e&&"C340"==t.currentMeta.chart_type&&angular.toJson(e)!=angular.toJson(o)){m(t.currentMeta.color_setting);var r=t.colorSetting;if(r&&0==r.mode){for(var n=angular.copy(t.wordCloudValues),a=n.length,l=a-1;l>=0;)n[l].length>200&&n.splice(l,1),l--;var i=t.colorSetting.enum_color_map||{};for(var c in i)i.hasOwnProperty(c)&&-1==$.inArray(c,n)&&delete i[c];angular.forEach(e,function(e,o){void 0==i[e]&&(i[e]={name:e,color:t.colors[o%t.colors.length]})}),t.colorSetting.enum_color_map=i,t.updateMeta()&&t.saveChartImmediate({not_need_redraw:!0})}}}function m(e){var o=t.currentMeta,r=bdpChart.ChartType;if(e?e.is_series=!!e.is_series:(e={is_series:[r.TreeMap,r.Sankey,r.Sunburst,r.AreaMap,r.BubbleMap].indexOf(o.chart_type)<0},t.colorSetting=e),o.compare_axis&&o.compare_axis.length){var n=[].concat(o.y||[],o.y_optional||[]),a=n.some(function(e){return!!e.series_color});t.showSeriesColor=a||[r.Gauge,r.KPICard].indexOf(o.chart_type)>-1,o.split_compare&&(t.showSeriesColor=!o.color_setting||$.isEmptyObject(o.color_setting.enum_color_map))}else t.showSeriesColor=e.is_series,t.showSeriesColor=!(!o.chart_type||!(e.is_series||[r.Waterfall,r.Funnel].indexOf(o.chart_type)>-1)||o.chart_type===r.Scatter);if(1==e.is_series)return o.color_setting={is_series:!0},!1;if(0===+e.mode)t.initColorTheme(e);else if(1===+e.mode){for(var l=0,i=t.rangeColorTheme.length;i>l;l++)if(t.rangeColorTheme[l].name==e.theme){t.rangeThemeSelector.theme=t.rangeColorTheme[l];break}t.setRangeColor(e.theme),t.colorSetting.range_color.inverse=e.range_color.inverse,t.viewData.enable_step=!!e.range_color.step,t.viewData.step=e.range_color.step||5,t.viewData.disable_max=defined(e.range_color.disable_max)?e.range_color.disable_max:!0,t.viewData.disable_min=defined(e.range_color.disable_min)?e.range_color.disable_min:!0,t.viewData.max=e.range_color.max,t.viewData.min=e.range_color.min}return!0}function f(e,o){return n.field.getFilteredRange(t.ct_id,o,e).then(function(e){var t=e;return 0==t.status?t.result:null})}function _(e,t){var o=[],r=e.granularity,n=e.granularity_name||"",a=e.month_start_day||0;return"week"===r&&(a=e.week_start_day_of_week),o=t.map(function(e){return bdpChart.helper.checkGranularity(r,e,n,a)})}function p(e,t){if(!e.length)return[[]];var o,r=p(e.slice(1)),n=[];return e[0].forEach(function(e){r.forEach(function(r){o=[e].concat(r),t&&(o=o.join(t)),n.push(o)})}),n}function C(e){return Object.keys(e)}function y(e){var o={showNameObj:e,dataObj:angular.copy(e)};angular.forEach(t.colorSetting.field,function(t){e[t.fid]&&"date"===t.data_type&&(o.showNameObj[t.fid]=_(t,e[t.fid]))});var r=[].concat(t.currentMeta.y,t.currentMeta.y_optional||[]);r.length>1&&(o.showNameObj.fields=[],o.dataObj.fields=[],r.forEach(function(e){e&&(o.showNameObj.fields.push(e.nick_name||e.name),o.dataObj.fields.push(e.uniq_id))}));var n=C(o.showNameObj).map(function(e){return o.showNameObj[e]}),a=C(o.dataObj).map(function(e){return o.dataObj[e]});return{showArr:p(n,"_"),dataArr:p(a,"_")}}function S(e,o,r,n){if(t.colorSetting&&void 0!==t.colorSetting.mode&&t.colors){var a={};angular.forEach(t.colorSetting.field,function(e){o[e.fid]&&(a[e.fid]=o[e.fid])}),t.originColorFields=angular.copy(a);var l={};(r||!t.colorSetting.enum_color_map)&&(t.colorSetting.enum_color_map={});var i=y(a);i.dataArr.forEach(function(e,o){void 0==l[e]&&(l[e]=t.colorSetting.enum_color_map[e]||void 0,l[e]?l[e].name=i.showArr[o]:l[e]={color:t.colors[o%t.colors.length],name:i.showArr[o]})}),t.colorSetting.enum_color_map=l,n&&(t.currentMeta.color_setting.enum_color_map=l),t.colorItemsOrder=i.dataArr.slice()}}var v=o.language,b=bdpChart.ChartType;t.goHelp=function(e){l(e)},t.$watch("chart_ops.meta.level[drill_level]",u,!0),t.getFieldValues=f,t.$watch("wordCloudValues",h),t.colorTheme=[],t.rangeColorTheme=[],t.colorWordCloudModel=[];var M="zh"===v?{"default":"BDP默认 12",contrast:"对比蓝 12",vintage:"葡萄酒 10",blue_sky:"天空蓝 10",green_contrast:"对比绿 10",green_contrast_2:"对比绿 7",green:"绿色 7",gray_blue:"灰蓝 7",purple:"粉紫 5",blue_contrast:"对比蓝 5",gray_red:"灰红 5",gray:"灰色 5"}:{"default":"BDP Default 12",contrast:"Contrast Blue 12",vintage:"Vintage 10",blue_sky:"Sky Blue 10",green_contrast:"Contrast Green 10",green_contrast_2:"Contrast Green 7",green:"Green 7",gray_blue:"Gray-Blue 7",purple:"Purple 5",blue_contrast:"Contrast Blue 5",gray_red:"Gray-Red 5",gray:"Gray 5"},w="zh"===v?{"default":"默认",golden:"渐变金",green:"渐变绿",blue:"渐变蓝",purple:"渐变紫",gray:"渐变灰"}:{"default":"Default",golden:"Gradient Gold",green:"Gradient Green",blue:"Gradient Blue",purple:"Gradient Purple",gray:"Gradient Gray"},x="en"===v?{0:"key words",1:"word frequency"}:{0:"关键词",1:"词频"};angular.forEach(x,function(e,o){t.colorWordCloudModel.push({key:o,name:e})}),angular.forEach(a,function(e,o){t.colorTheme.push({name:o,alias:M[o]})}),angular.forEach(bdpChart.rangeColors,function(e,o){t.rangeColorTheme.push({name:o,alias:w[o]})}),t.rangeColorTheme.push({name:"custom",alias:"en"==$.cookie("locale")?"Custom":"自定义"}),t.themeSelector={open:!1,theme:t.colorTheme[0]},t.cloudColorModeCache={mode_0:"default",mode_1:"blue"},t.changeTheme=function(e){e!=t.themeSelector.theme&&(t.themeSelector.theme=e,t.themeSelector.open=!1,t.colors=a[e.name],"C340"==t.currentMeta.chart_type&&(t.cloudColorModeCache.mode_0=e.name))},t.changeAggr=function(){var e=t.colorSetting.aggregator?1:0;if(e!=t.colorSetting.mode){t.colorSetting.mode=e,t.colorSetting.theme="default",t.init(t.colorSetting),0==e&&(t.colorSetting.aggregator="");var r=t.currentMeta.chart_type;0==e&&"C340"!=r&&f(t.colorSetting.field,t.tb_id).then(function(e){e.total>100?t.viewData.showTips=!0:(t.viewData.showTips=!1,o.$emit("triggerBuildEnumColorMap",e.result))})}},t.colorPickerOptions={preferredFormat:"hex",showInput:"true",cancelText:"en"===v?"Cancel":"取消",chooseText:"en"===v?"Ok":"确定"},t.rangeThemeSelector={open:!1,theme:t.rangeColorTheme[0]},t.changeRangeTheme=function(e){e!=t.themeSelector.theme&&(t.rangeThemeSelector.theme=e,t.rangeThemeSelector.open=!1,t.colorSetting.theme=e.name,t.setRangeColor(e.name),"C340"==t.currentMeta.chart_type&&(t.cloudColorModeCache.mode_1=e.name))},t.changeRangeColor=function(){t.changeRangeTheme(t.rangeColorTheme[t.rangeColorTheme.length-1])},t.reset=function(){delete t.colorSetting},t.setRangeColor=function(e){if("custom"!=e){t.colorSetting.range_color=t.colorSetting.range_color||{};var o=bdpChart.rangeColors[e],r=t.colorSetting.range_color.inverse;t.colorSetting.range_color.start_color=r?o[1]:o[0],t.colorSetting.range_color.end_color=r?o[0]:o[1]}},t.initColorTheme=function(e){for(var o=0,r=t.colorTheme.length;r>o;o++)if(t.colorTheme[o].name==e.theme){t.themeSelector.theme=t.colorTheme[o];break}t.colors=a[e.theme]},t.viewData={},t.init=m,t.updateMeta=function(){var o=angular.copy(t.colorSetting),r=t.$eval("chart_ops.meta.level[drill_level]");if(1==o.mode){if(delete o.enum_color_map,!t.handleMaxMin(o.range_color))return!1}else delete o.range_color;if(1!=t.colorSetting.mode){var n=r.chart_type;t.colorSetting.field.forEach(function(t){if(!e(r.x,t.fid))if("C280"==n)r.x.push(t);else if(-1==n.indexOf("C27"))if(r.compare_axis){var o=r.compare_axis.every(function(e){return e.fid!==t.fid});o&&r.compare_axis.push(t)}else r.compare_axis=[],r.compare_axis.push(t)})}return o.is_series||(r.y.forEach(function(e){delete e.series_color}),r.y_optional&&r.y_optional.forEach(function(e){delete e.series_color})),r.color_setting=o,!0},t.handleMaxMin=function(e){var o=!t.viewData.disabled_max&&defined(t.viewData.max),r=!t.viewData.disabled_min&&defined(t.viewData.min);return o&&r&&t.viewData.min>t.viewData.max?(alert("值域最小值不能大于最大值"),!1):(e.disable_max=!!t.viewData.disable_max,e.disable_min=!!t.viewData.disable_min,defined(t.viewData.max)&&(e.max=t.viewData.max),defined(t.viewData.min)&&(e.min=t.viewData.min),!0)},o.$on("triggerBuildEnumColorMap",S),t.$on("chartFilterChange",function(e,r){t.colorSetting&&0==t.colorSetting.mode?f(t.colorSetting.field,t.tb_id).then(function(e){e.total<=100&&o.$emit("triggerBuildEnumColorMap",e.result),t.updateMeta(),t.saveChartImmediate(r.saveChartOpts)}):t.saveChartImmediate(r.saveChartOpts)}),t.showColorSettingModalByField=function(){if(t.colorSetting){for(var e=t.colorSetting.field,o=e.length,n=[].concat(t.currentMeta.x,t.currentMeta.compare_axis||[]),a=0;o>a;a++)if("date"===e[a].data_type){for(var l=0;l<n.length;l++)if(n[l].fid===e[a].fid){e.splice(a,1,n[l]);break}break}t.preCloseDialog=!1,r.open({className:"ngdialog-theme-default ngdialog-color-setting",templateUrl:"/static/partials/dialogTemplates/color_setting_modal.html",scope:t,controller:"colorSettingByFieldCtrl",preCloseCallback:function(){return t.themeSelector.open=!1,t.rangeColorTheme.open=!1,t.preCloseDialog?!0:(delete t.colorSetting.is_series,angular.equals(t.currentMeta.color_setting,t.colorSetting)?void 0:confirm(t.tips["chart.notSave"])?(s(function(){t.colorSetting=angular.copy(t.currentMeta.color_setting),t.init(t.colorSetting)},0),!0):!1)}})}},t.showColorSettingModalByItem=function(){r.open({className:"ngdialog-theme-default ngdialog-color-setting",templateUrl:"/static/partials/dialogTemplates/series_color_modal.html",data:{colorSetting:t.colorSetting},scope:t,controller:"colorSettingByItemCtrl"})},c(["chart.notSave"],t)}]}}]).controller("colorSettingByFieldCtrl",["$rootScope","$scope","$getCustomFormula","chartColorTheme","commonService",function(e,t,o){var r=t.currentMeta.chart_type,n=t.colorSetting.mode;t.isSunburst="C360"==r,t.showFormulaList=function(){return 1==t.colorSetting.field.length&&1!=t.colorSetting.field[0].is_build_aggregated&&(!t.currentMeta.compare_axis||0===t.currentMeta.compare_axis.length)&&["C370","C360","C230","C320","C340"].indexOf(t.currentMeta.chart_type)<0},0==n&&t.getFieldValues(t.colorSetting.field,t.tb_id).then(function(o){"C340"!=r?o.total>100?t.viewData.showTips=!0:(t.viewData.showTips=!1,e.$emit("triggerBuildEnumColorMap",o.result),t.selectItem({},t.colorItemsOrder[0],0)):(e.$emit("triggerBuildEnumColorMap",o.result),t.selectItem({},t.colorItemsOrder[0],0))}),"C340"==r&&(0==n?t.cloudColorModeCache.mode_0=t.colorSetting.name?t.colorSetting.name:"default":t.cloudColorModeCache.mode_1=t.colorSetting.name?t.colorSetting.name:"blue"),t.formulaList=o("number"==t.colorSetting.field[0].data_type?["SUM","AVERAGE","MAX","MIN","COUNT","COUNT_DISTINCT"]:["COUNT","COUNT_DISTINCT"]),t.selected={value:"",key:"",color:""},t.applyTheme=function(o){t.colorSetting.theme=o.name,t.originColorFields&&(e.$emit("triggerBuildEnumColorMap",t.originColorFields,!0),t.selectedColorKeys.length<=1&&(t.viewData.selectedColor=t.colorSetting.enum_color_map[t.colorItemsOrder[t.selectedColorKeys[0]]].color))},t.selectColor=function(e){angular.forEach(t.selectedColorKeys,function(o){var r=t.colorItemsOrder[o];r&&(t.colorSetting.enum_color_map[r].color=t.colors[e],t.selected.color=t.colors[e],t.viewData.selectedColor=t.colors[e])})},t.onColorChange=function(e){angular.forEach(t.selectedColorKeys,function(o){var r=t.colorItemsOrder[o];r&&(t.colorSetting.enum_color_map[r].color=e)})},t.changeColorModel=function(){var o=t.colorSetting,r=t.colorSetting.mode,n=t.currentMeta.color_setting.mode;0==r?(o.theme=t.cloudColorModeCache.mode_0,t.initColorTheme(o),e.$emit("triggerBuildEnumColorMap",t.wordCloudValues,!0)):(o.theme=t.cloudColorModeCache.mode_1,0==n&&(t.setRangeColor(o.theme),t.viewData.enable_step=!1,t.viewData.step=5,t.viewData.disable_max=!0,t.viewData.disable_min=!0))},t.toggleStep=function(e){e?t.colorSetting.range_color.step=t.viewData.step:t.colorSetting.range_color&&(t.colorSetting.range_color.step=0)},t.setStep=function(e){e&&(t.colorSetting.range_color.step=e)},t.selectedColorKeys=[],t.selectItem=function(e,o,r){var n=t.colorSetting.enum_color_map[o];if(e.metaKey||e.ctrlKey)t.selectedColorKeys.push(r);else if(e.shiftKey)if(0==t.selectedColorKeys.length)t.selectedColorKeys=[r];else{var a=t.selectedColorKeys[0];t.selectedColorKeys.length=1;for(var l=r>a?-1:1,i=r;i!=a;)t.selectedColorKeys.push(i),i+=l}else t.selected.color=n.color,t.viewData.selectedColor=n.color,t.selectedColorKeys=[r]},t.isHighlight=function(e){return t.selectedColorKeys.indexOf(e)>-1},t.inverseRangeColor=function(){var e=t.colorSetting.range_color,o=e.start_color;e.start_color=e.end_color,e.end_color=o},t.saveByField=function(){t.$parent.preCloseDialog=!0,t.viewData.showTips&&0==t.colorSetting.mode||(t.colorSetting.is_series=!1,t.updateMeta()&&(t.saveChartImmediate(),t.closeThisDialog()))},t.cancelByField=function(){t.$parent.preCloseDialog=!1,t.closeThisDialog()}}]).controller("colorSettingByItemCtrl",["$scope","chartColorTheme",function(e,t){e.series=angular.copy(e.seriesColors),e.series_theme=e.currentMeta.series_theme||"default",e.chartColorTheme=t,e.highlightIndex=0,e.applyTheme=function(o){var r=o.name,n=t[r].length;angular.forEach(e.series,function(e,o){var a=o%n;e.color=t[r][a]}),e.series_theme=o.name,e.viewData.selectedColor=e.series[e.highlightIndex].color},e.selectItem=function(t){e.highlightIndex=t,e.viewData.selectedColor=e.series[t].color},e.isHighlight=function(t){return e.highlightIndex==t},e.selectColor=function(o){if(void 0!=e.highlightIndex){var r=t[e.themeSelector.theme.name];e.series[e.highlightIndex].color=r[o],e.viewData.selectedColor=r[o]}},e.onColorChange=function(t){void 0!=e.highlightIndex&&(e.series[e.highlightIndex].color=t)},e.init(),e.saveByItem=function(){e.colorSetting.is_series=!0;var t=e.isGisColorSetting?e.currentMeta:e.chart_ops.meta.level[e.drill_level];if("C320"===t.chart_type)t.waterfall_setting.color_theme=[],angular.forEach(e.series,function(e){t.waterfall_setting.color_theme.push(e.color)}),t.series_theme=e.series_theme;else if("C330"===t.chart_type)t.funnel_setting.color_theme=[],angular.forEach(e.series,function(e){t.funnel_setting.color_theme.push(e.color)}),t.series_theme=e.series_theme;else if(e.isGisColorSetting){var o=t.y;angular.forEach(o,function(t,o){t.series_color=e.series[o].color}),t.series_theme=e.series_theme}else{var o=t.y.concat(t.y_optional||[]);angular.forEach(o,function(t){for(var o=0;o<e.series.length;o++)t.uniq_id===e.series[o].uniq_id&&(t.series_color=e.series[o].color)}),t.series_theme=e.series_theme}e.saveChartImmediate(),e.closeThisDialog()},e.cancelByItem=function(){e.closeThisDialog()}}]).directive("colorLinearGradient",function(){return{template:'<span class="color-thumb fl" ng-style="{background: startColor}"><color-picker ng-model="startColor" on-change="onChangeColor()"></color-picker></span><span class="color-thumb fr" ng-style="{background: endColor}"><color-picker ng-model="endColor" on-change="onChangeColor()"></color-picker></span><div class="color-range-gradient"></div>',scope:{startColor:"=",endColor:"=",step:"=",onChangeColor:"&onChangeColor"},link:function(e,t){function o(e,o,r){return bdpChart.helper.renderLinearGradient(t.find(".color-range-gradient"),e,o,r)}e.$watch("startColor",function(t){t&&o(e.startColor,e.endColor,e.step)}),e.$watch("endColor",function(t){t&&o(e.startColor,e.endColor,e.step)}),e.$watch("step",function(){o(e.startColor,e.endColor,e.step)})}}})}();
;!function(){function e(e,o){return e.x1<o.x1+(o.x2-o.x1)/2&&o.x2-(o.x2-o.x1)/2<e.x2&&e.y1<o.y1+(o.y2-o.y1)/2&&e.y2-(o.y2-o.y1)/2<e.y2}var o={};angular.module("BC.directives").directive("gisColorSetting",["formulaKeyMap","errHint",function(t,r){return{templateUrl:"/static/partials/chart_color_setting.html",scope:!0,link:function(a){a.dropField=function(){return"date"==a.dragField.data_type?void r("不能对日期进行颜色设置"):1===a.dragField.is_build_aggregated&&"string"==a.dragField.data_type?void r("不能对文本类型的聚合字段进行尺寸设置"):(a.colorSetting={field:[a.dragField],theme:"default",mode:"number"==a.dragField.data_type?1:0,aggregator:"number"==a.dragField.data_type&&1!==a.dragField.is_build_aggregated?"SUM":""},a.init(a.colorSetting),a.showSeriesColor?r("当前设置不支持拖动字段设置颜色"):a.showColorSettingModalByField(),void(o=a.colorSetting))},a.$on("onDropToColor",function(e,o){a.onDrop(o.originEvent,o.ui)}),a.isGisColorSetting=!0,a.formulaKeyMap=t,a.startDrag=function(){angular.element(".chart-left-side,.gis-main").css({overflow:"visible"})},a.removePosition=function(){angular.element(".color-setting-layer").css({overflow:"visible"})},a.stop=function(e,o){var t=o.item.sortable.model;return"del"==sortOption.currentAction?(a.removeField(sortOption.originAxis,t),!1):void a.saveChart()},a.del=function(o,t){angular.element(".color-setting-layer,.chart-left-side,.gis-main").css({overflow:""});var r=t.helper.position(),n=$(".color-setting"),l={width:n.width(),height:n.height()},i={width:t.helper.width(),height:t.helper.height()},c=e({x1:0,y1:0,x2:l.width,y2:l.height},{x1:r.left,y1:r.top,x2:i.width+r.left,y2:i.height+r.top});return c?void t.helper.css({left:0,top:0}):(delete a.colorSetting,delete a.currentMeta.color_setting,a.saveChartImmediate(),void o.stopPropagation())},a.clickPanel=function(){a.showColorSettingModalByField()}},controller:["$scope","$rootScope","ngDialog","commonService","chartColorTheme","$q",function(e,t,r,a,n){function l(o){e.currentMeta=o,o&&(e.colorSetting=angular.copy(o.color_setting),i(e.colorSetting))}function i(o){var t=e.currentMeta;if(e.showSeriesColor="graph"!==t.type?!1:!0,!o||e.showSeriesColor)return!1;if(1!=o.mode)e.colors=n[o.theme],s(o);else{for(var r=0,a=e.rangeColorTheme.length;a>r;r++)if(e.rangeColorTheme[r].name==o.theme){e.rangeThemeSelector.theme=e.rangeColorTheme[r];break}c(o.theme),e.colorSetting.range_color.inverse=o.range_color.inverse,e.viewData.enable_step=!!o.range_color.step,e.viewData.step=o.range_color.step||5,e.viewData.disable_max=defined(o.range_color.disable_max)?o.range_color.disable_max:!0,e.viewData.disable_min=defined(o.range_color.disable_min)?o.range_color.disable_min:!0,e.viewData.max=o.range_color.max,e.viewData.min=o.range_color.min}return!0}function c(o){if("custom"!=o){e.colorSetting.range_color=e.colorSetting.range_color||{};var t=bdpChart.rangeColors[o],r=e.colorSetting.range_color.inverse;e.colorSetting.range_color.start_color=r?t[1]:t[0],e.colorSetting.range_color.end_color=r?t[0]:t[1]}}function s(o){for(var t=0,r=e.colorTheme.length;r>t;t++)if(e.colorTheme[t].name==o.theme){e.themeSelector.theme=e.colorTheme[t];break}e.colors=n[o.theme]}function g(o,t,r){return a.field.getFilteredRange(e.chartId,t,o,r).then(function(e){var o=e;return 0==o.status?o.result:null})}function d(o){var t={showNameObj:o,dataObj:angular.copy(o)},r=[].concat(e.currentMeta.y,e.currentMeta.y_optional||[]);r.length>1&&(t.showNameObj.fields=[],t.dataObj.fields=[],r.forEach(function(e){e&&(t.showNameObj.fields.push(e.nick_name||e.name),t.dataObj.fields.push(e.uniq_id))}));var a=function(e,o){if(!e.length)return[[]];var t,r=a(e.slice(1)),n=[];return e[0].forEach(function(e){r.forEach(function(r){t=[e].concat(r),o&&(t=t.join(o)),n.push(t)})}),n},n=function(e){return Object.keys(e)},l=n(t.showNameObj).map(function(e){return t.showNameObj[e]}),i=n(t.dataObj).map(function(e){return t.dataObj[e]});return{showArr:a(l,"_"),dataArr:a(i,"_")}}function u(o,t){if(e.colorSetting&&void 0!==e.colorSetting.mode&&e.colors){var r={};angular.forEach(e.colorSetting.field,function(e){o[e.fid]&&(r[e.fid]=o[e.fid])}),e.originColorValues=angular.copy(o);var a={};(t||!e.colorSetting.enum_color_map)&&(e.colorSetting.enum_color_map={});var n=d(r);n.dataArr.forEach(function(o,t){void 0==a[o]&&(a[o]=e.colorSetting.enum_color_map[o]||void 0,a[o]?a[o].name=n.showArr[t]:a[o]={color:e.colors[t%e.colors.length],name:n.showArr[t]})}),e.colorSetting.enum_color_map=a,e.colorItemsOrder=n.dataArr.slice()}}var h=t.language;e.$watch("chart_ops.meta.layers[currentLayerIndex]",l,!0),e.colorTheme=[],e.rangeColorTheme=[];var m="zh"===h?{"default":"BDP默认 12",contrast:"对比蓝 12",vintage:"葡萄酒 10",blue_sky:"天空蓝 10",green_contrast:"对比绿 10",green_contrast_2:"对比绿 7",green:"绿色 7",gray_blue:"灰蓝 7",purple:"粉紫 5",blue_contrast:"对比蓝 5",gray_red:"灰红 5",gray:"灰色 5"}:{"default":"BDP Default 12",contrast:"Contrast Blue 12",vintage:"Vintage 10",blue_sky:"Sky Blue 10",green_contrast:"Contrast Green 10",green_contrast_2:"Contrast Green 7",green:"Green 7",gray_blue:"Gray-Blue 7",purple:"Purple 5",blue_contrast:"Contrast Blue 5",gray_red:"Gray-Red 5",gray:"Gray 5"},f="zh"===h?{"default":"默认",golden:"渐变金",green:"渐变绿",blue:"渐变蓝",purple:"渐变紫",gray:"渐变灰"}:{"default":"Default",golden:"Gradient Gold",green:"Gradient Green",blue:"Gradient Blue",purple:"Gradient Purple",gray:"Gradient Gray"};angular.forEach(n,function(o,t){e.colorTheme.push({name:t,alias:m[t]})}),angular.forEach(bdpChart.rangeColors,function(o,t){e.rangeColorTheme.push({name:t,alias:f[t]})}),e.rangeColorTheme.push({name:"custom",alias:"自定义"}),e.themeSelector={open:!1,theme:e.colorTheme[0]},e.changeTheme=function(o){o!=e.themeSelector.theme&&(e.themeSelector.theme=o,e.themeSelector.open=!1,e.colors=n[o.name])},e.changeAggr=function(){var o=e.colorSetting.aggregator?1:0;if(o!=e.colorSetting.mode?(e.colorSetting.mode=o,e.colorSetting.theme="default",e.init(e.colorSetting)):(e.colorSetting.theme=e.color_setting?e.color_setting.theme:"default",e.init(e.colorSetting)),0==e.colorSetting.mode){var t=e.chart_ops.meta.layers[e.currentLayerIndex]?e.chart_ops.meta.layers[e.currentLayerIndex]:null;t&&t.tb_id&&e.getFieldValues(e.colorSetting.field,t.tb_id,e.currentLayerIndex).then(function(o){o.total>100?e.viewData.showTips=!0:(e.viewData.showTips=!1,e.buildEnumColorMap(o.result))})}},e.colorPickerOptions={preferredFormat:"hex",showInput:"true",cancelText:"en"===h?"Cancel":"取消",chooseText:"en"===h?"Ok":"确定"},e.rangeThemeSelector={open:!1,theme:e.rangeColorTheme[0]},e.changeRangeTheme=function(o){o!=e.themeSelector.theme&&(e.rangeThemeSelector.theme=o,e.rangeThemeSelector.open=!1,e.colorSetting.theme=o.name,c(o.name))},e.changeRangeColor=function(){e.changeRangeTheme(e.rangeColorTheme[e.rangeColorTheme.length-1])},e.reset=function(){delete e.colorSetting},e.viewData={},e.init=i,e.updateMeta=function(){var t=e.colorSetting?angular.copy(e.colorSetting):o,r=e.$eval("chart_ops.meta.layers[currentLayerIndex]");if(1==t.mode){if(delete t.enum_color_map,!e.handleMaxMin(t.range_color))return!1}else delete t.range_color;return r.color_setting=t,!0},e.handleMaxMin=function(o){var t=!e.viewData.disabled_max&&defined(e.viewData.max),r=!e.viewData.disabled_min&&defined(e.viewData.min);return t&&r&&e.viewData.min>e.viewData.max?(alert("值域最小值不能大于最大值"),!1):(o.disable_max=!!e.viewData.disable_max,o.disable_min=!!e.viewData.disable_min,defined(e.viewData.max)&&(o.max=e.viewData.max),defined(e.viewData.min)&&(o.min=e.viewData.min),!0)},e.getFieldValues=g,e.buildEnumColorMap=u,e.$on("chartFilterChange",function(o,t){if(e.colorSetting&&0==e.colorSetting.mode){var r=e.chart_ops.meta.layers[e.currentLayerIndex]?e.chart_ops.meta.layers[e.currentLayerIndex].tb_id:"";e.getFieldValues(e.colorSetting.field,r,e.currentLayerIndex).then(function(o){o.total<=100&&e.buildEnumColorMap(o.result),e.updateMeta(),e.saveChartImmediate(t.saveChartOpts)})}else e.saveChartImmediate(t.saveChartOpts)}),e.showColorSettingModalByField=function(){e.colorSetting&&(e.preCloseDialog=!1,e.preCloseDialogSure=!1,r.open({className:"ngdialog-theme-default ngdialog-color-setting",templateUrl:"/static/partials/dialogTemplates/color_setting_modal.html",scope:e,controller:"gisColorSettingByFieldCtrl",preCloseCallback:function(){return e.themeSelector.open=!1,e.rangeColorTheme.open=!1,e.preCloseDialog?e.preCloseDialogSure||angular.equals(e.currentMeta.color_setting,e.colorSetting)?!0:confirm("你有修改尚未保存，是否关闭？")?(e.colorSetting=angular.copy(e.currentMeta.color_setting),e.init(e.colorSetting),!0):!1:void 0}}))},e.showColorSettingModalByItem=function(){r.open({className:"ngdialog-theme-default ngdialog-color-setting",templateUrl:"/static/partials/dialogTemplates/series_color_modal.html",data:{colorSetting:e.colorSetting},scope:e,controller:"gisColorSettingByItemCtrl"})}}]}}]).controller("gisColorSettingByFieldCtrl",["$scope","$getCustomFormula","chartColorTheme","commonService",function(e,o){var t=e.chart_ops.meta.layers[e.currentLayerIndex]?e.chart_ops.meta.layers[e.currentLayerIndex]:null;e.showFormulaList=function(){return 1==e.colorSetting.field.length&&1!=e.colorSetting.field[0].is_build_aggregated&&["C360","C230","C320","C340"].indexOf(e.currentMeta.chart_type)<0},0==e.colorSetting.mode&&t&&t.tb_id&&e.getFieldValues(e.colorSetting.field,t.tb_id,e.currentLayerIndex).then(function(o){o.total>100?e.viewData.showTips=!0:(e.viewData.showTips=!1,e.buildEnumColorMap(o.result))}),e.formulaList=o("number"==e.colorSetting.field[0].data_type?["SUM","AVERAGE","MAX","MIN","COUNT","COUNT_DISTINCT"]:["COUNT","COUNT_DISTINCT"]),e.selected={value:"",key:"",color:""},e.applyTheme=function(o){e.colorSetting.theme=o.name,e.buildEnumColorMap(e.originColorValues,!0)},e.selectColor=function(o){angular.forEach(e.selectedColorKeys,function(t){var r=e.colorItemsOrder[t];r&&(e.colorSetting.enum_color_map[r].color=e.colors[o],e.selected.color=e.colors[o])})},e.onColorChange=function(o){angular.forEach(e.selectedColorKeys,function(t){var r=e.colorItemsOrder[t];r&&(e.colorSetting.enum_color_map[r].color=o)})},e.toggleStep=function(o){o?e.colorSetting.range_color.step=e.viewData.step:e.colorSetting.range_color&&(e.colorSetting.range_color.step=0)},e.setStep=function(o){o&&(e.colorSetting.range_color.step=o)},e.selectedColorKeys=[],e.selectItem=function(o,t,r){var a=e.colorSetting.enum_color_map[t];if(o.metaKey||o.ctrlKey)e.selectedColorKeys.push(r);else if(o.shiftKey)if(0==e.selectedColorKeys.length)e.selectedColorKeys=[r];else{var n=e.selectedColorKeys[0];e.selectedColorKeys.length=1;for(var l=r>n?-1:1,i=r;i!=n;)e.selectedColorKeys.push(i),i+=l}else e.selected.color=a.color,e.viewData.selectedColor=a.color,e.selectedColorKeys=[r]},e.isHighlight=function(o){return e.selectedColorKeys.indexOf(o)>-1},e.inverseRangeColor=function(){var o=e.colorSetting.range_color,t=o.start_color;o.start_color=o.end_color,o.end_color=t},e.saveByField=function(){var o=e.colorSetting.field[0];if(1===o.is_build_aggregated&&"number"==o.data_type)for(var t=e.currentMeta,r=0;r<t.y.length;r++)2==t.y[r].is_build_aggregated||0==t.y[r].is_build_aggregated?t.y[r].aggregator="number"===t.y[r].data_type?"SUM":"COUNT":1==t.y[r].is_build_aggregated&&(t.y[r].aggregator="");e.viewData.showTips&&0==e.colorSetting.mode||e.updateMeta()&&(e.saveChartImmediate(),e.closeThisDialog()),e.themeSelector.open=!1,e.rangeColorTheme.open=!1},e.cancelByField=function(){e.$parent.preCloseDialog=!0,e.$parent.preCloseDialogSure=!1,e.closeThisDialog()}}]).controller("gisColorSettingByItemCtrl",["$scope","chartColorTheme",function(e,o){e.series=angular.copy(e.seriesColors),e.series_theme=e.currentMeta.series_theme||"default",e.chartColorTheme=o,e.highlightIndex=0,e.applyTheme=function(t){var r=t.name,a=o[r].length;angular.forEach(e.series,function(e,t){var n=t%a;e.color=o[r][n]}),e.series_theme=t.name,e.viewData.selectedColor=e.series[e.highlightIndex].color},e.selectItem=function(o){e.highlightIndex=o,e.viewData.selectedColor=e.series[o].color},e.isHighlight=function(o){return e.highlightIndex==o},e.selectColor=function(t){if(void 0!=e.highlightIndex){var r=o[e.themeSelector.theme.name];e.series[e.highlightIndex].color=r[t],e.viewData.selectedColor=r[t]}},e.onColorChange=function(o){void 0!=e.highlightIndex&&(e.series[e.highlightIndex].color=o)},e.init(),e.saveByItem=function(){var o=e.isGisColorSetting?e.currentMeta:e.chart_ops.meta.level[e.drill_level];if("C320"===o.chart_type)o.waterfall_setting.color_theme=[],angular.forEach(e.series,function(e){o.waterfall_setting.color_theme.push(e.color)}),o.series_theme=e.series_theme;else if("C330"===o.chart_type)o.funnel_setting.color_theme=[],angular.forEach(e.series,function(e){o.funnel_setting.color_theme.push(e.color)}),o.series_theme=e.series_theme;else if(e.isGisColorSetting){var t=o.y;angular.forEach(t,function(o,t){o.series_color=e.series[t].color}),o.series_theme=e.series_theme}else{var t=o.y.concat(o.y_optional||[]);angular.forEach(t,function(o){for(var t=0;t<e.series.length;t++)o.uniq_id===e.series[t].uniq_id&&(o.series_color=e.series[t].color)}),o.series_theme=e.series_theme}e.saveChartImmediate(),e.closeThisDialog()},e.cancelByItem=function(){e.closeThisDialog()}}])}();
;!function(){function i(i){return{scope:!0,link:function(t,n){n.hover(function(i){var t=n.find(".chart-info-summary"),a=$(".J-scroll-project").width(),c=i.clientX;t.css(200>c-a?{right:"-200px"}:{right:"-25px"})}),t.$on("chart_data_load",function(n,a){{var c=a.info;a.data}i(function(){t.tb_update_time=1e3*c.tb_update_time}),t.width=50,c.xAxis&&(t.xAxis=c.xAxis),c.yAxis&&(t.yAxis=c.yAxis.concat(c.yAxisOptional),angular.forEach(c.yAxis,function(i){var n=hz.cutString.getP(i.nick_name||i.name);n>t.width&&(t.width=n)})),t.width=Math.min(t.width,96)})}}}angular.module("BC.directives").directive("chartInfoSummary",i),i.$inject=["$timeout"]}();
;angular.module("BC.directives").directive("tableConditionalFormatting",["ngDialog","formulaKeyMap","AdvfilterOperatorList","setAdvanceAggregatorName",function(e,r,o){return{scope:!0,link:function(r){function t(e,r){if(!e)return[];var o=[];switch(e){case"C200":o=a(r);break;case"C261":o=n(r);break;case"C310":o=i(r);break;default:o=[]}return o}function a(e){var o=[];return angular.forEach(e,function(e){var t=c(e),a=angular.extend({},e);if(u(a),t){if(a.y=t,t.nick_name)a.alias=t.nick_name;else{var n=r.setAdvanceAggregatorName(t);a.alias=n?t.name+n:t.name}o.push(a)}}),o}function n(e){var r=[];return angular.forEach(e,function(e){var o=angular.extend({},e);u(o),o.alias="完成率",r.push(o)}),r}function i(e){return a(e)}function l(e){var o=[];if(!angular.isArray(e))return o;var a=r.currentMeta.chart_type;return o=t(a,e)}function c(e){if(!r.currentMeta||!r.currentMeta.y)return!1;for(var o=r.currentMeta.y.concat(r.currentMeta.y_optional||[]),t=0,a=o.length;a>t;t++){var n=o[t];if(e.fid==n.fid&&e.uniq_id==n.uniq_id)return n}}function u(e){e.range=12==e.operator?e.value:[]}r.$watch("chart_ops.meta.level[drill_level]",function(e){r.currentMeta=e}),r.$watchCollection("currentMeta.tb_conditional_formatting",function(e){var o=angular.copy(e);angular.forEach(o,function(e){$.isArray(e.value)?angular.forEach(e.value,function(r,o){e.value[o]=e.isPercentage&&e.isPercentage[o]&&r&&-1==r.toString().indexOf("%")?100*r+"%":1*r}):e.value=e.isPercentage&&e.isPercentage[0]&&-1==e.value.toString().indexOf("%")?100*e.value+"%":1*e.value}),r.$view=l(o)}),r.$on("broadcastChangeTableFormattingName",function(){r.$view=l(r.currentMeta.tb_conditional_formatting)}),r.operatorMap=o,r.showDialog=function(){var o="",t=r.currentMeta.chart_type;"C261"==t?o="gauge-formatting-modal":"C310"==t&&(o="kpi-formatting-modal"),e.open({templateUrl:"/static/partials/dialogTemplates/table_conditional_formatting.html",className:"ngdialog-theme-default table-formatting-modal "+o,scope:r,controller:"tableConditionalFormattingSetting"})}}}}]).controller("tableConditionalFormattingSetting",["$scope","formulaKeyMap","setAdvanceAggregatorName","AdvfilterOperatorNumberMap","operatorHelpLink","errHint",function(e,r,o,t,a,n){function i(e){return 1*e}function l(e){return e.indexOf("%")>-1?e.match(/(\d+)%$/)[1]/100:e}function c(r){var o={1:{C200:{backgroundColor:"#303349",color:"#fff"},C261:{backgroundColor:"#9ACC67"},C310:{color:"#E45151"}},2:{C200:{backgroundColor:"#fff",color:"#333"},C261:{backgroundColor:"#9ACC67"},C310:{color:"#E45151"}}},t={range:[],style:o[usedThemeId][r]};return"C310"===r?t.shape_type="arrow-up":"C261"===r&&(t.fid=e.yAxis[0].fid,t.uniq_id=e.yAxis[0].uniq_id),t}function u(r){for(var o=0,t=e.yAxis.length;t>o;o++)if(e.yAxis[o].uniq_id==r)return e.yAxis[o].fid;return null}e.conditions=angular.copy(e.$view),e.operatorList=t,e.yAxis=[],e.displayText=["C200","C310"].indexOf(e.currentMeta.chart_type)>-1?"Aa":"";var s=e.currentMeta.y.concat(e.currentMeta.y_optional||[]);angular.forEach(s,function(r){var o=angular.copy(r);if(r.nick_name)o.alias=r.nick_name;else{var t=e.setAdvanceAggregatorName(r);o.alias=t?r.name+t:r.name}e.yAxis.push(o)}),e.tbConditionSort={handle:".ico-order"},e.save=function(){var r=[],o=e.currentMeta.chart_type,t=function(e,r,o){return r.toString().indexOf("%")>-1?(e.isPercentage[o]=!0,r=l(r)):(r=i(r),e.isPercentage[o]=!1),r};if("C200"===o||"C310"===o)for(var a=0;a<e.conditions.length;a++){var c=e.conditions[a];if(12==c.operator&&(c.value=c.range),!c.uniq_id||void 0==c.operator||$.isEmptyObject(c.value))return n("请填写完整的条件信息"),!1}else if("C261"===o)for(var a=0;a<e.conditions.length;a++){var c=e.conditions[a];if(12==c.operator&&(c.value=c.range),void 0==c.operator||$.isEmptyObject(c.value))return n("请填写完整的条件信息"),!1}angular.forEach(e.conditions,function(a){a.isPercentage=a.isPercentage||[],$.isArray(a.value)?angular.forEach(a.value,function(e,r){a.value[r]=t(a,e,r)}):a.value=t(a,a.value,0);var n={fid:u(a.uniq_id),uniq_id:a.uniq_id,operator:a.operator,value:a.value,style:a.style,isPercentage:a.isPercentage};"C310"===o?(n.shape_type=a.shape_type,e.currentMeta.y.forEach(function(e){n.uniq_id===e.uniq_id&&(delete e.series_color,e.BDP_TCF=!1)})):"C261"===o&&e.currentMeta.y.forEach(function(e){n.uniq_id===e.uniq_id&&(delete e.series_color,e.BDP_TCF=!1)}),r.push(n)}),0===e.conditions.length&&"C310"===o&&(e.currentMeta.y[0].series_color||(e.currentMeta.y[0].series_color="#a3abb0"),e.currentMeta.y[1]&&!e.currentMeta.y[1].series_color&&(e.currentMeta.y[1].series_color="#a3abb0")),e.currentMeta.tb_conditional_formatting=r,e.saveChartImmediate(),e.closeThisDialog()},e.changeOperator=function(e){if(e){var r=$(e.target).nextSibling().find("input");0==r.length&&r.focus().select()}},e.add=function(){e.conditions.push(c(e.currentMeta.chart_type))},e.remove=function(r){e.conditions.splice(r,1)},e.clearNoNum=function(e,r,o){function t(e){return e?(e=e.toString(),e=e.replace(/[^\d\.%-]/g,""),e=e.replace(/^[\.|%]/g,""),e=e.replace(".","$#$").replace(/\./g,"").replace("$#$","."),e=e.replace("%","$#$").replace(/%/g,"").replace("$#$","%")):""}angular.isNumber(o)?e[r][o]=t(e[r][o]):e[r]=t(e[r])},e.setAdvanceAggregatorName=o,e.goHelp=function(e){a(e)},e.init=function(r){e.matching=r.getAttribute("style")},e.tableColor={C200:[{style:{backgroundColor:"#FDE4E4",color:"#EE4B4B"}},{style:{backgroundColor:"#E3F2EB",color:"#40A276"}},{style:{backgroundColor:"#FFF6E7",color:"#FF9800"}},{style:{backgroundColor:"#EBF5FC",color:"#7ABCE9"}},{style:{backgroundColor:"#EE4B4B",color:"#FFFFFF"}},{style:{backgroundColor:"#40A276",color:"#FFFFFF"}},{style:{backgroundColor:"#FFC063",color:"#FFFFFF"}},{style:{backgroundColor:"#72AFD9",color:"#FFFFFF"}},{style:{backgroundColor:"#984337",color:"#FFFFFF"}},{style:{backgroundColor:"#A999C9",color:"#FFFFFF"}},{style:{backgroundColor:"#898E94",color:"#FFFFFF"}},{style:{backgroundColor:"#D8D9DA",color:"#FFFFFF"}}],C261:[{style:{backgroundColor:"#5182E4"}},{style:{backgroundColor:"#9BCC66"}},{style:{backgroundColor:"#3FB27E"}},{style:{backgroundColor:"#F7CB4A"}},{style:{backgroundColor:"#F88D48"}},{style:{backgroundColor:"#F35352"}},{style:{backgroundColor:"#CE62D6"}},{style:{backgroundColor:"#8954D4"}},{style:{backgroundColor:"#5156B8"}},{style:{backgroundColor:"#51B4F1"}},{style:{backgroundColor:"#69D4DB"}},{style:{backgroundColor:"#D42D6B"}}],C310:[{shape_type:"arrow-up",style:{color:"#EF4B4A"}},{shape_type:"arrow-down",style:{color:"#40A276"}},{shape_type:"arrow-equal",style:{color:"#A3ABB0"}},{shape_type:"",style:{color:"#EF4B4A"}},{shape_type:"",style:{color:"#FD642D"}},{shape_type:"",style:{color:"#EF9D01"}},{shape_type:"",style:{color:"#40B27E"}}],shapes:["arrow-down","arrow-up","arrow-equal","ok","remove","attention"],changeTemplate:function(r,o,t,a){r.style=o.style,void 0!==o.shape_type&&(r.shape_type=o.shape_type),e.selectedIndex=a,e.tableColor.setCustomStyle(o.style,a,!1)},changeShape:function(e,r){e.shape_type=r},setCustomStyle:function(e,r,o){if(o){if(this.clickedCondition==r&&o)return void(this.clickedCondition=-1);this.clickedCondition=r;var t=angular.element(".dialog-condition-item").eq(r),a=t.find(".tf-bg-color .sp-preview-inner"),n=t.find(".tf-text-color .sp-preview-inner");a.css({"background-color":e.backgroundColor,margin:"-7px 4px"}).addClass("color-matching"),n.css({"background-color":e.color,margin:"-7px 4px"}).addClass("color-matching color-border")}}}}]);
;angular.module("BC.directives").directive("ngEditable",["$timeout",function(t){return{restrict:"A",scope:{text:"=editText",onCommit:"&"},template:'<div class="ng-text-wrap" ng-class="{hidden: editting}"><p class="ng-editable nowrap">{{text}}</p><a class="bdp-icon-wrap edit-btn" title="{{\'rename\' | translate}}" ng-click="edit($event)"><i class="bdp-icon ico-text-edit"></i></a></div><div class="ng-edit-wrap" ng-show="editting"><input type="text" class="ng-editable" value="{{text}}"/><a class="bdp-icon-wrap confirm-btn" title="{{\'ok\' | translate}}" ng-click="commit(text, $event)"><i class="bdp-icon ico-ok"></i></a></div>',link:function(i,n){function e(){var t=a.val();t.length>0&&(i.text=a.val(),i.onCommit({text:i.text})),i.editting=!1}var o=i.text;i.edit=function(e){return i.editting=!0,e.stopPropagation(),a.val(i.text),o=i.text,t(function(){n.find("input").select().focus()},0),!1};var a=n.find("input").on("click",function(t){t.stopPropagation()}).on("blur",function(){t(function(){i.editting=!1},500)}).on("keypress",function(t){13===t.keyCode&&(e(),i.$$phase||i.$digest())});i.commit=function(t,i){return e(),i.stopPropagation(),!1}}}}]);
;!function(){angular.module("BC.directives").directive("advanceDataFormula",["$timeout",function(e){return{scope:{expressionContent:"=",onBlur:"&",onKeyUp:"&"},link:function(n,o,t){function r(){i=CodeMirror.fromTextArea(o[0],{mode:"text/x-bdp-sql",indentWithTabs:!0,smartIndent:!0,lineWrapping:!0,matchBrackets:!0,readOnly:a?"nocursor":!1,theme:"paraiso-light",autofocus:!a,extraKeys:{"Ctrl-Space":"autocomplete"}}),e(function(){void 0!=n.expressionContent&&i.setValue(n.expressionContent)},200),i.on("blur",function(){var e=i.getValue().replace(/0xa0/,"");n.onBlur({content:e})}),i.on("keyup",function(){var e=i.getValue().replace(/0xa0/,"");n.onKeyUp({flag:!0,content:e})})}var i,a=!!t.readonly,c={funcQueue:[],loadLibInProgress:!1};thirdPluginLoader({initFun:r,libSrc:"https://m1.bdp.cn/static/js/lib/bdpFormula/bdp-codemirror_4fc5c0e.js",otherSrc:"",libId:window.CodeMirror},c),n.$on("changeDateExpression",function(e,n){i.setValue(n)}),n.$on("insertFieldNameToExpression",function(e,n){if(defined(n)){var o="["+n+"]",t=i.getCursor();i.replaceSelection(o),i.setCursor(t.line+1,t.ch+o.length),i.focus()}})}}}])}();
;angular.module("BC.directives").directive("dateAdvanceEdit",["$rootScope","errHint","commonService","commonHttp","$stateParams","$timeout","$jsTipTranslate",function(e,t,a,i,n,s,r){return{restrict:"A",templateUrl:"/static/partials/directiveTemplates/dateAdvanceEdit.html",link:function(d,o){function c(e){var t=!1;return angular.forEach(g,function(a){a.name==e&&(t=!0)}),t}var l=e.language||"zh",p="未命名",u="日期",m=0;"en"==l&&(p="Untitled",u="DATE");var f=angular.copy(GlobalConstant.defaultAdvDateConfig);f.is_global=2,d.listLoading=!0,d.infoLoading=!1,d.hasNew=!1,d.model=!1,d.tempData={name:""},d.dateAdvanceData={},d.dateAdvanceView={},d.dateAdvanceList=[],d.dateFieldId=[],d.selected_date_opt_id="";var g=d.dateAdvanceList;d.$on("showDateAdvanceEdit",function(e,t){t&&(d.selected_date_opt_id="",d.dateAdvance.getList())}),d.dateAdvance={getList:function(){var e=d.filterView.selected_opt,i=d.filterStatus[e],r={};angular.forEach(i.tables,function(e){!!e.show&&(r[e.tb_id]=e.selected)}),d.dateFieldIds=angular.copy(r),a.dash_global_filter.range({dash_id:n.dashId,rule_id:d.ruleId,df_id:e,selected_tables:angular.toJson(r),granularity:i.config.granularity}).success(function(e){"0"===e.status?(d.dateAdvanceList=e.result.range||[],d.dateAdvanceList.length>0&&s(function(){d.dateAdvance.turnToLastItem()}),d.listLoading=!1):t(Number(e.status))})},getInfo:function(e,i){return d.hasNew?void t(d.tips["filter.pleaseSaveCurrentFilterItem"]):(d.infoLoading=!0,d.selected_date_opt_id=e,d.tempData=f,d.tempData.name=i,a.adv_date.info(e).success(function(e){"0"==e.status?(d.tempData=angular.fromJson(e.result),d.dateAdvance.setDefaultData(e.result),d.infoLoading=!1):t(Number(e.status))}),void(m=angular.element(o).find(".item-list").get(0).scrollTop))},setDefaultData:function(e){if("accurate"!==d.tempData.type?(d.tempData.accurate.start="",d.tempData.accurate.end=""):(d.tempData.accurate.start=e.accurate.start,d.tempData.accurate.end=e.accurate.end),d.tempData.fixed.hasOwnProperty("granularity")||(d.tempData.fixed.granularity="day"),"expression"===d.tempData.type){var t=new RegExp("\\[_field_id_\\]","g");d.tempData.expression=d.tempData.expression.replace(t,"["+u+"]"),s(function(){d.$broadcast("changeDateExpression",d.tempData.expression)},50)}else s(function(){d.$broadcast("changeDateExpression","")},50);d.original_is_global=d.tempData.is_global},createItem:function(){return d.hasNew?void t(d.tips["filter.pleaseSaveCurrentFilterItem"]):(d.tempData=angular.copy(f),d.selected_date_opt_id="newId",d.model="create",d.tempData.name=p,$(".date-advance-name > input").focus(),d.dateAdvanceList.push(d.tempData),scrollToBottom(angular.element(o).find(".item-list")),void(d.hasNew=!0))},clickFun:function(e){e&&e.stopPropagation(),d.tempData.name==p&&(d.tempData.name="")},blurFun:function(e){e&&e.stopPropagation(),d.tempData.name||(d.tempData.name=p),d.tempData.name&&d.tempData.name!=p&&c(d.tempData.name)&&(t(d.tips["filter.duplicatedNames"]),d.tempData.name="")},changeTypeFun:function(e){if(e&&e.stopPropagation(),"expression"===d.tempData.type){var t=new RegExp("\\[_field_id_\\]","g");d.tempData.expression=d.tempData.expression.replace(t,"["+u+"]"),s(function(){d.$broadcast("changeDateExpression",d.tempData.expression)},50)}else s(function(){d.$broadcast("changeDateExpression","")},50)},fixedGranularityChange:function(e){e&&e.stopPropagation(),d.tempData.fixed.start="day"==d.tempData.fixed.granularity?30:1},deleteItem:function(e,i,n){e&&e.stopPropagation();var s=d.filterView.selected_opt;if("newId"==d.selected_date_opt_id)d.dateAdvanceList.splice(n,1),d.hasNew=!1,d.dateAdvanceList.length>0&&d.dateAdvance.getInfo(d.dateAdvanceList[0].opt_id,d.dateAdvanceList[0].name);else{if(!confirm(d.tips["filter.delTip"]))return;i.opt_id==d.selected_date_opt_id&&(d.selected_date_opt_id=""),a.adv_date.global_del(i.opt_id,s).success(function(e){0==e.status?(d.dateAdvance.getList(),t(d.tips.delSuccess)):t(Number(e.status))})}},modifyItem:function(){if(0!=d.dateAdvanceList.length){var e=d.selected_date_opt_id||"",i=n.dashId,s=d.tempData.name,r=d.tempData.is_global,o=d.filterView.selected_opt;if(!s)return void t(d.tips["filter.nullTitle"]);if(c(s)&&(t(d.tips["filter.duplicatedNames"]),d.tempData.name=""),(2!==d.original_is_global||0!==r||confirm(d.tips["filter.changeScopeTip2"]))&&("newId"==e&&(e=""),d.dateAdvance.formatData())){var l=angular.toJson(d.tempData);a.adv_date.global_modify(i,e,o,l).success(function(e){0==e.status?(d.dateAdvance.getList(),e.result.hasOwnProperty("opt_id")&&(d.selected_date_opt_id=e.result.opt_id),d.hasNew=!1,t(d.tips.saveSuccess)):t(Number(e.status))})}}},formatData:function(){var e=!0,i=d.tempData.type,s=d.tempData.accurate.start,r=d.tempData.accurate.end;if("fixed"===i)"0"===d.tempData.fixed.start&&(t(d.tips["filter.inputPositiveNumber"]),e=!1),isNaturalNumber(d.tempData.fixed.start)&&isNaturalNumber(d.tempData.fixed.end.value)||(t(d.tips["chart.plzTypePositionInteger"]),e=!1);else if("accurate"===i)"string"==typeof s&&(s=new Date(s)),"string"==typeof r&&(r=new Date(r)),s||r||(t(d.tips["filter.nullData"]),e=!1),s.getTime()-r.getTime()>0&&(t(d.tips["chart.dateRangeInvalid"]),e=!1);else if("relative"===i);else if("expression"===i){var o=d.selected_date_opt_id||"",c=n.dashId,l=d.dateAdvance.checkFormulaGrammar(),p=d.filterView.selected_opt;l&&l.then(function(i){if(i){d.tempData.accurate.start=Highcharts.dateFormat("%Y-%m-%d",s),d.tempData.accurate.end=Highcharts.dateFormat("%Y-%m-%d",r);var n=angular.toJson(d.tempData);a.adv_date.global_modify(c,o,p,n).success(function(e){0==e.status?(d.dateAdvance.getList(),e.result.hasOwnProperty("opt_id")&&(d.selected_date_opt_id=e.result.opt_id),d.hasNew=!1,t(d.tips.saveSuccess)):t(Number(e.status))}),e=!1}else t(d.tips["filter.checkFailed"]),d.checkFormulaGrammarFlag=!1,e=!1;return e}),e=!1}return d.tempData.accurate.start=Highcharts.dateFormat("%Y-%m-%d",s),d.tempData.accurate.end=Highcharts.dateFormat("%Y-%m-%d",r),e},setExpression:function(e){d.tempData.expression=e},expressionChanged:function(e){d.expressionChangedFlag=e},insertFieldNameToExpression:function(){d.expressionChangedFlag=!0,d.$broadcast("insertFieldNameToExpression",u)},checkFormulaGrammar:function(){var e=d.tempData.expression;if(""==e)return void t(d.tips["filter.pleaseInputExpression"]);var a=u,s=new RegExp("\\["+a+"\\]","g");d.tempData.expression=e.replace(s,"[_field_id_]");var r=[],o=[];angular.forEach(d.dateFieldIds,function(e,t){r.push(t),o.push(e)});var c={dash_id:n.dashId,tb_id:angular.toJson(r),fid:angular.toJson(o),expression:d.tempData.expression};return d.expressionChangedFlag=!1,i.post("/api/expression/syntax_verify",c).then(function(e){return 0==e.status?(t(d.tips["filter.checkSuccess"]),d.checkFormulaGrammarFlag=!0,!0):(t(d.tips["filter.checkFailed"]),d.checkFormulaGrammarFlag=!1,!1)})},turnToLastItem:function(){var e="",t="";!d.selected_date_opt_id&&d.dateAdvanceList.length>0?(d.selected_date_opt_id=d.dateAdvanceList[0].opt_id,e=d.selected_date_opt_id,t=d.dateAdvanceList[0].name):(angular.forEach(d.dateAdvanceList,function(a){a.opt_id==d.selected_date_opt_id&&(e=d.selected_date_opt_id,t=a.name)}),scrollToBottom(angular.element(o).find(".item-list"),m)),d.dateAdvance.getInfo(e,t)}},d.returnGlobalFilter=function(){d.showDateAdvanceEdit=!1,d.hasNew=!1,$(".ngdialog-close").css("display","inline-block"),d.$emit("hideDateAdvanceEdit",!0)},r(["saveSuccess","fail","delSuccess","filter.pleaseSaveCurrentFilterItem","filter.checkSuccess","filter.checkFailed","filter.pleaseInputExpression","filter.nullData","chart.dateRangeInvalid","filter.inputPositiveNumber","chart.plzTypePositionInteger","filter.changeScopeTip2","filter.nullTitle","filter.duplicatedNames","filter.delTip"],d)}}}]);
;!function(){angular.module("BC.directives").directive("chartWarning",["commonHttp","formulaKeyMap","warnOperatorMap","ngDialog","errHint","$stateParams","setAdvanceAggregatorName","$translate","$jsTipTranslate",function(a,t,i,n,e,r,s,l,o){return{restrict:"A",templateUrl:"/static/partials/chart_warning_list.html",replace:!1,link:function(a){a.warns=[],a.warnItemIDFlag=0,a.y_warns=a.$parent.y_warns||[],a.y_optional_warns=a.$parent.y_optional_warns||[],a.$on("chart_data_warn",function(t,i){a.$parent.y_warns=a.y_warns=[],a.$parent.y_optional_warns=a.y_optional_warns=[];var n={};angular.forEach(i,function(t){a.warnItemIDFlag++,n={id:"warn_item_id_"+a.warnItemIDFlag,warn_id:t.warn_id,warn_name:t.warn_name,warn_time:t.warn_time,meta:t.meta,axis_type:t.axis_type,type:t.type,"switch":t.switch},0==t.axis_type&&a.y_warns.push(n),1==t.axis_type&&a.y_optional_warns.push(n)}),a.$$phase||a.$apply()}),a.$watch("global.watch",function(){a.getYaxisFields()}),a.getYaxisFields=function(){if(a.chart_ops){var t,i=[],n=a.chart_ops.meta.level[a.drill_level][a.axis_type];angular.forEach(n,function(n){if("row_summary"!=n.fid)if(n.nick_name)t=n.nick_name,i.push({name:t,fid:n.fid,uniq_id:n.uniq_id});else{t=n.name;var e=a.setAdvanceAggregatorName(n);i.push(e?{name:t+e,fid:n.fid,uniq_id:n.uniq_id}:{name:t,fid:n.fid,uniq_id:n.uniq_id})}}),"y"==a.axis_type?a.field_list_y=i:a.field_list_y_optional=i}},a.showSetWarningDialog=function(t){return a.axis_type=t,a.getYaxisFields(),a.chart_ops.meta.level[a.drill_level][t].length?void n.open("y"==a.axis_type?{template:"/static/partials/chart_warning_config.html",className:"ngdialog-theme-default ngDialog-width-600 set-warning-dialog",scope:a,data:{warnYList:a.y_warns,warnYOptionalList:a.y_optional_warns,yFieldsList:a.field_list_y,yOptionalFieldsList:[],isYAxis:!0,isYOptionalAxis:!1,rule_id:r.ruleId,ct_id:r.chartId,role_type:0,isDash:!1},controller:"chartWarnConfigCtrl"}:{template:"/static/partials/chart_warning_config.html",className:"ngdialog-theme-default ngDialog-width-600 set-warning-dialog",scope:a,data:{warnYList:a.y_warns,warnYOptionalList:a.y_optional_warns,yFieldsList:[],yOptionalFieldsList:a.field_list_y_optional,isYAxis:!1,isYOptionalAxis:!0,rule_id:r.ruleId,ct_id:r.chartId,role_type:0,isDash:!1},controller:"chartWarnConfigCtrl"}):void e(a.tips["chart.notAllowSetWarn"])},o(["warn.inputWarnName","warn.valueCompareTips","filter.inputCompleteCondition","warn.valueOutOfRange","warn.inputFormatError"],a)}}}]).directive("warningAmount",[function(){return{restrict:"A",controller:["$scope","commonHttp","$rootScope","$timeout",function(a,t,i){var n=function(){t.get("/api/warn/amount").then(function(a){"0"===a.status&&(i.unread=a.result.unread)})};n();var e="_websocketChartMessage_";a.$on(e,function(a,t){var n="string"==typeof t.data?$.parseJSON(t.data):t.data;5==n.type&&(i.unread=n.count)})}]}}])}();
;!function(){angular.module("BC.directives").directive("plotLine",["ngDialog","$timeout","chartLineType","$getCustomFormula","formulaKeyMap","operatorHelpLink","setAdvanceAggregatorName","$jsTipTranslate",function(e,t,l,i,n,a,o,r){return{restrict:"A",templateUrl:"/static/partials/plot_line.html",link:function(s){var p="y";s.formulaMap=n,s.goHelp=function(e){a(e)};var c=function(e){function t(e){var t="",l="";return e.nick_name?t=e.nick_name:(t=e.name,l=s.setAdvanceAggregatorName(e),l&&(t+=l)),t}var l=[],i=[],n=[],a=s.chart_ops.meta.level[s.drill_level];a.y_scatter?angular.map(a.y_scatter||[],function(e){e.alias_name=t(e),i.push(e)}):angular.map(a.y||[],function(e){e.alias_name=t(e),i.push(e)}),s.originFields=angular.copy(i),"C250"==s.selected_type&&(angular.map(a.y_optional||[],function(e){e.alias_name=t(e),l.push(e)}),s.originFieldsRight=angular.copy(l)),s.fields=angular.copy("y_optional"!==e?i:l),"C280"==s.selected_type&&(angular.map(a.y||[],function(e){e.alias_name=t(e),n.push(e)}),s.originFieldsX=angular.copy(n),s.fieldsX=angular.copy(n))};s.initPlotLinesData=function(e){if(s.chart_ops){c(e),s.plotLinesLeft=[],s.plotLinesLeftX=[];var t=s.chart_ops.meta.level[s.drill_level];t.guide_line&&(s.plotLinesLeft=[].concat(t.guide_line)),s.showPlotLines=s.plotLinesLeft.length?angular.copy(s.plotLinesLeft):[],"C250"==s.selected_type&&(s.plotLinesRight=[],t.guide_line_right&&(s.plotLinesRight=[].concat(t.guide_line_right)),s.showPlotLinesRight=s.plotLinesRight.length?angular.copy(s.plotLinesRight):[]),"y_optional"!==e?(s.plotLinesY=angular.copy(s.plotLinesLeft),p="y"):(s.plotLinesY=angular.copy(s.plotLinesRight),p="y_optional"),"C280"==s.selected_type&&(t.guide_line_x&&(s.plotLinesLeftX=[].concat(t.guide_line_x)),s.showPlotLinesX=s.plotLinesLeftX.length?angular.copy(s.plotLinesLeftX):[],s.plotLinesX=angular.copy(s.plotLinesLeftX))}},s.lineType=l,s.calcuType=i(["AVG","MIN","MAX"]),s.setPlotLine=function(t){s.initPlotLinesData(t),e.open({templateUrl:"/static/partials/add_plot_line.html",className:"ngdialog-theme-default ng-plot-line-dialog",scope:s}),"C280"==s.selected_type?0==s.plotLinesY.length&&0==s.plotLinesX.length&&(s.addPlotLineY(),s.addPlotLineX()):0==s.plotLinesY.length&&s.addPlotLineY()},s.addPlotLine=function(e,t,l){e.push({name:l,value_type:"constant",value:"",fid:"",uniq_id:"",formula:"AVG"}),t.length&&(e[e.length-1].fid=t[0].fid,e[e.length-1].uniq_id=t[0].uniq_id)},s.addPlotLineY=function(){if("C280"==s.selected_type)var e=s.tips["chart.lateral"]+"("+(s.plotLinesY.length+1)+")";else if("y"==p)var e=s.tips["chart.guideLine"]+"("+(s.plotLinesY.length+1)+")";else if("y_optional"==p)var e=s.tips["chart.guideLine"]+(s.plotLinesY.length+1);s.addPlotLine(s.plotLinesY,s.fields,e)},s.addPlotLineX=function(){var e=s.tips["chart.vertical"]+"("+(s.plotLinesX.length+1)+")";s.addPlotLine(s.plotLinesX,s.fieldsX,e)},s.removeThisLineY=function(e){s.plotLinesY.splice(e,1);for(var t=0;t<s.plotLinesY.length;t++)s.plotLinesY[t].name===s.tips["chart.lateral"]+"("+(t+2)+")"&&"C280"==s.selected_type?s.plotLinesY[t].name=s.tips["chart.lateral"]+"("+(t+1)+")":s.plotLinesY[t].name===s.tips["chart.guideLine"]+"("+(t+2)+")"&&(s.plotLinesY[t].name=s.tips["chart.guideLine"]+"("+(t+1)+")")},s.removeThisLineX=function(e){s.plotLinesX.splice(e,1);for(var t=0;t<s.plotLinesX.length;t++)s.plotLinesX[t].name===s.tips["chart.vertical"]+"("+(t+2)+")"&&(s.plotLinesX[t].name=s.tips["chart.vertical"]+"("+(t+1)+")")},s.reCheck=function(e,t){for(var l=e.length-1;l>-1;l--)if(e.length>0){var i=e[l];if(""===i.name)return alert(s.tips["chart.lineNameRequired"]),!1;if("constant"==i.value_type&&(""===i.value||isNaN(Number(i.value))))return alert(s.tips["chart.lineValueMustBeNumber"]),!1;if("calculate"==i.value_type&&""==i.uniq_id)return alert(s.tips["chart.lineCalcFidRequired"]),!1;"constant"==i.value_type&&(i.value=Number(i.value)),t.push(i)}return!0},s.save=function(){var l=[];if("C280"==s.selected_type){if(!s.reCheck(s.plotLinesY,l)||!s.reCheck(s.plotLinesX,l))return!1}else if(!s.reCheck(s.plotLinesY,l))return!1;for(var i=0;i<l.length;i++)for(var n=i+1;n<l.length;n++)if(l[i].name==l[n].name)return alert(s.tips["chart.lineNameRepeats"]),!1;angular.forEach(s.fields,function(e){delete e.alias_name}),angular.forEach(s.fieldsX,function(e){delete e.alias_name});var a="y"==p?"guide_line":"guide_line_right";t(function(){(1!=s.plotLinesY.length||""!=s.plotLinesY.value)&&(s.chart_ops.meta.level[s.drill_level][a]=s.plotLinesY),"C280"==s.selected_type&&(1!=s.plotLinesX.length||""!=s.plotLinesX.value)&&(s.chart_ops.meta.level[s.drill_level].guide_line_x=s.plotLinesX);var e=s.$bdpChart.data,t=!1;s.plotLinesY.forEach(function(e){"calculate"===e.value_type&&(t=!0)}),"C280"==s.selected_type&&s.plotLinesX.forEach(function(e){"calculate"===e.value_type&&(t=!0)}),e[a]=s.plotLinesY,e.guide_line_x=s.plotLinesX,"y"===p?s.showPlotLines=s.plotLinesY:s.showPlotLinesRight=s.plotLinesY,s.showPlotLinesX=s.plotLinesX,s.saveChartImmediate(t?{not_need_redraw:!1,only_refresh_data:!1,is_drill_chart:!!s.drill_level}:{only_redraw:!0,is_drill_chart:!!s.drill_level})},100),e.closeAll()},s.setAdvanceAggregatorName=o,r(["chart.lineNameRequired","chart.lineValueMustBeNumber","chart.lineCalcFidRequired","chart.lateral","chart.vertical","chart.lineNameRepeats","chart.guideLine"],s)},controller:["$scope",function(e){e.$watch("global.watch",function(){e.initPlotLinesData("init")})}]}}])}();
;angular.module("BC.directives").directive("chartFullScreen",["ngDialog","$timeout","$interval",function(e){function l(l,a,n){l.$on("ngDialog.opened",function(){$(".fs-queue-show").addClass("active")}),a.on("click",function(){l.chartUrl=l.$eval(n.chartUrl),l.domid=l.$eval(n.domid),l.standardItems=l.$eval(n.standardItems),l.autoPlaying=!1,l.showExtralCtrl=!0,$("#MEIQIA-BTN-HOLDER")&&$("#MEIQIA-BTN-HOLDER").css("display","none"),$("body").addClass("fs-chart-mode"),t=e.open({templateUrl:"/static/partials/dialogTemplates/fullscreen.html",className:"ngdialog-theme-default fullscreen-modal",showClose:!1,scope:l,preCloseCallback:function(){$(document).off("keydown.fs_key_ctrl"),$(document).off("mousemove.fs_mouse_ctrl"),$("#MEIQIA-BTN-HOLDER")&&$("#MEIQIA-BTN-HOLDER").css("display","block"),$("body").removeClass("fs-chart-mode")},controller:"fullscreenCtrl"})})}var t,a="zh"==bdpChart.language?"全屏显示":"Full screen display",n={link:l,template:'<a class="bdp-icon-wrap" title="'+a+'"><i class="bdp-icon ico-fullscreen"></i></a>',restrict:"EA",replace:!0,scope:!0};return n}]).controller("fullscreenCtrl",["$scope","$rootScope","$timeout","$interval","ngDialog","autoRefreshChart",function(e,l,t,a,n,s){function i(){for(var l=0,t=0;t<u.length;t++)if(e.chartUrl[e.domid].options.ct_id===u[t].children[0].meta.ct_id){l=t;break}e.fullscreen.index=l,e.fullscreen.name=u[e.fullscreen.index].children[0].meta.name,o("show",l),e.fullscreen.info=e.fullscreen.queue_show;var a="_websocketChartMessage_";e.$on(a,function(l,t){var a="string"==typeof t.data?$.parseJSON(t.data):t.data;1==a.type&&s.refresh({drawChartUrl:e.fullscreen.queue_show,type:"fullscreen",evt:l,scope:e,ret:t})});e.$bdpChart}function o(l,t){var t=c(t,0),a=u[t].children[0];$.extend(e.fullscreen["queue_"+l],{index:t,name:a.meta.name,chart_type:a.meta.type,filter_opts:a,dom_id:a.dom_id,options:{theme:1===e.fullDisplayTheme?"dark":"default",device:e.fullDisplayDevice||"pc",_t:new Date,ct_id:a.meta.ct_id,dsh_id:d,optional:{chart_jump_info:a.meta.chart_jump}},lazyload:!1},!0);var n=e.chartUrl[u[t].children[0].dom_id].options,s=n.optional;e.fullscreen["queue_"+l].options.is_tpl=n.is_tpl,s.filter_list&&(e.fullscreen["queue_"+l].options.optional.filter_list=s.filter_list),s.dsh_filter&&(e.fullscreen["queue_"+l].options.optional.dsh_filter=s.dsh_filter),s.sdo_id&&(e.fullscreen["queue_"+l].options.optional.sdo_id=s.sdo_id),n.rule_id&&(e.fullscreen["queue_"+l].options.optional.rule_id=n.rule_id),n.ws_id&&(e.fullscreen["queue_"+l].options.optional.ws_id=n.ws_id),e.drillOption&&(e.drillOption=void 0)}function r(){var e="%",l=100,t="50%",a=24,n=$(".J_chart"),s=$(".fullscreen-modal"),i=s.find(".drill-crumbs-wrap").height(),o=$(".J_filterWrap"),r=$(".J_filterWrap_hidden");o.css({visibility:"hidden"});var c=$(".J_filter",o),d=$(".J_dateGranularity",o),u=$(".J_filter_hidden",r),f=$(".J_dateGranularity_hidden",r),h=o.width(),p=h/2,_=u.width(),m=f.width()+a,v=(_+2)/h*l,w=m/h*l;c.css({width:(v>100?100:v)+e}),d.css({width:(w>100?100:w)+e}),p>_&&p>m?c.css({width:t}):_>=p&&m>=p?(c.css({width:t}),d.css({width:t})):_+m>=h&&_>=p&&p>=m?c.css({width:(h-m)/h*l+e}):_+m>=h&&p>=_&&m>=p&&0!=_&&d.css({width:(h-_)/h*l+e}),o.attr("has-add-diff","true"),o.css({visibility:"visible",minWidth:"1000px"}),n.css({top:o.height()+79+i})}function c(e,l){return e>=u.length?e%=u.length:0>e&&(e=u.length+e),"C101"===u[e].children[0].meta.type&&(l>=0?e++:0>l&&e--,e=c(e,l)),e<u.length&&e>=0?e:c(e)}for(var d=e.dashSelected,u=[],f=0;f<e.standardItems.length;f++){var h=e.standardItems[f];u.push(h)}u=u.sort(function(e,l){return"index"in e&&"index"in l?e.index-l.index:e.row==l.row?e.col-l.col:e.row<l.row?-1:1}),e.fullscreen={auto_play_flag:!1,index:0,charts:u,filter:{},queue_show:{},queue_next:{}},i(),e.slide=function(l,t){if(l){var a=c((e.fullscreen.index+l)%u.length,l);if(e.fullscreen.index=a,t&&!t.auto)$(".fullscreen-modal").find(".drill-crumbs-wrap").html(""),o("show",a),o("next",a+1),$(".fs-queue-next").removeClass("active"),$(".fs-queue-show").addClass("active"),e.fullscreen.name=u[e.fullscreen.index].children[0].meta.name;else{var n=$(".fullscreen-chart");if(1===u.length)return;for(var s=0;s<n.length;s++){var i=n.eq(s),r=i[0].className;if(r.indexOf("active")>-1){if(r.indexOf("fs-queue-show")>-1){e.fullscreen.queue_show.options.optional.drill_level>0&&$(".fullscreen-modal").find(".drill-crumbs-wrap").html("");var d=$(".fs-queue-next");i.removeClass("active").html(""),d.addClass("active"),e.fullscreen.name=u[e.fullscreen.index].children[0].meta.name,e.fullscreen.info=e.fullscreen.queue_next,o("show",a+l)}else if(r.indexOf("fs-queue-next")>-1){e.fullscreen.queue_next.options.optional.drill_level>0&&$(".fullscreen-modal").find(".drill-crumbs-wrap").html("");var f=$(".fs-queue-show");i.removeClass("active").html(""),f.addClass("active"),e.fullscreen.name=u[e.fullscreen.index].children[0].meta.name,e.fullscreen.info=e.fullscreen.queue_show,o("next",a+l)}break}}}var h=$(".J_filterWrap");h.css({visibility:"hidden"})}};var p,_=null;e.autoPlay=function(l){e.autoPlaying=l,e.showExtralCtrl=!l,e.watchPlayState(l,!0);var t=$(".J_filterWrap");t.css({visibility:"hidden"}),clearTimeout(_);var a=$(".fs-chart-main").parent();if(l){var n=$('<div class="only-layer" style="position:absolute;z-index:10;left:0;right:0;top:20;bottom:0;"></div>');n.on("click",function(){e.autoPlay(!1)}),a.append(n)}else e.fullscreen.auto_play_flag=!1,a.find(".only-layer").length&&a.find(".only-layer").remove(),_=setTimeout(function(){r()},25)},e.watchPlayState=function(l){l?setTimeout(function(){e.slide(1,{auto:!1}),p=a(function(){e.slide(1,{auto:!0})},5e3)},1e3):a.cancel(p)},e.fullScreenGranularity=function(l,t,a,n){a.granularity=n;var s=e.fullscreen.queue_show.options.optional.display_granularity||{};s[e.drill_level]=s[e.drill_level]||{},s[e.drill_level][a.fid]=n,e.fullscreen.queue_show.options.optional.display_granularity=s},e.$on("$destroy",function(){a.cancel(p)});var m;$(document).off("mousemove.fs_mouse_ctrl").on("mousemove.fs_mouse_ctrl",function(){e.$apply(function(){e.showExtralCtrl=!0}),t.cancel(m),m=t(function(){e.autoPlaying&&(e.showExtralCtrl=!1)},2e3)}),e.slideNav=function(e,l){if("show"===l)$(".fullscreen-modal").find(".nav").addClass("open"),$(".nav-handler").css({height:64});else if("hide"===l){if(e.clientX<196)return;$(".fullscreen-modal").find(".nav").removeClass("open"),$(".nav-handler").css({height:"100%"})}},e.toggleDataLabel=function(l){if(e.show_data_label=void 0!==l?l:!e.show_data_label,e.show_data_label)$(".fs-data-label").remove();else{var t=$("<style class='fs-data-label' type='text/css' rel='stylesheet' />").appendTo("head"),a=".fullscreen-modal .chart:not(.chart-map) .highcharts-data-labels > g, .fullscreen-modal .chart-pie .highcharts-data-label-connector ,.fullscreen-modal .funnel-datalabels, .fullscreen-modal .sunburst-labels {display:none}.fullscreen-modal .treemap-labels {opacity: 0 !important}";t[0].styleSheet?t[0].styleSheet.cssText=a:t[0].appendChild(document.createTextNode(a))}localStorage.setItem("fs_data_label",1&e.show_data_label),e.$broadcast("reflow")},e.toggleChartDescription=function(l){e.show_chart_description=void 0!==l?l:!e.show_chart_description,setTimeout(function(){r("showRemark"),reflowChart($(".fullscreen-chart").parent(),!0)},0),localStorage.setItem("fs_chart_description",e.show_chart_description)};var v=localStorage.getItem("fs_chart_description");void 0!=v?e.toggleChartDescription(1==v):e.show_chart_description=!1;var w=localStorage.getItem("fs_data_label");void 0!=w?e.toggleDataLabel(1==w):e.show_data_label=0==$(".fs-data-label").length,e.$watch("show_chart_description",function(l){e.$broadcast("toggleAllPoints",l)}),$(document).off("keydown.fs_key_ctrl").on("keydown.fs_key_ctrl",function(l){if(!$(l.target).closest(".string-filter").length){switch(l.keyCode){case 39:case 40:e.slide(1,{auto:!1});break;case 37:case 38:e.slide(-1,{auto:!1});break;case 27:e.closeThisDialog()}e.$$phase||e.$apply()}}),e.showMore=function(){var e=$(".J-more-action"),l=$(".J-action-optlist"),t=$(".J-fullscreen-more");if(t.addClass("open"),l.addClass("open"),$(".J-action-opt-wrap").css("z-index","3"),0==e.find(".opacity-layer").length){var a=$('<div class="opacity-layer"></div>');a.on("mouseenter",function(){e.parent().find(".opacity-layer").remove(),l.removeClass("open"),t.removeClass("open"),$(".J-action-opt-wrap").css("z-index","1")}),e.parent().append(a)}}}]);
;angular.module("BC.directives").directive("tableStatistic",["$timeout","$jsTipTranslate",function(t,i){function a(t){function a(t){if(!t)return!1;for(var i=0,a=t.length;a>i;i++){if(t[i])return!0;t[i]=!1}return!1}i(["TOTAL"],t),t.$watch("global.watch",function(){var i=t.chart_ops.meta.level[t.drill_level];t.tb_statistic=i.tb_statistic||{col:!1,row:!1,classify:!1,subtotal:!1},t.tb_statistic.col_pos||(t.tb_statistic.col_pos="bottom"),t.tb_statistic.row_pos||(t.tb_statistic.row_pos="right");var a=t.tb_statistic.subtotal_setting=t.tb_statistic.subtotal_setting||{};if(t.tb_statistic.subtotal){var n=a.dimensions,s=i.x.length;if(n&&n.length){if(n.length<s)for(var e=0;e<s-n.length;e++)n.push(!1);else n=n.slice(0,s);t.tb_statistic.subtotal_setting.dimensions=n}}if(!i.tb_statistic||i.tb_statistic&&!i.tb_statistic.row){if(i.tb_conditional_formatting&&i.tb_conditional_formatting.length>0)for(var e=0,o=i.tb_conditional_formatting.length;o>e;e++){var l=i.tb_conditional_formatting[e];if("row_summary"===l.fid){i.tb_conditional_formatting.splice(e,1);break}}if(i.advanced_sort&&i.advanced_sort.length>0)for(var r=0,_=i.advanced_sort.length;_>r;r++){var c=i.advanced_sort[r];if("row_summary"==c.fid){i.advanced_sort.splice(r,1);break}}}});var n=null;t.saveTableStatistic=function(i,a){var s,e,o=t.chart_ops.meta.level[t.drill_level],l=o.y.length,r="row_summary",_=+new Date;if(0==o.y.length)return i.row=!1,void(i.col=!1);if(0==o.x.length&&(i.subtotal=!1),o.tb_statistic=i,a)if(i.row){var c={check:"num",num:{digit:0,millesimal:!0},percent:{digit:0}};if(s=i.row_pos,"left"==s?e=0:"right"==s&&(e=o.y.length),t.tb_statistic.row_formula="SUM",t.tb_statistic.row_setting={pos:0==e?e:e||n,formatter:c,nick_name:"",unit_adv:"",description:"",uniq_id:_},o.tb_conditional_formatting&&o.tb_conditional_formatting.length>0)for(var d=0,b=o.tb_conditional_formatting.length;b>d;d++){var g=o.tb_conditional_formatting[d];g.fid===r&&(g.uniq_id=_)}}else{for(var d=0,b=o.y.length;b>d;d++)r==o.y[d].fid&&(n=d);if(o.tb_conditional_formatting&&o.tb_conditional_formatting.length>0)for(var d=0,b=o.tb_conditional_formatting.length;b>d;d++){var g=o.tb_conditional_formatting[d];if(g.fid===r){o.tb_conditional_formatting.splice(d,1);break}}t.tb_statistic.row_setting={}}if(angular.forEach(o.y,function(t){"left"===o.tb_statistic.row_pos&&o.tb_statistic.row&&t.alignment_method?o.tb_statistic.row_setting.alignment_method=o.y[0].alignment_method:"right"===o.tb_statistic.row_pos&&o.tb_statistic.row&&t.alignment_method&&(o.tb_statistic.row_setting.alignment_method=o.y[l-1].alignment_method)}),t.tb_statistic.subtotal){for(var f=i.subtotal_setting.dimensions.slice(0),m=0,b=o.x.length;b>m;m++)f[m]=f[m]?!0:!1;i.subtotal_setting.dimensions=f.slice(0),f=[]}t.handleVirtualFieldForTable(o,void 0,_),t.saveChartImmediate({not_need_redraw:!1,only_refresh_data:!1,is_drill_chart:!!t.drill_level})},t.handleSubtotalTitle=function(){var i=t.chart_ops.meta.level[t.drill_level],n=i.x.length,s=t.tb_statistic.subtotal_setting=t.tb_statistic.subtotal_setting||{},e=!1;t.tb_statistic.subtotal&&(!s.dimensions||s.dimensions.length<=0)&&(s.dimensions=new Array(n));var o=s.dimensions;a(o)||(e=!0),t.saveChartImmediate({not_need_redraw:e,only_refresh_data:!0,is_drill_chart:!!t.drill_level})}}var n={link:a,templateUrl:"/static/partials/table_statistic.html",restrict:"EA"};return n}]);
;angular.module("BC.directives").directive("gaugeSetting",["ngDialog","$timeout","commonService","errHint","$jsTipTranslate","$getCustomFormula","chartLineType",function(e,t,a,i,g,n,l){return{restrict:"A",templateUrl:"/static/partials/gauge_setting.html",scope:{opts:"=",save:"=",global:"="},link:function(t){t.lineType=l,t.calcuType=n(["SUM","AVG","MIN","MAX"]),t.canAddFormula=function(e){angular.forEach(t.fields,function(a){e===a.fid&&(t.opts.meta.level[0].gauge_setting||(t.opts.meta.level[0].gauge_setting=t.gaugeSetting),t.opts.meta.level[0].gauge_setting.goal.is_new=0===a.is_build_aggregated||2===a.is_build_aggregated)})},t.isEnterKey=function(e,a,i){13==e.keyCode&&t.lazySaveGauge(a,i)},t.lazySaveGauge=function(e,a){var g={not_need_redraw:!1,only_refresh_data:!1,is_drill_chart:!1};if(""==e.name)return i(t.tips["chart.gaugeTitleRequired"]),e.name=t.originGaugeSetting.name,!1;if("constant"===e.goal.value_type&&["goal","rateDigit"].indexOf(a)>-1&&(e.goal.value<=0||isNaN(e.goal.value)))return i(t.tips["chart.goalValueInvalid"]),!1;if(void 0===e.rateDigit||e.rateDigit<0||e.rateDigit>4)return i(t.tips["chart.gaugeRateDigitTip"]),!1;if(angular.forEach(t.fields,function(t){t.fid==e.goal.fid&&(e.goal.field_name=t.name,e.goal.is_new=0===t.is_build_aggregated||2===t.is_build_aggregated)}),"calculate"===e.goal.value_type){if(!e.goal.fid)return i(t.tips["chart.goalFidRequired"]),!1;if(e.goal.is_new&&!e.goal.formula)return i(t.tips["chart.goalFormulaRequired"]),!1}if(e.goal.digit<0||e.goal.digit>6)return i(t.tips["chart.numDigitInvalid"]),!1;if(t.opts.meta.level[0].gauge_setting=e||t.gaugeSetting,"title"==a||"unit"==a){g.not_need_redraw=!0;var n=$(".solidgauge-title");n.find(".title").text(e.name);var l=n.find(".unit").text();if(""!==t.originGaugeSetting.unit){var u=t.originGaugeSetting.unit,o=l.lastIndexOf(u);n.find(".unit").text(l.substring(0,o)+e.unit)}else n.find(".unit").text(l+e.unit)}t.save(g),t.originGaugeSetting=angular.copy(e),t.showGaugeSetting=angular.copy(e)},t.initGaugeData=function(){var e=t.opts.meta.level[0].gauge_setting||{};e.goal&&void 0===e.goal.digit&&(e.goal.digit=0),t.gaugeSetting={name:e.name||t.opts.meta.level[0].y[0].name,unit:e.unit||"",goal:"object"==typeof e.goal?e.goal:{digit:0,value_type:"constant",value:t.opts.meta.level[0].gauge_setting?t.opts.meta.level[0].gauge_setting.goal.value:""},rateDigit:e.rateDigit||0},t.originGaugeSetting=angular.copy(t.gaugeSetting),a.tb.getInfo(t.opts.tb_id).then(function(e){t.fields=[],angular.forEach(e.result.schema,function(e){"number"===e.data_type&&t.fields.push({name:e.name,fid:e.fid,data_type:e.data_type,is_build_aggregated:e.is_build_aggregated})}),t.canAddFormula(t.gaugeSetting.goal.fid),t.showGaugeSetting=angular.copy(t.gaugeSetting)})},t.goalSetting=function(){t.initGaugeData(),e.open({templateUrl:"/static/partials/gauge_goal_setting.html",className:"ngdialog-theme-default",scope:t})},t.$watch("gaugeSetting.goal.value_type",function(e){"calculate"===e&&t.calcuType[0]&&(t.gaugeSetting.goal.formula=t.calcuType[0].type)}),t.$watch("global.chartData.total",function(e){t.showGaugeSetting&&e&&(t.opts.meta.level[0].gauge_setting||(t.showGaugeSetting.goal.value=e))}),t.initGaugeData(),g(["chart.goalFidRequired","chart.goalFormulaRequired","chart.gaugeRateDigitTip","chart.gaugeTitleRequired","chart.goalValueInvalid","chart.numDigitInvalid"],t)},controller:["$scope",function(){}]}}]);
;angular.module("BC.directives").directive("resizeWidthFieldsList",[function(){return{restrict:"A",replace:!1,link:function(e,t){var o=160,n=300;t.on("mousedown",function(a){var r=$(".chart-left"),c=$(".chart-main"),i=a.pageX-r.outerWidth();a.preventDefault(),$(document).on("mousemove",function(e){var a=e.pageX-i;a=Math.max(o,a),a=Math.min(n,a),r.css("width",a+"px"),c.css("margin-left",a+"px"),t.css("left",a+"px")}),$(document).on("mouseup",function(){$(document).off("mousemove"),$(document).off("mouseup"),e.$apply(function(){e.draw_chart_url.options._t=(new Date).getTime()})})})}}}]).directive("resizeWidthFilterList",[function(){return{restrict:"A",replace:!1,link:function(e,t){var o=172,n=300;t.on("mousedown",function(a){var r=$(".chart-left-side"),c=$("#chartBox"),i=a.pageX-r.outerWidth();a.preventDefault(),$(document).on("mousemove",function(e){var a=e.pageX-i;a=Math.max(o,a),a=Math.min(n,a),r.css("width",a+"px"),c.css("left",a+"px"),t.css("left",a+"px")}),$(document).on("mouseup",function(){$(document).off("mousemove"),$(document).off("mouseup"),e.$apply(function(){e.draw_chart_url.options._t=(new Date).getTime()})})})}}}]).directive("resizeProjectList",["$timeout",function(e){return{link:function(t,o){var n=190,a=300;if(localStorage){var r=localStorage.getItem("project_width");r&&e(function(){$(".dash-sidebar").css("width",r+"px"),$(".dash-edit-content").css("padding-left",r+"px"),angular.element(".item-chart").each(function(){reflowChart(angular.element(this),!0)})},0)}o.on("mousedown",function(o){var r=$(".dash-sidebar"),c=$(".dash-edit-content"),i=o.pageX-r.outerWidth();o.preventDefault(),$(document).on("mousemove.drag_project",function(e){var t=e.pageX-i;t=Math.max(n,t),t=Math.min(a,t),r.css("width",t+"px"),c.css("padding-left",t+"px"),$(".global-filter-scroll").css("margin-left",t+24+"px")}),$(document).on("mouseup.drag_project",function(){t.$$phase||(t.$apply(),e(function(){angular.element(".item-chart").each(function(){reflowChart(angular.element(this),!0)})},0)),localStorage&&localStorage.setItem("project_width",r.width()),$(document).off("mousemove.drag_project"),$(document).off("mouseup.drag_project")})})}}}]).directive("resizeMergeTable",function(){return{restrict:"A",link:function(e,t,o){var n=100,a=300,r=o.leftSelector,c=o.rightSelector;if(localStorage){var i=localStorage.getItem("ds_tree_width");i&&(i>>>=0,setTimeout(function(){$(r).css("width",i+"px"),$(c).css("margin-left",i+1+"px")},10))}t.on("mousedown",function(e){var t=$(r),o=$(c),i=e.pageX-t.outerWidth();e.preventDefault(),$(document).on("mousemove.drag_data_source",function(e){var r=e.pageX-i;r=Math.max(n,r),r=Math.min(a,r),t.css("width",r+"px"),o.css("margin-left",r+1+"px")}),$(document).on("mouseup.drag_data_source",function(){localStorage&&localStorage.setItem("ds_tree_width",t.width()),$(document).off("mousemove.drag_data_source"),$(document).off("mouseup.drag_data_source")})})}}});
;angular.module("BC.directives").directive("chartDataInfo",["$window","commonService","ngDialog","commonHttp","$filter","$rootScope",function(t,e,i,n,a,o){return{restrict:"A",templateUrl:"/static/partials/directiveTemplates/chartDataInfo.html",controller:["$scope","$stateParams","$window","$jsTipTranslate","errHint","unionService",function(t,l,d,s,r,c){function f(i,n){t.chartContentLoading=!0,e.tb.getMultiInfo(i).then(function(e){if(t.chartContentLoading=!1,t.tableInfoList=e.result,t.dimensionArray=[],1==t.dataInfo.length)t.dimensionArray.push({field_id:null,title:"",name:"",type:""}),t.tableInfoList.forEach(function(t){t.fieldList=[],t.fieldList.push({fid:""})}),t.setCommonDimensionDialog(n);else if(t.dataInfo.length>1){t.previousTableConfig.table.fields.forEach(function(e){(2===e.type||3===e.type)&&t.dimensionArray.push({field_id:e.field_id,title:e.title,name:e.name,type:e.type})});var i=t.dimensionArray.length;t.tableInfoList.forEach(function(e){e.fieldList=[],t.previousTableConfig.info.forEach(function(t){if(e.tb_id==t.tb_id)for(var n=0;i>n;n++)e.fieldList.push({fid:t.col_fid_list[n]})})}),t.tableInfoList.forEach(function(t){if(0==t.fieldList.length)for(var e=0;i>e;e++)t.fieldList.push({fid:""})}),"add"==n||"edit"==n?t.setCommonDimensionDialog(n):"delete"==n&&t.sendDimensionConfig("delete")}})}function u(){t.dataInfo.forEach(function(e){t.folderList.forEach(function(t){"folder_root"!=t.folder_id&&t.sub_folders.forEach(function(t){t.tb_list.forEach(function(t){t.tb_id==e.tb_id&&(t.checked=!0,t.previous=!0)})}),t.tb_list.forEach(function(t){t.tb_id==e.tb_id&&(t.checked=!0,t.previous=!0)})})})}function h(){t.chartContentLoading=!0,n.get("/api/folder/list").then(function(e){t.chartContentLoading=!1,0==e.status&&(t.folderList=e.result,i.open({template:"/static/partials/dialogTemplates/check_table_list.html",className:"ngdialog-theme-default ngDialog-width-355 ngdialog-check-table",scope:t}),u())})}function m(n,a){t.chartContentLoading=!0,e.chart.tableUnion(n).then(function(n){if(0==n.status)if(1!=t.dataInfo.length||"add"!=a&&"delete"!=a)i.closeAll(),d.location.reload();else{var o;"add"==a?o=n.result.tb_id:"delete"==a&&(o=t.dataInfo[0].tb_id),e.chart.modifyTb(l.chartId,o).success(function(e){t.chartContentLoading=!1,0==e.status?d.location.reload():r(Number(e.status))})}else t.chartContentLoading=!1})}e.chart.getDbInfo(l.chartId).success(function(e){0==e.status?t.dataInfo=e.result:errorHandle(e)}),t.getDBList=function(){e.tb.getList().then(function(e){t.db_list=e})},t.previewData=function(n,l){o.pageLoading=!0,e.tb.preview(n).then(function(d){o.pageLoading=!1,d&&(d.tableName=l,d.latestData=d.data.length,d.totalData=d.count,d.generateCoordinateStatus=d.has_gis,2==d.has_gis&&e.tb.gisModify({tb_id:n}),d.tableUpdateTime=a("date")(1e3*d.update_time,"yyyy-MM-dd HH:mm:ss"),d.currentStatus="",3==d.status||6==d.status?d.currentStatus=t.tips["wb.isUpdatingWaiting"]:2==d.status&&(d.currentStatus=t.tips["wb.updateFailed"]),i.open({template:"/static/partials/dialogTemplates/preview_table_data.html",className:"ngdialog-theme-default chart-preview-data",data:d,scope:t,controller:["$scope","$timeout","$element",function(t,e,i){function n(){s=0,$(o).children("td").each(function(t,e){var i=parseInt($(e).width()+4);$(d[t]).width(i)})}var a,o,l,d,s;e(function(){i.find(".J-table-fixhead").width(i.find(".table-scroll").children("table").width()),a=i.find(".table-scroll"),o=i.find(".table-scroll").find("tbody").find("tr")[0],l=i.find(".J-table-fixhead").find("thead").find("tr")[0],d=$(l).children("th"),n(),a.scroll(function(t){i.find(".table-fixhead").css({left:-t.target.scrollLeft+"px"})})},100);var r;$(window).resize(function(){clearTimeout(r),setTimeout(function(){i.find(".J-table-fixhead").width(i.find(".table-scroll").children("table").width()),n()},10)})}]}))})},t.addWorkTable=function(){1==t.dataInfo.length?(h(),t.previousTableConfig={info:[{tb_id:t.dataInfo[0].tb_id}]}):t.dataInfo.length>1&&(t.chartContentLoading=!0,e.tb.getModelStruct(t.tb_id).then(function(e){t.chartContentLoading=!1,t.previousTableConfig=e.result,h()}))},t.removeWorkTable=function(n,a){t.currentDeletingTableId=n,i.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:t.tips["chart.confirmDeleteWorktable"]}}).then(function(){var i={tb_ids:[]};t.dataInfo.forEach(function(t){t.tb_id!=n&&i.tb_ids.push(t.tb_id)}),i.tb_ids=JSON.stringify(i.tb_ids),t.chartContentLoading=!0,e.tb.getModelStruct(t.tb_id).then(function(e){t.chartContentLoading=!1,t.previousTableConfig=e.result,f(i,"delete")})}),a.stopPropagation()},t.switchWorkTable=function(e,a){var o=function(e){t.folderList=e,t.original_folderList=angular.copy(e),i.open({template:"/static/partials/choose_table_list.html",className:"ngdialog-theme-default data-source choose-table-list",data:{json_data:{title:t.tips["chart.chooseWorktable"],type:"choose",show_upload:!1},choose_table:{tb_id:""}},scope:t})};n.get("/api/folder/list").then(function(t){0==t.status&&o(t.result)}),a.stopPropagation()},t.chooseTableOk=function(n){i.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:t.tips["chart.confirmSwitchTable"]}}).then(function(){t.chartContentLoading=!0,e.chart.modifyTb(l.chartId,n.tb_id).success(function(e){t.chartContentLoading=!1,0==e.status?d.location.reload():r(Number(e.status))})})},t.openSetCommonDimensionDialog=function(e){if(t.checkedTableToAdd=[],t.previousTableConfig&&t.previousTableConfig.info.length>0&&t.previousTableConfig.info.forEach(function(e){t.checkedTableToAdd.push(e.tb_id)}),t.folderList.forEach(function(e){"folder_root"!=e.folder_id&&e.sub_folders.forEach(function(e){e.tb_list.forEach(function(e){e.checked&&!e.previous&&t.checkedTableToAdd.push(e.tb_id)})}),e.tb_list.forEach(function(e){e.checked&&!e.previous&&t.checkedTableToAdd.push(e.tb_id)})}),t.checkedTableToAdd.length<=0)return r(t.tips["chart.chooseAtLeaseOneWorktable"]),!1;i.closeAll();var n={tb_ids:JSON.stringify(t.checkedTableToAdd)};f(n,e)},t.filterSelectType=function(t){return 2==t.type||3==t.type},t.updateInputValue=function(e,i,n){var a,o,l=n,d=!1;if(t.tableInfoList[i].fieldList.forEach(function(n,a){n.fid==l&&a!=e&&(r("您已选择过该字段"),t.tableInfoList[i].fieldList[e].fid="",d=!0)}),d)return!1;t.tableInfoList[i].schema.forEach(function(t){t.fid==l&&(a=t.name,o=t.type)});var s=0;if(t.tableInfoList.forEach(function(t){t.fieldList[e].fid&&(s+=1)}),o!=t.dimensionArray[e].type&&""!=t.dimensionArray[e].type&&1!=s){var c;2==t.dimensionArray[e].type?c=t.tips.text:3==t.dimensionArray[e].type&&(c=t.tips.date),r(t.tips["chart.chartTitleWarningOne"]+c+t.tips["chart.chartTitleWarningTwo"]),t.tableInfoList[i].fieldList.forEach(function(t){t.fid==l&&(t.fid="")})}t.dimensionArray[e].name&&1!=s||(t.dimensionArray[e].name=a||"",t.dimensionArray[e].type=o||""),t.dimensionArray[e].title||(t.dimensionArray[e].title=a||"")},t.editDimension=function(){t.chartContentLoading=!0,e.tb.getModelStruct(t.tb_id).then(function(e){t.previousTableConfig=e.result,n.get("/api/folder/list").then(function(e){t.chartContentLoading=!1,0==e.status&&(t.folderList=e.result,u(),t.openSetCommonDimensionDialog("edit"))})})},t.addNewColumn=function(){var e={field_id:null,title:"",name:"",type:""};t.dimensionArray.push(e),t.tableInfoList.forEach(function(t){t.fieldList.push({fid:""})});var i=$(".ngdialog-set-common-dimension .ngdialog-message"),n=i.scrollLeft();i.animate({scrollLeft:n+200},100)},t.removeColumn=function(e){return 1==t.dimensionArray.length?(r("需至少有一个公共维度"),!1):(t.dimensionArray.splice(e,1),void t.tableInfoList.forEach(function(t){t.fieldList.splice(e,1)}))},t.setCommonDimensionDialog=function(e){i.open({template:"/static/partials/dialogTemplates/set_common_dimension.html",className:"ngdialog-theme-default ngdialog-width-712 ngdialog-set-common-dimension",scope:t,data:{operationMode:e}})},t.sendDimensionConfig=function(e){t.union_info={dimension_num:t.dimensionArray.length,tb_list:[],schema:[]};var n=0,a=!0,o=!0;if(t.dimensionArray.forEach(function(t){t.title||(o=!1)}),!o)return r(t.tips["chart.fieldTitleRequired"]),!1;if(t.tableInfoList.forEach(function(e){var i={tb_id:e.tb_id,tb_name:e.tb_name||e.name,col_fid_list:[],metric_num:0};e.fieldList.forEach(function(t){t.fid?i.col_fid_list.push(t.fid):a=!1}),e.schema.forEach(function(e){(0===e.type||1===e.type)&&(i.col_fid_list[n+t.union_info.dimension_num]=e.fid,i.metric_num+=1,n+=1)}),t.union_info.tb_list.push(i)}),!a)return r(t.tips["chart.chooseAllFields"]),!1;if(t.union_info.tb_list.forEach(function(e){for(var i=t.union_info.dimension_num,a=n+t.union_info.dimension_num;a>i;i++)e.col_fid_list[i]=e.col_fid_list[i]?e.col_fid_list[i]:""}),t.dimensionArray.forEach(function(e){var i={field_id:e.field_id||"",title:e.title,name:e.name,type:e.type};t.union_info.schema.push(i)}),1==t.dataInfo.length)t.tableInfoList.forEach(function(e){e.schema.forEach(function(i){if(0===i.type||1===i.type){var n={field_id:null,title:i.name+"_"+e.tb_name,name:i.original_name+"_"+e.tb_name,type:i.type};t.union_info.schema.push(n)}})});else{if("delete"==e){var l=0;t.previousTableConfig.info.forEach(function(e){var i=0;e.fields.forEach(function(t){(0===t.type||1===t.type)&&(i+=1)}),e.tb_id==t.currentDeletingTableId&&t.previousTableConfig.table.fields.splice(t.dimensionArray.length+l,i),l+=i})}t.previousTableConfig.table.fields.forEach(function(e){if(0===e.type||1===e.type){var i={field_id:e.fid||"",title:e.title,name:e.name,type:e.type};t.union_info.schema.push(i)}});var d=[];t.tableInfoList.forEach(function(e){var i=!0;t.previousTableConfig.info.forEach(function(t){t.tb_id==e.tb_id&&(i=!1)}),i&&d.push(e)}),d.forEach(function(e){e.schema.forEach(function(i){if(0===i.type||1===i.type){var n={field_id:null,title:i.name+"_"+e.tb_name,name:i.original_name+"_"+e.tb_name,type:i.type};t.union_info.schema.push(n)}})})}var s={union_info:JSON.stringify(t.union_info),tb_id:""};if(t.dataInfo.length>1&&(s.tb_id=t.tb_id),s.tb_id){var f="delete"==e?0:1;c.tableUnionPreview(JSON.parse(s.union_info),"",s.tb_id,"",f).then(function(n){0==n.status&&(1==n.result.can_del?("delete"==e&&t.dataInfo.forEach(function(e,i){e.tb_id==t.currentDeletingTableId&&t.dataInfo.splice(i,1)}),m(s,e)):(t.dependencyFields=n.result.dependency,i.openConfirm({template:"/static/partials/dialogTemplates/delete_table_dependency.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:t.tips["chart.deleteTableDependencyWarning"]}})))})}else m(s,e)},s(["chart.confirmSwitchTable","wb.isUpdatingWaiting","wb.updateFailed","text","date","chart.confirmDeleteWorktable","chart.chooseWorktable","chart.chooseAtLeaseOneWorktable","chart.chooseAllFields","chart.chartTitleWarningOne","chart.chartTitleWarningTwo","chart.deleteTableDependencyWarning","chart.fieldTitleRequired"],t)}]}}]);
;!function(){angular.module("BC.directives").directive("operateName",["$timeout","$rootScope",function(t,n){return{restrict:"A",scope:{onCommit:"&",onDelete:"&",ws:"="},templateUrl:"/static/partials/directiveTemplates/operateName.html",link:function(e,o){function i(){if(e.inputVal){var t={ws_id:e.ws.ws_id,name:e.inputVal},n=e.onCommit(t);n&&(e.text=t.name),e.mode="cat"}}e.editable=!1,e.$watch(function(){return n.role},function(t){"s_admin"==t&&(e.editable=!0)}),e.$watch("ws",function(t){t&&(e.mode="cat",e.text=e.inputVal=e.ws.name)}),o.find("input").on("click",function(t){t.stopPropagation()}).on("blur",function(){t(function(){e.mode="cat"},500)}).on("keypress",function(t){13===t.keyCode&&i()}),e.save=function(t){t.stopPropagation(),e.ws.name!=e.inputVal?i():e.mode="cat"},e.edit=function(t){t.stopPropagation(),e.mode="modify",e.inputVal=e.text},e.del=function(t){t.stopPropagation();var n={ws_id:e.ws.ws_id};e.onDelete(n)}}}}])}();
;!function(){function e(){function e(){}var l={templateUrl:"/static/partials/directiveTemplates/doubleYaxisChartTypeTpl.html",restrict:"EA",link:e,controller:t,scope:{chartOps:"=",warnSetting:"=",type:"=",save:"=",drillLevel:"="},controllerAs:"vm",bindToController:!0};return l}function t(e){e.types=["C220","C210","C211","C212"],e.meta=e.chartOps.meta,e.yaxis=e.type,e.changeType=function(t){e.meta.level[e.drillLevel].type_optional[e.yaxis]=t,e.save(),e.showType=!1}}angular.module("BC.directives").directive("doubleYaxisChartType",e),t.$inject=["$scope","commonHttp"]}();
;angular.module("BC.directives").directive("errorReport",["$timeout","$jsTipTranslate","$translate",function(){return{restrict:"A",scope:{onExcel:"&",tbid:"=",data:"="},templateUrl:"/static/partials/directiveTemplates/error_report.html",controller:["$scope",function(t){function e(t){a.report=t,a.reportType="",a.reportJoinTable=[],a.reportJoinTableVal=0;var e=a.reportJoinTable;angular.forEach(t,function(t,r){t.count=t.duplicated.count+t.empty.count,t.duplicatedCount=t.duplicated.count,t.emptyLen=t.empty.count,e.push({id:r,name:t.left_tb.title+"-"+t.right_tb.title})}),r()}function r(){if(0!=a.reportJoinTable.length){var t,e,r=0,o=0,n=a.reportType;switch(r=a.report[a.reportJoinTableVal].duplicated.count,o=a.report[a.reportJoinTableVal].empty.count,t=0,e=0,n){case"duplicated":e=r,r=50>r?r:50,t=r;break;case"empty":e=o,o=50>o?o:50,t=o;break;default:e=r+o,r=50>r?r:50,r>=50?o=0:r+o>50&&(o=50-r),t=r+o}a.duplicatedIndex=r,a.emptyIndex=o,a.curTotal=t,a.total=e}}function o(e){t.errorReport.stage=1;var r=e.data.check_report.report,o=[];angular.forEach(r,function(t){o.push(t.left_tb+" -- "+t.right_tb+"重复条数"+t.expand_count)}),t.errorReport.report2=o}t.dataType="",t.errorReport={};var a=t.errorReport;t.$watch("data",function(t){t&&(1==t.stage?o(t):e(t))}),t.changeType=function(){r()},t.changeSelect=function(){r()},t.exportExcel=function(){t.onExcel()}}]}}]);
;angular.module("BC.directives").directive("navWorkspace",["$window","$location","$rootScope","$stateParams","commonService","commonHttp","$timeout","ngDialog","$jsTipTranslate","$state",function(t,e,a,s,o,r,c,i,n,l){return{restrict:"A",transclude:!0,replace:!0,templateUrl:"/static/js/common/tpl/directive/navWorkspace.html",link:function(t){n(["dash.projectNameRequired"],t)},controller:["$scope","$rootScope","$timeout",function(t,a,s){function o(e){if(e){var s=a.view,o=[];switch(s){case"dashboard":case"chart_edit":case"warn":case"personal":o=e.dash;break;case"worktable":o=e.worktable;break;case"template":case"template_config":case"template_rule":o=e.template}t.curWsList=o}}function c(t){var e=$(".nav-workspace-list > ul"),a=parseInt(e.css("width"));if(e.get(0).scrollWidth&&e.get(0).scrollWidth>a){var s=t,o=s.offset().left,r=s.offset().left+parseInt(s.css("width"));a+64>=o&&r>a+64&&(e.get(0).scrollLeft=r-(a+64)),o>a+64&&(e.get(0).scrollLeft=r-(a+64))}}t.$watch(function(){return a.workspaceList},function(e){e&&s(function(){var e=a.workspaceList.length,s=$(".nav-workspace-list > ul > li");angular.forEach(s,function(a){$(a).css("z-index",e--),$(a).hasClass("active")&&t.scrollLeftToNav($(a))})},200)}),a.$watch("workspaceList",function(t){t&&o(t)},!0),o(a.workspaceList),"dashboard"==a.view&&a.$watch("wsId",function(e){var s=void 0;e?s=void 0:t.curWsList&&t.curWsList.map(function(t){t.ws_id==e&&(s=t.admin)}),a.wsAdmin=s}),t.tabWorkspace=function(s,o,c){if(o!=a.wsId){a.wsId=o;var i="";e.path().indexOf("dash_edit")>-1?i=o?"ws_dash":"dash_edit":e.path().indexOf("data_source")>-1?i=o?"data_source_ws":"data_source":e.path().indexOf("template_home")>-1?i=o?"template_home_ws":"template_home":e.path().indexOf("template_config")>-1?i=o?"template_home_ws":"template_home":e.path().indexOf("template_rule")>-1?i=o?"template_home_ws":"template_home":e.path().indexOf("warn")>-1&&(i=o?"ws_dash":"dash_edit"),a.wsAdmin=c,l.go(i,{wsId:o}),t.scrollLeftToNav($(s.target).parent(".workspace-nav").parent("li")),a.unread=0,r.get("/api/warn/amount").then(function(t){"0"===t.status&&(a.unread=t.result.unread)})}},t.scrollLeftToNav=c}]}}]);
;!function(){function t(t){function e(e,a){function i(t){var e={},a=-30*Math.PI/180;r.width=t.width*Math.cos(a)+Math.abs(t.height/Math.sin(a)),r.height=t.width*Math.abs(Math.sin(a))+Math.abs(t.height/Math.cos(a)),e.x=-r.height*Math.abs(Math.sin(a))+20,e.y=r.height-t.height;var i=r.getContext("2d");i.textAlign="left",i.font="normal "+t.fontSize+"px Microsoft Yahei";var h="rgba(0,0,0,0.08)";"dash"!==t.mode&&(h="rgba(255,255,255,0.08)"),i.fillStyle=h,i.textBaseline="top",i.rotate(a),i.fillText(t.text,e.x,e.y);var n=Canvas2Image.convertToPNG(r,r.width,r.height).src;return i.clearRect(0,0,r.width,r.height),n}function h(){var e=$(a).find("span"),i={};return i.text=t.permision.isAuthorized?t.global.authInfoName||"":t.global.domain+"_"+t.global.username,i.fontSize=16,e.text(i.text),e.css({"font-size":i.fontSize+"px","font-family":"Microsoft Yahei"}),i.width=e.width(),i.height=e.height(),i}function n(){var e=h();t.global.dshWatermarkImg=i({text:e.text,width:e.width,height:e.height,fontSize:e.fontSize,mode:"dash"}),t.global.fullscreenWatermarkImg=i({text:e.text,width:e.width,height:e.height,fontSize:e.fontSize,mode:"fullscreen"});var n=".water-mark-dark{background:url("+t.global.dshWatermarkImg+")} .water-mark-white{background:url("+t.global.fullscreenWatermarkImg+")}";$(document).find("head").append('<style id="watermarkStyle">'+n+"</style>"),$(a).remove()}var r=$(a).find("canvas")[0];t.$watch("global.watterMark",function(t){t&&n()})}return{restrict:"A",template:"<canvas></canvas><span></span>",link:e}}angular.module("BC.directives").directive("waterMark",t),t.$inject=["$rootScope"]}();
;!function(){function e(e,t,a,i,l,s,r){function n(n,d){function f(){n.showDateAdvanceEdit?n.view="dateAdvance":(n.view="globalFilter",n.GF.getFilterItems(),n.showBaseLoading=!1)}function o(e){n.fieldMap={},angular.forEach(e.tb_list,function(e){angular.forEach(e.fields,function(e){n.fieldMap[e.fid]=e.data_type})})}var c=0;n.showDateAdvanceEdit=!1,n.view="globalFilter",n.new_add_df_name="",n.prevGlobalSave=function(){function e(t){return t.map(function(t){var a=t.df_id,i=n.filterStatus[a];t.df_id=0===a.indexOf("new")?"":a,t.name=i.name,t.config=i.config,t.data_type=i.data_type,t.type="string"==i.data_type?1:2,t.selected_charts=[],t.selected_tables={},angular.forEach(i.charts,function(e){!!e.selected&&t.selected_charts.push(e.ct_id)}),angular.forEach(i.tables,function(e){!!e.show&&(t.selected_tables[e.tb_id]=e.selected)}),r=t.data_type,d=t.config.granularity,"date"==r&&""==d?(t.config.default_select=!1,t.config.range&&(t.config.default_select=!0)):t.config.range="",t.items=t.items&&t.items.length>0?e(t.items):[]}),t}function a(e){for(var t=0;t<e.length;t++){var i=e[t],s=Object.keys(i.selected_tables);i.selected_tables[s[0]]||(l(i.name+": "+n.tips["dash.gfTableAndFieldRequired"]),f=!1);var r=n.fieldMap[i.selected_tables[s[0]]];for(var d in i.selected_tables)i.selected_tables.hasOwnProperty(d)&&r!==n.fieldMap[i.selected_tables[d]]&&(l(i.name+": "+n.tips["dash.gfFieldTypeMustBeSame"]),f=!1);i.items&&i.items.length>0&&a(i.items)}}var s=angular.copy(n.filterData.dsh_filter_list),r="",d="";s=e(s);var f=!0;return a(s),f?(n.showBaseLoading=!0,i.post("/api/dsh_filter/commit",{dsh_id:t.dashId,data:angular.toJson(s)}).then(function(e){return"0"==e.status?!0:(l(Number(e.status)),!1)})):void 0},n.goDateAdvanceEdit=function(){var e=n.prevGlobalSave();e&&e.then(function(e){if(e){if(!n.new_add_df_name)return n.showDateAdvanceEdit=!0,$(".ngdialog-close").css("display","none"),n.$broadcast("showDateAdvanceEdit",n.showDateAdvanceEdit),void f();a.dash_global_filter.list({dash_id:t.dashId,rule_id:n.ruleId}).success(function(e){if(n.showBaseLoading=!1,"0"==e.status){n.GF.initChartsAndTables(e.result),n.getInitialData=!1;var t=e.result.dsh_filter_list;t&&t.length>0&&(angular.forEach(e.result.dsh_filter_list,function(e){e.name==n.new_add_df_name&&(n.filterView.selected_opt=e.df_id)}),n.showDateAdvanceEdit=!0,$(".ngdialog-close").css("display","none"),n.$broadcast("showDateAdvanceEdit",n.showDateAdvanceEdit),f())}else l(Number(e.status))})}})},n.$on("hideDateAdvanceEdit",function(e,t){t&&(n.showDateAdvanceEdit=!1,f())}),n.allCharts={},n.getInitialData=!0,n.filterData={},n.filterView={model:"",editFilter:{}},n.goHelp=function(e){s(e)},n.GF={add:function(){n.filterView.isCreating||(n.filterView.editName=""),n.filterView.isCreating=!0,setTimeout(function(){$("#add_input").focus()},300),c++},initChartTableMap:function(){n.chartTableMap={};var e;angular.forEach(n.dashStandardItems,function(t){e=t.children[0].meta,n.chartTableMap[e.ct_id]=e.tb_id})},initChartsAndTables:function(e,t){function a(e){for(var t=0,i=e.length;i>t;t++){var l=e[t];n.filterStatus[l.df_id]={name:l.name,charts:angular.copy(n.charts),tables:angular.copy(n.tables),config:l.config||{},data_type:""},l.hasOwnProperty("items")||(l.items=[]),2==l.type?n.filterStatus[l.df_id].data_type="date":1==l.type&&(n.filterStatus[l.df_id].data_type="string"),n.GF.initSelectedStatus(l),l.items&&l.items.length>0&&a(l.items)}return e}n.charts=[];var i;angular.forEach(n.dashStandardItems,function(e){i=e.children[0].meta,2!=i.ct_type&&n.charts.push({name:i.name,ct_id:i.ct_id,tb_id:i.tb_id,is_gis:"C400"==i.type?!0:!1,selected:!1})}),n.tables=[],angular.forEach(e.tb_list,function(e){n.tables.push({show:!1,name:e.name,fields:e.fields,tb_id:e.tb_id,selected:""})}),n.filterStatus={},n.filterData=e,o(e),n.GF.initChartTableMap(),n.filterData.dsh_filter_list.length&&(a(n.filterData.dsh_filter_list),t&&(n.filterView.selected_opt=n.filterData.dsh_filter_list[0].df_id))},initSelectedStatus:function(e){angular.forEach(n.charts,function(t,a){n.filterStatus[e.df_id].charts[a].selected=$.inArray(t.ct_id,e.selected_charts)>-1}),angular.forEach(n.tables,function(t,a){n.filterStatus[e.df_id].tables[a].show=!!e.selected_tables[t.tb_id],n.filterStatus[e.df_id].tables[a].selected=e.selected_tables[t.tb_id]||""})},updateStatus:function(e){var t=n.filterStatus[n.filterView.selected_opt].charts,a=n.filterStatus[n.filterView.selected_opt].tables,i=n.chartTableMap[e.ct_id],l=function(e){for(var t=0;t<a.length;t++)if(i===a[t].tb_id)return a[t].show=e,!1};if(e.selected)n.changeCheckAll(!0),l(!0);else{n.changeCheckAll(!1);for(var s=0;s<t.length;s++)if(l(!1),i===t[s].tb_id&&t[s].selected)return l(!0),!1}n.GF.checkDataType()},checkAllCharts:function(e){n.allCharts[n.filterView.selected_opt]=e,n.isSelectingAllCharts=!0,angular.forEach(n.filterStatus[n.filterView.selected_opt].charts,function(t){t.selected=e,n.GF.updateStatus(t)}),n.allCharts[n.filterView.selected_opt]&&""!=selectFilter.data_type&&n.GF.getFilterItems(),n.isSelectingAllCharts=!1},list:function(e){a.dash_global_filter.list({dash_id:t.dashId,rule_id:n.ruleId}).success(function(t){"0"==t.status?(n.GF.initChartsAndTables(t.result,e),n.getInitialData=!1,n.filterData.dsh_filter_list.length>0&&n.changeCheckAll(!0)):l(Number(t.status))})},info:function(e,t){t&&t.stopPropagation(),n.filterView.selected_opt=e,e.indexOf("df_")>=0&&(n.new_add_df_name=""),n.changeCheckAll(!0),n.fieldSortValueCache&&n.fieldSortValueCache[e]&&(n.fieldSortValueCache[e].need=!0)},modify:function(){function i(e){for(var t=0;t<e.length;t++){var a=e[t],s=Object.keys(a.selected_tables);a.selected_tables[s[0]]||(l(a.name+": "+n.tips["dash.gfTableAndFieldRequired"]),o=!1);var r=n.fieldMap[a.selected_tables[s[0]]];for(var d in a.selected_tables)a.selected_tables.hasOwnProperty(d)&&r!==n.fieldMap[a.selected_tables[d]]&&(l(a.name+": "+n.tips["dash.gfFieldTypeMustBeSame"]),o=!1);a.items&&a.items.length>0&&i(a.items)}}function s(e){return angular.forEach(e,function(e){var t=e.df_id,a=n.filterStatus[t];e.df_id=0===t.indexOf("new")?"":t,e.name=a.name,e.config=a.config,e.data_type=a.data_type,e.type="string"==a.data_type?1:2,e.selected_charts=[],e.selected_tables={},angular.forEach(a.charts,function(t){!!t.selected&&e.selected_charts.push(t.ct_id)}),angular.forEach(a.tables,function(t){!!t.show&&(e.selected_tables[t.tb_id]=t.selected)}),d=e.data_type,f=e.config.granularity,"date"==d&&""==f?e.config.default_select=!!e.config.range:e.config.range="","string"==d&&n.fieldSortValueCache[t]&&n.fieldSortValueCache[t].sortRange&&n.fieldSortValueCache[t].sortRange.length>0&&(e.template=n.fieldSortValueCache[t].sortRange),e.items=e.items&&e.items.length>0?s(e.items):[]}),e}n.globalDashFilterItems={};var r=angular.copy(n.filterData.dsh_filter_list),d="",f="",o=!0;r=s(r),i(r),o&&a.dash_global_filter.modify({dash_id:t.dashId,dash_filter_list:angular.toJson(r)}).success(function(i){"0"==i.status?(l(n.tips.saveSuccess),e.closeAll(),a.dash_global_filter.item({dash_id:t.dashId}).then(function(e){"0"===e.status?(n.originalGlobalFilter=angular.copy(e.result),n.globalDashFilter=bdp.utils.handleGlobalFilterLevel(e.result)):l(Number(e.status))}),angular.forEach(n.drawChartUrl,function(e){e.lazyload||(e.options.optional._t=new Date,e.options.read_cache=!1,delete e.options.optional.dsh_filter)}),localforage.setItem("CACHE_DASH_DATA",{})):l(Number(i.status))})},del:function(e,t,a){function i(e){for(var t=0,l=e.length;l>t;t++){if(e[t].df_id==a){if(e[t].items&&e[t].items.length>0){var s=angular.copy(e[t].items);angular.forEach(s,function(t){e.push(t)})}e.splice(t,1);break}e[t].items&&e[t].items.length>0&&i(e[t].items)}return e}confirm(n.tips["dash.gfConfirmRemove"])&&(i(n.filterData.dsh_filter_list),delete n.filterStatus[a],a===n.filterView.selected_opt&&(n.filterView.selected_opt=n.filterData.dsh_filter_list.length?n.filterData.dsh_filter_list[0].df_id:""))},checkDataType:function(){function e(t){for(var a=0,i=t.length;i>a;a++){if(t[a].df_id==n.filterView.selected_opt)return t[a];t[a].items&&t[a].items.length>0&&e(t[a].items)}return{}}for(var t in n.filterStatus)if(t==n.filterView.selected_opt)selectFilter=n.filterStatus[t];else{var a=e(n.filterStatus);a.hasOwnProperty("df_id")&&(selectFilter=a)}var i=selectFilter.tables,l=[];angular.forEach(i,function(e){var t=n.fieldMap[e.selected];e.show&&l.indexOf(t)<0&&l.push(t)}),1===l.length&&l[0]?(selectFilter.data_type=l[0],(!selectFilter.config||isObjectEmpty(selectFilter.config))&&(selectFilter.config={granularity:"",default_select:!1,show_all:!0}),n.isSelectingAllCharts||n.GF.getFilterItems()):(n.range=[],selectFilter.data_type="")},getFilterItems:function(){var e=n.filterView.selected_opt,i=n.filterStatus[e],s={};return angular.forEach(i.tables,function(e){!!e.show&&(s[e.tb_id]=e.selected)}),n.range=[],"string"==i.data_type&&n.fieldSortValueCache[e]&&n.fieldSortValueCache[e].need&&n.fieldSortValueCache[e].sortRange.length?(n.range=n.fieldSortValueCache[e].sortRange||[],void(n.fieldSortValueCache[e].need=!1)):(e=0===e.indexOf("new")?"":e,n.showLoading=!0,void a.dash_global_filter.range({dash_id:t.dashId,rule_id:n.ruleId,df_id:e,selected_tables:angular.toJson(s),granularity:i.config.granularity}).success(function(e){if("0"===e.status){if(n.showLoading=!1,n.range=e.result.range||[],!n.filterStatus[n.filterView.selected_opt])return;if("date"==n.filterStatus[n.filterView.selected_opt].data_type&&""==n.filterStatus[n.filterView.selected_opt].config.granularity&&(n.filterStatus[n.filterView.selected_opt].config.default_select=!1),"string"==n.filterStatus[n.filterView.selected_opt].data_type&&delete n.fieldSortValueCache[n.filterView.selected_opt],0==n.range.length)n.filterStatus[n.filterView.selected_opt].config.range="";else{var t=!1,a=n.filterStatus[n.filterView.selected_opt].data_type,i=n.filterStatus[n.filterView.selected_opt].config.granularity;"date"==a&&""==i&&(angular.forEach(n.range,function(e){e.opt_id==n.filterStatus[n.filterView.selected_opt].config.range&&(t=!0)}),t||(n.filterStatus[n.filterView.selected_opt].config.range="",n.filterStatus[n.filterView.selected_opt].config.show_all=!0))}}else l(Number(e.status))}))},level:function(e,t,a){e&&e.stopPropagation();var i=t.index(),l=t.$parentNodeScope;"down"===a?i&&(t.prev().$modelValue.items.push(t.$modelValue),t.remove()):"up"===a&&l&&t.$last&&(l.$parentNodesScope.$modelValue.push(t.$modelValue),t.remove())}},n.$watch("filterView.selected_opt",function(e){e&&n.GF.checkDataType()}),d.on("click",function(){n.GF.list(!0),n.fieldSortValueCache={},e.open({template:"/static/js/global-filter/global_filter_set_modal.html",className:"ngdialog-theme-default global-filter-model",scope:n,preCloseCallback:function(){n.filterData={},n.filterView.selected_opt="",n.fieldSortValueCache={},n.filterView.isCreating=!1,n.filterView.model="",n.range=[]}})}),n.confirmName=function(e,t,a,i){function s(e){e.map(function(e){return e.df_id!=t&&e.name==n.filterView.editName?void(d=!0):void(e.items&&e.items.length>0&&s(e.items))})}function r(e){e.map(function(e){e.df_id==t&&(e.name=n.filterView.editName),e.items&&e.items.length>0&&r(e.items)})}if(i&&i.stopPropagation(),""===n.filterView.editName||!defined(n.filterView.editName))return l(n.tips["dash.gfNameRequired"]),!1;var d=!1;return s(n.filterData.dsh_filter_list),d?void l(n.tips["dash.gfNameDuplicate"]):("create"===e?(n.filterView.isCreating=!1,n.isCreating=!1,n.filterData.dsh_filter_list.push({df_id:"new"+c,name:n.filterView.editName,items:[]}),n.filterStatus["new"+c]={},n.filterStatus["new"+c].config={granularity:"",default_select:!1,show_all:!0},n.filterStatus["new"+c].charts=angular.copy(n.charts),n.filterStatus["new"+c].tables=angular.copy(n.tables),n.filterStatus["new"+c].name=n.filterView.editName,n.GF.info("new"+c),n.new_add_df_name=n.filterView.editName):(r(n.filterData.dsh_filter_list),n.filterStatus[t].name=n.filterView.editName,n.filterView.editFilter[t]=!1,n.GF.info(t)),n.filterView.model="createInfo",void(n.filterView.editName=""))},n.keyupFun=function(e,t,a,i){13==e.keyCode&&n.confirmName(t,a,i)},n.cancelEditStatus=function(){function e(t){t.map(function(t){n.filterView.editFilter[t.df_id]=!1,t.items&&t.items.length>0&&e(t.items)})}n.filterData.dsh_filter_list&&n.filterData.dsh_filter_list.length>0&&e(n.filterData.dsh_filter_list),n.filterView.model="createInfo"},n.editFilterName=function(e,t,a){e&&e.stopPropagation(),n.filterView.isCreating||(n.cancelEditStatus(),n.filterView.editFilter[t]=!0,n.filterView.editName=a)},n.stopPropagation=function(e){e.stopPropagation()},n.changeShowAllItem=function(){n.filterStatus[n.filterView.selected_opt].config.show_all=!n.filterStatus[n.filterView.selected_opt].config.show_all;var e=n.filterStatus[n.filterView.selected_opt].data_type,t=n.filterStatus[n.filterView.selected_opt].config.granularity,a=n.filterStatus[n.filterView.selected_opt].config.show_all,i=n.filterStatus[n.filterView.selected_opt].config.range;"date"==e&&""==t&&!i&&!a&&n.range.length>0&&(n.filterStatus[n.filterView.selected_opt].config.range=n.range[0].opt_id)},n.changeCheckAll=function(e){if(e){var t=0;angular.forEach(n.filterStatus[n.filterView.selected_opt].charts,function(e){e.selected&&t++}),n.allCharts[n.filterView.selected_opt]=t==n.filterStatus[n.filterView.selected_opt].charts.length}else n.allCharts[n.filterView.selected_opt]=!1},n.globalFilterTree={dragStart:function(){},dragMove:function(){},dragStop:function(){function e(a){angular.forEach(a,function(a){t[a.df_id]=n.filterStatus[a.df_id],a.items&&a.items.length>0&&e(a.items)})}var t={},a=n.filterData.dsh_filter_list;angular.forEach(a,function(e){t[e.df_id]=n.filterStatus[e.df_id]}),e(a),n.filterStatus=t}},n.sortGlobalStringFilter={items:".J-sortable-string",start:function(){},update:function(){n.fieldSortValueCache[n.filterView.selected_opt]={need:!1,sortRange:n.range}},stop:function(){}},r(["dash.gfTableAndFieldRequired","dash.gfFieldTypeMustBeSame","dash.gfConfirmRemove","dash.gfNameRequired","dash.gfNameDuplicate","saveSuccess"],n)}return{restrict:"A",scope:{originalGlobalFilter:"=",globalDashFilter:"=",ruleId:"=",drawChartUrl:"=",dashStandardItems:"=",globalDashFilterItems:"="},link:n}}angular.module("BC.directives").directive("globalFilterSet",e),e.$inject=["ngDialog","$stateParams","commonService","commonHttp","errHint","operatorHelpLink","$jsTipTranslate","$rootScope"]}();
;!function(){function t(t,e,r,a,i,n,l,s,d,o){function h(e,h){function f(t,r,a){var i=r.df_id,n=$(".project-nav").width()+64,l=t.pageX<n+200?{left:0}:{right:0},s=bdp.utils.getArrayTextWidth(a,r);l.width=s,e.adjustWidth[i]=l}function g(t,e){var a="global_filter_memory",i=angular.fromJson(window.localStorage.getItem(a))||[],n=!1,l=r.wsId||"";if(angular.forEach(i,function(r){r.name==t.name&&r.ws_id==l&&(r.range=e,r.data_type=t.data_type,"date"==t.data_type?r.granularity=t.config.granularity||"":"string"==t.data_type&&(r.granularity="",r.range_type=t.range_type),n=!0)}),!n){var s={name:t.name,range:e,ws_id:r.wsId||"",granularity:t.config.granularity||"",data_type:t.data_type,range_type:""};"string"==t.data_type&&t.hasOwnProperty("range_type")&&(s.range_type=t.range_type),i.push(s)}window.localStorage.setItem(a,angular.toJson(i))}e.advanceView={},e.showQueryfilter={},e.queryString={},e.globalDashFilterItems={};e.adjustWidth={},e.originalRange=[];var u;e.dateTimeByHalfHour=o,e.refreshCharts=function(t,r,a){t.range=a,t.show=!1,t.showName=""!==r?r:t.name,g(t,a),e.globalDashFilterItems[t.df_id]={granularity:t.config.granularity||"",df_id:t.df_id,range:a,data_type:t.data_type,show_name:t.showName,real_name:r,rela_charts:t.rela_ct_ids,range_type:t.range_type};var i=[];angular.forEach(e.globalDashFilterItems,function(t){i.push({df_id:t.df_id,range:t.range,data_type:t.data_type,granularity:t.granularity,range_type:t.range_type})}),angular.forEach(e.drawChartUrl,function(t){t.global_filter_value=[],angular.forEach(e.globalDashFilterItems,function(e){e.rela_charts.indexOf(t.options.ct_id)>-1&&(t.options.optional.dsh_filter=i,delete t.options.optional.filter_list,t.options.read_cache=!1,t.options.optional._t=new Date)})}),setTimeout(function(){e.scrollHandler.init(e.scrollHandler.scrollWidth)},10)},e.saveDateRange=function(t){var r=e.globalDashFilter[t.data.index],i="",n=t.sDate?t.sDate+" "+t.sDateHour:null,l=t.eDate?t.eDate+" "+t.eDateHour:null;if(!n&&!l)return s(e.tips["chart.dateRangeRequired"]),!1;if(n&&l){if(!t.sDateHour)return s(e.tips["filter.startDateErr2"]),!1;if(!t.eDateHour)return s(e.tips["filter.endDateErr2"]),!1;if(new Date(n)-new Date(l)>0)return s(e.tips["filter.dateRangeInvalid"]),!1}else{if(n&&!l&&!t.sDateHour)return s(e.tips["filter.startDateErr2"]),!1;if(!n&&l&&!t.eDateHour)return s(e.tips["filter.endDateErr2"]),!1}n?(i+=n,i+=l?"~"+l:"~"+e.tips["chart.notLimit"]):(i+=e.tips["chart.notLimit"]+"~",i+=l),a.close(u.id),u=null,e.refreshCharts(r,i,[n,l])},e.queryKwd={},e.filterQueryModule={enterToQuery:function(t){13==t.e.keyCode&&(t.real_search?e.filterQueryModule.query(t.filter,t.is_advance):e.queryString[t.filter.df_id].keyword=e.queryKwd[t.filter.df_id])},query:function(t,r){e.showLoading=!0,e.setParentAndChildMap();var a=e.getParentFilterRange(t.df_id),i=t.df_id,n=e.queryKwd[i]||e.strFilter&&e.strFilter.keyword;if(n){var d={keyword:n,rule_id:e.ruleId,df_id:t.df_id,granularity:t.config.granularity||"",parent_range:angular.toJson(a)};r&&(e.strFilter.loading=!0),l.post("/api/dsh_filter/enum_search",d).then(function(t){if(e.showLoading=!1,0==t.status)if(r){var a=[];angular.forEach(t.result,function(t){a.push({name:t,select:!1})}),e.strFilter.loading=!1,e.strFilter.searchList=a}else e.tempQueryList=angular.copy(e.queryString[i].list),e.queryString[i].list=t.result,e.queryString[i].show=!0;else s(Number(t.status))})}else if(e.showLoading=!1,r){var o=[];angular.forEach(e.originalRange,function(t){o.push({name:t,select:!1})}),e.strFilter.searchList=o}},delQueryField:function(t){e.tempQueryList&&(e.queryString[t].list=e.tempQueryList||[]),e.queryKwd[t]=""}},e.$watch("finalGlobalFilterList",function(t,r){e.finalGlobalFilterList=r}),e.innerFilterModule={showDatePicker:function(t,r){if(navigator.userAgent.indexOf("Firefox")>=0&&r[0]&&r[0].indexOf("opt_")>=0);else if(navigator.userAgent.indexOf("Firefox")>=0&&r&&r.length>0){var i=null,n=null;r[0]&&(i=r[0].split("-"),i[1]<10&&(i[1]="0"+parseInt(i[1])),i[2]<10&&(i[2]="0"+parseInt(i[2])),i=i[0]+"-"+i[1]+"-"+i[2]),r[1]&&(n=r[1].split("-"),n[1]<10&&(n[1]="0"+parseInt(n[1])),n[2]<10&&(n[2]="0"+parseInt(n[2])),n=n[0]+"-"+n[1]+"-"+n[2]),r=[i,n]}if(r.length>1){var l=r[0]?r[0].split(" ")[1]||"00:00:00":"00:00:00",s=r[1]?r[1].split(" ")[1]||"23:59:59":"23:59:59";r=r.concat([l,s])}else 1===r.length&&r[0].indexOf("opt_")>-1?r=[+new Date,+new Date,"00:00:00","23:59:59"]:0===r.length&&(r=[+new Date,+new Date,"00:00:00","23:59:59"]);u=a.open({template:"/static/partials/dialogTemplates/custom_date_modal.html",className:"ngdialog-theme-default date-picker-modal daterange-bdp-modal",data:{index:t,range:r},scope:e})},getItemList:function(t,r,a){e.setParentAndChildMap();var l=e.getParentFilterRange(r.df_id);r.show=a?!1:!r.show,(r.show||a)&&(e.showLoading=!0,e.queryKwd[r.df_id]="",n.dash_global_filter.range({dash_id:i.dashId,rule_id:e.ruleId,df_id:r.df_id,granularity:r.config.granularity||"",range:angular.toJson(l)}).success(function(i){if(0==i.status){e.showLoading=!1;var n=i.result.range;e.rangeList=n,!a&&f(t,r,n),e.showQueryfilter[r.df_id]=i.result.total>100,e.queryString[r.df_id]={show:!e.showQueryfilter[r.df_id],keyword:"",list:n,total:i.result.total},a&&(a(r,i.result.range),e.originalRange=i.result.range)}else s(Number(i.status))}))},openAdvanceModal:function(t,r){for(var i,t=angular.copy(t),n=0;n<e.globalDashFilter.length;n++)if(e.globalDashFilter[n].df_id===t.df_id){i=n;break}{var l=void 0==t.range?[]:t.range;e.globalDashFilter[i].showName}e.strFilter={index:i,df_id:t.df_id,name:t.name,data_type:t.data_type,keyword:"",config:t.config,searchList:[],addList:l,range_type:t.hasOwnProperty("range_type")?t.range_type:"1"},angular.forEach(r,function(t){e.strFilter.searchList.push($.inArray(t,l)>-1?{name:t,select:!0}:{name:t,select:!1})}),e.disabled_compare=!0,a.open({template:"/static/partials/strFilterModel.html",className:"ngdialog-theme-default str-filter-model global-str",scope:e})},addAdvanceItem:function(r,a){a&&a.stopPropagation();var i=!1;return $.inArray(r.name,e.strFilter.addList)>-1&&(i=!0),i?void s(e.tips["filter.hasTheFilter"]):(e.strFilter.addList.push(r.name),void t(function(){var t=$(".add-list").find("ul"),e=t[0].scrollHeight;t.animate({scrollTop:e})},300))},delAdvanceItem:function(t,r){r&&r.stopPropagation();for(var a=e.strFilter.searchList,i=0,n=a.length;n>i;i++)if(a[i].name==e.strFilter.addList[t]){a[i].select=!1;break}e.strFilter.addList.splice(t,1)},delAll:function(){e.strFilter.addList=[]},addAll:function(){return 0==e.strFilter.addList.length?void angular.forEach(e.strFilter.searchList,function(t){e.strFilter.addList.push(t.name)}):void angular.forEach(e.strFilter.searchList,function(t){$.inArray(t.name,e.strFilter.addList)<0&&e.strFilter.addList.push(t.name)})},saveAdvance:function(){var t=e.globalDashFilter[e.strFilter.index],r=e.strFilter.addList,a=r.join(",");t.range_type=e.strFilter.range_type,e.refreshCharts(t,a,r)}},e.setParentAndChildMap=function(){function t(r,l){angular.forEach(r,function(r){i=[],angular.forEach(a,function(t){t.df_id==l.df_id&&(i=t.range,n=t.hasOwnProperty("range_type")?t.range_type:"1")}),"string"==l.data_type&&(l.config.granularity=""),e.parentAndChildMap.push({parent_df_id:l.df_id,parent_name:l.name,parent_granularity:l.config.granularity,parent_range:i,parent_data_type:l.data_type,parent_range_type:n,self_df_id:r.df_id,self_name:r.name}),r.items&&r.items.length>0&&t(r.items,r)})}e.parentAndChildMap=[];var r=angular.copy(e.originalGlobalFilter),a=e.globalDashFilter,i=[],n="1",l={df_id:"",name:"",range:[],data_type:"",config:{granularity:""},range_type:"1"};t(r,l)},e.getParentFilterRange=function(t){function r(t){angular.forEach(e.parentAndChildMap,function(e){t==e.self_df_id&&e.parent_df_id&&(a.push({df_id:e.parent_df_id,range:e.parent_range,data_type:e.parent_data_type,name:e.parent_name,granularity:e.parent_granularity||"",range_type:e.parent_range_type}),r(e.parent_df_id))})}var a=[];return r(t),angular.forEach(a,function(t){delete t.name}),a},e.setParentAndChildMap(),e.resetRangeType=function(t){t.range_type="1"},e.scrollHandler={scrollCount:0,scrollWidth:0,firstIndex:0,nextIndex:0,itemWidthArr:[],rightShadow:24,getItemWidth:function(){for(var t=h.find(".global-filter").find(".filter-i"),e=[],r=0;r<t.length;r++)e.push(t[r].scrollWidth+24);this.itemWidthArr=[];for(var r=0;r<e.length;r++)this.itemWidthArr.push(0===r?e[0]:this.itemWidthArr[r-1]+e[r])},_setFirstIndex:function(t){var e=this.itemWidthArr.length;if(t-this.rightShadow>=this.itemWidthArr[e-1])return this.firstIndex=e-1,void(this.scrollWidth=this.itemWidthArr[this.firstIndex-1]||0);for(var r=0;e>r;r++)if(t-this.rightShadow<=this.itemWidthArr[r]){this.firstIndex=r,this.scrollWidth=this.itemWidthArr[this.firstIndex-1]||0;break}},_setNextIndex:function(t,e){for(var r=this.firstIndex;r<this.itemWidthArr.length;r++)if(this.nextIndex=0,t+e-this.rightShadow<=this.itemWidthArr[r]){this.nextIndex=r;break}0===this.nextIndex&&(this.nextIndex=this.itemWidthArr.length)},init:function(t){this.getItemWidth();var e=h.find(".global-filter"),r=e.innerWidth();this._setFirstIndex(t),this._setNextIndex(t,r)},scroll:function(t){this.scrollCount=this.scrollCount+t,this.getItemWidth();var e=h.find(".global-filter"),r=e[0].scrollWidth,a=e.innerWidth();if(this.scrollWidth=t>0?(this.scrollWidth||0)+a:this.scrollCount?(this.scrollWidth||0)-.5*a:0,this.scrollCount<0||r+this.rightShadow<=a||this.scrollWidth>=r+a-56)return void(this.scrollCount=this.scrollCount-t);this.scrollWidth>=0&&(this._setFirstIndex(this.scrollWidth),this._setNextIndex(this.scrollWidth,a));var i=0===this.scrollWidth?32:56-this.scrollWidth;e.animate({left:i})}},setTimeout(function(){e.scrollHandler.init(0)}),$(window).on("resize.globalFilter",$.debounce(300,function(){e.scrollHandler.init(e.scrollHandler.scrollWidth)})),e.$on("$destroy",function(){$(window).off("resize.globalFilter")}),d(["chart.notLimit","chart.dateRangeRequired","filter.hasTheFilter","filter.dateRangeInvalid","filter.startDateErr2","filter.endDateErr2"],e)}return{restrict:"A",templateUrl:"/static/js/common/tpl/global_filter.html",scope:{originalGlobalFilter:"=",globalDashFilter:"=",globalDashFilterItems:"=",ruleId:"=",showLoading:"=",drawChartUrl:"=",filterStatus:"=",onSharePage:"="},link:h}}angular.module("BC.directives").directive("globalFilter",t),t.$inject=["$timeout","$interval","$rootScope","ngDialog","$stateParams","commonService","commonHttp","errHint","$jsTipTranslate","dateTimeByHalfHour"]}();
;function expressionFuncTip(){return{restrict:"A",link:function(t,e,i){var n=i.funcTip?e.closest(i.funcTip)[0]:e.parent().parent()[0];e.hover(function(){if(n){var t=e.offset(),i=e.width(),r=(e.height(),$(this).find(".func-tip")),s=(r.offset(),r.outerHeight()),o=$(window).height(),a={left:t.left+i+10};a.top=t.top+s/2-10<o?t.top-r.outerHeight()/2-10:o-r.outerHeight(),r.css(a)}})}}}function expressionFilter(){return{templateUrl:"/static/partials/directiveTemplates/expression_filter.html",link:function(){},replace:!0,scope:{tbList:"=",expressionData:"=",hasBtn:"=",multipleTb:"="},controller:"expressionFilterCtrl"}}function expressionFilterCtrl(t,e,i,n,r,s,o){function a(){if(0==e.tbList.length)f.curTb=void 0,f.sql="",e.expressionData={},c("");else{var t=[];angular.forEach(e.expressionData,function(i,n){l(n)||(t.push(n),delete e.expressionData[n])}),t.indexOf(f.curTb)>-1&&(c(e.tbList[0].tb_id),e.tbList[0].open=!0)}}function l(t){for(var i=e.tbList,n=!1,r=0;r<i.length;r++)if(i[r].tb_id==t){n=!0;break}return n}function c(t){f.curTb=t,f.sql=e.expressionData[t]||"",e.updataSqlVal&&e.updataSqlVal()}function u(t){return 0!=e.tbList.length?t?void angular.forEach(e.tbList,function(e){e.open=!1,e.tb_id==t&&(e.open=!0)}):void(e.tbList[0].open=!0):void 0}var p;e.viewData={tab:1,funcList:[],sql:"",curTb:p||""},t.$watch("global.funcList",function(t){t&&(e.viewData.funcList=t.base)}),e.expressionData=e.expressionData||{},e.$on("initTbList",function(t,i){if(0!=e.tbList.length){var n=i;i||(n=e.tbList[0].tb_id),c(n),u(n),e.$broadcast("updateTbList")}}),e.$on("updateTbList",function(){a(),e.tbList&&e.tbList.length>0&&e.tbList.forEach(function(t){t.fields=bdp.utils.addSpecParamsToFields(t.fields)})});var d=e.$watch("tbList",function(t){t&&(e.$broadcast("initTbList"),d())}),f=e.viewData;f.tbList=e.tbList,e.tbList&&e.tbList.length>0&&(p=e.tbList[0].tb_id,e.tbList[0].open=!0,f.curTb=e.tbList[0].tb_id),f.curTb&&(f.sql=e.expressionData[p]),e.$on("initSql",function(t,e){var i=e||f.curTb;c(i),u(i)}),e.tabTable=function(t){t.open=!t.open,angular.forEach(e.tbList,function(e){t.tb_id!=e.tb_id&&(e.open=!1)}),t.open&&(f.curTb=t.tb_id,f.sql=e.expressionData[t.tb_id]||"",e.updataSqlVal())},e.insertFieldName=function(t){e.insert("["+t+"]")},e.insertFunc=function(t){t="COUNT_DISTINCT"===t?"COUNT(DISTINCT())":t+"()",e.insert(t),e.setCursor("COUNT(DISTINCT())"==t?2:1)},e.previewFilterAction=function(){e.$emit("toFilter","parent")},e.sqlTrans=function(){if(0!=e.tbList.length&&(1!=e.tbList.length||0!=e.tbList[0].fields.length)&&f.curTb){if(!f.sql)return void o(e.tips["where.sqlScriptNull"]);if("common"==f.curTb)return void e.$emit("toSqlTrans",f.sql);var t=f.curTb;r.tb.sqlTrans({tb_id:t,sql:f.sql}).then(function(t){0==t.status&&o(e.tips["filter.checkSuccess"])})}},s(["filter.checkSuccess","where.sqlScriptNull"],e)}function formulaExpression(){function t(t,e,i){function n(){r=CodeMirror.fromTextArea(e[0],{mode:"text/x-bdp-sql",indentWithTabs:!0,smartIndent:!0,lineWrapping:!0,matchBrackets:!0,readOnly:s?"nocursor":!1,theme:"paraiso-light",fields:t.fields,placeholder:i.p?i.p:"SUM([A]) + SUM([B])"}),t.viewData.sql&&r.setValue(t.viewData.sql),s||(r.on("change",function(){t.expressionData[t.viewData.curTb]=t.viewData.sql=r.getValue().replace(/0xa0/,"")}),t.insert=function(t){r.replaceSelection(t),r.focus()},t.setCursor=function(t){var e=r.getCursor(),i=e.ch-t;r.setCursor(e.line,i)}),t.updataSqlVal=function(){r.setValue(t.viewData.sql||"")},t.updataSqlVal()}var r,s=!!i.readonly,o={funcQueue:[],loadLibInProgress:!1};thirdPluginLoader({initFun:n,libSrc:"https://m1.bdp.cn/static/js/lib/bdpFormula/bdp-codemirror_4fc5c0e.js",otherSrc:"",libId:window.CodeMirror},o)}return{restrict:"A",link:t}}function formulaExpressionReadonly(){function t(t,e,i){function n(){r=CodeMirror.fromTextArea(e[0],{mode:"text/x-bdp-sql",indentWithTabs:!0,smartIndent:!0,lineWrapping:!0,matchBrackets:!0,readOnly:s?"nocursor":!1,theme:"paraiso-light",fields:t.fields,placeholder:i.p?i.p:"SUM([A]) + SUM([B])"}),r.setValue(t.formulaData)}var r,s=!!i.readonly,o={funcQueue:[],loadLibInProgress:!1};thirdPluginLoader({initFun:n,libSrc:"https://m1.bdp.cn/static/js/lib/bdpFormula/bdp-codemirror_4fc5c0e.js",otherSrc:"",libId:window.CodeMirror},o)}return{restrict:"A",link:t,scope:{formulaData:"="}}}angular.module("BC.directives").directive("expressionFilter",expressionFilter).directive("expressionFuncTip",expressionFuncTip).directive("formulaExpression",formulaExpression).directive("formulaExpressionReadonly",formulaExpressionReadonly),expressionFuncTip.$inject=["$rootScope"],expressionFilter.$inject=["$rootScope"],expressionFilterCtrl.$inject=["$rootScope","$scope","getFunctionList","$timeout","commonService","$jsTipTranslate","errHint"],formulaExpression.$inject=["$rootScope"],formulaExpressionReadonly.$inject=[];
;angular.module("BC.directives").directive("userGuide",["commonService","$http","commonHttp","$timeout","ngDialog","$location","$position","$stateParams","$rootScope","errHint","$jsTipTranslate","capacityHint",function(e,t,i,a,o,d,s,r,n,u){return{restrict:"A",templateUrl:"/static/js/common/tpl/guide/user_guide.html",replace:!1,scope:!0,link:function(s){function c(e){12==e.stepNum||103==e.stepNum?$("."+e.domClass).on(e.eventName,function(){l(e)}):$("body").off(e.eventName).on(e.eventName,"."+e.domClass,function(t){t.preventDefault(),l(e)})}function l(e){n.guideStep=e.stepNum?e.stepNum:n.guideStep++,e.path&&d.path(e.path),e.mask?s.guideMask=e.mask:""===e.mask&&(s.guideMask=void 0),$("body").off(e.eventName),s.$$phase||s.$apply(),p("no",n.guideStep)}function p(e,i){if(n.guideStep=i,"no"==e)var a={step:i};else var a={step:i,guide:userGuideFlags.set("origin",e)};t.post("/api/user/guide_set",a).success(function(e){return 0==e.status?!0:(errorHandle(e),!1)})}function h(){for(var e,t,i=s.dashStandardItems||[],a=i.length,o=0,d=0,r=0,n=0;a>n;n++){var u=i[n];u.row+u.sizeY>d&&(u.col+u.sizeX>6?(d=u.row+u.sizeY,r=0):(d=u.row,r=u.col+u.sizeX));for(var c=0;c<u.children.length;c++)e=u.children[c],t=parseInt(e.dom_id.substr(2)),o=t>o?t:o}o++;var l={sizeX:6,sizeY:4,row:d,col:r,children:[{dom_id:"id"+o,meta:{name:"未命名图表",ct_id:"init_ctid"}}]};s.dashStandardItems||(s.dashStandardItems=[]),s.dashStandardItems.push(l)}function m(e,t){var i=angular.copy(e);return angular.forEach(i,function(e){e.children[0].meta={ct_id:e.children[0].meta.ct_id},t&&(e.children[0].meta.dash_setting=e.children[0].meta.dash_setting)}),i}function g(t){e.dash_global_filter.item({dash_id:t,rule_id:n.global.rule_id||""}).success(function(e){"0"===e.status&&(s.global.globalDashFilter=e.result,angular.forEach(s.global.globalDashFilter,function(e){if("date"==e.data_type&&""==e.config.granularity){var t=e.config.range||"";if(t){var i=!1;angular.forEach(e.adv_date_list,function(e){e.opt_id==t&&(i=!0)}),i||(e.config.range="",e.config.default_select=!1,e.range=[])}}}))})}s.show_guide=!1,s.currentGuideType="",s.guideMask=void 0;var f={dashTplGuide:{mask:"/static/js/user-guide/new-version/template_page.html",stepNum:101,cnzzRecord:"operation"},internetOperation:{path:"/dash_tpl",mask:"/static/js/user-guide/new-version/template_page.html",stepNum:101,cnzzRecord:"operation"},electricitySupplier:{path:"/dash_tpl",mask:"/static/js/user-guide/new-version/template_page.html",stepNum:101,cnzzRecord:"electricity"},corporateFinance:{path:"/dash_tpl",mask:"/static/js/user-guide/new-version/template_page.html",stepNum:101,cnzzRecord:"sales"},customAnalysis:{path:"/database",mask:"/static/js/user-guide/new-version/how_to_use_guide.html",stepNum:1,cnzzRecord:"analysis"},customAnalysisAction:{domClass:"J-action-analysis-button",eventName:"click.guide.customAnalysisAction",path:"",mask:"/static/js/user-guide/new-version/add_datasource_button.html",stepNum:2,cnzzRecord:"customOverview"},toAddDbsPage:{domClass:"J-guide-add-dbs",eventName:"click.guide.toAddDbsPage",mask:"",path:"",stepNum:4},toPageUpload:{domClass:"J-page-upload",eventName:"click.guide.toPageUpload",mask:"",path:"",stepNum:3},CustomPreviewUplpadData:{mask:"/static/js/user-guide/new-version/page_upload_preview.html",path:"",stepNum:3},CustomPreviewUplpadDataOk:{domClass:"J-preview-guide-complete",eventName:"click.guide.previewUplpadDataOk",mask:"",path:"",stepNum:3},createDb:{mask:"",path:"/data_source",stepNum:5},continueNewChart:{domClass:"J-continue-new-chart",eventName:"click.guide.continueNewChart",mask:"/static/js/user-guide/new-version/new_chart_button.html",path:"",stepNum:6,cnzzRecord:"continueNewChart"},JNewChart:{domClass:"J-new-chart",eventName:"click.guide.newChart",mask:"",path:"",stepNum:7,cnzzRecord:"newChartClick"},dropOnX:{mask:"/static/js/user-guide/new-version/dropOnY.html",path:"",stepNum:9,cnzzRecord:"dropOnX"},dropOnY:{mask:"/static/js/user-guide/new-version/how_creat_button.html",path:"",stepNum:10,cnzzRecord:"dropOnY"},showGudieVideo:{domClass:"J-how-create-button",eventName:"click.guide.howCreatChart",mask:"",path:"",stepNum:11,cnzzRecord:"showGudieVideo"},quitChartEdit:{domClass:"J-create-chart-ok-button",eventName:"click.guide.createChartOk",mask:"",path:"",stepNum:12,cnzzRecord:"quitChartEdit"},newChartOk:{domClass:"J-see-share-button",eventName:"click.guide.newChartOk",mask:"/static/js/user-guide/new-version/design_dashboard_button.html",path:"",stepNum:13,cnzzRecord:"newChartOk"},designStart:{mask:"",path:"",stepNum:14,cnzzRecord:"designStart"},designEnd:{mask:"/static/js/user-guide/new-version/share_button.html",path:"",stepNum:15,cnzzRecord:"designEnd"},shareDashboard:{domClass:"J-share-button",eventName:"click.guide.shareStart",mask:"",path:"",stepNum:16,cnzzRecord:"shareDashboard"},shareComplete:{mask:"",path:"",stepNum:17,cnzzRecord:"shareComplete"}};s.dontDesignToShare=function(){l(f.designEnd),c(f.shareDashboard)},s.dontSeeGuideVideo=function(){l(f.showGudieVideo)},s.dontShareDashboard=function(){l(f.shareDashboard),o.open({template:"/static/js/user-guide/new-version/custom_guide_complete.html",className:"ngdialog-theme-default ngDialog-width-320",scope:s})},s.calcAddDataSourceButtonTop=function(){a(function(){$(".J-guide-add-dbs-tips").css({top:$(".J-guide-add-dbs").offset().top+$(".J-guide-add-dbs").height()+20,display:"block"})},100)},s.skipStep=function(){l(f.newChartOk)},s.changeGuideType=function(t){e.project.getTree({is_tpl:1}).then(function(e){switch(projectIdArray=e.proj,e.proj.length>3&&(f.internetOperation.path="/dash_tpl/"+projectIdArray[0].proj_id+(projectIdArray[0].dsh_list[0].dsh_id?"/"+projectIdArray[0].dsh_list[0].dsh_id:""),f.electricitySupplier.path="/dash_tpl/"+projectIdArray[1].proj_id+(projectIdArray[1].dsh_list[0].dsh_id?"/"+projectIdArray[1].dsh_list[0].dsh_id:""),f.corporateFinance.path="/dash_tpl/"+projectIdArray[2].proj_id+(projectIdArray[2].dsh_list[0].dsh_id?"/"+projectIdArray[2].dsh_list[0].dsh_id:"")),t){case"internetOperation":n.guide=0,userGuideFlags.set("origin",0),p(0,0),d.path(f.internetOperation.path);break;case"electricitySupplier":n.guide=0,userGuideFlags.set("origin",0),p(0,0),d.path(f.electricitySupplier.path);break;case"corporateFinance":n.guide=0,userGuideFlags.set("origin",0),p(0,0),d.path(f.corporateFinance.path);break;case"customAnalysis":l(f.customAnalysis),c(f.customAnalysisAction)}})},s.$on("nextGuide",function(e,t){switch(t){case"quitAddDbs":l(f.customAnalysisAction),a(function(){s.calcAddDataSourceButtonTop()},0);break;case"toAddDbsPage":l(f.toAddDbsPage);break;case"toPageUpload":l(f.toPageUpload);break;case"createDb":l(f.createDb),o.closeAll(),o.open({template:"/static/js/user-guide/new-version/data_access_complete.html",data:{step:1},className:"ngdialog-theme-default ngDialog-width-320",scope:s,showClose:!1}),c(f.continueNewChart);break;case"createChart":s.selectDataSheet(),localStorage.setItem("mc_guide_edit_guide","1");break;case"dropOnX":l(f.dropOnX);break;case"dropOnY":l(f.dropOnY);break;case"designStart":l(f.designStart);break;case"designEnd":l(f.designEnd),c(f.shareDashboard);break;case"shareComplete":o.open({template:"/static/js/user-guide/new-version/custom_guide_complete.html",className:"ngdialog-theme-default ngDialog-width-320",scope:s});break;case"CustomPreviewUplpadData":l(f.CustomPreviewUplpadData),c(f.CustomPreviewUplpadDataOk);break;case"testForZidingyi":n.guide=2,n.guideStep=0,s.guideMask="/static/js/user-guide/new-version/select_guide.html"}}),s.customGuideComplete=function(){n.guide=0,userGuideFlags.set("origin",0),n.guideStep=18,p(0,18),n.guideStep=0};var v=s.$watch(function(){return n.guide},function(){n.guideStep=0,0===n.guide?v():(v(),2==n.guide&&(n.guideStep=0,p(1,0),d.path("/database"),s.guideMask="/static/js/user-guide/new-version/select_guide.html"))});s.$watch(function(){return n.guideStep},function(e){6==e?c(f.JNewChart):10==e?c(f.showGudieVideo):11==e?c(f.quitChartEdit):12==e&&(o.open({template:"/static/js/user-guide/new-version/data_access_complete.html",data:{step:2},className:"ngdialog-theme-default ngDialog-width-320",scope:s,showClose:!1}),c(f.newChartOk))}),s.exitGuide=function(){o.openConfirm({template:"/static/js/user-guide/new-version/quit_guide.html",className:"ngdialog-theme-default ngDialog-width-320 guide-dialog",scope:s,data:{message:"确认退出引导吗？ 退出引导后，如有其他使用问题，可点击右上角咨询按钮，进行在线咨询"}}).then(function(){s.okExitGuide()})},s.okExitGuide=function(){s.guideMask="",o.closeAll(),$("body").off("click.guide"),n.guide=n.guideStep>100?0:1,p(n.guide,n.guideStep),n.guideStep=0},s.new_create_chart=!0,s.selectDataSheet=function(){s.isUploadFile=!1;var e=function(e){s.folderList=e,s.original_folderList=angular.copy(e),s.create_chart_dialog=o.open({template:"/static/js/user-guide/select_chart_data.html",className:"ngdialog-theme-default data-source",data:{json_data:{title:"选择工作表",type:"choose",show_upload:!1},choose_table:{tb_id:""}},scope:s,showClose:!1,preCloseCallback:function(){s.isUploadFile||(c(f.JNewChart),l(f.continueNewChart),s.show_guide=!0),s.$$phase||s.$apply()}}),s.show_guide=!1};i.get("/api/folder/list").then(function(t){0==t.status&&e(t.result)})},s.createChart=function(t){if(!t.tb_id)return void u("请选择表");s.dashSelected=r.dashId;var i=function(i,a){h(),e.chart.create({dsh_id:s.dashSelected,tb_id:t.tb_id,dsh_meta:{charts:m(s.dashStandardItems)}}).success(function(e){if("0"==e.status){o.closeAll(),$.cookie("grid_index","");var t=e.result.ct_id;if(o.closeAll(),a){var r=d.path();i&&(r+="/"+s.activeProjId),a&&(r+="/"+s.dashSelected),s.show_guide=!1,r=r.replace("data_source","chart_edit"),d.path(r+"/"+t),n.guideStep=8,s.guideMask="/static/js/user-guide/new-version/dropOnX.html"}a||(s.show_guide=!1,r=d.path(),r=r.replace("data_source","chart_edit"),d.path(r+"/"+t),n.guideStep=8,s.guideMask="/static/js/user-guide/new-version/dropOnX.html")}else errorHandle(e)})},a=this;if(s.dashSelected){var c={};c.dsh_id=s.dashSelected,e.dashboard.getInfo(c).then(function(e){var e=e.result;return e.meta.hasOwnProperty("charts")&&(s.dashStandardItems=e.meta.charts||[]),s.dashboardMeta=e.meta,i.call(this)})}else{var l=function(t){var o={name:"我的仪表盘",proj_id:s.activeProjId};return e.dashboard.create(o).then(function(o){if("0"===o.status){s.dashSelected=o.result.dsh_id,s.dashTitle="我的仪表盘";var d={};d.dsh_id=s.dashSelected,e.dashboard.getInfo(d).then(function(e){var e=e.result;e.meta.hasOwnProperty("charts")&&(s.dashStandardItems=e.meta.charts||[]),i.call(a,t,!0)})}})};void 0==s.activeProjId?e.project.create("我的文件夹").then(function(e){"0"===e.status&&(s.activeProjId=e.result.proj_id,l(!0))}):l()}},s.modify=function(){s.dashStandardItems.sort(function(e,t){return e.row-t.row}),s.dashTitle="我的仪表盘";var t;return t={access_token:$.cookie("token"),dsh_id:s.dashSelected,data:angular.toJson({name:s.dashTitle,label:"",comment:"",meta:{charts:m(s.dashStandardItems,!0)}})},e.dashboard.modify(t).then(function(e){"0"!=e.status?("3204"==e.status&&alert("报表标题重名"),errorHandle(e)):g(s.dashSelected)})}},controller:["$scope","$stateParams","commonHttp","$rootScope","errHint","ngDialog","$translate","$jsTipTranslate",function(){}]}}]).directive("dotGuide",["commonService","$http","commonHttp","$timeout","ngDialog","$location","$position","$stateParams","$rootScope","errHint","$jsTipTranslate","capacityHint","dotGuide",function(e,t,i,a,o,d,s,r,n,u,c,l,p){return{restrict:"A",templateUrl:"/static/js/common/tpl/guide/dot_guide.html",scope:{dotMask:"=",watchStatus:"=",guideItem:"@",guideType:"@",btnClass:"@",addClass:"="},link:function(e,i){function o(){$("body").off("click.changeDotStep").on("click.changeDotStep","."+e.btnClass,function(){d()})}function d(){e.showDotGuideTip=!1,a(function(){e.watchStatus=e.dotGuideData[e.guideItem].nextGuideNum},0),$("."+e.btnClass).off("click.changeDotStep");var i={};i[e.dotGuideData[e.guideItem].paramVal]=e.dotGuideData[e.guideItem].nextGuideNum,t.post("/api/user/guide_set",i).success(function(e){return 0==e.status?!0:(errorHandle(e),!1)})}e.dotGuideData=p[e.guideType],$(i).addClass(e.addClass);var s=e.$watch("watchStatus",function(t){switch(e.guideItem){case"advancedComputing":t===e.dotGuideData[e.guideItem].guideNum&&(o(),s());break;default:s()}});e.clickShowInfo=function(){return e.dotGuideData[e.guideItem].tooltipText?(e.dotMask=!0,void a(function(){e.showDotGuideTip=!0,e.dotMask&&$("."+e.btnClass).off("click.changeDotStep").on("click.changeDotStep",function(){d()})},0)):!1},e.seeHelpVideo=function(){d();var t='                        <div class="guide-video dot-guide-video" style="z-index:1000000001">                             <span class="video-close bdp-icon removeVideo" title="关闭">                                 <i class="bdp-icon ico-cancel-white"></i>                              </span>                             <video class="slow-in" id="guide_video" src="'+e.dotGuideData[e.guideItem].videoSrc+'" controls="controls"></video>                         </div>                    ';$("body").append(t),$(".removeVideo").off("click.removeDotVideo").on("click.removeDotVideo",function(e){e.preventDefault(),$(".dot-guide-video").remove(),$(".removeVideo").off("click.removeDotVideo")})},e.iKnowClick=function(){d()}}}}]).filter("toSce",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).factory("dotGuide",["$rootScope",function(){var e={data_source:{dataProcess:{videoSrc:"/pmresources/dotGuideVideo/dataProcess.mp4",tooltipText:"数据处理，包含多表关联、追加合并、SQL建表等多种数据处理方式，用于对已有工作表进行加工和建模。",paramVal:"table_guide",guideNum:1,nextGuideNum:2},addWbField:{videoSrc:"/pmresources/dotGuideVideo/addWbField.mp4",tooltipText:"工作表计算字段，即用函数创建一个新字段。",paramVal:"table_guide",guideNum:2,nextGuideNum:3},replace:{videoSrc:"/pmresources/dotGuideVideo/replace.mp4",tooltipText:"替换数据是指替换工作表中全部或部分数据记录。替换工作表数据后，所有用这张工作表做的图表，数据也会自动更新，无需重复做图。",paramVal:"table_guide",guideNum:3,nextGuideNum:4},append:{videoSrc:"/pmresources/dotGuideVideo/append.mp4",tooltipText:"追加数据是指往已有的工作表上追加数据记录行。追加成功后，所有用这张工作表做的图表，数据也会自动更新，无需重复做图。",paramVal:"table_guide",guideNum:4,nextGuideNum:5},worktablEidt:{videoSrc:null,tooltipText:"鼠标滑过工作表时，右侧会出现更多<i class='bdp-icon ico-more'></i>按钮，点击可对工作表进行编辑、删除等操作。",paramVal:"table_guide",guideNum:5,nextGuideNum:0}},chart_edit:{drillChart:{videoSrc:"/pmresources/dotGuideVideo/drillChart.mp4",tooltipText:"维度支持钻取，可用于在同一张图表上逐层向下查看数据，如省—市—区的数据。",paramVal:"chart_guide",guideNum:1,nextGuideNum:2},biaxialDiagram:{videoSrc:"/pmresources/dotGuideVideo/biaxialDiagram.mp4",tooltipText:"添加另一个Y轴，可使用双轴图展示数据。",paramVal:"chart_guide",guideNum:2,nextGuideNum:3},advancedComputing:{videoSrc:null,tooltipText:null,paramVal:"chart_guide",guideNum:4,nextGuideNum:5},addChartField:{videoSrc:"/pmresources/dotGuideVideo/addChartField.mp4",tooltipText:"计算字段即用函数创建一个新的字段用来做图，分组字段即把某个已有字段按一定规律进行分组。",paramVal:"chart_guide",guideNum:3,nextGuideNum:4},sort:{videoSrc:null,tooltipText:null,paramVal:"chart_guide",guideNum:5,nextGuideNum:0}},dash_edit:{design:{videoSrc:null,tooltipText:"点击“图文模式”，不仅可以在仪表盘添加文本框，还可以对图表的图例、数值标签等显示效果进行设置，让仪表盘更加图文并茂。",paramVal:"dashboard_guide",guideNum:2,nextGuideNum:3},dashEdit:{videoSrc:null,tooltipText:"鼠标滑过图表时，右上角会出现更多<i class='bdp-icon ico-more'></i>按钮，点击可对图表进行导出图片、导出excel、删除图表等操作。",paramVal:"dashboard_guide",guideNum:1,nextGuideNum:2},share:{videoSrc:"/pmresources/dotGuideVideo/share.mp4",tooltipText:"通过分享功能，可以把当前做好的数据仪表盘分享给工作伙伴。",paramVal:"dashboard_guide",guideNum:3,nextGuideNum:0}}};return e}]).directive("tplLibraryGuide",["$rootScope","commonService","$timeout",function(e,t,i){return{restrict:"A",replace:!1,templateUrl:"/static/js/user-guide/new-version/template_page.html",scope:{veilEle:"@",stepNum:"="},link:function(a){{var o={step1:"点击替换模板数据，可以将模板数据表替换成你的数据，替换完成后仪表盘将按照你的数据进行更新。还可以点击此处的下拉按钮，下载模板数据哦~",step2:"替换数据用于将你的最新数据替换当前表的全部或部数据。上传你的新表--设置新表与原表字段之间的对应关系--替换数据成功，使用该表做的仪表盘图表将按照最新的数据即时更新。"};userGuideFlags.get("tplLibrary")}0==a.stepNum&&$(".J-use-tpl").on("click.tplLibraryGuide0",function(){a.tplLibraryNext(),$(this).off("click.tplLibraryGuide0")}),1==a.stepNum&&i(function(){$("."+a.veilEle)[0]&&(window.bdpGuideVeil.creatVeil(a.veilEle,{mask:!1,deviation:{top:0,right:-8,bottom:0,left:0}}).creatTips(o["step"+a.stepNum],a.tplLibraryNext),$("."+a.veilEle).on("click.tplLibraryGuide1",function(){a.tplLibraryNext(),$(this).off("click.tplLibraryGuide1")}))},0,!1),2==a.stepNum&&i(function(){$("."+a.veilEle)[0]&&(window.bdpGuideVeil.creatVeil(a.veilEle,{mask:!1,deviation:{top:-8,right:8,bottom:8,left:-8}}).creatTips(o["step"+a.stepNum],a.tplLibraryNext),$("."+a.veilEle).on("click.tplLibraryGuide2",function(){a.tplLibraryNext(),$(this).off("click.tplLibraryGuide2")}))},0,!1),a.$on("$destroy",function(){window.bdpGuideVeil.remove()}),a.tplLibraryNext=function(){window.bdpGuideVeil.remove(),e.tplLibraryGuide+=1;var i=userGuideFlags.set("tplLibrary",e.tplLibraryGuide);t.guide.guideSet({guide:i}).then(function(e){return 0==e.status?!0:void 0})}}}}]).directive("gisEditGuide",["$rootScope","$timeout","$translate",function(e,t,i){return{restrict:"A",replace:!1,scope:{veilEle:"@",stepNum:"="},link:function(a){var o=[{tips:i.instant("chart.modifyWorksheetTip"),deviation:{top:-2,right:2,bottom:2,left:-2},tipsOptions:{direction:"bottom",tipsDeviation:-12}},{tips:i.instant("chart.trajctoryLayerTip"),deviation:{top:0,right:48,bottom:0,left:0}},{tips:i.instant("chart.timeAnimationTip"),deviation:{top:10,right:-10,bottom:-10,left:-10},tipsOptions:{direction:"bottom",tipsDeviation:135}}],d=o[a.stepNum];t(function(){window.bdpGuideVeil.creatVeil(a.veilEle,{mask:!0,deviation:d.deviation}).creatTips(d.tips,a.nextStep,d.tipsOptions),$("."+a.veilEle).one("click.gisEditGuide",function(){a.nextStep()})},0,!1),a.$on("$destroy",function(){window.bdpGuideVeil.remove()}),a.nextStep=function(){window.bdpGuideVeil.remove(),e.gisEditGuide+=1,e.$$phase||e.$apply()}}}}]).directive("chartTemplateGuide",["$rootScope","$http",function(e,t){return{restrict:"E",templateUrl:"/static/js/user-guide/chart-template-guide.html",link:function(e,i,a){e.guide=userGuideFlags.get("ctpl"),e.view=a.view,e.nextStep=function(i){i=i||1,e.guide+=i;var a=userGuideFlags.set("ctpl",e.guide);t.post("/api/user/guide_set",{guide:a}).success(function(e){return 0==e.status?!0:void errorHandle(e)})}}}}]).directive("guideNavigator",["$rootScope","$timeout","$jsTipTranslate",function(e,t){return{restrict:"A",templateUrl:"/static/js/user-guide/guide_navigator.html",replace:!0,link:function(e){var t=$("body")[0].getBoundingClientRect(),i=$(".highcharts-navigator")[0].getBoundingClientRect(),a=$(".canSetNavigator")[0].getBoundingClientRect(),o=$(".canSetNavigator").nextAll(),d=0;$.each(o,function(e){d+=o[e].clientHeight}),e.bodyDomWidth=t.width,e.bodyDomHeight=t.height,e.borderTop=i.bottom-i.height-10,e.borderRight=t.width-i.right-32,e.borderBottom=t.height-i.bottom-10,e.borderLeft=i.left-32,e.tipTop=i.bottom-i.height-10-90-20,e.tipLeft=i.left+i.width/2-129,e.borderTop2=t.height-d-50,e.borderRight2=t.width-a.right+32,e.borderBottom2=d+5,e.borderLeft2=a.left-4,e.tipTop2=e.borderTop2-14,e.tipRight2=a.width+32},controller:["$rootScope","$scope","$timeout","$jsTipTranslate",function(e,i,a,o){t(function(){i.maskStyle={width:i.bodyDomWidth+"px",height:i.bodyDomHeight+"px","border-style":"solid","border-width":i.borderTop+"px "+i.borderRight+"px "+i.borderBottom+"px "+i.borderLeft+"px "},i.naviTipStyle={top:i.tipTop+"px",left:i.tipLeft+"px"},i.maskStyle2={position:"fixed",left:"0px",top:"0px",width:i.bodyDomWidth+"px",height:i.bodyDomHeight+"px","border-style":"solid","border-width":i.borderTop2+"px "+i.borderRight2+"px "+i.borderBottom2+"px "+i.borderLeft2+"px"},i.naviTipStyle2={top:i.tipTop2+"px",right:i.tipRight2+"px"}},0),i.isStepOne=!0,i.isStepTwo=!1,i.naviGo=function(){t(function(){var e=1e5;$(".chart-right").scrollTop(e)},0),i.isStepOne=!1,i.isStepTwo=!0},i.closeGuide=function(){i.isStepTwo=!1,window.localStorage.setItem("hasUseNavigator",1)},t(function(){i.closeGuide()},5e3),o(["chart.guideNavigatorStepOne","chart.goOn","chart.guideNavigatorStepTwo","chart.gotIt"],i)}]}}]);
;!function(){function t(t,a,e,n,r,i){function o(t){function o(a){for(var e=t.info[a],n=0;n<e.length;n++){if(""===e[n].name)return alert(t.tips["granularity.nullNameCheck"]),!1;for(var r=n+1;r<e.length;r++)if(e[n].name===e[r].name)return alert(t.tips["granularity.duplicatedNameCheck"]+'"'+e[r].name+'"'),!1}return!0}function l(t){for(var a in t)t.hasOwnProperty(a)&&t[a].map(function(t){delete t.endDateInfo,delete t.granularityMap,delete t.granularityMapDay});return t}var u;t.selected="year",t.granularityMap={month:[1,2,3,4,5,6,7,8,9,10,11,12],day:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31],day_of_week:[1,2,3,4,5,6,7]},t.updateDay=function(t){{var a=t.month;t.day}t.granularityMapDay=2==a?[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28]:[4,6,9,11].indexOf(a)>-1?[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30]:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31]},"chart_edit"==a.view&&n.post("/api/date_granularity/list",{tb_id:t.tbId}).then(function(a){0==a.status&&(t.info=a.result,t.getInitialData=!1,u=angular.copy(a.result))}),t.setting={open:function(){t.preCloseDialog=!1,t.getInitialData=!t.info,e.open({template:"/static/js/date-granularity/set_modal.html",className:"ngdialog-theme-default global-filter-model granularity-modal",scope:t,preCloseCallback:function(){if(t.preCloseDialog)return!0;var a=l(u),n=l(angular.copy(t.info));if(angular.toJson(a)!==angular.toJson(n)){var r=e.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:t.tips["chart.notSave"],okClick:function(){}}});return r.then(function(){return t.info=angular.copy(u),!0})}}})},getInfo:function(a){return setTimeout(function(){$(".date-granularity-rule-list").scrollTop(0)},0),o(t.selected)?void(t.selected=a):!1},add:function(a){if(t.info[a].length>9)return void r(t.tips["granularity.tooMuchRules"]);var e={name:""};switch(a){case"year":e.month=1,e.day=1;break;case"month":e.day=1;break;case"week":e.day_of_week=1}t.info[a].push(e),scrollToBottom($(".date-granularity-rule-list"))},del:function(a,e){t.info[a].splice(e,1)},modify:function(){if(t.preCloseDialog=!0,t.preCloseDialogSure=!0,!o(t.selected))return!1;t.info=l(t.info);var a=!1;for(var i in t.info)t.info[i].length>10&&(a=!0);return a?void r(t.tips["granularity.tooMuchRules"]):void n.post("/api/date_granularity/commit",{tb_id:t.tbId,data:angular.toJson(t.info)}).then(function(a){0==a.status&&(u=angular.copy(t.info),e.closeAll())})},reset:function(){t.info=angular.copy(u)}},i(["chart.notSave","granularity.nullNameCheck","granularity.duplicatedNameCheck","granularity.tooMuchRules"],t)}return{restrict:"A",templateUrl:"/static/js/date-granularity/granularity.html",scope:{tbId:"=",field:"=",axis:"=",setGranularity:"="},link:o}}angular.module("BC.directives").directive("dateGranularity",t),t.$inject=["$timeout","$rootScope","ngDialog","commonHttp","errHint","$jsTipTranslate","granularityMap"]}();
;!function(){function t(){function t(){}return{restrict:"A",templateUrl:"/static/partials/directiveTemplates/stringDataShowType.html",scope:{tbId:"=",field:"=",axis:"=",setDataShowType:"="},link:t}}angular.module("BC.directives").directive("stringDataShowType",t),t.$inject=["$timeout","ngDialog","commonHttp","errHint","$jsTipTranslate","dataShowTypeMap"]}();
;!function(){function e(e){function a(a,i,t){a.axis=t.axis,a.meta=a.chart_ops.meta.level[a.drill_level],a.setAxisSort=function(e,i,t,n){t.show_formula=!1;{var r,s=a.chart_ops.meta.level[a.drill_level];s.tb_statistic&&s.tb_statistic.row_setting}"x"===n?r=s.x[e]:"compare_axis"===n&&(r=s.compare_axis[e]),"x"===n?(s.sort={fid:r.fid,axis:"x",uniq_id:r.uniq_id,type:i},s.is_advanced_sort=0):"compare_axis"===n&&(s.compare_axis[e].compare_sort={fid:r.fid,axis:"compare_axis",uniq_id:r.uniq_id,type:i}),a.saveChartImmediate()},a.canSetSort=function(){var e=["C200","C210","C211","C212","C220","C240","C241","C242","C250","C261","C290","C310","C330","C350","C351","C352","C320"],i=a.chart_ops.meta.chart_type||(a.chart_ops.meta.level[a.drill_level]?a.chart_ops.meta.level[a.drill_level].chart_type:"");return e.indexOf(i)>-1},a.setAlignmentMethod=function(e,i){var t=$(e.target).parents(".data-tag").parent().index(),n=a.chart_ops.meta.level[a.drill_level],r=n.x[t],s="alignment_method";r[s]=i,a.saveChartImmediate()},a.setNickName=function(i){var t=$(i.target).parents(".data-tag").parent().index(),n=a.is_gis?a.viewData.currentLayer:a.chart_ops.meta.level[a.drill_level],r=angular.copy(n.x[t]);e.open({template:"/static/partials/dialogTemplates/nick_name.html",className:"ngdialog-theme-default nick-model",data:{origin_name:r.nick_name,field_index:t,field:r,dimension:"dimension",save:a.saveNickName}})},a.saveNickName=function(e,i){var t=a.is_gis?a.viewData.currentLayer:a.chart_ops.meta.level[a.drill_level],n=t.tb_statistic&&t.tb_statistic.row_setting,r=t.x[i],s=r.fid,l=r.uniq_id;if(r.nick_name=e.nick_name,r.description=e.description,"row_summary"==s&&(n.nick_name=e.nick_name,n.description=e.description),t.advanced_sort&&t.advanced_sort.length>0)for(var c=0,o=t.advanced_sort.length;o>c;c++){var m=t.advanced_sort[c],d=m.fid,_=m.uniq_id,p=!1,v=m.axis;if("x"==v)if(l){if(_===l){p=!0,m.name=r.nick_name||m.originName;break}}else if(s=d){p=!0,m.name=r.nick_name||m.originName;break}}a.saveChartImmediate()}}return{restrict:"A",templateUrl:"/static/partials/directiveTemplates/dimensionCompareSort.html",scope:!0,link:a}}angular.module("BC.directives").directive("dimensionCompareSort",e),e.$inject=["ngDialog","commonService","errHint","$jsTipTranslate"]}();
;angular.module("BC.directives").directive("personalBroadcast",["commonService","$rootScope",function(e,n){return{restrict:"A",templateUrl:"/static/js/common/tpl/notice_broadcast.html",replace:!1,scope:!0,link:function(o){function r(){var n={new_version:0};e.guide.guideSet(n).then(function(e){return 0==e.status?!0:(errorHandle(e),!1)})}o.closeBroadcast=function(){n.personalInfo.new_version=!1,r()},o.toLearn=function(){window.open("./#/member"),n.personalInfo.new_version=!1,r()}}}}]);
;!function(){function t(){return{restrict:"A",scope:{show:"="},templateUrl:"/static/partials/directiveTemplates/ksturl_tip.html",link:function(t){t.hideLayer=function(){t.show=!1}}}}function i(){return{restrict:"A",scope:{show:"="},templateUrl:"/static/database/view/baidustatistics_tip.html",link:function(t){t.hideLayer=function(){t.show=!1}}}}angular.module("BC.directives").directive("ksturlTip",t).directive("baidustatisticsTip",i),t.$inject=["$rootScope"],i.$inject=["$rootScope"]}();
;angular.module("BC.directives").directive("pagination",["commonService","errHint","$jsTipTranslate",function(a,t,e){return{restrict:"A",templateUrl:"/static/partials/directiveTemplates/pagination.html",scope:{currPage:"=",totalPage:"=",onCommit:"&"},link:function(a){a.pageListPos=function(a){var t=$(a.target).offset(),e=$(window).height(),i=30;e-t.top<110&&(i=-80),$(".page-list").css({top:i}),a.stopPropagation()},a.goToFirstPage=function(){1==a.currPage?t(a.tips["pagination.isAlreadyFirstPage"]):(a.currPage=1,a.onCommit({page:a.currPage}))},a.goToLastPage=function(){a.currPage==a.totalPage?t(a.tips["pagination.isAlreadyLastPage"]):(a.currPage=a.totalPage,a.onCommit({page:a.currPage}))},a.goToPrevPage=function(){1==a.currPage?t(a.tips["pagination.isAlreadyFirstPage"]):(a.currPage--,a.onCommit({page:a.currPage}))},a.goToNextPage=function(){a.currPage==a.totalPage?t(a.tips["pagination.isAlreadyLastPage"]):(a.currPage++,a.onCommit({page:a.currPage}))},e(["pagination.isAlreadyFirstPage","pagination.isAlreadyLastPage"],a)}}}]);
;!function(){angular.module("bdp.charts").directive("markPoint",function(){return{link:function(t){t.addMarkPoint=function(){t.checkYAxisUniqId().then(function(){t.inAddingMarkPoint=!0,setTimeout(function(){$(document).on("click.cancelMarkPoint",function(){t.endAddMarkPoint(),t.$$phase||t.$apply()});var n=$(".chart-args").height(),o=$(".chart-left").width()+$(".chart-left-side").width()+10;$(".add-point-mask .mask-top").css({height:n,lineHeight:n+"px"}),$(".add-point-mask .mask-left").css({width:o})},0)})},t.endAddMarkPoint=function(){t.inAddingMarkPoint=!1,$(document).off("click.cancelMarkPoint")}},controller:["$scope","$q","commonService","ngDialog",function(t,n,o,e){var i=!1;t.checkYAxisUniqId=function(){var o=n.defer();if(i)o.resolve();else{var e=t.chart_ops.meta.level[t.drill_level],a=e.y[0]||e.y_optional[0];if(a&&!a.uniq_id){var r=+new Date;angular.forEach(e.y,function(t){t.uniq_id=r++}),angular.forEach(e.y_optional,function(t){t.uniq_id=r++}),t.saveChartImmediate().then(o.resolve,o.reject)}else o.resolve()}return i=!0,o.promise},t.editMarkPoint=function(n,o,i){i&&i.stopPropagation(),e.open({template:"/static/partials/dialogTemplates/mark_point_model.html",className:"ngdialog-theme-default ngdialog-small",scope:t,data:{point:angular.extend({},n,{ct_id:o}),type:"modify"},controller:"EditMarkPointCtrl"})},t.removeMarkPoint=function(n,e){return o.fieldComment.del(n,e.fc_id).then(function(){t.saveChartImmediate()})},t.removeMarkPointById=function(n,e,i){return i.stopPropagation(),o.fieldComment.del(n,e).then(function(){t.saveChartImmediate()})},t.markPoint_conf=[],t.show_makePoint_model=function(n){t.$broadcast("displayMarkPointModel",n)}}]}}).directive("chartMarkPoints",function(){return{replace:!0,templateUrl:"/static/js/dashboard/tpl/markPointTooltip.html",link:function(t){t.setTooltipPos=function(n,o){o.show=!0,o.popover={},o.popover.pos=o.pos.top<15||"edit"===t.mode&&o.pos.top<40?"bottom":"top"}}}})}();
;!function(){"use strict";function e(e,o){function r(t,r){function i(){e.role;o(function(){var e=$(r[0]).find("ul"),t=$(r[0]).find(".ico-more").offset(),o={},i=e.height(),n=$(window).height();o.left=t.left-80,o.top=i+t.top+24>n?t.top-i-24:t.top+24,e.css({top:o.top,left:o.left,visibility:"visible"})},0)}var n=t.operate;t.toggleList=function(){n.show=!n.show,n.show&&i()},t.$watch("operate.show",function(e,r){var i=".side-menu-list",n="scroll.userOperate";if(e!==r&&1==e){var l=angular.element(i).scrollTop();o(function(){angular.element(i).on(n,function(e){Math.abs(l-$(e.target).scrollTop())>8&&(t.operate.show=!1,t.$digest())})},0)}else e!==r&&0==e&&angular.element(i).off(n)})}var i={templateUrl:"/static/user/operate/user_operate.html",restrict:"EA",replace:!0,link:r,controller:t};return i}function t(e){e.operate={}}angular.module("BC.directives").directive("userOperate",["$rootScope","$timeout",e]),t.$inject=["$scope"]}();
;!function(){function e(e,t,o){function i(e,t){function i(){var t=e.query.val,i=0;if(t){n(t,e.folderList);for(var a=0,l=e.folderList.length;l>a;a++)if(!e.folderList[a].hide){i=a;break}}else r();angular.forEach(e.folderList,function(o){o.hide||(e.hideAll=!1),angular.forEach(o.sub_folders,function(e){e.hit_top=!1,o.name.toLowerCase().indexOf(t.toLowerCase())>-1&&(e.hit_top=!o.hide),angular.forEach(e.tb_list,function(i){i.hit_top=!1,o.name.toLowerCase().indexOf(t.toLowerCase())>-1?i.hit_top=!o.hide:e.name.toLowerCase().indexOf(t.toLowerCase())>-1&&(i.hit_top=!e.hide)})}),angular.forEach(o.tb_list,function(e){e.hit_top=!1,o.name.toLowerCase().indexOf(t.toLowerCase())>-1&&(e.hit_top=!o.hide)})}),e.$apply(),o(function(){e.folderList.length>0&&e.initFolder({index:i})},10)}function n(e,t){function o(t){function i(t){var o=0;return t.map(function(t){t.name.toLocaleLowerCase().indexOf(e.toLocaleLowerCase())>-1?(t.hide=!1,o++):t.hide=!0}),0==o}function n(e){if(0==e.length)return!0;var t=0;return e.map(function(e){e.hide&&t++}),t==e.length}if(t.name.toLowerCase().indexOf(e.toLowerCase())>-1)return void(t.hide=!1);t.sub_folders&&t.sub_folders.length>0&&t.sub_folders.map(o);var r=i(t.tb_list);if(r){if(!t.sub_folders||0==t.sub_folders.length)return void(t.hide=r);t.hide=n(t.sub_folders)?!0:!1}else t.hide=r}t.map(o)}function r(){function t(e){e.hide=!1}function o(e){e.hide=!1,e.sub_folders&&e.sub_folders.length>0&&e.sub_folders.map(o),e.tb_list&&e.tb_list.length>0&&e.tb_list.map(t)}e.folderList.map(o)}var a=null;e.query={},e.hideAll=!1,angular.element(t).on("keyup.searchTable",function(t){clearTimeout(a),e.query.val=t.target.value,a=setTimeout(i,100)})}return{restrict:"A",link:i,scope:{folderList:"=",initFolder:"&"}}}angular.module("BC.directives").directive("userSearchWb",e),e.$inject=["$rootScope","$filter","$timeout"]}();
;!function(){function t(){function t(t){function e(){function e(){function t(t){var e=[];return t.map(function(t){var i=$.inArray(t.tb_id,s);if(i>-1){var o=r[i];e.push({tb_type:t.tb_type,type:t.type,name:o.name,sh_id:o.sh_id,tb_id:o.tb_id,filter:o.filter})}}),e}function e(i,r,s){i.tb_list=t(i.tb_list),i.sub_folders&&i.sub_folders.length>0&&o(i.sub_folders,e),0!=i.tb_list.length||i.sub_folders&&0!=i.sub_folders.length||s.splice(r,1)}var o=bdp.utils.descMap;return o(i,e),i}if(t.folderList&&t.wbList){var i=angular.copy(t.folderList),r=t.wbList,s=[];r.map(function(t){s.push(t.tb_id)}),t.data.sharedFolderList=e(),t.setCurFolder(0)}}t.curFolder={},t.curFolderItem=null,t.data={},t.$watch("folderList",function(t){t&&e()}),t.$watch("wbList",function(t){t&&e()}),t.openFolder=function(e,i){t.setCurFolder(e,i)},t.setCurFolder=function(e,i){var r=t.curFolder;r.index=e,r.subIndex=i;var s;s=void 0===i?t.data.sharedFolderList[e]:t.data.sharedFolderList[e].sub_folders[i],t.curFolderItem=s}}return{restrict:"A",templateUrl:"/static/user/wb/user_wb.html",link:t,scope:{wbList:"=",folderList:"="}}}function e(t,e){function i(t){function i(){function e(){function t(i,r,s){i.sub_folders&&e(i.sub_folders,t),0!=i.tb_list.length||i.sub_folders&&0!=i.sub_folders.length||s.splice(r,1)}var e=bdp.utils.descMap;e(r,t)}function i(){function t(t){t.map(function(t){var e=$.inArray(t.tb_id,o);if(e>-1){var i=s[e];t.sh_id=i.sh_id,t.filter=i.filter,t.choose=!0}})}function e(i){t(i.tb_list),i.sub_folders&&i.sub_folders.length>0&&i.sub_folders.map(e)}r.map(e)}if(t.folderList&&t.wbList){var r=angular.copy(t.folderList),s=t.wbList,o=[];s.map(function(t){o.push(t.tb_id)}),i(),t.data.sharedList=t.sharedList=r,t.setCurFolder(0),e(),bdp.bdpTables.initFolderListChoose(t.data.sharedList)}}function r(e,i){function r(t,e){e.map(function(e){e.choose=t})}var s,o=[];o=void 0===i?t.data.sharedList[e]:t.data.sharedList[e].sub_folders[i],s=o.choose,o.className="",r(s,o.tb_list),void 0===i&&o.sub_folders&&o.sub_folders.length>0&&o.sub_folders.map(function(t){t.choose=s,r(s,t.tb_list)}),bdp.bdpTables.initFolderListChoose(t.data.sharedList,e)}t.curFolder={},t.curFolderItem=null,t.data={},t.$watch("folderList",function(t){t&&i()}),t.$watch("wbList",function(t){t&&i()}),t.openFolder=function(e,i){t.setCurFolder(e,i)},t.setCurFolder=function(e,i){var r=t.curFolder;r.index=e,r.subIndex=i;var s;s=void 0===i?t.data.sharedList[e]:t.data.sharedList[e].sub_folders[i],t.curFolderItem=s},t.checkAll=function(t,e){r(t,e)},t.checkone=function(e){bdp.bdpTables.initFolderListChoose(t.data.sharedList,e)},t.editWorktableFilter=function(i){i.filter=i.filter||{},e.open({template:"/static/partials/dialogTemplates/worktable-filter.html",scope:t,data:{editTbModel:i},className:"ngdialog-theme-default ngdialog-worktable-filter",controller:"WorktableFilterCtrl"})}}return{restrict:"A",templateUrl:"/static/user/wb/user_modify_wb.html",link:i,scope:{wbList:"=",folderList:"=",sharedList:"="}}}angular.module("BC.directives").directive("userWb",t),t.$inject=["$rootScope"],angular.module("BC.directives").directive("userModifyWb",e),e.$inject=["$rootScope","ngDialog"]}();
;!function(){angular.module("BC.directives").directive("socialShare",["ngDialog","$q","shareService","$window","$rootScope",function(e,t,n,r,a){return{scope:!0,link:function(o){o.sharePlatform=[{name:"tsina",text:"新浪微博"},{name:"renren",text:"人人网"},{name:"qzone",text:"qq空间"},{name:"tqq",text:"腾讯微博"},{name:"douban",text:"豆瓣网"},{name:"kaixin001",text:"开心网"},{name:"tieba",text:"百度贴吧"}],o.tab={index:0},o.showShareDialog=function(){e.open({templateUrl:"/static/partials/dialogTemplates/social_share.html",className:"ngdialog-theme-default ngDialog-width-490",scope:o,preCloseCallback:function(){3==a.enterprise_type&&2==a.guide&&o.$emit("okToGuide","shareComplete")}})};var i="";o.outer_share_info&&o.outer_share_info.description&&(i=o.outer_share_info.description),o.share={description:i,descriptionOriginal:i,changeDescSuc:!1},o.shareDesc=function(){return o.sdo_id?n.modifyShareDesc(o.sdo_id,o.share.description).then(function(e){e&&(o.share.changeDescSuc=!0,o.share.descriptionOriginal=angular.copy(o.share.description))}):n.getSdoId(o.dashSelected,o.share.description).then(function(e){e?(o.share.changeDescSuc=!0,o.share.descriptionOriginal=angular.copy(o.share.description),o.outer_share_info.sdo_id=e,o.sdo_id=e,o.shareUrl=location.protocol+"//"+location.host+"/share/index.html?shareId="+e):o.shareUrl=""})},o.gotoSharePage=function(){o.shareUrl&&r.open(o.shareUrl)},o.getShareId=function(){var e=t.defer();return o.sdo_id?(e.resolve(o.sdo_id),e.promise):n.getSdoId(o.dashSelected,o.share.description).then(function(e){return e&&(o.share.descriptionOriginal=angular.copy(o.share.description),o.outer_share_info.sdo_id=e),e})},o.generateShareUrl=function(){return o.getShareId().then(function(e){return e?(o.sdo_id=e,o.shareUrl=location.protocol+"//"+location.host+"/share/index.html?shareId="+e):o.shareUrl="",o.shareUrl})};var s={type:"text",pic:[location.origin+"/static/images/bdp-dashboard-overview.png",location.origin+"/static/images/login_logo.png"],title:encodeURIComponent("我在 #BDP# 制作了一个酷炫的数据仪表盘，里面全都是数据干货，快来点击围观！"),desc:"BDP",sign:"off",searchPic:0,relateUid:0};o.shareDashboardTo=function(e,t){return o.generateShareUrl().then(function(n){n||alert("获取分享链接失败");var a=angular.extend({},s,{to:e,url:n,product:"BDP",title:encodeURIComponent("我在 #BDP# 制作了一个酷炫的数据仪表盘“"+t+"”，里面全都是数据干货，快来点击围观！")}),o="http://share.baidu.com/s?",i=[];for(var c in a)if(a.hasOwnProperty(c))if("pic"==c&&angular.isArray(a[c])){var d;d="tsina"==e?a[c].join("||"):a[c][0],i.push(c+"="+d)}else i.push(c+"="+a[c]);o+=i.join("&"),r.open(o)})},o.shareToWeChat=function(e){return o.generateShareUrl().then(function(t){var n=e.target,r=$('<div class="share-wechat-pop"><div class="qrcode-wrap"></div><div class="foot">扫描二维码分享至微信</div><em class="arrow-left"></em></div>').appendTo("body"),a=$(n).offset();r.css({position:"absolute",zIndex:99999,top:a.top,left:a.left+$(n).width()+10}).find(".close-btn").on("click",function(){r.remove()}),r.find(".qrcode-wrap").qrcode({width:100,height:100,text:t}),$(n).on("mouseleave.showQrCode",function(){r.remove()})})},o.cancelSharePop=function(){e.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:o,data:{message:"取消此次分享？"}}).then(function(){o.cancelShare()})},o.cancelShare=function(){return o.getShareId().then(function(t){t&&n.cancelShare(t).then(function(t){0==t.data.status&&(o.clearOuterShareInfo(),delete o.sdo_id,e.closeAll())})})},o.$watch("outer_share_info.sdo_id",function(e){o.sdo_id=e,e&&(o.shareUrl=location.protocol+"//"+location.host+"/share/index.html?shareId="+o.sdo_id)})}}}]).directive("copyShareLink",["errHint","$timeout",function(e,t){return{link:function(n,r){t(function(){r.zclip({path:"/static/js/lib/jquery-ui/ZeroClipboard.swf",copy:function(){return n.shareUrl},afterCopy:function(){t(function(){e("复制成功")},0)}})},500)}}}]).factory("shareService",["$http","errHint",function(e,t){return{getSdoId:function(t,n){return e.post("/api/outer_share/generate",{dsh_id:t,description:n}).then(function(e){return 0==e.data.status?e.data.result.sdo_id:23030==e.data.status?(alert("您的描述含有敏感词"),null):null})},cancelShare:function(t){return e.get("/api/outer_share/delete?sdo_id="+t)},modifyShareDesc:function(n,r){return e.post("/api/outer_share/modify_desc",{sdo_id:n,description:r}).then(function(e){return 0==e.data.status?e.data:23030==e.data.status?(alert("您的描述含有敏感词"),null):(t(+e.data.status),null)})}}}])}();
;angular.module("BC.directives").directive("bubbleSize",function(){return{templateUrl:"/static/partials/directiveTemplates/bubbleSize.html",link:function(){},controller:"bubbleSizeCtrl"}}).controller("bubbleSizeCtrl",["$scope","ngDialog","$getCustomFormula","errHint","commonService","$jsTipTranslate",function(e,t,i,r,l,n){function a(e,t){return e.x1<t.x1+(t.x2-t.x1)/2&&t.x2-(t.x2-t.x1)/2<e.x2&&e.y1<t.y1+(t.y2-t.y1)/2&&e.y2-(t.y2-t.y1)/2<e.y2}function b(t){return e.drill_level>0?l.chart.getSizeGroups(e.ct_id,t,e.drill_level,e.drill_field,e.drill_value):l.chart.getSizeGroups(e.ct_id,t)}function u(e,t,i){var r=2;if(2>e)return[t[1]+r];for(var l=d3.scale.linear().domain([1,e]).range(t),n=[],a=0;e>a;a++)n.push(Math.round(l(a+1))+r);return i?n.reverse():n}e.$watch("chart_ops.meta.level[drill_level]",function(t){e.currentMeta=t,t.bubble_setting&&(e.bubbleSetting=t.bubble_setting)}),e.onDrop=function(){var t=e.dragField,i=e.currentMeta.y.concat(e.currentMeta.y_scatter||[]);if(0==i.length)return r(e.tips["chart.dragFieldToAxis"]),!1;if("date"==t.data_type)return void r(e.tips["chart.canNotSetOnDate"]);for(var l=0;l<i.length;l++)if(!i[l].aggregator&&1!=i[l].is_build_aggregated&&(1==t.is_build_aggregated||"number"!=t.data_type))return void r(e.tips["chart.invalidSetting"]);var n=e.initFormula(t,e.currentMeta);e.bubbleSetting={fid:t.fid,field:t,aggregator:n.defaults,size_range:[3,8]},e.showBubbleSettingDialog()},e.$on("onDropToSize",function(t,i){e.onDrop(i.dropEvent,i.ui)}),e.$watch("bubble_size_groups",function(t){t&&t.length&&(e.size_groups=t,e.bubble_size_preview=u(t.length,e.bubbleSetting.size_range,e.bubbleSetting.reverse))}),e.initFormula=function(e,t){if(1==e.is_build_aggregated)return{defaults:"",formulaList:[]};var r=t.y.concat(t.y_scatter||[]);if("number"==e.data_type){for(var l=0;l<r.length;l++)if(r[l].aggregator||1==r[l].is_build_aggregated)return{defaults:"SUM",formulaList:i(["SUM","AVG","MAX","MIN","COUNT","COUNT_DISTINCT"])};return{defaults:"",formulaList:[]}}return{defaults:"COUNT",formulaList:i(["COUNT","COUNT_DISTINCT"])}},e.startDrag=function(){angular.element(".chart-left-side,.chart-main").css({overflow:"visible"})},e.removePosition=function(){angular.element(".scatter-bubble-layer").css({overflow:"visible"})},e.del=function(t,i){angular.element(".scatter-bubble-layer,.chart-left-side,.chart-main").css({overflow:""});var r=i.helper.position(),l=$(".scatter-bubble-layer"),n={width:l.width(),height:l.height()},b={width:i.helper.width(),height:i.helper.height()},u=a({x1:0,y1:0,x2:n.width,y2:n.height},{x1:r.left,y1:r.top,x2:b.width+r.left,y2:b.height+r.top});return u?void i.helper.css({left:0,top:0}):(delete e.bubbleSetting,delete e.currentMeta.bubble_setting,delete e.size_groups,e.saveChartImmediate(),void t.stopPropagation())},e.clickPanel=function(){e.showColorSettingModalByField()},e.showBubbleSettingDialog=function(){t.open({className:"ngdialog-theme-default ngdialog-bubble-setting",templateUrl:"/static/partials/dialogTemplates/bubble_size_setting.html",scope:e,controller:["$scope",function(e){b(e.bubbleSetting).then(function(t){t&&(e.size_groups=t.bubble_size_groups,e.bubble_size_preview=u(e.size_groups.length,e.bubbleSetting.size_range,e.bubbleSetting.reverse))}),e.changeAggr=function(){b(e.bubbleSetting).then(function(t){t&&(e.size_groups=t.bubble_size_groups,e.bubble_size_preview=u(e.size_groups.length,e.bubbleSetting.size_range,e.bubbleSetting.reverse))})},e.formulaList=e.initFormula(e.bubbleSetting.field,e.currentMeta).formulaList,e.toggleReverse=function(){e.bubble_size_preview=u(e.size_groups.length,e.bubbleSetting.size_range,e.bubbleSetting.reverse)},e.$watch("bubbleSetting.size_range",function(t){t&&e.size_groups&&(e.bubble_size_preview=u(e.size_groups.length,e.bubbleSetting.size_range,e.bubbleSetting.reverse))},!0)}]})},e.confirm=function(){e.currentMeta.bubble_setting=e.bubbleSetting,e.saveChartImmediate()},e.clickPanel=e.showBubbleSettingDialog,n(["chart.dragFieldToAxis","chart.canNotSetOnDate","chart.invalidSetting"],e)}]);
;angular.module("BC.directives").directive("gisBubbleSize",function(){return{templateUrl:"/static/partials/directiveTemplates/bubbleSize.html",link:function(){},controller:"gisBubbleSizeCtrl"}}).controller("gisBubbleSizeCtrl",["$scope","ngDialog","$getCustomFormula","errHint","commonService",function(e,t,i,r,n){function l(e,t){return e.x1<t.x1+(t.x2-t.x1)/2&&t.x2-(t.x2-t.x1)/2<e.x2&&e.y1<t.y1+(t.y2-t.y1)/2&&e.y2-(t.y2-t.y1)/2<e.y2}function a(t){return n.chart.getGisSizeGroups(e.chartId,t,e.currentLayerIndex)}function b(e,t,i){var r=2;if(2>e)return[t[1]+r];for(var n=d3.scale.linear().domain([1,e]).range(t),l=[],a=0;e>a;a++)l.push(Math.round(n(a+1))+r);return i?l.reverse():l}e.$watch("chart_ops.meta.layers[currentLayerIndex]",function(t){e.currentMeta=t,t&&t.bubble_setting&&(e.bubbleSetting=t.bubble_setting)}),e.onDrop=function(){var t=e.dragField;if("date"==t.data_type)return void r("不能对日期字段进行尺寸设置");if("1"==t.is_build_aggregated&&"string"==t.data_type)return void r("不能对文本类型的聚合字段进行尺寸设置");var i=e.initFormula(t,e.currentMeta);e.bubbleSetting={fid:t.fid,field:t,aggregator:i.defaults,size_range:[3,8]},e.showBubbleSettingDialog()},e.$on("onDropToSize",function(t,i){e.onDrop(i.dropEvent,i.ui)}),e.$watch("bubble_size_groups",function(t){t&&t.length&&(e.size_groups=t,e.bubble_size_preview=b(t.length,e.bubbleSetting.size_range,e.bubbleSetting.reverse))}),e.initFormula=function(e,t){if(1==e.is_build_aggregated)return{defaults:"",formulaList:[]};var r=t.y;return"number"==e.data_type?r[0]&&r[0].aggregator?{defaults:"SUM",formulaList:i(["SUM","AVG","MAX","MIN","COUNT","COUNT_DISTINCT"])}:{defaults:"",formulaList:[]}:{defaults:"COUNT",formulaList:i(["COUNT","COUNT_DISTINCT"])}},e.startDrag=function(){angular.element(".chart-left-side,.gis-main").css({overflow:"visible"})},e.removePosition=function(){angular.element(".scatter-bubble-layer").css({overflow:"visible"})},e.del=function(t,i){angular.element(".scatter-bubble-layer,.chart-left-side,.gis-main").css({overflow:""});var r=i.helper.position(),n=$(".scatter-bubble-layer"),a={width:n.width(),height:n.height()},b={width:i.helper.width(),height:i.helper.height()},u=l({x1:0,y1:0,x2:a.width,y2:a.height},{x1:r.left,y1:r.top,x2:b.width+r.left,y2:b.height+r.top});return u?void i.helper.css({left:0,top:0}):(delete e.bubbleSetting,delete e.currentMeta.bubble_setting,delete e.size_groups,e.saveChartImmediate(),void t.stopPropagation())},e.clickPanel=function(){e.showColorSettingModalByField()},e.showBubbleSettingDialog=function(){t.open({className:"ngdialog-theme-default ngdialog-bubble-setting",templateUrl:"/static/partials/dialogTemplates/bubble_size_setting.html",scope:e,controller:["$scope",function(e){a(e.bubbleSetting).then(function(t){t&&(e.size_groups=t.bubble_size_groups,e.bubble_size_preview=b(e.size_groups.length,e.bubbleSetting.size_range,e.bubbleSetting.reverse))}),e.changeAggr=function(){a(e.bubbleSetting).then(function(t){t&&(e.size_groups=t.bubble_size_groups,e.bubble_size_preview=b(e.size_groups.length,e.bubbleSetting.size_range,e.bubbleSetting.reverse))})},e.formulaList=e.initFormula(e.bubbleSetting.field,e.currentMeta).formulaList,e.toggleReverse=function(){e.bubble_size_preview=b(e.size_groups.length,e.bubbleSetting.size_range,e.bubbleSetting.reverse)},e.$watch("bubbleSetting.size_range",function(t){t&&e.size_groups&&(e.bubble_size_preview=b(e.size_groups.length,e.bubbleSetting.size_range,e.bubbleSetting.reverse))},!0)}]})},e.confirm=function(){var i=e.dragField;if(i&&"1"==i.is_build_aggregated&&"number"==i.data_type)for(var r=e.viewData.currentLayer,n=0;n<r.y.length;n++)2==r.y[n].is_build_aggregated||0==r.y[n].is_build_aggregated?r.y[n].aggregator="number"===r.y[n].data_type?"SUM":"COUNT":1==r.y[n].is_build_aggregated&&(r.y[n].aggregator="");e.currentMeta.bubble_setting=e.bubbleSetting,e.saveChartImmediate(),t.closeAll()},e.clickPanel=e.showBubbleSettingDialog}]);
;!function(){function t(){function t(t){t.data={},t.curFolder={},t.$watch("wbList",function(e){e&&(t.wbList.map(function(t){t.name||(t.name="根目录")}),t.data.wbList=t.wbList,t.setCurFolder(0))}),t.openFolder=function(e,r){t.setCurFolder(e,r)},t.setCurFolder=function(e,r){var i=t.curFolder;i.index=e,i.subIndex=r;var n;n=void 0===r?t.data.wbList[e]:t.data.wbList[e].sub_folders[r],t.curFolderItem=n}}return{restrict:"A",templateUrl:"/static/workspace/wb/manage_work_tables.html",link:t,scope:{wbList:"="}}}angular.module("BC.directives").directive("wpWb",t),t.$inject=[]}();
;!function(){angular.module("BC.controllers.chart.template",[]).controller("chartTemplate",["$scope","$rootScope",function(e,t){t.view="chart_template",t.show_bdp_header=!0}])}();
;!function(){angular.module("BC.controllers.chart.template.config",[]).controller("chartTemplateConfig",["$scope","$rootScope","commonHttp","errHint","$location","$timeout","ngDialog","commonService","$jsTipTranslate","$state","$translate","$q",function(t,e,a,l,i,n,r,o,p,c,d,s){function _(){t.draw_chart_url={options:{theme:1===+e.usedThemeId?"dark":"default",ct_id:t.tplInfo.ct_id,is_chart_tpl:1,optional:{}}},e.wsId&&(t.draw_chart_url.options.ws_id=e.wsId)}function f(){function e(e){angular.forEach(e,function(e){var i=e.proj_id+(e.rule_id?"$"+e.rule_id:"");a[i]=e==t.active_proj?1:void 0===l[i]?1:1&l[i]})}var a={},l=localStorage.getItem("project_folding");try{l=angular.fromJson(l)||{}}catch(i){l={}}e(t.all_project_list),t.projFolding=a,u(a)}function u(t){t=t||{},localStorage.setItem("project_folding",angular.toJson(t))}function h(e){return o.chart_tpl_project.getTree().then(function(a){if(0==a.status){{t.all_project_list=a.result.proj_tree}f(),e&&t.tplOps.changeCurrentTpl(e),setTimeout(function(){bdp.utils.scrollToElement(".own-project-list",".project-item.active","top")},10)}})}function m(){h().then(function(){if(t.all_project_list){for(var e,a=t.all_project_list.length,l=0;a>l;){if(t.all_project_list[l].tpl_list.length){e=t.all_project_list[l].tpl_list[0];break}l++}t.tplOps.changeCurrentTpl(e.tpl_id)}})}e.view="chart_template_config",e.show_bdp_header=!1,t.tabIndex=1,t.ChartTypeGIS=bdpChart.ChartType.GIS,t.loadingState={tplInfo:!1},t.all_project_list=[],t.editState={},t.projFolding={},t.tplInfo={},t.draw_chart_url=null,t.createTpl={all_dashboard_list:[],dashStandardItems:[],selectedChart:null},t.back=function(){e.click_show_view("chart_template")},t.tplProj={createProjDialog:function(){r.open({templateUrl:"/static/chartTemplate/view/create_project.html",scope:t,className:"ngdialog-theme-default ngdialog-small"})},createProject:function(e,a){if(!e)return void l(t.tips["dash.projectNameRequired"]);for(var i=t.all_project_list||[],n=0,r=i.length;r>n;n++)if(i[n].name==e)return void l(t.tips["dash.duplicateProjectName"]);o.chart_tpl_project.create(e).then(function(t){"0"==t.status&&(a(),h())})},delProject:function(e,a,l){l&&l.stopPropagation();var i=a.proj_id,n=a.name;r.openConfirm({template:"/static/chartTemplate/view/delete_project.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:t.tips["chartTemplate.delProject"]+": "+n+" ?"}}).then(function(){o.chart_tpl_project.del(i).then(function(a){"0"==a.status&&t.all_project_list.splice(e,1)})})},setProjNameEditing:function(e,a){a.name_editing=a.name,angular.forEach(t.editState,function(e,a){t.editState[a]=!1}),t.editState[a.proj_id]=!0,n(function(){$(".list-hd > ul >li").eq(e).find(".rename-input").select().focus()},10)},isEnterKey:function(t,e){var a=t.which?t.which:event.keyCode;13===a&&this.editProject(e)},editProject:function(e){var a=e.name_editing;if(!a)return void l(t.tips["dash.projectNameRequired"]);for(var i=0,n=t.all_project_list.length;n>i;i++)if(t.all_project_list[i].name==a&&t.all_project_list[i].proj_id!=e.proj_id)return void l(t.tips["dash.duplicateProjectName"]);o.chart_tpl_project.modify(e.proj_id,a).then(function(l){0==l.status&&(e.name=a,t.editState[e.proj_id]=!1)})}},t.tplOps={selectedDashboard:null,createTplDialog:function(){return r.open({templateUrl:"/static/chartTemplate/view/create_template.html",scope:t,className:"ngdialog-theme-default create-template-dialog"}),o.project.getTree().then(function(e){if(t.createTpl.all_dashboard_list=e.proj,t.tplOps.selectedDashboard)for(var a,l=e.proj.length;l--;){for(a=e.proj[l].dsh_list.length;a--;)if(e.proj[l].dsh_list[a].dsh_id==t.tplOps.selectedDashboard.dsh_id){t.tplOps.selectedDashboard=e.proj[l].dsh_list[a];break}if(a>=0)break}})},getDashboardInfo:function(e){this.selectedDashboard=e;var a={};return a.dsh_id=e.dsh_id,o.dashboard.getInfo(a).then(function(e){if("0"==e.status){e=e.result;var a=e.meta.charts||[];t.createTpl.dashStandardItems=a||[]}})},commitChart:function(){if(!t.createTpl.selectedChart)return l("请选择一个图表");var e={},i=t.createTpl.selectedChart;e.ct_id=i.meta.ct_id;a.get("/api/chart_tpl_prepare/used_fids",e).then(function(a){if(0==a.status){r.closeAll();var l=a.result.used_origin_fids,n={ct_id:e.ct_id,explain:"",name:i.meta.name,proj_id:t.tplInfo.proj_id,type:"",fid_explain:l.map(function(t){return{title:t.name,fid:t.fid}})};t.tplOps.changeCurrentTpl(n)}else errorHandle(a)})["finally"](function(){})},changeCurrentTpl:function(e){var a;a="string"==typeof e?this.modifyTpl(e):e,s.when(a).then(function(e){t.tplInfo=e,2==t.tabIndex&&_()})},modifyTpl:function(e){t.loadingState.tplInfo=!0;for(var l=null,i=t.all_project_list.length,n=0;i--;){for(n=t.all_project_list[i].tpl_list.length;n--;)if(t.all_project_list[i].tpl_list[n].tpl_id==e){l=t.all_project_list[i].tpl_list[n];break}if(n>=0)break}var r=a.get("/api/chart_tpl_prepare/used_fids",{ct_id:l.ct_id}).then(function(t){return 0==t.status?s.when(t.result.used_origin_fids):s.reject(t)}),l=o.chart_tpl.info(e).then(function(t){return 0==t.status?s.when(t.result.tpl_info):void s.reject(t)});return s.all([r,l]).then(function(e){var a=e[1],l=e[0];return a.fid_explain.forEach(function(t){t.to_be_deleted=!0}),t.new_field_index_start_from=-1,l.forEach(function(e){for(var l=a.fid_explain,i=l.length;i--;)if(l[i].fid==e.fid){delete l[i].to_be_deleted;break}0>i&&(t.new_field_index_start_from<0&&(t.new_field_index_start_from=l.length),l.push({title:e.name,fid:e.fid}))}),a})["finally"](function(){t.loadingState.tplInfo=!1})},saveChartTemplate:function(){if(!t.all_project_list||0==t.all_project_list.length)return void l(t.tips["dash.emptyProject"]);if(""===t.tplInfo.name)return void l(t.tips["dash.dashNameRequired"]);if(""===t.tplInfo.type)return void l(d.instant("pleaseFillin")+d.instant("chartTemplate.type"));if(""===t.tplInfo.explain)return void l(d.instant("pleaseFillin")+d.instant("chartTemplate.direction"));var e={proj_id:t.tplInfo.proj_id,ct_id:t.tplInfo.ct_id,name:t.tplInfo.name,type:t.tplInfo.type,explain:t.tplInfo.explain,fid_explain:t.tplInfo.fid_explain.filter(function(t){return!t.to_be_deleted})};t.loadingState.tplInfo=!0,t.tplInfo.tpl_id?(e.tpl_id=t.tplInfo.tpl_id,o.chart_tpl.modify(e).then(function(t){0==t.status?(l(d.instant("saveSuccess")),h(e.tpl_id)):errorHandle(t)})["finally"](function(){t.loadingState.tplInfo=!1})):o.chart_tpl.create(e).then(function(t){"0"==t.status&&(l(d.instant("saveSuccess")),h(t.result.tpl_id))})["finally"](function(){t.loadingState.tplInfo=!1})},delTpl:function(e,a,l){l&&l.stopPropagation(),r.openConfirm({template:"/static/chartTemplate/view/delete_tpl.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:t.tips["chartTemplate.delTpl"]+": "+a.name+" ?"}}).then(function(){o.chart_tpl.delete(a.tpl_id).then(function(e){"0"==e.status&&(t.tplInfo.tpl_id==a.tpl_id?m():h())})})}},t.showTab=function(e){t.tabIndex=e,t.matchTabIndex=e,2==e&&_()},t.tapProject=function(e,a){var l=e.proj_id+(e.rule_id?"$"+e.rule_id:"");a&&(t.projFolding[l]^=1,u(t.projFolding))},m(),p(["chartTemplate.delProject","dash.projectNameRequired","dash.duplicateProjectName","dash.emptyProject","dash.duplicateDashName","chartTemplate.delTpl"],t)}])}();
;!function(){angular.module("BC.controllers.chart.template.rule",["ngDragDrop"]).controller("chartTemplateRuleList",["$scope","$rootScope","commonService","$jsTipTranslate","errHint","ngDialog",function(t,e,l,n,a,i){function o(){return l.chartTplRule.list().then(function(e){t.allRuleList=e.result.rule_list})}function r(){t.allRuleList=[],o()}e.view="chart_template_rule",e.show_bdp_header=!1,t.selectedProject=null,t.allRuleList=[],t.back=function(){e.click_show_view("chart_template")},t.listCtrl={create:function(){e.click_show_view("chart_template_rule_create")},del:function(e){if(e.issued_status)return i.openConfirm({templateUrl:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngdialog-width-340",data:{message:"该条规则是[已发布]状态，必须先取消发布，才能删除。 ",hideCancel:!0}});var n=e.rule_id,r=e.name;i.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:t.tips["chartTemplate.delRule"]+": "+r+" ?"}}).then(function(){l.chartTplRule.delete(n).then(function(e){"0"==e.status?(a(t.tips["chartTemplate.delSuccess"]),o()):a(Number(e.status))})})},modify:function(t){return t.issued_status?i.openConfirm({templateUrl:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngdialog-width-340",data:{message:"该条规则是[已发布]状态，必须先取消发布，才能修改。 ",hideCancel:!0}}):void e.click_show_view("chart_template_rule_modify",{chartTplRuleId:t.rule_id})},pub:function(e,n){var i={rule_id:e,issued_status:n};return l.chartTplRule.issued(i).then(function(e){"0"==e.status&&(a(n?t.tips["chartTemplate.issuedSuccess"]:"取消成功"),o())})}},r(),n(["chartTemplate.delRule","chartTemplate.delSuccess","chartTemplate.saveSuccess","chartTemplate.issuedSuccess"],t)}]).controller("chartTemplateRule",["$scope","$rootScope","commonService","$timeout","$location","ngDialog","$stateParams","$state","commonHttp","errHint","$jsTipTranslate","$q","$translate",function(t,e,l,n,a,i,o,r,c,u,s,d,h){function p(e){return l.chartTplRule.info(e).then(function(e){0==e.status&&(t.tplRuleInfo=e.result.rule_info,t.tplRuleInfo.is_all=!!e.result.rule_info.is_all)})}function m(t){for(var e=1;e<t.length&&!!t[e].choose==!!t[0].choose;e++);return e>=t.length?!1:!0}function f(){return l.chart_tpl_project.getTree().then(function(e){0==e.status&&(t.allTplProject=e.result.proj_tree)})}function _(){var e=l.chartTplRule.industryList().then(function(e){0==e.status&&(t.industryType=e.result.industry_list.industry_list)}),n=l.chartTplRule.domainList().then(function(e){0==e.status&&(t.industryDomain=e.result.domain_list,t.domainPage=1,t.domainMaxPage=e.result.total_page)});return d.all([e,n])}function g(){var e=d.all([f(),_()]);t.editRuleId?p(t.editRuleId).then(function(){e.then(function(){var e=t.tplRuleInfo;t.allTplProject.forEach(function(l){e.rule_proj_list.length&&e.rule_proj_list.indexOf(l.proj_id)>=0?(l.choose=!0,t.checkAll(l)):e.rule_tpl_list.length&&(l.tpl_list.forEach(function(t){e.rule_tpl_list.indexOf(t.tpl_id)>=0&&(t.choose=!0)}),t.checkOne(l))}),!e.is_all&&e.rule_industry_list&&t.industryType.forEach(function(t){e.rule_industry_list.indexOf(t.industry)>=0&&(t.checked=!0)}),e.rule_domain_list&&e.rule_domain_list.forEach(function(e){t.domainSelectedMap[e]=!0;var l=t.industryDomain.some(function(t){return t.domain==e});l||t.industryDomain.unshift({domain:e})})})}):t.tplRuleInfo.is_all=!1}e.show_bdp_header=!1,t.tabIndex=1,t.allTplProject=[],t.selectedProject=null,t.industryType=[],t.industryDomain=[],t.domainPage=0,t.domainMaxPage=1,t.domainSelectedMap={},t.domainSearching=!1,t.calcNum=function(){var e=0;return angular.forEach(t.domainSelectedMap,function(t){t&&e++}),e},t.tplRuleInfo={},t.loadingState=!1,t.editRuleId=o.chartTplRuleId,t.back=function(){e.click_show_view("chart_template_rule")},t.checkAll=function(t){var e=t.tpl_list;e.forEach(function(e){e.choose=t.choose}),t.check_half=!1},t.checkOne=function(e){e=e||t.selectedProject;var l=e.tpl_list,n=m(l);e.check_half=n,e.choose=!n&&l.length&&l[0].choose},t.onIsAllChange=function(){t.industryType.forEach(function(e){e.checked=t.tplRuleInfo.is_all})},t.onIndustryChange=function(){for(var e=t.industryType,l=e.length;l--;)if(!e[l].checked){t.tplRuleInfo.is_all=!1;break}},t.saveRule=function(){var e={name:t.tplRuleInfo.name,proj_id_list:[],tpl_list:[],is_all:1&t.tplRuleInfo.is_all,domain_list:[],industry_list:[]};return e.name?(angular.forEach(t.allTplProject,function(t){angular.forEach(t.tpl_list,function(l){l.choose&&e.tpl_list.push({proj_id:t.proj_id,tpl_id:l.tpl_id})})}),e.is_all_user?(delete e.industry_list,delete e.domain_list):(angular.forEach(t.industryType,function(t){t.checked&&e.industry_list.push(t.industry)}),angular.forEach(t.domainSelectedMap,function(t,l){t&&e.domain_list.push(l)})),e.proj_id_list.length+e.tpl_list.length===0?u("错误：没有选中任何模板"):e.is_all+e.domain_list.length+e.industry_list.length===0?u("错误：没有选中任何企业域"):(angular.forEach(e,function(t,l){angular.isArray(t)&&(e[l]=JSON.stringify(t))}),t.loadingState=!0,void(t.editRuleId?(e.rule_id=t.editRuleId,l.chartTplRule.modify(e).then(function(e){"0"==e.status&&(u(t.tips["chartTemplate.modifySuccess"]),t.back())})["finally"](function(){t.loadingState=!1})):l.chartTplRule.create(e).then(function(e){"0"==e.status&&(u(t.tips["chartTemplate.saveSuccess"]),t.back())})["finally"](function(){t.loadingState=!1})))):void u(h.instant("chartTemplate.inputRuleName"))},t.changeSelectedFolder=function(e){t.selectedProject=e},t.domainLoadMore=function(){l.chartTplRule.domainList({page:++t.domainPage}).then(function(e){0==e.status&&(t.industryDomain=t.industryDomain.concat(e.result.domain_list))})};var T;t.domainQueryChange=function(){(t.domainSearching=!!t.query_domain)?(n.cancel(T),T=n(function(){l.chartTplRule.domainSearch({domain:t.query_domain}).then(function(e){t.domainSearching&&0==e.status&&e.result&&e.result.domain_result&&(t.industryDomainSearch=e.result.domain_result.map(function(t){return{domain:t}}))})},200)):t.industryDomainSearch=null},t.tabIndustry=function(e){1==e?t.tabIndex=1:2==e&&(t.tabIndex=2)},g(),s(["chartTemplate.delRule","chartTemplate.delSuccess","chartTemplate.saveSuccess","chartTemplate.issuedSuccess","chartTemplate.modifySuccess"],t)}])}();
;function pageCtrl(e,t){function a(){var t,a,i=e.total,n=e.curPage;5>=i?(t=1,a=i):3>i-n?(t=i-4,a=i):(t=4>n?1:n-2,a=1==t?5:n+2),e.pageList=r(t,a),e.pageShow=!0}function r(e,t){for(var a=[],r=e;t+1>r;r++)a.push(r);return a}e.pageShow=!1,e.goPage=function(t){var a=t.target,r=a.getAttribute("page");if("prev"==r){if(1==e.curPage)return;r=e.curPage-1}if("next"==r){if(e.curPage==e.total)return;r=e.curPage+1}r!=e.curPage&&(e.curPage=r,e.$emit("goPage",r))},e.$on("initPage",function(){t(function(){a()},10)})}angular.module("BC.directives").directive("bdpPage",function(){return{templateUrl:"/static/partials/directiveTemplates/page.html",link:function(){},controller:"pageCtrl",scope:{curPage:"=",total:"="}}}),pageCtrl.$inject=["$scope","$timeout"];
;!function(){function e(e,s,t,a,r){return{restrict:"EA",templateUrl:"/static/partials/directiveTemplates/selectProjDash.html",scope:{projList:"=",projId:"=",dashId:"=",newDashName:"="},replace:!0,link:function(i,o,h){var d=e.language||"zh",n="zh"==d?"请选择":"Please select";i.showProjList=!1,i.showDashList=!1,i.dashList=[],i.currentProjName="",i.currentDashName=n||"",i.requestDone=!0,i.optType=h.optType,i.init=function(){var e=i.projList;i.dashList=[];for(var s=0,t=e.length;t>s;s++)e[s].proj_id==i.projId&&(i.currentProjName=e[s].name,i.dashList=e[s].dsh_list.length>0?e[s].dsh_list:[]);if("copyDash"!=i.optType)for(var a=i.dashList,r=0,o=a.length;o>r;r++)a[r].dsh_id==i.dashId&&(i.currentDashName=i.dashList[r].name)},i.init(),i.selectProjItem=function(e,s){i.currentProjName=s,i.projId=e,i.showProjList=!1;for(var t=i.projList,a=0,r=t.length;r>a;a++)t[a].proj_id==i.projId&&(i.currentProjName=t[a].name,i.dashList=t[a].dsh_list.length>0?t[a].dsh_list:[],i.currentDashName=i.dashList.length?i.dashList[0].name:n,"copyDash"!=i.optType&&(i.dashId=i.dashList.length?i.dashList[0].dsh_id:""))},i.selectDashItem=function(e,s){i.currentDashName=s,i.dashId=e,i.showDashList=!1},i.createNewProj=function(){i.showProjList=!1,i.showDashList=!1,i.newProjDialog=a.open({template:"/static/partials/directiveTemplates/selectProjDashInfo.html",className:"ngdialog-theme-default ngDialog-width-360",scope:i,data:{type:"proj",name:"",save:i.saveNewProj}})},i.createNewDash=function(){return i.projId?(i.showProjList=!1,i.showDashList=!1,void(i.newDashDialog=a.open({template:"/static/partials/directiveTemplates/selectProjDashInfo.html",className:"ngdialog-theme-default ngDialog-width-360",scope:i,data:{type:"dash",name:"",save:i.saveNewDash}}))):void t(i.tips["dash.pleaseSelectProj"])},i.saveNewProj=function(e){if(i.requestDone){if(void 0==e||""===e)return void t(i.tips["dash.projectNameRequired"]);for(var a=i.projList||[],r=0,o=a.length;o>r;r++)if(a[r].name==e)return void t(i.tips["dash.duplicateProjectName"]);i.requestDone=!1,s.project.create(e).then(function(s){if(i.requestDone=!0,"0"==s.status){var a={proj_id:s.result.proj_id,name:e,dsh_list:[],type:0,property:0};i.$emit("updateProjTree",a),i.currentProjName=e,i.projId=s.result.proj_id,"copyDash"!=i.optType&&(i.dashList=[],i.dashId="",i.currentDashName=n),i.newProjDialog.close()}else t(Number(s.status))})}},i.saveNewDash=function(e){if(i.requestDone){if(""===e)return void t(i.tips["dash.dashNameRequired"]);if(e.length>100)return void t(i.tips["dash.dashNameLessThan100"]);for(var a=null,r=i.projList,o=0;o<r.length;o++)if(r[o].proj_id==i.projId){a=r[o];break}a||(a=i.projList[0]);for(var h=a.dsh_list,d=0,n=h.length;n>d;d++)if(h[d].name==e)return void t(i.tips["dash.duplicateDashName"]);var l={name:e,proj_id:i.projId};i.requestDone=!1,s.dashboard.create(l).then(function(s){i.requestDone=!0,"0"==s.status?(h.push({dsh_id:s.result.dsh_id,name:e,label:"",comment:"",outer_share_id:"",property:0}),i.dashList=h,i.dashId=s.result.dsh_id,i.currentDashName=e,i.newDashDialog.close()):t(Number(s.status))})}},r(["dash.projectNameRequired","dash.duplicateProjectName","pleaseSelect","dash.dashNameRequired","dash.dashNameLessThan100","dash.duplicateDashName","dash.pleaseSelectProj"],i)}}}angular.module("BC.directives").directive("selectProjDash",e),e.$inject=["$rootScope","commonService","errHint","ngDialog","$jsTipTranslate"]}();
;!function(){angular.module("BC.directives").directive("navNotice",["errHint","$location","commonService","$filter",function(e,t,o,n){return{restrict:"A",templateUrl:"/static/js/common/tpl/nav_notice.html",replace:!1,scope:{},link:function(i){function a(e,t,o){var n=0;angular.forEach(i.noticTipsMol,function(i,a){o&&(i.show=!1),e&&e===a-0&&(i.show=t?!0:!1),i.show&&(n+=1)}),i.hasNewNotice.unReadTypeLen=n,i.hasNewNotice.show=0===i.hasNewNotice.unReadTypeLen?!1:!0,localStorage.setItem("noticTipsMol",angular.toJson(i.noticTipsMol))}function s(){o.notice.getNoticeType().then(function(t){if(0==t.status){var o=t.result,s=localStorage.getItem("noticTipsMol")?angular.fromJson(localStorage.getItem("noticTipsMol")):{};i.navNoticeList=[],i.hasNewNotice.unReadTotal=0;for(var c=o.length-1;c>=0;c--)i.navNoticeList.unshift({title:n("noticeTypeMap")(o[c].purpose),unReadNewsLen:o[c].unread_num,typeId:o[c].purpose}),i.hasNewNotice.unReadTotal+=o[c].unread_num,s[o[c].purpose]||(s[o[c].purpose]={},s[o[c].purpose].show=o[c].unread_num>0?!0:!1),0==o[c].unread_num?s[o[c].purpose].show=!1:o[c].unread_num>s[o[c].purpose].unReadLen&&(s[o[c].purpose].show=!0),s[o[c].purpose].unReadLen=o[c].unread_num;i.noticTipsMol=s,a()}else e(t.errstr)})}i.navNoticeList=[],i.hasNewNotice={show:!1,unReadTotal:0,unReadTypeLen:0},i.noticTipsMol={},i.closeNavNotice=function(){a("","",!0)},i.goToListPage=function(e){if("undefined"==typeof e)for(var o=i.navNoticeList.length-1;o>=0;o--)if(i.noticTipsMol[i.navNoticeList[o].typeId].show){e=i.navNoticeList[o].typeId;break}if("undefined"==typeof e)for(var o=i.navNoticeList.length-1;o>=0;o--)if(i.navNoticeList[o].unReadNewsLen){e=i.navNoticeList[o].typeId;break}if("undefined"==typeof e){if(!i.navNoticeList[0])return!1;e=i.navNoticeList[0].typeId}a(e,!1),t.path("/notice/"+e)},i.$on("getNavNoticeList",function(){i.init()});var c="_websocketChartMessage_";i.$on(c,function(e,t){var o="string"==typeof t.data?$.parseJSON(t.data):t.data;if(9==o.type){var n=o.content;if("is_publ"==n.type){for(var s=i.navNoticeList.length-1;s>=0;s--)if(i.navNoticeList[s].typeId===n.purpose){i.navNoticeList[s].unReadNewsLen+=1,i.hasNewNotice.unReadTotal+=1,i.noticTipsMol[n.purpose].show||a(n.purpose,!0);break}}else if("is_back"==n.type)for(var s=i.navNoticeList.length-1;s>=0;s--)if(i.navNoticeList[s].typeId===n.purpose&&!n.is_read){i.navNoticeList[s].unReadNewsLen-=1,i.hasNewNotice.unReadTotal-=1,"undefined"!=typeof i.noticTipsMol[n.purpose]&&0==i.navNoticeList[s].unReadNewsLen&&a(n.purpose,!1);break}i.$$phase||i.$digest()}}),i.init=function(){s()},i.init()}}}])}();
;angular.module("BC.directives").directive("searchFolderTableCheckbox",function(){return{restrict:"A",link:function(n,e){function i(){var e=n.query;e?angular.forEach(n.folderList,function(n){n.hide=!n.name.match(e),n.hide?(angular.forEach(n.tb_list,function(i){i.name.match(e)?(i.hide=!1,n.hide=!1,n.open=!0):i.hide=!0}),angular.forEach(n.sub_folders,function(i){i.name.match(e)?(i.hide=!1,i.open=!0,n.hide=!1,n.open=!0):i.hide=!0,i.hide?angular.forEach(i.tb_list,function(a){a.name.match(e)?(a.hide=!1,i.hide=!1,i.open=!0,n.hide=!1,n.open=!0):a.hide=!0}):angular.forEach(i.tb_list,function(n){n.hide=!1})})):(angular.forEach(n.tb_list,function(n){n.hide=!1}),angular.forEach(n.sub_folders,function(n){n.hide=!1,n.open=!1,angular.forEach(n.tb_list,function(n){n.hide=!1})}))}):angular.forEach(n.folderList,function(n){n.hide=!1,n.open=!1,angular.forEach(n.sub_folders,function(n){n.hide=!1,n.open=!1,angular.forEach(n.tb_list,function(n){n.hide=!1})}),angular.forEach(n.tb_list,function(n){n.hide=!1})}),n.$digest()}var a;e.bind("keyup",function(){clearTimeout(a),a=setTimeout(i,10)})}}});
;!function(){function e(e,t,a,r,i){function o(e){a(e.status+" : "+e.statusText)}var n=1,l=2;return{restrict:"A",template:'<i class="bdp-icon ml5" ng-class="typesMap[selectedTb.update_mode][0]"></i><span class="btn-layer-opt">    {{"wb.transform.type" + typesMap[selectedTb.update_mode][1]|translate}}</span><div class="bdp-tooltip bottom ml5">    <i class="bdp-icon ico-info-sign"></i>    <div class="bdp-tooltip-content">        <div class="content">{{"wb.transform.type" + typesMap[selectedTb.update_mode][1]|translate}}{{"wb.transform.descriptionFor" + typesMap[selectedTb.update_mode][1]|translate}}<p class="mt8 mute-font">{{"wb.transform.btnHelpTipTip"|translate}}</p></div>    </div></div>',scope:{selectedTb:"=transformTbType"},link:function(s,d){s.typesMap={0:["ico-file-normal","General"],1:["ico-file-data","Incremental"],2:["ico-file-speed","Frequently"]},s.editable=!0,s.changePartitionField=s.$parent.changePartitionField;var c={currentStep:"selecting",checkResult:"",showLoading:!1},u=s.transData={};angular.extend(s.transData,c),s.showTransformDialog=function(){angular.extend(s.transData,c),s.transData.targetType=s.transData.currentType=s.selectedTb.update_mode,s.selected=s.$parent.selected;var e=s.selectedTb,a=!t.isPersonal&&"union"!=e.type&&"public"!=e.type&&"allot"!=e.type&&"access_tb"!=e.tb_type;s.byShare=0==e.tb_id.indexOf("sh"),s.editable=a&&"join"!=e.type&&"script"!=e.type&&"aggr"!=e.type?!0:!1,r.open({template:"/static/partials/dialogTemplates/transform_tb_type.html",className:"ngdialog-theme-default ngdialog-trans-tbtype ngDialog-width-552",scope:s})},s.checkSelected=function(){if(u.currentType==u.targetType)return void a(s.tips["wb.transform.shouldSelectDiffrentType"]);if(u.targetType==n)s.$parent.preparePartitionData(),s.$parent.beginSetPartition(),s.partitionData=s.$parent.partitionData,s.partitionData.empty_field&&(s.transData.checkResult="wb.noPartitionField"),s.transData.currentStep="submiting";else if(u.targetType==l){if(s.selected.tb.data_count>1e5)return s.transData.checkResult="wb.transform.tableDataCountOver10w",void(s.transData.currentStep="submiting");s.transData.showLoading=!0,e.tb.updateModeCheck({tb_id:s.selected.tb_id,mode:l}).then(function(e){return 0!=e.status?a(e.errstr):(e.result.view_count&&(s.transData.checkResult="wb.transform.tableBeenDependent"),void(s.transData.currentStep="submiting"))},o)["finally"](function(){s.transData.showLoading=!1})}else s.transData.currentStep="submiting"},s.goSelectingStep=function(){angular.extend(s.transData,c)},s.submitTransform=function(){var t,i={tb_id:s.selected.tb_id,mode:s.transData.targetType};i.mode==n&&(t={base_field:s.partitionData.field_id,param:{type:s.partitionData.data_type,option:"date"==s.partitionData.data_type?s.partitionData.granularity:""}},t.param=angular.toJson(t.param),i.param=angular.toJson(t)),s.transData.showLoading=!0,e.tb.updateModeModify(i).then(function(e){0!=e.status?a(e.errstr):(a(s.tips["wb.transform.success"]+s.tips["wb.transform.type"+s.typesMap[i.mode][1]]),s.selectedTb.update_mode=i.mode,t&&s.$parent.updatePartitionData(t),r.closeAll())},o)["finally"](function(){s.transData.showLoading=!1})},d.on("click",function(){s.showTransformDialog(),t.$digest()}),i(["wb.transform.shouldSelectDiffrentType","wb.transform.success","wb.transform.typeGeneral","wb.transform.typeIncremental","wb.transform.typeFrequently","wb.transform.canNotEdit"],s)}}}!function(){function e(e,t){if(e){var a=t||$("#tb-header"),r=a.find("li"),i=0,o=e.find("thead").eq(0).find("th");o.each(function(e){var t=$(this).outerWidth(),a=0==e?t+1:t;i+=a,r.eq(e).css("width",a)}),a.css("width",i)}}function t(t,a,r,i,o,n,l,s,d,c,u,f,p,g){function h(){var e=a.wsId;if(e){var r=!1,i=a.workspaceList.dash;i.map(function(t){t.ws_id==e&&(r=!0)}),t.createChartDataShow=r}}function b(){t.previewFilterData={where:{where_type:"condition",where_linker:"and",sql:[],condition:{filters:[]}},sql:{}}}function _(){t.resetPreviewFilterData.flag=!t.resetPreviewFilterData.flag,t.previewFilterSort=[],t.$broadcast("last-param-change",null),t.lastPreviewFilterData=null,b()}function m(){var e=angular.copy(t.previewFilterData),a=[];return angular.forEach(e.sql,function(e,t){e&&a.push({tb_id:t,sql:e})}),e.where.sql=a,delete e.sql,delete e.where.condition,e}function v(){t.visiblePreviewFieldData={currentType:"base",fieldQueryText:"",baseTbField:{strField:{checkAll:!0,displayNum:0,checkNum:0,list:[]},numField:{checkAll:!0,displayNum:0,checkNum:0,list:[]},dateField:{checkAll:!0,displayNum:0,checkNum:0,list:[]}},calcTbField:{strField:{checkAll:!0,displayNum:0,checkNum:0,list:[]},numField:{checkAll:!0,displayNum:0,checkNum:0,list:[]},dateField:{checkAll:!0,displayNum:0,checkNum:0,list:[]}},currentTbField:{},originalTbField:{},modifyFieldList:[]}}function w(){function e(e,t){var a={};switch(e.data_type){case"string":a=t.strField;break;case"number":a=t.numField;break;case"date":a=t.dateField}a.list.push(e),a.displayNum++,a.checkNum=e.selected?++a.checkNum:a.checkNum,a.checkAll=a.displayNum==a.checkNum}v();var a=t.visiblePreviewFieldData,r=angular.copy(t.previewData.origin_schema);angular.forEach(r,function(t){t.visibleHitQuery=!0,t.aggregator?e(t,a.calcTbField):e(t,a.baseTbField)}),a.currentTbField="base"==a.currentType?a.baseTbField:a.calcTbField}function y(e,a){for(var r=t.previewData.field_list,i={number:1,string:2,date:3},o=e;a>o;o++){if(field=t.originData.schema[o],field.hasOwnProperty("param")&&field.param){var n=JSON.parse(field.param);n.type&&"cluster"==n.type?(field.ico_type=4,field.editable=!1):field.ico_type=i[field.data_type]}else field.ico_type=i[field.data_type];r.push(field)}}function D(){t.$$phase||t.$digest(),c(function(){e($("#tb-detail-table"))},0)}function T(){var e=localStorage.getItem("jumpToRelationMap");return e}function F(){localStorage.setItem("jumpToRelationMap","")}function k(e){function a(t){t.sub_folders&&t.sub_folders.length>0&&t.sub_folders.map(a),t.tb_list.map(function(t){e==t.tb_id&&(r=t.name)})}var r;return t.original_folderList.map(a),r}function L(e){e.map(function(e){e.tb_name=k(e.tb_id)})}function S(e,a){var r=e.where_type,i=t.modelData;if(i.whereInfo.where_type=r,"sql"==r)e.sql.length>0?(i.whereInfo.sql="aggr"==a?e[r][0].sql:e[r],i.whereInfo.data=!0):i.whereInfo.data=null;else{L(e[r].filters),i.whereInfo[r]={filters:e[r].filters},i.whereInfo.where_linker=e.where_linker,i.whereInfo.data=!0;var o={},n=i.whereInfo[r].filters;n.length>0&&(angular.forEach(n,function(e){o[e.tb_name]?o[e.tb_name].push(e):(o[e.tb_name]=[],o[e.tb_name].push(e))}),i.whereInfo.conditionFilters=o),0==n.length&&(i.whereInfo.data=null)}i.whereInfo.data&&(t.modelView.filter_show=!0)}function x(e,t){for(var a=0,r=e.length;r>a;a++)if(e[a].fid==t)return e[a];return null}function E(e){0==e.status&&(e.result.is_empty&&(t.no_datasource=!0,t.selected={tb:null,status:{},tb_id:0,folder_id:""},$.cookie("ds_tb_id",""),$.cookie("select_folder_id",""),t.previewData.table_preview_loading=!1,t.previewData.table_preview_filter_loading=!1,t.activeTab.index=1),e.result.tb_permission||$.cookie("ds_tb_id",""),t.loadingFolderStructure=!1,t.folderStructure=e.result.folder_list,t.tabView=!0)}function C(){N(),t.pageInit=!0,a.pageLoading=!0;var e=T();e||(e=$.cookie("ds_tb_id"));var r={get_first:e?0:1,get_root:1,tb_list:[]};e&&r.tb_list.push(e),t.getFolderStructure(r).then(function(){if(t.pageInit=!1,a.pageLoading=!1,t.no_datasource)return!1;var e;e=$.cookie("ds_tb_id")?bdp.bdpTables.getTableByTableId(t.folderStructure,$.cookie("ds_tb_id")):t.getFirst(t.folderStructure),t.showDetailPage(e,!0),t.refreshFolderStatus()})}function N(){function e(e){t.table_label_list=[],angular.forEach(e,function(e){e.totalTable=bdp.bdpTables.getFolderTableNumber(e),angular.forEach(e.tb_list,function(e){e.label&&t.table_label_list.indexOf(e.label)<0&&t.table_label_list.push(e.label)}),e.sub_folders&&e.sub_folders.length>0&&angular.forEach(e.sub_folders,function(e){angular.forEach(e.tb_list,function(e){e.label&&t.table_label_list.indexOf(e.label)<0&&t.table_label_list.push(e.label)})})}),t.original_folderList=angular.copy(e),angular.forEach(e,function(e){e.open=t.getUnFoldingStatus(e.folder_id)||!1,"folder_root"==e.folder_id&&(e.name="en"==a.language?"Root":"根目录"),e.sub_folders&&e.sub_folders.length>0&&angular.forEach(e.sub_folders,function(e){e.open=t.getUnFoldingStatus(e.folder_id)||!1})}),t.checkUnreadTbInFolder("",e),t.folderList=t.originFolderList=e,t.$broadcast("updatefolderList",t.original_folderList),t.$$phase||t.$apply(),t.saveFolderList=angular.copy(e),angular.forEach(t.saveFolderList,function(e){"folder_root"==e.folder_id&&(e.name="en"==$.cookie("locale")?"Root":"根目录")});var r,i;return i=T(),i||(i=$.cookie("ds_tb_id")),r=bdp.bdpTables.getTableByTableId(e,i),r||(r=t.getFirst(t.original_folderList)),r&&t.showDetailPage(r,!0),t.current_pos>0?c(function(){$("#ds-list > ul")[0].scrollTop=t.current_pos},100):c(I,100),e}return t.query="",t.isGettingFolder=!0,r.folder.getList().then(function(a){return a?(t.isGettingFolder=!1,e(a)):void 0})}function I(){var e=$("#ds-list > ul");if(e[0]){var t=e[0].clientHeight,a=e.find(".active")[0];a&&a.offsetTop>e[0].scrollTop+t&&(e[0].scrollTop=a.offsetTop-t/2)}}function j(){var e=[];return angular.forEach(t.fieldSet.schema,function(a){var r=!1,i={tb_id:t.selected.tb.tb_id,fid:a.field_id,type:null,fid_name:null,remark:null,flag:null};angular.forEach(t.fieldSet.origin_schema,function(e){e.field_id==a.field_id&&(e.type!=a.type&&(r=!0,i.type=a.type),e.remark!=a.remark&&null!=a.remark&&(r=!0,i.remark=a.remark),e.title!=a.title&&a.title&&(i.fid_name=a.title,r=!0),i.flag=e.flag)}),r&&e.push(i)}),e}function P(a){r.field.getEditableSchema(a).then(function(a){0==a.status&&(t.fieldSet.schema=angular.copy(a.result.fields),t.fieldSet.origin_schema=angular.copy(a.result.fields),c(function(){e(angular.element("#J_edit_field_detail_table"),angular.element("#J_edit_field_header")),$(window).off("resize.alignEditField").on("resize.alignEditField",function(){e(angular.element("#J_edit_field_detail_table"),angular.element("#J_edit_field_header"))})},0)),t.previewData.table_preview_loading=!1})}t.goHelp=function(e){n(e)},a.view="worktable",a.show_bdp_header=!0,a.last_worktable_path=l.path(),t.createChartDataShow=!0,t.selected={tb:null,status:{},tb_id:0,folder_id:""},t.unfolding={},a.wsId&&a.$watch("workspaceList",function(e){e&&h()}),t.setUnFoldingStatus=function(e,a){e.parent_id?(t.unfolding[e.folder_id]={open:a,parent_id:e.parent_id},t.unfolding[e.parent_id]={open:a,parent_id:""}):t.unfolding[e.folder_id]={open:a,parent_id:""}},t.getUnFoldingStatus=function(e){return t.unfolding[e]&&t.unfolding[e].hasOwnProperty("open")?t.unfolding[e].open:!1},t.changeFolderOpenStatus=function(e){angular.forEach(e,function(e){e.open=t.getUnFoldingStatus(e.folder_id),e.sub_folders&&e.sub_folders.length>0&&angular.forEach(e.sub_folders,function(e){e.open=t.getUnFoldingStatus(e.folder_id)})})},t.highlightByTableId=function(e,a){var r=bdp.bdpTables.getFolderByTableId(e,a);t.unfolding={},t.setUnFoldingStatus(r,!0),t.changeFolderOpenStatus(e)},t.isGettingFolder=!1,t.getFolderList=N,t.scroll_to_active=I,t.showDetailPage=function(e,a,r){t.no_datasource=!1;var i=t.selected.tb_id;if(e!=t.selected.tb||a){var o=bdp.bdpTables.getFolderByTableId(t.folderStructure,e.tb_id);t.selected.folder=o,t.selected.folder_id=o.folder_id,$.cookie("select_folder_id",o.folder_id),t.selected.tb=e,t.selected.tb_id=e.tb_id,i!=t.selected.tb_id&&(_(),t.showTab(T()?2:"access_tb"==e.tb_type&&0==e.tb_status?3:1),$.cookie("ds_tb_id",t.selected.tb_id),t.selected.status.timer&&clearTimeout(t.selected.status.timer),t.selected.status={},t.get_status(r,e),c(I,100)),t.preview.send=!0,t.preview.showErrorReport=!1}},t.updateTbList=function(e,a,r){function i(e){for(var t=0,o=e.length;o>t;t++){for(var l=0,s=e[t].tb_list.length;s>l;l++)if(e[t].tb_list[l].tb_id==a.tb_id){e[t].tb_list[l][r]=a[r],n=!0;break}if(n)break;e[t].sub_folders&&e[t].sub_folders.length&&i(e[t].sub_folders)}}function o(e){for(var t=0,r=e.length;r>t;t++){for(var i=0,n=e[t].tb_list.length;n>i;i++)if(e[t].tb_list[i].tb_id==a.tb_id){e[t].tb_list.splice(i,1),l=!0;break}!l&&e[t].sub_folders&&e[t].sub_folders.length>0&&o(e[t].sub_folders)}}var n=!1,l=!1;"changeStatus"==e?(i(t.folderList,"current"),i(t.original_folderList,"original")):"del"==e&&(o(t.folderList,"current"),o(t.original_folderList,"original")),t.$broadcast("updatefolderList",t.original_folderList)},t.hasModel=function(){var e=t.selected.tb?t.selected.tb.type:"",r=t.selected.tb?t.selected.tb.tb_type:"";return a.wsId?["aggr","join","union","script"].indexOf(e)>-1&&"self"==r:["aggr","join","union","script"].indexOf(e)>-1&&"access_tb"!=r},t.workTableFilter={showIt:!1,refreshCalculateFilter:!1},b(),t.resetPreviewFilterData={flag:!1},t.lastPreviewFilterData=null,t.$on("toFilter",function(){var e=m();t.show_preview_data(e)}),t.changeWhereType=function(){var e=t.previewFilterData.where.where_type;"sql"==e?$("#tb-detail").css("paddingTop",296):t.$broadcast("updateConditionHeight")},t.previewFilterSort=[],t.changeWorkTableSort=function(e,a){if(t.previewFilterSort=[{fid:e,type:a}],"condition"==t.previewFilterData.where.where_type)t.$broadcast("fire-change-sort",e,a);else{var r=m();r.sort=angular.copy(t.previewFilterSort),e&&t.show_preview_data(r)}},t.visibleFieldStatus={showFlag:!1,refreshVisibleField:!1},v(),t.formatVisiblePreviewFieldData=w,t.activeTab={index:1},t.relationView={view:"list"},t.operateMap={1:"新增",2:"追加",3:"替换",4:"删除",5:"替换"},t.showTab=function(e,a){function r(){switch(e){case 1:t.show_preview_data(t.lastPreviewFilterData);break;case 2:t.show_relation_list();break;case 3:t.show_update_record(a);break;case 4:t.show_model_struct();break;case 5:t.show_field_set()}}function i(){t.activeTab.index=e,r(),window.GOJS="GOJS"}if(!t.no_datasource){if(!t.selected.tb_id)return!1;if(4==e&&t.selected.tb&&"join"==t.selected.tb.type){var o={funcQueue:[],loadLibInProgress:!1};thirdPluginLoader({initFun:i,libSrc:"https://m1.bdp.cn/static/js/lib/go_latest_0d59d2c.js",libId:window.GOJS},o)}else t.activeTab.index=e,r()}},t.rename_field=function(a,i,o){var n=o.name;return r.tb.modify(angular.toJson([{tb_id:t.selected.tb.tb_id,name:t.selected.tb.name,fid:o.fid,type:i,fid_name:a}])).then(function(r){var l=r;if(0==l.status)o.title=o.name=a,o.type=i,o.data_type=t.fieldTypeMap[i],setTimeout(function(){e(angular.element("#tb-detail-table"))},100);else{o.name=n;var s=Number(l.status);d(s)}})},t.modifyFieldType=function(e,a){r.tb.modify(angular.toJson([{tb_id:t.selected.tb.tb_id,fid:e.fid,type:a}])).then(function(t){var r=t;0==r.status?e.type=a:d(r.errstr)}),e.show_type_list=!1},t.fieldTypeMap={0:"number",1:"number",3:"date",2:"string"},t.getCapacityStatistics=function(){i.get("/api/tb/stat_group").then(function(e){t.isGettingAccount=!1,0==e.status?(t.tableCapacityStatistics=e.result.total,t.tableCapacityStatisticsTip=t.tips["wb.tableCapacity.used"]+t.tips["wb.tableCapacity.capacity"]+t.tableCapacityStatistics):d(+e.status,{warn_msg:e.errstr})})},t.get_status=function(e,a){function i(){l.state="view-status-error",l.joinDesc1=t.tips["wb.joinWarning"],l.joinDesc2=t.tips["wb.joinKeyField"],l.joinDesc3=t.tips["wb.joinOr"],l.joinDesc4=t.tips["wb.joinErrorLog"],l.joinDesc5=t.tips["wb.joinWarnSure"]}function o(){l.state="view-status-error",l.description=t.tips["wb.joinFailed"],l.joinDesc1=t.tips["wb.joinFailed"],l.joinDesc2=t.tips["wb.joinKeyField"],l.joinDesc3=t.tips["wb.joinOr"],l.joinDesc4=t.tips["wb.joinErrorLog"],l.joinDesc5=t.tips["wb.joinFailedModify"]}function n(){return t.selected.tb_id?void r.tb.getStatus(t.selected.tb_id,e).then(function(e){if(0==e.status){var a=e.result,r=a.status,d=a.view_status;(1==r||2==r)&&t.getCapacityStatistics(),3==r||6==r?(s=l.state="update",l.description=t.tips["wb.isUpdatingWaiting"],l.timer=setTimeout(function(){n()},3e3)):2==r?1==d?i():2==d?o():(l.state="error",l.description=t.tips["wb.updateFailed"]):(1==d?i():t.selected.status.state=void 0,"update"==s&&(t.show_preview_data(),s=void 0))}}):!1}if(!a)return!1;var l=t.selected.status,s=void 0;t.selected.tb_id||(t.selected.tb_id=a.tb_id),n()};var R={table_preview_filter_loading:!0,table_preview_filter_flag:!1,table_preview_loading:!0,field_list:[],field_data_list:[],field_data_total:0,field_data_update_time:"",field_data_show_total:0,origin_schema:null,sqlTbList:[]};t.previewData=angular.copy(R),t.show_preview_data=function(i){var o=this;angular.element("#tb-detail-table"),i?t.previewData.table_preview_filter_loading=!0:t.previewData=angular.copy(R);var n=o.requestTimestamp=+new Date,l=null;null!=i&&(l=-1);var s=t.visiblePreviewFieldData.modifyFieldList;t.generateCoordinateStatus=0,r.tb.preview(t.selected.tb_id,l,i,s).then(function(l){if(o.requestTimestamp>n)return null;if(l){var s=!1;t.previewData.field_data_list.length<=0&&(s=!0),t.previewFields=angular.copy(l.fields),t.generateCoordinateStatus=l.has_gis,2==l.has_gis&&(r.tb.gisModify({tb_id:t.selected.tb_id}),c(function(){t.generateCoordinateStatus=0},1e4)),null!=i?t.previewData=angular.copy(R):t.previewData.field_list=[],angular.extend(t.previewData,{table_preview_filter_loading:!1,table_preview_filter_flag:!1,table_preview_loading:!1,field_data_total:l.count,field_data_show_total:l.count<=1e3?l.count:1e3,field_data_update_time:u("date")(1e3*l.update_time,"yyyy-MM-dd HH:mm:ss"),origin_schema:l.fields,show_schema:l.schema,has_gis:l.has_gis});var d=t.selected.tb;angular.forEach(l.fields,function(e){e.data_type=t.fieldTypeMap[e.type]}),t.previewData.sqlTbList=[{name:d.name,tb_id:d.tb_id,open:!0,fields:l.fields}],angular.forEach(l.schema,function(e){if(e.editable=!0,e.hasOwnProperty("param")&&e.param){var t=angular.fromJson(e.param);t&&t.type&&"ds"==t.type&&(e.editable=!1)}}),t.tbType=l.tb_type,t.originData=l,t.defaultMaxTable(),null!=i&&(t.$broadcast("last-param-change",i),t.previewData.table_preview_filter_flag=!0),t.lastPreviewFilterData=i||null,t.previewData.materialized=l.hasOwnProperty("materialized")?l.materialized:1,t.previewData.specialTbStatus=l.special_status;var f=!a.permision.isPersonal&&"union"!=t.selected.tb.type&&"public"!=t.selected.tb.type&&"allot"!=t.selected.tb.type&&"access_tb"!=t.selected.tb.tb_type;t.enable_set_partition=f&&l.hasOwnProperty("can_partition")&&!!l.can_partition,l.hasOwnProperty("partition")&&t.updatePartitionData(l.partition),d.materialized=l.materialized,d.update_mode=l.update_mode,c(function(){e($("#tb-detail-table")),$(window).off("resize.alignTable").on("resize.alignTable",function(){e($("#tb-detail-table"))}),angular.element("#J_wtb_table_scroll_preview").off("scroll.scrollxTable").on("scroll.scrollxTable",function(){angular.element("#tb-header").css({left:0-$(this).scrollLeft()})}),l.schema.length>20&&(s&&t.previewData.field_data_list.length>0&&$("#J_wtb_preview_wrap").scrollLeft(0),angular.element("#tb-detail-table").closest(".table-scroll").off("scroll.addColumn").on("scroll.addColumn",function(){if(this.scrollLeft+this.clientWidth>this.scrollWidth-100){var e=t.addColumn(15);e||$(this).off("scroll.addColumn")}}),angular.element("#J_wtb_preview_wrap").closest(".J-nodata-table-scroll").off("scroll.addColumnNodata"),t.previewData.field_data_list.length<=0&&angular.element("#J_wtb_preview_wrap").closest(".J-nodata-table-scroll").off("scroll.addColumnNodata").on("scroll.addColumnNodata",function(){if(this.scrollLeft+this.clientWidth>this.scrollWidth-100){var e=t.addColumn(15);e||$(this).off("scroll.addColumnNodata")}})),l.data.length>50&&angular.element("#tb-detail-table").closest(".table-scroll").off("scroll.addRow").on("scroll.addRow",function(){if(this.scrollTop+this.clientHeight>this.scrollHeight-100){var e=t.addRow(30);e||$(this).off("scroll.addRow")}}),t.workTableFilter.showIt&&(t.workTableFilter.refreshCalculateFilter=!t.workTableFilter.refreshCalculateFilter),t.visibleFieldStatus.showFlag&&(t.visibleFieldStatus.refreshVisibleField=!t.visibleFieldStatus.refreshVisibleField),w()},0);var p=t.selected.status;1==l.status&&(l.count>0&&0==l.data.length?(p.state="fail",p.description=t.tips["wb.loadFailed"]):"fail"==p.state&&(p.state=void 0))}else null!=i&&(t.previewData.table_preview_filter_loading=!1)})},t.changeTableFilterTab=function(e){switch(e){case"filter":t.workTableFilter.showIt=!t.workTableFilter.showIt,t.visibleFieldStatus.showFlag=!1;break;case"display":t.visibleFieldStatus.showFlag=!t.visibleFieldStatus.showFlag,t.workTableFilter.showIt=!1}t.visibleFieldStatus.showFlag||t.formatVisiblePreviewFieldData()},t.modelRedraw=function(){t.$broadcast("redraw")},t.defaultMaxTable=function(){var e=50,a=20,r=0,i=t.originData.data.length,o=t.originData.schema.length,n=Math.min(e,i),l=Math.min(a,o),s=t.previewData.field_data_list;y(r,l);for(var d=0;n>d;d++){var c=[];s.push(c);for(var u=0;l>u;u++)c.push(t.originData.data[d][u])}D()},t.addColumn=function(e){var a=t.previewData.field_list.length,r=t.originData.schema.length,i=Math.min(a+e,r),o=t.previewData.field_data_list,n=!0;return r>a?(y(a,i),angular.forEach(o,function(e,r){for(var o=a;i>o;o++)e.push(t.originData.data[r][o])}),n=!0,D()):n=!1,n},t.addRow=function(e){var a=t.previewData.field_data_list,r=a.length,i=t.originData.data.length,o=t.previewData.field_list.length,n=Math.min(r+e,i),l=!0;if(i>r){for(var s=r;n>s;s++){var d=[];a.push(d);for(var c=0;o>c;c++)d.push(t.originData.data[s][c])}l=!0,D()}else l=!1;return l},t.$on("reloadFieldList",function(){t.show_preview_data(t.lastPreviewFilterData)}),t.displayRelationMap=function(){function e(){c(function(){t.relationView.view="path"},0),t.changeRelationView(),window.GOJS="GOJS"}var a={funcQueue:[],loadLibInProgress:!1};thirdPluginLoader({initFun:e,libSrc:"https://m1.bdp.cn/static/js/lib/go_latest_0d59d2c.js",libId:window.GOJS},a)},t.changeRelationView=function(){function e(e){function a(e,t,o,s){angular.forEach(t,function(t){l=n[t],i++,r.push(e?{key:String(i),parent:e,tb_id:l.tb_id,tb_name:l.title,tb_type:l.type,view_type:l.view_type,schema_total:l.data_count,update_status:l.status,update_time:l.utime,produce_type:o,level:s}:{key:String(i),tb_id:l.tb_id,tb_name:l.title,tb_type:l.type,view_type:l.view_type,schema_total:l.data_count,update_status:l.status,update_time:l.utime,produce_type:o,level:s}),l.dep_list&&l.dep_list.length>0&&a(String(i),l.dep_list,l.view_type,s+1)})}var r=[],i=0,o=e.start_node,n=e.nodes,l={};n[o].dep_list.length>0?(a("",[o],"",0),t.relationMapData=r):(t.hasRelationMap=!1,t.showRelationProduceLoading=!1);var s={},d=0;angular.forEach(r,function(e){s[e.level]=s[e.level]>0?s[e.level]+1:1}),angular.forEach(s,function(e){d=Math.max(d,e)}),angular.element("#show_relation_produce").height(70*d),setTimeout(function(){angular.element(".relation-node-message").css({display:"none"}),angular.element("#show_relation_produce").find("canvas").height(70*d)},10),t.$broadcast("showRelationMapData",t.relationMapData)}function i(e){var r=[],i=6,o=e.start_node,n=e.nodes,l=n[o];if(0==n[o].chart.length&&0==n[o].ref_list.length&&0==n[o].user.length&&0==n[o].user_group.length)return t.hasCurrentRelation=!1,void(t.showCurrentRelationLoading=!1);r.push({key:"1",tb_id:l.tb_id,name:l.title,tb_type:l.type,view_type:l.view_type,schema_total:l.data_count,update_status:l.status,update_time:l.utime,node_type:"table",produce_type:"",level:1}),n[o].ref_list.length>0&&r.push({key:"2",parent:"1",name:"zh"==a.language?"工作表":"table",produce_type:"zh"==a.language?"工作表":"table",node_type:"classify",level:2}),n[o].chart.length>0&&r.push({key:"3",parent:"1",name:"zh"==a.language?"图表":"Chart",produce_type:"zh"==a.language?"图表":"Chart",node_type:"classify",level:2}),n[o].user.length>0&&r.push({key:"4",parent:"1",name:"zh"==a.language?"用户":"User",produce_type:"zh"==a.language?"用户":"User",node_type:"classify",level:2}),n[o].user_group.length>0&&r.push({key:"5",parent:"1",name:"zh"==a.language?"组":"Group",produce_type:"zh"==a.language?"组":"Group",node_type:"classify",level:2}),angular.forEach(n[o].ref_list,function(e){l=n[e],r.push({key:String(i++),parent:"2",tb_id:l.tb_id,name:l.title,tb_type:l.type,view_type:l.view_type,schema_total:l.data_count,update_status:l.status,update_time:l.utime,produce_type:l.view_type,node_type:"table",level:3})}),angular.forEach(n[o].chart,function(e){r.push({key:String(i++),parent:"3",ct_id:e.ct_id,name:e.ct_name,dsh_id:e.dsh_id,dsh_name:e.dsh_name,proj_id:e.proj_id,proj_name:e.proj_name,produce_type:"",node_type:"chart",level:3})}),angular.forEach(n[o].user,function(e){r.push({key:String(i++),parent:"4",name:e,produce_type:"",node_type:"user",level:3})}),angular.forEach(n[o].user_group,function(e){r.push({key:String(i++),parent:"5",name:e,produce_type:"",node_type:"group",level:3})}),t.currentRelationData=r;var s={},d=0;angular.forEach(r,function(e){s[e.level]=s[e.level]>0?s[e.level]+1:1}),angular.forEach(s,function(e){d=Math.max(d,e)}),angular.element("#show_current_relation").height(60*d),c(function(){angular.element(".relation-node-message").css({display:"none"}),angular.element("#show_current_relation").find("canvas").height(60*d)},10),t.$broadcast("showCurrentRelationData",t.currentRelationData)}angular.element(".relation-node-message").css({display:"none"}),t.showRelationProduceLoading=!0,t.showCurrentRelationLoading=!0,t.hasRelationMap=!0,t.hasCurrentRelation=!0,r.tb.wholeJoinChain({tb_id:t.selected.tb_id}).then(function(a){t.hasRelationMap=!0,e(a.result)}),r.chart.wholeRelaChain({tb_id:t.selected.tb_id}).then(function(e){t.hasCurrentRelation=!0,i(e.result)})},t.hideRelationNodeMessage=function(){angular.element(".relation-node-message").css({display:"none"})};var M=0,q=angular.element(".tab-relation-list").width(),A=0,O=angular.element(".tab-relation-list").height();$(window).resize(function(){"path"==t.relationView.view&&setTimeout(function(){M=parseInt(angular.element(".tab-relation-list").width()),A=parseInt(angular.element(".tab-relation-list").height()),(Math.abs(M-q)>30||Math.abs(A-O)>30)&&(a.$broadcast("refresh-relation-path"),q=M,O=A)},200)}),t.show_relation_list=function(){t.previewData.table_preview_filter_loading=!1,t.previewData.table_preview_loading=!1,t.relation={},t.relationMapData=[],t.currentRelationData=[],t.relationView.view="list",r.chart.getRelationList(t.selected.tb_id).then(function(e){if(e){for(var r=e.chart,i="en"==$.cookie("locale")?"Untitled Chart":"未命名图表",o=r.length-1;o>=0;o--)""==r[o].ct_name&&(r[o].ct_name=i);t.relation.chart=e.chart,t.relation.wb=e.wb,t.relation.user=e.user,t.relation.user_group=e.user_group,("self"==t.selected.tb.tb_type||"public"==t.selected.tb.tb_type)&&e.refer_ds.length>0&&(t.relation.refer_ds=e.refer_ds);var n=t.relation;t.relation.isEmpty="admin"==a.role?0==n.chart.length&&0==n.wb.length&&0==n.user.length&&0==n.user_group.length:0==n.chart.length&&0==n.wb.length,T()&&F()}})},t.$on("jumpToDashChart",function(e,a){a&&t.jumpToDashChart(a)}),t.jumpToDashChart=function(e){a.global.rule_id="",a.wtbRelationSelectedItem={ct_id:e.ct_id};var t="";t=a.wsId?"/dash_edit_ws/"+a.wsId+"/"+e.proj_id+"/"+e.dsh_id:"/dash_edit/"+e.proj_id+"/"+e.dsh_id,l.path(t)},t.show_update_record=function(e){var a=t.selected.tb;if("access_tb"==a.tb_type)r.db.shareTbInfo({tb_id:a.tb_id}).then(function(e){0==e.status&&(t.tb_shareInfo=e.result)});else if("excel"==a.type){var i={tb_id:a.dstb_id};r.db.getUpdateRecord(i).then(function(e){t.updateRecord=e||{}})}else r.tb.getJoinInfo(a.tb_id).then(function(a){t.joinInfo=a||[],e&&t.errReport()});t.previewData.table_preview_filter_loading=!1,t.previewData.table_preview_loading=!1},t.opLogPage=function(e){var a={};e>0&&e<=t.updateRecord.op_log.pages_count&&(a={tb_id:t.selected.tb.dstb_id,query_type:"op_log",page:e},r.db.getUpdateRecord(a).then(function(e){t.updateRecord.op_log=e.op_log}))},t.fileListPage=function(e){var a={};e>0&&e<=t.updateRecord.file_list.pages_count&&(a={tb_id:t.selected.tb.dstb_id,query_type:"file_list",page:e},r.db.getUpdateRecord(a).then(function(e){t.updateRecord.file_list=e.file_list}))};var B=function(e){r.getTaskStatus(e).then(function(a){if(0==a.status){var r=a.result;0==r.status||3==r.status?c(function(){B(e)},1e3):2==r.status?(d(t.tips["wb.deleteFailed"]),t.previewData.table_preview_loading=!1):(t.previewData.table_preview_loading=!1,d(t.tips["wb.deleteSuccess"]),_(),t.showTab(t.activeTab.index))}})};t.deleteDstbFile=function(e){t.previewData.table_preview_loading||confirm(t.tips["wb.confirmDelete"])&&(t.previewData.table_preview_loading=!0,r.db.excelDelete({map_id:e.map_id,tb_id:t.selected.tb_id}).then(function(e){0==e.status?B(e.result):d(21==e.status?t.tips["wb.isUpdatingThen"]:t.tips["wb.deleteFailed"])}))},t.operatorMap=f,t.show_model_struct=function(){t.modelData={};var e=t.modelData;t.previewData.table_preview_loading=!0,r.tb.getModelStruct(t.selected.tb.tb_id).success(function(a){function r(){t.modelData.whereInfo={},t.modelData.diagram={},t.modelData.diagram.nodeDataArray=i.info.nodeDataArray,t.modelData.diagram.linkDataArray=i.info.linkDataArray,S(i.info.where,"join"),window.GOJS="GOJS"}if(t.previewData.table_preview_loading=!1,0==a.status){t.modelView={};var i=a.result,o=i.type;switch(o){case"aggr":e.whereInfo={},e.name=i.origin_name,t.modelData.info=angular.fromJson(i.info),S(i.info.where,"aggr");break;case"join":var n={funcQueue:[],loadLibInProgress:!1};thirdPluginLoader({initFun:r,libSrc:"https://m1.bdp.cn/static/js/lib/go_latest_0d59d2c.js",libId:window.GOJS},n);break;case"union":t.modelData.info=[],t.modelData.thead=[],t.modelData.whereInfo={},angular.forEach(i.table.fields,function(e){e.flag||t.modelData.thead.push(e)}),angular.forEach(i.info,function(e){e.origin_fields=e.fields.map(function(e){return e.nick_name=e.title,e});var a=e.selected_fields=[];angular.forEach(e.col_fid_list,function(t){a.push(t?x(e.fields,t):{})}),t.modelData.info.push(e)}),S(i.where,"union");break;case"script":var l=[];angular.forEach(t.originFolderList,function(e){angular.forEach(e.tb_list,function(e){l.push(e.name)})}),t.modelData.info=i.info,t.table_name_array=l}}})},t.closeDialog=function(){s.closeAll()},t.editTb=function(){var e=t.selected.tb,r="";switch(e.type){case"join":r="join_table";break;case"union":r="union_table";break;case"aggr":r="polymer_table";break;case"script":r="sql_table"}var i=a.wsId?"_ws_edit":"_edit";g.go(r+i,{wsId:a.wsId,tbId:e.tb_id})},t.createFieldFormula=function(){a.pageLoading=!0,t.newField={type:"create",name:"",aggregator:"",module:"wb",placeholder:1,is_display:!1};var e="/static/partials/add_field.html";s.open({template:e,data:{fieldList:t.previewData.origin_schema},className:"ngdialog-theme-default add-field-dialog",scope:t})},t.modifyField=function(e){a.pageLoading=!0,t.newField=angular.extend({aggregator:e.row_aggregator,original_field_name:e.name,placeholder:1,module:"wb"},e,{type:"modify",data_type:t.fieldTypeMap[e.type]});var r="/static/partials/add_field.html";s.open({template:r,data:{fieldList:t.previewData.origin_schema},className:"ngdialog-theme-default add-field-dialog",scope:t})},t.addCalcField=function(e){t.global.clickComplete=!1,$("#tb-detail").css("padding-top","48px");var i=!1;if(e.name?e.data_type||e.param?e.aggregator.trim()||e.param&&"group"==e.param.type||(d(t.tips["field.fieldFormulaRequired"]),i=!0):(d(t.tips["field.fieldTypeRequired"]),i=!0):(d(t.tips["field.fieldNameRequired"]),i=!0),i)return t.global.clickComplete=!0,!1;a.pageLoading=!0;var o="create"==e.type?t.tips["field.addFieldSuccess"]:t.tips["field.modifyFieldSuccess"];r.field["create"===e.type?"create":"modify"]({tb_id:t.selected.tb.tb_id,original_field_name:e.original_field_name||"",new_field_name:e.name,aggregator:e.aggregator.trim(),data_type:e.data_type,flag:1,fid:e.fid||"",is_display:e.is_display?1:0}).success(function(e){if(a.pageLoading=!1,t.global.clickComplete=!0,0==e.status){t.showTab(1),s.closeAll();var r=s.open({template:"/static/partials/dialogTemplates/alert_success.html",scope:t,className:"ngdialog-theme-default ngDialog-width-300",data:{message:o},preCloseCallback:function(){c.cancel(i)}}),i=c(function(){s.close(r)},3e3)}else if("7200"==e.status)d(t.tips["field.formulaInvalid"]);else if("40005"==e.status)d(e.errstr);else{var n=Number(e.status);d(n)}})},t.delNewField=function(e,a){s.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t,data:{message:t.tips["chart.delField"]+": "+e+" ?"}}).then(function(){r.field.del(a,t.selected.tb.tb_id).success(function(e){0==e.status?(_(),t.showTab(1)):"7590"==e.status?d(t.tips["chart.fieldInUsing"]):"40006"==e.status?d(e.errstr):errorHandle(e)
})})},t.checkUnreadTbInFolder=function(e,a){var r=0,i=0,o=0;if(e)for(r=0;r<a.length;r++){if(a[r].folder_id==e){for(a[r].has_unread=!1,o=0;o<a[r].tb_list.length;o++)if(("access_tb"==a[r].tb_list[o].tb_type||"public"==a[r].tb_list[o].tb_type)&&0==a[r].tb_list[o].tb_status){a[r].has_unread=!0;break}break}if(a[r].sub_folders&&a[r].sub_folders.length>0)for(i=0;i<a[r].sub_folders.length;i++)if(a[r].sub_folders[i].folder_id==e){for(a[r].sub_folders[i].has_unread=!1,a[r].has_unread=!1,o=0;o<a[r].sub_folders[i].tb_list.length;o++)if(("access_tb"==a[r].sub_folders[i].tb_list[o].tb_type||"public"==a[r].sub_folders[i].tb_list[o].tb_type)&&0==a[r].sub_folders[i].tb_list[o].tb_status){a[r].sub_folders[i].has_unread=!0,a[r].has_unread=!0;break}break}}else for(r=0;r<a.length;r++){if(a[r].has_unread=!1,a[r].sub_folders&&a[r].sub_folders.length>0)for(i=0;i<a[r].sub_folders.length;i++)for(a[r].sub_folders[i].has_unread=!1,o=0;o<a[r].sub_folders[i].tb_list.length;o++)if(("access_tb"==a[r].sub_folders[i].tb_list[o].tb_type||"public"==a[r].sub_folders[i].tb_list[o].tb_type)&&0==a[r].sub_folders[i].tb_list[o].tb_status){a[r].sub_folders[i].has_unread=!0,a[r].has_unread||(a[r].has_unread=!0);break}if(a[r].tb_list&&a[r].tb_list.length>0)for(o=0;o<a[r].tb_list.length;o++)if(("access_tb"==a[r].tb_list[o].tb_type||"public"==a[r].tb_list[o].tb_type)&&0==a[r].tb_list[o].tb_status&&!a[r].has_unread){a[r].has_unread=!0;break}}t.$$phase||t.$apply()},t.show_table=function(e,i){if(a.global.tbEditting=!1,t.relationView.view="list",t.relationMapData=[],t.currentRelationData=[],t.selected.tb_id!=e.tb_id&&($("#tb-detail").css("padding-top","48px"),$("#FieldScreen").css("margin-top",0)),t.showDetailPage(e,!1,i),F(),("access_tb"==e.tb_type||"public"==e.tb_type)&&0==e.tb_status){t.updateTbList("changeStatus",e,"tb_status");var o={tb_id:e.tb_id,tb_status:angular.toJson({tb_status:1})};r.folder.modify_folder_rel(o).then(function(a){0==a.status?t.refreshSpecificFolderContent(e.tb_id).then(function(){var a=bdp.bdpTables.getFolderByTableId(t.folderStructure,e.tb_id);t.checkUnreadTbInFolder(a.folder_id,t.folderStructure)}):d(+a.status,{warn_msg:a.errstr})})}},t.$on("skipTargetTable",function(e,a){a&&t.refreshSpecificFolderContent(a).then(function(){var e=bdp.bdpTables.getTableByTableId(t.folderStructure,a);t.show_table(e),t.refreshFolderStatus()})}),t.show_table_by_id=function(e){function a(i){for(var o=0,n=i.length;n>o;o++){for(var l=0,s=i[o].tb_list.length;s>l;l++)if(e==i[o].tb_list[l].tb_id){r=i[o].tb_list[l],t.setUnFoldingStatus(i[o],!0);break}i[o].sub_folders&&i[o].sub_folders.length>0&&a(i[o].sub_folders)}}var r={};a(t.original_folderList),r||(r=t.getFirst(t.original_folderList)),t.changeFolderOpenStatus(t.folderList),t.show_table(r)},t.partitionData={field_list:[],field_id:"",data_type:"string",granularity:"month",empty_field:!1,set:!1,match_error:!1,readonly:!1},t.set_partition_view="preview",t.show_set_partition=function(){t.preparePartitionData(),s.open({template:"/static/partials/dialogTemplates/worktable_partition_set.html",className:"ngdialog-theme-default ng-ds-dialog partition-set-dialog",scope:t})},t.triggerFullUpdate=function(){s.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-400",scope:t,data:{message:"wb.fullUpdate.doubleCheck",preformat:!0}}).then(function(){r.tb.triggerFullUpdate({tb_id:t.selected.tb.tb_id}).success(function(e){0==e.status?t.get_status(1):d(e.errstr)})})},t.updatePartitionData=function(e){"string"==typeof e&&(e=angular.fromJson(e)),e=e||{},"string"==typeof e.param&&(e.param=angular.fromJson(e.param)),e.param=e.param||{},t.partitionData={field_list:[],field_id:e.base_field,data_type:e.param.type||"",granularity:e.param.option||"",empty_field:!1,set:!!e.base_field,match_error:!1,readonly:e.readonly}},t.preparePartitionData=function(){function e(){angular.forEach(t.partitionData.field_list,function(e){e.field_id==t.partitionData.field_id&&(a=!0,e.data_type!=t.partitionData.data_type&&(t.partitionData.data_type=e.data_type,t.partitionData.granularity="string"==e.data_type?"":"month"))})}t.partitionData.field_list=[],angular.forEach(t.previewData.origin_schema,function(e){e.hasOwnProperty("flag")&&1==e.flag||(2==e.type||3==e.type?t.partitionData.field_list.push({field_id:e.field_id,name:e.name,data_type:2==e.type?"string":"date"}):e.field_id==t.partitionData.field_id&&t.partitionData.readonly&&t.partitionData.field_list.push({field_id:e.field_id,name:e.name,data_type:"number"}))});var a=!1;t.partitionData.match_error=!1,t.partitionData.set?(t.set_partition_view="edit",e(),t.partitionData.match_error=!a):t.set_partition_view="preview"},t.changePartitionField=function(e,a){for(var r=angular.copy(t.partitionData.field_list),i=0,o=r.length;o>i;i++)if(r[i].field_id==a){("date"==r[i].data_type||"string"==r[i].data_type)&&(t.partitionData.data_type="string"==r[i].data_type?"string":"date",t.partitionData.granularity="string"==r[i].data_type?"":"month");break}t.partitionData.match_error=!1},t.beginSetPartition=function(){if(t.set_partition_view="edit",t.partitionData.field_list.length>0){if(t.partitionData.empty_field=!1,!t.partitionData.field_id){var e=t.partitionData.field_list[0];t.partitionData.field_id=e.field_id,t.partitionData.data_type=e.data_type,"date"==e.data_type&&(t.partitionData.granularity="month")}}else t.partitionData.empty_field=!0},t.setPartitionDone=!0,t.saveSetPartition=function(){if(t.setPartitionDone){var e="";"date"==t.partitionData.data_type&&(e=t.partitionData.granularity);var i={tb_id:t.selected.tb_id,base_field:t.partitionData.field_id,param:{type:t.partitionData.data_type,option:e}};i.param=angular.toJson(i.param),t.setPartitionDone=!1,r.tb.partitionSet(i).then(function(e){t.setPartitionDone=!0,0==Number(e.status)?(t.partitionData.set=!0,d(t.tips.saveSuccess),s.closeAll()):90005==e.status?(a.global.hint="",s.closeAll()):d(Number(e.status))})}},t.delSetPartition=function(){var e={tb_id:t.selected.tb_id};r.tb.partitionDel(e).then(function(e){0==e.status?(t.partitionData.set=!1,d(t.tips.delSuccess),s.closeAll()):d(90004==e.status?t.tips["wb.transform.cantDelPartIncre"]:Number(e.status))})},t.selectRplaceType=function(){s.open({template:"/static/js/worktable/pageUpload/select_replace_type.html",className:"ngdialog-theme-default ngDialog-width-420",scope:t})},t.singleReplace=function(){if(t.selected.tb){var e={tb_id:t.selected.tb.tb_id,is_whole:!0};r.db.getUpdateRecord(e).then(function(e){t.updateRecordUpload=e||{},s.closeAll(),s.open({template:"/static/js/worktable/pageUpload/single_replace.html",className:"ngdialog-theme-default ngDialog-width-650",scope:t})})}},t.toUploadFile=function(e,a){switch(e){case"add":l.path("/page_upload/"+e);break;case"append":l.path("/page_upload/"+e+"/"+t.selected.tb.dstb_id);break;case"replace":l.path("/page_upload/"+e+"/"+t.selected.tb.dstb_id);break;case"singleReplace":l.path("/page_upload/"+e+"/"+t.selected.tb.dstb_id+"/"+a.map_id)}s.closeAll()},t.show_merge_view=function(e){s.closeAll();var t=a.wsId,r=t?e+"_ws":e;g.go(r,{wsId:t})},t.uploadOption={},t.isOpeningAddDb=!1,t.show_add_db=function(e){if(!t.isOpeningAddDb){t.isOpeningAddDb=!0,t.uploadOption.method=e,t.uploadOption.default_tb=e?t.selected.tb.dstb_id:void 0;var r="";r=a.wsId&&a.wsId&&1===a.is_extrace?"ngDialog-width-520":"ngDialog-width-520",e||(!t.uploadOption.method&&"s_admin"==a.role&&!a.wsId||!a.wsId&&1===a.is_extrace?r="ngDialog-width-650":a.wsId||0!==a.is_extrace?a.wsId&&0===a.is_extrace&&(r="ngDialog-width-520"):r="ngDialog-width-520"),t.workdListView="folderList",t.dialogTitle=t.tips["wb.addWorkSheetType"],t.uploadDialg=s.open({template:"/static/partials/upload-data.html",className:"ngdialog-theme-default ng-ds-dialog "+r,scope:t}),c(function(){t.isOpeningAddDb=!1},500)}},t.down_menu={down_menu:!1},t.batch_append_db=function(e){t.uploadOption.method=e,t.uploadOption.default_tb=e?t.selected.tb.dstb_id:void 0,s.open({template:"/static/partials/dialogTemplates/batch_data.html",className:"ngdialog-theme-default ng-ds-dialog ng-ds-add-dialog",scope:t})},t.parse_url=function(){l.path(o.wsId?"/parse_url_ws/"+o.wsId+"/"+t.selected.tb.tb_id:"/parse_url/"+t.selected.tb.tb_id)},t.merge_field=function(){l.path(o.wsId?"/merge_field_ws/"+o.wsId+"/"+t.selected.tb.tb_id:"/merge_field/"+t.selected.tb.tb_id)},t.generate_coordinate_check_length=function(){t.previewData.field_data_total<=2e5?t.generate_coordinate():s.openConfirm({templateUrl:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-320",data:{title:t.tips.tips,message:t.tips["wb.rowLengthExceed"],okValue:t.tips["wb.gotIt"],hideCancel:!0}})},t.generate_coordinate=function(){$.cookie("generate_coordinate_showed")?t.open_generate_coordinate_dialog():s.openConfirm({templateUrl:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-320 dialog-coordinate-use-guide",data:{title:t.tips["wb.useGuide"],message:t.tips["wb.useGuideContent"],okValue:t.tips["wb.gotIt"],hideCancel:!0}}).then(function(){$.cookie("generate_coordinate_showed",1),t.open_generate_coordinate_dialog()})},t.generate_coordinate_suc_hint=function(){s.openConfirm({templateUrl:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-320",data:{message:t.tips["wb.firstGenerateSuccessHint"],okValue:t.tips["wb.gotIt"],hideCancel:!0}})},t.open_generate_coordinate_dialog=function(){1==t.previewData.has_gis?s.openConfirm({templateUrl:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-320",data:{message:t.tips["wb.coordinateGeneratedHint"]}}):3==t.previewData.has_gis?s.openConfirm({templateUrl:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-320",data:{message:t.tips["wb.coordinateAlreadyGenerating"]}}):(t.fieldToGenerate="",s.openConfirm({templateUrl:"/static/partials/dialogTemplates/generate_coordinate.html",className:"ngdialog-theme-default ngDialog-width-320 ngdialog-generate-coordinate",scope:t,data:{fieldToGenerate:""}}))},t.sendCoordinateTransfer=function(e){if(!e.fieldToGenerate)return d(t.tips["wb.selectFieldToGenerate"]),!1;var i={tb_id:t.selected.tb_id,field_id:e.fieldToGenerate};a.wsId&&(i.wsId=a.wsId),r.tb.gisTransfer(i).then(function(e){0==e.status&&($.cookie("generate_coordinate_showed")?(s.closeAll(),t.show_preview_data()):t.generate_coordinate_suc_hint())})},t.$on("$destroy",function(){$(window).off("resize.alignTable"),t.selected.status.timer&&(clearTimeout(t.selected.status.timer),delete t.selected.status.timer)}),t.preview={send:!0,showErrorReport:!1},t.errReport=function(){var e=t.selected.tb_id,i=t.preview;i.send&&(a.pageLoading=!0,r.tb.getJoinProfileReport(e).then(function(e){0==e.status&&(t.preview.report=e.result,i.send=!1),t.preview.showErrorReport=!0,a.pageLoading=!1}))},t.exportExcel=function(){Highcharts.post("/api/wb/profile_export",{tb_id:t.selected.tb_id})},t.checkNoTable=bdp.bdpTables.checkNoTableInFolder,t.getFolderStructure=function(e){return t.loadingFolderStructure=!0,e?(e.tb_list=JSON.stringify(e.tb_list),r.folder.getStructureWithTableList(e).then(E).then(function(){t.folderStructure.forEach(function(e){e.open=!1,"folder_root"!=e.folder_id&&(e.tb_list.length>0&&(e.open=!0,e.unfolded=!0),e.sub_folders.forEach(function(t){t.tb_list.length>0&&(t.unfolded=!0,t.open=!0,e.open=!0)}))})})):r.folder.getStructure()},t.refreshFolderStatus=function(){function e(t){t.forEach(function(e){e.folder_id==r&&(e.open=!0),e.tb_list.forEach(function(e){"self"!=e.tb_type&&"public"!=e.tb_type||"ds"!=e.type&&"public"!=e.type&&"opends"!=e.type||(i=!0)}),e.sub_folders&&e.sub_folders.forEach(function(t){t.folder_id==r&&(t.open=!0,e.open=!0),t.tb_list.forEach(function(e){"self"!=e.tb_type&&"public"!=e.tb_type||"ds"!=e.type&&"public"!=e.type&&"opends"!=e.type||(i=!0)})})}),angular.forEach(t,function(t){t.folder_id==r&&(t.open=!0),angular.forEach(t.tb_list,function(e){"self"!=e.tb_type&&"public"!=e.tb_type||"ds"!=e.type&&"public"!=e.type&&"opends"!=e.type||(i=!0)}),t.sub_folders&&t.sub_folders.length>0&&e(t.sub_folders)})}var a=bdp.bdpTables.getFolderByTableId(t.folderStructure,t.selected.tb_id);t.setUnFoldingStatus(a,!0),t.changeFolderOpenStatus(t.folderStructure);var r=$.cookie("select_folder_id"),i=!1;e(t.folderStructure),t.current_pos>0?c(function(){$("#ds-list > ul")[0].scrollTop=t.current_pos},100):c(I,100)},C(),t.refreshSpecificFolderContent=function(e){return r.folder.getTableSiblings({tb_id:e}).then(function(e){t.folderStructure.every(function(a){return a.folder_id==e.result.folder_id?(a.tb_list=e.result.tb_list,!1):("folder_root"!=a.folder_id&&a.sub_folders.every(function(a){return a.folder_id==e.result.folder_id?(a.tb_list=e.result.tb_list,t.getWorktableFromFolder({folder_id:a.parent_id}),!1):!0}),!0)})})},t.getFirst=function(e){for(var t="",a=0,r=e.length;r>a;a++){if(e[a].tb_list.length>0){t=e[a].tb_list[0];break}if(e[a].sub_folders&&e[a].sub_folders.length>0){for(var i=0,o=e[a].sub_folders.length;o>i;i++)if(e[a].sub_folders[i].tb_list.length>0){t=e[a].sub_folders[i].tb_list[0];break}if(t)break}}return t},t.getWorktableFromFolder=function(e){return e.unfolded?!1:(e.loadingWorktables=!0,r.folder.getWorktable({folder_id:e.folder_id}).then(function(a){e.loadingWorktables=!1,console.log(t.folderStructure),t.folderStructure.forEach(function(t){t.folder_id==e.folder_id&&0==t.tb_list.length&&(a.result.forEach(function(e){t.tb_list.push(e)}),t.unfolded=!0,t.open=!0),"folder_root"!=t.folder_id&&t.sub_folders&&t.sub_folders.forEach(function(r){r.folder_id==e.folder_id&&0==r.tb_list.length&&(a.result.forEach(function(e){r.tb_list.push(e)}),r.unfolded=!0,r.open=!0,t.open=!0)})})}))},t.show_field_set=function(){t.fieldSet={schema:null,editFlag:!1,origin_schema:null},t.previewData.table_preview_loading=!0,t.previewData.table_preview_filter_loading=!1,P(t.selected.tb_id)},t.field_set_save=function(){var e=j();e.length>0?r.tb.modify(angular.toJson(e)).then(function(a){0==a.status?(angular.forEach(e,function(e){angular.forEach(t.fieldSet.origin_schema,function(t){t.field_id==e.fid&&(e.type&&(t.type=e.type),null!=e.remark&&(t.remark=e.remark),e.fid_name&&(t.title=e.fid_name))})}),t.fieldSet.schema=angular.copy(t.fieldSet.origin_schema),t.fieldSet.editFlag=!t.fieldSet.editFlag):d(a.errstr)}):(t.fieldSet.editFlag=!t.fieldSet.editFlag,t.fieldSet.schema=angular.copy(t.fieldSet.origin_schema))},t.field_set_cancel=function(){t.fieldSet.schema=angular.copy(t.fieldSet.origin_schema)},p(["tips","saveSuccess","delSuccess","wb.isUpdatingWaiting","wb.updateFailed","wb.deleteFailed","wb.deleteSuccess","wb.confirmDelete","wb.isUpdatingThen","chart.delField","field.fieldNameRequired","field.fieldTypeRequired","field.fieldFormulaRequired","field.addFieldSuccess","field.modifyFieldSuccess","field.formulaInvalid","chart.fieldInUsing","chart.untitledChart","dash.titleRequired","wb.loadFailed","wb.selectWorkSheet","emptyProjectAndCreate","emptyDashboardAndCreate","wb.filterTip","wb.joinFailed","wb.joinWarning","wb.joinKeyField","wb.joinOr","wb.joinErrorLog","wb.joinWarnSure","wb.joinFailedModify","wb.addWorkSheetType","wb.useGuide","wb.useGuideContent","wb.firstGenerateSuccessHint","wb.gotIt","wb.coordinateAlreadyGenerating","wb.coordinateGenerateFailed","wb.selectFieldToGenerate","wb.coordinateGeneratedHint","wb.transform.cantDelPartIncre","wb.rowLengthExceed","wb.tableCapacity.used","wb.tableCapacity.capacity","wb.tableCapacity.clickDetail"],t)}window.isIE?5:getScrollbarWidth(),angular.module("BC.controllers.dataSource",[]).controller("WorktableCtrl",t).directive("resizeDatasourceList",function(){return{link:function(t,a){var r=100,i=300;if(localStorage){var o=localStorage.getItem("ds_tree_width");o&&setTimeout(function(){$(".ds-aside").css("width",o+"px"),$(".ds-main").css("left",o+"px")},10)}a.on("mousedown",function(t){var a=$(".ds-aside"),o=$(".ds-main"),n=t.pageX-a.outerWidth();t.preventDefault(),$(document).on("mousemove.drag_data_source",function(e){var t=e.pageX-n;t=Math.max(r,t),t=Math.min(i,t),a.css("width",t+"px"),o.css("left",t+"px")}),$(document).on("mouseup.drag_data_source",function(){e(angular.element("#tb-detail-table")),e(angular.element("#J_edit_field_detail_table"),angular.element("#J_edit_field_header")),localStorage&&localStorage.setItem("ds_tree_width",a.width()),$(document).off("mousemove.drag_data_source"),$(document).off("mouseup.drag_data_source")})})}}}),t.$inject=["$scope","$rootScope","commonService","commonHttp","$stateParams","operatorHelpLink","$location","ngDialog","errHint","$timeout","$filter","filterOperatorMap","$jsTipTranslate","$state"]}(),angular.module("BC.controllers.dataSource").controller("pageUploadCtrl",["$scope","$rootScope","commonService","$location","errHint","$timeout","Upload","ngDialog","$stateParams","$jsTipTranslate","capacityHint","operatorHelpLink","$http",function(e,t,a,r,i,o,n,l,s,d,c,u){function f(){var t={};switch(e.uploadOption.method){case"add":e.geHelpAdress="fileUpload",e.uploadStepTips=[e.tips["upload.supportFile"],e.tips["upload.supportBatch"]],e.ACCEPTFILENUM=5,e.uploadOption.pageTitle=e.tips["upload.uploadData"],t=[{name:"step1UploadFile",text:e.tips["upload.uploadFiles"],active:!0},{name:"step2PreviewData",text:e.tips["upload.previewData"],active:!1},{name:"step3WorktableSet",text:e.tips["upload.worktableSet"],active:!1}];break;case"replace":e.geHelpAdress="fileReplace",e.uploadStepTips=[e.tips["upload.supportFile"]],e.ACCEPTFILENUM=1,e.uploadOption.pageTitle=e.tips["wb.replaceAll"],t=[{name:"step1UploadFile",text:e.tips["upload.uploadFiles"],active:!0},{name:"step2PreviewSingData",text:e.tips["upload.previewData"],active:!1},{name:"step3adjustThead",text:e.tips["upload.worktableSet"],active:!1}];break;case"append":e.geHelpAdress="fileAppend",e.uploadStepTips=[e.tips["upload.supportFile"]],e.ACCEPTFILENUM=1,e.uploadOption.pageTitle=e.tips["wb.appendData"],t=[{name:"step1UploadFile",text:e.tips["upload.uploadFiles"],active:!0},{name:"step2PreviewSingData",text:e.tips["upload.previewData"],active:!1},{name:"step3adjustThead",text:e.tips["upload.worktableSet"],active:!1}];break;case"singleReplace":e.geHelpAdress="fileReplace",e.uploadStepTips=[e.tips["upload.supportFile"]],e.ACCEPTFILENUM=1,e.uploadOption.pageTitle=e.tips["wb.singleFileRplace"],t=[{name:"step1UploadFile",text:e.tips["upload.uploadFiles"],active:!0},{name:"step2PreviewSingData",text:e.tips["upload.previewData"],active:!1},{name:"step3adjustThead",text:e.tips["upload.worktableSet"],active:!1}]}return t}function p(a){angular.forEach(e.uploadSteps,function(r,i){a==i+1?(3==t.enterprise_type&&1==i&&"add"==e.uploadOption.method&&2==t.guide&&e.$emit("okToGuide","CustomPreviewUplpadData"),r.active=!0):r.active=!1})}function g(){e.tableExample={thead:["序号","拜访人","员工编号","部门","职位","拜访日期","拜访时间","客户类型","进展"],tbody:[["乔歆然","600001","销售一部","销售总监","2016/8/8","11:23","互联网","初次拜访"],["丘慧美","600002","销售一部","销售总监","2016/8/8","14:43","电商","初次拜访"],["束怜烟","600003","销售一部","销售总监","2016/8/8","16:34","商贸","初次拜访"]]},setTimeout(function(){for(var e=$(".j-table-example").children("tbody").children("tr:first").children("td"),t=$(".j-tips-head").children("li"),a=0,r=e.length;r>a;a++)t[a].style.width=e[a].offsetWidth+"px"},50),e.uploadExcelList={list:[],files:[],completeLength:0,needLength:0,invalidFiles:[]},e.selectAll=!1,e.completeExcelList=[],e.previewTable={theadObj:[],tbody:[],sheetName:null,offsetLine:null,errMsg:null,table_info:{folder_id:null,folder_name:null,excelId:null,tableName:null,originalName:null,label:null,comment:null},cleanInfo:{col_offset:null,column:null,row:null,row_offset:null}},o(function(){e.uploadSteps=f()},0),e.csv_terminate={value:"comma",otherValue:""}}function h(e){var t="",a=[];if(e.length>2&&"/"===e[0]&&"/"===e[e.length-1])t=e.substring(1,e.length-1);else{var r=e.split(",");if(r.length>1)for(var i=0;i<r.length;i++){var o=h(r[i]);o.regexp?(t+="("+o.regexp+")",i<r.length-1&&(t+="|")):a=a.concat(o.excludes)}else 0===e.indexOf("!")?a.push("^((?!"+h(e.substring(1)).regexp+").)*$"):(0===e.indexOf(".")&&(e="*"+e),t="^"+e.replace(new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g"),"\\$&")+"$",t=t.replace(/\\\*/g,".*").replace(/\\\?/g,"."))}return{regexp:t,excludes:a}}function b(e,t){if(!t)return!0;var a=h(t),r=!0;if(a.regexp&&a.regexp.length){var i=new RegExp(a.regexp,"i");r=null!=e.type&&i.test(e.type)||null!=e.name&&i.test(e.name)}for(var o=a.excludes.length;o--;){var n=new RegExp(a.excludes[o],"i");r=r&&(null==e.type||n.test(e.type))&&(null==e.name||n.test(e.name))}return r}function _(a){if(3==t.enterprise_type){for(var r=0,i=0;i<a.length;i++){var o=t.personalInfo,n=o.capacity_info.capacity;if(r+=a[i].size,"personal"==t.global.domain&&"replace"!=e.uploadOption.method&&r/1024/1024+o.capacity_info.used>n)return c(),!1}return e.$$phase||e.$digest(),!0}return!0}function m(t){for(var a=0;a<t.length;a++)if(/\.csv$/.test(t[a].name))return l.open({template:"/static/js/worktable/pageUpload/csv_set.html",className:"ngdialog-theme-default ngDialog-width-480",showClose:!1,scope:e,data:{files:t}}),!1;return!0}function v(t){angular.forEach(t,function(t){e.uploadExcelList.list.push({excelId:null,fileName:t.name,cancel:!1,progress:0,errMsg:null,abort:null})}),e.uploadExcelList.needLength=e.uploadExcelList.list.length,angular.forEach(t,function(t,a){t.upload=n.upload({url:"/api/excel/upload",method:"POST",data:{key:t.name,"Content-Type":null===t.type||""===t.type?"application/octet-stream":t.type,filename:t.name,file:t,field_terminate:/\.csv$/.test(t.name)?e.csv_terminate.value:void 0}}),e.uploadExcelList.list[a].abort=t.upload,t.upload.then(function(r){o(function(){0==r.data.status?(t.result=r.data,e.uploadExcelList.list[a].excelId=r.data.result.excel_id,e.uploadExcelList.list[a].progress=100,e.uploadExcelList.completeLength+=1,e.uploadExcelList.completeLength==e.uploadExcelList.needLength&&w()):(i(t.name+r.data.errstr),t.result=r.data,e.uploadExcelList.list[a].progress=100,e.uploadExcelList.completeLength+=1,e.uploadExcelList.completeLength==e.uploadExcelList.needLength&&w())})},function(){e.uploadExcelList.needLength-=1,e.uploadExcelList.completeLength==e.uploadExcelList.needLength&&w()}),t.upload.progress(function(r){t.progress=Math.min(95,parseInt(100*r.loaded/r.total)),e.uploadExcelList.list[a].progress=t.progress})})}function w(){if(t.pageLoading=!0,angular.forEach(e.uploadExcelList.list,function(t){!t.cancel&&t.excelId&&e.completeExcelList.push({excelId:t.excelId,excelName:t.fileName.slice(0,t.fileName.lastIndexOf(".")),sheetList:[]})}),0==e.completeExcelList.length&&o(function(){return t.pageLoading=!1,g(),!1},100),0==e.completeExcelList.length)return!1;if(1==e.completeExcelList.length){var r={excel_id:e.completeExcelList[0].excelId};a.db.uploadPreview(r,!0).then(function(a){if(0==a.status){var r=a.result;if(angular.forEach(r,function(t,a){e.completeExcelList[0].sheetList.push({theadObj:t.schema,tbody:t.data,sheetName:t.name,offsetLine:t.row_offset?t.row_offset:0,errMsg:t.errmsg,table_info:{sheetId:a,folder_id:"folder_root",folder_name:"en"==$.cookie("locale")?"Root":"根目录",excelId:e.completeExcelList[0].excelId,tableName:$.trim(e.completeExcelList[0].excelName)+"-"+t.name,originalName:e.completeExcelList[0].excelName,label:"",comment:""},cleanInfo:{col_offset:t.col_offset,column:t.column,row:t.row,row_offset:t.row_offset}})}),e.completeExcelList[0].sheetList.length>1){for(var o=0,n=0;n<e.completeExcelList[0].sheetList.length;n++)e.completeExcelList[0].sheetList[n].errMsg||(0==o&&(e.completeExcelList[0].sheetList[n].check=!0),o+=1);if(1==o&&(e.selectAll=!0),"add"==e.uploadOption.method)l.open({template:"/static/js/worktable/pageUpload/select_sheet.html",className:"ngdialog-theme-default ngDialog-width-520",scope:e,showClose:!1});else{for(var n=0;n<e.completeExcelList[0].sheetList.length;n++)e.completeExcelList[0].sheetList[n].errMsg||(e.completeExcelList[0].sheetList[n].check=!0);e.confirmCreateExcel("sheet")}}else if(e.completeExcelList[0].sheetList[0].errMsg)y();else{var s=e.completeExcelList[0].sheetList[0].table_info.tableName;e.completeExcelList[0].sheetList[0].table_info.tableName=s.slice(0,s.lastIndexOf("-"+e.completeExcelList[0].sheetList[0].sheetName)),e.confirmCreateExcel("excel")}t.pageLoading=!1}else t.pageLoading=!1,g(),i(a.errstr)})}else{var n=e.completeExcelList.length,s=0;angular.forEach(e.completeExcelList,function(e){var r={excel_id:e.excelId};a.db.uploadPreview(r,!1).then(function(a){if(0==a.status){var r=a.result[0];e.sheetList.push({theadObj:r.schema,tbody:r.data,sheetName:r.name,offsetLine:r.row_offset?r.row_offset:0,errMsg:r.errmsg,table_info:{sheetId:0,folder_id:"folder_root",folder_name:"en"==$.cookie("locale")?"Root":"根目录",excelId:e.excelId,tableName:$.trim(e.excelName),originalName:e.excelName,label:"",comment:""},cleanInfo:{col_offset:r.col_offset,column:r.column,row:r.row,row_offset:r.row_offset}}),s+=1,s==n&&(t.pageLoading=!1,y())}else e.sheetList.push({errMsg:a.errstr,table_info:{sheetId:0,folder_id:"folder_root",folder_name:"en"==$.cookie("locale")?"Root":"根目录",excelId:e.excelId,tableName:e.excelName,originalName:e.excelName,label:"",comment:""}}),s+=1,s==n&&(t.pageLoading=!1,y())})})}}function y(){var t="",a=0,r=[];return angular.forEach(e.completeExcelList,function(e){var t=e.sheetList[0];t.errMsg&&(r.push(t.table_info.tableName),a+=1)}),a==e.completeExcelList.length?(i(1==a?e.completeExcelList[0].sheetList[0].errMsg:e.tips["upload.parseFailedToUploadFailed"]),g(),!1):void(r.length>0?(t+='"'+r.join('"、"')+'"'+e.tips["upload.parseFailedToContinue"],l.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:t}}).then(function(){e.confirmCreateExcel("excel")},function(){g()})):e.confirmCreateExcel("excel"))}function D(){e.taskList={list:[],completeTaskLength:0,errMsg:null},p(2)}function T(){e.createTableList={readyLength:0,completeCreatTbLength:0},e.taskList={list:[],completeTaskLength:0,errMsg:null},e.changeTableInfo("sheet",e.completeExcelList[0].sheetList[0]),p(3)}function F(){for(var t=0;t<e.completeExcelList.length;t++)for(var a=0;a<e.completeExcelList[t].sheetList.length;a++)if(!e.completeExcelList[t].sheetList[a].table_info.tableName)return!1;return!0}function k(){e.createTableList.completeCreatTbLength+=1,e.createTableList.completeCreatTbLength==e.createTableList.readyLength&&(3==t.enterprise_type&&(t.$emit("changeCapacity","change"),2==t.guide&&e.$emit("okToGuide","createDb")),$.cookie("ds_tb_id",e.table_info.tb_id),t.pageLoading=!1,r.path("/data_source"))}function L(){a.db.getSchema(e.uploadOption.default_tb).then(function(a){if(0!=a.status)return i(a.errstr),!1;angular.forEach(a.result.fields,function(t){t.flag||e.adjustTheadData.oldThead.push({remark:t.remark,uniqIndex:t.uniq_index,fieldId:t.field_id,name:t.name,title:t.title,type:t.type,seqNo:t.seq_no,hasSelect:!1,add:!1,del:!1})});var r=e.adjustTheadData.oldThead,o=e.adjustTheadData.newThead,n=e.adjustTheadData.uploadThead,l={},s=r.length;n.length<r.length&&(e.adjustTheadData.lessThead=r.length-n.length);for(var d=0;s>d;d++)o.push({title:null,type:999,del:!1,diffType:null,index:d});for(var d=0,c=r.length;c>d;d++)l[r[d].title]=d;for(var u=0,c=n.length;c>u;u++)"number"==typeof l[n[u].name]&&(n[u].hasSelect=!0,o[l[n[u].name]].title=n[u].name,o[l[n[u].name]].type=n[u].type,N(r[l[n[u].name]],o[l[n[u].name]]));e.adjustTheadData.uploadThead.unshift({name:null,type:999,del:!1}),t.pageLoading=!1,p(3)})}function S(){var t={};return angular.forEach(e.adjustTheadData.oldThead,function(a,r){a.del||(t[a.title]=e.adjustTheadData.newThead[r].title)}),t}function x(){var t=[];return angular.forEach(e.adjustTheadData.uploadThead,function(e){!e.hasSelect&&e.add&&t.push(e.name)}),t}function E(){var t=[];return angular.forEach(e.adjustTheadData.oldThead,function(e){e.del&&t.push(e.title)}),t}function C(e,t){var a={dateDiff:[],diffArray:[]};return angular.forEach(e,function(e,r){e.type!=t[r].type&&t[r].title&&999!=t[r].type&&(a.diffArray.push(r),3==e.type&&a.dateDiff.push(e.title))}),a}function N(e,t){e.type!=t.type&&t.title&&999!=t.type?(t.diffType="warming",3==e.type&&(t.diffType="error")):t.diffType=null}function I(){var t={};return t="replace"==e.uploadOption.method?{excel_id:e.previewTable.table_info.excelId,tb_id:e.uploadOption.default_tb,sheet_name:e.previewTable.sheetName,tb_title_ex_title_mapping:angular.toJson(S()),add_field_titles:angular.toJson(x()),del_field_titles:angular.toJson(E())}:"singleReplace"==e.uploadOption.method?{excel_id:e.previewTable.table_info.excelId,tb_id:e.uploadOption.default_tb,sheet_name:e.previewTable.sheetName,tb_title_ex_title_mapping:angular.toJson(S()),add_field_titles:angular.toJson(x()),del_field_titles:angular.toJson(E()),map_id:e.uploadOption.mapId}:{excel_id:e.previewTable.table_info.excelId,tb_id:e.uploadOption.default_tb,sheet_name:e.previewTable.sheetName,tb_title_ex_title_mapping:angular.toJson(S()),add_field_titles:angular.toJson(x()),del_field_titles:angular.toJson(E())}}function j(r){var o=I();r&&(o.force=1),t.pageLoading=!0,"replace"==e.uploadOption.method?a.db.excelReplace(o).then(function(e){0==e.status?G(V,P,e.result):(i(e.errstr),t.pageLoading=!1)}):"singleReplace"==e.uploadOption.method?a.db.excelHistoryReplace(o).then(function(e){0==e.status?G(V,P,e.result):(i(e.errstr),t.pageLoading=!1)}):a.db.excelAppend(o).then(function(e){0==e.status?G(V,P,e.result):(i(e.errstr),t.pageLoading=!1)})}function P(e){i(e),t.pageLoading=!1}function R(){function r(a){return e.table_label_list=[],angular.forEach(a,function(a){"folder_root"==a.folder_id&&(a.name="en"==t.language?"Root":"根目录"),angular.forEach(a.tb_list,function(t){t.label&&e.table_label_list.indexOf(t.label)<0&&e.table_label_list.push(t.label)}),a.sub_folders&&a.sub_folders.length>0&&angular.forEach(a.sub_folders,function(t){angular.forEach(t.tb_list,function(t){t.label&&e.table_label_list.indexOf(t.label)<0&&e.table_label_list.push(t.label)})})}),e.folderList=angular.copy(a),M(),a}return e.query="",a.folder.getList().then(function(e){return e?r(e):(t.pageLoading=!1,void i("error"))})}function M(){var t=$.cookie("select_folder_id")?$.cookie("select_folder_id"):"folder_root";if("folder_root"===t)var a="en"==$.cookie("locale")?"Root":"根目录";else{var a=bdp.bdpTables.getFolderByFolderId(e.folderList,t);a=a.name?a.name:""}q(t,a)}function q(t,a){angular.forEach(e.completeExcelList,function(e){angular.forEach(e.sheetList,function(e){e.table_info.folder_id=t,e.table_info.folder_name=a})})}var A,O=uploadParam.excelMaxSize*(1<<20),B=uploadParam.csvMaxSize*(1<<20);t.show_bdp_header=!1,e.uploadOption={method:s.operate,default_tb:s.tbId?s.tbId:null,mapId:s.mapId?s.mapId:null,pageTitle:""},e.uploadSteps=[],e.geHelpAdress="",e.uploadStepTips=[],e.table_info={folder_id:"",folder_name:"",excelId:"",tableName:"",label:"",comment:""},e.taskList={list:[],completeTaskLength:0,errMsg:null},e.adjustTheadData={oldThead:[],newThead:[],uploadThead:[]},e.fieldTypeMap={0:"number",1:"number",3:"date",2:"string",999:"string"},e.acceptTypes="text/csv,*.xls,*.xlsx,.csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",e.MAX_RERTRY=5,e.CUR_RETRY=0,e.ACCEPTFILENUM=1,g(),e.goHelp=function(e){u(e)},e.backWorkTable=function(){if(e.uploadExcelList.list.length>0)l.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:e.tips["upload.backWorkTableTips"]}}).then(function(){return 3==t.enterprise_type&&2==t.guide&&t.guideStep>0?(e.$emit("okToGuide","quitAddDbs"),r.path("/database"),!1):void t.back()});else{if(3==t.enterprise_type&&2==t.guide&&t.guideStep>0)return e.$emit("okToGuide","quitAddDbs"),r.path("/database"),!1;t.back()}},$(window).on("beforeunload.uploadTip",function(){return e.uploadExcelList.list.length>0?e.tips["upload.refreshTips"]:void 0}),e.$on("$destroy",function(){$(window).off("beforeunload.uploadTip")
}),e.backLastStep=function(t){return 0===t&&l.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:e.tips["upload.backStep1Tips"]}}).then(function(){return g(),!1}),1===t?(D(),!1):void 0},e.uploadFiles=function(t){if(!t)return!1;"[object Array]"!==Object.prototype.toString.call(t)&&(t=[t]);for(var a=[],r=[],o=[],n=[],l="",s=t.length-1;s>=0;s--)t[s]&&0==t[s].size&&(r.push(t[s].name),t.splice(s,1)),t[s]&&!b(t[s],e.acceptTypes)&&(a.push(t[s].name),t.splice(s,1)),t[s]&&/\.csv$/.test(t[s].name)?(A=uploadParam.csvMaxSize,t[s].size>B&&(n.push(t[s].name),t.splice(s,1))):(A=uploadParam.excelMaxSize,t[s]&&t[s].size>O&&(o.push(t[s].name),t.splice(s,1)));if(a.length+r.length+o.length+n.length>1){if(0==t.length)return i(e.tips["upload.allUnPassMuster"]),!1;l=e.tips["upload.anyUnPassMuster1"]+'"'+a.reverse().concat(r.reverse(),o.reverse(),n.reverse()).join('"、"')+'"'+e.tips["upload.anyUnPassMuster2"]}else 1==a.length&&(l=e.tips["upload.unPassMuster"]),1==r.length&&(l=e.tips["upload.emptyUnPassMuster"]),1==o.length&&(l=e.tips["upload.excelFileSizeError"]+uploadParam.excelMaxSize+"M"),1==n.length&&(l=e.tips["upload.csvFileSizeError"]+uploadParam.csvMaxSize+"M");if(l&&i(l),e.uploadExcelList.files=t,null!=t){var d=_(t);if(!d)return!1;m(t)&&v(t)}e.$$phase||e.$digest()},e.initUploadData=function(){g()},e.setCsvDelimiter=function(){var t=e.csv_terminate.value;return"other"==t&&(t=e.csv_terminate.otherValue,t.length>1)?(i(e.tips["upload.onlyOneDelimiter"]),!1):t?(e.csv_terminate.value=t,e.csv_terminate.hasSet=!0,v(e.uploadExcelList.files),void l.closeAll()):(i(e.tips["upload.csvDesc"]),!1)},e.cancelUpload=function(e){e.cancel=!0,e.excelId||e.abort.abort()},e.checkAll=function(t){var a=t.currentTarget.checked;e.selectAll=a,angular.forEach(e.completeExcelList[0].sheetList,function(e){e.errMsg||(e.check=a)})},e.checkSheet=function(t,a,r){var i=t.check;if(i){for(var o=0,n=r.length;n>o;o++){var l=r[o];if(!l.check&&!l.errMsg)return e.selectAll=!1,!1}return e.selectAll=!0}e.selectAll=!1},e.confirmCreateExcel=function(t){if("sheet"==t){for(var a=e.completeExcelList[0].sheetList,r=0,o=a.length-1;o>=0;o--)a[o].check&&(r+=1);if(0==r)return i(e.tips["upload.noSelectWorktable"]),!1;for(var o=a.length-1;o>=0;o--)a[o].check||a.splice(o,1);1==a.length&&(a[0].table_info.tableName=a[0].table_info.tableName.slice(0,a[0].table_info.tableName.lastIndexOf("-"+a[0].sheetName))),e.changePreviewTable("sheet",e.completeExcelList[0].sheetList[0])}if("excel"==t){for(var n=e.completeExcelList,o=n.length-1;o>=0;o--)n[o].sheetList[0].errMsg&&n.splice(o,1);e.changePreviewTable("sheet",e.completeExcelList[0].sheetList[0])}l.closeAll(),p(2)},e.changePreviewTable=function(t,a){if("excel"==t){var r=a.sheetList[0];e.previewTable=r}else{var i=a;e.previewTable=i}},e.changeTableInfo=function(t,a){if("excel"==t){var r=a.sheetList[0];e.table_info=r.table_info}else{var i=a;e.table_info=i.table_info}},e.parseTable=function(r){t.pageLoading=!0,R().then(function(){if(e.taskList={list:[],completeTaskLength:0,errMsg:null},"sheet"==r){var o=[],n=[];angular.forEach(e.completeExcelList[0].sheetList,function(e){o.push(e.sheetName),n.push(e.offsetLine)});var l={excel_id:e.completeExcelList[0].excelId,sheet_names:angular.toJson(o),row_offsets:angular.toJson(n)};a.db.uploadParser(l).then(function(t){0==t.status?(e.taskList.list.push(t.result),G(W,P,t.result)):i(t.errorMsg)})}else angular.forEach(e.completeExcelList,function(r){var o={excel_id:r.excelId,sheet_names:angular.toJson([r.sheetList[0].sheetName]),row_offsets:angular.toJson([r.sheetList[0].offsetLine])};t.pageLoading=!0,a.db.uploadParser(o).then(function(t){0==t.status?(e.taskList.list.push(t.result),G(W,P,t.result)):i(t.errorMsg)})})})};var W=function(a){var r=[];angular.forEach(a.info,function(e){r.push({fileName:a.name,sheetName:e.name,errMsg:e.errmsg?e.errmsg:""})});var o=(a.excel_id,[]);if(angular.forEach(r,function(e){o.push(e.name)}),e.taskList.errMsg)return!1;if(e.taskList.list.length>1&&r[0].errMsg)return e.taskList.errMsg='"'+r[0].fileName.slice(0,r[0].fileName.lastIndexOf("."))+'"'+r[0].errMsg,i(e.taskList.errMsg),t.pageLoading=!1,!1;if(1==e.taskList.list.length){angular.forEach(e.completeExcelList[0].sheetList,function(e){angular.forEach(r,function(t){e.sheetName==t.sheetName&&(t.check=!0)})});for(var n=r.length-1;n>=0;n--)if(r[n].errMsg&&r[n].check)return e.taskList.errMsg='"'+r[n].fileName.slice(0,r[n].fileName.lastIndexOf("."))+(1==e.completeExcelList[0].sheetList.length?"":"-"+r[n].sheetName)+'"'+r[n].errMsg,i(e.taskList.errMsg),t.pageLoading=!1,!1}e.taskList.completeTaskLength+=1,e.taskList.completeTaskLength==e.taskList.list.length&&(t.pageLoading=!1,e.checkTableNameRepeat(),T())};e.hasRepeatName={hasRepeat:!1,repeatName:[],nameList:[]},e.checkTableNameRepeat=function(t){if(e.hasRepeatName.repeatName=[],e.hasRepeatName.nameList=[],e.completeExcelList.length>1){for(var r=0;r<e.completeExcelList.length;r++)e.hasRepeatName.nameList.push(e.completeExcelList[r].sheetList[0].table_info.tableName);var o={titles:angular.toJson(e.hasRepeatName.nameList)};a.db.excelRepeatCheck(o).then(function(a){if(0==a.status){if(a.result.length>0){e.hasRepeatName.hasRepeat=!0,e.hasRepeatName.repeatName=a.result;for(var r=0;r<e.completeExcelList.length;r++){e.completeExcelList[r].sheetList[0].table_info.repeatName=!1;for(var o=0;o<e.hasRepeatName.repeatName.length;o++)e.completeExcelList[r].sheetList[0].table_info.tableName==e.hasRepeatName.repeatName[o]&&(e.completeExcelList[r].sheetList[0].table_info.repeatName=!0)}}else{for(var r=0;r<e.completeExcelList.length;r++)e.completeExcelList[r].sheetList[0].table_info.repeatName=!1;e.hasRepeatName.hasRepeat=!1}t&&t()}else i("check service error")})}if(1==e.completeExcelList.length){for(var r=0;r<e.completeExcelList[0].sheetList.length;r++)e.hasRepeatName.nameList.push(e.completeExcelList[0].sheetList[r].table_info.tableName);var o={titles:angular.toJson(e.hasRepeatName.nameList)};a.db.excelRepeatCheck(o).then(function(a){if(0==a.status){if(a.result.length>0){e.hasRepeatName.hasRepeat=!0,e.hasRepeatName.repeatName=a.result;for(var r=0;r<e.completeExcelList[0].sheetList.length;r++){e.completeExcelList[0].sheetList[r].table_info.repeatName=!1;for(var o=0;o<e.hasRepeatName.repeatName.length;o++)e.completeExcelList[0].sheetList[r].table_info.tableName==e.hasRepeatName.repeatName[o]&&(e.completeExcelList[0].sheetList[r].table_info.repeatName=!0)}}else{for(var r=0;r<e.completeExcelList[0].sheetList.length;r++)e.completeExcelList[0].sheetList[r].table_info.repeatName=!1;e.hasRepeatName.hasRepeat=!1}t&&t()}else i("check service error")})}},e.completeCreatTb=function(){e.checkTableNameRepeat(function(){return e.hasRepeatName.hasRepeat?(i(e.tips["upload.hasRepeatName1"]+'"'+e.hasRepeatName.repeatName.join('"、"')+'"'+e.tips["upload.hasRepeatName2"]),!1):(t.pageLoading=!0,void(F()?H(U):(t.pageLoading=!1,i(e.tips["upload.worktableNameCantNotEmpty"]))))})};var H=function(r){e.completeExcelList.length>1&&(e.createTableList.readyLength=e.completeExcelList.length,angular.forEach(e.completeExcelList,function(o){a.db.excelCreate({excel_id:o.excelId,sheet_names:angular.toJson([o.sheetList[0].sheetName]),tb_name:o.sheetList[0].table_info.tableName,folder_id:o.sheetList[0].table_info.folder_id}).then(function(a){0==a.status?a.result[0].errmsg?(i(a.result[0].errmsg),t.pageLoading=!1):r(a.result,o.sheetList[0]):(e.errMsg=a.errstr,i(a.errstr),t.pageLoading=!1)})})),1==e.completeExcelList.length&&(e.createTableList.readyLength=e.completeExcelList[0].sheetList.length,angular.forEach(e.completeExcelList[0].sheetList,function(o){a.db.excelCreate({excel_id:e.completeExcelList[0].excelId,sheet_names:angular.toJson([o.sheetName]),tb_name:o.table_info.tableName,folder_id:o.table_info.folder_id}).then(function(a){0==a.status?a.result[0].errmsg?(i(a.result[0].errmsg),t.pageLoading=!1):r(a.result,o):(e.errMsg=a.errstr,i(a.errstr),t.pageLoading=!1)})}))},U=function(e,t){var a=[],r=!1;angular.forEach(e,function(e){0==e.status&&(r=!0,a.push(e.task_id))}),r&&(task_id=a.join(","),G(J,P,a,t))},J=function(t,a){var r=!0;t.tb_id?1==t.status&&(r=!1):angular.forEach(t,function(t){1==t.status?(r=!1,e.createErrMsg.push(t)):e.errSheetList.push(t)}),r||e.preview_current_tb(t,a)};e.preview_current_tb=function(e,t){var r=[];t.table_info.tb_id=e.tb_id,r.push({name:t.table_info.tableName,tb_id:e.tb_id,label:t.table_info.label||"",comment:t.table_info.comment||""}),t.table_info.label||t.table_info.comment||t.table_info.originalName!=t.table_info.tableName?a.tb.modify(angular.toJson(r)).then(function(e){0==Number(e.status)&&k()}):k()},e.parseSingleTable=function(){e.adjustTheadData={oldThead:[],newThead:[],uploadThead:[],lessThead:null},e.taskList={list:[],completeTaskLength:0,errMsg:null},e.previewAdjustTable={thead:[],tbody:[]};var r={excel_id:e.previewTable.table_info.excelId,sheet_names:angular.toJson([e.previewTable.sheetName]),row_offsets:angular.toJson([e.previewTable.offsetLine])};t.pageLoading=!0,a.db.uploadParser(r).then(function(t){0==t.status?(e.taskList.list.push(t.result),G(z,P,t.result)):i(t.errorMsg)})};var z=function(a){var r=[];if(angular.forEach(a.info,function(t,a){a===e.previewTable.table_info.sheetId&&(angular.forEach(t.schema,function(t){e.adjustTheadData.uploadThead.push({isEmpty:t.isEmpty,name:t.name,type:t.type})}),r.push({check:!1,name:t.name,errMsg:t.errmsg?t.errmsg:""}))}),e.taskList.errMsg)return!1;if(1==e.taskList.list.length){if(r[0].errMsg)return e.taskList.errMsg='"'+r[0].name+'"'+r[0].errMsg,i(e.taskList.errMsg),t.pageLoading=!1,!1;L()}};e.slectThead=function(e){var t=$(e.target);if(t.parents(".J-upload-list").length)return!1;t.hasClass("J-get-position")||(t=t.parents(".J-get-position"));var a=t.find(".J-upload-list");a.css("visibility","hidden"),o(function(){a.css(t.offset().top+t.height()+4+a.height()>$(window).height()?{top:t.offset().top+t.height()+4,left:t.offset().left+16,height:$(window).height()-(t.offset().top+t.height()+4)-25,width:t.width()-16}:{top:t.offset().top+t.height()+4,left:t.offset().left+16,height:"auto",width:t.width()-16}),a.css("visibility","visible")},10)},e.selectNewField=function(t,a){if(a.title==t.name)return!1;for(var r=e.adjustTheadData.newThead,i=0;i<r.length;i++)if(t.name==r[i].title&&t.name){r[i].title=null,r[i].type=999,r[i].del=!1,r[i].diffType=null;break}angular.forEach(e.adjustTheadData.uploadThead,function(e){a.title==e.name&&(e.hasSelect=!1)}),a.title=t.name,a.type=t.type,t.hasSelect=!0,N(e.adjustTheadData.oldThead[a.index],a)},e.delOldField=function(r,i){var o={tb_id:e.uploadOption.default_tb,del_field_titles:[r.title]};t.pageLoading=!0,o.del_field_titles=angular.toJson(o.del_field_titles),a.db.checkFieldDependency(o).then(function(a){if(0==a.status)if(1==a.result.can_del)t.pageLoading=!1,l.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-330",scope:e,data:{message:e.tips["wb.confirmDeleteField"]}}).then(function(){for(var t=e.adjustTheadData.uploadThead,a=0;a<t.length;a++)if(t[a].name==e.adjustTheadData.newThead[i].title){t[a].hasSelect=!1;break}r.del=!0,e.adjustTheadData.newThead[i]={title:null,type:999,del:!0}});else{e.responseHint={dependency:a.result.dependency};var o="en"==$.cookie("locale")?"Untitled Chart":"未命名图表";angular.forEach(e.responseHint.dependency,function(e){angular.forEach(e.chart,function(e){e.ct_name||(e.ct_name=o)})}),l.open({template:"/static/partials/dialogTemplates/tableModifyHint.html",className:"ngdialog-theme-default",scope:e}),t.pageLoading=!1}})},e.confirmAddFiled=function(){var t=C(e.adjustTheadData.oldThead,e.adjustTheadData.newThead);if(t.dateDiff.length>0)return i('"'+t.dateDiff.join("、")+'" '+("append"==e.uploadOption.method?e.tips["upload.plzUploadAgainAppend"]:e.tips["upload.plzUploadAgainReplace"])),!1;for(var a=!1,r=0;r<e.adjustTheadData.uploadThead.length;r++)e.adjustTheadData.uploadThead[r].hasSelect||e.adjustTheadData.uploadThead[r].check||!e.adjustTheadData.uploadThead[r].name||(a=!0);a?l.open({template:"/static/js/worktable/pageUpload/choose_add_fields.html",className:"ngdialog-theme-default ngDialog-width-400",scope:e,data:{addFileds:e.adjustTheadData.uploadThead}}):e.postAdjustInfo()},e.postAdjustInfo=function(){return E().length==e.adjustTheadData.oldThead.length&&0==x().length?(i(e.tips["upload.fiedsCanNotEmpty"]),!1):void j(1)};var V=function(){$.cookie("ds_tb_id",e.previewTable.table_info.tb_id),t.pageLoading=!1,t.back()},G=function(t,r,i,n){var l="";a.getTaskStatus(i).then(function(a){if(a.result.info&&(e.offsetList=a.result.info),0==a.status){var s=a.result;if(void 0!==s.status)if(0==s.status||3==s.status)o(function(){G(t,P,i,n)},1e3);else if(2==s.status)l=s.error_msg||s.errstr,r(l);else{if(!t)return;t(s,n)}else{var d=0,c=0,u=!1;if(angular.forEach(s,function(e){(0==e.status||3==e.status)&&(d+=1),2==e.status&&(u++,l=e.error_msg||e.errstr)}),c==s.length&&(u=!0),d>0)o(function(){G(t,P,i,n)},1e3);else if(u)r(l);else{if(!t)return;t(s,n)}}}else l=e.tips["wb.analysisFailed"],r(l)})};e.changeAllFolder=function(){q(e.table_info.folder_id,e.table_info.folder_name);var t=l.open({template:"/static/partials/dialogTemplates/alert_success.html",scope:e,className:"ngdialog-theme-default ngDialog-width-300",data:{message:e.tips["upload.applyAllSuccessTips"]},preCloseCallback:function(){o.cancel(a)}}),a=o(function(){l.close(t)},3e3)},e.showSelectFolder=function(){e.folderList?(e.openSelectFolderDialog(),t.pageLoading&&(t.pageLoading=!1)):(t.pageLoading=!0,o(function(){e.showSelectFolder()},1e3))},e.openSelectFolderDialog=function(){e.selectFolderDialog=l.open({templateUrl:"/static/js/worktable/tableDialog/choose_table_folder.html",scope:e,className:"ngdialog-theme-default choose-folder",data:{tbType:"upload",optType:"baseChoose",folderList:e.folderList||[],folderQueryList:[],targetFolderId:e.table_info.folder_id||"folder_root",targetFolderType:"",queryText:"",open:{},confirmSave:e.saveSelectFolder},controller:"chooseTbFolderCtrl"})},e.saveSelectFolder=function(t){e.table_info.folder_id=t.targetFolderId;var a=bdp.bdpTables.getFolderByFolderId(e.folderList,e.table_info.folder_id);e.table_info.folder_name=a?a.name:"",e.selectFolderDialog.close()},e.tableLabelLimit=function(t,a){return 8!=t.keyCode&&a&&a.length>=20?(i(e.tips["wb.tableLabelLimit"]),!1):void 0},e.tableCommentLimit=function(t,a){return 8!=t.keyCode&&a&&a.length>=100?(i(e.tips["wb.tableCommentLimit"]),!1):void 0},e.hitLabelList={show:!1,list:[]},e.hitExistTableLabel=function(t){e.hitLabelList.list=[],e.hitLabelList.show=!0,t?angular.forEach(e.table_label_list,function(a){a.toLowerCase().indexOf(t.toLowerCase())>=0&&e.hitLabelList.list.push(a)}):e.hitLabelList.list=angular.copy(e.table_label_list)},d(["upload.csvFileSizeError","upload.excelFileSizeError","upload.onlyOneDelimiter","upload.csvDesc","upload.parseFailed","upload.parseFailedToContinue","upload.worktableNameCantNotEmpty","wb.confirmDeleteField","upload.plzUploadAgainReplace","upload.plzUploadAgainAppend","upload.plzCheckExcel","wb.analysisFailed","wb.tableCommentLimit","wb.tableLabelLimit","wb.canNotDelete","upload.uploadData","upload.uploadFiles","upload.previewData","upload.worktableSet","upload.backStep1Tips","upload.backWorkTableTips","upload.refreshTips","upload.supportFile","upload.supportBatch","wb.replaceData","wb.replaceData","wb.singleFileRplace","wb.appendData","wb.replaceAll","upload.noSelectWorktable","upload.unPassMuster","upload.fiedsCanNotEmpty","upload.parseFailedToUploadFailed","upload.emptyUnPassMuster","upload.anyUnPassMuster1","upload.anyUnPassMuster2","upload.allUnPassMuster","upload.applyAllSuccessTips","upload.hasRepeatName1","upload.hasRepeatName2"],e)}]).directive("uploadDropDown",["$timeout",function(e){return{restrict:"A",scope:{dropDownFlag:"="},link:function(t){t.$watch("dropDownFlag",function(a,r){var i=".adjust-thead-wrap",o="scroll.uploadfolder";if(a!==r&&1==a){var n=angular.element(i).scrollTop();e(function(){angular.element(i).on(o,function(a){Math.abs(n-$(a.target).scrollTop())>8&&(t.dropDownFlag=!1,e(function(){t.$digest()},0))})},0)}else a!==r&&0==a&&angular.element(i).off(o)})}}}]),!function(){function e(e,t,a,r,i,o,n,l,s,d,c){function u(){return r.ds.tbList().then(function(e){0==e.status&&(t.dsTBList=e.result,t.original_dbList=angular.copy(e.result),f())})}function f(){function e(){angular.forEach(t.dsTBList,function(e){angular.forEach(e.tb_list,function(a){a.tb_id==t.selected.tb_id&&(e.open=!0)})})}t.dsTBList?e():t.$watch("dsTBList",function(t){t&&e()})}function p(i){r.getTaskStatus(i).then(function(r){if(0==Number(r.status)){var n=r.result;0==Number(n.status)||3==Number(n.status)?o(function(){p(i)},1e3):2==Number(n.status)?(a(t.tips["wb.copyFail"]),e.pageLoading=!1,t.getFolderList()):(a(t.tips["wb.copySuccess"]),e.pageLoading=!1,t.getFolderList(),l.closeAll())}})}function g(e,a,r,i){function o(t){for(var r=0,i=t.length;i>r;r++)if(t[r].folder_id!=a&&t[r].name==e){l=!1;break}}var n=t.original_folderList,l=!0;if(1==r)o(n);else{for(var s=[],d=0,c=n.length;c>d;d++)if(n[d].folder_id==i){s=n[d].sub_folders;break}o(s)}return l}function h(e,a){function r(t){for(var r=0,i=t.length;i>r;r++)if(t[r].tb_id!=a&&t[r].name==e)return!0;return!1}function i(e){for(var t=0,a=e.length;a>t;t++){if(e[t].tb_list&&e[t].tb_list.length>0&&r(e[t].tb_list)){n=!0;break}!n&&e[t].sub_folders&&e[t].sub_folders.length>0&&i(e[t].sub_folders)}}var o=t.original_folderList,n=!1;return i(o),n}function b(i,o,n,s,d){o="folder_root"==o?"folder_root":o;var c=n?n:0,u=s?s:0,f={tb_id:i,to_folder:o,to_seq:c,tb_index:u};t.requestDone=!1,r.folder.change(f).success(function(r){if(t.requestDone=!0,e.pageLoading=!1,0==Number(r.status)){if(t.selected.tb_id==i){var n=bdp.bdpTables.getFolderByFolderId(t.original_folderList,o);t.setUnFoldingStatus(n,!0)}t.getFolderStructure({get_first:0,get_root:1,tb_list:[f.to_folder]}),t.getFolderList(),a(t.tips["chart.moveChartSuccess"]),i==t.selected.tb_id&&(t.selected.folder_id=o,$.cookie("select_folder_id",o))}d&&(e.pageLoading=!1,l.closeAll())})}function _(){t.folderStructure=angular.copy(t.dragCopyList)}function m(e){t.enableSortFolder=!1,r.folder.modify_parent(e).then(function(r){t.requestDone=!0,0==Number(r.status)?(t.enableSortFolder=!0,t.getFolderStructure({get_first:0,get_root:1,tb_list:[e.folder_id]}),t.getFolderList()):a(Number(r.status))})}function v(e){t.enableSortFolder=!1,r.folder.modify_seq(e).then(function(r){t.requestDone=!0,0==Number(r.status)?(t.enableSortFolder=!0,t.getFolderStructure({get_first:0,get_root:1,tb_list:[e.folder_id]}),t.getFolderList()):a(Number(r.status))})}function w(e){function a(t,o){for(var n=0,l=t.length;l>n;n++)t[n].folder_id==e&&(r=!0,i.seq_no=0==n?0:t[n-1].seq_no+1,i.parent_id=o),!r&&t[n].sub_folders&&t[n].sub_folders.length>0&&a(t[n].sub_folders,t[n].folder_id)}var r=!1,i={seq_no:0,parent_id:""};return a(t.folderStructure,""),i}function y(e,t){for(var a={parent_id:"",type:""},r=!1,i=0;i<e.length;i++){if(e[i].folder_id==t){r=!0,a.type="top",a.parent_id="";break}if(!r&&e[i].sub_folders&&e[i].sub_folders.length>0)for(var o=0;o<e[i].sub_folders.length;o++)if(e[i].sub_folders[o].folder_id==t){r=!0,a.type="sub",a.parent_id=e[i].folder_id;break}if(r)break}return a}function D(e,a){var r=0,i={};return angular.forEach(t.folderStructure,function(t){e==t.folder_id?i=t:t.sub_folders&&t.sub_folders.length>0&&angular.forEach(t.sub_folders,function(t){e==t.folder_id&&(i=t)})}),1==i.tb_list.length?(t.sortWorkSheetData.tb_index=0,r=0):angular.forEach(i.tb_list,function(e,o){a==e.tb_id&&(t.sortWorkSheetData.tb_index=o,r=o==i.tb_list.length-1?i.tb_list[o-1].hasOwnProperty("tb_seq_no")?i.tb_list[o-1].tb_seq_no+1:"-2":i.tb_list[o+1].hasOwnProperty("tb_seq_no")?i.tb_list[o+1].tb_seq_no:"-2")}),r}t.workdListView="folderList",o(function(){t.viewTip=t.tips["wb.databaseView"]},0),t.isSortFolder=!1;var T=!1;t.enableSortWorkSheet=!0,t.enableSortFolder=!0,t.targetFolder={},t.sortWorkSheetData={from_folder_id:"",to_folder_id:"",from_tb_num:"",to_tb_num:"",tb_index:0},t.sortWorkSheets={appendTo:"body",connectWith:".accept-worksheet-list",placeholder:"worksheet-sort-placeholder",items:"li:not(.empty-worksheet-folder)",activate:function(e,a){return t.isSortWorkSheet=!0,a.item.sortable.model?void 0:void a.item.sortable.cancel()},start:function(e,a){if(t.enableSortWorkSheet){if(!a.item.sortable.model)return void a.item.sortable.cancel();$(e.target).addClass("is-sorting"),t.isSortWorkSheet=!0;var r=a.helper.sortable.model;t.sortWorkSheetData.from_folder_id=bdp.bdpTables.getFolderByTableId(t.folderList,r.tb_id),t.sortWorkSheetData.from_tb_num=r.tb_seq_no}},update:function(){},change:function(){T=!0},over:function(){T=!0},receive:function(){},stop:function(e,a){if($(a.item.sortable.droptarget).hasClass("ds-folder-list"))return t.folderList=angular.copy(t.original_folderList),void t.changeFolderOpenStatus(t.folderList);if(T){if(!a.item.sortable.model)return a.item.sortable.cancel(),t.folderList=angular.copy(t.original_folderList),void t.changeFolderOpenStatus(t.folderList);t.getPosAfterSort(),$(e.target).removeClass("is-sorting");var r=a.item.sortable.model;if(t.sortWorkSheetData.to_folder_id=bdp.bdpTables.getFolderByTableId(t.folderList,r.tb_id),!t.sortWorkSheetData.to_folder_id)return a.item.sortable.cancel(),t.folderList=angular.copy(t.original_folderList),void t.changeFolderOpenStatus(t.folderList);t.sortWorkSheetData.to_tb_num=getTableNumber(t.sortWorkSheetData.to_folder_id,r.tb_id),t.enableSortWorkSheet=!1,t.sortWorkSheetData.to_folder_id="folder_root"==t.sortWorkSheetData.to_folder_id?"folder_root":t.sortWorkSheetData.to_folder_id,t.sortWorkSheetData.to_tb_num=void 0==t.sortWorkSheetData.to_tb_num?-2:t.sortWorkSheetData.to_tb_num}}},t.getPosAfterSort=function(){t.current_pos="";var e=$("#ds-list > ul");e[0]&&(t.current_pos=e[0].scrollTop)},t.getDsTBList=u,t.dsTBList=[],t.original_dbList=[],t.toggleView=function(){t.query="","folderList"==t.workdListView?(t.workdListView="dsTbList",t.viewTip=t.tips["wb.worktableView"],e.wsId||0!=t.original_dbList.length?(t.dsTBList=angular.copy(t.original_dbList),f()):u().then(function(){f()})):(t.workdListView="folderList",t.viewTip=t.tips["wb.databaseView"],t.folderList=angular.copy(t.original_folderList));for(var a in t.unfolding)if(a==t.selected.folder_id){var r=bdp.bdpTables.getFolderByFolderId(t.folderList,a);r.open=t.getUnFoldingStatus(a)}else delete t.unfolding[a];o(function(){t.scroll_to_active()},100)},t.requestDone=!0,t.showCreateFolder=function(){l.open({template:"/static/js/worktable/tableDialog/create_table_folder.html",className:"ngdialog-theme-default ngdialog-small",scope:t,data:{folder_list:t.originFolderList,folder_id:"folder_root",folder_name:""}})},t.confirmCreateFolder=function(e,i){if(!i)return void a(t.tips["wb.inputFolderName"]);var o=e&&"folder_root"!=e?2:1,n=e?e:"";if(!g(i,"",o,n))return void a(t.tips["wb.repeatFolderName"]);var s={parent_id:e||"",name:i};t.requestDone=!1,r.folder.create(s).then(function(e){t.requestDone=!0,0==Number(e.status)?(t.getFolderStructure({get_first:0,get_root:1,tb_list:[t.selected.tb_id]}),t.getFolderList(),a(t.tips["wb.createSuccess"]),l.closeAll()):a(11==Number(e.status)?t.tips["wb.repeatFolderName"]:25001==Number(e.status)?t.tips["wb.repeatFolderName"]:t.tips["wb.createFailed"])})},t.openMoveTablesDialog=function(){return t.isGettingFolder?!1:void l.open({templateUrl:"/static/js/worktable/tableDialog/move_tables.html",className:"ngdialog-theme-default ngdialog-width-818 ngdialog-move-tables",scope:t,data:{batchMoveList:angular.copy(t.original_folderList)},controller:"batchMoveTablesCtrl",preCloseCallback:function(){t.needReloadFolderListFlag&&t.getFolderList()}})},t.batchDeleteTablesDialog=function(){return t.isGettingFolder?!1:void l.open({templateUrl:"/static/js/worktable/tableDialog/batch_delete_tables.html",className:"ngdialog-theme-default ngdialog-width-818 ngdialog-move-tables",scope:t,data:{batchDeleteList:angular.copy(t.original_folderList)},controller:"batchDeleteTablesCtrl",preCloseCallback:function(){t.needReloadFolderListFlag&&t.getFolderList()}})},t.rename_folder=function(e,i,o){if(i.name==e)return void a(t.tips["wb.editSuccesss"]);var n=i.name,l=i.parent_id?2:1;if(g(e,i.folder_id,l,o)){i.name=e;var s={name:e,folder_id:i.folder_id};return r.folder.modify(s).then(function(e){a(0==Number(e.status)?t.tips["wb.editSuccesss"]:Number(e.status)),t.getFolderList(),t.getFolderStructure({get_first:0,get_root:1,tb_list:[s.folder_id]})}),e}return a(t.tips["wb.repeatFolderName"]),i.name=n,n},t.moveWorktable=function(e){l.open({templateUrl:"/static/js/worktable/tableDialog/choose_table_folder.html",scope:t,className:"ngdialog-theme-default choose-folder",data:{tbType:"",optType:"move",tbInfo:{tb_id:e.tb_id,folder_id:"folder_root",tb_name:e.name},folderList:t.saveFolderList||[],folderQueryList:[],targetFolderId:t.saveFolderList.length>0?t.saveFolderList[0].folder_id:"folder_root",targetFolderType:"",queryText:"",open:{},confirmSave:t.saveMoveWorktable},controller:"chooseTbFolderCtrl",preCloseCallback:function(){t.needReloadFolderListFlag&&t.getFolderList()}})},t.$on("needReloadFolderListFlag",function(e,a){if(t.needReloadFolderListFlag=a.flag,a.targetFolderId){var r=a.targetFolderId;t.unfolding[r]?t.unfolding[r].open=!0:t.unfolding[r]={open:status,parent_id:""}}}),t.saveMoveWorktable=function(a){function r(e){angular.forEach(e,function(e){if(i.folder_id==e.folder_id){if(e.hasOwnProperty("tb_list")&&e.tb_list.length>0){var t=e.tb_list[e.tb_list.length-1];t.hasOwnProperty("tb_seq_no")?o=t.tb_seq_no+1:(n=e.tb_list.length,o=-2)}}else e.sub_folders&&e.sub_folders.length>0&&r(e.sub_folders)})}if(t.requestDone){e.pageLoading=!0;var i={tb_id:a.tbInfo.tb_id,folder_id:a.targetFolderId,tb_name:a.tbInfo.name},o=0,n=0;r(t.original_folderList),b(i.tb_id,i.folder_id,o,n,"dialog")}},t.copyWorktable=function(e){l.open({templateUrl:"/static/js/worktable/tableDialog/choose_table_folder.html",scope:t,className:"ngdialog-theme-default choose-folder",data:{tbType:"",optType:"copy",tbInfo:{original_tb_name:e.name,tb_name:e.name+"(副本)",tb_id:e.tb_id,folder_id:"folder_root"},folderList:t.saveFolderList||[],folderQueryList:[],targetFolderId:t.saveFolderList.length>0?t.saveFolderList[0].folder_id:"folder_root",targetFolderType:"",queryText:"",open:{},confirmSave:t.saveCopyWorktable},controller:"chooseTbFolderCtrl",preCloseCallback:function(){t.needReloadFolderListFlag&&t.getFolderList()}})},t.saveCopyWorktable=function(i){if(t.requestDone){if(!i.tbInfo.tb_name)return void a(t.tips["join.inputWorkSheetName"]);if(i.tbInfo.original_tb_name==i.tbInfo.tb_name)return void a(t.tips["wb.changeWorkSheetName"]);var o=i.tbInfo;if(bdp.bdpTables.checkRepeatTableName(t.folderList,o.tb_id,o.tb_name))return void a(t.tips["wb.changeWorkSheetName"]);o.folder_id=i.targetFolderId,e.pageLoading=!0,t.requestDone=!1,r.tb.copy(o).then(function(r){if(t.requestDone=!0,e.pageLoading=!1,0==r.status){var i=r.result.task_id;p(i),l.closeAll(),t.getFolderStructure({get_first:0,get_root:1,tb_list:[o.folder_id]}),t.getFolderList(),a(t.tips["user.copySuccess"])}else e.pageLoading=!1})}},t.moveFolder=function(e,a){a&&a.stopPropagation(),l.open({templateUrl:"/static/js/worktable/tableDialog/choose_table_folder.html",scope:t,className:"ngdialog-theme-default choose-folder",data:{tbType:"",optType:"move_folder",tbInfo:{folder_id:e.folder_id,folder_name:e.name,parent_id:e.parent_id,has_sub_folder:e.sub_folders&&e.sub_folders.length>0},folderList:t.saveFolderList||[],folderQueryList:[],targetFolderId:t.saveFolderList.length>0?t.saveFolderList[0].folder_id:"folder_root",targetFolderType:"top",queryText:"",open:{},confirmSave:t.saveMoveFolder},controller:"chooseTbFolderCtrl",preCloseCallback:function(){t.needReloadFolderListFlag&&t.getFolderList()}})},t.saveMoveFolder=function(e){function r(e){angular.forEach(e,function(e){i==e.folder_id&&e.hasOwnProperty("sub_folders")&&e.sub_folders.length>0&&(c.seq_no=e.sub_folders[e.sub_folders.length-1].seq_no+1)})}if(t.requestDone){var i=e.targetFolderId,o=e.targetFolderType,n=e.tbInfo;if(i==n.folder_id)return void a(t.tips["wb.cannotMoveToCurrentFolder"]);if("sub"==o)return void a(t.tips["wb.cannotMoveToSubFolder"]);if("top"==o&&n.has_sub_folder&&"folder_root"!=i)return void a(t.tips["wb.cannotMoveTwoLevelsToSubFolder"]);var s="folder_root"==i?1:2,d="folder_root"!=i?i:"";if(!g(n.folder_name,n.folder_id,s,d))return void a(t.tips["wb.repeatFolderName"]);var c={seq_no:0,parent_id:i,folder_id:n.folder_id};"folder_root"!=i?r(t.original_folderList):c.seq_no=t.original_folderList.length<2?0:t.original_folderList[t.original_folderList.length-2].seq_no+1,t.requestDone=!1,"folder_root"==i&&""==n.parent_id?v(c):m(c),l.closeAll()}},t.deleteFolder=function(e,a){a&&a.stopPropagation(),t.delInfo={delTb:!1,folder_id:e.folder_id,folder_name:e.name},l.open({template:"/static/partials/dialogTemplates/delete_folder.html",className:"ngdialog-theme-default ngDialog-width-380 ngdialog-confim-box",scope:t})},t.forceDeleteFolder=function(){if(t.showLoading=!0,t.requestDone){var e=t.delInfo.delTb?"1":"0";t.requestDone=!1,r.folder.del(t.delInfo.folder_id,e).then(function(e){if(t.requestDone=!0,0==e.status){if(1==e.result)a(t.tips["wb.deleteFolderErr"]);else{var r=l.open({template:"/static/partials/dialogTemplates/alert_success.html",scope:t,className:"ngdialog-theme-default ngDialog-width-300",closeByDocument:!0,data:{message:t.tips["wb.deleteSuccess"]},preCloseCallback:function(){o.cancel(i)}});t.getCapacityStatistics();var i=o(function(){l.close(r)},3e3)}t.getFolderStructure({get_first:1,get_root:1}),t.getFolderList()}else a(e.errstr);l.closeAll(),t.showLoading=!1})}},t.queryUserOrGroups="",t.switchRole=function(e){1==e?(t.showUser=!0,t.showGroup=!1):2==e&&(t.showUser=!1,t.showGroup=!0)},t.assignData={initCheckedUsers:[],initCheckedGroups:[],checkedUsers:[],checkedGroups:[],groups:[],users:[]},t.assignTableTo=function(e){r.share.allList({tb_id:e.tb_id}).then(function(a){t.showUser=!0,t.showGroup=!1,t.assignData.groups=a.result.user_group,t.assignData.users=a.result.user,t.assignData.initCheckedUsers=[],t.assignData.initCheckedGroups=[],t.assignData.users.map(function(e){e.shared&&t.assignData.initCheckedUsers.push(e.user_id)}),t.assignData.groups.map(function(e){e.shared&&t.assignData.initCheckedGroups.push(e.group_id)}),t.assignTableDialog=l.open({template:"/static/partials/dialogTemplates/assign_table.html",scope:t,data:{tb_name:e.name,tb_id:e.tb_id},className:"ngdialog-theme-default ngDialog-width-360 ngDialog-assign-table"})})},t.confirmAssignTable=function(e){t.assignData.checkedUsers=[],t.assignData.checkedGroups=[];for(var i=0;i<t.assignData.users.length;i++)1==t.assignData.users[i].shared&&t.assignData.checkedUsers.push(t.assignData.users[i].user_id);for(var i=0;i<t.assignData.groups.length;i++)1==t.assignData.groups[i].shared&&t.assignData.checkedGroups.push(t.assignData.groups[i].group_id);t.assignData.deletedUsers=getDiffItemsInTwoArray(t.assignData.initCheckedUsers,t.assignData.checkedUsers).del,t.assignData.deletedGroups=getDiffItemsInTwoArray(t.assignData.initCheckedGroups,t.assignData.checkedGroups).del;var o={tb_id:e,user_list:{all:t.assignData.checkedUsers,del:t.assignData.deletedUsers},group_list:{all:t.assignData.checkedGroups,del:t.assignData.deletedGroups}};o.user_list=JSON.stringify(o.user_list),o.group_list=JSON.stringify(o.group_list),r.share.modify(o).then(function(e){0==e.status&&(a(t.tips["wb.assign.success"]),l.close(t.assignTableDialog))})},t.deleteTb=function(i){function n(e){function a(t){angular.forEach(t,function(t){for(var r=0,i=t.tb_list.length;i>r;r++)if(t.tb_list[r].tb_id==e){t.tb_list.splice(r,1),u=!0;break}!u&&t.sub_folders&&t.sub_folders.length>0&&a(t.sub_folders)})}var r=bdp.bdpTables.getFolderByTableId(t.folderStructure,e);u=!1,a(t.folderStructure),u=!1,a(t.original_folderList),t.checkUnreadTbInFolder(r.folder_id,t.folderStructure),t.$broadcast("updatefolderList",t.original_folderList),angular.forEach(t.folderList,function(e){e.totalTable=bdp.bdpTables.getFolderTableNumber(e),e.sub_folders&&e.sub_folders.length>0&&angular.forEach(e.sub_folders,function(e){e.totalTable=bdp.bdpTables.getFolderTableNumber(e)
})})}function s(a){if(n(d),d==t.selected.tb_id)if($.cookie("ds_tb_id",""),t.no_datasource="folderList"==t.workdListView?t.checkNoTable(t.folderList,"list"):t.checkNoTable(t.dsTBList,"list"),t.no_datasource)t.activeTab.index=1,t.selected={tb:null,status:{},tb_id:0,folder_id:""},t.previewData.table_preview_loading=!1,t.previewData.table_preview_filter_loading=!1;else{var i={};"folderList"==t.workdListView?r.folder.getTableSiblings().then(function(e){e.result.tb_list.length?(i=e.result.tb_list[0],t.showDetailPage(i,!0)):(t.no_datasource=!0,t.loadingFolderStructure=!1,t.selected.tb=null)}):(i=t.getFirst(t.dsTBList),t.selected.tb_id=i.tb_id,f(),t.showDetailPage(i,!0))}t.$$phase||t.$digest(),"self"!=a.tb_type&&"public"!=a.tb_type||"ds"!=a.type&&"public"!=a.type||t.getDsTBList(),3==e.enterprise_type&&t.$emit("changeCapacity","change"),t.getCapacityStatistics()}if(t.requestRelateInfo=!0,!t.isGettingFolder){var d=i.tb_id,u=!1;r.chart.getRelationList(i.tb_id).then(function(e){t.requestRelateInfo=!1;var n=e.chart.length,u=e.wb.length,f=e.user.length,p=e.user_group.length;n||u||f||p?!n||u||f||p?(u||f||p)&&l.open({template:"/static/partials/dialogTemplates/delete_related_table.html",className:"ngdialog-theme-default ngDialog-width-320 ngDialog-delete-confirm",scope:t,data:{related_table:!0}}):t.delTbWithChartDialog=l.open({template:"/static/partials/dialogTemplates/delete_related_table.html",className:"ngdialog-theme-default ngDialog-width-380  ngDialog-delete-confirm",scope:t,data:{related_chart:!0,chart_names:e.chart,verifyCode:""}}):l.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:t}).then(function(){t.deletingWorktable=!0,r.tb.del(d).then(function(e){if(t.selected.status.timer&&d==t.selected.tb.tb_id&&(c.cancelOne("/api/tb/status"),clearTimeout(t.selected.status.timer),delete t.selected.status.timer),t.deletingWorktable=!1,0==Number(e.status)){s(i);var r=l.open({template:"/static/partials/dialogTemplates/alert_success.html",scope:t,className:"ngdialog-theme-default ngDialog-width-300",closeByDocument:!0,data:{message:t.tips["wb.deleteSuccess"]},preCloseCallback:function(){o.cancel(n)}}),n=o(function(){l.close(r)},3e3)}else a(19001==Number(e.status)?t.tips["wb.deleteFailedSearch"]:t.tips["wb.deleteFailed"])})})}),t.confirmDelTbWithChart=function(e){return""==e?(a(t.tips["user.inputPicVerifyCode"]),!1):void r.tb.delTableWithChart(d,t.sessionId,e).then(function(e){if(0!=Number(e.status))return 19001==Number(e.status)?(a(t.tips["wb.deleteFailedSearch"]),!1):23002==e.status?(a(t.tips["error.codeError"]),!1):(a(t.tips["wb.deleteFailed"]),!1);s(i);var r=l.open({template:"/static/partials/dialogTemplates/alert_success.html",scope:t,className:"ngdialog-theme-default ngDialog-width-300",closeByDocument:!0,data:{message:t.tips["wb.deleteSuccess"]},preCloseCallback:function(){o.cancel(n)}}),n=o(function(){l.close(r)},3e3);l.close(t.delTbWithChartDialog)})},t.checkRelateStatus=function(){t.selected.tb=i,t.selected.tb_id=i.tb_id,t.showTab(2)},t.toggleImg=function(){var e=(new Date).getTime();t.sessionId=e+parseInt(1e4*Math.random()),t.url="/api/register/pic?session_id="+t.sessionId+"&t="+e},t.toggleImg()}},t.editWorkTable=function(e){function r(e,r){return 8!=e.keyCode&&r&&r.length>=20?(a(t.tips["wb.tableLabelLimit"]),!1):void 0}function i(e,r){return 8!=e.keyCode&&r&&r.length>=100?(a(t.tips["wb.tableCommentLimit"]),!1):void 0}var o={save:t.rename_tb,hitExistTableLabel:t.hitExistTableLabel,labelLimit:r,commentLimit:i,name:e.name,table:e};l.open({templateUrl:"/static/js/worktable/tableDialog/rename_table.html",scope:t,className:"ngdialog-theme-default choose-folder",data:o})},t.hitLabelList={show:!1,list:[]},t.hitExistTableLabel=function(e){t.hitLabelList.list=[],t.hitLabelList.show=!0,e?angular.forEach(t.table_label_list,function(a){a.toLowerCase().indexOf(e.toLowerCase())>=0&&t.hitLabelList.list.push(a)}):t.hitLabelList.list=angular.copy(t.table_label_list)},t.rename_tb=function(e,i,o){function n(e){angular.forEach(e,function(e){angular.forEach(e.tb_list,function(e){e.tb_id==i.tb_id&&(e.name=i.name,d=!0)}),e.sub_folders&&e.sub_folders.length>0&&n(e.sub_folders)})}if(!e)return void a(t.tips["join.inputWorkSheetName"]);if(e.length>100)return void a(t.tips["wb.tableNameLessThan100"]);var l=i.name,s=!1;if(i.label=i.label||"",i.comment=i.comment||"",i.name=e,s=h(e,i.tb_id))return i.repeatName=!0,i.name=l,a(t.tips["wb.changeWorkSheetName"]),!1;i.repeatName=!1;var d=!1;return n(t.original_folderList),angular.forEach(t.original_dbList,function(e){angular.forEach(e.tb_list,function(e){e.tb_id==i.tb_id&&(e.name=i.name,d=!0)})}),r.tb.modify(angular.toJson([i])).then(function(e){0==Number(e.status)&&(a(t.tips["wb.editSuccesss"]),t.$broadcast("updatefolderList",t.original_folderList),t.selected.tb.tb_id==i.tb_id&&(t.selected.tb.name=i.name),"folderList"==t.workdListView&&t.refreshSpecificFolderContent(i.tb_id),"dsTbList"==t.workdListView&&t.getDsTBList(),o&&o())}),e},t.toggleFolder=function(e){function a(r){angular.forEach(r,function(r){e.folder_id==r.folder_id?(r.open=e.open,t.unfolding[e.folder_id]={open:r.open,parent_id:""}):r.sub_folders&&r.sub_folders.length>0&&a(r.sub_folders)})}e.open=!e.open,a(t.folderStructure)},t.stickyFolder=function(e){var t={folder_id:e,seq_no:0};v(t)},t.dragFolderFromTo={from_id:"",from_type:"",to_id:"",to_type:""},t.sortFolders={appendTo:"document.body",connectWith:".accept-folder",placeholder:"sort-folder-placeholder",items:".J-sortable-folder",dropOnEmpty:!0,distance:2,delay:200,scroll:!0,start:function(e,a){if(!$(a.item).hasClass("sort-table-placeholder")){if(!a.item.sortable.model||!t.enableSortFolder||t.isGettingFolder)return void a.item.sortable.cancel();$(a.helper).addClass("is-sorting");var r=a.item.sortable.model;t.sortFolderHasSub=r.hasOwnProperty("sub_folders")&&r.sub_folders.length>0,t.dragCopyList=angular.copy(t.folderStructure),t.dragFolderFromTo.from_type="top",t.dragFolderFromTo.from_id=r.parent_id||""}},update:function(){},change:function(){},over:function(){},receive:function(e,a){$(a.item).hasClass("ds-excel")&&(a.item.sortable.cancel(),t.isSortFolder=!1)},stop:function(e,r){if(t.query)return r.item.sortable.cancel(),void _();var i=r.item.sortable.model,o=w(i.folder_id);t.getPosAfterSort(),$(e.target).removeClass("is-sorting");var n=y(t.folderStructure,i.folder_id);t.dragFolderFromTo.to_type=n.type,t.dragFolderFromTo.to_id=n.parent_id;var l="top"==t.dragFolderFromTo.to_type?1:2;return g(i.name,i.folder_id,l,t.dragFolderFromTo.to_id)?void("sub"==t.dragFolderFromTo.to_type&&t.sortFolderHasSub?(a(t.tips["wb.cannotMoveTwoLevelsToSubFolder"]),r.item.sortable.cancel(),_(),t.changeFolderOpenStatus(t.folderStructure)):t.dragFolderFromTo.from_id==t.dragFolderFromTo.to_id?(o.folder_id=i.folder_id,v(o)):t.dragFolderFromTo.from_id!=t.dragFolderFromTo.to_id&&(o.folder_id=i.folder_id,m(o))):(a(t.tips["wb.repeatFolderName"]),r.item.sortable.cancel(),void _())}},t.sortSubFolders={appendTo:"document.body",connectWith:".accept-sub-folder",placeholder:"sort-folder-placeholder",items:".J-sortable-folder",dropOnEmpty:!0,distance:2,delay:200,scroll:!0,start:function(e,a){if(!$(a.item).hasClass("sort-table-placeholder")){if(!a.item.sortable.model||!t.enableSortFolder||t.isGettingFolder)return void a.item.sortable.cancel();$(a.helper).addClass("is-sorting");var r=a.item.sortable.model;t.dragCopyList=angular.copy(t.folderStructure),t.dragFolderFromTo.from_type="sub",t.dragFolderFromTo.from_id=r.parent_id||"",t.sortFolderHasSub=!1}},update:function(){},change:function(){},over:function(){},receive:function(){},stop:function(e,r){if(t.query)return r.item.sortable.cancel(),void _();t.getPosAfterSort(),$(e.target).removeClass("is-sorting");var i=r.item.sortable.model,o=w(i.folder_id),n=y(t.folderStructure,i.folder_id);t.dragFolderFromTo.to_type=n.type,t.dragFolderFromTo.to_id=n.parent_id;var l="top"==t.dragFolderFromTo.to_type?1:2;return g(i.name,i.folder_id,l,t.dragFolderFromTo.to_id)?void("sub"==t.dragFolderFromTo.to_type&&t.sortFolderHasSub?(a(t.tips["wb.cannotMoveTwoLevelsToSubFolder"]),r.item.sortable.cancel(),_(),t.changeFolderOpenStatus(t.folderStructure)):t.dragFolderFromTo.from_id==t.dragFolderFromTo.to_id?(o.folder_id=i.folder_id,v(o)):t.dragFolderFromTo.from_id!=t.dragFolderFromTo.to_id&&(o.folder_id=i.folder_id,m(o))):(a(t.tips["wb.repeatFolderName"]),r.item.sortable.cancel(),void _())}},t.sortTables={appendTo:"document.body",connectWith:".accept-tables",placeholder:"sort-table-placeholder",items:".J-sortable-excel",dropOnEmpty:!0,distance:2,delay:200,scroll:!0,start:function(e,a){if(!a.item.sortable.model||!t.enableSortWorkSheet||t.isGettingFolder)return a.item.sortable.cancel(),!1;$(e.target).addClass("is-sorting");var r=a.item.sortable.model;t.dragCopyList=angular.copy(t.folderStructure),t.sortWorkSheetData.from_folder_id=bdp.bdpTables.getFolderByTableId(t.folderStructure,r.tb_id).folder_id,t.sortWorkSheetData.from_tb_num=r.tb_seq_no},update:function(){},change:function(){},over:function(){},receive:function(){},stop:function(e,a){var i=a.item.sortable.model;if(t.query)return a.item.sortable.cancel(),void _();if(!i)return a.item.sortable.cancel(),_(),void t.changeFolderOpenStatus(t.folderStructure);if(t.getPosAfterSort(),$(e.target).removeClass("is-sorting"),t.sortWorkSheetData.to_folder_id=bdp.bdpTables.getFolderByTableId(t.folderStructure,i.tb_id).folder_id,!t.sortWorkSheetData.to_folder_id)return a.item.sortable.cancel(),_(),void t.changeFolderOpenStatus(t.folderStructure);t.sortWorkSheetData.to_tb_num=D(t.sortWorkSheetData.to_folder_id,i.tb_id),t.sortWorkSheetData.to_tb_num=void 0==t.sortWorkSheetData.to_tb_num?-2:t.sortWorkSheetData.to_tb_num,t.sortWorkSheetData.to_folder_id="folder_root"==t.sortWorkSheetData.to_folder_id?"folder_root":t.sortWorkSheetData.to_folder_id,t.enableSortWorkSheet=!1;var o={tb_id:i.tb_id,to_folder:t.sortWorkSheetData.to_folder_id,to_seq:t.sortWorkSheetData.to_tb_num,tb_index:t.sortWorkSheetData.tb_index};r.folder.change(o).then(function(e){0==Number(e.status)&&(t.getWorktableFromFolder({folder_id:t.sortWorkSheetData.to_folder_id}).then(function(){t.getWorktableFromFolder({folder_id:t.sortWorkSheetData.from_folder_id})}),t.enableSortWorkSheet=!0,t.getFolderList())})}},t.getCapacityStatistics(),t.goTableCapacityPage=function(){var t="table_capacity";e.wsId&&(t=t+"/"+e.wsId),d.path(t)};var F=null,k=0;t.searchFolderAndTable=function(){o.cancel(F),F=o(function(){var e=k=+new Date;!function(e){c.cancelOne("/api/folder/filter"),t.searchTableList=[],t.searchFolderList=[],t.searchingFolderAndTable=!0,t.showSearchFolderTable=!0;var a=t.queryFolderTable;a&&r.folder.searchFolderAndTable({filter_str:a}).then(function(a){if(0==a.status){if(k>e)return;t.searchingFolderAndTable=!1,t.originalSearchTableList=a.result.worksheet,t.originalSearchFolderList=a.result.folder,t.firstThreeTables=t.originalSearchTableList.slice(0,3),t.firstThreeFolders=t.originalSearchFolderList.slice(0,3),t.searchTableList=t.firstThreeTables.slice(0),t.searchFolderList=t.firstThreeFolders.slice(0)}})}(e)},100)},t.toggleSearchTableList=function(e){t.searchTableList="show"==e?t.originalSearchTableList.slice(0):t.firstThreeTables.slice(0)},t.toggleSearchFolderList=function(e){t.searchFolderList="show"==e?t.originalSearchFolderList.slice(0):t.firstThreeFolders.slice(0)},t.navigateToTable=function(e){e.sh_id&&(e.tb_id=e.sh_id),t.refreshSpecificFolderContent(e.tb_id).then(function(){e=bdp.bdpTables.getTableByTableId(t.folderStructure,e.tb_id),t.showDetailPage(e,!0),t.refreshFolderStatus(),t.queryFolderTable="",t.showSearchFolderTable=!1})},t.navigateToFolder=function(e){t.getWorktableFromFolder({folder_id:e.folder_id}).then(function(){e.parent_id&&t.getWorktableFromFolder({folder_id:e.parent_id});var a=[];t.folderStructure.forEach(function(t){t.folder_id==e.folder_id&&a.push(t),"folder_root"!=t.folder_id&&t.sub_folders.forEach(function(t){t.folder_id==e.folder_id&&a.push(t)})});var r=t.getFirst(a);r?t.navigateToTable(r):(t.folderStructure.forEach(function(t){t.folder_id==e.folder_id?(t.open=!0,t.currentSelected=!0):t.currentSelected=!1,t.sub_folders&&t.sub_folders.forEach(function(t){t.folder_id==e.folder_id?(t.open=!0,t.currentSelected=!0):t.currentSelected=!1})}),o(function(){var e=$("#ds-list > ul"),t=e[0].clientHeight,a=e.find(".current-folder")[0];a&&(e[0].scrollTop=a.offsetTop-t/2)},100),t.queryFolderTable="",t.showSearchFolderTable=!1)})},n(["wb.confirmDeleteWorkSheet","wb.confirmDeleteFolder","wb.deleteFailedSearch","wb.copyFail","wb.cannotMoveToCurrentFolder","wb.changeWorkSheetName","wb.editSuccesss","wb.unnameFolder","wb.inputFolderName","wb.createSuccess","wb.repeatFolderName","wb.createFailed","wb.worktableView","wb.databaseView","wb.deleteFolderErr","copySuccess","copyFail","wb.stickSuccess","wb.stickFail","join.worksheetname","join.inputWorkSheetName","nameInvalid","wb.cannotMoveToSubFolder","wb.cannotMoveTwoLevelsToSubFolder","wb.cannotAddToSubFolder","wb.tableCommentLimit","wb.tableLabelLimit","wb.tableNameLessThan100","wb.assign.success","wb.assign.nothingSelected","user.inputPicVerifyCode","error.codeError","user.inputPicVerifyCode","error.codeError","wb.chooseFromWorktable","wb.chooseToDirectory","wb.batchMoveSuccess","chart.moveChartSuccess","user.copySuccess"],t)}function t(){return{templateUrl:"/static/js/worktable/preview/worktable-folder-list.html",controller:e}}angular.module("BC.controllers.dataSource").directive("worktableList",t),e.$inject=["$rootScope","$scope","errHint","commonService","commonHttp","$timeout","$jsTipTranslate","ngDialog","verifyTbName","$location","pendingRequests"]}(),angular.module("BC.directives").directive("modifyField",function(){return{restrict:"A",link:function(e,t){e.copy_field=angular.copy(e.field),e.isModify=!1,e.edit=function(){e.isModify||(e.copy_field=angular.copy(e.field),e.editting=!0)},e.cancel=function(){e.editting=!1,e.copy_field=angular.copy(e.field)},e.save=function(){return e.copy_field.name?(e.isModify=!0,e.rename_field(e.copy_field.name,e.copy_field.type,e.field).then(function(){e.copy_field=angular.copy(e.field),e.isModify=!1,e.$emit("reloadFieldList")}),void(e.editting=!1)):void e.cancel()},e.modifyFieldType=function(t,a){t.ico_type=a,e.copy_field.type=a},t.on("keyup","input",function(t){function a(){e.$$phrase||e.$digest()}13==t.keyCode?(e.save(),a()):27==t.keyCode&&(e.cancel(),a())})}}}),!function(){function e(e,t,a,r,i,o,n,l,s,d,c){function u(){var t,a=!0,r=[];angular.forEach(e.files_list,function(e){t=/(\..{3,4})?$/.exec(e.name)[0].replace(/\./g,""),t="xls"==t?"xlsx":t,-1==$.inArray(t,r)&&r.push(t)}),a=r.length>1?!1:!0,e.formatHint=!a,a||(e.filesFormat=r[0])}function f(t){var a=!1;return/\.csv$/.test(t.name)?(_=uploadParam.csvMaxSize,t.size>v&&(a=!0,limitFileMsg="upload.csvFileSizeError")):(_=uploadParam.excelMaxSize,t.size>m&&(a=!0,limitFileMsg="upload.excelFileSizeError")),a?e.tips[limitFileMsg]+_+"M":void 0}function p(){for(var t=e.files_list,a=0,r=t.length;r>a;a++)if(t[a].fileSizeError)return!1;return!0}function g(){var t=0;return angular.forEach(e.files_list,function(e){t+=e.size}),t}function h(){var t={},a=[],r=!1;return angular.forEach(e.files_list,function(e){t[e.name]?r=!0:(t[e.name]=!0,a.push(e))}),e.files_list=a,r}function b(e){angular.element(".files-progress-ul")&&(angular.element(".files-progress-ul").get(0).scrollTop=48*e)}e.operate_type="batch",e.acceptTypes="text/csv,*.xls,*.xlsx,.csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",e.status="init",i(function(){e.uploadDialogTitle=e.tips["upload.batchAppend"],e.dialogTitle=e.tips["upload.batchAppend"],e.$$phase||e.$apply()},100),e.MAX_RERTRY=5,e.CUR_RETRY=0,e.files_list=[],e.clickDisabled=!0,e.csv_terminate="comma",e.csv_other="",e.uploadData={folder_id:e.selected.folder_id||"folder_root"},e.deleteMultipleFiles=function(t){e.files_list.splice(t,1),u()};var _,m=uploadParam.excelMaxSize*(1<<20),v=uploadParam.csvMaxSize*(1<<20);e.onFileInputChange=function(t,a){var r=e.files_list.length+a;return e.files_list.length+a>50?(alert(e.tips["upload.fileNumError"]+r+" "),t.length=0,!1):(h()&&alert(e.tips["upload.sameNameError"]),angular.forEach(t,function(t,a){t.id=a,t.status="init",t.progress=0,t.err_mesg="",t.show_err_mesg=!1,t.data_clear_mesg="",t.fileSizeError=f(t),e.files_list.push(t)}),u(),e.hasFile=t&&t.length,void(e.$$phase||e.$digest()))},e.confirm_upload_batch=function(){if(0==e.files_list.length)return alert(e.tips["upload.selectUploadFiles"]),!1;if(u(),e.formatHint)return void alert(e.tips["upload.fileFormatHint"]);if(p()){e.uploadData.total_size=g();var t=n.personalInfo,a=t.capacity;if("personal"==n.global.domain&&e.uploadData.total_size+t.used>a)return void c();if(e.file_type="excel","setCsv"==e.status||".csv"!=e.filesFormat){if("setCsv"==e.status){var r=e.csv_terminate;if("other"==e.csv_terminate&&(r=e.csv_other),!r)return void alert(e.tips["upload.csvDesc"]);e.file_type="csv",e.uploadData.field_terminate=r}e.$broadcast("fileInputChange",e.files_list),e.uploadData.tb_id=e.uploadOption.default_tb}else e.status="setCsv"}},e.$watch("files_list",function(){h()&&alert(e.tips["upload.sameNameError"]);var t=e.files_list.length;e.files_list.length>50&&alert(e.tips["upload.fileNumError"]+t+" ")},!0),e.onUpload=function(){"s_admin"==n.role&&$(".ngdialog").removeClass("ng-ds-sadmin-dialog"),e.status="loading",e.showProgress=!0},e.onProgress=function(t){e.uploadProgress=(100*t).toFixed(2)+"%",angular.element(".append-progress-bar-top.uploading").css("width",e.uploadProgress)},e.onError=function(t){var a=t.data;e.showProgress=!1,e.responseData=a,e.errMsg=a.errstr,23040==a.status&&c(),20==a.status&&angular.element(".append-progress-bar-top.formatError").css("width",0)},e.onComplete=function(t){var a=t.data;if(e.showProgress=!1,e.errSheet=[],0==a.status)e.dialogTitle=e.tips["upload.batchAppend"],e.status="success",3==n.enterprise_type&&e.$emit("changeCapacity","change");else{if(1==a.status)return void(location.href="/login.html");e.onError(t)}},e.ableToClick=function(t){e.clickDisabled=t},e.onChangeStatus=function(t){e.files_list[t.index].status=t.status,e.files_list[t.index].err_mesg=t.err_mesg,e.files_list[t.index].data_clear_mesg=t.data_clear_mesg,(t.index>=4||"analyzeComplete"==t.status)&&b(t.index-4+1)},e.complete_batch_append=function(){e.showTab(e.activeTab.index),e.getFolderList(),e.closeDialog()},e.hiddenFileClick=function(){angular.element("#file_input").click()},e.showErrorTips=function(e,t,a){var r=angular.element(".upload-error-tip"),i=l.positionElements($(t),r,"bottom");angular.element(".upload-error-tip").css("width","auto"),angular.element(".upload-error-tip").css("display","block"),angular.element(".upload-error-tip").css("top",i.top+4),angular.element(".upload-error-tip").html(a);var o=angular.element(".upload-error-tip").css("width");angular.element(".upload-error-tip").css("left",i.left-parseInt(o)+10),parseInt(o)>"300"&&(angular.element(".upload-error-tip").css("width",300),angular.element(".upload-error-tip").css("left",i.left-290))},e.hideErrorTips=function(){angular.element(".upload-error-tip").css("display","none"),angular.element(".upload-error-tip").css("top",0),angular.element(".upload-error-tip").css("left",0)},e.showOffsetTips=function(e,t,a){var r=angular.element(".upload-error-tip"),i=l.positionElements($(t),r,"bottom");angular.element(".upload-error-tip").css("width","auto"),angular.element(".upload-error-tip").css("display","block"),angular.element(".upload-error-tip").css("top",i.top+4),angular.element(".upload-error-tip").html(a);var o=angular.element(".upload-error-tip").css("width");angular.element(".upload-error-tip").css("left",i.left-parseInt(o)+10),o>"300"&&(angular.element(".upload-error-tip").css("width",300),angular.element(".upload-error-tip").css("left",i.left-290))},e.hideOffsetTips=function(){angular.element(".upload-error-tip").css("display","none"),angular.element(".upload-error-tip").css("top",0),angular.element(".upload-error-tip").css("left",0)},s(["upload.batchAppend","upload.selectUploadFiles","upload.fileSizeError","upload.fileNumError","upload.sameNameError","upload.fileFormatHint","upload.csvDesc","upload.csvFileSizeError","upload.excelFileSizeError"],e)}angular.module("BC.controllers.dataSource").controller("UploadBatchController",e),e.$inject=["$scope","commonService","$location","ngDialog","$timeout","errHint","$rootScope","$position","$jsTipTranslate","$translate","capacityHint"]}(),angular.module("BC.controllers.dataSource").directive("worktablePreviewFilter",["filterOperatorMapWithType","$timeout","$jsTipTranslate","errHint","$translate","ngDialog","dateTimeByHalfHour",function(e,t,a,r,i,o,n){return{restrict:"A",scope:!0,templateUrl:"/static/js/worktable/preview/worktable-preview-filter.html",replace:!0,link:function(l){function s(){i(h).then(function(e){l.dateOperatorMap.length=0,l.dateOperatorMap.push({value:10,name:e[h[0]]}),l.dateOperatorMap.push({value:8,name:e[h[1]]}),l.dateOperatorMap.push({value:9,name:e[h[2]]})})}function d(){l.previewFilterData=angular.copy(g),l.workTableFilter.showIt=!1,l.lastParamData=angular.copy(b),_=!0}function c(e){var t=angular.copy(b);return t.where.where_linker=e.where.where_linker,t.where.where_type=e.where.where_type,t.sort=e.sort,angular.forEach(e.where.condition.filters,function(e){var a=null,r=!1;if(null!=e.field){var i=l.fieldTypeMap[e.field.type];a={fid:e.field.fid,data_type:i,operator:null,value:null,start_date:null,end_date:null},"date"==i?null==e.startDate&&null==e.endDate||10!=e.operator?(8==e.operator||9==e.operator)&&(a.operator=e.operator,a.value="",r=!0):(a.operator=e.operator,a.start_date=e.startDate,a.end_date=e.endDate,a.value="",r=!0):8==e.operator||9==e.operator&&""===e.value?(a.operator=e.operator,a.value=e.value,r=!0):null!=e.operator&&null!=e.value&&e.value.length>0&&(a.operator=e.operator,a.value=e.value,r=!0)}r&&t.where.condition.filters.push(a)}),t}function u(e){for(var t=angular.copy(l.lastParamData),a=t.where.condition.filters,r=0,i=a.length;i>r;r++)a[r]&&null==a[r].fid&&a.splice(r,1);return a&&a.length<=0&&(t.where.where_linker=""),t.sort=e,t}function f(){t(function(){var e=0,t=$("#J_table_filter").outerHeight()||47,a=e+t;47>a&&(a=47),$("#tb-detail").css("paddingTop",a)},0)}function p(e){var t=$(e.target).parents(".J-table-filter-search:first"),a=t.find(".J-table-filter-result:first");pos=t.offset(),a.css({position:"fixed",top:pos.top+24+4,left:pos.left})}l.operatorMapWithType=e,l.dateTimeByHalfHour=n;var g={where:{where_type:"condition",where_linker:"and",sql:[],condition:{filters:[{value:null,operator:null,field:null,startDate:null,endDate:null,inputDisabled:!1}]}},sort:[]},h=["chart.selectDateRange","isEmpty","isNotEmpty"];l.dateOperatorMap=[],s();var b={where:{where_linker:"and",where_type:"condition",condition:{filters:[]}},sort:[]},_=!0;l.previewFilterData=angular.copy(g),l.$watch("resetPreviewFilterData.flag",function(e,t){e!=t&&d()}),l.previewFilterAction=function(){var e=c(l.previewFilterData);e.where.condition.filters.length<=0&&e.sort.length<=0&&_||l.show_preview_data(e)},l.$on("last-param-change",function(e,t){_=!1,null==t&&(t=angular.copy(b),_=!0),l.lastParamData=angular.copy(t)}),l.lastParamData=angular.copy(b),l.$on("fire-change-sort",function(e,t,a){l.changeWorkTableSort(t,a)}),l.changeWorkTableSort=function(e,t){l.previewFilterData.sort=[{fid:e,type:t}],null!=e&&l.show_preview_data(u(l.previewFilterData.sort))},l.changeSelectField=function(t){var a=!0;angular.forEach(l.previewData.origin_schema,function(e){t.field.fid==e.fid&&(a=!1,t.field=angular.copy(e))}),t.inputDisabled=!1,a?t.field=null:t.operator="date"==l.fieldTypeMap[t.field.type]?l.dateOperatorMap[0].value:e[l.fieldTypeMap[t.field.type]][0].value},l.addDefaultPreviewFilter=function(){var e=l.previewFilterData.where.condition.filters,t=e.length,a=e[t-1],i=!1;null!=a.field&&("date"==l.fieldTypeMap[a.field.type]?(null!=a.startDate||null!=a.endDate||8==a.operator||9==a.operator)&&(i=!0):null!=a.operator&&null!=a.value&&""!==a.value&&(i=!0),8!=a.operator&&9!=a.operator||a.value||(i=!0)),i?e.push(angular.copy(g.where.condition.filters[0])):r(l.tips["wb.filterTip"]),f()},l.delPreviewFilter=function(e){var t=l.previewFilterData.where.condition.filters;t.splice(e,1),t.length<=0&&t.push(angular.copy(g.where.condition.filters[0])),f()},l.$watch("workTableFilter.showIt",function(e,t){e!==t&&f()}),l.$watch("visibleFieldStatus.showFlag",function(e,t){e!==t&&f()}),l.$watch("workTableFilter.refreshCalculateFilter",function(e,t){e!==t&&f()}),l.$watch("visibleFieldStatus.refreshVisibleField",function(e,t){e!==t&&f()}),l.$on("updateConditionHeight",function(){f()}),l.filterChange=function(e){8==e.operator||9==e.operator?(e.value="",e.endDate=null,e.startDate=null,e.inputDisabled=!0):e.inputDisabled=!1},l.togglePrompt={},l.requestFilterItem=function(e,t,a){var r=!1;"input"==a?13==event.keyCode&&(r=!0):"click"==a&&(r=!0),l.togglePrompt[t]=r,r&&p(e)},l.dateRangShow=function(e){var t=[];if(e.startDate&&e.endDate&&(t=[e.startDate,e.endDate]),!e.inputDisabled){var t=[e.startDate,e.endDate];if(t[0]||t[1]||(t[0]=Highcharts.dateFormat("%Y-%m-%d",+new Date),t[1]=Highcharts.dateFormat("%Y-%m-%d",+new Date)),t.length>1){var a=t[0]?t[0].split(" ")[1]||"00:00:00":"00:00:00",r=t[1]?t[1].split(" ")[1]||"23:59:59":"23:59:59";t=t.concat([a,r])}else 0===t.length&&(t=[+new Date,+new Date,"00:00:00","23:59:59"]);o.open({template:"/static/partials/dialogTemplates/custom_date_modal.html",className:"ngdialog-theme-default date-picker-modal daterange-bdp-modal",data:{filterItem:e,range:t},scope:l})}},l.saveDateRange=function(e){var t=e.sDate?Highcharts.dateFormat("%Y-%m-%d",new Date(e.sDate))+" "+e.sDateHour:null,a=e.eDate?Highcharts.dateFormat("%Y-%m-%d",new Date(e.eDate))+" "+e.eDateHour:null;if(!t&&!a)return r(l.tips["chart.dateRangeRequired"]),!1;if(t&&a){if(!e.sDateHour)return r(l.tips["filter.startDateErr2"]),!1;if(!e.eDateHour)return r(l.tips["filter.endDateErr2"]),!1;if(new Date(t)-new Date(a)>0)return r(l.tips["filter.dateRangeInvalid"]),!1}else{if(t&&!a&&!e.sDateHour)return r(l.tips["filter.startDateErr2"]),!1;if(!t&&a&&!e.eDateHour)return r(l.tips["filter.endDateErr2"]),!1}e.data.filterItem.startDate=t,e.data.filterItem.endDate=a,o.closeAll()},a(["wb.filterTip","filter.dateRangeInvalid","chart.dateRangeRequired","filter.startDateErr2","filter.endDateErr2"],l)}}}]),angular.module("BC.directives").directive("startEndDate",["$timeout","dateTimeByHalfHour","errHint","$jsTipTranslate",function(e,t,a,r){return{restrict:"A",scope:{startDate:"=",endDate:"=",dateRangShow:"=",complete:"&"},templateUrl:"/static/js/worktable/preview/start-end-date.html",link:function(i){function o(e){return Highcharts.dateFormat("%Y-%m-%d",e)}if(i.dateTimeByHalfHour=t,i.range=[i.startDate,i.endDate],i.range.length>1){var n=i.range[0]?i.range[0].split(" ")[1]||"00:00:00":"00:00:00",l=i.range[1]?i.range[1].split(" ")[1]||"23:59:59":"23:59:59";i.range[0]||i.range[1]||(i.range[0]=o(new Date),i.range[1]=o(new Date)),i.range=i.range.concat([n,l])}i.$watch("startDate",function(e){null===e&&null===i.endDate&&(i.range=[o(new Date),o(new Date),"00:00:00","23:59:59"])}),i.$watch("endDate",function(e){null===e&&null===i.startDate&&(i.range=[o(new Date),o(new Date),"00:00:00","23:59:59"])}),i.sure=function(){var t=i.start_date?o(new Date(i.start_date))+" "+i.start_date_hour:null,r=i.end_date?o(new Date(i.end_date))+" "+i.end_date_hour:null;if(!t&&!r)return a(i.tips["chart.dateRangeRequired"]),i.dateRangShow=!0,!1;if(t&&r){if(!i.start_date_hour)return a(i.tips["filter.startDateErr2"]),i.dateRangShow=!0,!1;if(!i.end_date_hour)return a(i.tips["filter.endDateErr2"]),i.dateRangShow=!0,!1;if(new Date(t)-new Date(r)>0)return a(i.tips["filter.dateRangeInvalid"]),i.dateRangShow=!0,!1}else{if(t&&!r&&!i.start_date_hour)return a(i.tips["filter.startDateErr2"]),i.dateRangShow=!0,!1;if(!t&&r&&!i.end_date_hour)return a(i.tips["filter.endDateErr2"]),i.dateRangShow=!0,!1}i.startDate=t,i.endDate=r,i.complete&&e(function(){i.complete()},0)},r(["filter.dateRangeInvalid","chart.dateRangeRequired","filter.startDateErr2","filter.endDateErr2"],i)}}}]),!function(){function e(e,t,a,r,i,o,n,l,s,d,c){function u(){return a.ds.tbList().then(function(t){0==t.status&&(e.dsTBList=t.result,e.original_dbList=angular.copy(t.result))})}function f(t){function a(e){return e.map(function(e){e.title=e.nick_name}),e}function r(){for(var t,a=0;a<e.unionTablesSql.length;a++)if(e.unionTablesSql[a].open){t=a;break}return t}var i=[];e.union_tables.map(function(e,t){fieldList=a(e.origin_fields);var o={tb_id:e.dstb_id||e.tb_id,name:e.title||e.name,fields:fieldList};t==r()&&(o.open=!0),i.push(o)}),e.unionTablesSql=i,e.initUnionTableSql||(e.initUnionTableSql=!0,s(function(){e.$broadcast("initTbList")},1e3)),t&&s(function(){e.$broadcast("updateTbList")},10)}function p(a,r){function i(r){t.pageLoading=!0,e.requestDone=!1;var i=angular.copy(e.union_tables_thead),n=angular.copy(e.union_tables);return angular.forEach(s,function(e){for(c=0;r>c;c++)n[c].selected_fields.splice(e.index,1);i.current.splice(e.index,1)}),"modify"==e.model?void y(n,e.union_table_name,e.save_folder.folder_id,i).then(function(i){if(e.requestDone=!0,0==i.status){var n=i.result.can_del;1==n||2==n?angular.forEach(s,function(t){e.union_tables_thead.history[t.index].can_del=!0}):(angular.forEach(i.result.dependency,function(t){angular.forEach(s,function(a){t.fid==a.field_id&&(e.union_tables_thead.history[a.index].can_del=!1)})}),angular.forEach(s,function(t){0!=e.union_tables_thead.history[t.index].can_del&&(e.union_tables_thead.history[t.index].can_del=!0)}));for(var l=e.union_tables_thead.history.length-1;l>=0;l--)if(1==e.union_tables_thead.history[l].can_del)for(e.union_tables_thead.current.splice(l,1),e.union_tables_thead.history.splice(l,1),c=0;r>c;c++)a[c].splice(l,1);t.pageLoading=!1}else 40002==Number(i.status)&&o(i.errstr?e.tips["error.fieldRepeat"]+":"+i.errstr:Number(i.status)),t.pageLoading=!1}):void 0}for(var n=a[0].length,l=a.length,s=[];n--;){for(var d=!0,c=0;l>c;c++)if(a[c][n]&&a[c][n].fid){d=!1;break}if(d){if(r.history[n]){if(void 0===r.history[n].can_del){s.push({index:n,field_id:r.history[n].field_id});continue}continue}for(c=0;l>c;c++)a[c].splice(n,1)}}s.length>0&&i(l)}function g(){for(var t=!0,a=0,r=e.union_tables_thead.current.length;r>a;a++)if(""===e.union_tables_thead.current[a].title){t=!1;break}return t}function h(){function t(t,a){function r(t,a,n){angular.forEach(t,function(t){angular.forEach(t.tb_list,function(r){r.tb_id==a&&(o=!0,i="folder_root"!=t.folder_id?n?n+"/"+t.name:t.name:e.tips["extract.folderRoot"])}),!o&&t.sub_folders&&t.sub_folders.length>0&&r(t.sub_folders,a,t.name)})}var i="",o=!1;return r(t,a,""),i}e.folderList&&e.union_tables.length&&e.union_tables.map(function(a){a.folderName=t(e.folderList,a.tb_id)})}function b(){return a.folder.getList().then(function(t){function a(e){for(var t=0;t<e.length;t++){for(var i=0,o=e[t].tb_list.length;o>i;i++)if(e[t].tb_list[i].tb_id==d.tbId){e[t].tb_list.splice(i,1),r=!0;break}!r&&e[t].sub_folders&&e[t].sub_folders.length>0&&a(e[t].sub_folders)}}if(d.tbId){var r=!1;a(t)}e.saveFolderList=angular.copy(t),angular.forEach(e.saveFolderList,function(e){"folder_root"==e.folder_id&&(e.name="en"==$.cookie("locale")?"Root":"根目录")});var i=bdp.bdpTables.getFolderByFolderId(e.saveFolderList,e.save_folder.folder_id);e.save_folder.folder_name=i?i.name:"",e.original_folderList=angular.copy(t),angular.forEach(e.saveFolderList,function(t){"folder_root"==t.folder_id&&(t.name=e.tips["extract.folderRoot"])}),e.folderList=t,e.$broadcast("updatefolderList",e.folderList),h(),L()})}function _(t,a){function r(t){for(var a=e.union_tables,r=0;r<a.length;r++)if(a[r].tb_id==t)return!0;return!1}var i=t.map(function(e){var t=e.selected_fields.map(function(e){return e.fid||""});return{tb_id:e.tb_id,col_fid_list:t}}),o=F(),n={tb_list:i,schema:a?a.current:e.union_tables_thead.current,where:{where_linker:o.where_linker,where_type:e.union_filter.where_type}};
if("sql"==e.union_filter.where_type){var l=[];angular.forEach(e.union_filter.sql,function(e,t){e&&r(t)&&l.push({tb_id:t,sql:e})}),n.where.sql=l}else n.where.condition={filters:o.where};return n.empty_holder=x,n}function m(t){var a=_(t);return n.preview(a).then(function(t){0==Number(t.status)?(t.result.data.length>50&&(t.result.data=t.result.data.slice(0,50)),e.previewData=t.result):30003==Number(t.status)?o(t.errstr):40002==Number(t.status)&&o(t.errstr?e.tips["error.fieldRepeat"]+":"+t.errstr:Number(t.status))})}function v(t,a){var r=_(t);return e.union_gen_fids&&(r.gen_fids=e.union_gen_fids),n.modifyUnion(r,a,d.tbId)}function w(e,t,a){var r=_(e);return n.union(r,t,a)}function y(t,a,r,i){var o=_(t,i);return e.union_gen_fids&&(o.gen_fids=e.union_gen_fids),n.modifyPreview(o,a,d.tbId,r)}function D(e){return e.tb&&e.field&&(8==e.operator||9==e.operator||10==e.operator||""!==e.value&&void 0!=e.value)&&(10!=e.operator||""!=e.startDate&&""!=e.endDate)?!0:!1}function T(e){if("number"==e.field.data_type&&8!=e.operator&&9!=e.operator){if(isNaN(Number(e.value)))return!1;if(""===e.value)return!1;e.value=Number(e.value)}return!0}function F(){var t=angular.copy(e.union_filter);return t.where=$.map(t.where,function(e,t){return 0!=t&&D(e)&&T(e)?{data_type:e.field.data_type,fid:e.field.fid,field:e.field.nick_name,type:e.field.type,operator:e.operator,value:e.value,tb_id:e.tb.tb_id,tb_name:e.tb.title||e.tb.name,start_date:e.startDate?e.startDate:null,end_date:e.endDate?e.endDate:null}:null}),t}function k(){if("modify"==e.model)var t=e.union_tables_thead.history.length,a=angular.copy(e.union_tables_thead.history);else var t=0,a=[];if(!(e.union_tables.length>0))return[];for(var r=e.union_tables[0].selected_fields.length,i=e.union_tables.length;r>t;t++)for(var o=0;i>o&&!a[t];o++)e.union_tables[o].selected_fields.length>0&&e.union_tables[o].selected_fields[t].fid&&a.push({type:e.fieldTypeMapForParam[e.union_tables[o].selected_fields[t].data_type],title:e.union_tables[o].selected_fields[t].nick_name,name:e.union_tables[o].selected_fields[t].name,field_id:null});return a}function L(){function t(t){t.choosed=e.paddingFieldsMap[t.tb_id]?!0:!1}angular.forEach(e.folderList,function(e){e.tb_list.map(t),e.sub_folders&&e.sub_folders.length>0&&angular.forEach(e.sub_folders,function(e){e.tb_list.map(t)})}),angular.forEach(e.original_folderList,function(e){e.tb_list.map(t),e.sub_folders&&e.sub_folders.length>0&&angular.forEach(e.sub_folders,function(e){e.tb_list.map(t)})}),e.$broadcast("updatefolderList",e.original_folderList),S()}function S(){function t(e){var t=[];return e.map(function(e){t.push(e.tb_id)}),t}function a(e,t,i){e.sub_folders&&e.sub_folders.length>0&&n(e.sub_folders,a),n(e.tb_list,r),0!=e.tb_list.length||e.sub_folders&&0!=e.sub_folders.length||i.splice(t,1),e.open=!0}function r(e,t,a){-1==$.inArray(e.tb_id,o)&&a.splice(t,1)}function i(){e.view.listView&&e.$broadcast("updateList",e.view.choosedList)}if(e.view.choosedList=[],0==e.union_tables.length)return void i();var o=t(e.union_tables),n=bdp.utils.descMap,l=angular.copy(e.original_folderList);l&&(n(l,a),e.view.choosedList=l,e.view.originChoosedList=angular.copy(l),i())}t.show_bdp_header=!1,e.union_tables=[],e.union_tables_thead={history:[],current:[]},e.union_filter={where_type:"condition",where_linker:"and",where:[{tb:null,field:null,value:null,operator:null}],sql:{}};var x=void 0;e.unionTablesSql=[],e.initUnionTableSql=!1,e.paddingFieldsMap={},e.union_table_name="",e.tabView=!0,e.workdListView="folderList",e.viewTip="",e.saveFolderList=null,e.save_folder={folder_id:$.cookie("select_folder_id")?$.cookie("select_folder_id"):"folder_root",folder_name:""},e.batchTb={},e.view={preview:!1,listView:0},e.unionTableFt={open:!0,tab:1},e.requestDone=!0,e.fieldTypeMapForParam={number:1,string:2,date:3},e.unionTableFt.tabFun=function(t,a){e.unionTableFt.tab=t,e.unionTableFt.open=!0,a.stopPropagation(),e.preview()},t.wsId||u(),e.toggleView=function(){e.query="","folderList"==e.workdListView?(e.workdListView="dsTbList",e.viewTip=e.tips["wb.databaseView"],e.dsTBList=angular.copy(e.original_dbList)):(e.workdListView="folderList",e.viewTip=e.tips["wb.worktableView"],e.folderList=angular.copy(e.original_folderList))};var E=null;e.dragStart=function(t,a,r,i){E=r,E.folderName=i?i:e.tips["extract.folderRoot"]},e.onDrop=function(){var t=!1;angular.forEach(e.union_tables,function(e){E.tb_id==e.tb_id&&(t=!0)}),t?o(e.tips["union.batchAdded"]):e.getTableFields(E.tb_id).then(function(t){E.origin_fields=t,e.showSelectFieldsDialog(E)})},e.sortData={},e.sortFields={items:".sort-field",cursor:"move",forceHelperSize:!0,start:function(t,a){e.sortData.dragField=a.item.sortable.model,e.sortData.dragIndex=a.item.sortable.index,e.sortData.list=a.item.sortable.sourceModel,e.sortData.sortable=a.item.sortable,e.sortData.blockSort=!1},beforeStop:function(){e.sortData.blockSort&&e.sortData.sortable.cancel()},stop:function(){e.buildFields(),e.union_tables_thead.current=k()}},e.onDropToHelper=function(t){$(t.target).removeClass("empty-field-over"),e.sortData.list.splice(e.sortData.dragIndex,1,{}),e.sortData.list.push(e.sortData.dragField),e.buildFields()},e.onDropToEmpty=function(t,a,r){e.sortData.list[e.sortData.dragIndex].fid!=e.sortData.dragField.fid&&(e.sortData.dragField=angular.copy(e.sortData.list[e.sortData.dragIndex])),$(t.target).removeClass("empty-field-over"),e.sortData.list[e.sortData.dragIndex]=e.sortData.list[r],e.sortData.list[r]=e.sortData.dragField,e.buildFields()},e.onDropOver=function(t){$(t.target).addClass("empty-field-over"),e.sortData.blockSort=!0},e.onDropOut=function(t){$(t.target).removeClass("empty-field-over"),e.sortData.blockSort=!1},e.addTable=function(t,a){a&&(t=e.autoSortFields(t,a)),e.union_tables.push(t),f("add"),e.buildFields(),e.calculateTableNameWidth(),L()},e.autoSortFields=function(t,a){function r(){var e=[];return o.map(function(t,a){e[a]={}}),e}var i=e.union_tables,o=e.baseFields;if(0==i.length)return t;if(a){for(var n=[],l=0,s=i.length;s>l;l++)if(i[l].tb_id==a){n=i[l].selected_fields;break}o=[],n.map(function(e){o.push(e.nick_name)})}else o=e.baseFields;var d=[],c=r(),u=t.selected_fields;return c.length=o.length,u.map(function(e){var t=$.inArray(e.nick_name,o);t>-1?c[t]=e:d.push(e)}),d.length==u.length?t:(d.length>0&&(c=c.concat(d)),t.selected_fields=c,t)},e.calculateTableNameWidth=function(){var t=0;t=hz.cutString.getP(e.tips["union.workTableHeader"]),angular.forEach(e.union_tables,function(e){t=Math.max(t,hz.cutString.getP(e.title||e.name))}),t+=30,t=Math.min(t,125),s(function(){$(".union-table-list .table-name").css("width",t)},10)},e.buildFields=function(){var t={};if(!e.union_tables.length)return void(e.union_tables_thead.current=k());var a,r,i=e.union_tables[0].selected_fields.length,o=[];for(a=1,r=e.union_tables.length;r>a;a++)i=Math.max(i,e.union_tables[a].selected_fields.length);for(a=0,r=e.union_tables.length;r>a;a++){var n=e.union_tables[a];t[n.tb_id]=n.selected_fields;for(var l=i-n.selected_fields.length;l>0;)t[n.tb_id].push({}),l--;o.push(t[n.tb_id])}e.union_tables_thead.current=k(),p(o,e.union_tables_thead),e.paddingFieldsMap=t},e.goTbPos=function(t){for(var a,r=0,i=e.union_tables.length;i>r;r++)if(e.union_tables[r].tb_id==t){a=r;break}var o=$(".union-table-list > li.union_table_tbody")[a],n=$(".union-table-list")[0],l=n.clientHeight,d=o.offsetTop+50,c=n.scrollTop;return c>d?void(n.scrollTop=c-d-50):(d>l&&(n.scrollTop=d-l+50),$(o).addClass("selected-found"),void s(function(){$(o).removeClass("selected-found")},500))},e.showSelectFieldsDialog=function(t){e.selectFieldsDialog=i.open({template:"/static/js/worktable/union/union_select_fields_dialog.html",className:"ngdialog-theme-default",scope:e,data:{table:t,tbTip:t.folderName+"/"+(t.title||t.name)},controller:"unionSelectFieldsCtrl"})},e.showSelectTablesDialog=function(t){e.batchTb.addList=[],i.open({template:"/static/js/worktable/union/union_select_table_dialog.html",className:"ngdialog-theme-default ngDialog-width-650",scope:e,data:{unionTable:e.union_tables,table:t},controller:"unionSelectTableCtrl"})},e.deleteTable=function(t){for(var a=e.union_tables.splice(t,1),r=e.union_filter.where.length-1;r>=0;r--)e.union_filter.where[r].tb&&e.union_filter.where[r].tb.tb_id==a[0].tb_id&&(0==r?e.union_filter.where.splice(r,1,{tb:null,field:null,value:null,operator:null}):e.union_filter.where.splice(r,1));e.buildFields(),e.calculateTableNameWidth(),delete a[0].selected_fields,delete e.paddingFieldsMap[a[0].tb_id],L(),f("delete")},e.deleteAllTable=function(){for(var t=e.union_tables.length-1;t>=0;)e.deleteTable(t),t--},e.back=function(){function a(){var e="/data_source";t.wsId&&(e+="/"+t.wsId),r.path(e)}e.union_tables.length>0?i.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngdialog-width-340",scope:e,data:{message:e.tips["join.confirmToBack"]}}).then(function(){a()}):a()},e.preview=function(){return e.union_tables.length?(e.view.preview=!0,t.pageLoading=!0,void m(e.union_tables).then(function(){t.pageLoading=!1})):(e.previewData=void 0,void o(e.tips["union.AddWorkTableToPreview"]))},e.saveTb=function(){if(!g())return void o(e.tips["union.workTableHeaderNotNull"]);if(e.requestDone){var a=e.union_table_name;if(""==a)return o(e.tips["union.workSheetCanNotNull"]),!1;if(e.union_tables.length<1)return o(e.tips["union.atLeastOneWorksheet"]),!1;t.pageLoading=!0;var n=e.save_folder.folder_id;e.requestDone=!1;var l=angular.copy(e.union_tables_thead);return"modify"==e.model?void y(e.union_tables,e.union_table_name,e.save_folder.folder_id,l).then(function(a){if(e.requestDone=!0,0==a.status){var n=a.result.can_del;if(1==n)v(e.union_tables,e.union_table_name).then(function(a){0==a.status?r.path(t.wsId?"/data_source/"+t.wsId:"/data_source"):(40002==Number(a.status)&&o(a.errstr?e.tips["error.fieldRepeat"]+":"+a.errstr:Number(a.status)),t.pageLoading=!1)});else if(2==n)r.path(t.wsId?"/data_source/"+t.wsId:"/data_source");else{e.responseHint={dependency:a.result.dependency};var l="en"==$.cookie("locale")?"Untitled Chart":"未命名图表";angular.forEach(e.responseHint.dependency,function(e){angular.forEach(e.chart,function(e){e.ct_name||(e.ct_name=l)})}),i.open({template:"/static/partials/dialogTemplates/tableModifyHint.html",className:"ngdialog-theme-default",scope:e}),t.pageLoading=!1}}else o(40002==Number(a.status)&&a.errstr?e.tips["error.fieldRepeat"]+":"+a.errstr:Number(a.status)),t.pageLoading=!1}):void w(e.union_tables,e.union_table_name,n).then(function(a){if(e.requestDone=!0,0==a.status){var i=a.result.tb_id;$.cookie("ds_tb_id",i),r.path(t.wsId?"/data_source/"+t.wsId:"/data_source"),t.pageLoading=!1}else 40002==Number(a.status)&&o(a.errstr?e.tips["error.fieldRepeat"]+":"+a.errstr:Number(a.status)),t.pageLoading=!1,$.cookie("ds_tb_id",i)})}},b();var C=function(a){function r(t){function a(t){var a,r={};angular.forEach(t,function(e,t){r[e.tb_id]=e.sql,0==t&&(a=e.tb_id)}),e.union_filter.sql=r,s(function(){e.$broadcast("initSql",a)},10)}function r(t){angular.forEach(t,function(t){var a,r;angular.forEach(e.union_tables,function(e){t.tb_id==e.tb_id&&(a=e)}),angular.forEach(a.origin_fields,function(e){e.fid==t.fid&&(r=e)}),e.union_filter.where.push({tb:a,field:r,value:t.value,operator:t.operator,startDate:t.start_date,endDate:t.end_date})})}e.union_filter.where_linker=t.where_linker||"and",e.union_filter.where_type=t.where_type,"sql"==t.where_type?a(t.sql):r(t.condition.filters)}function i(e,t){for(var a=0,r=e.length;r>a;a++)if(e[a].fid==t)return e[a];return null}t.pageLoading=!0,l.get("/api/tb/model_struct",{tb_id:a}).then(function(a){if(t.pageLoading=!1,0==a.status){var o=a.result;e.union_tables=[],angular.forEach(o.table.fields,function(t){t.flag||e.union_tables_thead.history.push({field_id:t.field_id,title:t.title,name:t.name,type:t.type})}),e.union_tables_thead.current=angular.copy(e.union_tables_thead.history),x=o.empty_holder,angular.forEach(o.info,function(t){t.origin_fields=t.fields.map(function(e){return e.nick_name=e.title,e});var a=t.selected_fields=[];angular.forEach(t.col_fid_list,function(e){a.push(e?i(t.fields,e):{})}),e.union_tables.push(t)}),o.hasOwnProperty("gen_fids")&&(e.union_gen_fids=o.gen_fids),e.union_table_name=o.table.title,e.buildFields(),e.calculateTableNameWidth(),h(),L(),f(),r(o.where)}})};d.tbId&&(C(d.tbId),e.model="modify"),e.getTableFields=function(e){return a.db.getField(e).then(function(e){return e.columns})},e.showSelectFolder=function(){i.open({templateUrl:"/static/js/worktable/tableDialog/choose_table_folder.html",scope:e,className:"ngdialog-theme-default choose-folder",data:{tbType:"union",optType:"baseChoose",folderList:e.saveFolderList||[],folderQueryList:[],targetFolderId:e.save_folder.folder_id||"folder_root",targetFolderType:"",queryText:"",open:{},confirmSave:e.saveSelectFolder},controller:"chooseTbFolderCtrl"})},e.saveSelectFolder=function(t){e.save_folder.folder_id=t.targetFolderId;var a=bdp.bdpTables.getFolderByFolderId(e.saveFolderList,e.save_folder.folder_id);e.save_folder.folder_name=a?a.name:"",i.closeAll()},c(["join.optionsCanNotNull","union.workSheetCanNotNull","union.needTwoSheetToUnion","union.AddWorkTableToPreview","error.fieldRepeat","union.doNotSubmitRepeat","union.saveSuccess","union.saveFailed","union.atLeastOneWorksheet","wb.databaseView","wb.worktableView","extract.folderRoot","union.batchAdded","union.workTableHeader","union.workTableHeaderNotNull","join.confirmToBack"],e)}function t(e,t,a,r){function i(e){var t={},a=e.selected_fields;return angular.forEach(e.origin_fields,function(e){var r=a?angular.indexOf(a,e)>-1:!0;e.check=r;var i=e.data_type;t[i]?t[i].push(e):t[i]=[e]}),t}function o(e){for(var t in e)if(e.hasOwnProperty(t))for(var a=e[t],r=0,i=a.length;i>r;r++)if(!a[r].check)return!1;return!0}function n(e){var t=[];return angular.forEach(e,function(e){t=t.concat(e)}),t}e.fields=i(e.ngDialogData.table),e.selectAll=o(e.fields),e.confirm=function(t){function a(e){var t=[];return angular.forEach(e,function(e){e.check&&t.push(e.fid)}),t}function i(e,t){for(var a=0,r=e.length;r>a;a++)if(e[a].fid==t)return a;return-1}var o=e.ngDialogData.table.selected_fields,l=n(e.fields),s=a(l);if(0==s.length)return r(e.tips["union.selectFields"]),!1;if(o)angular.forEach(l,function(e){var t=i(o,e.fid);0>t&&e.check?o.push(e):t>-1&&!e.check&&(o[t]={})}),e.buildFields();else{if(o=[],angular.forEach(e.ngDialogData.table.origin_fields,function(e){angular.indexOf(s,e.fid)>-1&&o.push(e)}),o.length<e.union_tables_thead.history.length)for(var d=o.length;d<e.union_tables_thead.history.length;d++)o.push({});e.ngDialogData.table.selected_fields=o,e.addTable(e.ngDialogData.table),e.global.clickComplete=!0}e.selectFieldsDialog.close(),"batch"==t&&e.showSelectTablesDialog(e.ngDialogData.table)},e.onSelectAllChange=function(){for(var t=e.ngDialogData.table.origin_fields,a=0,r=t.length;r>a;a++)t[a].check=e.selectAll},e.onSelectChange=function(t){e.selectAll=t?o(e.fields):!1},t(["union.selectFields","join.worksheetname","nameInvalid","error.fieldRepeat"],e)}function a(e,t,a,r,i,o){function n(){var e=[];return angular.forEach(g,function(t){t.nick_name&&e.push(t.nick_name)}),e}function l(t,a){function r(o,n){angular.forEach(o,function(o){angular.forEach(o.tb_list,function(r){r.tb_id==t&&(r.selected_fields=a,r.folderName=o.name?o.name:e.tips["extract.folderRoot"],r.folderName=n?n+"/"+r.folderName:r.folderName,e.addTable(r,b),i=!0)}),!i&&o.sub_folders&&o.sub_folders.length>0&&r(o.sub_folders,o.name)})}var i=!1;r(e.batchTb.folderList,"")}function s(e){var t=[],a=[],r=[];return angular.forEach(m,function(){r.push(0)}),angular.forEach(e,function(e){var a=$.inArray(e.nick_name,m);a>-1&&(r[a]=1,t.push(e))}),angular.forEach(r,function(e,t){e||a.push(m[t])}),{selected:t,lack:a}}function d(t,a){var r=s(t.origin_fields),i=e.tips["union.missFieldsTips1"];i+=r.lack.slice(0,3).join(","),r.lack.length>3&&(i+=e.tips["union.missFieldsTips2"]+" "+r.lack.length+" "+e.tips["union.missFieldsTips3"]),e.batchTb.addList.push({tb_id:t.tb_id,name:t.title||t.name,folderName:a?a:e.tips["extract.folderRoot"],type:t.type,tb_type:t.tb_type,selected:r.selected,lack:r.lack,lackTip:i,emptyTip:e.tips["union.unMatchField"]}),f(t.tb_id,!0),c()}function c(){var t=e.batchTb.addList,a=0,r=0;angular.forEach(t,function(e){0==e.selected.length&&a++,e.lack.length>0&&e.selected.length>0&&r++}),e.batchTb.emptyNum=a,e.batchTb.lackNum=r}function u(t){for(var a=e.union_tables,r=e.batchTb.addList,i=0,o=a.length;o>i;i++)if(a[i].tb_id==t)return!0;if(0==r.length)return!1;for(var i=0,o=r.length;o>i;i++)if(r[i].tb_id==t)return!0;return!1}function f(t,a){function r(e){angular.forEach(e,function(e){e.sub_folders&&e.sub_folders.length>0&&r(e.sub_folders),e.tb_list.length>0&&i(e.tb_list)})}function i(e){angular.forEach(e,function(e){e.tb_id==t&&(e.choosed=a)})}e.batchTb.folderList,r(e.batchTb.folderList),r(e.original_folderList)}function p(e){return i.tb.getTbsField({dstb_ids:angular.toJson(e)})}e.batchTb.view="list";var g=e.ngDialogData.table.selected_fields,h=e.ngDialogData.table,b=e.ngDialogData.table.tb_id,_=e.ngDialogData.unionTable;e.batchTb.lackNum=0,e.batchTb.emptyNum=0,e.batchTb.folderList=angular.copy(e.original_folderList),e.batchTb.addList.push({tb_id:h.tb_id,name:h.title||h.name,folderName:h.folderName?h.folderName:e.tips["extract.folderRoot"],type:h.type,tb_type:h.tb_type,selected:h.selected_fields,lack:[],added:!0});var m=n();e.batchTb.addTb=function(a,i){if(!t.pageLoading){if(u(a.tb_id))return void r(e.tips["union.batchAdded"]);t.pageLoading=!0,a.origin_fields?(d(a,i),t.pageLoading=!1):e.getTableFields(a.tb_id).then(function(e){a.origin_fields=e,d(a,i),t.pageLoading=!1})}},e.batchTb.addAllTb=function(){function t(e,a){e.map(function(e){l=e.name,e.tb_list.map(function(e){u(e.tb_id)||(e.folderName=a?a+"/"+l:l,i.push(e),o.push(e.tb_id))}),e.sub_folders&&e.sub_folders.length>0&&t(e.sub_folders,l)})}function a(e){i.map(function(t){t.origin_fields=e[t.tb_id].columns,d(t,t.folderName)})}var i=[],o=[],n=null,l="";return t(e.batchTb.folderList,""),0==i.length?void r(e.tips["union.batchAdded"]):void(e.batchTb.loading||(e.batchTb.loading=!0,p(o).then(function(t){0==t.status&&(n=t.result,a(n)),e.batchTb.loading=!1})))},e.batchTb.delTb=function(t,a){e.batchTb.addList.splice(a,1),f(t.tb_id,!1),c()},e.batchTb.delAll=function(){for(var t=e.batchTb.addList,a=1,r=t.length;r>a;a++)f(t[a].tb_id,!1);t.length=1,c()},e.batchTb.resetTb=function(){var t=[];angular.forEach(_,function(e){t.push(e.tb_id)}),angular.forEach(e.batchTb.addList,function(e){t.indexOf(e.tb_id)<0&&f(e.tb_id,!1)})},e.batchTb.comfirm=function(){return e.batchTb.emptyNum>0?(r(e.tips["union.unMatchFieldTip"]),void(t.global.clickComplete=!0)):(angular.forEach(e.batchTb.addList,function(e,t){t>0&&l(e.tb_id,e.selected)}),void o.closeAll())},a(["error.fieldRepeat","union.batchAddLimit","union.batchAdded","union.unMatchField","extract.folderRoot","union.missFieldsTips1","union.missFieldsTips2","union.unMatchFieldTip","union.missFieldsTips3","sql.previewErrInfo1","sql.previewErrInfo2"],e)}angular.module("BC.controllers.dataSource").controller("UnionTableCtrl",e).controller("unionSelectFieldsCtrl",t).controller("unionSelectTableCtrl",a),e.$inject=["$scope","$rootScope","commonService","$location","ngDialog","errHint","unionService","commonHttp","$timeout","$stateParams","$jsTipTranslate","verifyTbName"],t.$inject=["$scope","$jsTipTranslate","ngDialog","errHint"],a.$inject=["$scope","$rootScope","$jsTipTranslate","errHint","commonService","ngDialog"]}(),!function(){function e(e,t){return{status:function(e){return t.get("/api/wb/status",{task_id:e}).then(function(e){return e})},valid:function(e,a){return t.get("/api/data_union/valid",{base_tb_id:e,union_tb_id:a}).then(function(e){return e})},preview:function(e){return t.post("/api/data_union/preview",{union_info:angular.toJson(e)}).then(function(e){return e})},union:function(e,a,r){return t.post("/api/data_union/union",{union_info:angular.toJson(e),table_name:a,folder_id:r}).then(function(e){return e})},modifyUnion:function(e,a,r){return t.post("/api/data_union/modify",{union_info:angular.toJson(e),table_name:a,tb_id:r}).then(function(e){return e})},modifyPreview:function(e,a,r,i){return t.post("/api/data_union/modify_preview",{info:angular.toJson(e),table_name:a,tb_id:r,folder_id:i}).then(function(e){return e})},tableUnionPreview:function(e,a,r,i,o){return t.post("/api/chart/table_union_preview",{info:angular.toJson(e),table_name:a,tb_id:r,folder_id:i,check_dimension:o}).then(function(e){return e})}}}angular.module("BC.controllers.dataSource").factory("unionService",e),e.$inject=["$http","commonHttp"]}(),angular.module("BC.controllers.dataSource").directive("unionFilter",["errHint","$jsTipTranslate","filterOperatorMapWithType","ngDialog","dateTimeByHalfHour",function(e,t,a,r,i){return{restrict:"A",scope:!0,templateUrl:"/static/partials/union_filter.html",replace:!0,link:function(o){function n(){return{tb:null,field:null,value:null,operator:null,startDate:null,endDate:null}}function l(e){return e.tb&&e.field&&void 0!=e.operator&&(8==e.operator||9==e.operator||10==e.operator||""!==e.value&&void 0!=e.value)&&(10!=e.operator||e.startDate||e.endDate)?!0:!1}function s(e){if("number"==e.field.data_type&&8!=e.operator&&9!=e.operator&&10!=e.operator){if(isNaN(Number(e.value)))return!1;if(""===e.value)return!1;e.value=Number(e.value)}return!0}function d(e){return Highcharts.dateFormat("%Y-%m-%d",e)}o.table=o.union_tables,o.filterData=o.union_filter,o.operatorMap=a,o.dateTimeByHalfHour=i,o.tableSelectChange=function(e){e.tb?(e.field=null,e.value=null,e.operator=null):e=n()},o.fieldSelectChange=function(e){"date"==e.field.data_type?(e.operator=10,e.value="",e.startDate=null,e.endDate=null):(e.operator=0,e.startDate=null,e.endDate=null,e.value=null)},o.operatorChange=function(e){(8==e.operator||9==e.operator||10==e.operator)&&(e.value=""),10!=e.operator&&(e.startDate=null,e.endDate=null)},o.selectWhere=function(t){l(t)?s(t)?o.filterData.where.unshift(n()):e(o.tips["error.filterValueError"]+"："+t.value):e(o.tips["join.optionsCanNotNull"]),o.currentItem=n()},o.delWhereFun=function(e){o.filterData.where.splice(e,1)},o.dateRangeShow=function(e){var t=[e.startDate,e.endDate];if(t[0]||t[1]||(t[0]=Highcharts.dateFormat("%Y-%m-%d",+new Date),t[1]=Highcharts.dateFormat("%Y-%m-%d",+new Date)),t.length>1){var a=t[0]?t[0].split(" ")[1]||"00:00:00":"00:00:00",i=t[1]?t[1].split(" ")[1]||"23:59:59":"23:59:59";t=t.concat([a,i])}else 0===t.length&&(t=[+new Date,+new Date,"00:00:00","23:59:59"]);r.open({template:"/static/partials/dialogTemplates/custom_date_modal.html",className:"ngdialog-theme-default date-picker-modal daterange-bdp-modal",data:{filterItem:e,range:t},scope:o})},o.saveDateRange=function(t){var a=t.sDate?d(new Date(t.sDate))+" "+t.sDateHour:null,i=t.eDate?d(new Date(t.eDate))+" "+t.eDateHour:null;if(!a&&!i)return e(o.tips["chart.dateRangeRequired"]),!1;if(a&&i){if(!t.sDateHour)return e(o.tips["filter.startDateErr2"]),!1;if(!t.eDateHour)return e(o.tips["filter.endDateErr2"]),!1;if(new Date(a)-new Date(i)>0)return e(o.tips["filter.dateRangeInvalid"]),!1}else{if(a&&!i&&!t.sDateHour)return e(o.tips["filter.startDateErr2"]),!1;if(!a&&i&&!t.eDateHour)return e(o.tips["filter.endDateErr2"]),!1}t.data.filterItem.startDate=a,t.data.filterItem.endDate=i,r.closeAll()},t(["join.optionsCanNotNull","error.filterValueError","chart.dateRangeRequired","filter.dateRangeInvalid","filter.startDateErr2","filter.endDateErr2"],o)}}}]),!function(){angular.module("BC.controllers.dataSource").controller("joinTableController",["$scope","$rootScope","$http","$location","$timeout","errHint","commonHttp","commonService","$stateParams","ngDialog","$jsTipTranslate","verifyTbName","$q","$translate",function(e,t,a,r,i,o,n,l,s,d,c,u,f,p){function g(){i(function(){e.goJsReady.join=!0,s.tbId&&(e.isCheck=!0,R(s.tbId))},0),window.GOJS="GOJS"}function h(){return l.ds.tbList().then(function(t){0==t.status&&(e.dsTBList=t.result,e.original_dbList=angular.copy(t.result))})}function b(t){function a(e){e.sub_folders&&e.sub_folders.length>0&&e.sub_folders.map(a),e.tb_list.map(function(e){t==e.tb_id&&(r=e.name)})}var r;return e.original_folderList.map(a),r}function _(){if(e.joinTable.where&&e.folderList){var t=e.joinTable.where;"sql"!=t.where_type&&t.condition.filters.map(function(e){e.tb_name=b(e.tb_id)})}}function m(e){var t=angular.fromJson(e),a=!0;if(t.info&&t.info.hasOwnProperty("where"))for(var r=0,i=t.info.where.length;i>r&&8!=t.info.where[r].operator&&(9!=t.info.where[r].operator||""!==t.info.where[r].value);r++)if(!t.info.where[r].value&&0!=t.info.where[r].value){a=!1;break}return a}function v(){for(var t=e.diagram.model.linkDataArray,a=0,r=t.length;r>a;a++)for(var i=t[a].join_fields,n=0,l=i.length;l>n;n++){var s=i[n].join_field;if(!s||!s[0]||!s[1])return o(e.tips["join.fieldCanNotNull"]),!1}return!0}function w(){var t=JSON.parse(e.diagram.model.toJson()).linkDataArray,a=!0,r=0;return angular.forEach(t,function(e){"full join"==e.join_type&&r++}),r>=2&&(a=!1,o(e.tips["join.fullJoinTip"])),a}function y(e){var t=angular.copy(e);return t=$.map(t,function(e){return D(e)&&T(e)?e:null})}function D(e){if("number"==e.data_type&&8!=e.operator&&9!=e.operator&&10!=e.operator){if(isNaN(Number(e.value)))return!1;if(""===e.value)return!1;e.value=Number(e.value)}return!0}function T(e){return e.fid&&void 0!=e.operator&&(8==e.operator||9==e.operator||10==e.operator||""!==e.value&&void 0!=e.value)&&(10!=e.operator||""!=e.start_date&&""!=e.end_date)?!0:!1}function F(e){var t=[],a={};return a={where_type:e.where_type,where_linker:e.where_linker},"sql"==e.where_type?(angular.forEach(e.sql,function(e,a){e&&t.push({tb_id:a,sql:e})}),a.sql=t):a.condition={filters:y(e.condition.filters)},a}function k(a){e.bottomLoading=!0;var r;r=a?{info:a}:{tb_id:e.workTbId},l.tb.getJoinErrorReport(r).then(function(a){e.bottomLoading=!1,0==Number(a.status)?e.preview.report=a.result:30003==Number(a.status)?o(a.errstr):40002==Number(a.status)?(a.errstr?(t.global.hint=!1,e.repeat_fields.repeatFieldTip=e.tips["error.fieldRepeat"]+":"+a.errstr,e.repeat_fields.showRepeatFieldTip=!0):o(Number(a.status)),t.pageLoading=!1):o(a.errstr)})}function L(t,a){function r(e,t,a){for(var r="from"==a?0:1,i=0,o=t.length;o>i;i++)if(t[i].join_field[r]==e)return!0;return!1}for(var i=e.diagram.model.linkDataArray,o=0,n=i.length;n>o;o++)if(i[o].from==t){if(r(a,i[o].join_fields,"from"))return!0}else if(i[o].to==t&&r(a,i[o].join_fields,"to"))return!0;return!1}function S(){e.repeat_fields.field_data_repeat_index=[];var t=e.preview.field;angular.forEach(t,function(a,r){a.is_repeat=!1;for(var i=0,o=t.length;o>i;i++)if(t[i].nick_name==a.nick_name&&r!=i){a.is_repeat=!0,e.repeat_fields.has_repeat_field=!0,e.repeat_fields.field_data_repeat_index.push(r);break}});var a=e.preview.tables;angular.forEach(a,function(e){e.has_repeat_field=!1,e.field_count=0;for(var t=0,a=e.fields.length;a>t;t++)e.fields[t].is_repeat&&(e.has_repeat_field=!0,e.field_count++)}),e.$$phase||e.$apply()}function x(t){var a=e.diagram.model.nodeDataArray;e.preview.field=[],e.preview.tables=[],angular.forEach(a,function(a){a.fields=[];var r={name:a.name,tb_id:a.tb_id,fields:[],field_count:e.fieldsList[a.tb_id].length};e.preview.tables.push(r),angular.forEach(e.fieldsList[a.tb_id],function(i){i.original_nick_name=i.original_nick_name||i.nick_name,i.linkField=L(a.tb_id,i.fid)&&i.original_nick_name!=i.nick_name,"preview"==t?a.fields.push(i):i.check&&a.fields.push(i),i.tb_name=a.name,e.preview.field.push(i),r.fields.push(i)})})}function E(t,a){var r=e.dragOption.parentNode.getBoundingClientRect();return{x:t-r.left,y:a-r.top}}function C(t,a){var r,i;return i=E(t,a),r=new go.Point(i.x,i.y),e.diagram.transformViewToDoc(r)}function N(){if(localStorage.getItem(B))return!1;for(var t=0,a=e.folderList.length;a>t;t++)for(var r=0,i=e.folderList[t].tb_list.length;i>r;r++){var o=e.folderList[t].tb_list[r];if("join"==o.type)return!1}return!0}function I(t){if(!t.length){if(1==e.diagram.model.nodeDataArray.length)return e.diagram.model.nodeDataArray[0].key;throw new Error("diagram model unnormal!! no links, nodes.length != 1")}var a={};t.forEach(function(e){a[e.from]=!1,0!=a[e.to]&&(a[e.to]=!0)});for(var r in a)if(1==a[r])return r}function j(t){var a=angular.copy(e.diagram.model.nodeDataArray);a.forEach(function(t,a,r){t.tb_id==e.target_id&&r.splice(a,1)});var r={fields:t.result.columns,key:t.result.tb_id,tb_id:t.result.tb_id,name:t.result.tb_name},i=null;i=s.tbId?e.getTbField(e.src_tb.tb_id,r,"modify"):e.getTbField(e.src_tb.tb_id,r),i&&i.then(function(){delete e.selectedTbs[e.target_id],a.push(r),e.dragOption.diagram_nodes=a;var i=angular.copy(e.diagram.model.linkDataArray);i.forEach(function(a){var r={},i={},o=0;if(a.from==e.target_id&&(a.from=t.result.tb_id,o=1),a.to==e.target_id&&(a.to=t.result.tb_id,o=1),1==o){var n=0;e.fieldsList[a.from].forEach(function(t){e.fieldsList[a.to].forEach(function(e){e.original_nick_name==t.original_nick_name&&0==n&&(r.id=t.fid,r.name=t.original_nick_name,i.id=e.fid,i.name=e.original_nick_name,n=1)})}),0==n&&(r.id=e.fieldsList[a.from][0].fid,r.name=e.fieldsList[a.from][0].original_nick_name,i.id=e.fieldsList[a.to][0].fid,i.name=e.fieldsList[a.to][0].original_nick_name),a.join_fields=[{join_field:[r.id,i.id],name:[r.name,i.name]}]}}),e.$broadcast("InitializeCurItem");var n=[];if(e.joinTable.where.condition.filters.forEach(function(t){t.tb_id!=e.target_id&&n.push(t)}),e.joinTable.where.condition.filters=n,e.diagram.model.nodeDataArray=angular.copy(a),e.diagram.model.linkDataArray=angular.copy(i),e.$broadcast("updateTbList"),e.createWorkTable("preview"),e.preview.tables){var l=[],d={};e.preview.tables.forEach(function(t){t.tb_id==e.src_tb.tb_id&&(t.checkAll=!0),t.fields.forEach(function(a){e.targetNodeInfo.fields.forEach(function(r){a.nick_name==r.original_nick_name&&t.tb_id==e.src_tb.tb_id&&(d[a.fid]=r.nick_name)}),t.tb_id==e.src_tb.tb_id&&(a.check=!0),l.push(a)})}),e.preview.tables.forEach(function(e){e.fields.forEach(function(e){d[e.fid]&&(e.original_nick_name=e.nick_name,e.nick_name=d[e.fid])})}),e.preview.field=l,s.tbId&&(e.original_tb_mapping[e.original_target_id]=e.src_tb.tb_id),o(e.tips["join.replaceSuccess"])}})}var P={funcQueue:[],loadLibInProgress:!1};e.goJsReady={join:!1},thirdPluginLoader({initFun:g,libSrc:"https://m1.bdp.cn/static/js/lib/go_latest_0d59d2c.js",libId:window.GOJS},P),t.view="table",t.show_bdp_header=!1,e.checkAll=!1,e.preview={},e.table_view="cat",e.nav=0,e.tab=1,e.page={nav:0,tab:1,delTable:0},e.dsTbList=[],e.dsTbListInfo=[],e.filter_check="",e.card_show={isShow:[]},e.diagram=window.diagram,e.joinTable={nodeDataArray:[],linkDataArray:[],where:{where_type:"condition",where_linker:"and",condition:{filters:[]},sql:{}}},e.selectedTbs={},e.selectedTbList=[],e.$watch("selectedTbs",function(){e.selectedTbList.length=0;var t=e.selectedTbs;for(var a in t)t.hasOwnProperty(a)&&e.selectedTbList.push(t[a]);e.selectedTbList.length&&!e.initSelectedTbList?(e.$broadcast("initTbList"),e.initSelectedTbList=!0):e.$broadcast("updateTbList")},!0),e.initSelectedTbList=!1,e.drop=!0,e.saveFolderList=null,e.tabView=!0,e.workdListView="folderList",e.viewTip="",e.repeat_fields={show_repeat_fields:!1,has_repeat_field:!1,field_data_repeat_index:[],repeatFieldTip:"",showRepeatFieldTip:!1},e.joinTableFt={open:!0},e.src_tb=null,e.requestDone=!0;var R=function(t){n.get("/api/tb/model_struct",{tb_id:t}).then(function(t){if(0==t.status){var a=t.result;e.originalNodeDataArray=t.result.info.nodeDataArray,e.tableInfo.table_name=a.table_name;var r=a.info;e.original_tb_mapping={},r.nodeDataArray.forEach(function(t){e.original_tb_mapping[t.tb_id]=t.tb_id}),e.fieldsList={},e.modifyInfo={fields:{},info:{nodeDataArray:r.nodeDataArray,linkDataArray:r.linkDataArray}};var o=r.nodeDataArray.map(function(t){return e.modifyInfo.fields[t.tb_id]=[],angular.forEach(t.fields,function(a){e.modifyInfo.fields[t.tb_id].push(a.fid)}),e.getTbField(t.tb_id,t,"modify")});f.all(o).then(function(){e.diagram.model=go.Model.fromJson(angular.toJson(e.modifyInfo.info));
var t=angular.copy(r.where);if("sql"==t.where_type){var a,o={};angular.forEach(r.where.sql,function(e,t){o[e.tb_id]=e.sql,0==t&&(a=e.tb_id)}),t.sql=o,t.condition={filters:[]},i(function(){e.$broadcast("initSql",a)},10)}else t.sql={};e.joinTable.where=t}),_()}})};e.filter_change=function(){e.filter_check=e.filter_check?void 0:{check:!0}},t.wsId||h(),e.toggleView=function(){e.query="","folderList"==e.workdListView?(e.workdListView="dsTbList",e.viewTip=e.tips["wb.databaseView"],e.dsTBList=angular.copy(e.original_dbList)):(e.workdListView="folderList",e.viewTip=e.tips["wb.worktableView"],e.folderList=angular.copy(e.original_folderList))};var M=function(){n.get("/api/folder/list").then(function(t){if(0==t.status){e.folderList=t.result;var a=s.tbId;angular.forEach(t.result,function(e){"folder_root"==e.folder_id&&(e.name="en"==$.cookie("locale")?"Root":"根目录"),a&&angular.forEach(e.tb_list,function(t,r){t.tb_id==a&&e.tb_list.splice(r,1)})}),e.saveFolderList=angular.copy(t.result);var r=bdp.bdpTables.getFolderByFolderId(e.saveFolderList,e.tableInfo.table_folder_id);e.tableInfo.table_folder_name=r?r.name:"",e.original_folderList=angular.copy(t.result),e.$broadcast("updatefolderList",e.original_folderList),N()&&e.showGuide(),_()}})};e.fieldsList={};var q=!1;e.getTbField=function(t,a,r){return n.post("/api/dstb/info",{dstb_id:t}).then(function(o){if(0==o.status){e.fieldsList[t]=[];var n=o.result,l=n.columns,s=angular.copy(l);angular.forEach(s,function(e){e.title=e.nick_name}),e.selectedTbs[t]={tb_id:n.tb_id,name:n.tb_name,fields:s,update_mode:n.update_mode};var d=null==n.partition?"":angular.fromJson(n.partition).base_field;if("modify"==r){var s=e.modifyInfo.fields;angular.forEach(l,function(r){var i=$.inArray(r.fid,s[t]),o={fid:r.fid,name:r.name,type:r.data_type,original_nick_name:r.nick_name||r.name,comment:"",forceCheck:1===n.update_mode&&r.fid==d};i>-1?(o.nick_name=a.fields[i].nick_name||r.name,o.check=!0):(o.nick_name=r.nick_name||r.name,o.check=!1),e.fieldsList[t].push(o)});var c=0;angular.forEach(e.modifyInfo.info.nodeDataArray,function(e){e.tb_id==t&&(c=e)}),0!=c?angular.forEach(c.fields,function(a){angular.forEach(e.fieldsList[t],function(e){a.fid==e.fid&&(angular.extend(a,e),a.gen_fid&&(e.gen_fid=a.gen_fid))})}):e.fieldsList[t].forEach(function(e){a.fields.forEach(function(t){""!=t.gen_fid&&t.fid==e.fid&&(e.gen_fid=t.gen_fid)})}),q||e.joinTable.where.sql[t]&&(q=!0,i(function(){e.$broadcast("initTbList",t)},10))}else angular.forEach(l,function(a){e.fieldsList[t].push({fid:a.fid,name:a.name,type:a.data_type,nick_name:a.nick_name||a.name,original_nick_name:a.nick_name||a.name,comment:"",check:!0,forceCheck:1===n.update_mode&&a.fid==d})})}return o})},e.setTbFiled=function(t){e.dsTbList.length<2||(t>0?(e.selectLindex=t-1,e.selectRindex=t,e.selectR=e.dsTbListInfo[e.selectLindex].data[0][0],e.selectL=e.dsTbListInfo[e.selectRindex].data[0][0],e.myLeft={left:100*t+170*t+50-176+"px"}):(e.selectLindex=0,e.selectRindex=1,e.selectR=e.dsTbListInfo[e.selectLindex].data[0][0],e.selectL=e.dsTbListInfo[e.selectRindex].data[0][0],e.myLeft={left:"144px"}))},M(),e.back=function(){function a(){r.path(t.wsId?"/data_source/"+t.wsId:"/data_source")}e.diagram.model.nodeDataArray.length?d.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngdialog-width-340",scope:e,data:{message:e.tips["join.confirmToBack"]}}).then(function(){a()}):a()},e.createTable=function(){e.table_view="add",e.tableInfo={},e.tableInfo.table_name="",e.tableInfo.table_folder_id=$.cookie("select_folder_id")?$.cookie("select_folder_id"):"folder_root",e.tableInfo.table_folder_name="",e.workTbInfo={},e.preview={field:[],data:[]},e.chooseShow=!1,e.dsTbList=[],e.dsTbListInfo=[],e.fieldsList={},e.diagram&&e.diagram.clear(),e.dragOption.diagram_nodes=[],e.currentLink=null},e.dragOption={diagram_nodes:[],dragTb:null,overlap_node:null,rect:null,canDrop:function(){return"add"===e.table_view}},e.dragTbFunc=function(t,a,r){e.src_tb=r,e.dragOption.dragTb={tb_id:r.tb_id,name:r.name},e.hideGuide()},e.goToRepeatFields=function(){3!=e.page.tab&&(e.table_ft_open=!0,e.createWorkTable("preview"),e.page.tab=3),e.showRepeatChange(!0),e.repeat_fields.showRepeatFieldTip=!1},e.showRepeatChange=function(t){e.repeat_fields.show_repeat_fields=t,e.repeat_fields.show_repeat_fields?S():(angular.forEach(e.preview.tables,function(e){e.field_count=e.fields.length}),e.repeat_fields.has_repeat_field=!1),e.check_field(),e.$$phase||e.$apply()},e.checkAllFields=function(t){e.repeat_fields.show_repeat_fields?angular.forEach(t.fields,function(e){e.is_repeat&&(e.check=t.checkAll||e.forceCheck&&e.check)}):angular.forEach(t.fields,function(e){e.check=t.checkAll||e.forceCheck&&e.check})},e.check_field=function(){if(e.repeat_fields.show_repeat_fields){var t=0,a=0;angular.forEach(e.preview.tables,function(e){t=0,a=0,e.has_repeat_field=!1,angular.forEach(e.fields,function(r){r.is_repeat&&(t++,e.has_repeat_field=!0,r.check&&a++)}),e.field_count=t,e.checkAll=t==a})}else angular.forEach(e.preview.tables,function(e){e.field_count=e.fields.length;for(var t=0,a=e.fields.length;a>t;t++)if(!e.fields[t].check)return void(e.checkAll=!1);e.checkAll=!0})},e.previewFun=function(t){if(m(t)){e.preview.data=[],e.preview.loading=!0;var a;a=t?{info:t}:{tb_id:e.workTbId},n.post("/api/wb/preview",a).then(function(t){e.preview.loading=!1,0==Number(t.status)?e.preview.data=t.result:30003==Number(t.status)&&o(t.errstr)})}};var A=function(){e.requestDone=!1,n.post("/api/wb/modify",{tb_id:s.tbId}).then(function(a){e.requestDone=!0,0==Number(a.status)?(t.pageLoading=!1,r.path(t.wsId?"/data_source/"+t.wsId:"/data_source")):30003==Number(a.status)?o(a.errstr):40002==Number(a.status)&&(a.errstr?(t.global.hint=!1,e.repeat_fields.repeatFieldTip=e.tips["error.fieldRepeat"]+":"+a.errstr,e.repeat_fields.showRepeatFieldTip=!0):o(Number(a.status)),t.pageLoading=!1)})},O=function(a){var i=s.tbId;e.requestDone=!1,n.post("/api/wb/modify_preview",{tb_id:i,info:angular.toJson(a.info),tb_name:a.table_name,folder_id:e.tableInfo.table_folder_id}).then(function(i){if(e.requestDone=!0,0==Number(i.status)){var n=i.result.can_del;if(1==n)A(a);else if(2==n)r.path(t.wsId?"/data_source/"+t.wsId:"/data_source");else{e.responseHint={dependency:i.result.dependency};var l="en"==$.cookie("locale")?"Untitled Chart":"未命名图表";angular.forEach(e.responseHint.dependency,function(e){angular.forEach(e.chart,function(e){e.ct_name||(e.ct_name=l)})}),d.open({template:"/static/partials/dialogTemplates/tableModifyHint.html",className:"ngdialog-theme-default",scope:e})}}else 30003==Number(i.status)?o(i.errstr):40002==Number(i.status)&&(i.errstr?(t.global.hint=!1,e.repeat_fields.repeatFieldTip=e.tips["error.fieldRepeat"]+":"+i.errstr,e.repeat_fields.showRepeatFieldTip=!0):o(Number(i.status)))})["finally"](function(){t.pageLoading=!1})};e.createWorkTable=function(a){if(!t.pageLoading&&e.requestDone&&w()){if(!a){var i=e.tableInfo.table_name;if(!i)return void o(e.tips["join.inputWorkSheetName"])}if(0==e.diagram.model.nodeDataArray.length)return a||o(e.tips["join.doNotSelectSheet"]),void(e.preview={});if(v()){var l=0;for(var s in e.fieldsList)if(e.fieldsList.hasOwnProperty(s))for(var d=0,c=e.fieldsList[s].length;c>d;d++)if(e.fieldsList[s][d].check&&(l++,!a&&!e.fieldsList[s][d].nick_name))return void o(e.tips["join.fieldAliasInvalid"]);if(0==l)return void o(e.tips["join.selectField"]);x(a),e.check_field();var u={table_name:e.tableInfo.table_name,info:JSON.parse(e.diagram.model.toJson())};if(u.info.where=F(e.joinTable.where),a)e.previewFun(angular.toJson(u));else if(e.isCheck)t.pageLoading=!0,O(u);else{t.pageLoading=!0;var f=e.tableInfo.table_folder_id;e.requestDone=!1,n.post("/api/wb/create",{info:angular.toJson(u),folder_id:f}).then(function(a){0==Number(a.status)?(a.result.tb_id,$.cookie("ds_tb_id",a.result.tb_id),r.path(t.wsId?"/data_source/"+t.wsId:"/data_source")):40002==Number(a.status)&&(a.errstr?(t.global.hint=!1,e.repeat_fields.repeatFieldTip=e.tips["error.fieldRepeat"]+":"+a.errstr,e.repeat_fields.showRepeatFieldTip=!0):o(Number(a.status)))})["finally"](function(){e.requestDone=!0,t.pageLoading=!1})}}}},e.changeField=function(){x("preview"),e.check_field()},e.getErrorReport=function(){if(0!=e.diagram.model.nodeDataArray.length&&v()){x("preview");var t={table_name:e.tableInfo.table_name,info:JSON.parse(e.diagram.model.toJson())};t.info.where=F(e.joinTable.where),e.preview.info=angular.toJson(t),k(angular.toJson(t))}},e.joinExportExcel=function(){0!=e.diagram.model.nodeDataArray.length&&(e.preview.export=!0,Highcharts.post("/api/wb/profile_export",{info:e.preview.info}),setTimeout(function(){e.preview.export=!1},50))},e.joinTableFt.switchFun=function(){e.joinTableFt.open=!e.joinTableFt.open,e.$broadcast("redraw")},e.joinTableFt.tabFun=function(t,a){e.page.tab=t,a.stopPropagation(),e.joinTableFt.open=!0,3==t?e.createWorkTable("preview"):4==t&&e.getErrorReport()},e.onDrag=function(t,a){if(0==e.dragOption.diagram_nodes.length)return!1;for(var r=C(a.offset.left,a.offset.top),i=e.dragOption.diagram_nodes.length,o=e.dragOption.overlap_node,n=a.helper.outerWidth(),l=a.helper.outerHeight();i--;){var s=e.dragOption.diagram_nodes[i],d=s.actualBounds;if(d.intersects(r.x,r.y,n,l))return s.background="#ff855a",o!=s&&(o&&(o.background="#44ccff"),e.dragOption.overlap_node=s),!0}e.dragOption.overlap_node&&(e.dragOption.overlap_node.background="#44ccff",e.dragOption.overlap_node=null)};var B="bdp_merge_table_guide";e.showGuide=function(){e.show_guide=!0},e.hideGuide=function(){e.show_guide=!1,localStorage.setItem(B,1)},$(window).on("beforeunload.tip",function(){return e.diagram.model.nodeDataArray.length&&!e.preview.export?e.tips["join.beforeunload"]:void 0}),e.$on("$destroy",function(){$(window).off("beforeunload.tip")}),e.createTable(),e.showSelectFolder=function(){d.open({templateUrl:"/static/js/worktable/tableDialog/choose_table_folder.html",scope:e,className:"ngdialog-theme-default choose-folder",data:{tbType:"join",optType:"baseChoose",folderList:e.saveFolderList||[],folderQueryList:[],targetFolderId:e.tableInfo.table_folder_id||"folder_root",targetFolderType:"",queryText:"",open:{},confirmSave:e.saveSelectFolder},controller:"chooseTbFolderCtrl"})},e.saveSelectFolder=function(t){e.tableInfo.table_folder_id=t.targetFolderId;var a=bdp.bdpTables.getFolderByFolderId(e.saveFolderList,e.tableInfo.table_folder_id);e.tableInfo.table_folder_name=a?a.name:"",d.closeAll()},e.openReplaceTableDialog=function(t){e.targetNodeInfo=t,e.target_id=e.targetNodeInfo.tb_id,e.src_tb=null,e.replaceList=angular.copy(e.original_folderList),e.currentFolderIndex=0,e.currentSubfolderIndex=void 0,e.$broadcast("updatefolderList",e.replaceList),d.open({templateUrl:"/static/js/worktable/tableDialog/select_join_replace_table.html",scope:e,className:"ngdialog-theme-default ngdialog-width-348 ngdialog-select-table"})},e.$on("recoverFolderList",function(t,a){e.replaceList=a}),e.checkWorktable=function(t){e.src_tb=t},e.showWarningDialog=function(e){return d.openConfirm({templateUrl:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngdialog-width-340",data:{message:e,hideCancel:!0}})},e.joinResultUpdateMode=function(){for(var t=e.diagram.model.linkDataArray,a=t.length;a--;)if("full join"==t[a].join_type)return 0;var r=I(t),i=e.selectedTbs[r];return 1==i.update_mode?1:0},e.checkOnTbWillin=function(t,a){function r(){for(var t=e.diagram.model.linkDataArray,a=t.length;a--;)if("full join"==t[a].join_type)return i}var i={then:function(e){e()}};if(t in e.selectedTbs)return o(e.tips["join.worktablePlaced"]),!1;if(e.src_tb&&t==e.src_tb.tb_id){if(2==e.src_tb.update_mode)return o(p.instant("join.updateMode2NotAllowed")),!1;e.diagram.model.nodeDataArray.length&&(1!=e.src_tb.update_mode||e.joinResultUpdateMode()||(!a||a&&a!=I(e.diagram.model.linkDataArray)&&!r())&&(i=e.showWarningDialog("wb.transform.combTbCantIncre")))}return i},e.sendReplaceWorktable=function(){if(!e.src_tb)return o(e.tips["wb.selectWorkSheet"]),!1;var t=e.src_tb.tb_id,a=e.checkOnTbWillin(t,e.target_id);a&&(e.checkTableResult="",d.closeAll(),a.then(function(){if(s.tbId){e.original_target_id="";for(var a in e.original_tb_mapping)e.original_tb_mapping.hasOwnProperty(a)&&e.original_tb_mapping[a]==e.target_id&&(e.original_target_id=a);if(""==e.original_target_id||e.original_target_id==t)return e.openReplaceConfirmDialog(),d.closeAll(),!1;var r={src_tb_id:t,target_tb_id:e.original_target_id,join_tb_id:s.tbId};l.tb.replaceCheck(r).then(function(t){if(0==t.status&&t.result.can_replace)e.checkTableResult=t.result,e.openReplaceConfirmDialog();else if(0==t.status&&!t.result.can_replace){e.missing_fields=t.result.missing_fields,e.conflict_fields=t.result.conflict_fields;var a;return e.missing_fields.length>0&&(a=1),e.conflict_fields.length>0&&(a=2),e.conflict_fields.length>0&&e.missing_fields.length>0&&(a=3),a>0&&d.open({templateUrl:"/static/partials/dialogTemplates/replace_fail_hint.html",className:"ngdialog-theme-default",scope:e,data:{conflict_type:a}}),!1}})}else e.openReplaceConfirmDialog()}))},e.openReplaceConfirmDialog=function(){d.openConfirm({templateUrl:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngdialog-width-340",data:{title:e.tips["join.replaceWorktable"],message:e.tips["join.replaceWorktableConfirmMessage"]}}).then(function(){e.checkTableResult?j({result:e.checkTableResult}):n.post("/api/dstb/info",{dstb_id:e.src_tb.tb_id}).then(function(e){0==e.status&&j(e)})})},c(["error.fieldRepeat","join.confirmToBack","join.saveSuccess","join.saveFailed","join.inputWorkSheetName","join.doNotSelectSheet","join.fieldAliasInvalid","join.selectField","wb.databaseView","wb.worktableView","nameInvalid","join.worksheetname","join.fieldCanNotNull","join.optionsCanNotNull","join.filterTypeAndValueError","join.beforeunload","join.fullJoinTip","sql.previewErrInfo1","sql.previewErrInfo2","join.replaceWorktable","join.replaceWorktableConfirmMessage","join.worktablePlaced","join.replaceSuccess","join.replaceFieldFailedMissing","join.replaceFieldFailedConflict","wb.selectWorkSheet"],e)}])}(),angular.module("BC.controllers.dataSource").directive("filterTable",function(){return{restrict:"A",scope:!0,templateUrl:"/static/partials/filter_table.html",replace:!0,controller:["$scope","errHint","$jsTipTranslate","filterOperatorMapWithType","ngDialog","dateTimeByHalfHour",function(e,t,a,r,i,o){function n(){return{tb:null,field:"",value:null,tb_name:"",operator:0,start_date:null,end_date:null}}function l(e){return Highcharts.dateFormat("%Y-%m-%d",e)}e.curItem=n(),e.fields={},e.filter={add:!0},e.operatorMap=r,e.dateTimeByHalfHour=o;var s=e.curItem;e.tableSelectChange=function(e){e.tb?(e.field=null,e.value=null,e.operator=null):e=n()},e.operatorChange=function(e){(8==e.operator||9==e.operator||10==e.operator)&&(e.value=""),10!=e.operator&&(e.start_date=null,e.end_date=null)},e.fieldSelectChange=function(e){"date"==e.field.type?(e.operator=10,e.value="",e.start_date=null,e.end_date=null):(e.operator=0,e.value="")},e.selectWhere=function(a){if(s=e.curItem,!e.curItem.tb||!e.curItem.field||void 0==e.curItem.operator||8!=e.curItem.operator&&9!=e.curItem.operator&&10!=e.curItem.operator&&(""===e.curItem.value||void 0==e.curItem.value)||10==e.curItem.operator&&!e.curItem.start_date&&!e.curItem.end_date)return void("click"==a&&t(e.tips["join.optionsCanNotNull"]));if("number"==s.field.type&&8!=e.curItem.operator&&9!=e.curItem.operator&&10!=e.curItem.operator){if(isNaN(Number(s.value)))return void t(e.tips["error.filterValueError"]+"："+s.value);if(""===s.value)return!1;s.value=Number(s.value)}e.joinTable.where.condition.filters.push({tb_id:s.tb.tb_id,field:s.field.name,fid:s.field.fid,data_type:s.field.type,value:s.value,operator:s.operator,tb_name:s.tb.name,name:s.field.nick_name,start_date:s.start_date,end_date:s.end_date}),e.curItem=n()},e.$on("InitializeCurItem",function(){e.curItem=n()}),e.$on("save",function(){e.selectWhere()}),e.delWhereFun=function(t){e.joinTable.where.condition.filters.splice(t,1)},e.dateRangeShow=function(t){var a=[t.start_date,t.end_date];if(a[0]||a[1]||(a[0]=Highcharts.dateFormat("%Y-%m-%d",+new Date),a[1]=Highcharts.dateFormat("%Y-%m-%d",+new Date)),a.length>1){var r=a[0]?a[0].split(" ")[1]||"00:00:00":"00:00:00",o=a[1]?a[1].split(" ")[1]||"23:59:59":"23:59:59";a=a.concat([r,o])}else 0===a.length&&(a=[+new Date,+new Date,"00:00:00","23:59:59"]);i.open({template:"/static/partials/dialogTemplates/custom_date_modal.html",className:"ngdialog-theme-default date-picker-modal daterange-bdp-modal",data:{filterItem:t,range:a},scope:e})},e.saveDateRange=function(a){var r=a.sDate?l(new Date(a.sDate))+" "+a.sDateHour:null,o=a.eDate?l(new Date(a.eDate))+" "+a.eDateHour:null;if(!r&&!o)return t(e.tips["chart.dateRangeRequired"]),!1;if(r&&o){if(!a.sDateHour)return t(e.tips["filter.startDateErr2"]),!1;if(!a.eDateHour)return t(e.tips["filter.endDateErr2"]),!1;if(new Date(r)-new Date(o)>0)return t(e.tips["filter.dateRangeInvalid"]),!1}else{if(r&&!o&&!a.sDateHour)return t(e.tips["filter.startDateErr2"]),!1;if(!r&&o&&!a.eDateHour)return t(e.tips["filter.endDateErr2"]),!1}a.data.filterItem.start_date=r,a.data.filterItem.end_date=o,i.closeAll()},a(["join.optionsCanNotNull","error.filterValueError","chart.dateRangeRequired","filter.dateRangeInvalid","filter.startDateErr2","filter.endDateErr2"],e)}]}}),angular.module("BC.controllers.dataSource").directive("showRelationProduce",["$rootScope","commonService","$timeout","$jsTipTranslate","errHint",function(e,t,a,r){return{restrict:"A",link:function(t,i){function o(){t.relationColors={bgLinkPanel:1==e.usedThemeId||1==$.cookie("theme_id")?"#24273E":"#fff",fontTextBlock:1==e.usedThemeId||1==$.cookie("theme_id")?"#9D9EA8":"#11121B"}}function n(){g=go.GraphObject.make,h=g(go.Diagram,"show_relation_produce",{contentAlignment:new go.Spot(.02,0,0,0),allowMove:!1,allowZoom:!1,layout:g(go.TreeLayout,{angle:180,layerSpacing:150}),AnimationFinished:function(){t.showRelationProduceLoading=!1,t.$$phase||t.$digest()}}),b=g(go.TreeModel)}function l(e){var t=angular.element(".relation-produce").scrollTop();if(angular.element("#show_relation_produce").children("div:eq(0)").scrollLeft(),"hide"==e)i.parent().parent().parent().parent().find(".relation-node-message").css({display:"none"});else{var a=h.transformDocToView(new go.Point(e.x,e.y)),r=0;r=parseInt(i.parent().width())<a.x+350?-320:90,i.parent().parent().parent().parent().find(".relation-node-message.rela-table").css({left:a.x+r,top:a.y+116-t,display:"block"})}}function s(a){var r="";switch(a.update_status){case 1:r="zh"==e.language?"更新成功":"Success";break;case 0:case 3:case 6:r="zh"==e.language?"更新中":"Updating";break;case 2:r="zh"==e.language?"更新失败":"Failed"}var i="tbType."+bdp.bdpTables.getTableTypeForShow(a);t.relationNodeData={tb_id:a.tb_id,tb_name:a.tb_name,tb_type:t.tips[i],schema_total:a.schema_total,update_status:a.update_status,update_status_str:r,update_time:a.update_time},t.$$phase||t.$digest()}function d(e){var t="#40A276";switch(e){case 1:t="#40A276";break;case 3:t="#FFC063";break;case 2:t="#EE4B4B"}return t}function c(){h.nodeTemplate=g(go.Node,"Horizontal",{selectionAdorned:!1},g(go.Panel,"Auto",{cursor:"pointer"},g(go.Shape,"File",{stroke:null},new go.Binding("figure","figure"),new go.Binding("fill","update_status",d)),g(go.TextBlock,"Default Text",{margin:new go.Margin(2,0,8,0),stroke:"white",font:"12px sans-serif bold",overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(100,0/0),minSize:new go.Size(100,0/0),textAlign:"center"},new go.Binding("text","tb_name"))),{click:function(t,a){"1"!=a.data.key&&(e.$broadcast("skipTargetTable",a.data.tb_id),i.parent().parent().parent().parent().find(".relation-node-message").css({display:"none"}))},mouseEnter:function(e,a){t.showRelationProduceLoading||(s(a.data),l(a.position))},mouseLeave:function(){l("hide")}})}function u(t){var a="";switch(t){case 0:a="zh"==e.language?"多表关联":"Join";break;case 1:a="zh"==e.language?"数据聚合":"Aggr";break;case 2:a="zh"==e.language?"追加合并":"Union";break;case 3:a="zh"==e.language?"SQL提取":"Sql";break;default:a=""}return a}function f(){h.linkTemplate=g(go.Link,{routing:go.Link.Orthogonal,corner:0},g(go.Shape,{strokeWidth:2,stroke:"#5182E4",isPanelMain:!0}),g(go.Panel,"Auto",{segmentIndex:0,segmentOffset:new go.Point(40,12),segmentOrientation:go.Link.OrientUpright},g(go.Shape,"Rectangle",{fill:t.relationColors.bgLinkPanel,stroke:null,strokeWidth:1,width:60,height:20}),g(go.TextBlock,"join",{margin:0,stroke:t.relationColors.fontTextBlock,font:"10px sans-serif bold"},new go.Binding("text","produce_type",u))))}function p(){"path"==t.relationView.view&&(o(),a(function(){c(),f(),i.parent().parent().parent().parent().find(".relation-node-message").css({display:"none"}),t.$$phase||t.$digest(),h.model=b},10))}t.relationNodeData={tb_id:"",tb_name:"",tb_type:"",schema_total:"",update_status:"",update_status_str:"",update_time:""},t.$on("showRelationMapData",function(e,a){a&&a.length>0&&(t.exportTableName=a[0]&&a[0].tb_name||"过程视图",i.parent().parent().parent().parent().find(".relation-node-message").css({display:"none"}),o(),c(),f(),b.nodeDataArray=a,h.model=b,t.showRelationProduceLoading=!1)}),o();var g,h,b;n(),angular.element(".relation-produce").scroll(function(){i.parent().parent().parent().parent().find(".relation-node-message").css({display:"none"})}),c(),f(),t.$on("refresh-relation-path",function(){p()}),e.$on("$translateChangeSuccess",function(){p()}),t.exportProcedureJpg=function(){var e,a,r=$("#show_relation_produce");e=r.find("canvas").next("div").children("div").width(),e=1>=e?r.find("canvas").width():e,a=r.find("canvas").next("div").next("div").children("div").height(),a=1>=a?r.find("canvas").height():a;var i=h.makeImage({scale:1,type:"image/png",background:t.relationColors.bgLinkPanel,maxSize:new go.Size(e+100,a+100)}),o="<img src='"+i.src+"' style='margin:10px'>";Highcharts.post("/api/chart/export_png",{filename:t.exportTableName,type:"image/png",background:t.relationColors.bgLinkPanel,width:e+20,height:a+20,svg:o})},r(["wb.joinTable","wb.polymerTable","wb.unionTable","wb.scriptTable","tbType.excel","tbType.share","tbType.allot","tbType.public","tbType.join","tbType.union","tbType.aggr","tbType.sql","tbType.extract","tbType.db","tbType.opends"],t)}}}]).directive("showCurrentRelation",["$rootScope","$timeout","$jsTipTranslate","errHint",function(e,t,a){return{restrict:"A",link:function(r,i){function o(){r.relationColors={bgLinkPanel:1==e.usedThemeId||1==$.cookie("theme_id")?"#24273E":"#fff",fontTextBlock:1==e.usedThemeId||1==$.cookie("theme_id")?"#9D9EA8":"#11121B"}}function n(){v=go.GraphObject.make,w=v(go.Diagram,"show_current_relation",{contentAlignment:new go.Spot(.02,0,0,0),allowMove:!1,allowZoom:!1,layout:v(go.TreeLayout,{angle:0,layerSpacing:150}),AnimationFinished:function(){r.showCurrentRelationLoading=!1,r.$$phase||r.$digest()}}),y=v(go.TreeModel)}function l(e,t){var a=angular.element("#show_current_relation").children("div:eq(0)").scrollLeft();if(a=0,"hide"==e)i.parent().parent().parent().parent().find(".relation-node-message").css({display:"none"});else{i.parent().parent().parent().parent().find(".relation-node-message").css({display:"none"});var o=w.transformDocToView(new go.Point(e.x,e.y)),n=0;"table"==t||"chart"==t?n=parseInt(i.parent().width())<o.x+parseInt(angular.element(".relation-node-message").width())+10?-320:90:"user"==t?n=parseInt(i.parent().width())<o.x+parseInt(angular.element(".relation-node-message.rela-user").width())+50?-parseInt(angular.element(".relation-node-message.rela-user").width())+10:90:"group"==t&&(n=parseInt(i.parent().width())<o.x+parseInt(angular.element(".relation-node-message.rela-group").width())+60?-parseInt(angular.element(".relation-node-message.rela-group").width())+10:90);var l=0,s=parseInt(angular.element("#show_relation_produce").height());l=r.hasRelationMap?s+56>200?s:140:-25,"table"==t&&i.parent().parent().parent().parent().find(".relation-node-message.rela-table").css({left:o.x+n-a,top:o.y+l-0,display:"block"}),"chart"==t&&i.parent().parent().parent().parent().find(".relation-node-message.rela-chart").css({left:o.x+n-a,top:o.y+l+100,display:"block"}),"user"==t&&i.parent().parent().parent().parent().find(".relation-node-message.rela-user").css({left:o.x+n-a,top:o.y+l+160,display:"block"}),"group"==t&&i.parent().parent().parent().parent().find(".relation-node-message.rela-group").css({left:o.x+n-a,top:o.y+l+160,display:"block"})}}function s(t){if("table"==t.node_type){var a="";switch(t.update_status){case 1:a="zh"==e.language?"更新成功":"Success";break;case 0:case 3:case 6:a="zh"==e.language?"更新中":"Updating";break;case 2:a="zh"==e.language?"更新失败":"Failed"}var i="tbType."+bdp.bdpTables.getTableTypeForShow(t);r.relationNodeData={tb_id:t.tb_id,tb_name:t.name,tb_type:r.tips[i],schema_total:t.schema_total,update_status:t.update_status,update_status_str:a,update_time:t.update_time}}"chart"==t.node_type&&(r.relationNodeData={ct_name:t.name,dsh_name:t.dsh_name,proj_name:t.proj_name}),("user"==t.node_type||"group"==t.node_type)&&(r.relationNodeData={name:t.name}),r.$$phase||r.$digest()}function d(e){var t="File";switch(e){case"classify":t="Rectangle";break;default:t="File"}return t}function c(e){var t="#5182E4";switch(e){case"classify":t=null;break;default:t="#5182E4"}return t}function u(e){var t=null;switch(e){case"classify":t="#5182E4";break;default:t=null}return t}function f(e){var t="#fff";switch(e){case"classify":t=r.relationColors.fontTextBlock;break;default:t="#fff"}return t}function p(e){var t=new go.Margin(2,0,8,0);switch(e){case"classify":t=new go.Margin(8,0,8,0);break;default:t=new go.Margin(2,0,8,0)}return t}function g(e){var t="pointer";switch(e){case"classify":t="default";break;case"user":t="default";break;case"group":t="default";break;default:t="pointer"}return t}function h(){w.nodeTemplate=v(go.Node,"Horizontal",{selectionAdorned:!1},v(go.Panel,"Auto",new go.Binding("cursor","node_type",g),v(go.Shape,"File",new go.Binding("figure","node_type",d),new go.Binding("fill","node_type",c),new go.Binding("stroke","node_type",u)),v(go.TextBlock,"Default Text",{margin:new go.Margin(2,0,8,0),font:"12px sans-serif bold",overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(100,0/0),minSize:new go.Size(100,0/0),textAlign:"center"},new go.Binding("text","name"),new go.Binding("stroke","node_type",f),new go.Binding("margin","node_type",p))),{click:function(t,a){"table"==a.data.node_type&&"1"!=a.data.key&&(e.$broadcast("skipTargetTable",a.data.tb_id),i.parent().parent().parent().parent().find(".relation-node-message").css({display:"none"})),"chart"==a.data.node_type&&(r.$emit("jumpToDashChart",a.data),i.parent().parent().parent().parent().find(".relation-node-message").css({display:"none"}))},mouseEnter:function(e,t){r.showCurrentRelationLoading||"classify"!=t.data.node_type&&(s(t.data),l(t.position,t.data.node_type))},mouseLeave:function(e,t){"classify"!=t.data.node_type&&l("hide",t.data.node_type)}})}function b(t){var a="";switch(t){case 0:a="zh"==e.language?"多表关联":"Join";break;case 1:a="zh"==e.language?"数据聚合":"Aggr";break;case 2:a="zh"==e.language?"追加合并":"Union";break;case 3:a="zh"==e.language?"SQL提取":"Sql";break;default:a=""}return a}function _(){w.linkTemplate=v(go.Link,{routing:go.Link.Orthogonal,corner:0},v(go.Shape,{strokeWidth:2,stroke:"#5182E4",isPanelMain:!0}),v(go.Panel,"Auto",{segmentIndex:-1,segmentOffset:new go.Point(-40,-12)},v(go.Shape,"Rectangle",{fill:r.relationColors.bgLinkPanel,stroke:null,strokeWidth:1,width:60,height:20}),v(go.TextBlock,"join",{margin:0,stroke:r.relationColors.fontTextBlock,font:"10px sans-serif bold"},new go.Binding("text","produce_type",b))))}function m(){"path"==r.relationView.view&&(o(),t(function(){h(),_(),i.parent().parent().parent().parent().find(".relation-node-message").css({display:"none"}),r.showCurrentRelationLoading=!0,r.$$phase||r.$digest(),w.model=y},10))}r.relationNodeData={tb_id:"",tb_name:"",tb_type:"",schema_total:"",update_status:"",update_status_str:"",update_time:""},r.$on("showCurrentRelationData",function(e,t){t.length>0&&(o(),h(),_(),y.nodeDataArray=t,w.model=y,r.showCurrentRelationLoading=!1)}),o();var v,w,y;n(),angular.element(".current-relation").scroll(function(){i.parent().parent().parent().parent().find(".relation-node-message").css({display:"none"})}),h(),_(),r.$on("refresh-relation-path",function(){m()}),e.$on("$translateChangeSuccess",function(){angular.forEach(y.nodeDataArray,function(t){switch(t.key){case"2":t.name="zh"==e.language?"工作表":"table",t.produce_type="zh"==e.language?"工作表":"table";break;case"3":t.name="zh"==e.language?"图表":"Chart",t.produce_type="zh"==e.language?"图表":"Chart";break;case"4":t.name="zh"==e.language?"用户":"User",t.produce_type="zh"==e.language?"用户":"User";break;case"5":t.name="zh"==e.language?"组":"Group",t.produce_type="zh"==e.language?"组":"Group"}}),m()}),a(["wb.joinTable","wb.polymerTable","wb.unionTable","wb.scriptTable","tbType.excel","tbType.share","tbType.allot","tbType.public","tbType.join","tbType.union","tbType.aggr","tbType.sql","tbType.extract","tbType.db","tbType.opends"],r)}}}]),angular.module("BC.controllers.dataSource").config(["$compileProvider",function(e){e.aHrefSanitizationWhitelist(/\s*/)}]).constant("goColors",{bg:"#5182E4",highlightBg:"#ff8555a",font:"#fff",highlightFont:"#fff"}).directive("goLinkEdit",[function(){return{link:function(){}}}]).directive("goDiagram",["goColors","$rootScope","$timeout","$document","$jsTipTranslate","errHint",function(e,t,a,r,i,o){return angular.map=function(e,t){for(var a=[],r=0,i=e.length;i>r;r++)a.push(t(e[r],r,e));return a},{link:function(n,l){function s(){function a(){go.ForceDirectedLayout.call(this)}go.Diagram.inherit(a,go.ForceDirectedLayout),a.prototype.makeNetwork=function(e){var t=go.ForceDirectedLayout.prototype.makeNetwork.call(this,e);return t.vertexes.each(function(e){var t=e.node;null!==t&&(e.isFixed=t.isSelected||!("number"==typeof t.location.x&&isNaN(t.location.x)))}),t};var r=go.GraphObject.make,i={makeButton:function(e,t,a){return void 0===a&&(a=function(){return!0}),r("ContextMenuButton",r(go.Shape,"Rectangle",{stroke:null,fill:"#fff",width:80,height:28,cursor:"pointer"}),r(go.TextBlock,{stroke:"#666",margin:new go.Margin(5,10,0,10)},e),{click:t},new go.Binding("visible","",a).ofObject())},textLabel:function(t,a){return r(go.TextBlock,angular.extend({font:"10px",wrap:go.TextBlock.WrapDesiredSize,margin:0,textAlign:"center",stroke:e.font,alignments:go.Spot.Bottom}),new go.Binding("text",a||"text").makeTwoWay())},tbNode:function(a,i,o){return r(go.Node,"Spot",new go.Binding("location","loc",go.Point.parse).makeTwoWay(go.Point.stringify),{locationSpot:go.Spot.Center,locationObjectName:"SHAPE",selectionAdorned:!1},r(go.Panel,"Auto",r(go.Shape,"File",{fill:e.bg,stroke:null},new go.Binding("figure","figure")),r(go.Panel,"Horizontal",r(go.TextBlock,{stroke:e.highlightFont,margin:new go.Margin(2,4,2,10),maxSize:new go.Size(160,0/0),overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.WrapFit,height:20},new go.Binding("text",a||"text").makeTwoWay()),r(go.Picture,{width:16,height:16,maxSize:new go.Size(16,16),margin:new go.Margin(-2,8,0,0),source:"/static/images/join_triangle_down_white.png"}))),{cursor:o?"pointer":"default",click:function(e,a){o&&(console.log("canSkip tb_id",a.data.tb_id),t.$broadcast("skipTargetTable",a.data.tb_id))}})},joinLink:function(){return r(go.Link,{toShortLength:4,layerName:"Background"},r(go.Shape,{isPanelMain:!0,stroke:"rgba(81, 130, 228, .6)",strokeWidth:2}),r(go.Shape,{toArrow:"standard",stroke:null,fill:"rgba(81, 130, 228, .6)"}),r(go.Panel,"Auto",r(go.Shape,"RoundedRectangle",{fill:"#fff",stroke:"#A3ABB0",strokeWidth:1,width:58,height:20}),r(go.TextBlock,"join",{margin:5,stroke:"#333"},new go.Binding("text","join_type"))))}};return{AppLayout:a,goWidget:i}}function d(){m.nodeTemplate=b.tbNode("name",!0,!1),m.linkTemplate=b.joinLink()}function c(){function e(){for(var e=m.model.nodeDataArray,t=m.model.linkDataArray,a=!1,r=e.length;r;r--){for(var i=e[r-1].key,o=!0,n=0,l=t.length;l>n;n++)if(i==t[n].from||i==t[n].to){o=!1;
break}o&&(a=!0,e.length>1&&e.splice(r-1,1))}if(a){var s=m.model.toJson();m.clear(),$scope.redrawDiagram(s,"del")}else 3==$scope.page.tab&&$scope.createWorkTable("preview");$scope.collect_node(),$scope.$apply(function(){var e=[];angular.forEach(m.model.nodeDataArray,function(t){e.push(t.key)}),e=e.join("$$$$");for(var t in $scope.fieldsList)$scope.fieldsList.hasOwnProperty(t)&&e.indexOf(t)<0&&delete $scope.fieldsList[t];for(var t in $scope.selectedTbs)$scope.selectedTbs.hasOwnProperty(t)&&e.indexOf(t)<0&&delete $scope.selectedTbs[t]})}m.addDiagramListener("LinkDrawn",function(){console.log("add_a_link")}),m.addDiagramListener("AnimationFinished",function(){$scope.collect_node()}),m.addDiagramListener("ExternalObjectsDropped",function(){console.log(arguments)}),m.addDiagramListener("ObjectSingleClicked",function(e){var t=e.subject.part;$scope.showLinkEdit&&$scope.showContextMenu||($scope=$scope.$parent),t instanceof go.Link&&$scope.showLinkEdit(t.fromNode.data,t.toNode.data,t.data,t.actualBounds),t instanceof go.Node&&$scope.showContextMenu(t.actualBounds,t)}),m.addDiagramListener("LayoutCompleted",function(){if($scope.folderList)$scope.updateWorktableListStyle();else var e=$scope.$watch("folderList",function(t){t&&t.length>0&&($scope.updateWorktableListStyle("initial"),e())})}),m.addDiagramListener("SelectionDeleting",function(){console.log($scope.tips["join.deleteNode"],arguments)}),m.addDiagramListener("SelectionDeleted",function(){if(e(),"add"===$scope.table_view){$scope.page.delTable+=1;var t=$scope.joinTable.where.condition.filters,a=$scope.diagram.model.nodeDataArray;if(0==a.length)t.length=0;else for(var r=t.length;r--;)t[r].tb_id in $scope.selectedTbs||t.splice(r,1);$scope.$broadcast("InitializeCurItem"),$scope.$$phase||$scope.$apply(),$scope.createWorkTable("preview")}})}function u(e,t){for(var a=$scope.fieldsList[e]||[],r=$scope.fieldsList[t]||[],i=0,o=a.length;o>i;i++)for(var n=a[i],l=0,s=r.length;s>l;l++){var d=r[l];if(n.nick_name==d.nick_name)return{from:n,to:d}}return{from:a[0],to:r[0]}}function f(){$scope.collect_node(),3==$scope.page.tab&&$scope.createWorkTable("preview")}function p(){for(var e=$scope.currentLink.join_fields,t=0,a=e.length;a>t;t++){var r=e[t].join_field;if(!r||!r[0]||!r[1])return o($scope.tips["join.fieldCanNotNull"]),!1}return!0}function g(e,t){var a=JSON.parse($scope.diagram.model.toJson()).linkDataArray,r=!0,i=0,n=[];return angular.forEach(a,function(e,t){"full join"==e.join_type&&(i++,n.push(t))}),-1==$.inArray(t,n)&&i++,i>=2&&(r=!1,o($scope.tips["join.fullJoinTip"])),r}$scope=n.$parent.$parent;var h=s(),b=h.goWidget,_=go.GraphObject.make,m=_(go.Diagram,l[0],{initialContentAlignment:go.Spot.Center,layout:_(go.LayeredDigraphLayout)});$scope.dragOption.parentNode=l[0];var v=m.layout;v.direction=180,v.layerSpacing=160,v.columnSpacing=30,window.diagram=$scope.diagram=m,$scope.$on("redraw",function(){a(function(){m.requestUpdate(),m.model=go.Model.fromJson(m.model.toJson())},10)}),$scope.dragStart=function(){},$scope.updateWorktableListStyle=function(e){m.model.nodeDataArray.length>0?m.model.nodeDataArray.forEach(function(e){var t=[];m.model.nodeDataArray.forEach(function(a){a.tb_id!=e.tb_id&&t.push(a.tb_id)}),$scope.folderList.forEach(function(a){"folder_root"!=a.folder_id&&(a.sub_folders.forEach(function(a){a.tb_list.forEach(function(a){a.tb_id==e.tb_id?a.in_chart=!0:t.indexOf(a.tb_id)<=-1&&(a.in_chart=!1)})}),a.tb_list.forEach(function(a){a.tb_id==e.tb_id?a.in_chart=!0:t.indexOf(a.tb_id)<=-1&&(a.in_chart=!1)})),a.tb_list.forEach(function(a){a.tb_id==e.tb_id?a.in_chart=!0:t.indexOf(a.tb_id)<=-1&&(a.in_chart=!1)})})}):$scope.folderList.forEach(function(e){"folder_root"!=e.folder_id&&(e.sub_folders.forEach(function(e){e.tb_list.forEach(function(e){e.in_chart=!1})}),e.tb_list.forEach(function(e){e.in_chart=!1})),e.tb_list.forEach(function(e){e.in_chart=!1})}),e||$scope.$digest()},$scope.onDrop=function(){var e=$scope.dragOption.overlap_node;if(!$scope.dragOption.canDrop())return o($scope.tips["join.canNotEditChart"]),!1;if($scope.dragOption.diagram_nodes.length>0&&!e)return o($scope.tips["join.mustDropOnNodes"]),!1;if(!$scope.checkOnTbWillin($scope.dragOption.dragTb.tb_id))return!1;var t,a=$scope.dragOption.dragTb,r=angular.extend({},{key:a.tb_id,tb_id:a.tb_id,name:a.name});$scope.dragOption.diagram_nodes.length?(t=m.model,t.nodeDataArray.push(r),$scope.getTbField(a.tb_id).then(function(){var i=u(a.tb_id,e.data.key),o=i.from?i.from.fid:"",n=i.to?i.to.fid:"";i.from?i.from.name:"",i.to?i.to.name:"",t.linkDataArray.push({from:a.tb_id,to:e.data.key,join_type:"left join",join_fields:[{join_field:[o,n]}]}),r.fields=[].concat($scope.fieldsList[a.tb_id]),m.model=go.Model.fromJson(m.model.toJson()),f()})):(t=go.GraphObject.make(go.GraphLinksModel),t.nodeDataArray=[r],m.model=t,$scope.getTbField(a.tb_id).then(function(){r.fields=[].concat($scope.fieldsList[a.tb_id]),f()}))},$scope.collect_node=function(){$scope.dragOption.diagram_nodes=angular.map(m.model.nodeDataArray,function(e){return m.findNodeForKey(e.tb_id)})},$scope.currentLink=null,$scope.to_tb_fields=[],$scope.from_tb_fields=[],$scope.showLinkEdit=function(e,t,a,r){$scope.$apply(function(){$scope.currentLink=angular.copy(a),$scope.from_tb=e,$scope.to_tb=t,$scope.from_tb_fields=$scope.fieldsList[a.from],$scope.to_tb_fields=$scope.fieldsList[a.to],setTimeout(function(){var e=r.x+r.width/2+25,t=r.y+r.height/2+15,a=m.transformDocToView(new go.Point(e,t)),i=l.parent().width(),o=l.parent().height(),n=Math.min(a.x,i-445),s=Math.min(a.y,o-150);l.parent().parent().find(".merge-field-select").css({left:n-55,top:s+55,opacity:1})},0)})},$scope.showContextMenu=function(e,t){$scope.clickingNode=!0,$scope.currentPartInfo=t;var a=e.x+e.width/2,r=e.y+e.height/2,i=m.transformDocToView(new go.Point(a,r)),o=e.width;$(".merge-table-context-menu").toggle().css({left:i.x+o/2-80,top:i.y+68,width:80}),$scope.replaceTableInChart=function(){$scope.openReplaceTableDialog(t.data)},$scope.deleteTableInChart=function(){setTimeout(function(){t.diagram.commandHandler.canDeleteSelection()&&t.diagram.commandHandler.deleteSelection()},0)}};var w=function(){$scope.clickingNode||$(".merge-table-context-menu").hide(),$scope.clickingNode=!1};r.bind("click",w),$scope.$on("$destroy",function(){r.unbind("click",w)}),$scope.changeJoinType=function(e){$scope.currentLink.join_type=e,"full join"==e&&$scope.joinResultUpdateMode()&&$scope.showWarningDialog("join.fullJoinCantUpdateIncre")},$scope.save_field=function(){if(p()){for(var e,t=m.model.linkDataArray,a=0,r=0,i=t.length;i>r;r++)t[r].from==$scope.currentLink.from&&t[r].to==$scope.currentLink.to&&(e=t[r],a=r);if(e){var o=$scope.currentLink.join_type;("full join"!=o||g(o,a))&&(e.join_type=$scope.currentLink.join_type,e.join_fields=$scope.currentLink.join_fields,$scope.redrawDiagram(),$scope.currentLink=null)}}},$scope.addField=function(){p()&&$scope.currentLink.join_fields.push({join_field:[]})},$scope.removeField=function(e){e>0?$scope.currentLink.join_fields.splice(e,1):$scope.currentLink.join_fields.length>1?$scope.currentLink.join_fields.splice(e,1):$scope.currentLink.join_fields[0].join_field=[]},$scope.hideLinkEdit=function(){$scope.currentLink||($scope=$scope.$parent);for(var e=$scope.currentLink.join_fields,t=e.length-1;t>=0;){var a=e[t].join_field;a&&a[0]&&a[1]||e.splice(t,1),t--}$scope.currentLink=null},$scope.redrawDiagram=function(e,t){m.model=go.Model.fromJson(e||m.model.toJson()),3==$scope.page.tab&&"del"!=t&&$scope.createWorkTable("preview")},$scope.commitMergeTable=function(){$scope.createWorkTable()},d(),c(),i(["join.deleteNode","join.canNotEditChart","join.fieldCanNotNull","join.tbExists","join.mustDropOnNodes"],$scope)}}}]).directive("goWbcat",["goColors","$timeout","$rootScope",function(e,t,a){function r(){function t(){go.ForceDirectedLayout.call(this)}go.Diagram.inherit(t,go.ForceDirectedLayout),t.prototype.makeNetwork=function(e){var t=go.ForceDirectedLayout.prototype.makeNetwork.call(this,e);return t.vertexes.each(function(e){var t=e.node;null!==t&&(e.isFixed=t.isSelected||!("number"==typeof t.location.x&&isNaN(t.location.x)))}),t};var r,i=go.GraphObject.make,o={makeButton:function(e,t,a){return void 0===a&&(a=function(){return!0}),i("ContextMenuButton",i(go.Shape,"Rectangle",{stroke:null,fill:"#fff",width:80,height:28,cursor:"pointer"}),i(go.TextBlock,{stroke:"#666",margin:new go.Margin(5,10,0,10)},e),{click:t},new go.Binding("visible","",a).ofObject())},textLabel:function(t,a){return i(go.TextBlock,angular.extend({font:"10px",wrap:go.TextBlock.WrapDesiredSize,margin:0,textAlign:"center",stroke:e.font,alignments:go.Spot.Bottom}),new go.Binding("text",a||"text").makeTwoWay())},tbNode:function(t,r,o){var n=r?{contextMenu:i(go.Adornment,"Vertical",s.replaceButton(),s.delButton())}:{};return i(go.Node,"Spot",new go.Binding("location","loc",go.Point.parse).makeTwoWay(go.Point.stringify),{locationSpot:go.Spot.Center,locationObjectName:"SHAPE",selectionAdorned:!1},i(go.Panel,"Auto",i(go.Shape,"File",{fill:e.bg,stroke:null},new go.Binding("figure","figure")),i(go.TextBlock,{stroke:e.highlightFont,margin:new go.Margin(5,10,0,10),maxSize:new go.Size(160,0/0),overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.WrapFit,height:20},new go.Binding("text",t||"text").makeTwoWay()),n),{cursor:o?"pointer":"default",click:function(e,t){o&&(console.log("canSkip tb_id",t.data.tb_id),a.$broadcast("skipTargetTable",t.data.tb_id))}})},joinLink:function(){return i(go.Link,{toShortLength:4},i(go.Shape,{isPanelMain:!0,stroke:"rgba(81, 130, 228, .6)",strokeWidth:2}),i(go.Shape,{toArrow:"standard",stroke:null,fill:"rgba(81, 130, 228, .6)"}),i(go.Panel,"Auto",i(go.Shape,"RoundedRectangle",{fill:"#fff",stroke:"#A3ABB0",strokeWidth:1,width:58,height:20}),i(go.TextBlock,"join",{margin:5,stroke:"#333"},new go.Binding("text","join_type"))))}},n="",l="";"zh"==$.cookie("locale")?(n="替换",l="删除"):(n="Replace",l="Delete");var s={replaceButton:function(){return o.makeButton(n,function(){a.$broadcast("replaceWorktable",r)},function(e){return r=e.data,!0})},delButton:function(){return o.makeButton(l,function(e){e.diagram.commandHandler.deleteSelection()},function(e){return e.diagram.commandHandler.canDeleteSelection()})}};return{goContextMenu:s,AppLayout:t,goWidget:o}}return{restrict:"A",link:function(e,a){function i(){s.nodeTemplate=n.tbNode("name",!1,!0),s.linkTemplate=n.joinLink()}var o=r(),n=o.goWidget,l=go.GraphObject.make,s=l(go.Diagram,a[0],{initialContentAlignment:go.Spot.Center,layout:l(go.LayeredDigraphLayout)}),d=s.layout;e.$on("redraw",function(){s.requestUpdate(),t(function(){s.model=go.Model.fromJson(s.model.toJson())},10)}),e.$watch("modelData.diagram",function(a){a&&(d.direction=180,d.layerSpacing=160,d.columnSpacing=30,e.currentLink=null,t(function(){s.model=go.Model.fromJson(angular.toJson(a)),i()},10))},!0);var c=function(t,r,i,o){e.$apply(function(){e.currentLink=i,setTimeout(function(){var e=o.x+o.width/2+25,t=o.y+o.height/2+15,r=s.transformDocToView(new go.Point(e,t)),i=a.parent().width(),n=a.parent().height(),l=Math.min(r.x,i-445),d=Math.min(r.y,n-150);a.parent().find(".merge-field-select").css({left:l,top:d,opacity:1})},0)})};s.addDiagramListener("ObjectSingleClicked",function(e){var t=e.subject.part;t instanceof go.Link&&c(t.fromNode.data,t.toNode.data,t.data,t.actualBounds)})}}}]),!function(){angular.module("BC.controllers.dataSource").controller("SQLTableCtrl",["$scope","$rootScope","$location","$timeout","errHint","commonService","$stateParams","formulaDocument","ngDialog","$jsTipTranslate","verifyTbName",function(e,t,a,r,i,o,n,l,s,d){function c(t){for(var a=e.fieldMap[t.tb_id],r=e.fieldMap[t.tb_id].length,i=" ",o=0;r>o;o++)i+=a[o].name+",";i=i.substring(0,i.length-1),e.$broadcast("insert",i)}function u(){o.folder.getList().then(function(t){function a(e){angular.forEach(e,function(e){angular.forEach(e.tb_list,function(e){i.push(e.name)}),e.sub_folders&&e.sub_folders.length>0&&a(e.sub_folders)})}e.saveFolderList=angular.copy(t),angular.forEach(e.saveFolderList,function(e){"folder_root"==e.folder_id&&(e.name="en"==$.cookie("locale")?"Root":"根目录")});var r=bdp.bdpTables.getFolderByFolderId(e.saveFolderList,e.viewData.save_folder_id);e.viewData.save_folder_name=r?r.name:"",e.folderList=t,e.original_folderList=angular.copy(t),e.$broadcast("updatefolderList",e.original_folderList);var i=[];a(e.folderList),e.table_name_array=i})}function f(t){o.field.getList(t).then(function(a){0==a.status&&(a=a.result,e.fieldMap[t]=a.schema.filter(function(e){return!e.formula}),e.fieldMap[t]=bdp.utils.addSpecParamsToFields(e.fieldMap[t]),e.tbTypeMap[t]=a.tb_type)})}function p(e){return o.tb.getModelStruct(e)}t.view="worktable",t.show_bdp_header=!1,e.folderList=null,e.table_name_array=[],e.fieldMap={},e.tbTypeMap={},e.requestDone=!0,e.actionType=void 0===n.tbId?"create":"modify",e.tbId=n.tbId,e.viewData={table_name:"",sql:"",sqlFunctions:"",func_list:[],save_folder_name:"",save_folder_id:""},e.saveFolderList=null,e.viewData.save_folder_id=$.cookie("select_folder_id")?$.cookie("select_folder_id"):"folder_root",e.sqlTablePreview={open:!0},e.tabs={index:0},e.sqlCodeMirrorLoad={complete:!1},t.pageLoading=!0;var g={funcQueue:[],loadLibInProgress:!1};thirdPluginLoader({initFun:function(){e.sqlCodeMirrorLoad.complete=!0,e.$$phase||e.$apply()},libSrc:"https://m1.bdp.cn/static/js/lib/bdpFormula/bdp-codemirror_4fc5c0e.js",otherSrc:"",libId:window.CodeMirror},g);var h=e.$watch("sqlCodeMirrorLoad.complete",function(e){e&&(t.pageLoading=!1,h())});e.toggleOpenFormula=function(){e.viewData.openFormula=!e.viewData.openFormula},e.toggleShowFields=function(t){t.open=!t.open,e.fieldMap[t.tb_id]||f(t.tb_id)},e.insertAllTable=function(t){e.fieldMap[t.tb_id]?c(t):o.field.getList(t.tb_id).then(function(a){0==a.status&&(a=a.result,e.fieldMap[t.tb_id]=a.schema.filter(function(e){return!e.formula}),e.tbTypeMap[t.tb_id]=a.tb_type,c(t))})},e.calculatePosition=function(t){var a=t.target;"I"==a.nodeName&&(a=$(a).parent(".sql-drop-down"));var r=$(a).offset(),i=$(window).height();$(a).children(".addSqlOption").css(i-r.top<100?{top:r.top-72,left:r.left-66}:{top:r.top+20,left:r.left-66}),e.clickShow=!e.clickShow},e.insertTable=function(t){e.$broadcast("insert",t.name)},e.insertFieldName=function(t){e.$broadcast("insert",t)},e.insertFunc=function(t){t="COUNT_DISTINCT"===t?"COUNT(DISTINCT())":t+"()",e.$broadcast("insert",t),e.$broadcast("setCursor","COUNT(DISTINCT())"==t?2:1)},e.undo=function(){e.$broadcast("undo")},e.redo=function(){e.$broadcast("redo")},e.resetFormat=function(){if(!e.viewData.sql)return!1;var a={sql:e.viewData.sql};t.pageLoading=!0,o.tb.sqlFormat(a).then(function(a){0==a.status&&(e.viewData.sql=e.viewData.originSql=a.result.sql,e.$broadcast("resetFormat",a.result.sql)),t.pageLoading=!1})},e.show_help=function(){e.show_syntax_help=!e.show_syntax_help,e.show_syntax_help&&r(function(){$(document).on("click.show_help",function(t){0==$(t.target).closest(".sql-syntax-help").length&&(e.show_syntax_help=!1,$(document).off("click.show_help"),e.$$phase||e.$digest())})})},e.sqlTrans=function(t){t.stopPropagation();var a=e.viewData.sql;return a?void o.tb.sqlScript({sql:a}).then(function(t){0==t.status&&i(e.tips["filter.checkSuccess"])}):void i(e.tips["where.sqlScriptNull"])},e.preview=function(a){if(a.stopPropagation(),e.tabs.index=1,e.sqlTablePreview.open=!0,!e.viewData.sql)return i(e.tips["sql.sqlScriptNotBeNullToPreview"]),!1;t.pageLoading=!0;var r={info:e.viewData.sql};"create"!=e.actionType&&(r.current_tb_id=e.tbId||""),o.sql_script.preview(r).then(function(a){var r=a;if(t.pageLoading=!1,e.sql_script_err=void 0,0==r.status)e.viewData.preview=r.result.data,e.viewData.schema=r.result.schema;else{var o=i(parseInt(r.status),{warn_msg:r.errstr,always_show:!0});e.sql_script_err=o?r.errstr:t.global.hint,t.global.hint=""}})},e.save=function(){return e.requestDone?e.viewData.sql?e.viewData.sql.length>15e4?(i(e.tips["sql.sqlTooLong"]),!1):void("create"==e.actionType?e.saveWorkTable():e.modifyWorktable()):(i(e.tips["where.sqlScriptNull"]),!1):void 0},e.saveWorkTable=function(a){function r(r){e.requestDone=!0,t.pageLoading=!1;var o=r;if(e.sql_script_err=void 0,0==o.status){var n;"create"==a&&(n=o.result.tb_id),e.preview_by_tb_id(n)}else 29e3==o.status?e.sql_script_err=o.errstr:t.global.hint||t.global.dialog_hint?e.sql_script_err=t.global.hint||t.global.dialog_hint:i(o.errstr)}a=a||"create";var n=e.viewData.table_name;if(!n)return i(e.tips["sql.workSheetCanNotNull"]),!1;if("create"==a&&e.table_name_array.indexOf(e.viewData.table_name)>-1)return i(e.tips["sql.worksheet"]+'"'+n+'"'+e.tips["sql.existAndChangeName"]),!1;if(!e.viewData.sql)return i(e.tips["sql.sqlScriptNotBeNullToSave"]),!1;if(t.pageLoading=!0,e.requestDone=!1,"create"==a){var l=e.viewData.save_folder_id;o.sql_script[a](e.viewData.table_name,e.viewData.sql,l).then(r)}else o.sql_script[a](e.viewData.table_name,e.viewData.sql,e.tbId).then(r)},e.modifyWorktable=function(){t.pageLoading=!0,e.requestDone=!1,o.sql_script.modifyPreview(e.viewData.table_name,e.viewData.sql,e.tbId,e.viewData.save_folder_id).success(function(r){if(e.requestDone=!0,t.pageLoading=!1,0==r.status){var o=r.result.can_del;if(1==o)e.saveWorkTable("modify");else if(2==o)a.path(t.wsId?"/data_source/"+t.wsId:"/data_source");else{e.responseHint={dependency:r.result.dependency};var n="en"==$.cookie("locale")?"Untitled Chart":"未命名图表";angular.forEach(e.responseHint.dependency,function(e){angular.forEach(e.chart,function(e){e.ct_name||(e.ct_name=n)})}),s.open({template:"/static/partials/dialogTemplates/tableModifyHint.html",className:"ngdialog-theme-default",scope:e})}}else 29e3==r.status?e.sql_script_err=r.errstr:t.global.hint||t.global.dialog_hint?e.sql_script_err=t.global.hint||t.global.dialog_hint:i(40002==Number(r.status)?r.errstr?e.tips["error.fieldRepeat"]+":"+r.errstr:Number(r.status):r.errstr)})},e.back=function(){function r(){a.path(t.wsId?"/data_source/"+t.wsId:"/data_source")}e.viewData.sql?s.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngdialog-width-340",scope:e,data:{message:e.tips["join.confirmToBack"]}}).then(function(){r()}):r()},e.sqlTablePreview.tabFun=function(t,a){e.tabs.index=t,e.sqlTablePreview.open=!0,a.stopPropagation()},e.preview_by_tb_id=function(e){e&&$.cookie("ds_tb_id",e),a.path(t.wsId?"/data_source/"+t.wsId:"/data_source")},angular.forEach(l,function(t){e.viewData.func_list.push(t)}),u(),"modify"==e.actionType&&p(e.tbId).success(function(t){0==t.status&&(e.viewData.table_name=t.result.table_name,e.viewData.sql=e.viewData.originSql=t.result.info)}),e.showSelectFolder=function(){s.open({templateUrl:"/static/js/worktable/tableDialog/choose_table_folder.html",scope:e,className:"ngdialog-theme-default choose-folder",data:{tbType:"sql",optType:"baseChoose",folderList:e.saveFolderList||[],folderQueryList:[],targetFolderId:e.viewData.save_folder_id||"folder_root",targetFolderType:"",queryText:"",open:{},confirmSave:e.saveSelectFolder},controller:"chooseTbFolderCtrl"})},e.saveSelectFolder=function(t){e.viewData.save_folder_id=t.targetFolderId;var a=bdp.bdpTables.getFolderByFolderId(e.saveFolderList,e.viewData.save_folder_id);e.viewData.save_folder_name=a?a.name:"",s.closeAll()},d(["sql.sqlScriptNotBeNullToSave","sql.sqlScriptNotBeNullToPreview","sql.workSheetCanNotNull","sql.preViewFailedAndCannotSave","sql.saveSuccess","sql.saveFailed","sql.existAndChangeName","sql.worksheet","sql.previewErrInfo1","sql.previewErrInfo2","join.confirmToBack","where.sqlScriptNull","filter.checkSuccess","error.fieldRepeat","wb.transform.realtimeTableCantJoin","sql.sqlTooLong"],e)}]).directive("bdpSqlEditor",function(){return{link:function(e,t,a){function r(){i=CodeMirror.fromTextArea(t[0],{mode:"text/x-bdp-sql",indentWithTabs:!0,smartIndent:!0,lineWrapping:!0,matchBrackets:!0,readOnly:n?"nocursor":!1,theme:"paraiso-light",autofocus:!n,fields:e.table_name_array,extraKeys:{"Ctrl-Space":"autocomplete"}}),n||(e.$on("insert",function(e,t){i.replaceSelection(t),i.focus()}),e.$on("setCursor",function(e,t){var a=i.getCursor(),r=a.ch-t;i.setCursor(a.line,r)}),i.on("blur",function(){e.viewData.sql=i.getValue().replace(/0xa0/,"")}),e.$on("undo",function(){i.undo(),e.viewData.sql=e.viewData.originSql=i.getValue()}),e.$on("redo",function(){i.redo(),e.viewData.sql=e.viewData.originSql=i.getValue()}),e.$on("resetFormat",function(e,t){i.setValue(t)})),o=e.$watch(a.sqlContent,function(e){e&&(i.setValue(e),o())}),e.$watch("table_name_array",function(e){e&&e.length&&i.setOption("fields",e)})}var i,o,n=!!a.readonly,l={funcQueue:[],loadLibInProgress:!1};thirdPluginLoader({initFun:r,libSrc:"https://m1.bdp.cn/static/js/lib/bdpFormula/bdp-codemirror_4fc5c0e.js",otherSrc:"",libId:window.CodeMirror},l)}}}).directive("sqlDropDown",["$timeout",function(e){return{restrict:"A",scope:{dropDownFlag:"="},link:function(t){t.$watch("dropDownFlag",function(a,r){var i=".ds-list",o="scroll.sqlfolder";if(a!==r&&1==a){var n=angular.element(i).scrollTop();e(function(){angular.element(i).on(o,function(a){Math.abs(n-$(a.target).scrollTop())>8&&(t.dropDownFlag=!1,e(function(){t.$digest()},0))})},0)}else a!==r&&0==a&&angular.element(i).off(o)})}}}])}(),!function(){function e(e,t,a,r,i,o,n,l,s){function d(){a.user.userList().then(function(t){if(0==t.status){var a=$.cookie("user_id"),r=[];for(var i in t.result)a!==t.result[i].userid&&r.push(t.result[i]);v.userList=r,e.chooseUser(v.userList[0],"init")}})}function c(t){g(t,function(e){e.forceChoose=e.choose||void 0}),bdp.bdpTables.initFolderListChoose(t),e.updateExtractTableData()}function u(){r.pageLoading=!0,a.db.subOwnWbList({sub_id:v.user.userid}).then(function(t){if(r.pageLoading=!1,0==t.status){v.folderList=t.result,c(v.folderList),r.pageLoading=!1;var a=b(v.folderList);if(v.empty=0==a,v.empty)return;e.setCurFolder(0)}})}function f(){v.workspaceList=r.workspaceList.dash}function p(){r.pageLoading=!0,a.db.subOwnWbList({sub_id:v.workspace.ws_id}).then(function(t){if(0==t.status){v.folderList=t.result,c(v.folderList),r.pageLoading=!1;var a=b(v.folderList);if(v.empty=0==a,v.empty)return;e.setCurFolder(0)}})}function g(e,t){function a(e){angular.forEach(e,function(e){angular.forEach(e.tb_list,function(e){t(e)}),e.sub_folders&&e.sub_folders.length>0&&a(e.sub_folders)})}a(e)}function h(e){function t(e){angular.forEach(e,function(e){angular.forEach(e.tb_list,function(e){e.choose&&(a+=1)}),e.sub_folders&&e.sub_folders.length>0&&t(e.sub_folders)})}var a=0;return t(e),a}function b(e){function t(e){angular.forEach(e,function(e){a+=e.tb_list.length,e.sub_folders&&e.sub_folders.length>0&&t(e.sub_folders)})}var a=0;return t(e),a}function _(e,t){function a(e,t,i){angular.forEach(e,function(e){angular.forEach(e.tb_list,function(a){a.choose&&r.push({folder_name:e.name,parent_name:i,sub_id:t,tb_id:a.tb_id})}),e.sub_folders&&e.sub_folders.length>0&&a(e.sub_folders,t,e.name)})}var r=[];return angular.forEach(t,function(t){"user"==e?a(t.data,t.userid,""):"workspace"==e&&a(t.data,t.ws_id,"")}),r}function m(e,t){function a(e,t){t.map(function(t){t.choose=e||t.forceChoose})}var r,i=[];i=void 0===t?v.folderList[e]:v.folderList[e].sub_folders[t],r=i.choose,i.className="",a(r,i.tb_list),void 0===t&&i.sub_folders&&i.sub_folders.length>0&&i.sub_folders.map(function(e){e.choose=r,a(r,e.tb_list)}),bdp.bdpTables.initFolderListChoose(v.folderList,e)}r.view="worktable",r.show_bdp_header=!1,l(function(){$(".extract-table-content").get(0).addEventListener("scroll",function(){var e=$(".bdp-tips");e.length>0&&e.hide(),e=null})},1e3),e.extractTableData={user:{data:{}},selected:null,viewType:"user",workspace:{data:{}},ws_selected:null,empty:null,ws_empty:null},e.extractTableView={sharedTbList:{}},e.curFolder={},e.curFolderItem=null;var v=e.extractTableData,w=e.extractTableView;e.changeTab=function(t){v.viewType!=t&&(v.folderList=[],e.curFolderItem=null,v.viewType=t,w.query="","user"==t?(v.userList.length>0&&e.chooseUser(v.userList[0],"init"),v.workspace.data={},v.ws_empty={}):"workspace"==t&&(v.workspaceList.length>0&&e.chooseWorkspace(v.workspaceList[0],"init"),v.user.userid="",v.user.data={},v.empty={}))},d(),e.$watch(function(){return r.workspaceList},function(e){e&&f()}),e.updateExtractTableData=function(){var e=0;if("user"==v.viewType){var t=v.user.userid,a=v.user.data;a["u_"+t]||(a["u_"+t]={data:[],empty:!1,total:0,userid:t}),a["u_"+t].data=angular.copy(v.folderList),a["u_"+t].total=h(a["u_"+t].data)}else if("workspace"==v.viewType){var r=v.workspace.ws_id,i=v.workspace.data;i[r]||(i[r]={data:[],empty:!1,total:0,ws_id:r}),i[r].data=angular.copy(v.folderList),i[r].total=h(i[r].data)}return e},e.chooseUser=function(t){if(w.userlist=!1,v.user.userid!=t.userid){v.selected=!0,v.user.name=t.name,v.user.userid=t.userid;var a=v.user.data;return a["u_"+t.userid]?(v.folderList=angular.copy(a["u_"+t.userid].data),v.empty=!1,void e.setCurFolder(0)):void u()}},e.chooseWorkspace=function(t){v.ws_selected=!0,v.workspace.name=t.name,v.workspace.ws_id=t.ws_id;var a=v.workspace.data;return a[t.ws_id]?(v.folderList=angular.copy(a[t.ws_id].data),v.empty=!1,void e.setCurFolder(0)):void p()},e.saveTb=function(){var o=[];if(!r.pageLoading)if("user"==v.viewType){var n=v.user.data;if(o=_("user",n),!o||0==o.length)return void t(e.tips["extract.selectworksheetextract"]);r.pageLoading=!0,a.db.extractTb({data:angular.toJson(o)}).then(function(e){r.pageLoading=!1,0==e.status&&i.path("/data_source")})}else if("workspace"==v.viewType){var l=v.workspace.data;if(o=_("workspace",l),!o||0==o.length)return void t(e.tips["extract.selectworksheetextract"]);r.pageLoading=!0,a.db.extractTb({workspace:1,data:angular.toJson(o)}).then(function(e){r.pageLoading=!1,0==e.status&&i.path("/data_source")})}},e.previewTbData=function(t,i){t.stopPropagation(),r.pageLoading=!0,a.tb.preview(i.tb_id,v.workspace.ws_id).then(function(t){t&&(t.generateCoordinateStatus=t.has_gis,2==t.has_gis&&a.tb.gisModify({tb_id:i.tb_id}),t.tableName=i.name,t.latestData=t.data.length,t.totalData=t.count,t.tableUpdateTime=n("date")(1e3*t.update_time,"yyyy-MM-dd HH:mm:ss"),t.currentStatus="",3==t.status||6==t.status?t.currentStatus=e.tips["wb.isUpdatingWaiting"]:2==t.status&&(t.currentStatus=e.tips["wb.updateFailed"]),e.ngDialogData=t,o.open({template:"/static/partials/dialogTemplates/preview_table_data.html",className:"ngdialog-theme-default chart-preview-data",scope:e,controller:["$scope","$timeout","$element",function(e,t,a){function r(){s=0,$(o).children("td").each(function(e,t){var a=parseInt($(t).width());$(l[e]).width(a)})}var i,o,n,l,s;t(function(){a.find(".J-table-fixhead").width(a.find(".table-scroll").children("table").width()),i=a.find(".table-scroll"),o=a.find(".table-scroll").find("tbody").find("tr")[0],n=a.find(".J-table-fixhead").find("thead").find("tr")[0],l=$(n).children("th"),r(),i.scroll(function(e){a.find(".J-table-fixhead").css({left:-e.target.scrollLeft+"px"})})},100);var d;$(window).resize(function(){clearTimeout(d),setTimeout(function(){a.find(".J-table-fixhead").width(a.find(".table-scroll").children("table").width()),r()},10)})}]})),r.pageLoading=!1})},e.back=function(){i.path(r.wsId?"/data_source/"+r.wsId:"/data_source")},e.setCurFolder=function(t,a){var r=e.curFolder;r.index=t,r.subIndex=a;var i;i=void 0===a?v.folderList[t]:v.folderList[t].sub_folders[a],e.curFolderItem=i},e.openFolder=function(t,a){e.setCurFolder(t,a)},e.checkAll=function(t,a){m(t,a),e.updateExtractTableData()},e.checkOne=function(t){bdp.bdpTables.initFolderListChoose(v.folderList,t),e.updateExtractTableData()},s(["extract.selectworksheetextract"],e)}angular.module("BC.controllers.dataSource").controller("ExtractTableCtrl",e),e.$inject=["$scope","errHint","commonService","$rootScope","$location","ngDialog","$filter","$timeout","$jsTipTranslate"]}(),!function(){angular.module("BC.controllers.dataSource.polymer",[]).controller("polymerTableCtrl",["$scope","$rootScope","$location","ngDialog","$timeout","errHint","commonHttp","$stateParams","commonService","$jsTipTranslate","filterOperatorMapWithType","formulaKeyMap","dateNameMap","verifyTbName",function(e,t,a,r,i,o,n,l,s,d,c,u,f){function p(){var t=angular.copy(e.polymerData.fields);angular.forEach(t,function(e){e.title=e.nick_name}),e.polymerData.tbList=[{name:e.polymerData.current_tb_name,tb_id:e.polymerData.current_tb_id,open:!0,fields:t}]}function g(e,t){var a=Math.abs(e.x1+e.x2-t.x1-t.x2),r=e.x2-e.x1+(t.x2-t.x1),i=Math.abs(e.y1+e.y2-t.y1-t.y2),o=e.y2-e.y1+(t.y2-t.y1);return r>=a&&o>=i}function h(e,t){var a={x1:t.offset.left,y1:t.offset.top,x2:t.offset.left+t.helper.width(),y2:t.offset.top+t.helper.height()},r=$(".polymer-content-hd"),i=r.offset(),o={x1:i.left,y1:i.top,x2:i.left+r.width(),y2:i.top+r.height()};return!g(a,o)}function b(e){return 1!==e.is_build_aggregated||"date"==e.data_type&&(e.formula.indexOf("MAX_DATE")>=0||e.formula.indexOf("max_date")>=0||e.formula.indexOf("MIN_DATE")>=0)||e.formula.indexOf("min_date")>=0?!0:!1}function _(t){for(var a=e.polymerData.data.x,r=0,i=a.length;i>r;r++)if(a[r].fid==t.fid)return!0;return!1}function m(t,a){var r=e.polymerData.data.x,i=e.polymerData.data.y,o=e.polymerView.show_formula_y,n={};if("x"==a)n={fid:t.fid,name:t.name,nick_name:t.nick_name||t.name,data_type:t.data_type,is_build_aggregated:t.is_build_aggregated,formula:t.formula},"date"==t.data_type&&(n.granularity="day"),r.push(n);else{var l,s="SUM";"number"!==t.data_type&&(s="COUNT"),l=u[s],n={fid:t.fid,name:t.name,nick_name:t.nick_name||t.name,data_type:t.data_type,aggregator:1!=t.is_build_aggregated?s:"",aggregator_name:1!=t.is_build_aggregated?l:"",is_build_aggregated:t.is_build_aggregated,formula:t.formula},"date"==t.data_type&&(n.granularity="day"),i.push(n),o.push(!1)}}function v(){i(function(){var t=$("#polymer-content-hd").height();e.polymerView.top=t+23+"px"},10)}function w(e){var t={};t.where_type=e.filterType,t.where_linker=e.where_linker,"sql"==t.where_type?(t[t.where_type]=[],angular.forEach(e.sql,function(e,a){e&&t[t.where_type].push({tb_id:a,sql:e})})):t[t.where_type]={filters:y(e.filters)},e.where=t,delete e.filterType,delete e.where_linker,delete e.filters,delete e.sql}function y(e){var t=angular.copy(e);return t=$.map(t,function(e){return D(e)&&T(e)?e:null})}function D(e){if("number"==e.data_type&&8!=e.operator&&9!=e.operator&&10!=e.operator){if(isNaN(Number(e.value)))return!1;if(""===e.value)return!1;e.value=Number(e.value)}return!0}function T(e){return e.fid&&void 0!=e.operator&&(8==e.operator||9==e.operator||10==e.operator||""!==e.value&&void 0!=e.value)&&(10!=e.operator||""!=e.start_date&&""!=e.end_date)?!0:!1}function F(){e.polymerData.fields_list=bdp.utils.addSpecParamsToFields(e.polymerData.fields),angular.forEach(e.polymerData.fields_list,function(e){e.origin_name=e.name,e.name=e.nick_name})}function k(e){E=0;var t=$("#tb-header"),a=t.find("li"),r=0;e.find("thead").eq(0).find("th").each(function(e){var t=$(this).outerWidth(),i=e==a.length-1?t-E-1:0==e?t+1:t;r+=i,a.eq(e).css("width",i)}),t.css("width",r),t.show()}t.view="data_source",t.show_bdp_header=!1,e.requestDone=!0,e.isRequestFieldList=!1,e.formulaKeyMap=u,e.action=l.tbId?"modify":"create",e.polymerView={show_formula_y:[],show_formula_date:{},loading:!1,show_edit:{}},e.polymerData={tbList:[],current_tb:{tb_id:"",name:""},current_tb_name:"",editting_text:"",preview_list:[],table_name:"",data:{x:[],y:[],where_linker:"and",filters:[],filterType:"condition",sql:{}},formula:[{name:"求和",type:"SUM",show:"number"},{name:"平均值",type:"AVG",show:"number"},{name:"计数",type:"COUNT",show:"all"},{name:"去重计数",type:"COUNT_DISTINCT",show:"all"},{name:"最大值",type:"MAX",show:"number"},{name:"最小值",type:"MIN",show:"number"}],date_formula:[{name:"按年",type:"year"},{name:"按季",type:"quarter"},{name:"按月",type:"month"},{name:"按周",type:"week"},{name:"按日",type:"day"},{name:"按时",type:"hour"},{name:"按分",type:"minute"},{name:"按秒",type:"second"}]},e.polymerFilter={open:!0};var L=e.polymerData;e.saveFolderList=null,e.save_folder={folder_id:$.cookie("select_folder_id")?$.cookie("select_folder_id"):"folder_root",folder_name:""},e.filterMergedTable=function(e){return"excel"!==e.type&&"aggr"!==e.type&&"db"!==e.type
},e.back=function(){function i(){a.path(t.wsId?"/data_source/"+t.wsId:"/data_source")}L.data.x.length>0||L.data.y.length>0?r.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngdialog-width-340",scope:e,data:{message:e.tips["join.confirmToBack"]}}).then(function(){i()}):i()},e.chooseTbModel=function(){var t=function(t){e.saveFolderList=angular.copy(t),angular.forEach(e.saveFolderList,function(e){"folder_root"==e.folder_id&&(e.name="en"==$.cookie("locale")?"Root":"根目录")});var a=bdp.bdpTables.getFolderByFolderId(e.saveFolderList,e.save_folder.folder_id);e.save_folder.folder_name=a?a.name:"",e.folderList=t,e.original_folderList=angular.copy(t),e.$broadcast("updatefolderList",e.original_folderList),r.open({template:"/static/partials/choose_table_list.html",className:"ngdialog-theme-default data-source",data:{json_data:{title:"选择聚合数据表",type:"choose",show_upload:!1},choose_table:{tb_id:""}},scope:e})};n.get("/api/folder/list").then("modify"==e.action?function(t){e.saveFolderList=angular.copy(t.result),angular.forEach(e.saveFolderList,function(e){"folder_root"==e.folder_id&&(e.name="en"==$.cookie("locale")?"Root":"根目录")});var a=bdp.bdpTables.getFolderByFolderId(e.saveFolderList,e.save_folder.folder_id);e.save_folder.folder_name=a?a.name:"",e.folderList=t.result,e.original_folderList=angular.copy(t.result),e.$broadcast("updatefolderList",e.original_folderList)}:function(e){0==e.status&&t(e.result)})},e.getModelStruct=function(t){s.tb.getModelStruct(t).then(function(t){var a=t;if("0"==a.status){var r=a.result;angular.extend(e.polymerData,{table_name:r.tb_title,current_tb:{tb_id:r.origin_tb_id,name:r.origin_name},data:r.info,current_tb_name:r.origin_name});var i=r.info.where,n=L.data.filterType=i.where_type;if(L.data.where_linker=i.where_linker,L.data.filters=[],"sql"==i.where_type){var l={};angular.forEach(i[n],function(e){l[e.tb_id]=e.sql}),L.data.sql=l}else{var s=i[n];L.data.filters=s.filters}e.chooseTableOk({name:r.origin_name,tb_id:r.origin_tb_id},!0),v()}else o(Number(a.status))})},e.chooseTableOk=function(t,a){return t.tb_id?(void 0===a&&(e.polymerData.data.x=[],e.polymerData.data.y=[]),e.polymerData.preview_list=[],e.polymerData.schema=[],void n.get("/api/data_aggr/fields",{tb_id:t.tb_id}).then(function(o){0==Number(o.status)&&(e.polymerData.fields=o.result.fields,e.polymerData.chooseTableTbType=o.result.tb_type,e.polymerData.fieldValues={},F(),r.closeAll(),e.polymerData.current_tb_name=t.name,e.polymerData.current_tb_id=t.tb_id,e.tb_id=t.tb_id,a&&x(),"modify"!=e.action&&(e.polymerData.data.filters=[],e.$broadcast("InitializeCurItem")),p(),i(function(){e.$broadcast("initSql",t.tb_id)},10))})):void o(e.tips["polymer.selectWorkSheet"])},"modify"==e.action?(e.tbId=l.tbId,e.chooseTbModel(),e.getModelStruct(e.tbId)):e.chooseTbModel(),e.startDragField=function(t,a,r,i){return e.isRequestFieldList?void o("正在加载字段列表，请稍等"):(e.polymerData.current_field={},curField=e.polymerData.current_field,curField.fid=r.fid,curField.name=r.name,curField.data_type=r.data_type,curField.nick_name=r.nick_name,curField.is_build_aggregated=r.is_build_aggregated,curField.formula=r.formula,angular.element(".axis").append('<div class="draggable-area"></div>'),i?(e.sortPolymerOption.originAxis=i,curField.fid=r.fid+"_"+i,curField.data_type="sub_date",void(curField.name=f[i]+"("+curField.name+")")):void(e.sortPolymerOption.originAxis="field-list"))},e.sortPolymerOption={originAxis:"",targetAxis:"",currentAction:""},e.sortPolymerField={connectWith:".axis-field-list",opacity:.6,"ui-floating":!0,start:function(t,a){$(a.item[0].parentNode).hasClass("x-field-list")?e.sortPolymerOption.originAxis="x":$(a.item[0].parentNode).hasClass("y-field-list")&&(e.sortPolymerOption.originAxis="y")},sort:function(e,t){var a=t.helper;a.css({width:$(this).width()+1})},over:function(){},beforeStop:function(t,a){e.sortPolymerOption.currentAction=h(t,a)?"del":"sort","del"==e.sortPolymerOption.currentAction&&a.item.sortable.cancel()},receive:function(){},update:function(){},stop:function(t,a){var r=a.item.sortable.model;if("del"==e.sortPolymerOption.currentAction)return void("x"==e.sortPolymerOption.originAxis?e.deleteField("x",r):e.deleteField("y",r));if($(a.item.sortable.droptarget).hasClass("x-field-list"))e.sortPolymerOption.targetAxis="x";else{if(!$(a.item.sortable.droptarget).hasClass("y-field-list"))return void a.item.sortable.cancel();e.sortPolymerOption.targetAxis="y"}"x"==e.sortPolymerOption.targetAxis?(r=e.sortFieldAtX(r),e.formatFieldForAxis("x")):(r=e.sortFieldAtY(r),e.formatFieldForAxis("y")),v(),x()}},e.stopDragField=function(){angular.element(".draggable-area").remove()},e.sortFieldAtX=function(e){return e={fid:e.fid,name:e.name,nick_name:e.nick_name||e.name,data_type:e.data_type,is_build_aggregated:e.is_build_aggregated,formula:e.formula},"date"==e.data_type&&(e.granularity="day"),e},e.sortFieldAtY=function(t){var a,r="SUM";return"number"!==t.data_type&&(r="COUNT"),a=u[r],t={fid:t.fid,name:t.name,nick_name:t.nick_name||t.name,data_type:t.data_type,aggregator:1!=t.is_build_aggregated?r:"",aggregator_name:1!=t.is_build_aggregated?a:"",is_build_aggregated:t.is_build_aggregated,formula:t.formula},"date"==t.data_type&&(t.granularity="day"),e.polymerView.show_formula_y.push(!1),t},e.formatFieldForAxis=function(t){if("x"==t)angular.forEach(e.polymerData.data.x,function(e){"date"==e.data_type&&""!=e.granularity&&(e.granularity="day"),e.hasOwnProperty("aggregator")&&(delete e.aggregator,delete e.aggregator_name)});else{var a="",r="";angular.forEach(e.polymerData.data.y,function(e){e.hasOwnProperty("aggregator")||(a="number"!==e.data_type?"COUNT":"SUM",r=u[a],e.aggregator=1!=e.is_build_aggregated?a:"",e.aggregator_name=1!=e.is_build_aggregated?a:""),"date"==e.data_type&&""!=e.granularity&&(e.granularity="day")})}},e.deleteField=function(t,a){if("x"==t){var r=e.polymerData.data.x.indexOf(a);r>-1&&e.polymerData.data.x.splice(r,1)}else{var r=e.polymerData.data.y.indexOf(a);r>-1&&e.polymerData.data.y.splice(r,1)}v(),x()},e.batchOnDropAdd=function(t){return e.polymerData.fields_list&&0!=e.polymerData.fields_list.length?void r.open({template:"/static/partials/polymer_batch_add_ondrop.html",className:"ngdialog-theme-default batch-add-axis-dialog",scope:e,data:{fieldList:e.polymerData.fields_list,axisType:t},controller:["$scope","$filter",function(e,a){e.fieldTypeList=[{type:"date",selected:!1},{type:"string",selected:!1},{type:"number",selected:!1}],e.initText={dialogFooterTip:function(t){switch(t){case"x":return e.tips["polymer.batchAddTips"];case"y":return""}}(e.ngDialogData.axisType),dialogTitleKeyWord:function(t){return"x"===t?e.tips["polymer.addFieldsToAxisX"]:e.tips["polymer.addFieldsToAxisY"]}(e.ngDialogData.axisType)},e.axisType=e.ngDialogData.axisType,angular.forEach(e.ngDialogData.fieldList,function(t){t.selected=!1,t.disabled=!1,"x"===e.axisType&&(!b(t)||_(t))&&(t.disabled=!0)}),e.selectedAllByType=function(t,r){var i=r.selected,o=a("getFieldsByDataType")(e.ngDialogData.fieldList,t);angular.forEach(o,function(e){e.disabled||(e.selected=i)})},e.checkBatchAddType=function(t,r){var i=0,o=0,n=a("getFieldsByDataType")(e.ngDialogData.fieldList,t);angular.forEach(n,function(e){e.disabled||(o+=1,e.selected&&(i+=1))}),r.selected=i==o?!0:!1},e.batchAdd=function(){var a=[];return angular.forEach(e.ngDialogData.fieldList,function(e){e.selected&&a.push(e)}),0==a.length?(o(e.tips["chart.canNotAddEmpty"]),!1):(angular.forEach(a,function(e){m(e,t)}),v(),x(),void e.closeThisDialog())}}]}):!1},e.onDropAdd=function(t,a,r){if("x"!=e.sortPolymerOption.originAxis&&"y"!=e.sortPolymerOption.originAxis){if("x"==r){if(_(e.polymerData.current_field))return o(e.tips["polymer.isAdd"]),!1;if(!b(e.polymerData.current_field))return o(e.tips["polymer.useAggregate"]),!1}m(e.polymerData.current_field,r),v(),x()}},e.removeAxis=function(t,a,r,i){e.polymerData.data[i].splice(r,1),x()},e.switchAggregator=function(t,a){e.polymerData.data.y[a].aggregator=t.type,e.polymerData.data.y[a].aggregator_name=t.name,x()},e.switchGranularity=function(t,a){e.polymerData.data.x[a].granularity=t.type,x()},e.edit=function(t){var a=e.polymerData.schema;angular.forEach(a,function(e,a){e.editting=!1,a==t&&(e.editting=!0)}),e.polymerData.editting_text=e.polymerData.schema[t].name},e.keyupFun=function(t,a){13==t.keyCode&&e.commit(a)},e.commit=function(t){var a=e.polymerData.editting_text,r=e.polymerData.data.x.length;e.polymerData.schema[t].name=a,r>t?e.polymerData.data.x[t].nick_name=a:e.polymerData.data.y[t-r].nick_name=a,e.polymerData.schema[t].editting=!1},e.saveTb=function(){var r=e.polymerData.data,i=e.polymerData.table_name;if(!i)return void o(e.tips["polymer.inputTableName"]);if(0==r.x.length&&0==r.y.length)return void o(e.tips["polymer.dimensionOrValueCanNotNull"]);var l=angular.copy(e.polymerData.data);w(l),t.pageLoading=!0;var s="/api/data_aggr/create",d={info:angular.toJson(l),tb_name:i,base_tb_id:e.polymerData.current_tb_id};"modify"==e.action?(s="api/data_aggr/modify",d.tb_id=e.tbId):d.folder_id=e.save_folder.folder_id,e.requestDone=!1,n.post(s,d).then(function(r){if(e.requestDone=!0,t.pageLoading=!1,0==Number(r.status)){if("modify"!=e.action){var i=r.result.tb_id;$.cookie("ds_tb_id",i)}a.path(t.wsId?"/data_source/"+t.wsId:"/data_source")}})};var S=function(){var i=e.polymerData.data,l=e.polymerData.table_name;if(!l)return void o(e.tips["polymer.inputTableName"]);if(0==i.x.length&&0==i.y.length)return void o(e.tips["polymer.dimensionOrValueCanNotNull"]);var s=angular.copy(e.polymerData.data);w(s),e.requestDone=!1,n.post("/api/data_aggr/modify_preview",{tb_id:e.tbId,base_tb_id:e.polymerData.current_tb_id,info:angular.toJson(s),tb_name:e.polymerData.table_name,folder_id:e.save_folder.folder_id}).then(function(i){if(e.requestDone=!0,0==Number(i.status)){var n=i.result.can_del;if(1==n)e.saveTb();else if(2==n)a.path(t.wsId?"/data_source/"+t.wsId:"/data_source");else{e.responseHint={dependency:i.result.dependency};var l="en"==$.cookie("locale")?"Untitled Chart":"未命名图表";angular.forEach(e.responseHint.dependency,function(e){angular.forEach(e.chart,function(e){e.ct_name||(e.ct_name=l)})}),r.open({template:"/static/partials/dialogTemplates/tableModifyHint.html",className:"ngdialog-theme-default",scope:e}),e.loading=!1}}else 30003==Number(i.status)?o(i.errstr):40002==Number(i.status)&&o(i.errstr?e.tips["error.fieldRepeat"]+":"+i.errstr:Number(i.status))})};e.save=function(){e.requestDone&&("modify"==e.action?S():e.saveTb())};var x=function(){var a=angular.copy(e.polymerData.data);w(a),t.pageLoading=!0,n.post("/api/data_aggr/preview",{info:angular.toJson(a),base_tb_id:e.polymerData.current_tb_id}).then(function(a){if(0==Number(a.status)){var r=a.result;e.polymerData.schema=[],angular.forEach(r.schema,function(t){e.polymerData.schema.push({data_type:t.data_type,fid:t.fid,name:t.nick_name,editting:!1})}),e.polymerData.schema=r.schema,e.polymerData.preview_list=r.data,i(function(){$("#tb-header").hide(),k($("#tb-detail-table"))},0),e.originalPolymerData=angular.copy(e.polymerData)}else 10==Number(a.status)?o(a.errstr):40002==Number(a.status)&&o(a.errstr?e.tips["error.fieldRepeat"]+":"+a.errstr:Number(a.status));t.pageLoading=!1})};e.$on("toFilter",function(){x()}),e.createFieldFormula=function(){if(e.newField={type:"create",name:"",aggregator:"",tb_id:e.polymerData.current_tb_id},e.newField.tb_id){t.pageLoading=!0;var a="/static/partials/add_field.html";r.open({template:a,data:{fieldList:e.polymerData.fields_list},className:"ngdialog-theme-default add-field-dialog",scope:e})}else o(3009)},e.createFieldGroup=function(){if(e.newField={type:"create",name:"",aggregator:"",tb_id:e.polymerData.current_tb_id},e.newField.tb_id){t.pageLoading=!0;var a="/static/partials/field_groups.html";r.open({template:a,data:{fieldList:e.polymerData.fields_list},className:"ngdialog-theme-default add-field-dialog group-field-dialog",scope:e})}else o(3009)},e.addCalcField=function(t){e.global.clickComplete=!1;var a=!1;if(t.name?t.data_type||t.param?t.aggregator.trim()||t.param&&"group"==t.param.type||(o(e.tips["polymer.inputFieldCalcFormula"]),a=!0):(o(e.tips["polymer.mustSelectFieldType"]),a=!0):(o(e.tips["polymer.fieldNameCanNotNull"]),a=!0),a)return e.global.clickComplete=!0,!1;var l="create"==t.type?e.tips["polymer.addFieldSuccess"]:e.tips["polymer.editFieldSuccess"];if("create"!=t.type){var d=!1,c=e.polymerData.data.x,u=e.polymerData.data.y;if(c&&c.length>0)for(var f=0;f<c.length;f++)t.fid==c[f].fid&&(d=!0);if(!d&&u&&u.length>0)for(var g=0;g<u.length;g++)t.fid==u[g].fid&&(d=!0);d&&(l=l+"!  "+e.tips["polymer.pleaseDragAgain"])}s.field["create"===t.type?"create":"modify"]({tb_id:t.tb_id,original_field_name:t.original_field_name||"",new_field_name:t.name,aggregator:t.aggregator.trim(),data_type:t.data_type,param:angular.toJson(t.param),fid:t.fid||""}).success(function(a){e.global.clickComplete=!0,0==a.status?(r.closeAll(),e.isRequestFieldList=!0,n.get("/api/data_aggr/fields",{tb_id:e.polymerData.current_tb_id}).then(function(t){if(e.isRequestFieldList=!1,0==Number(t.status)){e.polymerData.fields=t.result.fields,F(),p(),r.closeAll();var a=r.open({template:"/static/partials/dialogTemplates/alert_success.html",scope:e,className:"ngdialog-theme-default ngDialog-width-300",data:{message:l},preCloseCallback:function(){i.cancel(o)}}),o=i(function(){r.close(a)},3e3)}})):o("7200"==a.status?isObjectEmpty(t.param)?e.tips["polymer.fieldFormularError"]:e.tips["polymer.groupMessageError"]:a.errstr)})},e.modifyField=function(a){if(e.isRequestFieldList)return void o("正在加载字段列表，请稍等");t.pageLoading=!0,e.newField=angular.extend({aggregator:a.formula,original_field_name:a.nick_name||a.name},a,{type:"modify",tb_id:e.polymerData.current_tb_id,name:a.nick_name||a.name});var i="/static/partials/add_field.html";a.hasOwnProperty("param")&&"group"==a.param.type&&(i="/static/partials/field_groups.html"),r.open({template:i,data:{fieldList:e.polymerData.fields_list},className:"ngdialog-theme-default add-field-dialog group-field-dialog",scope:e})},e.delNewField=function(t,a){if(e.isRequestFieldList)return void o("正在加载字段列表，请稍等");var i=e.polymerData.data.x,l=e.polymerData.data.y;if(i&&i.length>0)for(var d=0;d<i.length;d++)if(a==i[d].fid)return void o(e.tips["chart.fieldInUsing"]);if(l&&l.length>0)for(var c=0;c<l.length;c++)if(a==l[c].fid)return void o(e.tips["chart.fieldInUsing"]);r.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:e.tips["chart.delField"]+": "+t+" ?"}}).then(function(){s.field.del(a,e.polymerData.current_tb_id).success(function(t){0==t.status?(e.isRequestFieldList=!0,n.get("/api/data_aggr/fields",{tb_id:e.polymerData.current_tb_id}).then(function(t){e.isRequestFieldList=!1,0==Number(t.status)?(e.polymerData.fields=t.result.fields,F(),p(),e.$broadcast("updateField",{fid:a})):30003==Number(t.status)?o(t.errstr):40002==Number(t.status)&&o(t.errstr?e.tips["error.fieldRepeat"]+":"+t.errstr:Number(t.status))})):7590==Number(t.status)?o(e.tips["chart.fieldInUsing"]):40006==Number(t.status)?o(t.errstr):30003==Number(t.status)?o(t.errstr):40002==Number(t.status)&&o(t.errstr?e.tips["error.fieldRepeat"]+":"+t.errstr:Number(t.status))})})},e.changeCalcFieldName=function(t,a){var r=e.polymerData.data.x,i=e.polymerData.data.y,o=(r.concat(i),{}),n=0,l=0;for(n=0,l=a.length;l>n;n++)if(t==a[n].fid){o=a[n];break}if(o){for(n=0,l=r.length;l>n;n++)t==r[n].fid&&(r[n].data_type=o.data_type,r[n].formula=o.formula,r[n].is_build_aggregated=o.is_build_aggregated,r[n].nick_name=o.nick_name);for(n=0,l=i.length;l>n;n++)t==i[n].fid&&(i[n].data_type=o.data_type,i[n].formula=o.formula,i[n].is_build_aggregated=o.is_build_aggregated,i[n].nick_name=o.nick_name)}},$(window).resize(function(){k($("#tb-detail-table"))});var E=window.isIE?5:getScrollbarWidth();e.showSelectFolder=function(){r.open({templateUrl:"/static/js/worktable/tableDialog/choose_table_folder.html",scope:e,className:"ngdialog-theme-default choose-folder",data:{tbType:"polymer",optType:"baseChoose",folderList:e.saveFolderList||[],folderQueryList:[],targetFolderId:e.save_folder.folder_id||"folder_root",targetFolderType:"",queryText:"",open:{},confirmSave:e.saveSelectFolder},controller:"chooseTbFolderCtrl"})},e.saveSelectFolder=function(t){e.save_folder.folder_id=t.targetFolderId;var a=bdp.bdpTables.getFolderByFolderId(e.saveFolderList,e.save_folder.folder_id);e.save_folder.folder_name=a?a.name:"",r.closeAll()},d(["polymer.selectWorkSheet","polymer.year","polymer.month","polymer.day","polymer.hour","polymer.minute","polymer.second","polymer.useAggregate","polymer.isAdd","polymer.inputTableName","polymer.dimensionOrValueCanNotNull","chart.fieldInUsing","saveSuccess","polymer.saveFailed","polymer.fieldNameCanNotNull","polymer.mustSelectFieldType","polymer.inputFieldCalcFormula","polymer.addFieldSuccess","polymer.editFieldSuccess","polymer.fieldFormularError","polymer.groupMessageError","nameInvalid","join.worksheetname","filter.checkSuccess","filter.checkFailed","chart.delField","chart.fieldInUsing","polymer.pleaseDragAgain","polymer.filterTypeAndValueError","polymer.optionsCanNotNull","error.fieldRepeat","sql.previewErrInfo1","sql.previewErrInfo2","join.confirmToBack","chart.canNotAddEmpty","polymer.addFieldsToAxisX","polymer.addFieldsToAxisY","polymer.batchAddTips"],e)}])}(),angular.module("BC.controllers.dataSource.polymer").directive("polymerFilter",["errHint","$jsTipTranslate","filterOperatorMapWithType","ngDialog","dateTimeByHalfHour",function(e,t,a,r,i){return{restrict:"A",scope:!0,templateUrl:"/static/partials/polymer_filter.html",replace:!0,link:function(o){function n(e){var t=o.curFilter;t.field&&t.field.fid==e&&(t.field={},t.value="",t.operator="");for(var a=o.polymerData.data.filters,r=a.length-1;r>=0;r--)a[r].fid==e&&a.splice(r,1)}function l(e){if("number"==e.field.data_type&&8!=e.operator&&9!=e.operator&&10!=e.operator){if(isNaN(Number(e.value)))return!1;if(""===e.value)return!1;e.value=Number(e.value)}return!0}function s(e){return e.field&&void 0!=e.operator&&(8==e.operator||9==e.operator||10==e.operator||""!==e.value&&void 0!=e.value)&&(10!=e.operator||e.start_date||e.end_date)?!0:!1}function d(e){return Highcharts.dateFormat("%Y-%m-%d",e)}o.curFilter={operator:0,notPreview:!0},o.operatorMap=a,o.dateTimeByHalfHour=i,o.addFilter=function(t){if(!s(t))return void e(o.tips["polymer.optionsCanNotNull"]);if(!l(t))return void e(o.tips["polymer.filterTypeAndValueError"]);var a=angular.extend({value:t.value,operator:t.operator,start_date:t.start_date,end_date:t.end_date},t.field);o.polymerData.data.filters.push(a),o.curFilter={operator:0,notPreview:!0},o.$emit("toFilter","parent"),o.addNewFilter()},o.deleteFilter=function(e){o.polymerData.data.filters.splice(e,1),o.$emit("toFilter","parent")},o.$on("updateField",function(e,t){var a=t.fid;n(a)}),o.addNewFilter=function(e){e&&angular.element(e.target).closest(".filter-wrap").animate({scrollTop:2e3})},o.operatorChange=function(e,t){(8==e.operator||9==e.operator||10==e.operator)&&(e.value=""),10!=e.operator&&(e.start_date=null,e.end_date=null),t&&o.$emit("toFilter","parent")},o.preViewTb=function(){o.$emit("toFilter","parent")},o.onWhereLinkerChange=function(){o.$emit("toFilter","parent")},o.fieldChange=function(e){"date"==e.field.data_type?(e.operator=10,e.value="",e.start_date=null,e.end_date=null):(e.operator=0,e.value="")},o.dateRangeShow=function(e){var t=[e.start_date,e.end_date];if(t[0]||t[1]||(t[0]=Highcharts.dateFormat("%Y-%m-%d",+new Date),t[1]=Highcharts.dateFormat("%Y-%m-%d",+new Date)),t.length>1){var a=t[0]?t[0].split(" ")[1]||"00:00:00":"00:00:00",i=t[1]?t[1].split(" ")[1]||"23:59:59":"23:59:59";t=t.concat([a,i])}else 0===t.length&&(t=[+new Date,+new Date,"00:00:00","23:59:59"]);r.open({template:"/static/partials/dialogTemplates/custom_date_modal.html",className:"ngdialog-theme-default date-picker-modal daterange-bdp-modal",data:{filterItem:e,range:t},scope:o})},o.saveDateRange=function(t){var a=t.sDate?d(new Date(t.sDate))+" "+t.sDateHour:null,i=t.eDate?d(new Date(t.eDate))+" "+t.eDateHour:null;if(!a&&!i)return e(o.tips["chart.dateRangeRequired"]),!1;if(a&&i){if(!t.sDateHour)return e(o.tips["filter.startDateErr2"]),!1;if(!t.eDateHour)return e(o.tips["filter.endDateErr2"]),!1;if(new Date(a)-new Date(i)>0)return e(o.tips["filter.dateRangeInvalid"]),!1}else{if(a&&!i&&!t.sDateHour)return e(o.tips["filter.startDateErr2"]),!1;if(!a&&i&&!t.eDateHour)return e(o.tips["filter.endDateErr2"]),!1}t.data.filterItem.start_date=a,t.data.filterItem.end_date=i,r.closeAll(),t.data.filterItem.notPreview||o.$emit("toFilter","parent")},o.$on("InitializeCurItem",function(){o.curFilter={operator:0,notPreview:!0}}),t(["polymer.optionsCanNotNull","polymer.filterTypeAndValueError","chart.dateRangeRequired","filter.dateRangeInvalid","filter.startDateErr2","filter.endDateErr2"],o)}}}]),!function(){angular.module("BC.controllers.dataSource").controller("parseUrlCtrl",["$scope","ngDialog","$stateParams","commonService","mergeFieldDelegate","errHint","$filter","$location","$translate","$rootScope",function(e,t,a,r,i,o,n,l,s,d){function c(){s(["field.parseUrl","field.merge","field.originField","field.queryField","back"]).then(function(t){T.parseUrl=t["field.parseUrl"],T.mergeField=t["field.merge"],T.queryField=t["field.queryField"],T.originField=t["field.originField"],e.title="parse_url"==e.action?T.parseUrl:T.mergeField})}function u(){if(!e.viewData.urlPreviewData.hasOwnProperty("header"))return[];var t=e.viewData.urlPreviewData.header,a=[];return angular.forEach(t,function(e){e.hasOwnProperty("key")&&e.hasOwnProperty("fromFid")&&e.hasOwnProperty("check")&&e.check&&a.push({key:e.key,from_fid:e.fromFid})}),a}function f(e,t,a){for(var r=!1,i=0,o=a.length;o>i;i++)a[i].from_fid==t&&a[i].key==e&&(r=!0);return r}function p(t){var a=[],r=[],i={},o=0,n=0,l=[],s=!1;return!e.viewData.needPreview&&e.previewDone&&e.viewData.urlPreviewData&&e.viewData.urlPreviewData.hasOwnProperty("header")&&(s=!0,l=u()),angular.forEach(t,function(t,d){i=m(d,e.viewData.schema),r=[],i&&(o+=t.keys.length,angular.forEach(t.keys,function(e,t){s&&l.length>0?f(e,d,l)?(n++,r.push({name:e,index:t,check:!0})):r.push({name:e,index:t,check:!1}):s&&0==l.length?r.push({name:e,index:t,check:!1}):(n++,r.push({name:e,index:t,check:!0}))}),a.push({original_field_id:d,original_field_name:i.name,keys:r}))}),e.beforeExtractData.total_num=o,e.beforeExtractData.check_num=n,e.beforeExtractData.select_all=o==n,o>200&&(e.beforeExtractData.select_all=!1,a=[]),a}function g(t){e.viewData.urlExtractData.fields=n("query_parse_param")(e.beforeExtractData.fields,t);var a=0,r=0;angular.forEach(e.viewData.urlExtractData.fields,function(t){r+=t.keys.length,angular.forEach(t.keys,function(r){angular.forEach(e.current_select_fields.fields,function(e){t.original_field_id==e.original_field_id&&angular.forEach(e.keys,function(e){r.name==e.name&&(r.check=e.check)})}),r.check&&a++})}),e.viewData.urlExtractData.check_num=a,e.viewData.urlExtractData.total_num=r,e.viewData.urlExtractData.select_all=a==r&&0!=a}function h(e){return r.tb.getInfo(e)}function b(e,t){return r.field.url_preview(e,t)}function _(t){var a=[],r=[],i=[],n=200,l=0;return angular.forEach(t,function(e){l+=e.keys.length}),l.length>n?void o("提取出来的字段数超过"+n+"个, 暂不支持"):(angular.forEach(t,function(t,o){var n=m(o,e.viewData.schema);if(n){a.push({name:"源字段",cols:1}),t.keys.length&&a.push({type:"query",name:"新字段",cols:t.keys.length}),r.push(n);var s=t.keys.map(function(e){return{name:e+"-"+n.name,fromFid:n.fid,fid:e+"-"+n.fid,key:e,data_type:"string",check:50>l}});r=r.concat(s),angular.forEach(t.odata,function(e,a){var r=[e].concat(t.data[a]);i[a]=i[a]?i[a].concat(r):r})}}),{groups:a,header:r,content:i})}function m(e,t){for(var a=0,r=t.length;r>a;a++)if(t[a].fid===e)return t[a];return null}function v(e){var t=[];return angular.forEach(e,function(e){e.fromFid&&e.check&&t.push(e)}),t}function w(e,t){for(var a=t.map(function(e){return e.name}),r=0,i=e.length;i>r;r++)if(a.indexOf(e[r].title)>=0)return e[r].title;return!1}function y(e){var t=!1;return angular.forEach(e,function(e){""==e.title&&(t=!0)}),t}function D(e,t){return r.field.merge(e,t)}function D(e,t){return r.field.extract_url(e,t)}d.show_bdp_header=!1;var T={parseUrl:"提取网址参数",mergeField:"归并字段",queryField:"提取字段",originField:"工作表字段"};e.tbId=a.tbId,e.title="提取网址参数",e.action="parse_url",c(),e.$on("$translateChangeSuccess",c),e.viewData={},e.viewData.query_param="",e.viewData.urlFields=[],e.viewData.needPreview=!0,e.viewData.originalData={},e.viewData.urlExtractData={},e.viewData.urlPreviewData=null,e.beforeExtractData={check_num:0,total_num:0,select_all:!0,fields:[]},e.addUrlField=function(){if(e.viewData){if(e.viewData.urlFields.length>=10)return o("一次最多允许解析10个字段"),!1;e.viewData.urlFields.push(e.viewData.string_schema[0]),e.viewData.needPreview=!0,e.clearPreviewData()}},e.changeUrlField=function(){e.viewData.needPreview=!0,e.clearPreviewData()},e.removeUrlField=function(t){e.viewData.urlFields.splice(t,1),e.viewData.needPreview=!0,e.clearPreviewData()},e.previewDone=!0,e.previewParseUrl=function(){function a(e){for(var t=0,a=e.length-1;a>t;t++)if(e.indexOf(e[t],t+1)>-1)return!0;return!1}if(e.viewData.urlFields.length>0&&void 0==e.viewData.urlFields[0])return void o("请先添加提取来源字段");var r=e.viewData.urlFields.map(function(e){return e.fid});return 0===r.length?void o("请先添加网址字段"):a(r)?void o("字段重复"):(d.pageLoading=!0,e.previewDone=!1,b(e.tbId,r).then(function(a){e.previewDone=!0;var r=!0;e.viewData.urlExtractData&&angular.forEach(a,function(e){e.keys.length>0&&(r=!1)}),r?e.viewData.urlPreviewData=_(a):(e.viewData.originalData=a,e.beforeExtractData.fields=p(a),e.viewData.urlExtractData=angular.copy(e.beforeExtractData)),e.viewData.needPreview=!1,d.pageLoading=!1,r||t.open({templateUrl:"/static/js/worktable/parse/select_parse_param.html",className:"ngdialog-theme-default select-parse-param",scope:e})},function(){d.pageLoading=!1}))},e.current_select_fields=[],e.selectAll=function(t){e.viewData.urlExtractData.select_all=t,e.viewData.urlExtractData.check_num=t?e.viewData.urlExtractData.total_num:0,angular.forEach(e.viewData.urlExtractData.fields,function(e){angular.forEach(e.keys,function(e){e.check=t})}),e.current_select_fields=angular.copy(e.viewData.urlExtractData)},e.changeKeyCheck=function(t){var a=0;angular.forEach(e.viewData.urlExtractData.fields,function(e){angular.forEach(e.keys,function(e){e.check&&a++})}),e.viewData.urlExtractData.check_num=a,a==e.viewData.urlExtractData.total_num&&(e.viewData.urlExtractData.select_all=!0),t||(e.viewData.urlExtractData.select_all=!1),e.current_select_fields=angular.copy(e.viewData.urlExtractData)};var F="";e.$watch("viewData.query_param",function(e){clearTimeout(F),F=setTimeout(g(e),1e3)}),e.filterPreviewData=function(){if(0==e.viewData.urlExtractData.check_num)return void o("请选择需要解析的参数");var a={},r=angular.copy(e.viewData.originalData),i=e.viewData.urlExtractData.fields,n={},l={},s=[];angular.forEach(i,function(e){var t=e.original_field_id,i={};s=[],n=r[t].keys,l=r[t].data,a[t]={odata:r[t].odata,keys:[],data:[]};for(var o=0,d=e.keys.length;d>o;o++)if(i=e.keys[o],i.check)for(var c=0,u=n.length;u>c;c++)i.name==n[c]&&(s.push(c),a[t].keys.push(i.name.toString()));angular.forEach(l,function(e,r){a[t].data.push([]);for(var i=0,o=s.length;o>i;i++)a[t].data[r].push(e[s[i]])})}),e.viewData.urlPreviewData=_(a),t.closeAll()},e.clearPreviewData=function(){e.viewData.urlPreviewData=null,setTimeout(function(){e.fixTop()},0)},e.fixTop=function(){$(".preview-pane").css({top:$(".action-pane").outerHeight()+56+"px"})},e.mergeFields=function(){if(e.viewData.needPreview)return void o(e.viewData.urlFields&&e.viewData.urlFields.length>0?"请先点击“提取”，进行数据预览":"请先添加提取来源字段");var t={originFields:{list:angular.copy(e.viewData.schema),name:T.originField},parseFields:{list:angular.copy(v(e.viewData.urlPreviewData.header)),name:T.queryField}};angular.forEach(t,function(e,t){var a="parseFields"===t&&e.list.length<50;angular.forEach(e.list,function(e){e.check=a})}),e.action="merge_field",e.title=T.mergeField,e.mergeFieldSchema=t,setTimeout(function(){i.$getByHandle(e.delegateKey).showSelectFieldsDialog()},200)},e.delegateKey="parse_url",e.save=function(){var t=i.$getByHandle(e.delegateKey).readyToSave();if(t){var a=i.$getByHandle(e.delegateKey).getMergeModel(),r=y(a);if(r)return o("归并字段名不能为空，请填写字段名"),!1;var n=w(a,e.viewData.string_schema);if(n)return void o('字段名"'+n+'"与工作表初始字段重复');d.pageLoading=!0,D(e.tbId,a).then(function(e){d.pageLoading=!1,e&&l.path(d.wsId?"/data_source/"+d.wsId:"/data_source")})}else o("请先预览归并数据")},e.back=function(){"merge_field"==e.action?(e.action="parse_url",e.title=T.parseUrl,setTimeout(function(){e.fixTop()},0)):l.path(d.wsId?"/data_source/"+d.wsId:"/data_source")},h(e.tbId).then(function(t){0==t.status&&(e.viewData.schema=t.result.schema.filter(function(e){return 0===e.is_build_aggregated}),e.viewData.string_schema=t.result.schema.filter(function(e){return"string"===e.data_type&&0===e.is_build_aggregated}))})}])}(),!function(){function e(e){function t(){return!0}if(e.indexOf("$getByHandle")>-1)throw new Error("Method '$getByHandle' is implicitly added to each delegate service. Do not list it as a method.");return["$log",function(a){function r(e,t){this._instances=e,this.handle=t}function i(){this._instances=[]}function o(e){return function(){var t,r=this.handle,i=arguments,o=0;return this._instances.forEach(function(a){if((!r||r==a.$$delegateHandle)&&a.$$filterFn(a)){o++;var n=a[e].apply(a,i);1===o&&(t=n)}}),!o&&r?a.warn('Delegate for handle "'+r+'" could not find a corresponding element with delegate-handle="'+r+'"! '+e+"() was not called!\nPossible cause: If you are calling "+e+'() immediately, and your element with delegate-handle="'+r+'" is a child of your controller, then your element may not be compiled yet. Put a $timeout around your call to '+e+"() and try again."):t}}return e.forEach(function(e){r.prototype[e]=o(e)}),i.prototype=r.prototype,i.prototype._registerInstance=function(e,a,r){var i=this._instances;return e.$$delegateHandle=a,e.$$filterFn=r||t,i.push(e),function(){var t=i.indexOf(e);-1!==t&&i.splice(t,1)}},i.prototype.$getByHandle=function(e){return new r(this._instances,e)},new i}]}angular.module("BC.controllers.dataSource").controller("mergeFieldCtrl",["$scope","commonService","errHint","$stateParams","mergeFieldDelegate","$location","dataTypeMap","$rootScope",function(e,t,a,r,i,o,n,l){function s(e){var t={};return angular.forEach(e,function(e){var a=e.data_type;t[a]?t[a].list.push(e):t[a]={name:n[a],list:[e]}}),t}function d(e){return t.tb.getInfo(e)}function c(e,t){for(var a=t.map(function(e){return 0===e.is_build_aggregated?e.name:""}),r=0,i=e.length;i>r;r++)if(a.indexOf(e[r].title)>=0)return e[r].title;return!1}function u(e){var t=!1;return angular.forEach(e,function(e){""==e.title&&(t=!0)}),t}function f(e,a){return t.field.merge(e,a)}l.show_bdp_header=!1,e.tbId=r.tbId,e.viewData={},e.delegateKey="merge_field",e.save=function(){var t=i.$getByHandle(e.delegate).readyToSave();if(t){var r=i.$getByHandle(e.delegate).getMergeModel(),n=u(r);if(n)return a("归并字段名不能为空，请填写字段名"),!1;var s=c(r,e.viewData.schema);if(s)return void a('字段名"'+s+'"与工作表初始字段重复');l.pageLoading=!0,f(e.tbId,r).then(function(e){e&&o.path(l.wsId?"/data_source/"+l.wsId:"/data_source"),l.pageLoading=!1})}else a("请先完成字段归并")},e.back=function(){o.path(l.wsId?"/data_source/"+l.wsId:"/data_source")},d(e.tbId).then(function(t){0==t.status&&(e.viewData.schema=t.result.schema.filter(function(e){return 0===e.is_build_aggregated}),e.mergeFieldSchema=s(e.viewData.schema),i.$getByHandle(e.delegateKey).showSelectFieldsDialog())})}]).factory("mergeFieldDelegate",e(["showSelectFieldsDialog","readyToSave","getMergeModel"])).directive("mergeField",["mergeFieldDelegate",function(e){return{templateUrl:"/static/js/worktable/parse/merge_field_directive.html",scope:!0,link:function(t,a,r){if(r.delegateKey){var i=e._registerInstance(t,r.delegateKey);t.$on("$destroy",function(){i()})}},controller:["$scope","ngDialog","errHint","commonService",function(e,t,a,r){function i(t,a){var r,i,o;
if(e.columns&&e.columns.length){r=a;for(var n=[],l=[],s=t.map(function(e){return e.fid}),d=a.length;d--;){var c=a[d];for(o=c.length;o--;){var u=c[o];l.push(u.fid),s.indexOf(u.fid)<0&&c.splice(o,1)}0===c.length&&a.splice(d,1)}angular.forEach(t,function(e){l.indexOf(e.fid)<0&&n.push([e])}),n.push([]),r=r.concat(n)}else for(r=[],i=0,o=t.length;o>i;i++)r.push([t[i]]);return r}function o(e){var t=[];return angular.forEach(e,function(e){if(defined(e)&&0!==e.length){var a=[],r=e[0].name;angular.forEach(e,function(e){a.push(e.fromFid?{field_id:e.fromFid,key:e.key}:{field_id:e.fid})}),t.push({fields:a,title:r,data_type:e[0].data_type,param:e[0].param})}}),t}function n(t){return r.field.extract_preview(e.tbId,t)}e.selectedFields=e.selectedFields||[],e.needPreview=!0,e.showSelectFieldsDialog=function(){var a=e.selectedFields.map(function(e){return e.fid});t.open({templateUrl:"/static/js/worktable/parse/select_fields_dialog.html",className:"ngdialog-theme-default",scope:e,data:{schema:e.mergeFieldSchema,selectedFids:a},controller:["$scope","errHint",function(e,t){function a(t,a){return angular.forEach(t,function(e){angular.forEach(e.list,function(e){"undefined"==typeof e.check&&(e.check=a.indexOf(e.fid)>-1)})}),e.ngDialogData.schema}function r(e){var t=[];for(var a in e)e.hasOwnProperty(a)&&angular.forEach(e[a].list,function(e){e.check&&t.push(e)});return t}e.fields=a(e.ngDialogData.schema,e.ngDialogData.selectedFids),e.confirm=function(){var a=r(e.fields);return 0===a.length?(t("没有选中的字段"),!1):(e.selectFieldCallback&&e.selectFieldCallback(a),void e.closeThisDialog())}}]})},e.selectFieldCallback=function(t){t.length&&(e.selectedFields=t,e.columns=i(t,e.columns)),e.needPreview=!0,e.clearPreviewData()},e.sortColumn={connectWith:".merge-column",receive:function(){},stop:function(){e.needPreview=!0,e.clearPreviewData();for(var t=e.columns.length;t--;)0===e.columns[t].length&&e.columns.splice(t,1);e.columns.push([])}},e.previewMergeField=function(){var t=o(e.columns);return $.isEmptyObject(t)?void a("没有选中的字段"):void n(t).then(function(t){e.previewData=t,e.previewData.schema=bdp.utils.addSpecParamsToFields(e.previewData.schema),e.needPreview=!1})},e.clearPreviewData=function(){e.previewData=null,setTimeout(function(){e.fixTop()},0)},e.fixTop=function(){$(".merge-field-preview").css({top:$(".merge-field-action").outerHeight()+56+"px"})},e.readyToSave=function(){return!e.needPreview},e.getMergeModel=function(){var t=[],a=e.previewData.schema,r=e.mergeFieldSchema.parseFields;if(r&&r.list){angular.forEach(e.columns,function(e){angular.forEach(e,function(e){t.push(e.fid)})});var i=[];angular.forEach(r.list,function(e){e.check||i.push({title:e.name,data_type:e.data_type,fields:[{field_id:e.fromFid,key:e.key}]})}),a=a.concat(i)}return a}}]}}])}(),!function(){function e(e,t,a,r,i,o){function n(e,t){return e.toLowerCase().indexOf(t.toLowerCase())>=0}function l(){e.chooseTbFolderData.folderQueryList=[];var t=e.chooseTbFolderData.queryText,a={};t?angular.forEach(e.chooseTbFolderData.folderList,function(r){a={name:r.name,folder_id:r.folder_id,sub_folders:[],open:!1},r.sub_folders&&r.sub_folders.length>0&&angular.forEach(r.sub_folders,function(e){n(e.name,t)&&a.sub_folders.push({name:e.name,folder_id:e.folder_id,open:!1})}),a.open=a.sub_folders.length>0,(n(a.name,t)||a.open)&&e.chooseTbFolderData.folderQueryList.push(a)}):e.chooseTbFolderData.folderQueryList=[]}function s(t,a){function r(e){for(var r=0,i=e.length;i>r;r++)if(e[r].folder_id!=a&&e[r].name==t){o=!1;break}}var i=e.chooseTbFolderData.folderList,o=!0;return r(i),o}e.chooseTbFolderData=null,e.initData=function(){e.chooseTbFolderData={tbInfo:e.ngDialogData.tbInfo||null,tbType:e.ngDialogData.tbType,optType:e.ngDialogData.optType||"baseChoose",folderList:e.ngDialogData.folderList||[],folderQueryList:[],originalTargetFolderId:e.ngDialogData.targetFolderId||"folder_root",targetFolderId:e.ngDialogData.targetFolderId||"folder_root",targetFolderType:e.ngDialogData.targetFolderType||"top",queryText:"",open:{},isCreating:!1},e.confirmSave=e.ngDialogData.confirmSave,angular.forEach(e.chooseTbFolderData.folderList,function(t){e.chooseTbFolderData.open[t.folder_id]=!1,t.isNew=!1,t.sub_folders&&t.sub_folders.length>0&&angular.forEach(t.sub_folders,function(t){e.chooseTbFolderData.open[t.folder_id]=!1,t.isNew=!1})})},e.initData();var d;e.folderQueryKeyUp=function(){e.chooseTbFolderData.isCreating&&e.cancelCreateFolder(),clearTimeout(d),d=setTimeout(l(),100)},e.toggleChooseFolder=function(t,a){return t&&t.stopPropagation(),e.chooseTbFolderData.isCreating?void r(e.tips["wb.saveNewFolderFirst"]):void(e.chooseTbFolderData.open[a]=!e.chooseTbFolderData.open[a])},e.setTargetFolder=function(t,a){return e.chooseTbFolderData.isCreating?void r(e.tips["wb.saveNewFolderFirst"]):(e.chooseTbFolderData.targetFolderId=t,void(e.chooseTbFolderData.targetFolderType=a))},e.confirmChooseFolder=function(){if(e.chooseTbFolderData.isCreating)return void r(e.tips["wb.saveNewFolderFirst"]);var t={targetFolderId:e.chooseTbFolderData.targetFolderId},a=["move","copy","move_folder"];a.indexOf(e.chooseTbFolderData.optType)>=0&&(e.$emit("needReloadFolderListFlag",{flag:!1,targetFolderId:e.chooseTbFolderData.targetFolderId}),t.tbInfo=e.chooseTbFolderData.tbInfo),"move_folder"==e.chooseTbFolderData.optType&&(t.targetFolderType=e.chooseTbFolderData.targetFolderType),e.confirmSave(t)},e.createNewFolder=function(){if(e.chooseTbFolderData.isCreating)return void r(e.tips["wb.saveNewFolderFirst"]);e.chooseTbFolderData.queryText&&(e.chooseTbFolderData.queryText="",e.chooseTbFolderData.folderQueryList=[]),e.chooseTbFolderData.targetFolderId="new_"+(new Date).getTime();var t=e.chooseTbFolderData.folderList.length,a=angular.copy(e.chooseTbFolderData.folderList[t-1]);e.chooseTbFolderData.folderList[t-1]={folder_id:e.chooseTbFolderData.targetFolderId,name:"",isNew:!0},e.chooseTbFolderData.folderList.push(a),e.chooseTbFolderData.isCreating=!0,i(function(){$(".create-new-folder input").focus(),scrollToBottom($(".choose-folder .folder-list"),"",$(".choose-folder .folder-list > ul").height())},10)},e.okCreateFolder=function(a,i){if(!a)return void r(e.tips["wb.inputFolderName"]);if(!s(a,i))return void r(e.tips["wb.repeatFolderName"]);var o={parent_id:"folder_root",name:a};e.requestDone=!1,t.folder.create(o).then(function(t){if(e.requestDone=!0,0==Number(t.status)){r(e.tips["wb.createSuccess"]);for(var a=e.chooseTbFolderData.folderList,i=a.length,o=i-1;o>=0;o--)a[o].folder_id==e.chooseTbFolderData.targetFolderId&&(a[o].isNew=!1,a[o].folder_id=t.result.folder,e.chooseTbFolderData.targetFolderId=t.result.folder);e.chooseTbFolderData.isCreating=!1;var n=["move","copy","move_folder"];n.indexOf(e.chooseTbFolderData.optType)>=0&&e.$emit("needReloadFolderListFlag",{flag:!0,targetFolderId:t.result.folder}),e.getFolderStructure({get_first:0,get_root:1,tb_list:[e.selected.tb_id]})}else r(11==Number(t.status)||25001==Number(t.status)?e.tips["wb.repeatFolderName"]:e.tips["wb.createFailed"])})},e.cancelCreateFolder=function(){var t=e.chooseTbFolderData.folderList.length;e.chooseTbFolderData.isCreating&&(e.chooseTbFolderData.folderList.splice(t-2,1),e.chooseTbFolderData.isCreating=!1,e.chooseTbFolderData.targetFolderId=e.chooseTbFolderData.originalTargetFolderId)},o(["wb.newFolder","wb.saveNewFolderFirst","wb.inputFolderName","wb.repeatFolderName","wb.createSuccess","wb.repeatFolderName","wb.createFailed"],e)}angular.module("BC.controllers.dataSource").controller("chooseTbFolderCtrl",e),e.$inject=["$scope","commonService","ngDialog","errHint","$timeout","$jsTipTranslate"]}(),!function(){function e(e,t,a,r,i,o,n){function l(e,a){function r(t){for(var r=0,i=t.length;i>r;r++)if(t[r].folder_id!=a&&t[r].name==e){o=!1;break}}var i=t.batchMoveList,o=!0;return r(i),o}t.isSelectingTables=!0,t.batchMoveList=t.ngDialogData.batchMoveList,t.selectedBatchTables=[],t.selectedBatchFolder="",t.currentFolderIndex=0,t.currentSubFolderIndex=void 0,t.currentFolder=t.batchMoveList[t.currentFolderIndex].sub_folders,t.currentList=t.batchMoveList[t.currentFolderIndex].tb_list,t.isCreatingFolder=!1,t.newFolderId="",t.changeQueryFromFolderState=function(e){o.cancel(a);var a=o(function(){var a=e.queryFromFolder;if(a){t.fromResultFiltered=!0,angular.forEach(t.batchMoveList,function(e){e.hide=!e.name.match(a),e.hide?(angular.forEach(e.tb_list,function(t){t.name.match(a)?(t.hide=!1,e.hide=!1):t.hide=!0}),angular.forEach(e.sub_folders,function(t){t.name.match(a)?(t.hide=!1,e.hide=!1):t.hide=!0,t.hide?angular.forEach(t.tb_list,function(r){r.name.match(a)?(r.hide=!1,t.hide=!1,e.hide=!1):r.hide=!0}):angular.forEach(t.tb_list,function(e){e.hide=!1})})):(angular.forEach(e.tb_list,function(e){e.hide=!1}),angular.forEach(e.sub_folders,function(e){e.hide=!1,angular.forEach(e.tb_list,function(e){e.hide=!1})}))});for(var r=0,i=t.batchMoveList.length;i>r;r++)if(0==t.batchMoveList[r].hide){t.currentFolderIndex=r,t.currentSubFolderIndex=void 0,t.checkFolder(t.batchMoveList[r],r);break}}else t.fromResultFiltered=!1,angular.forEach(t.batchMoveList,function(e){e.hide=!1,angular.forEach(e.sub_folders,function(e){e.hide=!1,angular.forEach(e.tb_list,function(e){e.hide=!1})}),angular.forEach(e.tb_list,function(e){e.hide=!1})}),t.currentFolderIndex=0,t.currentSubFolderIndex=void 0,t.currentFolder=t.batchMoveList[t.currentFolderIndex].sub_folders,t.currentList=t.batchMoveList[t.currentFolderIndex].tb_list},100)},t.changeQueryToFolderState=function(e){t.isCreatingFolder&&t.cancelCreateFolderForBatchMove(),o.cancel(a);var a=o(function(){var a=e.queryToFolder;if(a){t.toResultFiltered=!0,angular.forEach(t.batchMoveList,function(e){e.hideDir=!e.name.match(a),e.hideDir?angular.forEach(e.sub_folders,function(t){t.name.match(a)?(t.hideDir=!1,e.hideDir=!1):t.hideDir=!0}):angular.forEach(e.sub_folders,function(e){e.hideDir=!1})});for(var r=0,i=t.batchMoveList.length;i>r;r++)if(0==t.batchMoveList[r].hideDir){t.currentFolderIndex=r,t.currentSubFolderIndex=void 0,t.checkFolder(t.batchMoveList[r],r);break}}else t.toResultFiltered=!1,t.currentFolderIndex=0,t.currentSubFolderIndex=void 0,angular.forEach(t.batchMoveList,function(e){e.hideDir=!1,angular.forEach(e.sub_folders,function(e){e.hideDir=!1})})},100)},t.checkFolder=function(e,a){return t.isCreatingFolder?void i(t.tips["wb.saveNewFolderFirst"]):(t.currentFolder=e.sub_folders,t.currentFolderIndex=a,t.currentList=e.tb_list,void(t.currentSubFolderIndex=void 0))},t.checkSubFolder=function(e,a,r){return t.isCreatingFolder?void i(t.tips["wb.saveNewFolderFirst"]):(t.currentFolder=[],t.currentFolderIndex=r,t.currentList=e.tb_list,void(t.currentSubFolderIndex=a))},t.chooseTargetFolder=function(e){return t.isCreatingFolder?void i(t.tips["wb.saveNewFolderFirst"]):void(t.selectedBatchFolder=e)},t.moveTablesPrevStep=function(){t.isCreatingFolder&&t.cancelCreateFolderForBatchMove(),t.isSelectingTables=!0,t.currentFolderIndex=0,t.currentSubFolderIndex=void 0,t.fromResultFiltered=!1,angular.element(".ngdialog-move-tables").removeClass("ngdialog-width-348").addClass("ngdialog-width-818")},t.moveTablesNextStep=function(){return t.toResultFiltered=!1,angular.forEach(t.batchMoveList,function(e){angular.forEach(e.sub_folders,function(e){angular.forEach(e.tb_list,function(e){if(e.checked){var a={tb_index:0,tb_id:e.tb_id};t.selectedBatchTables.push(a)}})}),angular.forEach(e.tb_list,function(e){if(e.checked){var a={tb_index:0,tb_id:e.tb_id};t.selectedBatchTables.push(a)}})}),0==t.selectedBatchTables.length?(i(t.tips["wb.chooseFromWorktable"]),!1):(t.isSelectingTables=!1,t.currentFolderIndex=void 0,t.currentSubFolderIndex=void 0,void angular.element(".ngdialog-move-tables").removeClass("ngdialog-width-818").addClass("ngdialog-width-348"))},t.createFolderForBatchMove=function(){if(t.isCreatingFolder)return void i(t.tips["wb.saveNewFolderFirst"]);t.queryToFolder&&(t.queryToFolder="",t.changeQueryToFolderState({queryToFolder:""})),t.newFolderId="new_"+(new Date).getTime();var e=t.batchMoveList.length,a=angular.copy(t.batchMoveList[e-1]);t.batchMoveList[e-1]={folder_id:t.newFolderId,name:"",isNew:!0},t.batchMoveList.push(a),t.isCreatingFolder=!0,o(function(){t.currentFolderIndex=t.batchMoveList.length-2,t.currentSubFolderIndex=void 0,$(".create-new-folder input").focus(),scrollToBottom($(".ngdialog-move-tables .directory-list"))},200)},t.okCreateFolderForBatchMove=function(e,r){if(!e)return void i(t.tips["wb.inputFolderName"]);if(!l(e,r))return void i(t.tips["wb.repeatFolderName"]);var o={parent_id:"folder_root",name:e};t.requestDone=!1,a.folder.create(o).then(function(e){if(t.requestDone=!0,0==Number(e.status)){i(t.tips["wb.createSuccess"]);for(var a=t.batchMoveList,r=a.length,o=r-1;o>=0;o--)a[o].folder_id==t.newFolderId&&(a[o].isNew=!1,a[o].folder_id=e.result.folder,t.selectedBatchFolder=e.result.folder);t.isCreatingFolder=!1,t.$emit("needReloadFolderListFlag",{flag:!0,targetFolderId:""}),t.getFolderStructure({get_first:0,get_root:1,tb_list:[t.selected.tb_id]})}else i(11==Number(e.status)||25001==Number(e.status)?t.tips["wb.repeatFolderName"]:t.tips["wb.createFailed"])})},t.cancelCreateFolderForBatchMove=function(){var e=t.batchMoveList.length;t.isCreatingFolder&&(t.batchMoveList.splice(e-2,1),t.isCreatingFolder=!1,t.newFolderId="",t.currentFolderIndex=void 0,t.currentSubFolderIndex=void 0)},t.saveBatchMove=function(){if(!t.selectedBatchFolder)return i(t.tips["wb.chooseToDirectory"]),!1;var o={change_folders:JSON.stringify(t.selectedBatchTables),to_folder:t.selectedBatchFolder,ws_id:e.wsId};t.$emit("needReloadFolderListFlag",{flag:!1,targetFolderId:""}),a.tb.batchMove(o).then(function(e){0==e.status&&(i(t.tips["wb.batchMoveSuccess"]),t.getFolderStructure({get_first:0,get_root:1,tb_list:[o.to_folder]}),t.getFolderList(),r.close())})},n(["wb.chooseFromWorktable","wb.saveNewFolderFirst","wb.newFolder","wb.chooseToDirectory","wb.batchMoveSuccess","wb.inputFolderName","wb.repeatFolderName","wb.createSuccess","wb.createFailed"],t)}angular.module("BC.controllers.dataSource").controller("batchMoveTablesCtrl",e),e.$inject=["$rootScope","$scope","commonService","ngDialog","errHint","$timeout","$jsTipTranslate"]}(),!function(){function e(e,t,a,r,i,o,n){t.isSelectingTables=!0,t.isCheckSelectedTables=!1,t.isCheckCodeTables=!1,t.batchDeleteList=t.ngDialogData.batchDeleteList,t.selectedBatchTables=[],t.currentFolderIndex=0,t.currentSubFolderIndex=void 0,t.currentFolder=t.batchDeleteList[t.currentFolderIndex].sub_folders,t.currentList=t.batchDeleteList[t.currentFolderIndex].tb_list,t.batchDeleteListRely=[],t.currentFolderIndexRely=0,t.currentSubFolderIndexRely=void 0,t.currentFolderRely=[],t.currentListRely=[],t.delCheckCode="",t.relyMapTip=null,t.checkCodePageLoading=!1,t.changeQueryFromFolderState=function(e){o.cancel(a);var a=o(function(){var a=e.queryFromFolder;if(a){t.fromResultFiltered=!0,angular.forEach(t.batchDeleteList,function(e){e.hide=!e.name.match(a),e.hide?(angular.forEach(e.tb_list,function(t){t.name.match(a)?(t.hide=!1,e.hide=!1):t.hide=!0}),angular.forEach(e.sub_folders,function(t){t.name.match(a)?(t.hide=!1,e.hide=!1):t.hide=!0,t.hide?angular.forEach(t.tb_list,function(r){r.name.match(a)?(r.hide=!1,t.hide=!1,e.hide=!1):r.hide=!0}):angular.forEach(t.tb_list,function(e){e.hide=!1})})):(angular.forEach(e.tb_list,function(e){e.hide=!1}),angular.forEach(e.sub_folders,function(e){e.hide=!1,angular.forEach(e.tb_list,function(e){e.hide=!1})}))});for(var r=0,i=t.batchDeleteList.length;i>r;r++)if(0==t.batchDeleteList[r].hide){t.currentFolderIndex=r,t.currentSubFolderIndex=void 0,t.checkFolder(t.batchDeleteList[r],r);break}}else t.fromResultFiltered=!1,angular.forEach(t.batchDeleteList,function(e){e.hide=!1,angular.forEach(e.sub_folders,function(e){e.hide=!1,angular.forEach(e.tb_list,function(e){e.hide=!1})}),angular.forEach(e.tb_list,function(e){e.hide=!1})}),t.currentFolderIndex=0,t.currentSubFolderIndex=void 0,t.currentFolder=t.batchDeleteList[t.currentFolderIndex].sub_folders,t.currentList=t.batchDeleteList[t.currentFolderIndex].tb_list},100)},t.checkFolder=function(e,a){t.currentFolder=e.sub_folders,t.currentFolderIndex=a,t.currentList=e.tb_list,t.currentSubFolderIndex=void 0},t.checkSubFolder=function(e,a,r){t.currentFolder=[],t.currentFolderIndex=r,t.currentList=e.tb_list,t.currentSubFolderIndex=a},t.checkFolderRely=function(e,a){t.currentFolderRely=e.sub_folders,t.currentFolderIndexRely=a,t.currentListRely=e.tb_list,t.currentSubFolderIndexRely=void 0},t.checkSubFolderRely=function(e,a,r){t.currentFolderRely=[],t.currentFolderIndexRely=r,t.currentListRely=e.tb_list,t.currentSubFolderIndexRely=a},t.deleteTablesSelectingTablesStep=function(){t.setStepDisplay(1),angular.element(".ngdialog-move-tables").removeClass("ngDialog-width-320").addClass("ngdialog-width-818")},t.deleteTablesCheckSelectedStep=function(){return t.selectedBatchTables=[],t.toResultFiltered=!1,t.currentFolderIndexRely=0,t.currentSubFolderIndexRely=void 0,angular.forEach(t.batchDeleteList,function(e){angular.forEach(e.sub_folders,function(e){angular.forEach(e.tb_list,function(e){e.checked&&t.selectedBatchTables.push(e.tb_id)})}),angular.forEach(e.tb_list,function(e){e.checked&&t.selectedBatchTables.push(e.tb_id)})}),0==t.selectedBatchTables.length?(i(t.tips["wb.chooseDeleteWorktable"]),!1):void t.checkWorktableRely()},t.checkWorktableRely=function(){t.checkCodePageLoading=!0;var r={tb_list:JSON.stringify(t.selectedBatchTables),ws_id:e.wsId};a.tb.checkTablesRely(r).then(function(e){0==e.status&&(e.result.length>0?(t.setStepDisplay(2),t.batchDeleteListRely=e.result,t.setCheckDeleteListRely(),t.currentFolderRely=t.batchDeleteListRely[t.currentFolderIndexRely].sub_folders,t.currentListRely=t.batchDeleteListRely[t.currentFolderIndexRely].tb_list,t.currentListRely.length<=0&&(t.currentSubFolderIndexRely=0,t.currentListRely=t.currentFolderRely[t.currentSubFolderIndexRely].tb_list)):t.deleteTablesCheckCodeStep()),t.checkCodePageLoading=!1})},t.changeRelyChecked=function(e){angular.forEach(t.batchDeleteList,function(t){angular.forEach(t.sub_folders,function(t){angular.forEach(t.tb_list,function(t){t.tb_id==e.tb_id&&(t.checked=e.checked)})}),angular.forEach(t.tb_list,function(t){t.tb_id==e.tb_id&&(t.checked=e.checked)})})},t.setCheckDeleteListRely=function(){angular.forEach(t.batchDeleteListRely,function(e){angular.forEach(e.tb_list,function(e){e.checked=!0}),angular.forEach(e.sub_folders,function(e){angular.forEach(e.tb_list,function(e){e.checked=!0})})})},t.excludeDeleteList=function(){var e=[],a=[],r=!0;angular.forEach(t.batchDeleteListRely,function(t){angular.forEach(t.sub_folders,function(t){angular.forEach(t.tb_list,function(t){t.checked&&2!=t.rely_type||e.push(t.tb_id)})}),angular.forEach(t.tb_list,function(t){t.checked&&2!=t.rely_type||e.push(t.tb_id)})});for(var i=0,o=t.selectedBatchTables.length;o>i;i++){r=!0;for(var n=0,l=e.length;l>n;n++)e[n]==t.selectedBatchTables[i]&&(r=!1);r&&a.push(t.selectedBatchTables[i])}t.selectedBatchTables=a},t.deleteTablesCheckCodeStep=function(){t.excludeDeleteList(),t.selectedBatchTables.length>0?(t.setStepDisplay(3),angular.element(".ngdialog-move-tables").removeClass("ngdialog-width-818").addClass("ngDialog-width-320"),t.toggleImg()):i(t.tips["wb.deleteTablesNone"])},t.saveBatchDelete=function(){if(t.checkedCode()){var o={tb_list:JSON.stringify(t.selectedBatchTables),ws_id:e.wsId,session_id:t.sessionId,verify_code:t.delCheckCode};t.$emit("needReloadFolderListFlag",{flag:!1,targetFolderId:""}),t.checkCodePageLoading=!0,a.tb.batchDeleteTables(o).then(function(e){if(0==e.status){i(t.tips["wb.batchDeleteSuccess"]);var a={get_first:0,get_root:1,tb_list:[]};t.selected.tb_id&&a.tb_list.push(t.selected.tb_id),t.getFolderStructure(a),t.getFolderList(),r.close()}else 23002==e.status&&i(t.tips["error.codeError"]),t.toggleImg();t.checkCodePageLoading=!1})}},t.setStepDisplay=function(e){switch(e){case 1:t.isSelectingTables=!0,t.isCheckSelectedTables=!1,t.isCheckCodeTables=!1;break;case 2:t.relyMapTip||(t.relyMapTip={1:t.tips["wb.tableRelyWarning"],2:t.tips["wb.tableRelyError"]}),t.isSelectingTables=!1,t.isCheckSelectedTables=!0,t.isCheckCodeTables=!1;break;case 3:t.isSelectingTables=!1,t.isCheckSelectedTables=!1,t.isCheckCodeTables=!0}},t.checkedCode=function(){var e=!0;return 4!=t.delCheckCode.length&&(t.errorCodeMsg=t.tips["error.codeError"],e=!1),e},t.toggleImg=function(){var e=(new Date).getTime();t.sessionId=e+parseInt(1e4*Math.random()),t.url="/api/register/pic?session_id="+t.sessionId+"&t="+e},n(["wb.chooseDeleteWorktable","error.codeError","wb.batchDeleteSuccess","wb.tableRelyError","wb.tableRelyWarning","error.codeError","wb.deleteTablesNone"],t)}angular.module("BC.controllers.dataSource").controller("batchDeleteTablesCtrl",e),e.$inject=["$rootScope","$scope","commonService","ngDialog","errHint","$timeout","$jsTipTranslate"]}(),!function(){function e(e,t,a,r,i,o,n,l,s){function d(e){g(0,e,t.capacityData.queryData.text)}function c(){g(0,t.capacityData.queryData.account,t.capacityData.queryData.text)}function u(e){13==e.keyCode&&g(0,t.capacityData.queryData.account,t.capacityData.queryData.text)}function f(e){g(e-1,t.capacityData.queryData.account,t.capacityData.queryData.text)}function p(){t.isGettingAccount=!0,r.get("/api/sub/list").then(function(e){if(t.isGettingAccount=!1,0==e.status){var a=[{name:t.tips["wb.tableCapacity.all"],userid:"default_all_id"},{name:_,userid:$.cookie("user_id")}];t.capacityData.accountList=a.concat(e.result),t.capacityData.queryData.account=$.cookie("user_id")}else o(+e.status,{warn_msg:e.errstr})})}function g(e,a,i){var n="default_all_id"==a?1:0;a="default_all_id"==a?"":a,t.isGettingCapacity=!0;var l={page:e,sub_id:a||"",keyword:i||"",show_all:n};r.post("/api/tb/list_info",l).then(function(e){t.isGettingCapacity=!1,0==e.status?(t.capacityData.tableList=e.result.tb_list||[],t.capacityData.page.total=Math.ceil(e.result.count/50),t.capacityData.page.cur=e.result.page+1,t.capacityData.summary.base=e.result.stat.base,t.capacityData.summary.combined=e.result.stat.view,t.capacityData.summary.total=e.result.stat.total):o(+e.status,{warn_msg:e.errstr})})}function h(e){localStorage.setItem("jumpToRelationMap",e),b()}function b(){l.path(e.wsId?"/data_source/"+e.wsId:"/data_source")}var _="";e.view="tableCapacity",e.show_bdp_header=!1,t.isGettingCapacity=!1,t.isGettingTable=!1,t.isGettingAccount=!1;var m=t.$watch(function(){return e.userInfoObj},function(e){isObjectEmpty(e)||(t.capacityData.isSuperAdmin=0==e.role,t.capacityData.isSuperAdmin&&(_=e.contact,p()),m())});t.initData=function(){t.capacityData={summary:{total:0,base:0,combined:0},queryData:{text:"",account:null},page:{cur:0,total:0},accountList:[],tableList:[],showAccountType:!1,isSuperAdmin:!1,back:b,selectAccount:d,keyUpSearch:u,clickSearch:c,changePage:f,jumpToRelationMap:h},g(0,"","")},t.initData(),s(["wb.newFolder","wb.saveNewFolderFirst","wb.inputFolderName","wb.repeatFolderName","wb.createSuccess","wb.repeatFolderName","wb.createFailed","wb.tableCapacity.all","wb.tableCapacity.superAdmin"],t)}angular.module("BC.controllers.dataSource").controller("tableCapacityCtrl",e),e.$inject=["$rootScope","$scope","commonService","commonHttp","ngDialog","errHint","$timeout","$location","$jsTipTranslate"]}(),angular.module("BC.directives").directive("setUp",["$timeout","$rootScope",function(e,t){return{restrict:"A",scope:{onCommit:"&",editTable:"=",assignTableTo:"&",deleteTb:"&",moveTb:"=",folderId:"=",copyTb:"=",showTb:"="},templateUrl:"/static/partials/table_set_up.html",link:function(a,r,i){function o(){var e=a.onCommit({text:a.tbName.newText});e&&(a.text=e),a.editting=!1}a.tb=angular.fromJson(i.tbData),a.tbName={},a.tbName.newText=a.text=a.tb.name,a.opt_list=!1,a.ds_over_one=!1,a.view=i.view;var n=a.tb;a.canCopyTb="self"==n.tb_type&&("join"==n.type||"aggr"==n.type||"script"==n.type||"union"==n.type),a.canEdit="self"==n.tb_type&&"allot"!=n.type,a.canDelete="allot"!=n.type||t.wsId,a.canMove="folderList"==a.view||"folder_root"==a.folderId,a.canAssign=!t.permision.isPersonal&&!t.permision.isNormalUser&&!t.wsId,a.tabOpt=function(t,i){a.opt_list=!a.opt_list,e(function(){var e=$(r).find(".opt_list"),t=$(i.target).offset(),o=$(window).height(),n=t.top+15,l=t.left-50,s=0;s=a.canEdit&&a.canCopyTb&&a.canDelete?140:a.canEdit&&!a.canCopyTb&&a.canDelete?85:a.canEdit||a.canCopyTb||!a.canDelete?30:50,140>o-n&&(n=t.top-s),e.css({top:n,left:l,visibility:"visible"})},0),angular.element(".label-comment-tooltip").css({display:"none"})},a.$watch("opt_list",function(t,r){var i=".J_scroll_folder",o="scroll.wtbfolder";if(t!==r&&1==t){var n=angular.element(i).scrollTop();e(function(){angular.element(i).on(o,function(e){Math.abs(n-$(e.target).scrollTop())>8&&(a.opt_list=!1,a.$digest())})},0)}else t!==r&&0==t&&angular.element(i).off(o)}),a.edit=function(e){a.editTable(e),a.ds_over_one=!1,a.opt_list=!1},t.$watch("global.tbEditting",function(e){void 0!=e&&(e||(a.editting=!1))}),a.inputClick=function(){},a.inputBlur=function(){e(function(){a.editting=!1},500)},a.inputKeyup=function(e){13===e.keyCode&&o()},a.commit=function(){return o(),!1},a.assignTo=function(e){a.opt_list=!1,a.ds_over_one=!1,a.assignTableTo(e)},a.delete=function(){a.opt_list=!1,a.ds_over_one=!1,a.deleteTb()},a.move=function(e){a.moveTb(e),a.ds_over_one=!1,a.opt_list=!1},a.copyTo=function(e){a.copyTb(e),a.ds_over_one=!1,a.opt_list=!1},a.show_table=function(e){var t=1;a.showTb(e,t)},a.$on("folder-drop-fire",function(){a.opt_list=!1,a.ds_over_one=!1})}}}]),angular.module("BC.directives").directive("folderOpt",["$timeout","$rootScope",function(e,t){return{restrict:"A",scope:{onCommit:"&",deleteFolder:"&",stickyFolder:"&",moveFolder:"&",tgFolder:"&",getTable:"&"},templateUrl:"/static/partials/table_folder_opt.html",link:function(a,r,i){function o(){var e=a.onCommit({text:a.folderName.newText});e&&(a.text=e),a.editting=!1}a.editting=!1,a.show_opt_list=!1,a.ds_over_one=!1,a.canEdit=!0,a.canMove=!0,a.canDelete=!0,a.folder=angular.fromJson(i.folderData),a.folderName={},a.folderName.newText=a.text=a.folder.name,a.folderOption=function(t){a.show_opt_list=!a.show_opt_list,e(function(){var e=$(t.target).offset(),i=$(window).height(),o=e.top+15,n=e.left-50,l=0;l=a.canEdit&&a.canCopyTb&&a.canDelete?160:a.canEdit&&!a.canCopyTb&&a.canDelete?130:90,120>i-o&&(o=e.top-l),$(r).find(".opt_list").css({top:o,left:n,visibility:"visible"})},0)},a.$watch("show_opt_list",function(t,r){var i=".J_scroll_folder",o="scroll.wtbfolder";if(t!==r&&1==t){var n=angular.element(i).scrollTop();e(function(){angular.element(i).on(o,function(e){Math.abs(n-$(e.target).scrollTop())>8&&(a.show_opt_list=!1,a.$digest())})},0)}else t!==r&&0==t&&angular.element(i).off(o)}),a.inputClick=function(e){e.stopPropagation()},a.inputBlur=function(){e(function(){a.editting=!1},500)},a.inputKeyup=function(e){13===e.keyCode&&o()},a.edit=function(i){return t.global.tbEditting=!0,a.editting=!0,a.show_opt_list=!1,a.ds_over_one=!1,i.stopPropagation(),a.folderName.newText=a.text,e(function(){r.find("input").select().focus()},0),!1},t.$watch("global.tbEditting",function(e){void 0!=e&&(e||(a.editting=!1))}),a.commit=function(e){return e&&e.stopPropagation(),o(),!1},a.delete=function(e){e&&e.stopPropagation(),a.show_opt_list=!1,a.ds_over_one=!1,a.deleteFolder({folder:a.folder})},a.stick=function(e){e&&e.stopPropagation(),a.show_opt_list=!1,a.ds_over_one=!1,a.stickyFolder({folder_id:a.folder.folder_id}),e.stopPropagation()},a.move=function(e){e&&e.stopPropagation(),a.show_opt_list=!1,a.ds_over_one=!1,a.moveFolder({folder:a.folder}),e.stopPropagation()},a.toggle=function(){a.tgFolder({folder:a.folder})},a.$on("folder-drop-fire",function(){a.show_opt_list=!1,a.ds_over_one=!1})}}}]),angular.module("BC.directives").directive("searchFolderTable",[function(){return{link:function(e,t,a){function r(){var t=e.$eval(a.ngModel);t?e.folderList=i(t,o):(e.folderList=angular.copy(o),e.selected&&e.selected.tb_id&&e.highlightByTableId(e.folderList,e.selected.tb_id)),e.$emit("recoverFolderList",e.folderList),e.$apply()}function i(e,t){function a(t,a){var r=[],i=!1;return t.map(function(t){(t.name.toLowerCase().indexOf(e.toLowerCase())>-1||t.label&&t.label.toLowerCase().indexOf(e.toLowerCase())>-1)&&(i=!0,t.searchHover=!0),a?r.push(t):t.searchHover&&(delete t.searchHover,r.push(t))}),{tbList:r,hasTb:i,hasFolder:a}}function r(t,i,o){var o=o||!1;o||t.name.toLowerCase().indexOf(e.toLowerCase())>-1&&(o=!0);var n=t.sub_folders,l=[],s=!1;n&&n.length>0&&n.map(function(e){var t=angular.copy(e);delete t.tb_list;var a=r(e,2,o);(a.hasTb||a.hasFolder||o)&&(a.hasTb&&(t.open=!0),t.tb_list=a.tbList,l.push(t),s=a.hasTb||a.hasFolder)});var d=t.tb_list,c=a(d,o);if(2==i)return c;var u=angular.copy(t);return u.sub_folders=l,u.tb_list=c.tbList,(c.hasTb||s)&&(u.open=!0),{arr:u,hasFolder:o||s}}var i=[],o=angular.copy(t);return o.map(function(e){var t=r(e,1);(t.arr.tb_list.length>0||t.hasFolder)&&i.push(t.arr)}),i}var o,n;e.searchOriginList=[],e.$on("updatefolderList",function(t,a){a&&(o=a===!0?e.folderList:a)}),o=angular.copy(e.original_folderList?e.original_folderList:e.folderList),angular.element(t).on("keyup.searchFolderTable",function(){clearTimeout(n),n=setTimeout(r,100)})}}}]),!function(){function e(){function e(){}return{restrict:"A",templateUrl:"/static/partials/directiveTemplates/tableRelationPath.html",link:e}}angular.module("BC.directives").directive("tableRelationPath",e),e.$inject=["$rootScope"]}(),angular.module("BC.directives").directive("transformTbType",e),e.$inject=["commonService","$rootScope","errHint","ngDialog","$jsTipTranslate"],angular.module("BC.directives").directive("tableFilterPrompt",["$timeout","$rootScope","commonService","errHint","$jsTipTranslate",function(e,t,a,r,i){return{restrict:"A",scope:{togglePrompt:"=",choosePrompt:"&",tbId:"=",fieldId:"=",filterStr:"="},templateUrl:"/static/partials/directiveTemplates/tableFilterPrompt.html",replace:!0,link:function(e){var t=0;e.showFieldSearchLoading=!1,e.filterResult=[],e.promptData={showFilterPrompt:!1},e.getFieldValueList=function(r,i,o){var n=t=+new Date,l={tb_id:r,field_id:i,filter_str:o,limit:50};!function(r){e.promptData.showFilterPrompt=!0,e.showFieldSearchLoading=!0,a.tb.tableFieldFilter(l).then(function(a){e.showFieldSearchLoading=!1,t>r||a&&(e.filterResult=a.result.data)})}(n)},e.$watch("togglePrompt",function(t){return t?void(e.fieldId&&e.filterStr?e.getFieldValueList(e.tbId,e.fieldId,e.filterStr):e.fieldId?e.filterStr||r(e.tips["wb.tableFilterValueRequired"]):r(e.tips["wb.selectField"])):(e.promptData.showFilterPrompt=!1,void(e.filterResult=[]))}),e.chooseFilterItem=function(t){e.filterStr=t,e.togglePrompt=!1},i(["wb.selectField","wb.tableFilterValueRequired"],e)}}}]),angular.module("BC.directives").directive("searchDsTable",["$filter",function(e){return{link:function(t,a,r){function i(){var a=t.$eval(r.ngModel);c=!1,s="dsTbList"!=t.workdListView?"folderList":"dsTBList",n||(n=t.dsTBList),o||(o=t.folderList),a?(l="dsTBList"==s?n:o,l&&(d=[],u=!1,angular.forEach(l,function(t){if(u=!1,t.hasOwnProperty("tag")&&null!=t.tag&&t.tag.toLowerCase().indexOf(a.toLowerCase())>-1?(d.push(t),u=!0):t.hasOwnProperty("ds_name")&&null!=t.ds_name&&t.ds_name.toLowerCase().indexOf(a.toLowerCase())>-1&&(d.push(t),u=!0),!u){var r=e("query_tables")(t.tb_list,a);(r.length||"folder_root"==t.folder_id)&&d.push(angular.extend({},t,{tb_list:r,open:!0}))}}),t[s]=d)):(t.dsTBList&&(t.dsTBList=n),t.folderList=o),t.$apply()}var o,n,l,s,d,c,u,f;t.$on("updatefolderList",function(e,a){a&&(o=a===!0?t.folderList:a)}),angular.element(a).on("keyup.searchTable",function(){clearTimeout(f),f=setTimeout(i,100)})}}}]),angular.module("BC.directives").directive("searchTable",["$filter","$timeout",function(e){return{link:function(t,a,r){function i(){var a=t.$eval(r.ngModel);t.original_folderList?(n=angular.copy(o),c=!0):(n=t.folderList,c=!1),copy_folder_list=angular.copy(o);var i=[],d=[],u=!1,f=!1;a?n&&(l=[],s={},angular.forEach(n,function(t){u=!1,f=!1,i=e("query_tables")(t.tb_list,a),t.tb_list=i.length>0?i:[],u=i.length>0,t.sub_folders&&t.sub_folders.length>0&&(d=[],angular.forEach(t.sub_folders,function(t){i=e("query_tables")(t.tb_list,a),t.tb_list=i.length>0?i:[],t.open=i.length>0,i.length>0&&d.push(t)
}),t.sub_folders=d,f=d.length>0),(u||f)&&(t.open=!0,l.push(t))}),t.folderList=l,t.$emit("recoverFolderList",t.folderList)):(t.folderList=copy_folder_list,t.selected&&t.selected.tb_id&&t.highlightByTableId(t.folderList,t.selected.tb_id),t.$emit("recoverFolderList",t.folderList)),t.$apply()}var o,n,l,s,d,c=!0;t.searchOriginList=[],t.$on("updatefolderList",function(e,a){a&&(o=a===!0?t.folderList:a)}),o=angular.copy(t.original_folderList?t.original_folderList:t.folderList),angular.element(a).on("keyup.searchTable",function(){clearTimeout(d),d=setTimeout(i,100)})}}}]),angular.module("BC.directives").directive("searchTb",["$filter","$rootScope",function(e,t){return{templateUrl:"/static/partials/directiveTemplates/searchTb.html",scope:{list:"=",mode:"=",searchModeShow:"=",originList:"="},link:function(a){function r(e){clearTimeout(o),o=setTimeout(i,e)}function i(){function r(e){e.map(function(e){e.tag&&-1==$.inArray(e.tag,n)&&n.push(e.tag);var a=e.ds_type_name[t.language];a&&-1==$.inArray(a,n)&&n.push(a)})}function i(e){n.length?(1==e.length&&a.searchList.push({name:e[0],tag:""}),n.map(function(t){e.length>1?t.toLowerCase().indexOf(e[1].toLowerCase())>-1&&a.searchList.push({name:e[0],tag:t}):a.searchList.push({name:e[0],tag:t})})):a.searchList=[]}function o(){function t(o,n,l){o.sub_folders&&o.sub_folders.length>0&&i(o.sub_folders,t);var d=null;d=s[0]?e("query_fields")(o.tb_list,s[0],a.viewSearch.searchMode):o.tb_list,d.length>0&&s.length>1&&(d=e("queryByTagorDstype")(d,s[1])),r(d),o.tb_list=d,0!=o.tb_list.length||o.sub_folders&&0!=o.sub_folders.length?o.open=!0:l.splice(n,1)}var i=bdp.utils.descMap,o=angular.copy(a.originList);return i(o,t),o}a.searchList=[];var n=[],l=a.keyword,s=[];if(l)s="nomal"==a.mode?[l]:l.split(" "),a.list=o();else{if(a.list=a.originList,0==a.list.length)return;a.list[0].open=!0}i(s),a.$apply()}var o;a.viewSearch={showlist:!1,searchMode:"fuzzy"},a.searchList=[],a.keywordChange=function(){a.viewSearch.showlist=!0,r(300)},a.keyDownFun=function(e){13==e.keyCode&&(a.viewSearch.showlist=!1,r(0))},a.chooseSearchType=function(e){a.keyword=e.name+" "+e.tag,a.viewSearch.showlist=!1,r(0)},a.changeSearchMode=function(){a.keyword&&r(0)}}}}]),angular.module("BC.directives").directive("createChartAtTb",["commonService","$rootScope","errHint","ngDialog","$location","$rootScope","$jsTipTranslate",function(e,t,a,r,i,t,o){return{link:function(n){function l(e){var t=[];return e.length>0&&angular.forEach(e,function(e){0==e.type&&t.push(e)}),t}function s(){var e=[];return angular.forEach(n.dashStandardItems,function(t){e.push(t.top+t.height)}),{top:Math.max.apply(this,e)}}function d(e){for(var t,a,r=n.dashStandardItems||[],i=r.length,o=0,l=0,d=0,c=0;i>c;c++){var u=r[c];u.row+u.sizeY>l&&(u.col+u.sizeX>6?(l=u.row+u.sizeY,d=0):(l=u.row,d=u.col+u.sizeX));for(var f=0;f<u.children.length;f++)t=u.children[f],a=parseInt(t.dom_id.substr(2)),o=a>o?a:o}o++;var p={sizeX:6,sizeY:4,row:l,col:d,children:[{dom_id:"id"+o,meta:{name:n.tips["chart.untitledChart"],ct_id:"init_ctid"}}]};if(2==e){var g=s();p.width=480,p.height=324,p.left=0,p.top=g.top+10}n.dashStandardItems||(n.dashStandardItems=[]),n.dashStandardItems.push(p)}function c(e){var t=angular.copy(e);return angular.forEach(t,function(e){e.children[0].meta={ct_id:e.children[0].meta.ct_id,dash_setting:e.children[0].meta.dash_setting,html:e.children[0].meta.html||""}}),t}var u=t.language||"zh",f="zh"==u?"请选择":"Please select";n.requestDone=!0,n.initData=function(){n.createChartData={project_list:[],projId:"",dash_list:[],dashId:"",fixed_width:!1,show_block:!0,isGis:!1,currentProjName:"",currentDashName:f||"",showProjList:!1,showDashList:!1}},n.initData(),n.show_add_chart=function(){return n.selected.tb_id?3==t.enterprise_type&&2==t.guide?(n.$emit("okToGuide","createChart"),!1):(n.initData(),void e.project.getTree().then(function(e){e.proj=l(e.proj),0==e.proj.length?(n.createChartData.currentProjName=f||"",n.createChartData.currentDashName=f||""):(n.createChartData.project_list=[],angular.forEach(e.proj,function(e){0==e.type&&1!=e.property&&n.createChartData.project_list.push(e)}),n.createChartData.projId=n.createChartData.project_list[0].proj_id,n.createChartData.currentProjName=n.createChartData.project_list[0].name,n.createChartData.project_list[0].dsh_list.length>0&&(n.createChartData.dash_list=n.createChartData.project_list[0].dsh_list,n.createChartData.dashId=n.createChartData.dash_list[0].dsh_id,n.createChartData.currentDashName=n.createChartData.dash_list[0].name,n.getDashboardInfo())),r.open({template:"/static/partials/dialogTemplates/create_chart.html",className:"ngdialog-theme-default create-chart-dialog ngDialog-width-400",scope:n})})):void a(n.tips["wb.selectWorkSheet"])},n.selectProjItem=function(e,t){n.createChartData.currentProjName=t,n.createChartData.projId=e,n.createChartData.showProjList=!1;for(var a=n.createChartData.project_list,r=0,i=a.length;i>r;r++)a[r].proj_id==n.createChartData.projId&&(n.createChartData.currentProjName=a[r].name,n.createChartData.dash_list=a[r].dsh_list.length>0?a[r].dsh_list:[],n.createChartData.currentDashName=n.createChartData.dash_list.length?n.createChartData.dash_list[0].name:f,n.createChartData.dashId=n.createChartData.dash_list.length?n.createChartData.dash_list[0].dsh_id:"")},n.selectDashItem=function(e,t){n.createChartData.currentDashName=t,n.createChartData.dashId=e,n.createChartData.showDashList=!1,n.getDashboardInfo()},n.createNewProj=function(){n.createChartData.showProjList=!1,n.createChartData.showDashList=!1,n.newProjDialog=r.open({template:"/static/partials/directiveTemplates/selectProjDashInfo.html",className:"ngdialog-theme-default ngDialog-width-360",scope:n,data:{type:"proj",name:"",save:n.saveNewProj}})},n.createNewDash=function(){return n.createChartData.projId?(n.createChartData.showProjList=!1,n.createChartData.showDashList=!1,void(n.newDashDialog=r.open({template:"/static/partials/directiveTemplates/selectProjDashInfo.html",className:"ngdialog-theme-default ngDialog-width-360",scope:n,data:{type:"dash",name:"",save:n.saveNewDash}}))):void a(n.tips["dash.pleaseSelectProj"])},n.saveNewProj=function(t){if(n.requestDone){if(void 0==t||""===t)return void a(n.tips["dash.projectNameRequired"]);for(var r=n.createChartData.project_list||[],i=0,o=r.length;o>i;i++)if(r[i].name==t)return void a(n.tips["dash.duplicateProjectName"]);n.requestDone=!1,e.project.create(t).then(function(e){if(n.requestDone=!0,"0"==e.status){var r={proj_id:e.result.proj_id,name:t,dsh_list:[],type:0,property:0};n.createChartData.project_list.push(r),n.createChartData.currentProjName=t,n.createChartData.projId=e.result.proj_id,n.createChartData.dash_list=[],n.createChartData.dashId="",n.createChartData.currentDashName=f,n.newProjDialog.close()}else a(Number(e.status))})}},n.saveNewDash=function(t){if(n.requestDone){if(""===t)return void a(n.tips["dash.dashNameRequired"]);if(t.length>100)return void a(n.tips["dash.dashNameLessThan100"]);for(var r=null,i=n.createChartData.project_list,o=0;o<i.length;o++)if(i[o].proj_id==n.createChartData.projId){r=i[o];break}r||(r=n.createChartData.project_list[0]);for(var l=r.dsh_list,s=0,d=l.length;d>s;s++)if(l[s].name==t)return void a(n.tips["dash.duplicateDashName"]);var c={name:t,proj_id:n.createChartData.projId};n.requestDone=!1,e.dashboard.create(c).then(function(e){n.requestDone=!0,"0"==e.status?(l.push({dsh_id:e.result.dsh_id,name:t,label:"",comment:"",outer_share_id:"",property:0}),n.createChartData.dash_list=l,n.createChartData.dashId=e.result.dsh_id,n.createChartData.currentDashName=t,n.newDashDialog.close()):a(Number(e.status))})}},n.confirmCreate=function(){if(!n.selected.tb_id)return void a(n.tips["wb.selectWorkSheet"]);if(!n.gettingDashInfo){if(!n.createChartData.dashId)return void a(n.tips["dash.pleaseSelectDash"]);var o={};o.dsh_id=n.createChartData.dashId,e.dashboard.getInfo(o).then(function(o){var l=o.result.meta;n.dashStandardItems=l.charts||[];var s=n.createChartData.isGis?[n.selected.tb_id]:n.selected.tb_id;d(l.layout_style),e.chart.create({dsh_id:n.createChartData.dashId,tb_id:s,dsh_meta:{charts:c(n.dashStandardItems)}}).success(function(e){if("0"==e.status){$.cookie("grid_index","");var l=e.result.ct_id;r.closeAll();var s=i.path();s=n.createChartData.isGis?t.wsId?s.replace("data_source","gis_edit_ws"):s.replace("data_source","gis_edit"):t.wsId?s.replace("data_source","chart_edit_ws"):s.replace("data_source","chart_edit"),s=s+"/"+n.createChartData.projId+"/"+n.createChartData.dashId+"/"+l,i.path(s),t.global.rule_id="",t.creatingChart=!0}else a(Number(o.status))})})}},n.getDashboardInfo=function(){n.gettingDashInfo=!0;var t={};t.dsh_id=n.createChartData.dashId,e.dashboard.getInfo(t).then(function(e){0==e.status&&(n.createChartData.show_block=e.result.meta.show_block,n.createChartData.fixed_width=e.result.meta.fixed_width,n.$$phase||n.$digest(),n.gettingDashInfo=!1)})},o(["wb.selectWorkSheet","chart.untitledChart","dash.projectNameRequired","dash.duplicateProjectName","pleaseSelect","dash.dashNameRequired","dash.dashNameLessThan100","dash.duplicateDashName","dash.pleaseSelectProj","dash.pleaseSelectDash"],n)}}}]),!function(){angular.module("BC.directives").directive("selectSearchList",["$rootScope","$timeout","$jsTipTranslate","$translate",function(e,t,a){return{restrict:"A",templateUrl:"/static/partials/directiveTemplates/selectSearchList.html",replace:!0,scope:{selectData:"=",searchList:"=",valChange:"&"},link:function(e,r,i){function o(){e.viewData={defaultPlaceHolder:"",selectedText:"",selectedVal:"",searchList:[],originalList:[],searchQuery:"",showList:!1,displayKey:"",modeType:i.modeType,hitQueryNum:0}}function n(){switch(e.viewData.originalList=angular.copy(e.searchList),e.viewData.searchList=angular.copy(e.searchList),e.viewData.modeType){case"tableFilter":s="fid",d="name";break;case"joinSelect":s="fid",d="original_nick_name";break;case"queryAccount":s="userid",d="name";break;default:s="",d=""}e.viewData.displayKey=d}function l(e,t){return e.toLowerCase().indexOf(t.toLowerCase())>=0}var s="",d="";o(),e.$watch(function(){return e.searchList},function(){n()}),e.$watch(function(){return e.selectData},function(){e.viewData.selectedVal="",e.viewData.selectedText="";for(var t=e.viewData.searchList||[],a=0,r=t.length;r>a;a++)switch(e.viewData.modeType){case"tableFilter":e.selectData.field&&e.selectData.field.fid==t[a][s]&&(e.viewData.selectedVal=t[a][s],e.viewData.selectedText=t[a][d]);break;case"joinSelect":case"queryAccount":e.selectData==t[a][s]&&(e.viewData.selectedVal=t[a][s],e.viewData.selectedText=t[a][d])}}),e.toggleList=function(t){var a=angular.element(t.target);a=a.hasClass("bdp-icon")?a.parents(".select-search-value:first"):a;var r=a.parents(".select-search-value:first");r=0==r.length?a:r;var i=a.offset(),o=r.next(".search-list-box");e.viewData.showList=!e.viewData.showList,e.viewData.searchQuery="",angular.forEach(e.viewData.searchList,function(e){e.selectHit=!0}),e.viewData.hitQueryNum=e.viewData.searchList.length,o.css(e.viewData.showList?{position:"fixed",top:i.top+24+4,left:i.left,width:r.width()}:{top:"-9999px",left:"-9999px"})},e.doQuery=function(){var t=0;angular.forEach(e.viewData.searchList,function(a){e.viewData.searchQuery?(a.selectHit=l(a[d],e.viewData.searchQuery),a.selectHit&&t++):(a.selectHit=!0,t++)}),e.viewData.hitQueryNum=t},e.formatSelectDataByType=function(t){switch(e.viewData.modeType){case"tableFilter":e.selectData.field?e.selectData.field.fid=t:e.selectData.field={fid:t},d="name";break;case"joinSelect":case"queryAccount":e.selectData=t}},e.selectItem=function(a){e.viewData.selectedVal=a[s],e.viewData.selectedText=a[d],e.viewData.showList=!1,e.formatSelectDataByType(e.viewData.selectedVal),e.valChange&&t(function(){e.valChange({field:e.selectData})},0)},a(["wb.selectField"],e)}}}])}(),!function(){function e(e,t,a){return{restrict:"EA",templateUrl:"/static/js/worktable/directivesTemplates/setVisiblePreviewField.html",link:function(t){function r(){function e(e){r=displayNum=0,angular.forEach(e.list,function(e){e.visibleHitQuery=e.name.toLocaleLowerCase().indexOf(a.toLocaleLowerCase())>=0||!a,displayNum=e.visibleHitQuery?++displayNum:displayNum,r=e.selected&&e.visibleHitQuery?++r:r}),e.displayNum=displayNum,e.checkNum=r,e.checkAll=displayNum==r}var a=t.visiblePreviewFieldData.fieldQueryText,r=displayNum=0;for(var i in t.visiblePreviewFieldData.baseTbField)e(t.visiblePreviewFieldData.baseTbField[i]);for(var o in t.visiblePreviewFieldData.calcTbField)e(t.visiblePreviewFieldData.calcTbField[o]);t.visiblePreviewFieldData.currentTbField="base"==t.visiblePreviewFieldData.currentType?t.visiblePreviewFieldData.baseTbField:t.visiblePreviewFieldData.calcTbField,t.$broadcast("updateConditionHeight"),t.$apply()}t.changeTab=function(e){t.visiblePreviewFieldData.currentType=e,t.visiblePreviewFieldData.currentTbField="base"==e?t.visiblePreviewFieldData.baseTbField:t.visiblePreviewFieldData.calcTbField,t.$broadcast("updateConditionHeight")},t.changeCheckedAll=function(e){angular.forEach(e.list,function(t){t.visibleHitQuery&&(t.selected=e.checkAll)})},t.changeChecked=function(e){function a(e){var t=displayNum=0;angular.forEach(e.list,function(e){t=e.selected&&e.visibleHitQuery?++t:t,displayNum=e.visibleHitQuery?++displayNum:displayNum}),e.displayNum=displayNum,e.checkNum=t,e.checkAll=t==displayNum}switch(e.data_type){case"string":a(t.visiblePreviewFieldData.currentTbField.strField);break;case"number":a(t.visiblePreviewFieldData.currentTbField.numField);break;case"date":a(t.visiblePreviewFieldData.currentTbField.dateField)}};var i=null;t.queryInput=function(){clearTimeout(i),i=setTimeout(r,100)},t.modifyVisibleField=function(){function r(e){angular.forEach(e.list,function(e){e.selected&&i.push(e.field_id)})}var i=[];for(var o in t.visiblePreviewFieldData.baseTbField)r(t.visiblePreviewFieldData.baseTbField[o]);for(var n in t.visiblePreviewFieldData.calcTbField)r(t.visiblePreviewFieldData.calcTbField[n]);e.tb.modifyFieldStatus(t.selected.tb_id,JSON.stringify(i)).then(function(e){0==Number(e.status)?t.show_preview_data(t.lastPreviewFilterData):a(Number(e.status))})}}}}angular.module("BC.directives").directive("setVisiblePreviewField",e),e.$inject=["commonService","$timeout","errHint"]}()}();
;!function(){function e(e,a,t,i,s,n,r,o,d,s){function c(){l(),a.shopexAccessToken()}function l(e,i){m.loading=!0,t.ds.getListForDataSource(e).then(function(e){m.loading=!1,0==e.status&&(h(e.result),a.$broadcast("initPage"),a.$broadcast("initNum"),"page"==i&&r(function(){$("#table_list").scrollTop(0)},0))})}function h(t){angular.forEach(t.conf,function(e){e.db_name=e.db_name?angular.fromJson(e.db_name):e.db_name}),angular.forEach(t.ds_info,function(e){e.db_name=e.db_name?angular.fromJson(e.db_name):e.db_name,e.isSetShow=-1==$.inArray(e.db_type,[18,53,4,22,13])&&(e.have_tb>0||3==e.config_step||6==e.category),e.isDetailSetShow=$.inArray(e.db_type,[18,26,53])>-1&&(e.have_tb>0||3==e.config_step||6==e.category),e.isSyncShow=3!=e.status&&e.is_sync&&e.have_tb>0,e.isUnionShow=18!=e.db_type&&e.union&&e.have_tb>0,e.icon_url||(13==e.db_type?"/static/images/small-shopex.jpg":"/static/images/small.jpg",e.icon_url={small:"/static/images/small.jpg"})}),a.databaseInfo=t;var i=a.databaseInfo;if(i.res_tb_size){var s=p(i.res_tb_size.data_size_used);if(i.res_tb_size.data_size_limit)var n=p(i.res_tb_size.data_size_limit);m.tbUsed=n?s+"/"+n:s}i.res_ds_size&&(m.dsUsed=i.res_ds_size.ds_size_used+"/"+i.res_ds_size.ds_size_limit),m.hasWarn=t.has_warn;var o=a.databaseInfo.page_info;m.curPage=o.page,m.totalPage=o.total_page;var o=a.databaseInfo.page_info;if(m.curPage=o.page,m.totalPage=o.total_page,m.serverTime=t.server_time,t.ds_info&&t.ds_info[0]&&t.ds_info[0].extend){var d=t.ds_info[0].extend;d=angular.fromJson(d),m.pwdBatch=d.pwd_batch}r(function(){!a.shopexData.shopexFirstInDatabase||5!=e.enterprise_type&&6!=e.enterprise_type||0!=a.databaseInfo.ds_info.length||a.shopexData.shopexFlagIndex>0&&a.shopexData.codeFlagIndex>0||(a.shopexData.shopexFirstInDatabase=!1,a.add_data_shopex())},0)}function u(e){return 3==e.status?(o(a.tips["ds.SyncingDataSourceIn"]),!1):!0}function p(e){var a,t=["B","K","M","G"];for(a=0;a<t.length&&!(e>1&&1>e/1024)&&3!=a;a++)e/=1024;return e.toFixed(2).toString()+"  "+t[a]}function f(e){if(a.databaseInfo)for(var t=a.databaseInfo.ds_info,i=0;i<t.length;i++)if(t[i].ds_id==e.ds_id){l(b);break}}e.view="database",e.show_bdp_header=!0,a.viewData={currentDbType:"all",statusType:0,orderType1:0,orderType2:0,orderType3:0,orderBy:1},a.shopexData={bindSucFlag:!0,fromShopexCodeLink:!1,shopexFirstInDatabase:!0,locationUrl:s.absUrl(),shopexFlag:"&flag=shopex",codeFlag:"code=",shopexFlagIndex:"",codeFlagIndex:""};var g,m=a.viewData,b={};m.goLogView=function(e){6!=e.category&&s.path("/database_log/"+e.ds_id)},m.showSearchFun=function(){m.searchShow=!0,r(function(){$("#search_input").focus()},0)},m.getStatisticsData=function(e){m.currentDbType="all",b={status_type:e},m.statusType=e,l(b)},m.setDatabaseWarn=function(){n.open({template:"/static/database/partials/database_warn.html",className:"ngdialog-theme-default ngDialog-width-360",scope:a,showClose:!1,closeByDocument:!1,data:{list:a.warn_mobile_list||[]},controller:"databaseWarnCtrl"})},m.setDatabase=function(e){u(e)&&n.open({templateUrl:"/static/database/partials/database_set.html",className:"ngdialog-theme-default ngDialog-width-520",data:e,controller:"databaseSetCtrl",scope:a})},m.detailConfig=function(e){var a;switch(e.db_type){case 18:a="database_baidu_search_list";break;case 53:a="database_baidu_index_list";break;default:a="database_ba"}s.path("/"+a+"/"+e.ds_id)},m.delete=function(i){n.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:a,data:{message:a.tips["ds.confirmDelDb"]+": "+i.name+" ?"}}).then(function(){a.updateNameOrTag=!0,m.loading=!0,t.ds.delete({ds_id:i.ds_id}).then(function(t){m.loading=!1,0==t.status?(3==e.enterprise_type&&--e.personalInfo.capacity_info.used_api_num,o(a.tips["ds.delDbSuccess"]),l(b)):o(10007==Number(t.status)?Number(t.status):t.errstr)})})},m.getDbCategoryInfo=function(e){b.db_type=e?e.db_type:"",m.currentDbType=e?e.db_type:"all",b.page=1,l(b)},m.batchChangePwd=function(e){n.open({templateUrl:"/static/database/partials/database_change_pwd_batch.html",scope:a,data:{dbType:m.currentDbType,pwdBatch:e},className:"ngdialog-theme-default ngDialog-width-420 ngdialog-change-pwd-batch",controller:"databasePwdBatchCtrl",preCloseCallback:function(){}})},m.sortDatabaseList=function(e,a){e==b.order_by&&(a=1==a?0:1),b.order_type=m["orderType"+e]=a,b.order_by=m.orderBy=e,l(b)},m.searchKeyword=function(){r.cancel(g),g=r(function(){b.keyword=m.keyword,b.page=1,b.db_type=0,m.currentDbType="all",l(b)},500)},m.blurSearchInput=function(){m.keyword||(m.searchShow=!1)},m.quickUnion=function(e){u(e)&&n.open({template:"/static/database/partials/database_union.html",className:"ngdialog-theme-default ngDialog-width-400",scope:a,data:{ds:e},controller:"databaseUnionCtrl"})},m.start_sync=function(e){return u(e)?e.is_use?void(1==e.status||0==e.status?n.open({template:"/static/database/partials/database_sync_set.html",className:"ngdialog-theme-default ngDialog-width-360",scope:a,data:{ds:e},controller:"databaseSyncSetCtrl"}):o(a.tips["ds.syncFailDesc"])):void o(a.tips["ds.dataSourceDisabled"]):void 0},a.$on("goPage",function(e,a){b.page=a,l(b,"page")}),a.$on("updateDatabaseList",function(){l(b)}),a.gotoDatabaseList=function(){2==e.guide&&3==e.enterprise_type&&a.$emit("okToGuide","toAddDbsPage"),e.permision.isPartner.shopex||s.path("/database_list")},a.shopexAccessToken=function(){if(a.shopexData.shopexFlagIndex=a.shopexData.locationUrl.indexOf(a.shopexData.shopexFlag),a.shopexData.codeFlagIndex=a.shopexData.locationUrl.indexOf(a.shopexData.codeFlag),a.shopexData.shopexFlagIndex>0&&a.shopexData.codeFlagIndex>0){a.shopexData.fromShopexCodeLink=!0,a.shopexData.codeFlagIndex+=a.shopexData.codeFlag.length;var e=a.shopexData.locationUrl.slice(a.shopexData.codeFlagIndex,a.shopexData.shopexFlagIndex);d.post("/api/shopex/token",{code:e}).then(function(e){0===+e.status&&a.add_data_shopex()})}},a.getHomeUrl=function(){var e=s.absUrl(),a="https://www.bdp.cn/index.html",t=e.indexOf("?"),i=e.indexOf("#");return t>0&&i>t?a=e.slice(0,t):i>0?a=e.slice(0,i):0>t&&0>i&&(a=e),a},a.oauthLink=function(){n.closeAll();var e="https://openapi.shopex.cn/oauth/authorize?client_id=33wiwwae&view=oauth_usercenter&redirect_uri=",t="?flag=shopex#/database",i=a.getHomeUrl(),s="";s=e+encodeURIComponent(i+t),window.location.href=s},a.add_data_shopex=function(){d.get("/api/shopex/list").then(function(t){if(a.showLoading=!1,0==t.status||107==t.status)a.shopexDataList=t.result,a.shopexDataStatus=t.status,n.closeAll(),n.open({template:"/static/partials/dialogTemplates/create_db_shopex.html",className:"ngdialog-theme-default ngDialog-width-330 shopex-add-db",scope:a,showClose:0==t.status,controller:"CreateShopexCtrl",preCloseCallback:function(){if(0==a.shopexDataStatus&&a.shopexData.bindSucFlag){var t="database";5!=e.enterprise_type&&6!=e.enterprise_type||0!=a.databaseInfo.ds_info.length||(t="dash_edit"),a.shopexData.fromShopexCodeLink?(a.shopexData.fromShopexCodeLink=!1,window.location.replace(a.getHomeUrl()+"#/"+t)):s.path("/"+t)}a.shopexData.bindSucFlag=!0,a.$apply()}}),107==t.status&&(e.global.dialog_hint="",e.global.hint="");else if(7202==t.status)e.global.dialog_hint="",e.global.hint="",a.oauthLink();else{o(t.errstr);var i="database";a.databaseInfo&&a.databaseInfo.ds_info&&0==a.databaseInfo.ds_info.length&&(i="dash_edit"),r(function(){window.location.replace(a.getHomeUrl()+"#/"+i)},2e3)}})};var _="_websocketChartMessage_";a.$on(_,function(e,a){var t="string"==typeof a.data?$.parseJSON(a.data):a.data;4==t.type&&f(t)}),c(),i(["ds.syncFailDesc","ds.taskStartSuccess","ds.confirmDelDb","ds.delDbSuccess","ds.SyncingDataSourceIn","ds.dataSourceDisabled","ds.confirmToSync"],a)}function a(e,a,t,i,s,n,r,o,d,c){e.show_bdp_header=!1,e.view="database-list",a.personal_free=!1,s(function(){var t=e.enterprise_type,i=e.memberData.vipLevel;3==t&&0==i&&(a.personal_free=!0)},0);var l=function(){a.databaseInfo={},a.navListMore=[],a.allData=[],a.resultForEnter=[],a.queryText="",a.currentCategory=0,a.createLoading=!1,s(function(){a.baidu_ds={name:a.tips["ds.baiduAdsRank"]}},0),a.baiduSearchRrError="",a.showView={resultPage:!1,resultBar:!1,queryText:"",showLoading:!0,viewMore:!1},D()},h=function(e){d.open({template:"/static/database/partials/database_beta_tip.html",className:"ngdialog-theme-default ngDialog-width-360",scope:a,data:{item:e}})};a.gotoDetailsPage=function(e){18==e.db_type?n.path("database_baidu_search_list/"+e.ds_id):26==e.db_type?a.BA.gotoConfig(e):53==e.db_type&&n.path("database_baidu_index_list/"+e.ds_id)},a.gotoCreate=function(t){-1!=[18,26,53].indexOf(t.db_type)?t.ds_id?d.open({template:"/static/database/partials/database_ds_exist.html",className:"ngdialog-theme-default ngdialog-width-340",scope:a,data:{info:t}}):-1!=[18,53].indexOf(t.db_type)?a.add_baidu_data(t.db_type):a.BA.showAddBA():46==t.db_type||47==t.db_type?(2==e.guide&&3==e.enterprise_type&&a.$emit("okToGuide","toPageUpload"),n.path("page_upload/add")):n.path(51==t.db_type?"/developer_center":52==t.db_type?"/database_sync_client/":[49,50,54].indexOf(t.db_type)>-1?"/database_sync_client_big/":"/database_create/"+t.db_type)},a.BA={showAddBA:function(){d.closeAll(),a.ba={name:"BDP网站统计"},d.open({template:"/static/partials/dialogTemplates/add_ba.html",className:"ngdialog-theme-default ba-modal step-1",scope:a})},addBA:function(){var e=this;if(!a.ba.name)return t(a.tips["ba.datasourceNameNull"]),!1;if(a.ba.name.length>64)return t(a.tips["ba.datasourceNameLong"]),!1;var s=i.ds.create({db_type:26,name:a.ba.name}).then(function(i){if(0===+i.status)d.close(s),e.gotoConfig({ds_id:i.result.ds_id});else if(130===+i.status)return t(a.tips["ba.onlyOne"]),!1})},gotoConfig:function(e){n.path("/database_ba/"+e.ds_id)}},a.add_baidu_data=function(e){d.open({template:"/static/partials/dialogTemplates/add_baidu_search.html",className:"ngdialog-theme-default ngdialog-width-340",scope:a,data:{dbType:e}}),a.baidu_ds.name=18==e?a.tips["ds.baiduAdsRank"]:a.tips["ds.baiduIndex"]},a.confirm_add_baidu_data=function(e){if(""==a.baidu_ds.name)return void t(a.tips["ds.baiduSearchDsNameEmpty"]);a.createLoading=!0;var s={name:a.baidu_ds.name,db_type:e};i.ds.createDbBaiduSearch(s).then(function(i){0==i.status?(a.createLoading=!1,t(18==e?a.tips["ds.baiduAdsRankAddSuccess"]:a.tips["ds.baiduIndexAddSuccess"]),n.path(18==e?"database_baidu_search_list/"+i.result.ds_id:"database_baidu_index_list/"+i.result.ds_id),d.closeAll()):t(i.errstr)})},a.modifyDbBaiduSearch=function(e){n.path("database_baidu_search_list/"+e)};var u=function(a){d.open({template:"/static/database/partials/database_volume_tip.html",className:"ngdialog-theme-default ngDialog-width-360",scope:e,data:{type:a}})},p=function(){if(3==e.enterprise_type){var a=e.personalInfo.capacity_info.capacity,t=e.personalInfo.capacity_info.used;if(t>=a)return u("volume"),!0}},f=function(){if(3==e.enterprise_type){var a=e.personalInfo.capacity_info.used_api_num,t=e.personalInfo.vip_level;if(0==t&&a>=3||1==t&&a>=8||3==t&&a>=50)return u("api_num"),!0}},g=function(){return 3==e.enterprise_type&&0===e.memberData.vipLevel?!0:void 0},m=function(a){return g()&&8013==a.db_type?!1:p()?!1:6!=a.category&&1!=a.category&&-1==[46,47,52,54].indexOf(a.db_type)&&f()?!1:0===e.memberData.vipLevel&&8013==a.db_type?!1:!0},b=function(e){d.open({template:"/static/database/partials/database_create_common.html",className:"ngdialog-theme-default ngDialog-width-360",scope:a,data:{db_name:e.db_name,db_type:e.db_type,beta:e.beta,description:e.description.abstract,id:e.id,category:e.category}})};a.openAddDs=function(e){e.is_use&&!e.added&&(-1!=[51,52].indexOf(e.db_type)||m(e))&&(6==e.category?b(e):e.beta?h(e):a.gotoCreate(e),a.showView.resultBar=!1)},a.guideBackAddDbs=function(){2==e.guide&&3==e.enterprise_type&&a.$emit("okToGuide","quitAddDbs")},a.createOpenData=function(t){a.showView.showLoading=!0;var s=[];s.push(t.id);var n={db_type:t.db_type,check_tables:angular.toJson(s)};i.ds.create(n).then(function(i){if(0==i.status){if(a.showView.showLoading=!1,2==e.guide&&3==e.enterprise_type)return a.$emit("okToGuide","createDb"),!1;d.open({template:"/static/database/partials/database_create_success.html",className:"ngdialog-theme-default ngDialog-width-360"}),D(t.category)}})},a.searchInfo=function(){a.queryText&&(a.resultForEnter=a.resultForSearch,a.resultForEnter.length>0?(a.showView.resultPage=!0,a.showView.resultBar=!1,a.showView.queryText=a.queryText):a.showView.resultPage=!0,a.currentCategory="")},a.search=function(e){a.queryText?13==e.keyCode&&a.searchInfo():(a.currentCategory=0,a.showView.resultPage=!1)},a.filterSearch=function(){a.queryText?(a.resultForSearch=o("categoryFilter")(a.allData,a.queryText),a.resultForSearch.length>0&&(a.showView.resultBar=!0)):(a.resultForSearch=[],a.showView.viewItem=!1)};var _=function(e){angular.forEach(a.databaseInfo.data,function(t){t.category==e&&(a.categoryList=t.category_list)})};a.tabView=function(e){a.currentCategory=e,_(e),a.showView.viewMore=!1,a.showView.resultPage=!1};var y=function(e){return angular.forEach(e,function(e){e.category_name=angular.fromJson(e.category_name),e.db_name=angular.fromJson(e.db_name),e.description=angular.fromJson(e.description),e.extend=angular.fromJson(e.extend)}),e},D=function(e){a.allData=[],i.ds.getInitInfo().then(function(t){0==t.status&&(a.showView.showLoading=!1,a.databaseInfo=t.result,a.databaseInfo.hot=y(t.result.hot),a.databaseInfo.new=y(t.result.new),angular.forEach(a.databaseInfo.data,function(e){e.category_list=y(e.category_list);for(var t=0,i=e.category_list.length;i>t;t++)a.allData.push(e.category_list[t])}),e&&_(e),a.navListMore=t.result.data.slice(9))})};l(),c(["ds.baiduAdsRank","ds.baiduSearchDsNameEmpty","ds.baiduAdsRankAddSuccess","ba.datasourceNameNull","ba.datasourceNameLong","ba.onlyOne","ds.baiduIndex","ds.baiduIndexAddSuccess"],a)}function t(e,a,t,i,s,n,r,o,d,c,l,h,u){function p(){T=a.dbTypeInfo={},k=a.connectInfo={},C=a.tableInfo={},S=a.advancedInfo={},I=a.viewData={},I.prevTbData={},I.step=0,e.pageLoading=!0,I.date_layer=!1,S.field_list=[],S.is_pause=1;var t=r.params.dbType;S.is_pause=0,g(t)}function f(t){t.description=t.description?angular.fromJson(t.description):t.description,t.db_name=t.db_name?angular.fromJson(t.db_name):t.db_name,t.extend=angular.fromJson(t.extend),angular.extend(T,t),k.init=!0,a.paramTip=u[a.dbTypeInfo.db_type],0==T.param_categroy&&(S.hour="00",S.minute="00"),I.tab=3==T.config_step?[{key:1,name:a.tips["ds.connection"],title:"connect"},{key:2,name:a.tips["ds.workSheet"],title:"worktable"},{key:3,name:a.tips["ds.advanced"],title:"advanced"}]:[{key:1,name:a.tips["ds.connection"],title:"connect"},{key:2,name:a.tips["ds.advanced"],title:"advanced"}],T.param_desc=angular.fromJson(t.param_desc),m(),a.$broadcast("initData"),e.pageLoading=!1}function g(e){i.ds.dbTypeInfo({db_type:e}).then(function(e){0==e.status&&f(e.result)})}function m(){o(function(){var e=I.tab[I.step].title,t=0;t="connect"==e?0:"worktable"==e?1:2;var i=$($(".form-layer")[t]).height();$(".form-desc").height(i),a.usageHeight=i,a.viewData.showCreateGuide=!0},500)}function b(){a.viewData.loading=!0,C.tableList=null,48!=T.db_type?i.ds.getCTableList(x).then(function(e){C.tableList=0==e.status?e.result:[],a.viewData.loading=!1,m()}):i.ds.getGaReports(x).then(function(e){C.tableList=0==e.status?e.result:[],a.viewData.loading=!1,m()})}function _(){if(48!=a.dbTypeInfo.db_type){var e=0,t=1==T.category?"name":"name_id";return x.check_tables=[],C.checkTables=[],angular.forEach(C.tableList,function(a){a.check&&(e++,x.check_tables.push(a[t]),C.checkTables.push(a.name))}),0==e?!1:!0}var i=[],s=angular.copy(C.tableList);return angular.forEach(s,function(e){if("add"==e.tag){var a=e.report.where;"custom"==a.where_type&&(a.filters=$.trim(a.expression)),i.push(e.report)}}),x.reports=angular.toJson(i),!0}function y(){var e=C.checkTables,a=!0;return angular.forEach(e,function(t,i){var s=angular.copy(e);s.splice(i,1),$.inArray(t,s)>-1&&(a=!1)}),a}function D(){var e,a=angular.copy(S);return delete a.hourOptions,delete a.minuteOptions,delete a.addField,delete a.clearField,delete a.curFields,angular.extend(x,a),e=angular.copy(x),3==T.config_step&&(e.check_tables=angular.toJson(e.check_tables)),1==T.category&&(e.is_remark=T.extend.comments?1:0),e.field_list=v(),e}function v(){var e=[];return angular.forEach(S.field_list,function(a){a.ftitle&&a.fvalue&&e.push(a)}),angular.toJson(e)}function w(){a.viewData.goDatabase=function(){r.go("database")},a.viewData.goCreate=function(){r.go("database_list")},l.open({templateUrl:"/static/database/partials/database_create_success.html",className:"ngdialog-theme-default ngDialog-width-360",scope:a,showClose:!1})}e.show_bdp_header=!1,e.view="database-create";var k,C,S,T,I,x;p(),a.$on("nextStep",function(e,t){x=t,a.requestData=x,a.nextStep()}),a.nextStep=function(){if(3==T.config_step&&1==I.step){if(0==a.tableInfo.tableList.length)return;if(!_())return void d(a.tips["ds.tablesRequire"]);if(48!=T.db_type&&!y())return void d("不能勾选相同名字的表,请到"+T.db_name[e.language]+"中进行修改")}I.step+=1,3==T.config_step&&1==I.step?o(function(){b()},0):m()},a.prevStep=function(){I.step-=1,m()},a.save=function(){a.$broadcast("advancedInfoVerifyForm")},a.createDatabase=function(){var t=D();I.loading=!0,i.ds.create(t).then(function(t){if(0==t.status){if(3==e.enterprise_type&&++e.personalInfo.capacity_info.used_api_num,2==e.guide&&3==e.enterprise_type)return a.$emit("okToGuide","createDb"),!1;w()}I.loading=!1})},n(["ds.auxiliaryFieldNameNull","ds.auxiliaryFieldNameTooLong","ds.auxiliaryFieldValueNull","ds.fieldValueNovalidated","ds.apiName","ds.tablesRequire","ds.connection","ds.workSheet","ds.advanced"],a)}function i(e,a,t,i,s,n,r,o){function d(){var e=1,t=a.dbInfo;6==t.category&&(e=2),26==t.db_type&&(e=3),a.viewData.tab=e}function c(){var e=a.viewData,t=a.dbInfo,i=new Date(t.syncLastDate).getTime(),n=new Date(t.sync_start_date).getTime(),r=Highcharts.dateFormat("%Y-%m-%d",new Date),o=new Date(r).getTime();if(i>n)return s(a.tips["ds.startDateGreaterLastSyncDate"]),!1;if(n>o)return s(a.tips["ds.plzSelectBeforeToday"]),!1;var d=parseInt((o-n)/864e5)+1;return d>30&&(e.quotaTips=!0),e.syncDatetip=t.sync_start_date!=t.originalSyncStartDate?!0:!1,!0}function l(){var e=a.viewData,i=a.dbInfo;e.loading=!0,t.ds.getCTableList(i.conn_info).then(function(a){0==a.status&&h(i.sync_tables,a.result),e.loading=!1})}function h(e,t){var i,s=a.dbInfo.category;i=1==s?"name":6==s?"tb_id":"name_id",angular.forEach(t,function(a){$.inArray(a[i],e)>-1?(a.check=!0,a.initCheck=!0):(a.check=!1,a.initCheck=!1)}),a.dbInfo.tableList=t}function u(){var e=a.viewData;e.conn=!0,e.needConn=!1,s(a.tips["ds.testLinkSuccess"])}function p(){var e=0,t=a.dbInfo;return t.checkTables=[],0==t.is_use||0==t.tableList.length?!0:(angular.forEach(t.tableList,function(a){a.check&&(e++,t.checkTables.push(a.name))}),!!e)}function f(){var e=a.dbInfo.checkTables,t=!0;return angular.forEach(e,function(a,i){var s=angular.copy(e);s.splice(i,1),$.inArray(a,s)>-1&&(t=!1)}),t}function g(){var e=b(),i=a.viewData,n=a.dbInfo;i.loading=!0,t.ds.modify(e).then(function(t){i.loading=!1,0==t.status&&(s(a.tips["ds.modifySuccess"]),1==e.is_use&&(2==n.status&&i.conn||48==n.db_type&&angular.fromJson(e.reports).length>0)&&m(),a.$emit("updateDatabaseList"),r.closeAll())})}function m(){t.ds.startSyncTask(a.dbInfo.ds_id).then(function(){})}function b(){function e(e){var a=[];return angular.forEach(e,function(e){e.ftitle&&e.fvalue&&a.push(e)}),a}var t,i={},s=[],n=a.dbInfo,r=n.db_type;if(angular.extend(i,n.conn_info,n.config_info),48!=r)t=6==n.category?"tb_id":1==n.category?"name":"name_id",0==n.is_use||0==n.tableList.length?s=n.check_tables.sync_tables:angular.forEach(n.tableList,function(e){e.check&&s.indexOf(e[t])<0&&s.push(e[t])});else{var o=[],d=angular.copy(n.tableList);angular.forEach(d,function(e){if("add"==e.tag){var a=e.report.where;"custom"==a.where_type&&(a.filters=$.trim(a.expression)),o.push(e.report)}}),i.reports=angular.toJson(o)}0==n.is_use||0==n.tableList.length?s=n.check_tables.sync_tables:angular.forEach(n.tableList,function(e){e.check&&s.indexOf(e[t])<0&&s.push(e[t])}),angular.extend(i,n.conn_info,n.config_info),i.sync_start_date=n.sync_start_date;var c=n.config_info,l=e(c.field_list),h=l.concat(c.editFieldList);i.field_list=angular.toJson(h),delete i.editFieldList,i.is_use=n.is_use,i.sync_tables=angular.toJson(s);var u=[];return angular.forEach(n.tableList,function(e){e.check&&!e.initCheck&&u.push(e[t])}),u.length>0&&(i.whether_immediate_sync=n.syncNewTables===!0?1:0),9==n.db_type&&(i.target=[],angular.forEach(n.target,function(e){e.value&&i.target.push(e.key)}),i.target=angular.toJson(i.target)),i}function _(e){var i=a.dbInfo,s=a.viewData;s.loading=!0,t.ds.info({ds_id:e}).then(function(e){if(s.loading=!1,0==e.status){angular.extend(i,e.result),i.conn_info.db_type=i.db_type,i.conn_info.ds_id=i.ds_id,i.config_info.editFieldList=angular.copy(i.config_info.field_list),i.config_info.field_list=[],i.originalIsUse=i.is_use,i.originalSyncStartDate=i.sync_start_date,i.syncLastDate=i.sync_start_date;var t=i.check_tables;i.sync_tables=angular.fromJson(t.sync_tables),i.orginalTableList=angular.fromJson(t.table_list),t.connect&&2!=i.status?(s.conn=!0,i.conn=!0):(s.conn=!1,i.conn=!1),n(function(){s.dbInfoDataInit=!0,6==a.dbInfo.category&&s.switchTab(2),a.$broadcast("initData")},0)}})}a.init=function(){var e=a.ngDialogData;a.dbInfo={param_category:e.param_category,config_step:e.config_step,ds_id:e.ds_id,db_type:e.db_type,db_name:angular.fromJson(e.db_name),status:e.status,category:e.category,extend:angular.fromJson(e.extend),tableList:[]},a.tableInfo={},a.advancedInfo={},a.viewData={},a.tableInfo={},a.advancedInfo={};var t=a.advancedInfo,s=a.viewData,n=a.dbInfo;t.hourOptions=i.hourOptions,t.minuteOptions=i.minuteOptions,s.connBtn=-1!=[40,58,61].indexOf(n.db_type)?!1:!0,d(),_(e.ds_id)},a.init(),a.$watch("dbInfo.conn_info",function(){var e=a.viewData;e.dbInfoDataInit&&-1==[40,58,61].indexOf(a.dbInfo.db_type)&&(e.needConn=!0,e.conn=!1)},!0),a.$on("conn",function(){var e=a.viewData;e.conn=a.dbInfo.conn=!0,e.needConn=!1}),a.viewData.switchTab=function(e){var t=a.dbInfo,i=a.viewData,n=-1!=[40,58,61].indexOf(t.db_type)?a.tips["ds.authorizeConnTip"]:a.tips["ds.plzTestLink"];if((2==e||3==e)&&i.needConn&&!i.conn)return void s(n);if(2==e){if(0==t.is_use)return;if(!i.conn)return void s(n);0==t.tableList.length&&(0==t.orginalTableList.length?l():h(t.sync_tables,t.orginalTableList))}i.tab=e},a.switchDate=function(e,t){e.stopPropagation(),t||(a.viewData.date_layer=!a.viewData.date_layer)},a.$watch("viewData.picker_date",function(e){e&&(a.dbInfo.sync_start_date=Highcharts.dateFormat("%Y-%m-%d",e),c(),a.viewData.date_layer=!1)}),a.connectInfoVerify=function(){var e=a.viewData;e.needConn&&a.$broadcast("verifyForm")},a.connect=function(){var e=a.dbInfo.conn_info,i=a.viewData,s=a.dbInfo.db_type;48==s?a.$broadcast("gaConn"):(i.loading=!0,t.ds.conn(e).then(function(e){0==e.status&&u(),i.loading=!1}))},a.$on("connectSuccess",function(){u()}),a.saveSet=function(){var t=a.dbInfo;if(t.db_type,6==t.category)a.saveModify();else{if(3==t.config_step){if(!p())return void s(a.tips["ds.tablesRequire"]);if(48!=p&&!f())return void s("不能勾选相同名字的表,请到"+t.db_name[e.language]+"中进行修改")}a.$broadcast("advancedInfoVerifyForm")}},a.saveModify=function(){var e=a.viewData,t=a.dbInfo,i=-1!=[40,58,61].indexOf(t.db_type)?a.tips["ds.authorizeConnTip"]:a.tips["ds.plzTestLink"];return e.needConn&&!e.conn?void s(i):void((2!=t.config_step||0!=t.originalIsUse||1!=t.is_use||c())&&(e.syncDatetip?r.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:a,data:{message:a.tips["ds.presentSyncTip1"]+t.sync_start_date+a.tips["ds.presentSyncTip2"]+t.syncLastDate+a.tips["ds.presentSyncTip3"]}}).then(function(){g()}):g()))},o(["ds.plzSelectBeforeToday","ds.requireApiPassword","ds.plzTestLink","ds.startDateGreaterLastSyncDate","ds.tablesRequire","ds.testLinkSuccess","ds.authorizeConnTip","ds.modifySuccess","ds.presentSyncTip1","ds.presentSyncTip2","ds.presentSyncTip3"],a)}function s(e,a,t,i,s,n,r){function o(a){for(var t=0,i=a.length;i>t;t++)for(var s=0,n=a[t].merge_list.length;n>s;s++)a[t].merge_list[s].contain=Number(a[t].merge_list[s].contain),1==a[t].merge_list[s].contain&&(e.unionData.table_exits_in_Union=!0)}function d(a){var t=[],i=[],s=[];return angular.forEach(a,function(e){e.union_flag?i.push(e):s.push(e)}),t=i.concat(s),e.unionData.hasAble=i.length>0,t}function c(){if(e.createDone){var a={ds_id:e.createdApiId||"",ds_type:e.dbInfo.db_type};e.createDone=!1;var t={};e.showLoading=!0,n.sem.list(a).then(function(a){if(e.createDone=!0,e.showLoading=!1,0==Number(a.status)){e.currentConfig="unionSelect",a.result.length>0?(angular.forEach(a.result,function(a){t={},t.union_flag=a.tmp_ds_flag,t.ds_id=a.tmp_ds_id||"",t.name=a.tmp_ds_name||"",t.tag=a.tmp_ds_tag||"",t.type=e.dbInfo.db_type||0,t.field_error_tb=a.tb_info||[],e.unionData.select_list.push(t)}),e.unionData.select_list=d(e.unionData.select_list),e.unionData.refer_id="",angular.forEach(e.unionData.select_list,function(a){a.union_flag&&!e.unionData.refer_id&&(e.unionData.refer_id=a.ds_id,e.unionData.refer_db_name=a.name)})):e.currentConfig="noData";var i=$(".ngdialog");i.removeClass("ngDialog-width-360"),i.hasClass("ngDialog-width-400")||i.addClass("ngDialog-width-400")}else s(Number(a.status))})}}function l(e){for(var a=[],t=0,i=e.length;i>t;t++){for(var s=0,n=e[t].more.length;n>s;s++)a.indexOf(e[t].more[s])<0&&a.push(e[t].more[s]);for(var r=0,o=e[t].less.length;o>r;r++)a.indexOf(e[t].less[r])<0&&a.push(e[t].less[r])}return a}e.dbInfo={},e.unionData={union_query:"",refer_id:"",select_list:[],operator_list:[],error_field_list:[],table_exits_in_Union:!1},e.createDone=!0,e.currentConfig="unionSelect",e.createdApiId=e.ngDialogData.ds.ds_id,e.dbInfo.db_type=e.ngDialogData.ds.db_type,c(),e.showFieldErrorTip=function(a,t,i){var s=$(a.target).offset(),n=0;if("field"==t){n=s.top-$(".union-select-list").position().top,$(".union-select-list .bdp-tooltip").css({top:n+20,left:200}),$(".union-select-list .bdp-tooltip-content").css({display:"block"});var r=l(i.field_error_tb);e.unionData.error_field_list=r.length>2?r[0]+","+r[1]+"...":r.join(",")}else n=s.top-$(".union-operator-list").position().top,$(".union-operator-list .bdp-tooltip").css({top:n+20,left:200}),$(".union-operator-list .bdp-tooltip-content").css({display:"block"})},e.hideFieldErrorTip=function(a){"field"==a?($(".union-select-list .bdp-tooltip").css({top:0,left:0}),$(".union-select-list .bdp-tooltip-content").css({display:"none"}),e.unionData.error_field_list=""):($(".union-operator-list .bdp-tooltip").css({top:0,left:0}),$(".union-operator-list .bdp-tooltip-content").css({display:"none"}))},e.tabView=function(a){e.currentConfig=a,e.showLoading=!1},e.confirmUnion=function(){var a={};if("unionSelect"==e.currentConfig){if(!e.unionData.hasAble)return;if(!e.unionData.refer_id)return e.showLoading=!1,void s(e.tips["ds.openDataRequire"]);a={ds_id:e.createdApiId||"",tmp_ds_id:e.unionData.refer_id||""},e.createDone=!1,e.showLoading=!0,n.sem.tbrefer(a).then(function(a){e.createDone=!0,0==Number(a.status)?(e.currentConfig="unionDo",e.unionData.operator_list=a.result||[],o(a.result)):s(Number(a.status)),e.showLoading=!1})}else if("unionDo"==e.currentConfig){if(0==e.unionData.operator_list.length)return void s(e.tips["ds.noTablesHistoryUnion"]);a={link_list:angular.toJson(e.unionData.operator_list)},e.createDone=!1,e.createApiLoading=!0,e.showLoading=!0,n.sem.merge(a).then(function(a){0==Number(a.status)&&r.closeAll(),e.showLoading=!1})}},e.unionToExistTable=c,t(["ds.openDataRequire","ds.noTablesHistoryUnion"],e)}function n(e,a,t,i){e.show_bdp_header=!1,a.view="tab1",a.switch=1,a.switchPic=function(e){a.switch=e},t(function(){a.switch=1==a.switch?2:1},3e3),i([],a)}function r(e,a,t,i,s,n,r,o){function d(e,t){var i,s=a.dbInfo.category,n=[];i=1==s?"name":6==s?"tb_id":"name_id",angular.forEach(t,function(a){$.inArray(a[i],e)>-1&&(a.check=!0,a.initCheck=!0,n.push(a))}),a.dbInfo.tableList=n}function c(e){var i=a.dbInfo,s=a.viewData;s.loading=!0,t.ds.info({ds_id:e}).then(function(e){if(s.loading=!1,0==e.status){angular.extend(i,e.result),i.conn_info.db_type=i.db_type,i.conn_info.ds_id=i.ds_id,i.config_info.editFieldList=angular.copy(i.config_info.field_list),i.config_info.field_list=[],i.originalIsUse=i.is_use,i.originalSyncStartDate=i.sync_start_date,i.syncLastDate=i.sync_start_date;var a=i.check_tables;i.sync_tables=angular.fromJson(a.sync_tables),i.orginalTableList=angular.fromJson(a.table_list),i.conn=a.connect&&2!=i.status?!0:!1,n(function(){s.dbInfoDataInit=!0,d(i.sync_tables,i.orginalTableList),i.extend.tb_preview=!1,i.initOK=!0},0)}})}a.init=function(){var e=a.ngDialogData.ds;a.dbInfo={param_category:e.param_category,config_step:e.config_step,ds_id:e.ds_id,db_type:e.db_type,db_name:angular.fromJson(e.db_name),status:e.status,category:e.category,extend:angular.fromJson(e.extend),tableList:[]},c(e.ds_id)},a.init(),a.startSyncTask=function(){var e=a.dbInfo,i=a.viewData;i.loading=!0;var n;n=6==e.category?"tb_id":1==e.category?"name":"name_id";var r=[];angular.forEach(e.tableList,function(e){e.check&&r.push(e[n])}),t.ds.startSyncTask(a.ngDialogData.ds.ds_id,angular.toJson(r),e.db_type).then(function(e){i.loading=!1,"0"==e.status?(s(a.tips["ds.taskStartSuccess"]),a.$emit("updateDatabaseList")):s(e.errstr)})},o(["ds.taskStartSuccess"],a)}function o(e,a,t,i,s,n,r,o){function d(){e.guide=a.db_enterprise_guide,e.guide&&p()}e.viewGuide="",e.showGuide=!1,e.guide=0,e.have_dialog=!0;var c=t.current.name,l=[],h=$.cookie("user_id"),u=function(){var a=n(function(){return l=o.getOpenDialogs(),l.length>0?(e.have_dialog=!0,!0):(e.have_dialog=!1,n.cancel(a),!1)},0)},p=function(){if("database"==c){if([5,6].indexOf(e.guide)>-1)return;if(3==e.guide&&(e.guide=a.db_enterprise_guide=4,m(4)),0==e.num){if(e.guide>4)return;m(5),localStorage.setItem("db_num"+h,0)}(4==e.guide||7==e.guide)&&(e.viewGuide="guide-step1",e.showGuide=!0)}else{if(3==e.guide){var t=Number($.cookie("is_weak")),i=$.cookie("is_weak_hint");if(!t||i)e.showGuide=!0;else{if(u())return;e.showGuide=!0}}5==e.guide&&"database_list"==c&&(e.viewGuide="guide-step5",e.showGuide=!0),6==e.guide&&"database_create"==c&&(e.viewGuide="guide-step6",e.showGuide=!0,e.language=a.language,e.style={height:e.usageHeight+48+"px"})}};e.goOn=function(a){e.viewGuide=a},e.closeInit=function(){m(4)},e.gotoDataSource=function(){i.path("database"),m(4)};var f=function(){"database_list"==c&&m(6),"database_create"==c&&(0===Number(localStorage.num)||0===Number(localStorage["db_num"+h])?(m(7),window.localStorage.removeItem("num"),window.localStorage.removeItem("db_num"+h)):m(0)),4==e.guide&&"database"==c?m(5):7==e.guide&&"database"==c&&m(0),e.showGuide=!1};e.confirmQuit=function(a){"quit"==a?f():e.showGuide=!0};var g=function(){o.open({template:"/static/database/partials/quit_db_guide.html",className:"ngdialog-theme-default ngDialog-width-360",scope:e,showClose:!1})};e.quit=function(a){e.showGuide=!1,"quit"==a?g():f()};var m=function(t){r.post("/api/user/guide_set?guide="+userGuideFlags.set("origin",t)).then(function(){e.showGuide=!1,a.db_enterprise_guide=t})};d()}angular.module("BC.controllers.database",[]),angular.module("BC.controllers.database").controller("databaseCtrl",e),e.$inject=["$rootScope","$scope","commonService","$jsTipTranslate","$location","ngDialog","$timeout","errHint","commonHttp","$location"],!function(){function e(e,a,t,i,s,n){function r(){e.show_bdp_header=!1,a.databaseLog={dsId:s.dsId,dsName:"",selectTabs:{selected:"sheet",tabs:["sheet","task"]},show_run_records:!1,loading:!1},a.sheetData={statusData:{all:a.tips.all,0:a.tips.done,1:a.tips.done,2:a.tips.fail,3:a.tips["ds.status.updating"]},status:"all",searchKey:"",dsSheet:{}},a.taskData={statusData:{all:a.tips.all,1:a.tips.success,2:a.tips.fail,3:a.tips["ds.status.updating"]},rtType:{1:a.tips["ds.autoTouch"],2:a.tips["ds.handTouch"]},status:"all",dsTask:{}},a.getDsSheet(a.databaseLog.dsId)
}a.getDsSheet=function(e){var i={ds_id:e};a.databaseLog.loading=!0,t.ds.getDsSheet(i).then(function(e){a.databaseLog.loading=!1,0==e.status&&(a.sheetData.dsSheet=e.result,a.databaseLog.dsName=e.result.ds_name,4!=e.result.db_type&&(a.databaseLog.show_run_records=!0))})},a.getDsTask=function(e){var i={ds_id:e};a.databaseLog.loading=!0,t.ds.getDsTask(i).then(function(e){a.databaseLog.loading=!1,0==e.status&&(a.taskData.dsTask=e.result,a.databaseLog.dsName=e.result.ds_name)})},a.changeLogTab=function(e){a.databaseLog.selectTabs.selected=e,e==a.databaseLog.selectTabs.tabs[0]?a.getDsSheet(a.databaseLog.dsId):e==a.databaseLog.selectTabs.tabs[1]&&a.getDsTask(a.databaseLog.dsId)},n(function(){r()},0),i(["all","done","success","fail","ds.status.updating","ds.autoTouch","ds.handTouch"],a)}angular.module("BC.controllers.database").controller("databaseLogCtrl",e),e.$inject=["$rootScope","$scope","commonService","$jsTipTranslate","$stateParams","$timeout"]}(),angular.module("BC.controllers.database").controller("databaseListCtrl",a),a.$inject=["$rootScope","$scope","errHint","commonService","$timeout","$location","$state","$filter","ngDialog","$jsTipTranslate"],angular.module("BC.controllers.database").controller("databaseCreateCtrl",t),t.$inject=["$rootScope","$scope","personalSettingService","commonService","$location","$jsTipTranslate","$state","$timeout","errHint","$filter","ngDialog","databaseSyncTime","databaseParamTip","$sce"],!function(){function e(e,a,t,i,s,n,r,o){function d(){a.get("/api/ds_open/test_info").then(function(a){var t=a.result;0==a.status&&(e.test_info=t,e.applyCount="")})}t.view="database",t.show_bdp_header=!1,e.isMaster=!1,e.reset=!1,t.$watch("role_code",function(a){angular.isUndefined(a)||(e.isMaster=0==a)}),e.requesting=!1,e.hide_verification=!1,e.account=$.cookie("user"),e.verifyError=!1,e.noCount=!1,e.$watch("isMaster",function(t){t&&a.get("/api/ds_open/open_info").then(function(a){0==a.status&&(e.ipLimitationOpen=a.result.opends_ip_strategy,e.allowedIps=a.result.whitelist)},function(){i(e.tips.fail)})});var c={account:e.account,reset:!1};e.getToken=function(){return e.noCount=!1,e.verifyError=!1,e.tokenForm.$error.required?(e.verifyError=!0,void(e.yourPassword="")):(c.domain=e.yourDomain,c.pwd=e.yourPassword,void a.post("/api/ds_open/deal_token",c,{errHint:!1}).then(function(a){0==a.status?(e.token=a.result.access_token,e.verifyError=!1,e.yourPassword="",e.hide_verification=!0):1028==a.status?(e.noCount=!0,e.yourPassword=""):(e.verifyError=!0,e.yourPassword="")}))},e.resetToken=function(){var a=r.openConfirm({template:"confirmReset",className:"ngdialog-theme-default ngDialog-width-300",scope:e,name:"confirmReset"});a.then(function(){e.hide_verification=!1,c.reset=!0,e.reset=!0})},e.showToken=function(){e.hide_verification=!1,c.reset=!1},e.cancelReset=function(){e.hide_verification=!0};var l={del:!1,add:!1,changedIp:""};e.openLimitation=function(){e.ipLimitationOpen=1,l.del=!1,l.add=!1,l.changedIp="",l.ipLimitationOpen=e.ipLimitationOpen,a.post("/api/ds_open/deal_ip",l).then(function(a){0!=a.status&&i(e.tips.fail)},function(){i(e.tips.fail)})},e.closeLimitation=function(){e.ipLimitationOpen=0,l.del=!1,l.add=!1,l.changedIp="",l.ipLimitationOpen=e.ipLimitationOpen,a.post("/api/ds_open/deal_ip",l).then(function(a){0!=a.status&&i(e.tips.fail)},function(){i(e.tips.fail)})},e.delIp=function(t){l.del=!0,l.add=!1,l.changedIp=e.allowedIps[t],l.ipLimitationOpen=e.ipLimitationOpen,a.post("/api/ds_open/deal_ip",l).then(function(a){0==a.status?e.allowedIps.splice(t,1):i(e.tips.fail)},function(){i(e.tips.fail)})},e.addIp=function(){return e.ipForm.newIp.$invalid?(e.ipRedundancy=!1,void(e.ipError=!0)):$.inArray(e.newIp,e.allowedIps)>=0?(e.ipError=!1,e.ipRedundancy=!0,void(e.newIp="")):(e.ipRedundancy=!1,e.ipError=!1,l.del=!1,l.add=!0,l.changedIp=e.newIp,l.ipLimitationOpen=e.ipLimitationOpen,void a.post("/api/ds_open/deal_ip",l).then(function(a){0==a.status?(e.allowedIps.push(e.newIp),e.newIp=""):(e.ipRedundancy=!1,e.ipError=!0)},function(){i(e.tips.fail)}))},e.applyCount="",e.test_info={},e.stopNow=function(){r.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-320",scope:e,data:{title:o.instant("dc.stopDevmode"),message:o.instant("dc.confirmStopDevmode")+"\n",preformat:!0}}).then(function(){e.requesting=!0,a.post("/api/ds_open/stop_test").then(function(){d()})["finally"](function(){e.requesting=!1})})},e.confirmApply=function(){if(e.test_info.is_testing)return i(o.instant("dc.devmodeAlreadyOn"));var t=Number(e.applyCount);if(!(t>0)||t%1)return i(o.instant("dc.plzEnterHours"));var s=e.test_info.left_hours-t;return 0>s?i(o.instant("dc.noEnoughHours")):void r.openConfirm({template:"/static/partials/dialogTemplates/devcenter_enable_testing.html",className:"ngdialog-theme-default ngDialog-width-320 dev-center-dialog",scope:e,data:{title:o.instant("dc.turnOnDevmode"),message:o.instant("dc.confirmTurnOnDevmode").split("%span%"),message2:o.instant("dc.restHoursAfterThis").replace("%rest%",s),span:t}}).then(function(){var i={span:t};e.requesting=!0,a.post("/api/ds_open/apply_test",i).then(function(){d()})["finally"](function(){e.requesting=!1})})},t.permision.isPersonal||d(),s(["fail"],e)}angular.module("BC.controllers.dataSource").controller("developerCenterCtrl",e),e.$inject=["$scope","commonHttp","$rootScope","errHint","$jsTipTranslate","$location","ngDialog","$translate"]}(),angular.module("BC.controllers.database").controller("databaseSetCtrl",i),i.$inject=["$rootScope","$scope","commonService","databaseSyncTime","errHint","$timeout","ngDialog","$jsTipTranslate"],angular.module("BC.controllers.database").controller("databaseUnionCtrl",s),s.$inject=["$scope","commonService","$jsTipTranslate","$timeout","errHint","commonService","ngDialog"],!function(){function e(e,a,t,i,s,n,r){function o(){t.post("/api/shopex/bind").then(function(a){0===+a.status&&(e.showLoading=!1,e.newShopexLink=a.result)})}a.global.clickComplete=!0,e.shopexDatatype="1",e.newShopexLink="",e.showLoading=!0,o(),e.showShopexLayer=!1,e.createShopex=function(){a.global.clickComplete=!1;var s={shop_list:[]};return angular.forEach(e.shopexDataList,function(e){e.is_bind&&s.shop_list.push(e)}),s.shop_list.length<=0?(n(e.tips["ds.shopexDataRequire"],"dialog"),r(function(){a.global.clickComplete=!0},0),!1):(s.shop_list=angular.toJson(s.shop_list),e.showShopexLayer=!0,void t.post("/api/shopex/create",s).then(function(t){0==t.status?i.closeAll():n(t.errstr),e.showShopexLayer=!1,a.global.clickComplete=!0}))},e.goToDashboard=function(){window.location.replace(e.getHomeUrl()+"#/dash_edit")},e.addNewShopex=function(){var a=i.openConfirm({template:'                         <div class="ngdialog-title"></div>                         <div class="ngdialog-message">                             <p class="mb10">新店铺绑定成功?</p>                             <p>授权成功后，店铺将显示在列表中</p>                         </div>                         <div class="ngdialog-buttons">                             <button type="button" class="ngdialog-button ngdialog-button-secondary" ng-click="closeThisDialog(0)">取消</button>                             <button type="button" class="ngdialog-button ngdialog-button-primary" ng-click="confirm(1)">授权完成</button>                         </div>',className:"ngdialog-theme-default ngDialog-width-300",plain:!0,scope:e});a.then(function(){e.shopexBindFlag.bindSucFlag=!1,e.add_data_shopex()}),e.newShopexLink.length>0&&window.open(e.newShopexLink)},s(["ds.plzTestLink","ds.testLinkFail","ds.testLinkFailV2","ds.repeatSave","ds.fieldRequired","ds.remoteAddrError","ds.linkSuccess","ds.shopexDataRequire","ds.addNewShop","ds.firstAddNewShop","ds.nullShop","ds.notBoundShop","ds.backDashboard","ds.bindShop"],e)}angular.module("BC.controllers.dataSource").controller("CreateShopexCtrl",e),e.$inject=["$scope","$rootScope","commonHttp","ngDialog","$jsTipTranslate","errHint","$timeout","$location"]}(),angular.module("BC.controllers.database").directive("copyDeployCode",["errHint","$timeout",function(e,a){return{link:function(t,i){a(function(){i.zclip({path:"/static/js/lib/jquery-ui/ZeroClipboard.swf",copy:function(){return t.deployCode},afterCopy:function(){var t=bdpChart.language||"zh";a(function(){e("zh"===t?"复制成功":"Copied")},0)}})},500)}}}]).controller("databaseBaController",["$stateParams","$scope","$rootScope","baService","databaseType","$location","ngDialog","errHint","$jsTipTranslate","dbTypeMap",function(e,a,t,i,s,n,r,o,d){function c(){a.baInfo.configList={1:!1,2:!1,3:!1}}function l(e,t){i.list({ds_id:e}).then(function(e){if(0===+e.status){var i=e.result;a.baInfo.name=i.name,a.baInfo.sites=i.info,t&&t(i.info[i.info.length-1])}})}t.view="database-ba",t.show_bdp_header=!1;var h=e.ds_id,u=bdpChart.language||"zh";a.configMap="zh"===u?{1:"URL防丟参",2:"通话事件监控",3:"自定义事件追踪"}:{1:"URL Reference Anti-lost",2:"Call Event Monitor",3:"Custom Event Tracking"},a.baInfo={activeTabIndex:0,sites:[],name:"",domain:"",configList:{1:!1,2:!1,3:!1}},a.setCheckStat=function(e){e&&(a.baInfo.configList[1]=!0)},a.baConfig={showAddDomain:function(){var e=a.baInfo.sites;return e.length>=20?(o(a.tips["ba.siteLimit20"]),!1):void(this.dialog1=r.open({template:"/static/partials/dialogTemplates/ba_add_domain.html",className:"ngdialog-theme-default ngDialog-width-400",scope:a}))},checkDomain:function(e){return e=e.trim(),e?bdp.verify.isUrl(e)||bdp.verify.isMonUrl(e)?/^https?:\/\//.test(e)?(o(a.tips["ba.siteError1"]),!1):/\/$/.test(e)?(o(a.tips["ba.siteError2"]),!1):!0:(o(a.tips["ba.siteError"]),!1):!1},saveDomain:function(e){a.global.clickComplete=!1;var t=this;if(e=e.trim(),!e)return o(a.tips["ba.siteNameNull"]),a.global.clickComplete=!0,!1;if(!t.checkDomain(e))return a.global.clickComplete=!0,!1;for(var s=a.baInfo.sites,n=0;n<s.length;n++)if(e===s[n].net_domain)return o(a.tips["ba.siteExisted"]),a.global.clickComplete=!0,!1;i.addDomain({ds_id:h,net_domain:e}).then(function(e){0===+e.status&&(a.global.clickComplete=!0,a.baInfo.domain="",r.close(t.dialog1),l(h,t.showFuncsModal))})},getStaCode:function(){i.getToken({ds_id:h}).then(function(e){if(0===+e.status){var t=encodeURIComponent(e.result);a.deployCode='<script>\nvar _bat = _bat || [];\n(function() {\nvar host = encodeURIComponent(location.host);\nvar ba = document.createElement("script");\nba.src = "//ba.bdp.cn/bdpxt.js?js_type=3&token='+t+'&host=" + host;\nvar s = document.getElementsByTagName("script")[0];\ns.parentNode.insertBefore(ba, s);\n})();\n</script>',this.dialog3=r.open({template:"/static/partials/dialogTemplates/ba_deploy_code.html",className:"ngdialog-theme-default ba-deploy-modal",scope:a})}})},showCase:function(){this.dialog4=r.open({template:"/static/partials/dialogTemplates/ba_deploy_case.html",className:"ngdialog-theme-default ba-deploy-modal",scope:a})},isChecking:{},checkDeploy:function(e){var t=this;if(this.isChecking[e.net_domain])return!1;this.isChecking[e.net_domain]=!0;for(var s=a.baInfo.sites,n=0;n<s.length;n++)if(e.net_domain===s[n].net_domain){s[n].status=0;break}i.checkDeploy({ds_id:h,net_domain:e.net_domain}).then(function(a){if(0===+a.status){t.isChecking[e.net_domain]=!1;for(var i=0;i<s.length;i++)if(e.net_domain===s[i].net_domain){s[i].status=a.result.status;break}}})},showFuncsModal:function(e){var t=e.config_list||[];c();for(var i=0;i<t.length;i++)a.baInfo.configList[t[i]]=!0;this.dialog2=r.open({template:"/static/partials/dialogTemplates/ba_funcs_config.html",className:"ngdialog-theme-default ba-funcs-modal",scope:a,data:{site:e}})},saveFuncs:function(e,a){var t=this,s=[];for(var n in e)e[n]&&s.push(+n);s.sort(function(e,a){return e-a}),i.updateConfig({ds_id:h,net_domain:a.net_domain,config_list:angular.toJson(s)}).then(function(e){0===+e.status&&(r.close(t.dialog2),c(),a.config_list=s)})},delDomain:function(e,t){confirm(a.tips["ba.sureToDelete"])&&i.delDomain({ds_id:h,net_domain:e.net_domain}).then(function(i){0===+i.status&&(o(a.tips["ba.deleteTipHead"]+e.net_domain+a.tips["ba.deleteTipTail"]),a.baInfo.sites.splice(t,1))})}},a.gotoPage=function(e){n.path(e)},h&&(l(h),d(["ba.sureToDelete","ba.deleteTipHead","ba.deleteTipTail","ba.siteNameNull","ba.siteExisted","ba.siteLimit20","ba.siteError","ba.siteError1","ba.siteError2"],a))}]),angular.module("BC.controllers.database").controller("databaseSyncClientCtrl",n),n.$inject=["$rootScope","$scope","$interval","$jsTipTranslate"],!function(){function e(e,a,t,i,s,n,r,o,d){function c(e){switch(e){case"Mon":case 0:return{dayTitle:"星期一",dayIndex:0,dayId:"Mon"};case"Tue":case 1:return{dayTitle:"星期二",dayIndex:1,dayId:"Tue"};case"Wed":case 2:return{dayTitle:"星期三",dayIndex:2,dayId:"Wed"};case"Thu":case 3:return{dayTitle:"星期四",dayIndex:3,dayId:"Thu"};case"Fri":case 4:return{dayTitle:"星期五",dayIndex:4,dayId:"Fri"};case"Sat":case 5:return{dayTitle:"星期六",dayIndex:5,dayId:"Sat"};case"Sun":case 6:return{dayTitle:"星期天",dayIndex:6,dayId:"Sun"}}}function l(){var a=[];return angular.forEach(e.searchData.rate,function(e,t){e&&a.push(t.split("min")[1])}),a}function h(e){for(var a=0,t=0;t<e.timeFrequency.length;t++)e.timeFrequency[t].selected&&(a+=1);e.selectAllDay=a==e.timeFrequency.length?!0:!1}function u(a){for(var t=e.searchData.week.length-1;t>=0;t--)if(!e.searchData.week[t].timeFrequency[a].selected)return e.verticalSec[a]=!1,!1;e.verticalSec[a]=!0}function p(){for(var a=0,t=e.searchData.week.length-1;t>=0;t--)e.searchData.week[t].selectAllDay&&(a+=1);e.continueSelected.selectedAllHour=a===e.searchData.week.length?!0:!1}e.init=function(){var t=new Date,i={selectAllDay:!1,timeFrequency:[]},r=[];e.verticalSec=[];for(var o=0;24>o;o++)i.timeFrequency.push({value:o+"",selected:!1}),e.verticalSec.push(!1);for(var o=0;7>o;o++){var d=c(o);i.dayTitle=d.dayTitle,i.dayId=d.dayId,r.push(angular.copy(i))}a.view="database_baidu_search",a.show_bdp_header=!1,e.searchPrice={rtType:null,cost:0,dayCost:0,singleCost:0,miss:0,frequency:0,balance:0,repeat:0,timeLimit:!1},e.dayTimes=n,e.searchData={dsId:s.dsId,realtimeId:"create"==s.realtimeId?null:s.realtimeId,cost:0,singleCost:0,balance:0,name:"",searchWords:"",searchWordsNum:0,regions:{},week:r,rate:{min05:!0,min20:!1,min35:!1,min50:!1},device:{pc:!1,mo:!1},rtType:0,startDate:t,startTime:"00",endDate:null,endTime:"23",timeLimit:!1,queryAreaKey:null,showSearchArea:[],isShowSearchArea:!1},e.showDists={},e.showCitys={},e.continueSelected={controll:!1,selectedAllHour:!1},e.getRegions()},e.updataSearchWords=function(){e.searchData.searchWordsNum=e.getSearchWords().length},e.getRegions=function(){t.ds.baiduRegion().then(function(a){0==a.status&&(e.processRegionData(a.result),e.searchData.realtimeId&&e.getSearchConfig(e.searchData.realtimeId))})},e.processRegionData=function(a){var t=[];e.searchData.regions=a;for(var i=0,s=e.searchData.regions.length;s>i;i++){e.searchData.regions[i].selected=!1,e.searchData.regions[i].selectedHalf=!1,e.searchData.regions[i].count=0,0==i&&(e.searchData.regions[i].selected=!0);for(var n=0,r=e.searchData.regions[i].childs.length;r>n;n++)if(e.searchData.regions[i].childs[n].checked=!1,e.searchData.regions[i].childs[n].selected=!1,e.searchData.regions[i].childs[n].selectedHalf=!1,e.searchData.regions[i].childs[n].count=0,0==i&&0==n&&(e.searchData.regions[i].childs[n].selected=!0),null!=e.searchData.regions[i].childs[n].childs)for(var o=0,d=e.searchData.regions[i].childs[n].childs.length;d>o;o++)if(e.searchData.regions[i].childs[n].childs[o].checked=!1,e.searchData.regions[i].childs[n].childs[o].selected=!1,e.searchData.regions[i].childs[n].childs[o].selectedHalf=!1,e.searchData.regions[i].childs[n].childs[o].count=0,null!=e.searchData.regions[i].childs[n].childs[o].childs)for(var c=0,l=e.searchData.regions[i].childs[n].childs[o].childs.length;l>c;c++)e.searchData.regions[i].childs[n].childs[o].childs[c].checked=!1,e.searchData.regions[i].childs[n].childs[o].childs[c].selected=!1,e.searchData.regions[i].childs[n].childs[o].childs[c].selectedHalf=!1,t.push(e.searchData.regions[i].childs[n].childs[o].childs[c]),e.searchData.regions[i].childs[n].childs[o].childs[c].count=0;else 0==o&&0==n&&(e.searchData.regions[i].childs[n].selected=!0,e.showDists=e.searchData.regions[i].childs[n].childs)}e.showCitys=t},e.getSearchConfig=function(i){var s={realtime_id:i};a.pageLoading=!0,t.ds.baiduSearchConfig(s).then(function(t){a.pageLoading=!1,0==t.status&&e.processData(t.result)})},e.changeRegion=function(a){for(var t=e.searchData.regions.length-1;t>=0;t--)e.searchData.regions[t].selected=!1;e.searchData.regions[a].selected=!0,e.searchData.isShowSearchArea=!1},e.processData=function(a){var t=a.config;e.searchData.singleCost=a.single_cost,e.searchData.balance=a.balance,e.searchData.name=t.name,e.searchData.rtType=t.rt_type||0,e.searchData.searchWords=t.search_words.join("\n");for(var i=!1,s=t.citys.length-1;s>=0;s--){i=!1;for(var n=e.searchData.regions.length-1;n>=0;n--){for(var r=e.searchData.regions[n].childs.length-1;r>=0;r--)if(null!=e.searchData.regions[n].childs[r].childs)for(var o=e.searchData.regions[n].childs[r].childs.length-1;o>=0;o--){if(null!=e.searchData.regions[n].childs[r].childs[o].childs){for(var d=e.searchData.regions[n].childs[r].childs[o].childs.length-1;d>=0;d--)if(e.searchData.regions[n].childs[r].childs[o].childs[d].code==t.citys[s]){e.searchData.regions[n].childs[r].childs[o].childs[d].checked=!0,i=!0;break}}else if(e.searchData.regions[n].childs[r].childs[o].code==t.citys[s]){e.searchData.regions[n].childs[r].childs[o].checked=!0,i=!0;break}if(i)break}if(i)break}}e.checkedCitys(),e.checkedDists();for(var r=t.device.length-1;r>=0;r--)e.searchData.device[t.device[r]]=!0;angular.forEach(t.week,function(a,t){for(var i=c(t).dayIndex,s=e.searchData.week[i].timeFrequency,n=a.length-1;n>=0;n--)for(var r=s.length-1;r>=0;r--)if((s[r].value<10?"0"+s[r].value:s[r].value)==a[n]){s[r].selected=!0;break}});for(var r=e.searchData.week.length-1;r>=0;r--)h(e.searchData.week[r]);for(var r=23;r>=0;r--)u(r);if(p(),t.rate){e.searchData.rate.min05=!1;for(var r=t.rate.length-1;r>=0;r--)t.rate[r]&&(e.searchData.rate["min"+t.rate[r]]=!0)}t.start_time&&(e.searchData.startDate=t.start_time.split(" ")[0],e.searchData.startTime="00"),t.time_limit||(e.searchData.endDate=t.end_time.split(" ")[0],e.searchData.endTime="23"),e.searchData.timeLimit=t.time_limit,e.searchPrice.timeLimit=t.time_limit},e.checkedAllCitys=function(a){for(var t=a.checked,i=a.childs.length-1;i>=0;i--)if(a.childs[i].checked=t,null!=a.childs[i].childs)for(var s=a.childs[i].childs.length-1;s>=0;s--)a.childs[i].childs[s].checked=t;e.checkedCitysNum(),e.checkedCitysHalf()},e.resetSelectedCitys=function(){for(var a=!1,t=e.searchData.regions[0].childs.length-1;t>=0;t--){e.searchData.regions[0].childs[t].selected=a;for(var i=e.searchData.regions[0].childs[t].childs.length-1;i>=0;i--)null!=e.searchData.regions[0].childs[t].childs[i].childs&&(e.searchData.regions[0].childs[t].childs[i].selected=a)}e.checkedCitysNum(),e.checkedCitysHalf()},e.showChangeRegion=function(a){var t=[];if(1==a)t=e.searchData.regions[0].childs[a].childs;else for(var i=0,s=e.searchData.regions[0].childs[a].childs.length;s>i;i++)for(var n=0,r=e.searchData.regions[0].childs[a].childs[i].childs.length;r>n;n++)t.push(e.searchData.regions[0].childs[a].childs[i].childs[n]);e.showCitys=t,e.resetSelectedCitys(),e.searchData.regions[0].childs[a].selected=!0,e.checkedCitysNum(),e.checkedCitysHalf()},e.showChangeCitys=function(a){e.showCitys=a.childs,e.resetSelectedCitys(),a.selected=!0,e.checkedCitysNum(),e.checkedCitysHalf()},e.checkedCitys=function(){for(var a=0,t=!0,i=!0,s=e.searchData.regions[0].childs.length-1;s>=0;s--){a=0,i=!0;for(var n=e.searchData.regions[0].childs[s].childs.length-1;n>=0;n--)if(t=!0,null!=e.searchData.regions[0].childs[s].childs[n].childs){for(var r=e.searchData.regions[0].childs[s].childs[n].childs.length-1;r>=0;r--)if(!e.searchData.regions[0].childs[s].childs[n].childs[r].checked){t=!1;break}t?(e.searchData.regions[0].childs[s].childs[n].checked=!0,a++):e.searchData.regions[0].childs[s].childs[n].checked=!1}else{if(!e.searchData.regions[0].childs[s].childs[n].checked){i=!1;break}a++}e.searchData.regions[0].childs[s].checked=a==e.searchData.regions[0].childs[s].childs.length?!0:!1}e.checkedCitysNum(),e.checkedCitysHalf()},e.checkedOneCitys=function(a){for(var t=a.childs.length-1;t>=0;t--)a.childs[t].checked=a.checked;e.showChangeCitys(a),e.checkedCitys(),e.checkedCitysNum(),e.checkedCitysHalf()},e.checkedAllRegionCitys=function(){for(var a=e.searchData.regions[0].childs.length-1;a>=0;a--)if(e.searchData.regions[0].childs[a].checked=!0,null!=e.searchData.regions[0].childs[a].childs)for(var t=e.searchData.regions[0].childs[a].childs.length-1;t>=0;t--)if(e.searchData.regions[0].childs[a].childs[t].checked=!0,null!=e.searchData.regions[0].childs[a].childs[t].childs)for(var i=e.searchData.regions[0].childs[a].childs[t].childs.length-1;i>=0;i--)e.searchData.regions[0].childs[a].childs[t].childs[i].checked=!0;e.checkedCitysNum(),e.checkedCitysHalf()},e.resetCheckedAllRegionCitys=function(){for(var a=e.searchData.regions[0].childs.length-1;a>=0;a--)if(e.searchData.regions[0].childs[a].checked=!1,null!=e.searchData.regions[0].childs[a].childs)for(var t=e.searchData.regions[0].childs[a].childs.length-1;t>=0;t--)if(e.searchData.regions[0].childs[a].childs[t].checked=!1,null!=e.searchData.regions[0].childs[a].childs[t].childs)for(var i=e.searchData.regions[0].childs[a].childs[t].childs.length-1;i>=0;i--)e.searchData.regions[0].childs[a].childs[t].childs[i].checked=!1;e.checkedCitysNum(),e.checkedCitysHalf()},e.checkedCitysNum=function(){var a=0,t=0;oneTypeCitysNum=0,foreignNum=0,isForeign=!1;for(var i=e.searchData.regions[0].childs.length-1;i>=0;i--)if(foreignNum=0,isForeign=!1,null!=e.searchData.regions[0].childs[i].childs){for(var s=e.searchData.regions[0].childs[i].childs.length-1;s>=0;s--)if(null!=e.searchData.regions[0].childs[i].childs[s].childs){oneTypeCitysNum=0;for(var n=e.searchData.regions[0].childs[i].childs[s].childs.length-1;n>=0;n--)e.searchData.regions[0].childs[i].childs[s].childs[n].checked&&(oneTypeCitysNum++,a++,t++);e.searchData.regions[0].childs[i].childs[s].count=oneTypeCitysNum}else isForeign=!0,e.searchData.regions[0].childs[i].childs[s].checked&&(foreignNum++,a++);e.searchData.regions[0].childs[i].count=isForeign?foreignNum:t}e.searchData.regions[0].count=a},e.checkedCitysHalf=function(){var a=0;allCitysNum=0,oneTypeCitysNum=0,foreignNum=0,isForeign=!1;for(var t=e.searchData.regions[0].childs.length-1;t>=0;t--)if(foreignNum=0,isForeign=!1,a=0,null!=e.searchData.regions[0].childs[t].childs){for(var i=e.searchData.regions[0].childs[t].childs.length-1;i>=0;i--)if(null!=e.searchData.regions[0].childs[t].childs[i].childs){oneTypeCitysNum=0;for(var s=e.searchData.regions[0].childs[t].childs[i].childs.length-1;s>=0;s--)e.searchData.regions[0].childs[t].childs[i].childs[s].checked&&(oneTypeCitysNum++,allCitysNum++),a++;e.searchData.regions[0].childs[t].childs[i].selectedHalf=oneTypeCitysNum>0&&oneTypeCitysNum<e.searchData.regions[0].childs[t].childs[i].childs.length?!0:!1}else isForeign=!0,e.searchData.regions[0].childs[t].childs[i].checked&&foreignNum++;e.searchData.regions[0].childs[t].selectedHalf=isForeign?foreignNum>0&&foreignNum<e.searchData.regions[0].childs[t].childs.length?!0:!1:allCitysNum>0&&a>allCitysNum?!0:!1}},e.resetSelectedDists=function(){for(var a=!1,t=e.searchData.regions[1].childs.length-1;t>=0;t--){e.searchData.regions[1].childs[t].selected=a;for(var i=e.searchData.regions[1].childs[t].childs.length-1;i>=0;i--)null!=e.searchData.regions[1].childs[t].childs[i].childs&&(e.searchData.regions[1].childs[t].childs[i].selected=a)}e.checkedDistsNum(),e.checkedDistsHalf()},e.showChangeDists=function(a){e.showDists=a.childs,e.resetSelectedDists(),a.selected=!0,e.checkedDistsNum(),e.checkedDistsHalf()},e.checkedDists=function(){for(var a=0,t=e.searchData.regions[1].childs.length-1;t>=0;t--)if(a=0,null!=e.searchData.regions[1].childs[t].childs){for(var i=e.searchData.regions[1].childs[t].childs.length-1;i>=0;i--)e.searchData.regions[1].childs[t].childs[i].checked&&a++;e.searchData.regions[1].childs[t].checked=a==e.searchData.regions[1].childs[t].childs.length?!0:!1}e.checkedDistsNum(),e.checkedDistsHalf()},e.checkedOneDists=function(a){for(var t=a.childs.length-1;t>=0;t--)a.childs[t].checked=a.checked;e.showChangeDists(a),e.checkedDists(),e.checkedDistsNum(),e.checkedDistsHalf()},e.checkedAllRegionDists=function(){for(var a=e.searchData.regions[1].childs.length-1;a>=0;a--)if(e.searchData.regions[1].childs[a].checked=!0,null!=e.searchData.regions[1].childs[a].childs)for(var t=e.searchData.regions[1].childs[a].childs.length-1;t>=0;t--)e.searchData.regions[1].childs[a].childs[t].checked=!0;e.checkedDistsNum(),e.checkedDistsHalf()},e.resetCheckedAllRegionDists=function(){for(var a=e.searchData.regions[1].childs.length-1;a>=0;a--)if(e.searchData.regions[1].childs[a].checked=!1,null!=e.searchData.regions[1].childs[a].childs)for(var t=e.searchData.regions[1].childs[a].childs.length-1;t>=0;t--)e.searchData.regions[1].childs[a].childs[t].checked=!1;e.checkedDistsNum(),e.checkedDistsHalf()},e.checkedDistsNum=function(){for(var a=0,t=0,i=e.searchData.regions[1].childs.length-1;i>=0;i--){if(t=0,null!=e.searchData.regions[1].childs[i].childs)for(var s=e.searchData.regions[1].childs[i].childs.length-1;s>=0;s--)e.searchData.regions[1].childs[i].childs[s].checked&&(t++,a++);e.searchData.regions[1].childs[i].count=t}e.searchData.regions[1].count=a},e.checkedDistsHalf=function(){for(var a=0,t=e.searchData.regions[1].childs.length-1;t>=0;t--)if(a=0,null!=e.searchData.regions[1].childs[t].childs){for(var i=e.searchData.regions[1].childs[t].childs.length-1;i>=0;i--)e.searchData.regions[1].childs[t].childs[i].checked&&a++;e.searchData.regions[1].childs[t].selectedHalf=a>0&&a<e.searchData.regions[1].childs[t].childs.length?!0:!1}},e.changeSearchArea=function(){var a=[];if(e.searchData.isShowSearchArea=!0,e.searchData.queryAreaKey&&e.searchData.queryAreaKey.trim()){e.searchData.showSearchArea=[];for(var t=0,i=e.searchData.regions.length;i>t;t++)for(var s=0,n=e.searchData.regions[t].childs.length;n>s;s++)if(null!=e.searchData.regions[t].childs[s].childs)for(var r=0,o=e.searchData.regions[t].childs[s].childs.length;o>r;r++)if(null!=e.searchData.regions[t].childs[s].childs[r].childs)for(var d=0,c=e.searchData.regions[t].childs[s].childs[r].childs.length;c>d;d++)e.searchData.regions[t].childs[s].childs[r].childs[d].name.indexOf(e.searchData.queryAreaKey.trim())>-1&&a.push(e.searchData.regions[t].childs[s].childs[r].childs[d]);else e.searchData.regions[t].childs[s].childs[r].name.indexOf(e.searchData.queryAreaKey.trim())>-1&&a.push(e.searchData.regions[t].childs[s].childs[r])}e.searchData.showSearchArea=a,0!=a.length||e.searchData.queryAreaKey&&e.searchData.queryAreaKey.trim()||(e.searchData.isShowSearchArea=!1)},e.clearSearchWords=function(){e.searchData.searchWords=""},e.save=function(){e.checkSearch()&&e.searchBudget()},e.searchBudget=function(){t.ds.modifyDbBaiduSearch(e.getSearchParam(0)).then(function(a){if(0==a.status){e.searchPrice={rtType:e.searchData.rtType,cost:a.result.cost,dayCost:a.result.day_cost,singleCost:a.result.single_cost,miss:a.result.miss,frequency:a.result.frequency,balance:a.result.balance,repeat:a.result.repeat,timeLimit:e.searchData.timeLimit},e.searchData.singleCost=a.result.single_cost,e.searchData.balance=a.result.balance;var t="ngDialog-width-510";1==e.searchPrice.rtType&&(t="ngDialog-width-370"),i.open({template:"/static/partials/dialogTemplates/search_budget.html",className:"ngdialog-theme-default "+t,scope:e})}})},e.checkSearch=function(){if(!(e.searchData.name&&e.searchData.name.trim().length>0))return o("名称不能为空"),!1;if(!(e.searchData.searchWords&&e.searchData.searchWords.trim().length>0))return o("搜索词不能为空"),!1;if(e.getCheckedCitys().length<=0)return o("监控地域至少选择一个"),!1;if(!e.searchData.device.pc&&!e.searchData.device.mo)return o("监控设备至少选择一个"),!1;if(0==e.searchData.rtType&&!e.searchData.startDate)return o("监控起始日期必选"),!1;if(0==e.searchData.rtType&&!e.searchData.timeLimit&&!e.searchData.endDate)return o("监控截至日期必选"),!1;if(!(0!=e.searchData.rtType||e.searchData.timeLimit||Highcharts.dateFormat("%Y-%m-%d",new Date(e.searchData.startDate))+e.searchData.startTime<Highcharts.dateFormat("%Y-%m-%d",new Date(e.searchData.endDate))+e.searchData.endTime))return o("起始时间必须小于截至时间"),!1;if(0==e.searchData.rtType&&l().length<=0)return o("监控频率至少选择一个"),!1;if(0==e.searchData.rtType){var a=0;if(angular.forEach(e.getSelectedWeek(),function(e){a+=e.length}),!a)return o("监控频次至少选择一个"),!1}return!0},e.getSearchWords=function(){for(var a=e.searchData.searchWords.split("\n"),t=[],i=0,s=a.length;s>i;i++)a[i]&&a[i].trim().length>0&&t.push(a[i]);return t},e.getSearchParam=function(a){var t={db_type:18,modify:a,ds_id:e.searchData.dsId,realtime_id:e.searchData.realtimeId,name:e.searchData.name,rt_type:e.searchData.rtType};0==e.searchData.rtType&&(t.start_time=Highcharts.dateFormat("%Y-%m-%d",new Date(e.searchData.startDate))+" "+e.searchData.startTime+":00:00",t.end_time=Highcharts.dateFormat("%Y-%m-%d",new Date(e.searchData.endDate))+" "+e.searchData.endTime+":59:59",t.time_limit=e.searchData.timeLimit);for(var i=e.searchData.searchWords.split("\n"),s=0,n=i.length;n>s;s++)i[s]=i[s].trim();t.search_words=angular.toJson(i);var r=e.getCheckedCitys();t.citys=angular.toJson(r);var o=[];if(e.searchData.device.pc&&o.push("pc"),e.searchData.device.mo&&o.push("mo"),t.device=angular.toJson(o),0==e.searchData.rtType){var d=l();t.rate=angular.toJson(d)}if(0==e.searchData.rtType){var c=e.getSelectedWeek();t.week=angular.toJson(c)}return t},e.getCheckedCitys=function(){for(var a=[],t=e.searchData.regions.length-1;t>=0;t--)for(var i=e.searchData.regions[t].childs.length-1;i>=0;i--)if(null!=e.searchData.regions[t].childs[i].childs)for(var s=e.searchData.regions[t].childs[i].childs.length-1;s>=0;s--)if(null!=e.searchData.regions[t].childs[i].childs[s].childs)for(var n=e.searchData.regions[t].childs[i].childs[s].childs.length-1;n>=0;n--)e.searchData.regions[t].childs[i].childs[s].childs[n].checked&&a.push(e.searchData.regions[t].childs[i].childs[s].childs[n].code);else e.searchData.regions[t].childs[i].childs[s].checked&&a.push(e.searchData.regions[t].childs[i].childs[s].code);return a},e.chooseAllDay=function(e,a){for(var t=0;t<a.timeFrequency.length;t++)a.timeFrequency[t].selected=e,u(t)},e.chooseTimeFrequency=function(e,a,t,i){a.selected=e,h(t),u(i),p()},e.selectedAllHour=function(a){for(var t=e.searchData.week.length-1;t>=0;t--)e.searchData.week[t].selectAllDay=a,e.chooseAllDay(a,e.searchData.week[t])},e.selectHourAllWeek=function(a,t){for(var i=e.searchData.week.length-1;i>=0;i--)e.searchData.week[i].timeFrequency[a].selected=t,h(e.searchData.week[i])},e.selectedTime=function(a,t,i,s){a.preventDefault(),e.continueSelected.controll&&(t.selected=!t.selected,h(i),u(s),p())},d(function(){$(".J-continue-selected").on("mousedown.continueSelected",function(a){a.preventDefault(),e.continueSelected.controll=!0,$(document).on("mouseup.continueSelected",function(a){a.preventDefault(),$(document).off("mouseup.continueSelected"),e.continueSelected.controll=!1})})},0),e.getSelectedWeek=function(){var a={};return angular.forEach(e.searchData.week,function(e){a[e.dayId]=[];for(var t=0,i=e.timeFrequency.length;i>t;t++)e.timeFrequency[t].selected&&a[e.dayId].push(e.timeFrequency[t].value<10?"0"+e.timeFrequency[t].value:e.timeFrequency[t].value)}),a},e.baiduSearch=function(){a.pageLoading=!0,e.searchData.realtimeId?t.ds.modifyDbBaiduSearch(e.getSearchParam(1)).then(function(t){0==t.status&&r.path("/database_baidu_search_list/"+e.searchData.dsId),a.pageLoading=!1}):t.ds.createDbBaiduSearchTask(e.getSearchParam()).then(function(t){0==t.status&&r.path("/database_baidu_search_list/"+e.searchData.dsId),a.pageLoading=!1})},e.init()}angular.module("BC.controllers.database").controller("databaseBaiduSearchCtrl",e),e.$inject=["$scope","$rootScope","commonService","ngDialog","$stateParams","dateTimesMap","$location","errHint","$timeout"]}(),!function(){function e(e,t,i,s,n,r,o,d){function c(){var a={ds_id:e.baiduSearchDsConfig.ds_id};
t.pageLoading=!0,i.ds.getDbBaiduSearchTaskList(a).then(function(a){if(t.pageLoading=!1,0==a.status){var i=a.result;e.baiduSearchDsConfig.day_cost=i.day_cost,e.baiduSearchDsConfig.balance=i.balance,e.baiduSearchDsConfig.word_count=i.word_count,e.baiduSearchRrError=i.rt_error,e.baiduSearchDsConfig.tbId=i.tb_id,i.is_empty?e.baiduSearchDsConfig.baiduSearchTaskList=[]:(e.baiduSearchDsConfig.baiduSearchTaskList=i.rt_list,e.noTask=e.baiduSearchDsConfig.baiduSearchTaskList.length>0?!1:!0)}})}function l(a){var s={ds_id:e.baiduSearchDsConfig.ds_id,realtime_id:a.realtime_id};i.ds.deleteDbBaiduSearchTask(s).then(function(a){"0"==a.status?(t.pageLoading=!1,c(),o(e.tips["ds.delBaiduSearchTaskSuccess"])):o(a.errstr)})}e.init=function(){e.baiduCompanyConfig={canClose:null},e.baiduSearchDsConfig={ds_id:n.dsId,day_cost:0,balance:0,word_count:0,baiduSearchTaskList:[],tbId:null},d(["ds.stopBaiduSearchTaskSuccess","ds.startBaiduSearchTaskSuccess","ds.delBaiduSearchTaskSuccess","ds.startSyncTaskSuccess","ds.confirmToDelTask","ds.confirmToStopTask","ds.confirmToStartTask"],e),c(),e.baiduSearchRrError="",t.view="database_baidu_search",t.show_bdp_header=!1},e.init(),e.back=function(){for(var e,a=t.historyTime,i=a.length-1;i>=0;i--)if("/database"==a[i]||"/database_list"==a[i]){e=a[i];break}r.path(e||"/database")},e.add_baidu_data=function(){r.path("database_baidu_search/"+e.baiduSearchDsConfig.ds_id+"/create")},e.getSearchConfig=function(a){r.path("database_baidu_search/"+e.baiduSearchDsConfig.ds_id+"/"+a.realtime_id)},e.showIntroduction=function(){s.open({template:"/static/database/partials/baidu_search_introduction.html",scope:e,className:"ngdialog-theme-default ngdialog.ngDialog-width-420"})},e.baiduSearchTaskContrl=function(a,n){s.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:0==n?e.tips["ds.confirmToStartTask"]+a.name+"?":e.tips["ds.confirmToStopTask"]+a.name+"?"}}).then(function(){var s={ds_id:e.baiduSearchDsConfig.ds_id,realtime_id:a.realtime_id,is_pause:n};t.pageLoading=!0,i.ds.modifyDbBaiduSearchTask(s).then(function(i){"0"==i.status?(t.pageLoading=!1,a.is_pause=+i.result,o(i.result?e.tips["ds.stopBaiduSearchTaskSuccess"]:e.tips["ds.startBaiduSearchTaskSuccess"])):o(i.errstr)})})},e.confirmToDelTask=function(a){s.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:e.tips["ds.confirmToDelTask"]+a.name+"?"}}).then(function(){l(a)})},e.startBaiduSync=function(a){var t={ds_id:e.baiduSearchDsConfig.ds_id,realtime_id:a.realtime_id};i.ds.startBaiduTaskSyncCost(t).then(function(t){"0"==t.status?e.baiduSyncConfirm(a,t.result.cost):o(t.errstr)})},e.baiduSyncConfirm=function(a,t){s.openConfirm({template:"/static/database/partials/database_baidu_sync.html",className:"ngdialog-theme-default ngDialog-width-370",scope:e,data:{cost:t,balance:e.baiduSearchDsConfig.balance}}).then(function(){e.startSyncTask(a)})},e.startSyncTask=function(a){var t={ds_id:e.baiduSearchDsConfig.ds_id,realtime_id:a.realtime_id};i.ds.startBaiduSyncTask(t).then(function(t){"0"==t.status?(a.syncing=!0,setTimeout(function(){a.syncing=!1,c()},1500),s.open({template:"/static/database/partials/database_baidu_sync_result.html",className:"ngdialog-theme-default ngDialog-width-370",scope:e,data:{checkName:t.result.check_name}})):o(t.errstr)})},e.companySetting=function(){var t={ds_id:e.baiduSearchDsConfig.ds_id,tb_id:e.baiduSearchDsConfig.tbId},n={selfList:[],otherList:[]};i.ds.baiduCompanySetting(t).then(function(t){0==t.status&&(angular.forEach(t.result.self_info,function(e,a){n.selfList.push({domain:a,companyName:e})}),angular.forEach(t.result.other_info,function(e,a){n.otherList.push({domain:a,companyName:e})}),s.open({template:"/static/database/partials/database_baidu_company.html",className:"ngdialog-theme-default baidu-company-setting",scope:e,data:{baiduCompanyData:n},controller:a,preCloseCallback:function(){return e.baiduCompanyConfig.canClose?(o("含有未保存内容，请先保存"),e.$$phase||e.$apply(),!1):!0}}))})}}function a(e,a,t,i,s,n,r){function o(){for(var a=[],t={},i=e.baiduCompanyModel.list,s=i.length-1;s>=1;s--)t[i[s].companyName]=t[i[s].companyName]?t[i[s].companyName]+1:0;for(typeItem in t)a.push(typeItem.trim().length<=0?"暂未设置":typeItem);return t[e.baiduCompanyModel.companyFilter]||(e.baiduCompanyModel.companyFilter=null),a}function d(a){e.baiduCompanyModel.loading=!0,t.ds.modifyCompanySetting(a).then(function(a){0==a.status&&(e.baiduCompanyModel.list.unshift({domain:"",companyName:"",domainErrorTip:"",companyNameErrorTip:""}),e.baiduCompanyModel.companyNameList=o("model")),e.baiduCompanyModel.loading=!1})}function c(a){e.baiduCompanyModel.loading=!0,t.ds.modifyCompanySetting(a).then(function(t){if(0==t.status){for(var i=e.baiduCompanyModel.list.length-1;i>=0;i--)if(e.baiduCompanyModel.list[i].companyName===a.ent_name){e.baiduCompanyModel.list.splice(i,1);break}e.baiduCompanyModel.companyNameList=o("model")}e.baiduCompanyModel.loading=!1})}function l(a,i){e.baiduCompanyModel.loading=!0,t.ds.modifyCompanySetting(a).then(function(a){0==a.status&&(e.baiduCompanyModel.oldCompanyItem=null,i.edit=!1,e.baiduCompanyModel.companyNameList=o("model")),e.baiduCompanyModel.loading=!1})}function h(a,t){switch(param={ds_id:e.baiduSearchDsConfig.ds_id,tb_id:e.baiduSearchDsConfig.tbId,data_type:"string",domain_belong:e.baiduCompanyModel.domainBelong,domain:a.domain,ent_name:a.companyName},t){case"add":param.op_type="add";break;case"modify":param.op_type="modify",param.old_domain=e.baiduCompanyModel.oldCompanyItem.domain,param.old_entname=e.baiduCompanyModel.oldCompanyItem.companyName;break;case"del":param.op_type="delete"}return param}var u={selfList:[],otherList:[]};e.companyDomainInit=function(){u=e.ngDialogData.baiduCompanyData,e.baiduCompanyModel={list:[{domain:"",companyName:"",domainErrorTip:"",companyNameErrorTip:""}],domainBelong:"",companyFilter:"",companyNameList:[],loading:!1,oldCompanyItem:null},e.changeCompanyDomainTab("self","init")},e.$watch("baiduCompanyModel.oldCompanyItem",function(a){e.baiduCompanyConfig.canClose=a}),e.changeCompanyDomainTab=function(a,t){if(a==e.baiduCompanyModel.domainBelong)return!1;if(e.baiduCompanyModel.oldCompanyItem)return r("含有未保存内容，请先保存"),!1;for(var i=e.baiduCompanyModel.list.length-1;i>=0;i--)e.baiduCompanyModel.list[i].edit&&e.cancelModify(e.baiduCompanyModel.list[i]);var s=angular.copy(e.baiduCompanyModel.list);s[0].domain="",s[0].companyName="",s[0].domainErrorTip="",s[0].companyNameErrorTip="","self"==a?(e.baiduCompanyModel.list=s.splice(0,1).concat(u.selfList),e.baiduCompanyModel.domainBelong="self",t||(u.otherList=s)):(e.baiduCompanyModel.list=s.splice(0,1).concat(u.otherList),e.baiduCompanyModel.domainBelong="other",u.selfList=s),e.baiduCompanyModel.companyNameList=o(a)},e.checkCompanySetting=function(e){var a=!0;(!e.domain||e.domain.trim().length<=0)&&(e.domainErrorTip="企业域不能为空",a=!1),(!e.companyName||e.companyName.trim().length<=0)&&(e.companyNameErrorTip="企业名不能为空",a=!1),("暂未设置"===e.companyName||"全部"===e.companyName)&&(e.companyNameErrorTip="企业名不合法",a=!1);for(var t=0,i=u.selfList.length;i>t;t++)if(e.domain==u.selfList[t]){e.domainErrorTip="企业域不能重复",a=!1;break}for(var t=0,i=u.otherList.length;i>t;t++)if(e.domain==u.otherList[t]){e.domainErrorTip="企业域不能重复",a=!1;break}return a&&(e.domainErrorTip="",e.companyNameErrorTip=""),a},e.cancelModify=function(a){a.domain=e.baiduCompanyModel.oldCompanyItem.domain,a.companyName=e.baiduCompanyModel.oldCompanyItem.companyName,a.domainErrorTip=e.baiduCompanyModel.oldCompanyItem.domainErrorTip,a.companyNameErrorTip=e.baiduCompanyModel.oldCompanyItem.companyNameErrorTip,a.edit=!1,e.baiduCompanyModel.oldCompanyItem=null,e.baiduCompanyModel.companyNameList=o("model")},e.editCompanySetting=function(a,t,i){var s=h(a,t);switch(t){case"add":if(!e.checkCompanySetting(a))return!1;d(s);break;case"modify":if(!e.checkCompanySetting(a))return!1;l(s,a);break;case"del":c(s,i);break;case"edit":for(var n=e.baiduCompanyModel.list.length-1;n>=0;n--)e.baiduCompanyModel.list[n].edit&&e.cancelModify(e.baiduCompanyModel.list[n]);e.baiduCompanyModel.oldCompanyItem=angular.copy(a),a.edit=!0}},e.companyDomainInit()}angular.module("BC.controllers.database").controller("databaseBaiduSearchListCtrl",e).controller("companyDomainCtrl",a),e.$inject=["$scope","$rootScope","commonService","ngDialog","$stateParams","$location","errHint","$jsTipTranslate","$timeout"],a.$inject=["$scope","$rootScope","commonService","ngDialog","$stateParams","$location","errHint","$jsTipTranslate","$timeout"]}(),!function(){function e(e,a,t,i,s,n){function r(){o()}function o(){a.ds.warn_mobile_list().then(function(a){0==Number(a.status)?a.result.length>0&&angular.forEach(a.result,function(a){e.mobileList.push(a.phone)}):s(Number(a.status))})}function d(){function a(){e.verify_seconds--,e.verify_seconds>0?h=n(function(){a()},1e3):e.isGettingVcode=!1}e.verify_seconds=60,a()}function c(){e.verify_mobile=60,e.editingMobile=!1,e.isGettingVcode=!1,e.mobile_format_wrong=!1,e.saveWarnDone=!0,e.defaultNumber="",e.vCode="",e.verifyMobile="",e.oldMobile="",h&&n.cancel(h)}function l(a){var t=!1;return t=e.mobileList.length>0?e.mobileList.indexOf(a)>=0:!1}e.saveWarnDone=!0,e.db_warn_view="list",e.mobile_format=0,e.verify_mobile=60,e.defaultNumber="",e.vCode="",e.verifyMobile="",e.oldMobile="",e.editingMobile=!1,e.isGettingVcode=!1,e.current_mobile_index=0,e.mobile_format_wrong=!1,e.mobileList=[],e.request_code_times=0;var h=null;e.goVerify=function(a){return a?verifyHandle.mobile(a)?(e.verifyMobile=a,e.editingMobile=!1,void(e.db_warn_view="verify")):void s(e.tips["user.phoneNumberFormatError"]):void s(e.tips["user.inputPhoneNumber"])},e.addMobile=function(){e.db_warn_view="verify",c()},e.changeMobile=function(a,t){e.editingMobile=!0,e.oldMobile=a,e.verifyMobile=a,e.db_warn_view="verify",e.vCode="",e.current_mobile_index=t},e.checkMobile=function(a){a&&(e.mobile_format_wrong=!verifyHandle.mobile(a))},e.delMobile=function(t,i){if(confirm(e.tips["user.whetherDeleteBoundNumber"])){var n={phone:t};a.ds.warn_mobile_del(n).then(function(a){0==Number(a.status)?e.mobileList.splice(i,1):s(Number(a.status))})}},e.getVerifyCode=function(){if(!e.isGettingVcode&&!e.mobile_format_wrong){if(e.request_code_times++,e.request_code_times>5)return void s(e.tips["user.getTooMuchVerifyCode"]);if(!e.verifyMobile)return void s(e.tips["user.inputPhoneNumber"]);if(l(e.verifyMobile))return void s(e.tips["user.phoneNumberExisted"]);var t=null;t=e.editingMobile?{phone:e.oldMobile+"",new_phone:e.verifyMobile+""}:{phone:e.verifyMobile+"",new_phone:"null"},d(),e.isGettingVcode=!0,a.ds.warn_mobile_vcode(t).then(function(a){0==Number(a.status)?s(e.tips["user.sendVerifyCodeAndWait"]):(s(Number(a.status)),e.isGettingVcode=!1)})}},e.returnMobileList=function(){e.db_warn_view="list",c()},e.saveDatabaseWarn=function(){if(e.saveWarnDone&&!e.mobile_format_wrong){if(!e.verifyMobile)return void s(e.tips["user.inputPhoneNumber"]);if(!e.vCode)return void s(e.tips["user.inputVerifyCode"]);if(l(e.verifyMobile))return void s(e.tips["user.phoneNumberExisted"]);var t=null;t=e.editingMobile?{phone:e.oldMobile+"",new_phone:e.verifyMobile+"",vcode:e.vCode+""}:{phone:e.verifyMobile+"",new_phone:"null",vcode:e.vCode+""},e.saveWarnDone=!1,a.ds.warn_mobile_verify(t).then(function(a){e.saveWarnDone=!0,0==Number(a.status)?(s(e.tips.saveSuccess),e.db_warn_view="list",e.editingMobile?e.mobileList[e.current_mobile_index]=e.verifyMobile:e.mobileList.push(e.verifyMobile),c()):s(Number(a.status))})}},e.reloadMobile=function(){e.$emit("updateDatabaseList"),t.closeAll()},r(),i(["saveSuccess","user.phoneNumberExisted","user.phoneNumberFormatError","user.inputPhoneNumber","user.inputVerifyCode","user.sendVerifyCodeAndWait","user.getTooMuchVerifyCode","user.whetherDeleteBoundNumber"],e)}angular.module("BC.controllers.dataSource").controller("databaseWarnCtrl",e),e.$inject=["$scope","commonService","ngDialog","$jsTipTranslate","errHint","$timeout"]}(),angular.module("BC.controllers.dataSource").directive("copyDeployCode",["errHint","$timeout",function(e,a){return{link:function(t,i){a(function(){i.zclip({path:"/static/js/lib/jquery-ui/ZeroClipboard.swf",copy:function(){return t.deployCode},afterCopy:function(){var t=bdpChart.language||"zh";a(function(){e("zh"===t?"复制成功":"Copied")},0)}})},500)}}}]).controller("BAConfigController",["$stateParams","$scope","$rootScope","baService","databaseType","$location","ngDialog","errHint","$jsTipTranslate","dbTypeMap",function(e,a,t,i,s,n,r,o,d){function c(){a.baInfo.configList={1:!1,2:!1,3:!1}}function l(e,t){i.list({ds_id:e}).then(function(e){if(0===+e.status){var i=e.result;a.baInfo.name=i.name,a.baInfo.sites=i.info,t&&t(i.info[i.info.length-1])}})}t.view="database",t.show_bdp_header=!1;var h=e.dsId,u=bdpChart.language||"zh";a.configMap="zh"===u?{1:"URL防丟参",2:"通话事件监控",3:"自定义事件追踪"}:{1:"URL Reference Anti-lost",2:"Call Event Monitor",3:"Custom Event Tracking"},a.baInfo={activeTabIndex:0,sites:[],name:"",domain:"",configList:{1:!1,2:!1,3:!1}},a.setCheckStat=function(e){e&&(a.baInfo.configList[1]=!0)},a.baConfig={showAddDomain:function(){var e=a.baInfo.sites;return e.length>=50?(o(a.tips["ba.siteLimit50"]),!1):void(this.dialog1=r.open({template:"/static/partials/dialogTemplates/ba_add_domain.html",className:"ngdialog-theme-default ngDialog-width-400",scope:a}))},checkDomain:function(e){return e=e.trim(),e?bdp.verify.isUrl(e)||bdp.verify.isMonUrl(e)?/^https?:\/\//.test(e)?(o(a.tips["ba.siteError1"]),!1):/\/$/.test(e)?(o(a.tips["ba.siteError2"]),!1):!0:(o(a.tips["ba.siteError"]),!1):!1},saveDomain:function(e){a.global.clickComplete=!1;var t=this;if(e=e.trim(),!e)return o(a.tips["ba.siteNameNull"]),a.global.clickComplete=!0,!1;if(!t.checkDomain(e))return a.global.clickComplete=!0,!1;for(var s=a.baInfo.sites,n=0;n<s.length;n++)if(e===s[n].net_domain)return o(a.tips["ba.siteExisted"]),a.global.clickComplete=!0,!1;i.addDomain({ds_id:h,net_domain:e}).then(function(e){0===+e.status&&(a.global.clickComplete=!0,a.baInfo.domain="",r.close(t.dialog1),l(h,t.showFuncsModal))})},getStaCode:function(){i.getToken({ds_id:h}).then(function(e){if(0===+e.status){var t=encodeURIComponent(e.result);a.deployCode='<script>\nvar _bat = _bat || [];\n(function() {\nvar host = encodeURIComponent(location.host);\nvar ba = document.createElement("script");\nba.src = "//ba.bdp.cn/bdpxt.js?js_type=3&token='+t+'&host=" + host;\nvar s = document.getElementsByTagName("script")[0];\ns.parentNode.insertBefore(ba, s);\n})();\n</script>',this.dialog3=r.open({template:"/static/partials/dialogTemplates/ba_deploy_code.html",className:"ngdialog-theme-default ba-deploy-modal",scope:a})}})},showCase:function(){this.dialog4=r.open({template:"/static/partials/dialogTemplates/ba_deploy_case.html",className:"ngdialog-theme-default ba-deploy-modal",scope:a})},isChecking:{},checkDeploy:function(e){var t=this;if(this.isChecking[e.net_domain])return!1;this.isChecking[e.net_domain]=!0;for(var s=a.baInfo.sites,n=0;n<s.length;n++)if(e.net_domain===s[n].net_domain){s[n].status=0;break}i.checkDeploy({ds_id:h,net_domain:e.net_domain}).then(function(a){if(0===+a.status){t.isChecking[e.net_domain]=!1;for(var i=0;i<s.length;i++)if(e.net_domain===s[i].net_domain){s[i].status=a.result.status;break}}})},showFuncsModal:function(e){var t=e.config_list||[];c();for(var i=0;i<t.length;i++)a.baInfo.configList[t[i]]=!0;this.dialog2=r.open({template:"/static/partials/dialogTemplates/ba_funcs_config.html",className:"ngdialog-theme-default ba-funcs-modal",scope:a,data:{site:e}})},saveFuncs:function(e,a){var t=this,s=[];for(var n in e)e[n]&&s.push(+n);s.sort(function(e,a){return e-a}),i.updateConfig({ds_id:h,net_domain:a.net_domain,config_list:angular.toJson(s)}).then(function(e){0===+e.status&&(r.close(t.dialog2),c(),a.config_list=s)})},delDomain:function(e,t){confirm(a.tips["ba.sureToDelete"])&&i.delDomain({ds_id:h,net_domain:e.net_domain}).then(function(i){0===+i.status&&(o(a.tips["ba.deleteTipHead"]+e.net_domain+a.tips["ba.deleteTipTail"]),a.baInfo.sites.splice(t,1))})}},a.gotoPage=function(e){n.path(e)},h&&(l(h),d(["ba.sureToDelete","ba.deleteTipHead","ba.deleteTipTail","ba.siteNameNull","ba.siteExisted","ba.siteLimit50","ba.siteError","ba.siteError1","ba.siteError2"],a))}]),!function(){function e(e,a,t,i,s,n,r,o){e.init=function(){var t=new Date((new Date).getTime()-864e5);a.view="database_baidu_index",a.show_bdp_header=!1,e.searchPrice={cost:0,isCreate:0,limit:0},e.searchData={dsId:s.dsId,indexId:"create"==s.indexId?null:s.indexId,name:"",searchWords:"",error_keywords:[],searchWordsNum:0,regions:{},device:{pc:!1,wise:!1},startDate:t,queryAreaKey:null,showSearchArea:[],isShowSearchArea:!1},e.checkData={err_words:[],err_words_num:0,showCheckResult:!1,checkPass:!0},e.showDists={},e.showCitys={},e.getRegions()},e.$watch("searchData.searchWords",function(a,t){a!=t&&(e.searchData.searchWordsNum=e.getSearchWords().length,e.checkData.showCheckResult=!1)}),e.getRegions=function(){t.ds.baiduIndex().then(function(a){0==a.status&&(e.processRegionData(a.result),e.searchData.indexId&&e.getSearchConfig(e.searchData.indexId))})},e.processRegionData=function(a){var t=[];e.searchData.regions=a;for(var i=0,s=e.searchData.regions.length;s>i;i++){e.searchData.regions[i].selected=!1,e.searchData.regions[i].selectedHalf=!1,e.searchData.regions[i].count=0,0==i&&(e.searchData.regions[i].selected=!0);for(var n=0,r=e.searchData.regions[i].childs.length;r>n;n++)if(e.searchData.regions[i].childs[n].checked=!1,e.searchData.regions[i].childs[n].selected=!1,e.searchData.regions[i].childs[n].selectedHalf=!1,e.searchData.regions[i].childs[n].count=0,1==i&&0==n&&(e.searchData.regions[i].childs[n].selected=!0),null!=e.searchData.regions[i].childs[n].childs)for(var o=0,d=e.searchData.regions[i].childs[n].childs.length;d>o;o++)if(e.searchData.regions[i].childs[n].childs[o].checked=!1,e.searchData.regions[i].childs[n].childs[o].selected=!1,e.searchData.regions[i].childs[n].childs[o].selectedHalf=!1,e.searchData.regions[i].childs[n].childs[o].count=0,null!=e.searchData.regions[i].childs[n].childs[o].childs)for(var c=0,l=e.searchData.regions[i].childs[n].childs[o].childs.length;l>c;c++)e.searchData.regions[i].childs[n].childs[o].childs[c].checked=!1,e.searchData.regions[i].childs[n].childs[o].childs[c].selected=!1,e.searchData.regions[i].childs[n].childs[o].childs[c].selectedHalf=!1,t.push(e.searchData.regions[i].childs[n].childs[o].childs[c]),e.searchData.regions[i].childs[n].childs[o].childs[c].count=0;else 0==o&&0==n&&(e.searchData.regions[i].childs[n].selected=!0,e.showDists=e.searchData.regions[i].childs[n].childs)}e.showCitys=t},e.getSearchConfig=function(i){var s={index_id:i};a.pageLoading=!0,t.ds.baiduIndexConfig(s).then(function(t){a.pageLoading=!1,0==t.status&&e.processData(t.result)})},e.changeRegion=function(a){for(var t=e.searchData.regions.length-1;t>=0;t--)e.searchData.regions[t].selected=!1;e.searchData.regions[a].selected=!0,e.searchData.isShowSearchArea=!1},e.processData=function(a){var t=a;e.searchData.name=t.name,e.searchData.searchWords=t.key_words.join("\n");for(var i=!1,s=t.area_code.length-1;s>=0;s--){i=!1;for(var n=e.searchData.regions.length-1;n>=0;n--){for(var r=e.searchData.regions[n].childs.length-1;r>=0;r--)if(null!=e.searchData.regions[n].childs[r].childs)for(var o=e.searchData.regions[n].childs[r].childs.length-1;o>=0;o--){if(null!=e.searchData.regions[n].childs[r].childs[o].childs){for(var d=e.searchData.regions[n].childs[r].childs[o].childs.length-1;d>=0;d--)if(e.searchData.regions[n].childs[r].childs[o].childs[d].code==t.area_code[s]){e.searchData.regions[n].childs[r].childs[o].childs[d].checked=!0,i=!0;break}}else if(e.searchData.regions[n].childs[r].childs[o].code==t.area_code[s]){e.searchData.regions[n].childs[r].childs[o].checked=!0,i=!0;break}if(i)break}if(i)break}}e.checkedCitys(),e.checkedDists();for(var r=t.index_type.length-1;r>=0;r--)e.searchData.device[t.index_type[r]]=!0;t.start_time&&(e.searchData.startDate=t.start_time.split(" ")[0])},e.checkedAllCitys=function(a){for(var t=a.checked,i=a.childs.length-1;i>=0;i--)if(a.childs[i].checked=t,null!=a.childs[i].childs)for(var s=a.childs[i].childs.length-1;s>=0;s--)a.childs[i].childs[s].checked=t;e.checkedCitysNum(),e.checkedCitysHalf()},e.resetSelectedCitys=function(){for(var a=!1,t=e.searchData.regions[1].childs.length-1;t>=0;t--){e.searchData.regions[1].childs[t].selected=a;for(var i=e.searchData.regions[1].childs[t].childs.length-1;i>=0;i--)null!=e.searchData.regions[1].childs[t].childs[i].childs&&(e.searchData.regions[1].childs[t].childs[i].selected=a)}e.checkedCitysNum(),e.checkedCitysHalf()},e.showChangeRegion=function(a){var t=[];if(1==a)t=e.searchData.regions[1].childs[a].childs;else for(var i=0,s=e.searchData.regions[1].childs[a].childs.length;s>i;i++)for(var n=0,r=e.searchData.regions[1].childs[a].childs[i].childs.length;r>n;n++)t.push(e.searchData.regions[1].childs[a].childs[i].childs[n]);e.showCitys=t,e.resetSelectedCitys(),e.searchData.regions[1].childs[a].selected=!0,e.checkedCitysNum(),e.checkedCitysHalf()},e.showChangeCitys=function(a){e.showCitys=a.childs,e.resetSelectedCitys(),a.selected=!0,e.checkedCitysNum(),e.checkedCitysHalf()},e.checkedCitys=function(){for(var a=0,t=!0,i=!0,s=e.searchData.regions[1].childs.length-1;s>=0;s--){a=0,i=!0;for(var n=e.searchData.regions[1].childs[s].childs.length-1;n>=0;n--)if(t=!0,null!=e.searchData.regions[1].childs[s].childs[n].childs){for(var r=e.searchData.regions[1].childs[s].childs[n].childs.length-1;r>=0;r--)if(!e.searchData.regions[1].childs[s].childs[n].childs[r].checked){t=!1;break}t?(e.searchData.regions[1].childs[s].childs[n].checked=!0,a++):e.searchData.regions[1].childs[s].childs[n].checked=!1}else{if(!e.searchData.regions[1].childs[s].childs[n].checked){i=!1;break}a++}e.searchData.regions[1].childs[s].checked=a==e.searchData.regions[1].childs[s].childs.length?!0:!1}e.checkedCitysNum(),e.checkedCitysHalf()},e.checkedOneCitys=function(a){for(var t=a.childs.length-1;t>=0;t--)a.childs[t].checked=a.checked;e.showChangeCitys(a),e.checkedCitys(),e.checkedCitysNum(),e.checkedCitysHalf()},e.checkedAllRegionCitys=function(){for(var a=e.searchData.regions[1].childs.length-1;a>=0;a--)if(e.searchData.regions[1].childs[a].checked=!0,null!=e.searchData.regions[1].childs[a].childs)for(var t=e.searchData.regions[1].childs[a].childs.length-1;t>=0;t--)if(e.searchData.regions[1].childs[a].childs[t].checked=!0,null!=e.searchData.regions[1].childs[a].childs[t].childs)for(var i=e.searchData.regions[1].childs[a].childs[t].childs.length-1;i>=0;i--)e.searchData.regions[1].childs[a].childs[t].childs[i].checked=!0;e.checkedCitysNum(),e.checkedCitysHalf()},e.resetCheckedAllRegionCitys=function(){for(var a=e.searchData.regions[1].childs.length-1;a>=0;a--)if(e.searchData.regions[1].childs[a].checked=!1,null!=e.searchData.regions[1].childs[a].childs)for(var t=e.searchData.regions[1].childs[a].childs.length-1;t>=0;t--)if(e.searchData.regions[1].childs[a].childs[t].checked=!1,null!=e.searchData.regions[1].childs[a].childs[t].childs)for(var i=e.searchData.regions[1].childs[a].childs[t].childs.length-1;i>=0;i--)e.searchData.regions[1].childs[a].childs[t].childs[i].checked=!1;e.checkedCitysNum(),e.checkedCitysHalf()},e.checkedCitysNum=function(){var a=0,t=0;oneTypeCitysNum=0,foreignNum=0,isForeign=!1;for(var i=e.searchData.regions[1].childs.length-1;i>=0;i--)if(foreignNum=0,isForeign=!1,null!=e.searchData.regions[1].childs[i].childs){for(var s=e.searchData.regions[1].childs[i].childs.length-1;s>=0;s--)if(null!=e.searchData.regions[1].childs[i].childs[s].childs){oneTypeCitysNum=0;for(var n=e.searchData.regions[1].childs[i].childs[s].childs.length-1;n>=0;n--)e.searchData.regions[1].childs[i].childs[s].childs[n].checked&&(oneTypeCitysNum++,a++,t++);e.searchData.regions[1].childs[i].childs[s].count=oneTypeCitysNum}else isForeign=!0,e.searchData.regions[1].childs[i].childs[s].checked&&(foreignNum++,a++);e.searchData.regions[1].childs[i].count=isForeign?foreignNum:t}e.searchData.regions[1].count=a},e.checkedCitysHalf=function(){var a=0;allCitysNum=0,oneTypeCitysNum=0,foreignNum=0,isForeign=!1;for(var t=e.searchData.regions[1].childs.length-1;t>=0;t--)if(foreignNum=0,isForeign=!1,a=0,null!=e.searchData.regions[1].childs[t].childs){for(var i=e.searchData.regions[1].childs[t].childs.length-1;i>=0;i--)if(null!=e.searchData.regions[1].childs[t].childs[i].childs){oneTypeCitysNum=0;for(var s=e.searchData.regions[1].childs[t].childs[i].childs.length-1;s>=0;s--)e.searchData.regions[1].childs[t].childs[i].childs[s].checked&&(oneTypeCitysNum++,allCitysNum++),a++;e.searchData.regions[1].childs[t].childs[i].selectedHalf=oneTypeCitysNum>0&&oneTypeCitysNum<e.searchData.regions[1].childs[t].childs[i].childs.length?!0:!1}else isForeign=!0,e.searchData.regions[1].childs[t].childs[i].checked&&foreignNum++;e.searchData.regions[1].childs[t].selectedHalf=isForeign?foreignNum>0&&foreignNum<e.searchData.regions[1].childs[t].childs.length?!0:!1:allCitysNum>0&&a>allCitysNum?!0:!1}},e.resetSelectedDists=function(){for(var a=!1,t=e.searchData.regions[0].childs.length-1;t>=0;t--){e.searchData.regions[0].childs[t].selected=a;for(var i=e.searchData.regions[0].childs[t].childs.length-1;i>=0;i--)null!=e.searchData.regions[0].childs[t].childs[i].childs&&(e.searchData.regions[0].childs[t].childs[i].selected=a)}e.checkedDistsNum(),e.checkedDistsHalf()},e.showChangeDists=function(a){e.showDists=a.childs,e.resetSelectedDists(),a.selected=!0,e.checkedDistsNum(),e.checkedDistsHalf()},e.checkedDists=function(){for(var a=0,t=e.searchData.regions[0].childs.length-1;t>=0;t--)if(a=0,null!=e.searchData.regions[0].childs[t].childs){for(var i=e.searchData.regions[0].childs[t].childs.length-1;i>=0;i--)e.searchData.regions[0].childs[t].childs[i].checked&&a++;e.searchData.regions[0].childs[t].checked=a==e.searchData.regions[0].childs[t].childs.length?!0:!1}e.checkedDistsNum(),e.checkedDistsHalf()},e.checkedOneDists=function(a){for(var t=a.childs.length-1;t>=0;t--)a.childs[t].checked=a.checked;e.showChangeDists(a),e.checkedDists(),e.checkedDistsNum(),e.checkedDistsHalf()},e.checkedAllRegionDists=function(){for(var a=e.searchData.regions[0].childs.length-1;a>=0;a--)if(e.searchData.regions[0].childs[a].checked=!0,null!=e.searchData.regions[0].childs[a].childs)for(var t=e.searchData.regions[0].childs[a].childs.length-1;t>=0;t--)e.searchData.regions[0].childs[a].childs[t].checked=!0;e.checkedDistsNum(),e.checkedDistsHalf()},e.resetCheckedAllRegionDists=function(){for(var a=e.searchData.regions[0].childs.length-1;a>=0;a--)if(e.searchData.regions[0].childs[a].checked=!1,null!=e.searchData.regions[0].childs[a].childs)for(var t=e.searchData.regions[0].childs[a].childs.length-1;t>=0;t--)e.searchData.regions[0].childs[a].childs[t].checked=!1;e.checkedDistsNum(),e.checkedDistsHalf()},e.checkedDistsNum=function(){for(var a=0,t=0,i=e.searchData.regions[0].childs.length-1;i>=0;i--){if(t=0,null!=e.searchData.regions[0].childs[i].childs)for(var s=e.searchData.regions[0].childs[i].childs.length-1;s>=0;s--)e.searchData.regions[0].childs[i].childs[s].checked&&(t++,a++);e.searchData.regions[0].childs[i].count=t}e.searchData.regions[0].count=a},e.checkedDistsHalf=function(){for(var a=0,t=e.searchData.regions[1].childs.length-1;t>=0;t--)if(a=0,null!=e.searchData.regions[1].childs[t].childs){for(var i=e.searchData.regions[1].childs[t].childs.length-1;i>=0;i--)e.searchData.regions[1].childs[t].childs[i].checked&&a++;e.searchData.regions[1].childs[t].selectedHalf=a>0&&a<e.searchData.regions[1].childs[t].childs.length?!0:!1}},e.changeSearchArea=function(){var a=e.searchData.regions[0].selected?0:1,t=[];if(e.searchData.isShowSearchArea=!0,e.searchData.queryAreaKey&&e.searchData.queryAreaKey.trim()){e.searchData.showSearchArea=[];for(var i=0,s=e.searchData.regions[a].childs.length;s>i;i++)if(null!=e.searchData.regions[a].childs[i].childs)for(var n=0,r=e.searchData.regions[a].childs[i].childs.length;r>n;n++)if(null!=e.searchData.regions[a].childs[i].childs[n].childs)for(var o=0,d=e.searchData.regions[a].childs[i].childs[n].childs.length;d>o;o++)e.searchData.regions[a].childs[i].childs[n].childs[o].name.indexOf(e.searchData.queryAreaKey.trim())>-1&&t.push(e.searchData.regions[a].childs[i].childs[n].childs[o]);else e.searchData.regions[a].childs[i].childs[n].name.indexOf(e.searchData.queryAreaKey.trim())>-1&&t.push(e.searchData.regions[a].childs[i].childs[n])}e.searchData.showSearchArea=t,0!=t.length||e.searchData.queryAreaKey&&e.searchData.queryAreaKey.trim()||(e.searchData.isShowSearchArea=!1)},e.clearSearchWords=function(){e.searchData.searchWords=""},e.checkKeyWords=function(i){var s=e.getSearchWords();if(s.length>0){var n=bdp.utils.arrayUnique(s);if(e.searchData.searchWords=n.join("\n"),n.length>20)return void r("关键词数量超过20，请修改后重试");if(d())return void r("存在超过字符限制的关键词，请修改后重试");a.pageLoading=!0;var o={key_words:angular.toJson(n)};t.ds.baiduIndexCheckKeyWords(o).then(function(t){if(a.pageLoading=!1,0==t.status)if(1==+t.result.status){var s=t.result.error_keywords;s.length>0?(e.checkData={showCheckResult:!0,checkPass:!1,err_words:s,err_words_num:s.length},"save"==i&&r("存在未被百度指数收录的关键词，请修改或删除")):"save"==i?e.searchBudget():e.checkData={showCheckResult:!0,checkPass:!0}}else r(t.result.error_message)})}else r("无可检查的关键词，请添加关键词后重试")},e.clearErrKeyWords=function(){for(var a=e.checkData.err_words,t=e.getSearchWords(),i=0,s=a.length;s>i;i++){var n=$.inArray(a[i],t);n>-1&&t.splice(n,1)}e.searchData.searchWords=t.join("\n")},e.save=function(){e.checkSearch()&&e.checkKeyWords("save")},e.searchBudget=function(){t.ds.modifyDbBaiduIndex(e.getSearchParam(0)).then(function(a){if(0==a.status)if(e.searchPrice={cost:a.result.cost,limit:a.result.limit},a.result.isCreate){var t="ngDialog-width-370";i.open({template:"/static/partials/dialogTemplates/baidu_index_budget.html",className:"ngdialog-theme-default "+t,scope:e})}else e.baiduSearch()})};var d=function(){for(var a=e.getSearchWords(),t=0,i=a.length;i>t;t++)if(a[t].trim().length>100)return!0};e.checkSearch=function(){return e.searchData.name&&e.searchData.name.trim().length>0?e.searchData.name&&e.searchData.name.trim().length>30?(r("名称长度最大为30个字符，请修改后重试"),!1):e.searchData.searchWords&&e.searchData.searchWords.trim().length>0?bdp.utils.arrayUnique(e.getSearchWords()).length>20?(r("关键词数量超过20，请修改后重试"),!1):d()?(r("存在超过字符限制的关键词，请修改后重试"),!1):e.getCheckedCitys().length<=0?(r("监控地域至少选择一个"),!1):e.searchData.device.pc||e.searchData.device.wise?c()?!1:!0:(r("监控设备至少选择一个"),!1):(r("搜索词不能为空"),!1):(r("名称不能为空"),!1)};var c=function(){var a=l();return 0>=a?(r(e.tips["ds.plzSelectBeforeToday"]),!0):!1},l=function(){var a=0,t=new Date(e.searchData.startDate).getTime(),i=(new Date).getTime();return a=parseInt((i-t)/864e5)};e.getSearchWords=function(){for(var a=e.searchData.searchWords.split("\n"),t=[],i=0,s=a.length;s>i;i++)a[i]&&a[i].trim().length>0&&t.push(a[i]);return t};var h=function(e){var a=new Date,t=a.getMonth()+1;a.getDate(),require_month=10>t-3?"0"+(t-3):t-3;var i=Highcharts.dateFormat("%Y-%m-%d",a).replace(/(-.{2}\-)/,"-"+require_month+"-");return e.getTime()<new Date(i).getTime()?i:Highcharts.dateFormat("%Y-%m-%d",e)};e.getSearchParam=function(a){var t={db_type:53,modify:a,ds_id:e.searchData.dsId,index_id:e.searchData.indexId,name:e.searchData.name};t.start_time=h(new Date(e.searchData.startDate));for(var i=e.searchData.searchWords.split("\n"),s=0,n=i.length;n>s;s++)i[s]=i[s].trim();t.key_words=angular.toJson(i);var r=e.getCheckedCitys();t.area_code=angular.toJson(r);var o=[];return e.searchData.device.pc&&o.push("pc"),e.searchData.device.wise&&o.push("wise"),t.index_type=angular.toJson(o),t},e.getCheckedCitys=function(){for(var a=[],t=e.searchData.regions.length-1;t>=0;t--)for(var i=e.searchData.regions[t].childs.length-1;i>=0;i--)if(null!=e.searchData.regions[t].childs[i].childs)for(var s=e.searchData.regions[t].childs[i].childs.length-1;s>=0;s--)if(null!=e.searchData.regions[t].childs[i].childs[s].childs)for(var n=e.searchData.regions[t].childs[i].childs[s].childs.length-1;n>=0;n--)e.searchData.regions[t].childs[i].childs[s].childs[n].checked&&a.push(e.searchData.regions[t].childs[i].childs[s].childs[n].code);
else e.searchData.regions[t].childs[i].childs[s].checked&&a.push(e.searchData.regions[t].childs[i].childs[s].code);return a},e.baiduSearch=function(){a.pageLoading=!0,e.searchData.indexId?t.ds.modifyDbBaiduIndex(e.getSearchParam(1)).then(function(t){0==t.status&&n.path("/database_baidu_index_list/"+e.searchData.dsId),a.pageLoading=!1}):t.ds.createDbBaiduIndexTask(e.getSearchParam()).then(function(t){0==t.status&&n.path("/database_baidu_index_list/"+e.searchData.dsId),a.pageLoading=!1})},e.init(),o(["ds.plzSelectBeforeToday"],e)}angular.module("BC.controllers.database").controller("databaseBaiduIndexCtrl",e),e.$inject=["$scope","$rootScope","commonService","ngDialog","$stateParams","$location","errHint","$jsTipTranslate"]}(),!function(){function e(e,a,t,i,s,n,r,o){function d(){var i={ds_id:e.baiduIndexDsConfig.ds_id};a.pageLoading=!0,t.ds.getDbBaiduIndexTaskList(i).then(function(t){if(a.pageLoading=!1,0==t.status){var i=t.result;e.baiduIndexDsConfig.day_cost=i.day_cost,e.baiduIndexDsConfig.balance=i.balance,e.baiduIndexDsConfig.word_count=i.word_count,e.baiduIndexRrError=i.rt_error,e.baiduIndexDsConfig.tbId=i.tb_id,e.baiduIndexDsConfig.is_limit=i.is_limit,i.is_empty?e.baiduIndexDsConfig.baiduIndexTaskList=[]:(e.baiduIndexDsConfig.baiduIndexTaskList=i.in_list,e.noTask=e.baiduIndexDsConfig.baiduIndexTaskList.length>0?!1:!0)}})}function c(i){var s={ds_id:e.baiduIndexDsConfig.ds_id,index_id:i.index_id};t.ds.deleteDbBaiduIndexTask(s).then(function(t){"0"==t.status?(a.pageLoading=!1,d(),r(e.tips["ds.delBaiduSearchTaskSuccess"])):r(t.errstr)})}e.init=function(){e.baiduIndexDsConfig={ds_id:s.dsId,day_cost:0,balance:0,word_count:0,baiduSearchTaskList:[],is_limit:0,tbId:null},o(["ds.stopBaiduSearchTaskSuccess","ds.startBaiduSearchTaskSuccess","ds.delBaiduSearchTaskSuccess","ds.startSyncTaskSuccess","ds.confirmToDelTask","ds.confirmToStopTask","ds.confirmToStartTask"],e),d(),e.baiduSearchRrError="",a.view="database_baidu_index_list",a.show_bdp_header=!1},e.init(),e.back=function(){for(var e,t=a.historyTime,i=t.length-1;i>=0;i--)if("/database"==t[i]||"/database_list"==t[i]){e=t[i];break}n.path(e||"/database")},e.add_baidu_data=function(){e.baiduIndexDsConfig.is_limit?r("每天最多添加或编辑5个查询任务"):n.path("database_baidu_index/"+e.baiduIndexDsConfig.ds_id+"/create")},e.getSearchConfig=function(a){e.baiduIndexDsConfig.is_limit?r("每天最多添加或编辑5个查询任务"):0==a.is_pause&&3==a.status?r("当前子任务正在同步中"):n.path("database_baidu_index/"+e.baiduIndexDsConfig.ds_id+"/"+a.index_id)},e.showIntroduction=function(){i.open({template:"/static/partials/dialogTemplates/baidu_index_introduction.html",scope:e,className:"ngdialog-theme-default ngdialog.ngDialog-width-420"})};var l="_websocketChartMessage_";e.$on(l,function(a,t){var i="string"==typeof t.data?$.parseJSON(t.data):t.data;if(7==i.type){console.log(i);for(var s=0,n=e.baiduIndexDsConfig.baiduIndexTaskList.length;n>s;s++)e.baiduIndexDsConfig.baiduIndexTaskList[s].index_id==i.index_id&&(e.baiduIndexDsConfig.baiduIndexTaskList[s].status=i.status);e.$apply()}}),e.baiduIndexTaskContrl=function(s,n){i.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:0==n?e.tips["ds.confirmToStartTask"]+s.name+"?":e.tips["ds.confirmToStopTask"]+s.name+"?"}}).then(function(){var i={ds_id:e.baiduIndexDsConfig.ds_id,index_id:s.index_id,is_pause:n};a.pageLoading=!0,t.ds.modifyDbBaiduIndexTask(i).then(function(t){"0"==t.status?(a.pageLoading=!1,s.is_pause=+t.result.is_pause,r(+t.result.is_pause?e.tips["ds.stopBaiduSearchTaskSuccess"]:e.tips["ds.startBaiduSearchTaskSuccess"])):r(t.errstr)})})},e.confirmToDelTask=function(a){i.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:e.tips["ds.confirmToDelTask"]+a.name+"?"}}).then(function(){c(a)})}}angular.module("BC.controllers.database").controller("databaseBaiduIndexListCtrl",e),e.$inject=["$scope","$rootScope","commonService","ngDialog","$stateParams","$location","errHint","$jsTipTranslate","$timeout"]}(),!function(){function e(e,a,t,i,s,n,r){function o(e){return/\.csv$/.test(e)}function d(){var a=e.csvData.value;return"other"==a&&(a=e.csvData.otherValue,a.length>1)?(i(e.tips["upload.onlyOneDelimiter"]),!1):a?(e.csvData.value=a,e.csvData.hasSet=!0,void u()):(i(e.tips["upload.csvDesc"]),!1)}function c(){e.pwdBatchData.viewType="init",e.csvData.value="comma",e.csvData.otherValue=""}function l(){angular.element("#upload_pwd_file").click()}function h(){return e.uploadFileData.localFile?void(e.uploadFileData.name=e.uploadFileData.localFile.name):void(e.uploadFileData.name="")}function u(){var a=e.uploadFileData.localFile;a&&(a.upload=n.upload({url:"/api/ds_batch/upload",method:"POST",data:{file:a,key:a.name,"Content-Type":null===a.type||""===a.type?"application/octet-stream":a.type,filename:a.name,field_terminate:/\.csv$/.test(a.name)?e.csvData.value:void 0}}),a.upload.then(function(a){0==a.data.status?f(a.data.result):(e.pwdBatchData.errStr=a.data.errstr||e.tips["ds.uploadFailed"],e.pwdBatchData.viewType="error")},function(a){e.pwdBatchData.errStr=a.data.errstr||e.tips["ds.uploadFailed"],e.pwdBatchData.viewType="error"},function(a){angular.element(s).find(".ngdialog-content").width(420),e.pwdBatchData.viewType="uploading",Math.min(100,parseInt(100*a.loaded/a.total))}))}function p(){var a=e.uploadFileData.localFile;a&&(o(a.name)?(e.pwdBatchData.viewType="csv",angular.element(s).find(".ngdialog-content").width(420)):u())}function f(t){var i=t;i.db_type=b,e.pwdBatchData.pwdStatusMap={},a.ds.pwdBatchPreview(i).then(function(a){if(e.isRequesting=!1,0==a.status){if(a.result[0].errmsg)return e.pwdBatchData.errStr=a.result[0].errmsg,void(e.pwdBatchData.viewType="error");var t=a.result;e.pwdBatchData.pwdPreviewList.tbHead=t.shift(),e.pwdBatchData.pwdPreviewList.tbHead.pop(),e.pwdBatchData.pwdPreviewList.tbBody=[],angular.forEach(t,function(a){a.uniqId=y++,e.pwdBatchData.pwdStatusMap[a.uniqId]=a.pop(),e.pwdBatchData.pwdPreviewList.tbBody.push(a)}),e.pwdBatchData.fileData={total:0,wrong:0,noExist:0};for(var i in e.pwdBatchData.pwdStatusMap)e.pwdBatchData.fileData.total++,2==e.pwdBatchData.pwdStatusMap[i]&&e.pwdBatchData.fileData.wrong++,3==e.pwdBatchData.pwdStatusMap[i]&&e.pwdBatchData.fileData.noExist++;e.pwdBatchData.viewType="success",angular.element(s).find(".ngdialog-content").width(520),e.pwdBatchData.hasInvalidPwd=!1;for(var i in e.pwdBatchData.pwdStatusMap)1!=e.pwdBatchData.pwdStatusMap[i]&&(e.pwdBatchData.hasInvalidPwd=!0);e.$$phase||e.$digest()}else e.pwdBatchData.errStr=a.errstr||e.tips["ds.uploadFailed"],e.pwdBatchData.viewType="error"})}function g(){var t=[];t.push(e.pwdBatchData.pwdPreviewList.tbHead),t=t.concat(e.pwdBatchData.pwdPreviewList.tbBody);var s={db_type:b,ds_list_info:angular.toJson(t)};e.isRequesting=!0,a.ds.pwdBatchModify(s).then(function(a){e.isRequesting=!1,0==a.status?(i(e.tips.saveSuccess),r.closeAll()):i(+a.status,{warn_msg:a.errstr})})}function m(a,t){e.pwdBatchData.pwdPreviewList.tbBody.splice(t,1),delete e.pwdBatchData.pwdStatusMap[a.uniqId],e.pwdBatchData.hasInvalidPwd=!1;for(var i in e.pwdBatchData.pwdStatusMap)1!=e.pwdBatchData.pwdStatusMap[i]&&(e.pwdBatchData.hasInvalidPwd=!0)}var b=e.ngDialogData.dbType,_=e.ngDialogData.pwdBatch;e.isRequesting=!1,e.twoColsType=[],e.threeColsType=[],e.pwdBatchData={},e.uploadFileData={name:"",localFile:"",acceptTypes:"text/csv,*.xls,*.xlsx,.csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"};var y=(new Date).getTime();e.initView=function(){e.csvData={value:"comma",otherValue:""},e.pwdBatchData={viewType:"init",dbType:b,errStr:"",fileData:{total:0,wrong:0,noExist:0},pwdBatchExample:_,pwdPreviewList:{tbHead:[],tbBody:[]},pwdStatusMap:{},hasInvalidPwd:!1,selectPwdFile:l,changePwdFiles:h,uploadPwdFiles:p,pwdBatchModify:g,delPwd:m,saveSetCsv:d,cancelSetCsv:c},e.tableColWidthStyle={width:100/e.pwdBatchData.pwdBatchExample.cols.length+"%"}},e.initView(),t(["ds.uploadFailed","saveSuccess","upload.onlyOneDelimiter","upload.csvDesc"],e)}angular.module("BC.controllers.database").controller("databasePwdBatchCtrl",e),e.$inject=["$scope","commonService","$jsTipTranslate","errHint","$element","Upload","ngDialog"]}(),angular.module("BC.controllers.database").controller("databaseSyncSetCtrl",r),r.$inject=["$rootScope","$scope","commonService","databaseSyncTime","errHint","$timeout","ngDialog","$jsTipTranslate"],!function(){angular.module("BC.directives").directive("dbConnectInfo",["$templateCache","commonHttp","$compile",function(){function e(e,a,t,i){function s(){var a=angular.copy(e.connectInfo),t=e.dbTypeInfo.db_type;if(delete a.init,a.db_type=t,9==t){var i=[];angular.forEach(e.dbTypeInfo.target,function(e){e.value&&i.push(e.key)}),a.target=angular.toJson(i)}return a}e.next=function(){var a=e.dbTypeInfo;(-1==[40,58,61].indexOf(a.db_type)||a.authorization)&&(60!=a.db_type||a.protocolAgreed)&&e.$broadcast("verifyForm")},e.connect=function(){var a=s(),t=e.dbTypeInfo.db_type;-1!=[40,58,61].indexOf(t)?e.$emit("nextStep",a):48==t?e.$broadcast("gaConn"):(e.viewData.loading=!0,i.ds.conn(a).then(function(t){0==t.status&&e.$emit("nextStep",a),e.viewData.loading=!1}))},t(["ds.apiUserName","ds.requireApiPassword","ds.requireApiToken","ds.apiStartDate","ds.hostRequire","ds.portRequire","ds.databaseRequire","ds.apiSiteId","ds.websiteRequire","ds.catPwdRequire","ds.monitorWebsiteRequire","ds.transformSettingRequire"],e)}var a={templateUrl:"/static/database/partials/database_connect_info.html",restrict:"EA",replace:!1,scope:!0,controller:e};return e.$inject=["$scope","errHint","$jsTipTranslate","commonService","Upload"],a}])}(),!function(){angular.module("BC.directives").directive("dbBaseInfo",["$templateCache","commonHttp","$compile",function(e,a,t){function i(e,i,s){var n=e.dbInfo.param_category;e.mode=s.mode,a.get("/static/database/partials/database_baseInfo_"+n+".html").then(function(a){i.replaceWith(t(a)(e))})}function s(e,a,t,i,s,n,i,r){function o(){if(-1!=[40,58,61].indexOf(e.dbInfo.db_type)){var a=location.href.match(/https?:\/\/.*?\//)[0],t=a+"static/database/view/authorization.html",i=$.cookie("user_id")+"_"+e.dbInfo.db_type;alipayId="https://me.bdp.cn/"==a?0x729a4b9a83431:0x729a4b3b17937;var s=40==e.dbInfo.db_type?1000004:alipayId,n=40==e.dbInfo.db_type?"&r_url=":"&redirect_uri=",r=40==e.dbInfo.db_type?"https://login.huoban.com/login?app_id=":"https://openauth.alipay.com/oauth2/appToAppAuth.htm?app_id=";e.oAuthUrl=r+s+n+t+"&state="+i,e.dbInfo.authorization=!1,e.dbInfo.authorizeTip=e.tips["ds.authorizeTip"]}}function d(){var a=e.dbInfo,t=angular.fromJson(e.param.target);angular.forEach(a.target,function(e){e.value=$.inArray(e.key,t)>-1?!0:!1})}function c(t,i){var s,n=e.dbInfo.db_type;return t.username?t.password?1!=i||t.token?!0:(s="ds.requireApiToken",[35,23].indexOf(n)>-1&&(s="ds.apiComId"),a(e.tips[s]),!1):(s="ds.requireApiPassword",[35].indexOf(n)>-1&&(s="ds.apiAppSecret"),a(e.tips[s]),!1):(s="ds.apiUserName",[35].indexOf(n)>-1&&(s="ds.apiAppId"),a(e.tips[s]),!1)}function l(t){return t.host?t.port?t.username?t.password?t.database?!0:(a(e.tips["ds.databaseRequire"]),!1):(a(e.tips["ds.requireApiPassword"]),!1):(a(e.tips["ds.apiUserName"]),!1):(a(e.tips["ds.portRequire"]),!1):(a(e.tips["ds.hostRequire"]),!1)}function h(t){var i=e.dbInfo.db_type;if(9==i){if(!t.login_url)return a(e.tips["ds.websiteRequire"]),!1;if(!t.password)return a(e.tips["ds.catPwdRequire"]),!1;if(!t.monitor_url)return a(e.tips["ds.monitorWebsiteRequire"]),!1;var s=0;if(angular.forEach(e.dbInfo.target,function(e){e.value&&s++}),0==s)return a(e.tips["ds.transformSettingRequire"]),!1}if(23==i){if(!t.token)return a(e.tips["ds.apiComId"]),!1;if(!t.username)return a(e.tips["ds.apiCustomID"]),!1;if(!t.password)return a(e.tips["ds.requireApiPassword"]),!1}if(32==i){if(!t.site_id)return a(e.tips["ds.apiSiteId"]),!1;if(!t.password)return a(e.tips["ds.requireApiPassword"]),!1}if(16==i){if(!t.compId)return a(e.tips["ds.apiComId"]),!1;if(!e.url&&"modify"!=e.mode)return a(e.tips["ds.generateLink"]),!1;if(!t.ak)return a(e.tips["ds.apiAppKey"]),!1;if(!t.ase)return a(e.tips["ds.apiAppSecret"]),!1;if(!t.at)return a(e.tips["ds.apiAppToken"]),!1;if(!t.url)return a(e.tips["ds.apiUrl"]),!1;if(!bdp.verify.url().test(t.url))return a(e.tips["ds.apiUrlFormat"]),!1}if(56==i){if(!t.appkey)return a(e.tips["ds.apiAppKey"]),!1;if(!t.secret)return a(e.tips["ds.gySecret"]),!1;if(!t.sessionkey)return a(e.tips["ds.gySessionKey"]),!1}if(19==i){if(!t.comp_id)return a(e.tips["ds.apiKst"]),!1;if(!t.baseurl)return a(e.tips["ds.apiBaseUrl"]),!1;if(!t.app_id)return a(e.tips["ds.apiAppId"]),!1;if(!t.app_secret)return a(e.tips["ds.apiAppSecret"]),!1;if(!t.signkey)return a(e.tips["ds.apiSignKey"]),!1}if(55==i){if(!t.client_id)return a(e.tips["ds.ioClientId"]),!1;if(!t.password)return a(e.tips["ds.ioPrivateKey"]),!1;if(!t.project_id)return a(e.tips["ds.ioProject"]),!1;if(!t.ai)return a(e.tips["ds.ioAi"]),!1}if(48==i){if(!t.service_account_email)return a("请输入谷歌账户"),!1;if(!t.file)return a("请上传文件"),!1;if(!t.view_id)return a("请输入数据源视图ID"),!1}if(57==i){if(!t.appid)return a(e.tips["ds.wxAppIdRequired"]),!1;if(!t.mch_id)return a(e.tips["ds.wxShopIdRequired"]),!1;if(!t.key)return a(e.tips["ds.wxKeyRequired"]),!1}if(60==i){if(!t.enterprise_id)return a(e.tips["ds.enterprise_idRequired"]),!1;if(!t.app_id)return a(e.tips["ds.app_idRequired"]),!1;if(!t.sign)return a(e.tips["ds.signRequired"]),!1}return!0}function u(t){var i=e.dbInfo.db_type;return 40!=i||t.database?!0:(a(e.tips["ds.requireWorkSpace"]),!1)}function p(){var a=e.param,t=e.dbInfo.param_category;return!(1!=t&&2!=t||c(a,t))||0==t&&!l(a)||3==t&&!h(a)||4==t&&!u(a)?!1:!0}function f(){i.ds.jyw_klist().then(function(a){0==a.status&&(e.jywKlist=a.result,"modify"==e.mode&&e.$watch("param",function(a){a&&angular.forEach(e.jywKlist,function(t){t.comp_id==a.comp_id&&(e.kst=t.name)})}))})}function g(){$("#h_url").zclip({path:"/static/js/lib/jquery-ui/ZeroClipboard.swf",copy:function(){return e.param.hurl},afterCopy:function(){n(function(){a(e.tips["user.copySuccess"])},0)}}),$("#v_url").zclip({path:"/static/js/lib/jquery-ui/ZeroClipboard.swf",copy:function(){return e.parm.vurl},afterCopy:function(){n(function(){a(e.tips["user.copySuccess"])},0)}})}function m(){n(function(){var a=0,t=$($(".form-layer")[a]).height();$(".form-desc").height(t),e.usageHeight=t},0)}e.dbInfo.target=[{key:-1,label:"ds.pageGoal",value:!0},{key:-2,label:"ds.actionGoal",value:!1},{key:-3,label:"ds.timeGoal",value:!1},{key:-4,label:"ds.viewPageGoal",value:!1}],n(function(){o(),60==e.dbInfo.db_type&&(e.dbInfo.protocolAgreed=!1)},10),e.acceptTypes=".p12",19==e.dbInfo.db_type&&f(),e.$on("initData",function(a){if(a){var t=e.dbInfo;9==t.db_type&&"modify"==e.mode&&d()}}),e.$on("verifyForm",function(){if(p()){if("modify"!=e.mode&&Number(e.dbInfo.extend.verify_account)){var a=angular.copy(e.param);return delete a.init,a.db_type=e.dbInfo.db_type,i.ds.username_verify(a).then(function(a){0==a.status&&e.goOn()})}e.goOn()}}),e.$on("gaConn",function(){var t=e.dbInfo,i=e.param;e.loading=!0,r.upload({url:"/api/ds/conn",method:"POST",data:{db_type:t.db_type,service_account_email:i.service_account_email,view_id:i.view_id,"Content-Type":null===i.file.type||""===i.file.type?"application/octet-stream":i.file.type,key_file_name:"key_file_content",key_file_content:i.file}}).then(function(s){e.loading=!1;var n=s.data;if(0!=n.status)a(+n.status,{warn_msg:n.errstr});else if("modify"!=e.mode){var r={db_type:t.db_type,service_account_email:i.service_account_email,view_id:i.view_id};e.$emit("nextStep",r)}else e.$emit("connectSuccess")},function(){})}),e.url=!1,e.edit_status=0,e.getUrl=function(){e.kst_compid_input=$(".kst-compid-input");var t=e.param;return t.compId?(e.loading=!0,void i.ds.kstList({compId:t.compId}).then(function(a){if(e.loading=!1,0==a.status){e.kst_compid_input.attr("readonly","true"),e.kst_compid_input.css("box-shadow","none"),e.url=!0;var i=a.result;t.hurl=i.hurl,t.vurl=i.vurl,0==$(".zclip").length&&n(function(){g()},1e3)}})):void a(e.tips["ds.apiComId"])},e.modify=function(a){"edit"==a?(e.old=e.param.compId,e.edit_status=1,e.kst_compid_input.removeAttr("readonly"),e.kst_compid_input.css("box-shadow","0 -1px 0 0 rgba(81, 130, 228, 0.6) inset")):("quit"==a&&(e.param.compId=e.old),e.kst_compid_input.attr("readonly","true"),e.kst_compid_input.css("box-shadow","none"),e.edit_status=0,e.getUrl())};var b="_websocketChartMessage_";e.$on(b,function(a,t){var i="string"==typeof t.data?$.parseJSON(t.data):t.data;if(-1!=[40,58,61].indexOf(e.dbInfo.db_type)&&6==i.type&&0==i.status){if(40==e.dbInfo.db_type)e.param.token=i.ticket,e.param.refresh_ticket=i.refresh_ticket||"","modify"!=e.mode?m():e.$emit("conn");else if(-1!=[58,61].indexOf(e.dbInfo.db_type)){e.param.code=i.app_auth_code;var s={code:i.app_auth_code,db_type:e.dbInfo.db_type};"modify"!=e.mode?e.$emit("nextStep",s):e.$emit("conn")}e.dbInfo.authorization=!0,e.dbInfo.authorizeLoading=!1,e.$apply()}}),t(["ds.apiUserName","ds.generateLink","ds.requireApiPassword","ds.requireApiToken","ds.apiStartDate","ds.hostRequire","ds.portRequire","ds.databaseRequire","ds.apiSiteId","ds.websiteRequire","ds.catPwdRequire","ds.monitorWebsiteRequire","ds.transformSettingRequire","ds.apiComId","user.copySuccess","ds.apiKst","ds.apiUrl","ds.apiAppId","ds.apiAppSecret","ds.apiSignKey","ds.apiAppKey","ds.apiAppSecret","ds.apiAppToken","ds.apiUrlFormat","ds.apiBaseUrl","ds.requireWorkSpace","ds.ioClientId","ds.ioPrivateKey","ds.ioProject","ds.ioAi","ds.apiCustomID","ds.authorizeTip","ds.wxAppIdRequired","ds.wxShopIdRequired","ds.wxKeyRequired","ds.gySecret","ds.gySessionKey","ds.enterprise_idRequired","ds.app_idRequired","ds.signRequired"],e)}var n={link:i,restrict:"EA",replace:!1,scope:{dbInfo:"=",param:"=",goOn:"&",loading:"="},controller:s};return s.$inject=["$scope","errHint","$jsTipTranslate","commonService","ngDialog","$timeout","commonService","Upload"],n}])}(),!function(){function e(){function e(e,a,t){function i(){var i,s=!!t.readonly;i=CodeMirror.fromTextArea(a[0],{mode:"text/x-bdp-sql",indentWithTabs:!0,smartIndent:!0,lineWrapping:!0,matchBrackets:!0,readOnly:s?"nocursor":!1,theme:"paraiso-light",fields:e.fields,placeholder:t.p?t.p:"SUM([A]) + SUM([B])"}),i.setValue(e.report.where.expression),e.gaInfo.updataSqlVal=function(){i.setValue(e.report.where.expression)},s||(i.on("change",function(){e.report.where.expression=i.getValue().replace(/0xa0/,"")}),e.insert=function(e){i.replaceSelection(e),i.focus()},e.setCursor=function(e){var a=i.getCursor(),t=a.ch-e;i.setCursor(a.line,t)})}var s={funcQueue:[],loadLibInProgress:!1};thirdPluginLoader({initFun:i,libSrc:"https://m1.bdp.cn/static/js/lib/bdpFormula/bdp-codemirror_4fc5c0e.js",otherSrc:"",libId:window.CodeMirror},s)}return{restrict:"A",link:e}}angular.module("BC.directives").directive("dbTableList",["$templateCache","commonHttp","$compile",function(){function e(e,a,t,i,s,n,r){function o(){var a=e.report;if(reprot=$.trim(a.name),!a.name)return n(r.instant("ds.reportNameRequire")),!1;if(/\s/.test(a.name))return n(r.instant("ds.reportNameHasEmpty")),!1;var t=!1,i=e.gaInfo;return angular.forEach(e.tableList,function(e,s){("modify"==i.mode&&i.index!=s||"add"==i.mode)&&e.name==a.name&&(t=!0)}),t?(n(r.instant("ds.reportNameRepeat")),!1):"date"==a.granularity&&a.dimensions.length>6?(n(r.instant("ds.reportDimensionLimt6")),!1):"hour"==a.granularity&&a.dimensions.length>5?(n(r.instant("ds.reportDimensionLimt5")),!1):"minute"==a.granularity&&a.dimensions.length>4?(n(r.instant("ds.reportDimensionLimt4")),!1):0==a.metrics.length?(n(r.instant("ds.reportMetricRequire")),!1):a.metrics.length>10?(n(r.instant("ds.reportMetricLimit10")),!1):!0}function d(){var a,t,i=e.report,s={};if("condition"==i.where.where_type){var n=e.reportInfo;addFilter=angular.copy(n.addFilter),addFilter.field.id&&addFilter.operator.value&&addFilter.expression&&(i.where.filters.push(addFilter),n.addFilter={field:{},operator:{},expression:""}),a=angular.copy(i.where.filters)}else a=$.trim(i.where.expression);return t=angular.copy(i),t.where.filters=angular.copy(a),angular.extend(s,e.param),s.report=angular.toJson(t),s}function c(a){function t(){var a=e.reportView,t=e.report;angular.forEach(e.reportInfo.granularity,function(e){e.type==t.granularity&&(a.granularity.name=e.name,a.granularity.type=e.type)})}e.report={name:"",granularity:"date",dimensions:[],metrics:[],segment:{},where:{where_type:"condition",where_linker:"and",filters:[],expression:""},include_empty_rows:!0,samplingLevel:"DEFAULT"},e.reportInfo={granularity:[{name:"按日",type:"date"},{name:"按时",type:"hour"},{name:"按分",type:"minute"}],operatorList:{metric:[{name:"等于",value:"=="},{name:"不等于",value:"!="},{name:"大于",value:">"},{name:"小于",value:"<"},{name:"大于或等于",value:">="},{name:"小于或等于",value:"<="}],dimension:[{name:"完全匹配",value:"=="},{name:"包含子字符串",value:"=@"},{name:"不包含子字符串",value:"!@"},{name:"包含与正则表达式匹配的内容",value:"=~"},{name:"与正则表达式不匹配",value:"!~"},{name:"不匹配",value:"!="}]},samplingLevel:[{type:"DEFAULT",name:e.tips["default"]},{type:"FASTER",name:e.tips["ds.smallScale"]},{type:"HIGHER_PRECISION",name:e.tips["ds.bigScale"]}],addFilter:{field:{},operator:{},expression:""}},e.reportView={dataFormula:!1,granularity:{},view:"set",previewDate:Highcharts.dateFormat("%Y-%m-%d",(new Date).getTime()-864e5)},e.reportView.type=e.report.granularity,t(),e.reportView.title=r.instant("ds.gaReportTitle"+e.gaInfo.mode),"cat"!=a&&l()}function l(){function a(e,a){var t=[];return angular.forEach(e,function(e){e.add=!1,a&&a==e.attributes.type?t.push(e):e.type=e.attributes.type.toLowerCase()}),a?t:e}function t(t){var i=e.reportInfo;i.dimensions=a(t.fields.items,"DIMENSION"),i.metrics=a(t.fields.items,"METRIC"),e.reportInfo.segments=t.segments.items,e.report.segment=e.reportInfo.segments[0]}return e.gaInfo.init?(e.gaInfo.data,void t(e.gaInfo.data)):(e.loading=!0,void i.ds.getGaInfo(e.param).then(function(a){if(0==a.status){var i=a.result;e.gaInfo.data=i,t(i),e.gaInfo.init=!0}e.loading=!1}))}function h(a,t){return"create"===e.mode?void(e.prevTbData={name:t,showPreviewCount:e.showPreviewCount,data:a}):void s.open({templateUrl:"/static/database/partials/database_tbinfo.html",className:"ngdialog-theme-default ngDialog-width-percent-80 database-tb-preview",data:{data:a,name:t}})}e.viewData={searchResult:!0},e.gaInfo={},e.$watch("tableList",function(a){a&&a.length>0&&(e.tableInfo.getCheckNum(),e.tableInfo.isCheckAll(),"modify"===e.mode&&e.tableInfo.getAddTbaleInfo(),e.viewData.largeDataTip=e.tips["ds.largeDataTip"])}),e.dbInfo.syncNewTables=!0,e.showPreviewCount=!1,e.tableInfo={showCheck:!1,newAddTable:[],showFirstAdd:localStorage.getItem("BDP_guide_dbNewTable")||0,getCheckNum:function(){var a=0,t=e.tableInfo;angular.forEach(e.tableList,function(e){e.check&&a++}),t.checkedNum=a},isCheckAll:function(){var a,i=e.tableInfo,s=t("query_fields")(e.tableList,i.keyword),n=0,i=e.tableInfo;angular.forEach(s,function(e){e.check&&n++}),n==s.length?(a=!0,initCheck=!0):(initCheck=!1,a=!1),i.all=a,i.initAll=initCheck},getAddTbaleInfo:function(){var a=(e.dbInfo,e.tableInfo),t=e.tableList;a.newAddTable=[],angular.forEach(t,function(e){e.check&&!e.initCheck&&a.newAddTable.push(e.name)})},setAddTableGuide:function(){localStorage.setItem("BDP_guide_dbNewTable",1),e.tableInfo.showFirstAdd=1},checkAll:function(){var a=e.tableInfo,i=a.all,s=t("query_fields")(e.tableList,a.keyword);angular.forEach(s,function(e){e.check=a.keyword&&e.name.toLowerCase().indexOf(a.keyword.toLowerCase())>-1?i:i}),a.getCheckNum(),"modify"===e.mode&&a.getAddTbaleInfo()},checkTb:function(){var a,i=0,s=e.tableInfo,n=t("query_fields")(e.tableList,s.keyword);angular.forEach(n,function(e){e.check&&i++}),a=i==n.length?!0:!1,s.all=a,s.getCheckNum(),"modify"===e.mode&&s.getAddTbaleInfo()},toFilter:function(){var a=t("query_fields")(e.tableList,e.tableInfo.keyword),i=!1;i=0==a.length?!1:!0,e.viewData.searchResult=i},preview:function(a){var t,s=angular.copy(e.param);if(e.showPreviewCount=!0,48!=s.db_type)t=a.name||a,s.tb_name=t,e.loading=!0,i.ds.getTbInfo(s).then(function(a){0==a.status&&h(a.result,t),e.loading=!1});else{var n=angular.copy(a),r=n.report.where;r&&"custom"==r.where_type&&(r.filters=$.trim(r.expression)||r.filters),s.report=angular.toJson(n.report),t=n.name,e.loading=!0,i.ds.previewGa(s).then(function(a){0==a.status&&h(a.result,t),e.loading=!1})}},isOperate:function(e,a,t){6==t&&e&&n(r.instant("ds.publicDataTip"))},modify:function(a,t){e.param.db_type,e.reportHandle.addReport("modify",a.report,t)},cat:function(a,t){e.reportHandle.addReport("cat",a.report,t)},"delete":function(a,t){s.openConfirm({templateUrl:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",data:{message:e.tips["gaReport.confirmDeleteReport"]+a+"?"}}).then(function(){e.tableList.splice(t,1)})}},e.reportHandle={addReport:function(a,t,i){function n(a,t){var i=e.report,s="DIMENSION"==t?i.dimensions:i.metrics,n=[];angular.forEach(s,function(e){n.push(e.id)}),angular.forEach(a,function(e){$.inArray(e.id,n)>-1&&(e.add=!0)})}if(s.open({templateUrl:"/static/database/partials/database_report.html",className:"ngdialog-theme-default ngdialog-width-818 database-ga-report",scope:e,showClose:!1}),e.gaInfo.mode=a,e.gaInfo.index=i,"add"==a)c();else if(c(a),e.report=angular.copy(t),e.report.samplingLevel=e.report.samplingLevel||"DEFAULT","modify"==a){var r=e.reportInfo;n(r.dimensions,"DIMENSION"),n(r.metrics,"METRIC")}},addField:function(a,t){var i="dimensions"==t?6:10;return e.report[t].length>=i?void n(e.tips["ds.fieldSetOverRun"]):a.add?void n(e.tips["ds.fieldAdded"]):(a.add=!0,e.report[t].push(a),void(e.reportView[t+"ListShow"]=!1))},deleteField:function(a,t,i){a.add=!1,e.report[i].splice(t,1)},switchGranularity:function(a){e.report.granularity=a.type,e.reportView.granularity=a,e.reportView.dataFormula=!1},addFilter:function(){var a=e.report,t=e.reportInfo;return addFilter=angular.copy(t.addFilter),addFilter.field.id?addFilter.operator.value?addFilter.expression?(a.where.filters.push(addFilter),void(t.addFilter={field:{},operator:{},expression:""})):void n(r.instant("ds.reportExpressionRequire")):void n(r.instant("ds.selectFilter")):void n(r.instant("ds.selectField"))},deleteFilter:function(a){e.report.where.filters.splice(a,1)},reportPreview:function(){if(o()){var a=d();e.loading=!0,i.ds.previewGa(a).then(function(a){0==a.status&&(e.reportView.view="preview",e.reportInfo.data=a.result),e.loading=!1,e.reportView.title=e.report.name})}},back:function(){e.reportView.view="set",e.reportView.title=r.instant("ds.gaReportTitle"+e.gaInfo.mode)},sure:function(){var a=e.report,t=e.gaInfo;if("modify"==t.mode){var i=e.tableList[t.index];i.name=a.name,i.report=angular.copy(a)}else e.tableList.push({name:a.name,tag:"add",report:angular.copy(a)});e.reportView.view="set"}},a(["ds.apiUserName","ds.requireApiPassword","ds.requireApiToken","ds.apiStartDate","ds.hostRequire","ds.portRequire","ds.databaseRequire","ds.apiSiteId","ds.websiteRequire","ds.catPwdRequire","ds.monitorWebsiteRequire","ds.transformSettingRequire","ds.largeDataTip","gaReport.confirmDeleteReport","ds.fieldSetOverRun","ds.fieldAdded","default","ds.smallScale","ds.bigScale"],e)}var a={restrict:"EA",templateUrl:"/static/database/partials/database_table_list.html",replace:!1,scope:{tableList:"=",loading:"=",param:"=",dbInfo:"=",prevTbData:"="},controller:e,link:function(e,a,t){e.mode=t.mode}};return e.$inject=["$scope","$jsTipTranslate","$filter","commonService","ngDialog","errHint","$translate"],a}]),angular.module("BC.directives").directive("gaExpression",e),e.$inject=["$rootScope"]}(),!function(){angular.module("BC.directives").directive("dbAdvancedInfo",["$templateCache","commonHttp","$compile",function(){function e(e,a,t,i,s){function n(e){return p.setDate(p.getDate()+e),p.getFullYear(),p.getMonth()+1,p.getDate(),Highcharts.dateFormat("%Y-%m-%d",p)}function r(){var a=e.viewData;if(38==e.dbInfo.db_type){var t=Highcharts.dateFormat("%Y-%m-%d",new Date);e.info.start_date=t.replace(/.{2}$/,"01"),a.readonlyDate=!0}21==e.dbInfo.db_type&&(e.info.start_date=n(-1),a.readonlyDate=!0),[19,16,34,40].indexOf(e.dbInfo.db_type)>-1||1==e.dbInfo.category||(e.viewData.showDate=!0)}function o(){if("modify"==e.mode&&0!=e.info.editFieldList.length){var a=angular.copy(e.curFields);e.info.field_list.push(a)}}function d(t){for(var i=e.info.field_list.concat(e.info.editFieldList||[]),s=[],n=!0,r=0,o=i.length;o>r;r++){if(1==e.info.field_list.length&&"add"!=t){if(i[r].ftitle&&!i[r].fvalue||!i[r].ftitle&&i[r].fvalue)return a(e.tips["ds.auxiliaryFieldNameNotEmpty"]),!1}else if(!i[r].ftitle||!i[r].fvalue)return a(e.tips["ds.auxiliaryFieldNameNotEmpty"]),!1;s.push(i[r].ftitle)}for(var r=0;r<s.length;r++){var d=angular.copy(s);if(d.splice(r,1),s[r]&&$.inArray(s[r],d)>-1)return a(e.tips["ds.auxiliaryFieldNotRepeat"]),!1}return n}function c(){var a=0,t=e.info.start_date.replace(/-/g,"/"),i=new Date(t).getTime(),s=Highcharts.dateFormat("%Y-%m-%d",new Date).replace(/-/g,"/"),n=new Date(s).getTime();return a=parseInt((n-i)/864e5)}function l(){var t=e.info,i=e.dbInfo;if(!t.name)return a(e.tips["ds.apiName"]),!1;if(e.viewData.showDate&&"modify"!=e.mode){if(!t.start_date)return a(e.tips["ds.apiStartDate"]),!1;var s=c();if(0>=s)return a(e.tips["ds.plzSelectBeforeToday"]),!1;if(24==i.db_type&&s>30)return a(e.tips["ds.cnzzStartDateVerify"]),!1;if(17==e.dbInfo.db_type){var n=new Date(e.info.start_date).getTime(),r=new Date("2016-06-01").getTime();if(r>n)return a(e.tips["ds.dateWrong"]),!1}}return e.info.field_list.length>0&&!d()?!1:e.viewData.editing?void a(e.tips["ds.editFieldTip"]):!0}function h(){var a=e.viewData,t=e.dbInfo;a.pauseModify=0==t.param_category||$.inArray(t.db_type,[34,40])>-1,a.showField=1!=t.category&&-1==$.inArray(t.db_type,[34,40])}function u(){r(),h(),o(),"modify"!=e.mode&&(e.info.hour="00",e.info.minute="00")}e.viewData={showDate:!1,curField:{}},e.viewData.hourOptions=s.hourOptions,e.viewData.minuteOptions=s.minuteOptions,e.curFields={fname:"",ftitle:"",fvalue:"",status:1},e.addField=function(){var a=angular.copy(e.curFields);return e.info.field_list.length>0&&!d("add")?!1:(e.info.field_list.unshift(a),void(e.curFields={fname:"",ftitle:"",fvalue:"",status:1}))},e.clearField=function(t,s){if(!s)return void e.info.field_list.splice(t,1);var n=e.info.editFieldList[t],r={ds_id:e.dbInfo.ds_id,fname:n.fname,ftitle:n.ftitle,fvalue:n.fvalue};e.loading=!0,i.ds_field.field_del(r).then(function(t){e.loading=!1,0==t.status?n.status=3:a(7590==Number(t.status)?e.tips["ds.auxiliaryFieldUsed"]:Number(t.status))})},e.modifyField=function(t){var i=e.viewData;return i.editing?void a(e.tips["ds.editFieldTip"]):(i.curField.fname=t.fname,i.curField.ftitle=t.ftitle,i.curField.fvalue=t.fvalue,t.editing=!0,void(e.viewData.editing=!0))},e.saveField=function(t){var s={ds_id:e.dbInfo.ds_id,fname:t.fname,ftitle:t.ftitle,fvalue:t.fvalue};return s.ftitle&&s.fvalue?(e.loading=!0,void i.ds_field.field_modify(s).then(function(a){e.loading=!1,0==a.status&&(t.editing=!1,e.viewData.editing=!1,t.status=2)})):void a(e.tips["ds.fieldNameNotEmpty"])},e.cancelModifyField=function(a){var t=e.info.editFieldList,i=t[a],s=e.viewData;i.fname=s.curField.fname,i.ftitle=s.curField.ftitle,i.fvalue=s.curField.fvalue,i.editing=!1,e.viewData.editing=!1},e.switchDate=function(a,t){a.stopPropagation(),t||(e.dateLayer=!e.dateLayer)},e.$watch("viewData.picker_date",function(a){a&&(e.info.start_date=Highcharts.dateFormat("%Y-%m-%d",a),e.dateLayer=!1)});var p=new Date;e.$on("advancedInfoVerifyForm",function(){l()&&e.goOn()}),e.$on("initData",function(){u()}),t(["ds.apiName","ds.apiStartDate","ds.plzSelectBeforeToday","ds.auxiliaryFieldNameNull","ds.auxiliaryFieldNameTooLong","ds.auxiliaryFieldValueNull","ds.fieldValueNovalidated","ds.auxiliaryFieldRepeat","ds.auxiliaryFieldHasExist","ds.auxiliaryFieldUsed","ds.dateWrong","ds.cnzzStartDateVerify","ds.editFieldTip","ds.fieldNameNotEmpty","ds.auxiliaryFieldNameNotEmpty","ds.auxiliaryFieldNotRepeat"],e)
}var a={templateUrl:"/static/database/partials/database_advanced_info.html",restrict:"EA",replace:!1,scope:{info:"=",dbInfo:"=",dateLayer:"=",loading:"=",goOn:"&"},link:function(e,a,t){e.mode=t.mode},controller:e};return e.$inject=["$scope","errHint","$jsTipTranslate","commonService","databaseSyncTime","$timeout"],a}])}(),angular.module("BC.directives").directive("dbGuide",["$timeout",function(){return{restrict:"EA",templateUrl:"/static/js/common/tpl/guide/database_guide.html",controller:o,scope:{num:"=",descInfo:"=",usageHeight:"="}}}]),o.$inject=["$scope","$rootScope","$state","$location","$timeout","$interval","commonHttp","ngDialog"],!function(){angular.module("BC.directives").directive("databaseSearch",["$timeout","commonService","$rootScope","commonHttp","dbTypeMap","$filter","$jsTipTranslate",function(e,a,t,i,s,n){return{restrict:"A",templateUrl:"/static/partials/directiveTemplates/databaseSearch.html",replace:!0,scope:{searchDirectiveData:"="},link:function(a){function t(){a.$emit("reloadList","noGetName")}function i(){var e=a.query_text;if(e){var t=angular.copy(a.name_list),i=angular.copy(a.tag_list),s={};a.search_result=[];for(var n=0,r=i.length;r>n;n++)i[n].value.indexOf(e)>=0&&(a.search_result.push(i[n]),s[i[n].value+"_"+i[n].type]=!0);for(var n=0,r=t.length;r>n;n++)t[n].value.indexOf(e)>=0&&(s[t[n].value+"_"+t[n].type]||a.search_result.push(t[n]))}}function r(){a.search_data=a.searchDirectiveData.search_data,a.name_list=a.searchDirectiveData.database_name_list,a.tag_list=a.searchDirectiveData.database_tag_list,a.type_list=a.searchDirectiveData.database_type_list}function o(e){var t=!1;for(var i in a.dbTypeMap)a.dbTypeMap[i]==e&&(t=!0);return t}r(),a.dbTypeMap=s,a.query_text="",a.show_search_list="",a.show_search_close=!1,$(".clear-value"),$(".search-input"),a.beginSearch=function(){r(),e(function(){a.query_text?("0"==a.search_data.stype&&o(a.query_text)?a.show_search_list="type":(a.show_search_list="name",i()),a.show_search_close=!0):a.show_search_list="type"},100)},a.searchNameOrTag=function(e){a.query_text?(a.show_search_list="name",i(),13==e.keyCode&&(a.search_data={dstype:"3",sort_type:"0",stype:"1",scontent:a.query_text,sc_type:0,page:"1"},t())):(a.show_search_list="type",i(),13==e.keyCode&&(a.search_data={dstype:"3",sort_type:"0",stype:"0",scontent:"",sc_type:0,page:"1"},t()))},a.clearValue=function(e){e&&e.stopPropagation(),a.query_text="",a.show_search_close=!1,a.show_search_list="",a.search_data.stype="0",a.search_data.scontent="",a.search_data.sc_type=0,t()},a.selectApiType=function(e){a.show_search_list="type",a.query_text=n("db_type")(e.type),a.show_search_list="",a.search_data.stype="0",a.search_data.scontent=String(e.type),a.search_data.sc_type=0,t()},a.selectDatabaseName=function(e){a.query_text=e.value,a.show_search_list="name",a.search_data.stype="1",a.search_data.scontent=a.query_text,a.search_data.sc_type=e.type,t()},a.hideSearchList=function(){""==a.query_text&&(a.search_data.stype="0",a.search_data.scontent="",a.search_data.sc_type=0),a.show_search_list="",a.$digest||a.$apply()}}}}])}(),!function(){angular.module("BC.directives").directive("databaseBaseInfo",["$timeout","commonService","$rootScope","commonHttp","$filter","$jsTipTranslate",function(e,a,t){return{restrict:"A",templateUrl:"/static/partials/directiveTemplates/databaseBaseInfo.html",replace:!0,link:function(e){function i(e){var a,t=["B","K","M","G"];for(a=0;a<t.length&&!(e>1&&1>e/1024)&&3!=a;a++)e/=1024;return e.toFixed(2).toString()+"  "+t[a]}e.hasStorageLimitFlag=!1,e.$watch(function(){return t.role},function(s){("s_admin"==s||3==t.enterprise_type)&&a.tb.getStorageAccount().then(function(a){var t=a.data_size_used,s=a.data_size_limit;"0"!=s?(e.hasStorageLimitFlag=!0,e.storage_progress_num=t/s*100,e.storage_progress_percent=e.storage_progress_num.toFixed(2),e.storage_progress_num<.5&&(e.storage_progress_num=.5),e.storage_progress_num>100&&(e.storage_progress_num=100),e.storage_account=i(t),e.storage_total=i(s)):(e.hasStorageLimitFlag=!1,e.storage_account=i(t))})})}}}])}()}();
;!function(){angular.module("BC.controllers.dataSource").controller("UserController",["$scope","$rootScope","commonHttp","commonService","$location","errHint","ngDialog","$timeout","$jsTipTranslate",function(e,t,a,i,r,o,s,n,u){function l(){0==e.showAccount.role&&h()}function c(e){return angular.forEach(e,function(e){var t=e.filter;t.where_type&&("sql"==t.where_type&&0==t.sql.length&&(e.filter={}),"condition"==t.where_type&&0==t.condition.filters.length&&(e.filter={}))}),e}function d(){function t(e){e.map(function(e){if(e.choose){var t={tb_id:e.tb_id};t.filter=e._filter||e.filter?e.filter:null,e.sh_id&&(t.sh_id=e.sh_id),i.push(t)}})}var a=e.viewData.sharedWorkTables,i=[];return angular.forEach(a,function(e){t(e.tb_list),e.sub_folders&&e.sub_folders.length>0&&angular.forEach(e.sub_folders,function(e){t(e.tb_list)})}),e.viewData.emptyWb=0==i.length,i}t.view="user",t.show_bdp_header=!0,e.tables=[];var p={routeTo:function(e){location.href=e},shopex:{getLicense:function(){a.post("/api/shangpai/license").then(function(){})},gotoBind:function(){e.click_show_view("database"),s.closeAll(),t.guideAddDatabase=!0},init:function(){e.modalInfo={type:"init",title:"设置登录信息"},s.open({template:"/static/partials/shopex/init_bdp.html",className:"ngdialog-theme-default ngDialog-width-330 partner-shopex-modal",data:{username:t.username,domain:"",password:"",confirm_password:"",save:p.shopex.save,gotoBind:p.shopex.gotoBind,enterKey:p.shopex.enterKey},scope:e})},save:function(t){var i=t.domain,r=t.password,s=t.confirm_password;return i?r?verifyHandle.password(r)?(o("密码强度过低，请重新输入包含字母与数字的并且长度不小于8位的密码","dialog"),!1):r!==s?(o("两次密码不一致","dialog"),!1):void a.post("/api/enterprise/init",{domain:t.domain,password:t.password}).then(function(t){0===+t.status&&(e.modalInfo={type:"guide",title:"用户引导"})}):(o("密码不能为空","dialog"),!1):(o("请输入有效的域名","dialog"),!1)},enterKey:function(e){13==e.keyCode&&this.save(this)}}};n(function(){t.permision.isPartner&&t.permision.isPartner.shopexNeedInit&&p.shopex.init()},0),e.edit_state={edit_user_info:!1,edit_user_group:!1,edit_work_tables:!1,edit_group_info:!1,edit_group_user:!1},e.userInfo={groups:[]},e.groupInfo={},e.groupList=[],e.viewData={activeGroup:"",activeUser:"",groupInfo:!1,userInfo:!0,tab:"table",menuTab:"user",loading:!0},e.empty=void 0,e.userList=[],e.groupUserList=[],e.groupUsers=[],e.curWorkTables=[],e.allGroups=[],e.sourceGroups=[],e.curUserGroupsIds=[],e.curUserGroups=[],e.showAccount={},e.viewData.sharedWorkTables=[],e.viewData.curTables=null,t.$watch("master_role",function(){e.showAccount.role=t.master_role,l()});var f=function(){function i(){function t(e){e.tb_list.length>0&&i++,e.sub_folders&&e.sub_folders.length>0&&e.sub_folders.map(t)}var a=e.folderList,i=0;return a.map(t),!i}a.get("/api/folder/list").then(function(a){if(0==a.status){e.folderList=a.result;var r=e.folderList.length;"folder_root"==e.folderList[r-1].folder_id&&(e.folderList[r-1].name="en"==t.locale?"Root Folder":"根目录"),e.viewData.emptyTb=i()}})};f();var m=function(t,i){return a.get("/api/sub/list").then(function(a){if(0==a.status){if(e.userList=a.result,0==e.userList.length)return e.empty=!0,void(e.viewData.loading=!1);if("init"==i&&t){for(var r=!1,o=0,s=e.userList.length;s>o;o++)if(e.userList[o].userid==t){r=!0;break}r||(t=void 0)}t&&setTimeout(function(){v($("#u_"+t))},300),t=t?t:e.userList[0].userid,e.getUserInfo(t)}})};m(sessionStorage.getItem("userId"),"init");var g=function(t){i.user.groupList().then(function(a){if(0==a.status){e.groupList=a.result;var i;switch(e.allGroups=[],e.sourceGroups=[],angular.forEach(e.groupList,function(t){"00000000000000000000000000000000"!==t.group_id&&(e.allGroups.push({group_id:t.group_id,group_name:t.group_name}),e.sourceGroups.push({group_id:t.group_id,group_name:t.group_name}))}),t){case"init":var r=e.groupList;e.groupList[0]?i=r[0].group_id:e.empty=!0;break;case"edit":i=e.viewData.activeGroup;break;case"create":i=e.viewData.activeGroup,setTimeout(function(){v($("#g_"+e.viewData.activeGroup))},300)}if(!i)return;e.getGroupInfo(i),e.viewData.activeGroup=i}})};g(),e.cancelEdit=function(){if("create"!=e.viewData.model)return void(e.viewData.model="cat");if(e.viewData.model="cat",e.viewData.userInfo){if(0==e.userList.length)return e.empty=!0,void(e.viewData.model="cat");e.viewData.beforeUser?e.getUserInfo(e.viewData.beforeUser):e.getGroupInfo(e.viewData.beforeGroup)}else{if(0==e.groupList.length)return e.empty=!0,void(e.viewData.model="cat");if(!e.viewData.beforeGroup)return void e.getUserInfo(e.viewData.beforeUser);e.getGroupInfo(e.viewData.beforeGroup)}},e.changeRole=function(){role=e.userInfo.role,2==role&&(e.viewData.manage="all"),e.userInfo.is_admin=2==role?!0:!1};var v=function(e){var t=$(".side-menu .side-menu-list");if(0!=t.length){var a=t.height(),i=t[0].scrollTop;if(!e)return void t.animate({scrollTop:0});var r=e.offset().top;return 0>r-40?void t.animate({scrollTop:i-Math.abs(r)-250}):void(r-a>0&&t.animate({scrollTop:r-250}))}};e.getUserInfo=function(i,r){return e.viewData.menuTab="user",e.viewData.loading=!0,"edit"!=e.viewData.model||confirm(e.tips["user.confirmCancel"])?(e.viewData.model="cat",e.isRead=!0,e.viewData.activeGroup="",e.viewData.userInfo=!0,e.viewData.groupInfo=!1,e.originalUserInfo={},e.viewData.tab=5==t.enterprise_type||6==t.enterprise_type?"group_table":1!=t.enterprise_type?"table":"tpl",a.get("/api/sub/info",{sub_id:i}).then(function(t){if(e.viewData.loading=!1,0==t.status){e.empty=!1,sessionStorage.setItem("userId",i),e.viewData.activeUser=i,"group"==r&&setTimeout(function(){v($("#u_"+i))},100),e.originalUserInfo=angular.copy(t.result),e.userInfo=t.result,e.viewData.templateRule=t.result.template_rule_info,e.viewData.tplTab=0,e.curUserGroupsIds=[],e.curUserGroups=[];var a=e.userInfo.role,s="";s=2==a?e.tips["user.manageAccount"]:4==a?e.tips["user.readOnlyAccount"]:e.tips["user.ordinaryAccount"],e.userInfo.roleAccount=s,2==a&&(0==e.userInfo.access_all_account?(e.viewData.manage="group",e.userInfo.is_admin=!1):(e.viewData.manage="all",e.userInfo.is_admin=!0),e.userInfo.is_admin=!0);var u=0,l=0;angular.forEach(e.userInfo.groups,function(t){e.curUserGroupsIds.push(t.group_id),e.curUserGroups.push(t),u+=t.template_rule_info.length,l+=t.work_tables.length}),e.viewData.groupTpl=u,e.viewData.groupTb=l;var d=[];angular.forEach(e.userInfo.manage_groups,function(e){d.push(e.group_id)}),e.userInfo.domain=$.cookie("domain")?$.cookie("domain"):"",e.viewData.curTables=c(e.userInfo.work_tables),e.curUserManageGroups=angular.copy(e.userInfo.manage_groups),e.allGroups=angular.copy(e.sourceGroups),angular.forEach(e.allGroups,function(t){t.manage=$.inArray(t.group_id,d)>-1,t.check=$.inArray(t.group_id,e.curUserGroupsIds)>-1}),0!=e.userInfo.status&&n(function(){$("#copy_url").zclip({path:"/static/js/lib/jquery-ui/ZeroClipboard.swf",copy:function(){return $("#copy").val()},afterCopy:function(){n(function(){o(e.tips["user.copySuccess"])},0)}})},500)}})):void 0},e.editUserInfo=function(){e.viewData.model="edit",e.viewData.isCheck=!0,e.viewData.groupInfo&&"data_admin"==t.role&&(e.viewData.tab="table"),(5==t.enterprise_type||6==t.enterprise_type)&&(e.viewData.tab="group_table")},e.getGroupInfo=function(t){("edit"!=e.viewData.model||confirm(e.tips["user.confirmCancel"]))&&(sessionStorage.setItem("userId",""),e.viewData.model="cat",e.viewData.loading=!0,e.viewData.activeGroup=t,"00000000000000000000000000000000"!=t&&(e.viewData.activeUser="",e.viewData.userInfo=!1,e.viewData.groupInfo=!0,e.edit_state.edit_user_info=!1,e.isRead=!0,e.viewData.tab="user",e.viewData.menuTab="group",a.get("/api/group/info",{group_id:t}).then(function(t){if(0==t.status){e.empty=!1;var a=t.result;e.groupInfo=a,e.groupInfo.domain=$.cookie("domain")?$.cookie("domain"):"",e.viewData.templateRule=a.template_rule_info,e.viewData.tplTab=0,e.viewData.curTables=c(e.groupInfo.work_tables),e.groupUsers=[];var i=[];angular.forEach(a.user_list,function(t){i.push(t.userid),e.groupUsers.push(t.userid)}),e.groupUserList=[],angular.forEach(e.userList,function(t){e.groupUserList.push($.inArray(t.userid,i)>-1?{name:t.name,user_id:t.userid,check:!0}:{name:t.name,user_id:t.userid,check:!1})})}e.viewData.loading=!1})))},e.removeSelectedTable=function(t){angular.indexOf(e.work_tables,t.tb_id)>-1?(e.remove_table=t,s.open({templateUrl:"/static/partials/remove_table_warning.html",scope:e})):t.check=!1},e.cancelRemove=function(){s.closeAll(),e.remove_table=null},e.confirmRemove=function(){e.remove_table&&(e.remove_table.check=!1),s.closeAll(),e.remove_table=null},e.noCheckedTable=function(){return e.folders?0==e.tables.length:!1},e.noCheckedUser=function(){if(e.groupUsers.length>0)return!1;for(var t=e.groupUserList.length;t--;)if(e.groupUserList[t].check)return!1;return!0},e.createUser=function(){e.viewData.activeUser?e.viewData.beforeUser=e.viewData.activeUser:e.viewData.beforeGroup=e.viewData.activeGroup,e.viewData.activeUser="",e.viewData.userInfo=!0,e.viewData.groupInfo=!1,e.viewData.model="create",e.empty=!1,angular.forEach(e.allGroups,function(e){e.check=!1,e.manage=!1}),e.viewData.menuTab="user",e.userInfo={},e.userInfo.domain=$.cookie("domain"),e.userInfo.username="",e.userInfo.userid="",e.userInfo.sub_id="",e.userInfo.name="",e.userInfo.email="",e.userInfo.mobile="",e.userInfo.groups=[],e.work_tables=[],e.viewData.curTables=[],t.permision.assignWorkTable&&(e.viewData.tab="table");var a=3;t.permision.userOnlyReadOption&&(a=4),e.userInfo.role=a,e.viewData.manage="all",e.folders=angular.copy(e.folderList)},e.createGroup=function(){e.viewData.beforeGroup=e.viewData.activeGroup,e.viewData.beforeUser=e.viewData.activeUser,e.viewData.activeGroup="",e.viewData.activeUser="",e.viewData.userInfo=!1,e.viewData.groupInfo=!0,e.groupUsers=[],e.empty=!1,e.viewData.menuTab="group",e.groupUserList=[],angular.forEach(e.userList,function(t){e.groupUserList.push({name:t.name,user_id:t.userid,check:!1})}),e.groupInfo.group_name="",e.groupInfo.domain=$.cookie("domain")?$.cookie("domain"):"",e.viewData.tab="user",e.viewData.model="create",e.folders=angular.copy(e.folderList)},e.deleteUser=function(t){e.toggleImg(),e.deleteUserDialog=s.open({template:"/static/partials/dialogTemplates/delete_user_confirm.html",className:"ngdialog-theme-default ngdialog-width-344 ngDialog-delete-confirm",scope:e,data:{verifyCode:"",userId:t,message:e.tips["user.confirmRemoveUser"]}})},e.toggleImg=function(){var t=(new Date).getTime();e.sessionId=t+parseInt(1e4*Math.random()),e.url="/api/register/pic?session_id="+e.sessionId+"&t="+t},e.confirmDeleteUser=function(t,i){return""==i?(o(e.tips["user.inputPicVerifyCode"]),!1):void a.get("/api/sub/delete",{sub_id:t,verify_code:i,session_id:e.sessionId}).then(function(a){0==a.status&&(t==e.viewData.activeUser&&(sessionStorage.setItem("userId",""),v()),m(),0==e.showAccount.role&&h(),o(e.tips["user.deleteUserSuccess"]),s.close(e.deleteUserDialog))})},e.freezeUser=function(t){var a={};1==t.is_frozen?(a.message=e.tips["user.unLockTip"],a.title=e.tips["user.unLockTitle"],a.is_frozen=0,a.tip=e.tips["user.unLockSuccess"]):(a.message=e.tips["user.lockTip"],a.title=e.tips["user.lockTitle"],a.is_frozen=1,a.tip=e.tips["user.lockSuccess"]),s.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:a}).then(function(){i.user.setFrozen({sub_id:t.userid,is_frozen:a.is_frozen}).then(function(e){0==e.status&&(t.is_frozen=a.is_frozen,o(a.tip))})})},e.bindMobileForDs=function(e,t){i.ds.mobile_default_bind({phone:t,user_id:e}).then(function(){})},e.unBindMobileForDs=function(e){i.ds.mobile_unbind_all({user_id:e}).then(function(){})},e.is_extrace=function(t){var a=t.target.checked?1:0;e.userInfo.is_extrace=a},e.dmsPermission=function(t){var a=t.target.checked?1:0;e.userInfo.dms_permission=a},e.saveUserInfo=function(i){if(!e.viewData.loading||i){var r={},s={},u="/api/sub/create";if(s=angular.copy(e.userInfo),delete s.is_admin,delete s.groups,s.manage_groups&&delete s.manage_groups,delete s.template_rule_info,"data_admin"!=t.role){if("create"==e.viewData.model&&e.userform.username.$invalid)return e.userform.username.$viewValue?void o(e.tips["user.usernameInvalid"]):void o(e.tips["user.usernameRequired"]);if(e.userform.name.$invalid)return e.userform.name.$viewValue?void o(e.tips["user.nameInvalid"]):void o(e.tips["user.nameRequired"]);if(e.userform.mobile.$invalid)return void o(e.tips["user.phoneNumberInvalid"]);if(e.userform.email.$invalid)return void o(e.tips["user.mailInvalid"]);if(!e.userInfo.mobile&&!e.userInfo.email)return void o(e.tips["user.needPhoneOrMail"]);if(e.userform.$invalid)return}if(e.userInfo.is_admin){if(s.role=2,s.data_permission=1,s.account_permission=0,s.manage_group_id_list=[],"all"==e.viewData.manage)s.access_all_account=1;else if("data_admin"==t.role)angular.forEach(e.curUserManageGroups,function(e){s.manage_group_id_list.push(e.group_id)});else if(s.access_all_account=0,e.curUserManageGroups=[],angular.forEach(e.allGroups,function(t){t.manage&&(s.manage_group_id_list.push(t.group_id),e.curUserManageGroups.push(t))}),0==s.manage_group_id_list.length)return void o(e.tips["user.plzSelectGroup"])}else s.role=s.role?s.role:3,s.manage_group_id_list=[];if(s.is_extrace=3==s.role?0:s.is_extrace,s.work_tables=d(),s.join_group_id_list=[],e.curUserGroupsIds=[],e.curUserGroups=[],angular.forEach(e.allGroups,function(t){t.check&&(s.join_group_id_list.push(t.group_id),e.curUserGroupsIds.push(t.group_id),e.curUserGroups.push(t))}),e.viewData.loading=!0,"edit"==e.viewData.model){if(e.viewData.isCheck)return void _(e.userInfo.userid,s.work_tables);u="/api/sub/modify"}e.tables=[],angular.forEach(e.folders,function(t){angular.forEach(t.tb_list,function(t){t.check&&e.tables.push(t)})}),r={sub_id:e.userInfo.userid,data:angular.toJson(s)},a.post(u,r).then(function(a){0==a.status?(o(e.tips.saveSuccess),e.viewData.model="cat","/api/sub/create"==u?(m(a.result),e.showAccount.show&&h(),0==t.enterprise_type&&e.userInfo.mobile&&2==e.userInfo.role&&e.bindMobileForDs(a.result,e.userInfo.mobile),n(function(){e.openSendNotice()},500)):(m(e.userInfo.userid),0==t.enterprise_type&&e.userInfo.mobile&&2==e.userInfo.role&&3==e.originalUserInfo.role&&e.bindMobileForDs(e.userInfo.userid,e.userInfo.mobile),0==t.enterprise_type&&e.userInfo.mobile&&3==e.userInfo.role&&2==e.originalUserInfo.role&&e.unBindMobileForDs(e.userInfo.userid))):1035==a.status?(o(e.tips["user.emailExist"]),e.viewData.loading=!1):(o(Number(a.status)),e.viewData.loading=!1),l()})}};var _=function(t,i){a.post("/api/sub/del_tb_check",{sub_id:t,work_tables:angular.toJson(i)}).then(function(t){if(0==t.status){var a=t.result.can_del;0==a?(e.dependency=t.result.tb_list,s.open({template:"/static/partials/dialogTemplates/userTableModifyHint.html",className:"ngdialog-theme-default",scope:e}),e.viewData.loading=!1):(e.viewData.isCheck=!1,e.saveUserInfo(1))}})},w=function(t,i){a.post("/api/group/del_tb_check",{group_id:t,work_tables:angular.toJson(i)}).then(function(t){if(0==t.status){var a=t.result.can_del;0==a?(e.viewData.loading=!1,e.dependency=t.result.dependency,s.open({template:"/static/partials/dialogTemplates/userTableModifyHint.html",className:"ngdialog-theme-default",scope:e})):(e.viewData.isCheck=!1,e.saveGroupInfo(1))}})};e.saveGroupInfo=function(t){if(!e.viewData.loading||t){var i={},r="/api/group/create";if(""==e.groupInfo.group_name)return void o(e.tips["user.groupNameRequired"]);if(e.userform.$invalid)return void o(e.tips["user.formInvalid"]);var s=d();if(e.viewData.loading=!0,"edit"==e.viewData.model){if(e.viewData.isCheck)return void w(e.viewData.activeGroup,s);i={group_id:e.viewData.activeGroup},r="/api/group/modify"}i.name=e.groupInfo.group_name,i.add_users=[];var n=e.groupUsers,u=[];angular.forEach(e.groupUserList,function(e){e.check&&u.push(e.user_id)}),angular.forEach(u,function(e){new RegExp(e).test(n.join(","))||i.add_users.push(e)}),i.add_users=i.add_users.join(","),"edit"==e.viewData.model&&(i.del_users=[],angular.forEach(n,function(e){new RegExp(e).test(u.join(","))||i.del_users.push(e)}),i.del_users=i.del_users.join(",")),i.work_tables=angular.toJson(s),a.post(r,i).then(function(t){if(0==t.status){if(o(e.tips.saveSuccess),e.viewData.model="cat","/api/group/create"==r)return e.viewData.activeGroup=t.result,void g("create");g("edit","group")}else e.viewData.loading=!1})}},e.deleteGroup=function(t){s.openConfirm({template:"/static/partials/dialogTemplates/confirm_dialog.html",className:"ngdialog-theme-default ngDialog-width-300",scope:e,data:{message:e.tips["user.confirmRemoveGroup"]}}).then(function(){a.get("/api/group/delete",{group_id:t}).then(function(a){if(0==a.status){var i;e.viewData.activeGroup==t?(i="init",v()):i="",o(e.tips["user.deleteGroupSuccess"]),g(i)}})})},e.resetPwd=function(){return 0==e.userInfo.mobile&&""==e.userInfo.email?(o(e.tips["user.bindContactBeforeReset"]),!1):void(confirm(e.tips["user.confirmResetPassword"])&&a.get("/api/user/reset_pwd",{sub_user_id:e.userInfo.userid}).then(function(t){if(0==t.status){if(o(e.tips["user.resetPasswordSuccess"]),e.getUserInfo(e.viewData.activeUser),!e.userInfo.email&&!e.userInfo.mobile)return;n(function(){e.openSendNotice()},300)}}))},e.showAccount.show=!1;var h=function(){a.get("/api/account/limit").then(function(t){if(0==t.status){var a=t.result;if(a.staff_limit){e.showAccount.num=a.staff_count,e.showAccount.total=a.staff_limit;var i=e.showAccount.num,r=e.showAccount.total,o=i/r*100;e.showAccount.width={width:i/r*100+"px"},e.showAccount.show=!0,e.showAccount.percent=o,e.allPermissionCount=a.all_permission,e.usedAll=a.used_all_permission,a.all_permission?(e.onlyReadCount=a.staff_limit-a.all_permission,e.usedOnly=a.used_only_read):(e.onlyReadCount=a.staff_limit,e.usedOnly=a.staff_count)}}})};e.checkAll=function(t){var a=e.folders[t],i=a.check,r=a.tb_list;angular.forEach(r,function(e){e.check=i})},e.checkworkTb=function(t){var a=e.folders[t],i=a.tb_list,r=0;angular.forEach(i,function(e){e.check&&r++}),a.check=r==i.length?!0:!1},e.activateUrl=function(e){$(e.currentTarget).focus().select()},e.copyUrl=function(e){$(e.target).zclip({path:"/static/js/lib/jquery-ui/ZeroClipboard.swf",copy:function(){return $("#copy").val()}})},e.openSendNotice=function(){s.open({template:"/static/partials/dialogTemplates/send_notice.html",className:"ngdialog-theme-default",scope:e}),e.viewData.isSendNotice=!0,window.clearTimeout(D);var t=sessionStorage.getItem("count_"+e.viewData.activeUser);if(t){var a=(new Date).getTime(),i=Math.round(60-(a-t)/1e3);60>i&&i>0?(e.viewData.isSendNotice=!1,e.viewData.sendText=i+" "+e.tips.second,new b(i)):(e.viewData.isSendNotice=!0,e.viewData.sendText=e.tips["user.send"])}else e.viewData.isSendNotice=!0,e.viewData.sendText=e.tips["user.send"];e.userInfo.email&&e.userInfo.mobile?(e.viewData.email=!0,e.viewData.mobile=!0):e.userInfo.email?e.viewData.email=!0:e.viewData.mobile=!0};var D,b=function(t){D=setTimeout(function(){t--,t>=0?(e.$apply(function(){e.viewData.sendText=t+" "+e.tips.second}),b(t)):e.$apply(function(){e.viewData.sendingUser="",e.viewData.isSendNotice=!0,e.viewData.sendText=e.tips["user.resend"]})},1e3)};e.sendNotice=function(t){{var i;t.target}if(e.viewData.isSendNotice){if(e.viewData.isSendNotice=!1,b(60),!e.viewData.email&&!e.viewData.mobile)return void o(e.tips["user.plzSelectSendType"]);i=e.viewData.email&&e.viewData.mobile?0:e.viewData.email?2:1;var r=e.viewData.activeUser;a.get("/api/sub/send_notice",{sub_id:r,target:i}).then(function(t){0==t.status&&(o(e.tips["user.sendSuccess"]),sessionStorage.setItem("count_"+r,(new Date).getTime())),s.closeAll()})}},u(["saveSuccess","second","user.confirmCancel","user.copySuccess","user.confirmRemoveUser","user.usernameInvalid","user.usernameRequired","user.nameInvalid","user.nameRequired","user.emailExist","user.phoneNumberInvalid","user.mailInvalid","user.needPhoneOrMail","user.plzSelectGroup","user.groupNameRequired","user.formInvalid","user.confirmRemoveGroup","user.confirmResetPassword","user.bindContactBeforeReset","user.resetPasswordSuccess","user.resend","user.plzSelectSendType","user.sendSuccess","user.send","user.readOnlyAccount","user.manageAccount","user.ordinaryAccount","user.lockTitle","user.lockTip","user.unLockTitle","user.unLockTip","user.lockSuccess","user.unLockSuccess","user.inputPicVerifyCode","user.deleteUserSuccess","user.deleteGroupSuccess"],e)}])}();
;!function(){function e(e,t,r,l,i,o,n){function a(t){var l=[];angular.forEach(t.sql,function(e,t){e&&l.push({tb_id:t,sql:e})}),t.sql=l,delete t.condition,0==l.length&&(t={}),e.editTbModel.filter=t,r.closeAll()}function d(r){var l=e.editTbModel.tb_id;e.filter.sql[l]?t.tb.sqlTrans({tb_id:l,sql:e.filter.sql[l]}).then(function(e){0==e.status&&a(r)}):a(r)}function f(t){for(var r=0,i=e.filterGroups.length;i>r;r++)for(var o=0,n=e.filterGroups[r].filters.length;n>o;o++){var a=e.filterGroups[r].filters[o];if(!a.value&&8!=a.operator&&9!=a.operator&&10!=a.operator)return l("筛选值必须填写",{dialog:!0}),!1}t.condition.filters=e.filterGroups,delete t.sql,0==e.filterGroups.length&&(t={})}function s(){t.db.getField(e.editTbModel.tb_id).then(function(t){t&&(angular.forEach(t.columns,function(e){e.title=e.nick_name}),e.fieldList=t.columns,e.tbList=[{name:e.editTbModel.name,tb_id:e.editTbModel.tb_id,fields:bdp.utils.addSpecParamsToFields(e.fieldList)}],n(function(){e.$broadcast("initSql",e.editTbModel.tb_id)},10))})}e.editTbModel=e.ngDialogData.editTbModel,e.operatorList=i,e.conditionTypes=o,e.newFilter={operator:0,value:"",start_date:null,end_date:null};var u={where_type:"condition",where_linker:"and",sql:{},condition_type:0,condition:{filters:[]}};if(e.filterGroups=[],e.editTbModel.filter.where_type){var p=angular.copy(e.editTbModel.filter);if(angular.extend(u,p),e.filter=u,"condition"==p.where_type)e.filterGroups=p.condition.filters;else{var c={};c[p.sql[0].tb_id]=p.sql[0].sql,e.filter.sql=c}}else e.filter=angular.copy(u);e.addFilter=function(t){function r(e){return e.filters[0]?e.filters[0].fid:""}if(!t.field)return l("请选择字段",{dialog:!0}),!1;if(!t.value&&8!=t.operator&&9!=t.operator&&10!=t.operator)return l("请填写值",{dialog:!0}),!1;if(10==t.operator&&!t.start_date&&!t.end_date)return void l("请填写值",{dialog:!0});for(var i={fid:t.field.fid,field_name:t.field.nick_name,operator:t.operator,value:t.value,data_type:t.field.data_type,start_date:t.start_date,end_date:t.end_date},o=!1,n=0,a=e.filterGroups.length;a>n;n++){var d=e.filterGroups[n];i.fid==r(d)&&(d.filters.push(i),o=!0)}o||e.filterGroups.push({condition_type:0,filters:[i]}),e.newFilter={operator:0,value:""}},e.filterchange=function(e){(8==e.operator||9==e.operator||10==e.operator)&&(e.value=""),10!=e.operator&&(e.start_date=null,e.end_date=null)},e.fieldChange=function(e){e.field&&"date"==e.field.data_type?(e.operator=10,e.value="",e.start_date=null,e.end_date=null):(e.operator=0,e.value="")},e.delFilter=function(t,r){if(t.filters.splice(r,1),0==t.filters.length){var l=e.filterGroups.indexOf(t);l>-1&&e.filterGroups.splice(l,1)}},e.cancel=function(){r.closeAll()},e.save=function(){var t=angular.copy(e.filter);"sql"==t.where_type?d(t):(f(t),e.editTbModel.filter=t,r.closeAll())},s()}angular.module("BC.controllers.dataSource").controller("WorktableFilterCtrl",e),e.$inject=["$scope","commonService","ngDialog","errHint","filterOperatorMapWithType","conditionType","$timeout"]}();
;$(document).ready(function(){for(var e="",t=document.cookie.split(";"),a=0,n=t.length;n>a;a++){var i=t[a].split("=");if(/domain/.test(i[0])){e=i[1];break}}if(e&&"personal"==e){var s="https://m1.bdp.cn/static/js/personal/meiqia/meiqiaInit_2386ff7.css";$("body").append('<link rel="stylesheet" type="text/css" href="'+s+'">'),function(e,t,a,n,i,s,c){e[i]=e[i]||function(){(e[i].a=e[i].a||[]).push(arguments)},s=t.createElement(a),c=t.getElementsByTagName(a)[0],s.async=!0,s.charset="UTF-8",s.src=n+"?v="+(new Date).getUTCDate(),c.parentNode.insertBefore(s,c)}(window,document,"script","//static.meiqia.com/dist/meiqia.js","_MEIQIA"),_MEIQIA("entId",26073)}});